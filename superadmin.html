<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NCHSM Super Admin Dashboard</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 220px; background-color: #1E293B; color: #fff; display: flex; flex-direction: column; padding: 20px; }
    .sidebar-header { text-align: center; margin-bottom: 30px; }
    .sidebar-header img { width: 60px; margin-bottom: 10px; }
    .nav { list-style: none; padding: 0; flex-grow: 1; }
    .nav li { margin: 10px 0; }
    .nav a { color: #fff; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.2s; }
    .nav a:hover, .nav a.active { background-color: #3B82F6; }
    .logout { margin-top: auto; text-align: center; }
    .logout a { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #EF4444; color: #fff; text-decoration: none; border-radius: 6px; }

    /* Main Content */
    .main { flex: 1; padding: 20px 30px; overflow-y: auto; }
    header h1 { margin: 0; font-size: 2rem; }
    .subtitle { color: #475569; margin-bottom: 20px; }

    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background-color: #fff; padding: 20px; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; text-align:center;}
    .card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .card h3 { margin-top: 0; font-size:1rem; color:#1e293b; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: #fff; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #E2E8F0; text-align: left; }
    th { background-color: #E2E8F0; }
    tr:hover { background-color: #F1F5F9; }

    /* Forms */
    form input, form select, form button, form textarea { padding: 8px 12px; margin: 5px 5px 10px 0; border-radius: 6px; border: 1px solid #CBD5E1; }
    form button { background-color: #3B82F6; color: #fff; cursor: pointer; }
    form button:hover { background-color: #2563EB; }

    .btn { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; color: #fff; }
    .btn-approve { background:#22c55e; }
    .btn-reject { background:#ef4444; }
    .btn-delete { background:#f97316; }

    .section { display: none; }
    .section.active { display: block; }

    .small { font-size: 0.9rem; color: #475569; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="images/Logo_NCHSM.png" alt="Logo" />
        <h2>Super Admin</h2>
      </div>

      <ul class="nav">
        <li><a href="#" class="active" onclick="showSection('dashboard', this)">Dashboard</a></li>
        <li><a href="#" onclick="showSection('students', this)">Students</a></li>
        <li><a href="#" onclick="showSection('courses', this)">Courses</a></li>
        <li><a href="#" onclick="showSection('attendance', this)">Attendance</a></li>
        <li><a href="#" onclick="showSection('cats', this)">CATS/Exams</a></li>
        <li><a href="#" onclick="showSection('messages', this)">Inbox</a></li>
        <li><a href="#" onclick="showSection('calendar', this)">Calendar</a></li>
        <li><a href="#" onclick="showSection('resources', this)">Resources</a></li>
        <li><a href="#" onclick="showSection('pending', this)">Pending Approvals</a></li>
      </ul>

      <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <header>
        <h1>Welcome, Super Admin!</h1>
        <p class="subtitle">Manage users, courses, exams and more</p>
      </header>

      <!-- Dashboard -->
      <section id="dashboard" class="section active">
        <div class="cards" id="dashboardCards">
          <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
          <div class="card"><h3>Admins</h3><p id="totalAdmins">0</p></div>
          <div class="card"><h3>Students</h3><p id="totalStudents">0</p></div>
          <div class="card"><h3>Pending Approvals</h3><p id="totalPending">0</p></div>
        </div>
      </section>

      <!-- Students -->
      <section id="students" class="section">
        <h2>Students</h2>
        <table>
          <thead><tr><th>Full Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="studentsList"></tbody>
        </table>
      </section>

      <!-- Courses -->
      <section id="courses" class="section">
        <h2>Courses</h2>
        <form id="addCourseForm">
          <input id="courseName" placeholder="Course name" required />
          <button type="submit">Add Course</button>
        </form>
        <table>
          <thead><tr><th>Course Name</th><th>Action</th></tr></thead>
          <tbody id="coursesList"></tbody>
        </table>
      </section>

      <!-- Pending Approvals (separate view) -->
      <section id="pending" class="section">
        <h2>Pending Approvals</h2>
        <table>
          <thead><tr><th>Full Name</th><th>Email</th><th>Action</th></tr></thead>
          <tbody id="pendingList"></tbody>
        </table>
      </section>

      <!-- Placeholders for the rest -->
      <section id="attendance" class="section"><h2>Attendance</h2><p class="small">Attendance tools to connect later</p></section>
      <section id="cats" class="section"><h2>CATS / Exams</h2><p class="small">Exams tools to connect later</p></section>
      <section id="messages" class="section"><h2>Inbox</h2><p class="small">Messaging to connect later</p></section>
      <section id="calendar" class="section"><h2>Calendar</h2><p class="small">Calendar placeholder</p></section>
      <section id="resources" class="section"><h2>Resources</h2><p class="small">Resources placeholder</p></section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- Supabase client ----------
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ---------- Helpers & UI ----------
    function setActiveLink(el){
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    function showSection(id, el){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add('active');
      setActiveLink(el);
      // update content title small UX
      // load data for that section
      if (id === 'dashboard') loadDashboard();
      if (id === 'students') loadStudents();
      if (id === 'courses') loadCourses();
      if (id === 'pending') loadPending();
    }

    async function logout(){
      await sb.auth.signOut();
      window.location.href = 'login.html';
    }

    // ---------- Dashboard ----------
    async function loadDashboard(){
      try {
        const { data, error } = await sb.from('profiles').select('*');
        if (error) { console.error('Dashboard profiles error', error); return; }
        const total = data.length;
        const admins = data.filter(u => u.role === 'admin').length;
        const students = data.filter(u => u.role === 'student').length;
        const pending = data.filter(u => !u.approved).length;

        document.getElementById('totalUsers').textContent = total;
        document.getElementById('totalAdmins').textContent = admins;
        document.getElementById('totalStudents').textContent = students;
        document.getElementById('totalPending').textContent = pending;
      } catch (err) {
        console.error('loadDashboard error', err);
      }
    }

    // ---------- Students ----------
    async function loadStudents(){
      try {
        const { data, error } = await sb.from('profiles').select('*').eq('role', 'student').order('full_name', { ascending: true });
        if (error) { console.error('loadStudents error', error); return; }
        const tbody = document.getElementById('studentsList');
        tbody.innerHTML = '';
        data.forEach(u => {
          tbody.innerHTML += `
            <tr>
              <td>${escapeHtml(u.full_name || '-')}</td>
              <td>${escapeHtml(u.email || '-')}</td>
              <td>${escapeHtml(u.phone || '-')}</td>
              <td>${u.approved ? 'Approved' : 'Pending'}</td>
              <td>
                ${!u.approved
                  ? `<button class="btn btn-approve" onclick="approveUser('${u.id}')">Approve</button>
                     <button class="btn btn-reject" onclick="rejectUser('${u.id}')">Reject</button>`
                  : `<button class="btn btn-delete" onclick="removeUser('${u.id}')">Remove</button>`}
              </td>
            </tr>`;
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Approve student (set approved = true)
    async function approveUser(id){
      const { error } = await sb.from('profiles').update({ approved: true }).eq('id', id);
      if (error) return alert('Error approving: ' + error.message);
      await loadStudents();
      await loadPending();
      await loadDashboard();
    }

    // Delete user entirely
    async function rejectUser(id){
      if (!confirm('Remove this user? This deletes their profile.')) return;
      const { error } = await sb.from('profiles').delete().eq('id', id);
      if (error) return alert('Error deleting user: ' + error.message);
      await loadStudents();
      await loadPending();
      await loadDashboard();
    }

    // Remove active user (duplicate of reject, kept for clarity)
    async function removeUser(id){
      if (!confirm('Remove this user?')) return;
      const { error } = await sb.from('profiles').delete().eq('id', id);
      if (error) return alert('Error removing user: ' + error.message);
      await loadStudents();
      await loadDashboard();
    }

    // ---------- Pending approvals ----------
    async function loadPending(){
      try {
        const { data, error } = await sb.from('profiles').select('*').eq('approved', false).order('full_name', { ascending: true });
        if (error) { console.error('loadPending error', error); return; }
        const tbody = document.getElementById('pendingList');
        tbody.innerHTML = '';
        data.forEach(u => {
          tbody.innerHTML += `
            <tr>
              <td>${escapeHtml(u.full_name || '-')}</td>
              <td>${escapeHtml(u.email || '-')}</td>
              <td>
                <button class="btn btn-approve" onclick="approveUser('${u.id}')">Approve</button>
                <button class="btn btn-reject" onclick="rejectUser('${u.id}')">Reject</button>
              </td>
            </tr>`;
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ---------- Courses ----------
    async function loadCourses(){
      try {
        // expects table `courses` with columns id (int/serial) and course_name (text)
        const { data, error } = await sb.from('courses').select('*').order('course_name', { ascending: true });
        if (error) {
          // if table missing, show empty and log
          console.warn('loadCourses warn:', error.message);
          document.getElementById('coursesList').innerHTML = '<tr><td colspan="2">No courses found or table missing.</td></tr>';
          return;
        }
        const tbody = document.getElementById('coursesList');
        tbody.innerHTML = '';
        data.forEach(c => {
          tbody.innerHTML += `
            <tr>
              <td>${escapeHtml(c.course_name || c.title || '-')}</td>
              <td><button class="btn btn-delete" onclick="deleteCourse(${c.id})">Delete</button></td>
            </tr>`;
        });
      } catch (err) {
        console.error(err);
      }
    }

    // add course handler
    document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('courseName').value.trim();
      if (!name) return alert('Enter course name');
      const { error } = await sb.from('courses').insert([{ course_name: name }]);
      if (error) return alert('Error adding course: ' + error.message);
      document.getElementById('addCourseForm').reset();
      await loadCourses();
      await loadDashboard();
    });

    async function deleteCourse(id){
      if (!confirm('Delete this course?')) return;
      const { error } = await sb.from('courses').delete().eq('id', id);
      if (error) return alert('Error deleting course: ' + error.message);
      await loadCourses();
    }

    // ---------- Utility ----------
    // Small HTML-escape to avoid simple injection when rendering values
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // ---------- Initial load & session check ----------
    async function init(){
      // Quick client test - helpful for debugging in console
      try {
        const { data, error } = await sb.from('profiles').select('*').limit(1);
        console.log('Supabase test query:', { data, error });
      } catch (err) {
        console.error('Supabase test failed', err);
      }

      // Load default content
      await loadDashboard();
      await loadStudents();
      await loadCourses();
      await loadPending();
    }

    init();
  </script>
</body>
</html>
