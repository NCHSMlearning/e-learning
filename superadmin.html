<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>NCHSM Super Admin Dashboard</title> Â  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
Â  <style>
Â  Â  /* --- NCHSM style (improved) --- */
Â  Â  body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
Â  Â  .container { display: flex; min-height: 100vh; }

Â  Â  /* Sidebar */
Â  Â  .sidebar {Â 
Â  Â  Â  width: 250px; /* Slightly wider */
Â  Â  Â  background-color: #1A202C; /* Deeper, more neutral dark tone */
Â  Â  Â  color: #fff;Â 
Â  Â  Â  display: flex;Â 
Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  padding: 20px;Â 
Â  Â  }
Â  Â  .sidebar-header { text-align: center; margin-bottom: 24px; }
Â  Â  .sidebar-header img { width: 60px; margin-bottom: 10px; }
Â  Â  .nav { list-style: none; padding: 0; flex-grow: 1; }
Â  Â  .nav li { margin: 6px 0; }
Â  Â  .nav a {Â 
Â  Â  Â  color: #CBD5E1; /* Lighter text */
Â  Â  Â  text-decoration: none;Â 
Â  Â  Â  padding: 12px 10px; /* More vertical padding */
Â  Â  Â  border-radius: 8px; /* Rounder corners */
Â  Â  Â  display: block;Â 
Â  Â  Â  transition: 0.15s;Â 
Â  Â  }
Â  Â  .nav a:hover {Â 
Â  Â  Â  background-color: #2D3748; /* Lighter background on hover */
Â  Â  Â  color: #E2E8F0;Â 
Â  Â  }
Â  Â  .nav a.active {Â 
Â  Â  Â  background-color: #3B82F6;Â 
Â  Â  Â  font-weight: 600; /* Bold the active link */
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .logout { margin-top: auto; text-align: center; }
Â  Â  .logout a {Â 
Â  Â  Â  display: inline-block;Â 
Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  padding: 10px 18px; /* Larger button */
Â  Â  Â  background-color: #DC2626; /* Stronger red */
Â  Â  Â  color: #fff;Â 
Â  Â  Â  text-decoration: none;Â 
Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  transition: background-color 0.2s;
Â  Â  }

Â  Â  /* Main Content */
Â  Â  .main { flex: 1; padding: 20px 28px; overflow-y: auto; }
Â  Â  header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px; } /* Increased margin */
Â  Â  header h1 { margin: 0; font-size: 1.8rem; color: #0f172a; } /* Slightly larger title */
Â  Â  .subtitle { color: #475569; }

Â  Â  /* Cards */
Â  Â  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 24px; } /* Increased gap */
Â  Â  .card {Â 
Â  Â  Â  background-color: #fff;Â 
Â  Â  Â  padding: 20px; /* More padding */
Â  Â  Â  border-radius: 12px; /* Rounder corners */
Â  Â  Â  border: 1px solid #E2E8F0; /* Subtle border */
Â  Â  Â  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Modern shadow */
Â  Â  Â  text-align: center;Â 
Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  transition: transform 0.1s, box-shadow 0.1s;Â 
Â  Â  }
Â  Â  .card:hover {
Â  Â  Â  transform: translateY(-2px); /* Slight lift on hover */
Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
Â  Â  }
Â  Â  .card h3 { margin: 4px 0 8px; font-size: 1.1rem; color: #0f172a; }
Â  Â  .card p { margin: 0; font-weight: 700; font-size: 1.5rem; color: #0b2447; }

Â  Â  /* Layout / Tabs */
Â  Â  .section { display: none; }
Â  Â  .section.active { display: block; }

Â  Â  /* Tables */
Â  Â  table {Â 
Â  Â  Â  width: 100%;Â 
Â  Â  Â  border-collapse: collapse;Â 
Â  Â  Â  background: white;Â 
Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  overflow:hidden;Â 
Â  Â  Â  margin-bottom: 20px;Â 
Â  Â  Â  border: 1px solid #E2E8F0; /* Subtle border */
Â  Â  Â  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* Lighter shadow for table */
Â  Â  }
Â  Â  th, td { padding: 14px; border-bottom: 1px solid #E6EEF8; text-align: left; color:#1A202C; } /* Darker text */
Â  Â  th {Â 
Â  Â  Â  background: #F1F5F9 !important; /* Lighter header background */
Â  Â  Â  color: #1E293B !important;Â 
Â  Â  Â  font-weight: 700 !important;Â 
Â  Â  }
Â  Â  tr:hover { background: #F8FAFC; }

Â  Â  /* Forms */
Â  Â  form {
Â  Â  Â  display: flex;Â 
Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  gap: 12px; /* Consistent spacing between elements */
Â  Â  Â  align-items: flex-end; /* Align inputs and buttons nicely */
Â  Â  }
Â  Â  form input, form select, form button, form textarea {Â 
Â  Â  Â  padding: 10px 12px; /* More padding */
Â  Â  Â  border-radius: 8px; /* Match other components */
Â  Â  Â  border: 1px solid #D2D6DC;Â 
Â  Â  Â  font-size: 0.95rem;Â 
Â  Â  Â  flex-grow: 1; /* Allow inputs to fill space */
Â  Â  Â  min-width: 180px;
Â  Â  }
Â  Â  form textarea {Â 
Â  Â  Â  flex-basis: 100%; /* Make textarea span full width */
Â  Â  Â  resize: vertical;
Â  Â  }
Â  Â  form button {Â 
Â  Â  Â  background:#3B82F6;Â 
Â  Â  Â  color:#fff;Â 
Â  Â  Â  border:none;Â 
Â  Â  Â  padding:11px 16px; /* Larger button */
Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  border-radius:8px;Â 
Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  flex-grow: 0; /* Prevent button from stretching unnecessarily */
Â  Â  }
Â  Â  form button:hover {
Â  Â  Â  background: #2563EB;
Â  Â  }
Â  Â  form button.alt { background:#10B981; }

Â  Â  /* small utility buttons */
Â  Â  .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; color:#fff; font-size:.9rem; }
Â  Â  .btn-approve { background:#059669; } /* Emerald Green */
Â  Â  .btn-reject { background:#DC2626; } /* Stronger Red */
Â  Â  .btn-delete { background:#F59E0B; } /* Amber Orange */
Â  Â  .btn-edit { background:#3B82F6; }
Â  Â  .btn-attendance { background:#0D9488; }Â 
Â  Â  .btn-map { background:#7C3AED; }Â 

Â  Â  .muted { font-size: .9rem; color:#6B7280; }
Â  Â  .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
Â  Â  .mb { margin-bottom:12px; }
Â  Â  .center { text-align:center; }
Â  Â  .file-input { display:inline-block; }
Â  Â  .notice { padding:12px; background:#FFF7ED; border-left: 4px solid #F97316; border-radius:6px; margin-bottom:18px; color:#7C2D12; }

Â  Â  /* Modal for Map */
Â  Â  .modal {
Â  Â  Â  display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
Â  Â  Â  overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background-color: #fefefe; padding: 30px; border-radius: 12px;Â 
Â  Â  Â  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
Â  Â  Â  width: 90%; max-width: 800px;
Â  Â  }
Â  Â  .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 1; }
Â  Â  .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
Â  Â  #attendanceMap { height: 400px; width: 100%; margin-top: 20px; border-radius: 8px; }

Â  Â  /* responsive */
Â  Â  @media (max-width:900px){
Â  Â  Â  .sidebar{ display:none; }
Â  Â  Â  .container{ flex-direction:column; }
Â  Â  Â  .main{ padding:12px; }
Â  Â  Â  .cards { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <aside class="sidebar">
Â  Â  Â  <div class="sidebar-header">
Â  Â  Â  Â  <img src="images/Logo_NCHSM.png" alt="Logo" onerror="this.style.display='none'"/>
Â  Â  Â  Â  <h3>Super Admin</h3>
Â  Â  Â  </div>

Â  Â  Â  <ul class="nav" id="mainNav">
Â  Â  Â  Â  <li><a href="#" class="active" onclick="showSection('dashboard', this)">Dashboard</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('users', this)">Users</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('students', this)">Students</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('courses', this)">Courses</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('attendance', this)">Attendance</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('exams', this)">Exams</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('messages', this)">Inbox</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('calendar', this)">Calendar</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('resources', this)">Resources</a></li>
Â  Â  Â  Â  <li><a href="#" onclick="showSection('pending', this)">Pending Approvals</a></li>
Â  Â  Â  </ul>

Â  Â  Â  <div class="logout">
Â  Â  Â  Â  <a href="#" onclick="logout()">Logout</a>
Â  Â  Â  </div>
Â  Â  </aside>

Â  Â  <main class="main">
Â  Â  Â  <header>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h1>Welcome, Super Admin</h1> Â  Â  Â  Â  Â  <p class="subtitle">Manage users, courses, attendance, exams, messages and resources</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" id="sessionInfo">Signed out</div>
Â  Â  Â  </header>

Â  Â  Â  <section id="dashboard" class="section active">
Â  Â  Â  Â  <div class="cards" id="dashboardCards">
Â  Â  Â  Â  Â  <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
Â  Â  Â  Â  Â  <div class="card"><h3>Admins</h3><p id="totalAdmins">0</p></div>
Â  Â  Â  Â  Â  <div class="card"><h3>Students</h3><p id="totalStudents">0</p></div>
Â  Â  Â  Â  Â  <div class="card"><h3>Pending</h3><p id="totalPending">0</p></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mb">
Â  Â  Â  Â  Â  <div class="notice">This dashboard reads/writes directly to your Supabase project. If you get permission errors, check RLS policies and ensure the anon key is valid.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  <section id="users" class="section">
Â  Â  Â  Â  <h2>Users â€” Add new user (Admin or Student)</h2>

Â  Â  Â  Â  <form id="addUserForm" class="mb">
Â  Â  Â  Â  Â  <input id="new_full_name" placeholder="Full name" required />
Â  Â  Â  Â  Â  <input id="new_email" placeholder="Email" type="email" required />
Â  Â  Â  Â  Â  <input id="new_phone" placeholder="Phone" />
Â  Â  Â  Â  Â  <input id="new_password" placeholder="Password" type="password" required />
Â  Â  Â  Â  Â  <select id="new_role">
Â  Â  Â  Â  Â  Â  <option value="student">Student</option>
Â  Â  Â  Â  Â  Â  <option value="admin">Admin</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <button type="submit">Create user</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>All users</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Approved</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="usersTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="students" class="section">
Â  Â  Â  Â  <h2>Students</h2>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="studentsTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="courses" class="section">
Â  Â  Â  Â  <h2>Courses</h2>
Â  Â  Â  Â  <form id="addCourseForm" class="mb">
Â  Â  Â  Â  Â  <input id="course_name" placeholder="Course name" required />
Â  Â  Â  Â  Â  <input id="course_description" placeholder="Short description (optional)" />
Â  Â  Â  Â  Â  <button type="submit">Add course</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>Course list</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Course</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="coursesTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="attendance" class="section">
Â  Â  Â  Â  <h2>Attendance</h2>

Â  Â  Â  Â  <div class="flex mb">
Â  Â  Â  Â  Â  <button class="btn btn-attendance" onclick="markMyAttendance()">ðŸ§­ Mark My Attendance (Geo Log)</button>
Â  Â  Â  Â  Â  <button class="btn btn-map" onclick="showAttendanceMap()">ðŸ—º View Latest Map</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h3 class="muted">Manual Attendance Entry (Admin/Super Admin only)</h3>
Â  Â  Â  Â  <form id="addAttendanceForm" class="mb">
Â  Â  Â  Â  Â  <select id="att_student_id"></select>
Â  Â  Â  Â  Â  <select id="att_session_type"><option value="classroom">Classroom</option><option value="clinical">Clinical</option></select>
Â  Â  Â  Â  Â  <select id="att_course_id"></select>
Â  Â  Â  Â  Â  <input id="att_location" placeholder="Location" />
Â  Â  Â  Â  Â  <input id="att_date" type="date" />
Â  Â  Â  Â  Â  <input id="att_time" type="time" />
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <input type="hidden" id="att_latitude" value="" />
Â  Â  Â  Â  Â  <input type="hidden" id="att_longitude" value="" />
Â  Â  Â  Â  Â  <input type="hidden" id="att_ip_address" value="" />
Â  Â  Â  Â  Â  <input type="hidden" id="att_device_id" value="" />
Â  Â  Â  Â  Â  <input type="hidden" id="att_marked_by" value="manual" />

Â  Â  Â  Â  Â  <button type="submit">Mark attendance (Manual)</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>Attendance records</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Student</th><th>Type</th><th>Location/Time</th><th>Date</th><th>Geo-IP</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="attendanceTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="exams" class="section">
Â  Â  Â  Â  <h2>Exams / CATS</h2>
Â  Â  Â  Â  <form id="addExamForm" class="mb">
Â  Â  Â  Â  Â  <select id="exam_course_id"></select>
Â  Â  Â  Â  Â  <input id="exam_title" placeholder="Exam title" required />
Â  Â  Â  Â  Â  <input id="exam_date" type="date" required />
Â  Â  Â  Â  Â  <select id="exam_status"><option>Upcoming</option><option>Completed</option></select>
Â  Â  Â  Â  Â  <button type="submit">Add exam</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>Exams</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Course</th><th>Title</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="examsTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="messages" class="section">
Â  Â  Â  Â  <h2>Inbox / Send Message</h2>
Â  Â  Â  Â  <form id="sendMessageForm" class="mb">
Â  Â  Â  Â  Â  <input id="msg_recipient" placeholder="Recipient email" required />
Â  Â  Â  Â  Â  <textarea id="msg_body" placeholder="Message" rows="3"></textarea>
Â  Â  Â  Â  Â  <button type="submit">Send</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>Messages (recent)</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>From</th><th>To</th><th>Message</th><th>Date</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="messagesTable"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="calendar" class="section">
Â  Â  Â  Â  <h2>Calendar</h2>
Â  Â  Â  Â  <p class="muted">Simple calendar placeholder â€” we can wire to exams/attendance events later.</p>
Â  Â  Â  Â  <div id="calendarPlaceholder" class="mb">[Calendar grid placeholder]</div>
Â  Â  Â  </section>

Â  Â  Â  <section id="resources" class="section">
Â  Â  Â  Â  <h2>Resources (Uploads)</h2>
Â  Â  Â  Â  <form class="mb">
Â  Â  Â  Â  Â  <label class="file-input">
Â  Â  Â  Â  Â  Â  <input id="resourceFile" type="file" />
Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  <input id="resourceTitle" placeholder="Title (optional)" />
Â  Â  Â  Â  Â  <button id="uploadResourceBtn" type="button">Upload to Storage</button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <h3>Available resources</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>File</th><th>Size</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="resourcesTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>

Â  Â  Â  <section id="pending" class="section">
Â  Â  Â  Â  <h2>Pending Approvals</h2>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="pendingTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </section>
Â  Â  </main>
Â  </div>

Â  <div id="mapModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <span class="close" onclick="$('mapModal').style.display='none'">&times;</span>
Â  Â  Â  <h3>Attendance Check-in Map</h3>
Â  Â  Â  <p class="muted" id="mapInfo"></p>
Â  Â  Â  <div id="attendanceMap"></div>
Â  Â  </div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

Â  <script>
Â  Â  /*******************
Â  Â  Â * Configuration
Â  Â  Â *******************/
Â  Â  const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
Â  Â  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
Â  Â  Â  auth: { persistSession: true, autoRefreshToken: true }
Â  Â  });
Â  Â  const RESOURCES_BUCKET = 'resources';
Â  Â  const IP_API_URL = 'https://api.ipify.org?format=json';
Â  Â  const DEVICE_ID_KEY = 'nchsm_device_id';

Â  Â  let currentUserProfile = null;
    let attendanceMap = null; // Variable to hold the Leaflet map object

Â  Â  /*******************
Â  Â  Â * Utilities
Â  Â  Â *******************/
Â  Â  function $(id){ return document.getElementById(id); }
Â  Â  function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
Â  Â Â 
Â  Â  function generateUUID() {
Â  Â  Â  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
Â  Â  Â  Â  (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
Â  Â  Â  );
Â  Â  }

Â  Â  function setActiveNav(el){
Â  Â  Â  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
Â  Â  Â  if (el) el.classList.add('active');
Â  Â  }

Â  Â  function showSection(id, el){
Â  Â  Â  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
Â  Â  Â  const sec = document.getElementById(id);
Â  Â  Â  if (sec) sec.classList.add('active');
Â  Â  Â  setActiveNav(el);
Â  Â  Â  // load relevant content
Â  Â  Â  switch(id){
Â  Â  Â  Â  case 'dashboard': loadDashboard(); break;
Â  Â  Â  Â  case 'users': loadUsers(); break;
Â  Â  Â  Â  case 'students': loadStudents(); break;
Â  Â  Â  Â  case 'courses': loadCourses(); break;
Â  Â  Â  Â  case 'attendance': loadAttendance(); populateAttendanceSelects(); break; // ADDED populate select
Â  Â  Â  Â  case 'exams': loadExams(); break;
Â  Â  Â  Â  case 'messages': loadMessages(); break;
Â  Â  Â  Â  case 'resources': loadResources(); break;
Â  Â  Â  Â  case 'pending': loadPending(); break;
Â  Â  Â  Â  default: break;
Â  Â  Â  }
Â  Â  }

Â  Â  async function logout(){
Â  Â  Â  await sb.auth.signOut();
Â  Â  Â  window.location.href = 'login.html';
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Session Info & User Profile
Â  Â  Â *******************/
Â  Â  async function initSessionInfo(){
Â  Â  Â  const { data: { user } } = await sb.auth.getUser();
Â  Â  Â  if (user) {
Â  Â  Â  Â  $('sessionInfo').textContent = `Signed in as ${user.email}`;
Â  Â  Â  Â  const { data: profile, error } = await sb.from('profiles').select('*').eq('id', user.id).single();
Â  Â  Â  Â  if (profile) currentUserProfile = profile;
Â  Â  Â  } else {
Â  Â  Â  Â  $('sessionInfo').textContent = 'Signed out';
Â  Â  Â  }
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Dashboard
Â  Â  Â *******************/
Â  Â  async function loadDashboard(){
Â  Â  Â  try {
Â  Â  Â  Â  const { data, error } = await sb.from('profiles').select('*');
Â  Â  Â  Â  if (error) { console.warn('dashboard profiles error', error); return; }
Â  Â  Â  Â  const total = data.length;
Â  Â  Â  Â  const admins = data.filter(u=>u.role==='admin').length;
Â  Â  Â  Â  const students = data.filter(u=>u.role==='student').length;
Â  Â  Â  Â  const pending = data.filter(u=>!u.approved).length;
Â  Â  Â  Â  $('totalUsers').textContent = total;
Â  Â  Â  Â  $('totalAdmins').textContent = admins;
Â  Â  Â  Â  $('totalStudents').textContent = students;
Â  Â  Â  Â  $('totalPending').textContent = pending;
Â  Â  Â  } catch (err){
Â  Â  Â  Â  console.error('loadDashboard', err);
Â  Â  Â  }
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Users management
Â  Â  Â *******************/
Â  Â  // create user (auth + profile)
Â  Â  $('addUserForm').addEventListener('submit', async (e)=>{
Â  Â  Â  e.preventDefault();
Â  Â  Â  const name = $('new_full_name').value.trim();
Â  Â  Â  const email = $('new_email').value.trim();
Â  Â  Â  const phone = $('new_phone').value.trim();
Â  Â  Â  const password = $('new_password').value;
Â  Â  Â  const role = $('new_role').value;
Â  Â  Â  if (!name || !email || !password) return alert('Name, email and password required');
Â  Â  Â  try {
Â  Â  Â  Â  // create auth user
Â  Â  Â  Â  const { data: signupData, error: signupErr } = await sb.auth.signUp({ email, password });
Â  Â  Â  Â  if (signupErr) {
Â  Â  Â  Â  Â  // If user exists, maybe create profile only (but careful). For now show error.
Â  Â  Â  Â  Â  return alert('Signup error: ' + signupErr.message);
Â  Â  Â  Â  }
Â  Â  Â  Â  const userId = signupData.user.id;
Â  Â  Â  Â  // create profile
Â  Â  Â  Â  const { error: pErr } = await sb.from('profiles').insert([{ id: userId, full_name: name, email, phone, role, approved: true }]);
Â  Â  Â  Â  if (pErr) { alert('Profile insert error: ' + pErr.message); return; }
Â  Â  Â  Â  alert('User created');
Â  Â  Â  Â  $('addUserForm').reset();
Â  Â  Â  Â  loadUsers(); loadStudents(); loadDashboard(); loadPending();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('create user err', err);
Â  Â  Â  Â  alert('Error creating user (see console)');
Â  Â  Â  }
Â  Â  });

Â  Â  // list users
Â  Â  async function loadUsers(){
Â  Â  Â  try {
Â  Â  Â  Â  const { data, error } = await sb.from('profiles').select('*').order('created_at', {ascending:false});
Â  Â  Â  Â  if (error) { console.warn('loadUsers', error); $('usersTable').innerHTML='<tr><td colspan="6">Error loading users</td></tr>'; return; }
Â  Â  Â  Â  const tbody = $('usersTable'); tbody.innerHTML = '';
Â  Â  Â  Â  data.forEach(u=>{
Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(u.full_name)}</td>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(u.email)}</td>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(u.phone)}</td>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(u.role)}</td>
Â  Â  Â  Â  Â  Â  <td>${u.approved ? 'Yes' : 'No'}</td>
Â  Â  Â  Â  Â  Â  <td class="flex">
Â  Â  Â  Â  Â  Â  Â  ${u.approved ? `<button class="btn btn-delete" onclick="deactivateUser('${u.id}')">Deactivate</button>` : `<button class="btn btn-approve" onclick="approveUser('${u.id}')">Approve</button>`}
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-delete" onclick="deleteUser('${u.id}')">Delete</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  Â  } catch (err){ console.error('loadUsers', err); }
Â  Â  }

Â  Â  async function approveUser(id){
Â  Â  Â  const { error } = await sb.from('profiles').update({ approved: true }).eq('id', id);
Â  Â  Â  if (error) return alert('Approve error: ' + error.message);
Â  Â  Â  await loadUsers(); await loadPending(); await loadDashboard(); await loadStudents();
Â  Â  }

Â  Â  async function deactivateUser(id){
Â  Â  Â  const { error } = await sb.from('profiles').update({ approved: false }).eq('id', id);
Â  Â  Â  if (error) return alert('Deactivate error: ' + error.message);
Â  Â  Â  await loadUsers(); await loadDashboard(); await loadPending();
Â  Â  }

Â  Â  // delete profile row (note: auth user still exists in auth table)
Â  Â  async function deleteUser(id){
Â  Â  Â  if (!confirm('Delete profile row? This removes the profile record. The auth user will remain in Auth.')) return;
Â  Â  Â  const { error } = await sb.from('profiles').delete().eq('id', id);
Â  Â  Â  if (error) return alert('Delete error: ' + error.message);
Â  Â  Â  await loadUsers(); await loadDashboard(); await loadStudents(); await loadPending();
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Students tab (filtered users)
Â  Â  Â *******************/
Â  Â  async function loadStudents(){
Â  Â  Â  try {
Â  Â  Â  Â  const { data, error } = await sb.from('profiles').select('*').eq('role','student').order('full_name', {ascending:true});
Â  Â  Â  Â  if (error) { console.warn('loadStudents', error); $('studentsTable').innerHTML='<tr><td colspan="5">Error</td></tr>'; return; }
Â  Â  Â  Â  const tbody = $('studentsTable'); tbody.innerHTML = '';
Â  Â  Â  Â  data.forEach(s=>{
Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(s.full_name)}</td>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(s.email)}</td>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(s.phone)}</td>
Â  Â  Â  Â  Â  Â  <td>${s.approved ? 'Approved' : 'Pending'}</td>
Â  Â  Â  Â  Â  Â  <td class="flex">
Â  Â  Â  Â  Â  Â  Â  ${!s.approved ? `<button class="btn btn-approve" onclick="approveUser('${s.id}')">Approve</button>` : `<button class="btn btn-delete" onclick="deactivateUser('${s.id}')">Deactivate</button>`}
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-delete" onclick="deleteUser('${s.id}')">Delete</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  Â  } catch (err){ console.error('loadStudents', err); }
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Courses
Â  Â  Â *******************/
Â  Â  $('addCourseForm').addEventListener('submit', async (e)=>{
Â  Â  Â  e.preventDefault();
Â  Â  Â  const name = $('course_name').value.trim();
Â  Â  Â  const description = $('course_description').value.trim();
Â  Â  Â  if (!name) return alert('Course name required');
Â  Â  Â  try {
Â  Â  Â  Â  const { error } = await sb.from('courses').insert([{ course_name: name, description }]);
Â  Â  Â  Â  if (error) return alert('Add course error: ' + error.message);
Â  Â  Â  Â  $('addCourseForm').reset();
Â  Â  Â  Â  await loadCourses(); await populateCourseSelects();
Â  Â  Â  } catch (err){ console.error(err); }
Â  Â  });

Â  Â  async function loadCourses(){
Â  Â  Â  try {
Â  Â  Â  Â  const { data, error } = await sb.from('courses').select('*').order('course_name', {ascending:true});
Â  Â  Â  Â  if (error) { console.warn('loadCourses', error); $('coursesTable').innerHTML = '<tr><td colspan="2">No courses or table missing</td></tr>'; return; }
Â  Â  Â  Â  const tbody = $('coursesTable'); tbody.innerHTML = '';
Â  Â  Â  Â  data.forEach(c=>{
Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td>${escapeHtml(c.course_name)}</td>
Â  Â  Â  Â  Â  Â  <td><button class="btn btn-delete" onclick="deleteCourse(${c.id})">Delete</button></td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  Â  } catch (err){ console.error('loadCourses', err); }
Â  Â  }

Â  Â  async function deleteCourse(id){
Â  Â  Â  if (!confirm('Delete course?')) return;
Â  Â  Â  const { error } = await sb.from('courses').delete().eq('id', id);
Â  Â  Â  if (error) return alert('Delete course error: ' + error.message);
Â  Â  Â  await loadCourses(); await populateCourseSelects();
Â  Â  }

Â  Â  async function populateCourseSelects(){
Â  Â  Â  try {
Â  Â  Â  Â  const { data } = await sb.from('courses').select('*').order('course_name', {ascending:true});
Â  Â  Â  Â  const courseSelects = document.querySelectorAll('#att_course_id, #exam_course_id');
Â  Â  Â  Â  courseSelects.forEach(s => s.innerHTML = '');
Â  Â  Â  Â  if (!data || data.length === 0) {
Â  Â  Â  Â  Â  courseSelects.forEach(s => s.innerHTML = '<option value="">(no courses)</option>');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  data.forEach(c => {
Â  Â  Â  Â  Â  const opt = `<option value="${c.id}">${escapeHtml(c.course_name)}</option>`;
Â  Â  Â  Â  Â  courseSelects.forEach(s => s.insertAdjacentHTML('beforeend', opt));
Â  Â  Â  Â  });
Â  Â  Â  } catch (err){ console.error('populateCourseSelects', err); }
Â  Â  }

Â  Â  /*******************
Â  Â  Â * Attendance Utilities (NEW)
Â  Â  Â *******************/
Â  Â  async function getPublicIP() {
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(IP_API_URL);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  return data.ip || '0.0.0.0';
Â  Â  Â  } catch {
Â  Â  Â  Â  return '0.0.0.0';
Â  Â  Â  }
Â  Â  }

Â  Â  function getDeviceId() {
Â  Â  Â  let deviceId = localStorage.getItem(DEVICE_ID_KEY);
Â  Â  Â  if (!deviceId) {
Â  Â  Â  Â  deviceId = generateUUID();
Â  Â  Â  Â  localStorage.setItem(DEVICE_ID_KEY, deviceId);
Â  Â  Â  }
Â  Â  Â  return deviceId;
Â  Â  }

Â  Â  function getGeoLocation() {
Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  alert('Geolocation is not supported by your browser.');
Â  Â  Â  Â  Â  return resolve({ lat: null, lng: null, accuracy: null });
Â  Â  Â  Â  }
Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  (position) => {
Â  Â  Â  Â  Â  Â  resolve({ lat: position.coords.latitude, lng: position.coords.longitude, accuracy: position.coords.accuracy });
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  (error) => {
Â  Â  Â  Â  Â  Â  console.error('Geolocation Error:', error);
Â  Â  Â  Â  Â  Â  alert('Could not get location. Ensure permissions are granted.');
Â  Â  Â  Â  Â  Â  resolve({ lat: null, lng: null, accuracy: null });
Â  Â  Â  Â  Â  },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
Â  Â  Â  Â  );
Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  async function hasAlreadyMarkedAttendance(studentId) {
Â  Â  Â  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
Â  Â  Â Â 
Â  Â  Â  // CHECKING AGAINST THE CORRECT TABLE AND COLUMN
Â  Â  Â  const { data, error } = await sb.from('geo_attendance_logs')
Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  .eq('student_id', studentId)
Â  Â  Â  Â  .gte('check_in_time', today) // Use the correct column check_in_time
Â  Â  Â  Â  .limit(1);

Â  Â  Â  if (error) {
Â  Â  Â  Â  console.error('Supabase check error:', error);
Â  Â  Â  Â  return true; // Fail safe
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  return data.length > 0;
Â  Â  }

    async function populateAttendanceSelects() {
        try {
            const { data: students } = await sb.from('profiles').select('id, full_name').eq('role', 'student').order('full_name');
            const studentSelect = $('att_student_id');
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
            if (students) {
                students.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.id}">${escapeHtml(s.full_name)}</option>`;
                });
            }
            populateCourseSelects();
        } catch(err) {
            console.error('populateAttendanceSelects', err);
        }
    }
Â  Â Â 
Â  Â  /*******************
Â  Â  Â * Attendance Logic
Â  Â  Â *******************/
Â  Â Â 
Â  Â  // 1. Student / Self Check-in
Â  Â  async function markMyAttendance() {
Â  Â  Â  if (!currentUserProfile || !currentUserProfile.approved) {
Â  Â  Â  Â  return alert('Access Denied: Only approved users can use self check-in.');
Â  Â  Â  }

Â  Â  Â  const studentId = currentUserProfile.id;
Â  Â  Â  const deviceId = getDeviceId();
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // 1. Get Geo and IP
Â  Â  Â  Â  const [ipAddress, location] = await Promise.all([
Â  Â  Â  Â  Â  getPublicIP(),Â 
Â  Â  Â  Â  Â  getGeoLocation()
Â  Â  Â  Â  ]);
Â  Â  Â  Â 
        if (!location.lat || !location.lng) {
            return; // Geolocation failed, error message already shown.
        }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Check for Duplicates
Â  Â  Â  Â  if (await hasAlreadyMarkedAttendance(studentId)) {
Â  Â  Â  Â  Â  return alert('Attendance already marked today via this device/IP. Try again tomorrow.');
Â  Â  Â  Â  }

        // Determine session type
        const defaultSession = currentUserProfile.role === 'student' ? 'Clinical' : 'Office';
        const sessionType = prompt(`Enter session type (e.g., Clinical, Office):`, defaultSession);
        if (!sessionType) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Insert Record into the NEW geo_attendance_logs table
Â  Â  Â  Â  const { error } = await sb.from('geo_attendance_logs').insert([{Â 
Â  Â  Â  Â  Â  student_id: studentId,Â 
Â  Â  Â  Â  Â  session_type: sessionType,
Â  Â  Â  Â  Â  latitude: location.lat,
Â  Â  Â  Â  Â  longitude: location.lng,
Â  Â  Â  Â  Â  accuracy_meters: location.accuracy,
          ip_address: ipAddress,
          // Use only a portion of the device ID to keep the table cleaner
          device_id: deviceId.substring(0, 8) 
Â  Â  Â  Â  }]);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  return alert('Geo Check-in failed: ' + error.message);
Â  Â  Â  Â  }

Â  Â  Â  Â  alert(`Attendance marked successfully! Session: ${sessionType}.`);
Â  Â  Â  Â  loadAttendance();
Â  Â  Â  } catch(err) {
Â  Â  Â  Â  console.error('markMyAttendance error:', err);
Â  Â  Â  Â  alert('An unexpected error occurred during check-in.');
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 2. Admin Manual Mark Attendance
Â  Â  $('addAttendanceForm').addEventListener('submit', async (e)=>{
Â  Â  Â  e.preventDefault();
Â  Â  Â  if (currentUserProfile.role !== 'admin' && currentUserProfile.role !== 'superadmin') {
Â  Â  Â  Â  return alert('You do not have permission for manual attendance entry.');
Â  Â  Â  }
Â  Â  Â  manualMarkAttendance();
Â  Â  });
Â  Â Â 
Â  Â  async function manualMarkAttendance() {
Â  Â  Â  const student_id = $('att_student_id').value;
Â  Â  Â  const session_type = $('att_session_type').value;
Â  Â  Â  const course_id = $('att_course_id').value || null;
Â  Â  Â  const location = $('att_location').value.trim();
Â  Â  Â  const date = $('att_date').value;
Â  Â  Â  const time = $('att_time').value || null;
Â  Â  Â Â 
Â  Â  Â  // For manual entry, location data is often null/zero.
Â  Â  Â  const latitude = parseFloat($('att_latitude').value) || null;
Â  Â  Â  const longitude = parseFloat($('att_longitude').value) || null;
Â  Â  Â  const ip_address = $('att_ip_address').value || null;
Â  Â  Â  const device_id = $('att_device_id').value || null;
Â  Â  Â  const marked_by = currentUserProfile.email || 'superadmin_manual';

Â  Â  Â  if (!student_id || !date) return alert('Student and date required for manual entry.');
Â  Â  Â Â 
      // Note: This uses the OLD 'attendance' table
Â  Â  Â  const { error } = await sb.from('attendance').insert([{Â 
Â  Â  Â  Â  student_id, session_type, course_id, location, time, date,Â 
Â  Â  Â  Â  latitude, longitude, ip_address, device_id, marked_by
Â  Â  Â  }]);
Â  Â  Â Â 
Â  Â  Â  if (error) return alert('Add attendance error: ' + error.message);
Â  Â  Â  $('addAttendanceForm').reset();
Â  Â  Â  await loadAttendance();
Â  Â  }


Â  Â  // 3. Load Attendance Records (Combined View)
Â  Â  async function loadAttendance(){
        // Note: This displays records from both the NEW geo_attendance_logs and OLD attendance table.
Â  Â  Â  try {
            // Fetch records from the OLD 'attendance' table
Â  Â  Â  Â  Â  Â  const { data: oldData, error: oldError } = await sb.from('attendance').select('*, profiles(full_name)').order('date', {ascending:false});

            // Fetch records from the NEW 'geo_attendance_logs' table (FIXED)
            const { data: geoData, error: geoError } = await sb.from('geo_attendance_logs')
                .select('id, student_id, session_type, latitude, longitude, accuracy_meters, check_in_time, ip_address, profiles(full_name)')
                .order('check_in_time', {ascending:false});
            
            const tbody = $('attendanceTable'); 
            tbody.innerHTML = '';

            // ------------------------------------
            // Display GEO LOGS
            // ------------------------------------
            if (geoError) { 
                console.warn('Geo Attendance Load Error:', geoError);
                tbody.innerHTML += `<tr><td colspan="6" style="color:red; font-weight:bold;">Error loading Geo Logs: ${geoError.message}. Check RLS on geo_attendance_logs.</td></tr>`;
            } else if (geoData.length > 0) {
                 tbody.innerHTML += `<tr><td colspan="6" style="font-weight:bold; background:#EBF8FF;">--- Geo-Location Check-in Logs ---</td></tr>`;
                geoData.forEach(r => {
                    const studentName = r.profiles?.full_name || r.student_id || '-';
                    const geoIpText = `Lat: ${r.latitude.toFixed(4)} | Acc: ${r.accuracy_meters.toFixed(1)}m`;
                    const time = new Date(r.check_in_time).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                    const date = new Date(r.check_in_time).toLocaleDateString();
                    
                    tbody.innerHTML += `<tr style="background:#F7FAFD;">
                        <td>${escapeHtml(studentName)} <span style="font-size:0.7em; color:#3B82F6;">(GEO)</span></td>
                        <td>${escapeHtml(r.session_type)}</td>
                        <td>IP: ${r.ip_address || 'N/A'} | ${time}</td>
                        <td>${date}</td>
                        <td>${escapeHtml(geoIpText)}</td>
                        <td>
                            <button class="btn btn-map" onclick="showAttendanceMap(${r.latitude}, ${r.longitude}, '${escapeHtml(studentName)} Check-in')">Map</button>
                            <button class="btn btn-delete" onclick="deleteGeoAttendance(${r.id})">Del</button>
                        </td>
                    </tr>`;
                });
            }


            // ------------------------------------
            // Display OLD/MANUAL LOGS
            // ------------------------------------
            if (oldData && oldData.length > 0) {
                tbody.innerHTML += `<tr><td colspan="6" style="font-weight:bold; background:#F1F5F9;">--- Manual/Old Attendance Records ---</td></tr>`;
                oldData.forEach(r=>{
                    const studentName = r.profiles?.full_name || r.student_id || '-';
                    const locationText = (r.location || 'N/A') + ' at ' + (r.time || 'N/A');
                    const date = r.date || 'N/A';
                    
                    tbody.innerHTML += `<tr>
                        <td>${escapeHtml(studentName)}</td>
                        <td>${escapeHtml(r.session_type)}</td>
                        <td>${escapeHtml(locationText)}</td>
                        <td>${escapeHtml(date)}</td>
                        <td>Manual</td>
                        <td><button class="btn btn-delete" onclick="deleteAttendance(${r.id})">Delete</button></td>
                    </tr>`;
                });
            }

            if (!oldData && !geoData) {
                tbody.innerHTML = '<tr><td colspan="6">No attendance records found.</td></tr>';
            }

Â  Â  Â  Â  } catch (err){ console.error('loadAttendance', err); }
Â  Â  }


    // 4. Leaflet Map Logic (NEW)
    function showAttendanceMap(lat, lng, label) {
        if (!lat || !lng) {
            return alert('No valid geo-coordinates found for this entry.');
        }

        $('mapModal').style.display = 'flex';
        $('mapInfo').textContent = `Check-in location for ${label}.`;

        // Clear existing map instance if it exists
        if (attendanceMap) {
            attendanceMap.remove();
        }

        // Initialize the map (Delaying initialization slightly ensures the map container is fully visible)
        setTimeout(() => {
            attendanceMap = L.map('attendanceMap').setView([lat, lng], 16);

            // Add the tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(attendanceMap);

            // Add a marker for the check-in location
            L.marker([lat, lng]).addTo(attendanceMap)
                .bindPopup(`<b>${label}</b><br>Check-in Location.`)
                .openPopup();
        }, 100);
    }

    async function deleteGeoAttendance(id){
        if (!confirm('Delete Geo Attendance Log?')) return;
        const { error } = await sb.from('geo_attendance_logs').delete().eq('id', id);
        if (error) return alert('Delete geo log error: ' + error.message);
        await loadAttendance();
    }
    
    async function deleteAttendance(id){
        if (!confirm('Delete Manual/Old Attendance Log?')) return;
        const { error } = await sb.from('attendance').delete().eq('id', id);
        if (error) return alert('Delete attendance error: ' + error.message);
        await loadAttendance();
    }


Â  Â  /*******************
Â  Â  Â * Exams, Messages, Resources, Pending (Omitted for brevity, but exist)
Â  Â  Â *******************/

    // Dummy/Placeholder Functions for the full code environment
    async function loadExams(){}
    async function loadMessages(){}
    async function loadResources(){}
    async function loadPending(){}
    
Â  Â  /*******************
Â  Â  Â * Initialization
Â  Â  Â *******************/

Â  Â  // The robust session listener
Â  Â  sb.auth.onAuthStateChange((event, session) => {
Â  Â  Â  if ((event === 'INITIAL_SESSION' || event === 'SIGNED_IN') && session) {
Â  Â  Â  Â  initSessionInfo();
Â  Â  Â  Â  showSection('dashboard', $('mainNav').querySelector('a'));
Â  Â  Â  Â  populateCourseSelects(); // Load options for forms
Â  Â  Â  Â  populateAttendanceSelects(); // Load student options for attendance form
Â  Â  Â  } else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
Â  Â  Â  Â  // Ensure users are redirected to login if no session is found
Â  Â  Â  Â  window.location.href = "login.html";
Â  Â  Â  }
Â  Â  });
Â  </script>
</body>
</html>
