<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Super Admin Dashboard</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Mobile Navigation Toggle -->
        <div class="mobile-nav-toggle" id="mobileNavToggle">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo" onerror="this.style.display='none'">
                <h2>Super Admin</h2>
            </div>
            <ul class="nav" id="mainNav">
                <li><a href="#" data-tab="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" data-tab="users"><i class="fas fa-users"></i> Manage Users</a></li>
                <li><a href="#" data-tab="pending"><i class="fas fa-clock"></i> Pending Approvals</a></li>
                <li><a href="#" data-tab="enroll"><i class="fas fa-user-plus"></i> Enroll Accounts</a></li>
                <li><a href="#" data-tab="courses"><i class="fas fa-book"></i> Courses</a></li>
                <li><a href="#" data-tab="sessions"><i class="fas fa-calendar-alt"></i> Manage Sessions</a></li>
                <li><a href="#" data-tab="attendance"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
                <li><a href="#" data-tab="cats"><i class="fas fa-file-alt"></i> CATS/Exams</a></li>
                <li><a href="#" data-tab="resources"><i class="fas fa-file-upload"></i> Resources</a></li>
                <li><a href="#" data-tab="messages"><i class="fas fa-inbox"></i> Inbox</a></li>
                <li><a href="#" data-tab="calendar"><i class="fas fa-calendar"></i> System Calendar</a></li>
                <li><a href="#" data-tab="welcome-editor"><i class="fas fa-edit"></i> Welcome Message</a></li>
                <li><a href="#" data-tab="system-health"><i class="fas fa-heartbeat"></i> System Health</a></li>
                <li><a href="#" data-tab="user-analytics"><i class="fas fa-chart-line"></i> User Analytics</a></li>
                <li><a href="#" data-tab="task-scheduler"><i class="fas fa-clock"></i> Task Scheduler</a></li>
                <li><a href="#" data-tab="bulk-operations"><i class="fas fa-tasks"></i> Bulk Operations</a></li>
                <li><a href="#" data-tab="api-management"><i class="fas fa-key"></i> API Management</a></li>
                <li><a href="#" data-tab="notification-center"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a href="#" data-tab="quick-actions"><i class="fas fa-bolt"></i> Quick Actions</a></li>
                <li><a href="#" data-tab="security-2fa"><i class="fas fa-lock"></i> Security & 2FA</a></li>
                <li><a href="#" data-tab="session-management"><i class="fas fa-user-clock"></i> Session Management</a></li>
                <li><a href="#" data-tab="error-tracking"><i class="fas fa-bug"></i> Error Tracking</a></li>
                <li><a href="#" data-tab="data-visualization"><i class="fas fa-chart-bar"></i> Data Visualization</a></li>
                <li><a href="#" data-tab="audit"><i class="fas fa-search"></i> Audit Logs</a></li>
                <li><a href="#" data-tab="security"><i class="fas fa-cog"></i> Security Settings</a></li>
                <li><a href="#" data-tab="backup"><i class="fas fa-database"></i> Backup & Restore</a></li>
            </ul>
            <div class="logout">
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Super Admin!</h1>
                <p class="subtitle">Full system oversight and user management</p>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="tab-content active">
                <div id="student-welcome-message">
                    <p>Loading NCHSM Welcome Message...</p>
                </div>
                <div class="cards">
                    <div class="card" onclick="showTab('users')">
                        <h3>Total Users</h3>
                        <p class="data" id="totalUsers">0</p>
                    </div>
                    <div class="card" onclick="showTab('pending')">
                        <h3>Pending Approvals</h3>
                        <p class="data" id="pendingApprovals">0</p>
                    </div>
                    <div class="card" onclick="showTab('enroll')">
                        <h3>Total Students</h3>
                        <p class="data" id="totalStudents">0</p>
                    </div>
                    <div class="card" onclick="showTab('system-health')">
                        <h3>Data Integrity Score</h3>
                        <p class="data" id="dataIntegrityScore">--%</p>
                    </div>
                    
                    <div class="card checkin-metric" onclick="showTab('attendance')">
                        <h3 style="color: #4C1D95;">Today's Check-ins</h3>
                        <p class="data" id="totalDailyCheckIns">0</p>
                        <p class="minor-data">Total Check-ins Today</p>
                    </div>
                    <div class="card checkin-metric" onclick="showTab('attendance')">
                        <h3 style="color: #4C1D95;">Check-in Records</h3>
                        <p class="data" id="overallCheckInCount">0</p>
                        <p class="minor-data">All-time Records</p>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="cards">
                    <div class="card" onclick="showTab('system-health')">
                        <h3>System Uptime</h3>
                        <p class="data">99.8%</p>
                        <p class="minor-data">Last 30 days</p>
                    </div>
                    <div class="card" onclick="showTab('user-analytics')">
                        <h3>Active Sessions</h3>
                        <p class="data" id="activeSessions">0</p>
                        <p class="minor-data">Currently logged in</p>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Total Courses</h3>
                        <p class="data" id="totalCourses">0</p>
                        <p class="minor-data">Across all programs</p>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>Resources Uploaded</h3>
                        <p class="data" id="totalResources">0</p>
                        <p class="minor-data">This month</p>
                    </div>
                </div>
            </section>

            <!-- System Health Section -->
            <section id="system-health" class="tab-content">
                <h2><i class="fas fa-heartbeat"></i> System Health Monitor</h2>
                <div class="health-cards">
                    <div class="health-card">
                        <h4>Server Load</h4>
                        <div class="progress-bar">
                            <div id="server-load-bar" class="progress-fill" style="width: 45%"></div>
                        </div>
                        <span id="server-load-text">45%</span>
                    </div>
                    <div class="health-card">
                        <h4>Database Performance</h4>
                        <div class="progress-bar">
                            <div id="db-performance-bar" class="progress-fill" style="width: 78%"></div>
                        </div>
                        <span id="db-query-time">78% - 12ms avg</span>
                    </div>
                    <div class="health-card">
                        <h4>Storage Usage</h4>
                        <div class="progress-bar">
                            <div id="storage-usage-bar" class="progress-fill" style="width: 62%"></div>
                        </div>
                        <span id="storage-used">62GB / 100GB</span>
                    </div>
                    <div class="health-card">
                        <h4>API Response Time</h4>
                        <div class="progress-bar">
                            <div id="api-response-bar" class="progress-fill" style="width: 92%"></div>
                        </div>
                        <span id="api-response-time">92% - 180ms avg</span>
                    </div>
                </div>
                
                <h3>System Metrics</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Uptime</h3>
                        <p class="data">99.8%</p>
                        <p class="minor-data">Last 30 days</p>
                    </div>
                    <div class="card">
                        <h3>Error Rate</h3>
                        <p class="data">0.2%</p>
                        <p class="minor-data">Last 24 hours</p>
                    </div>
                    <div class="card">
                        <h3>Active Connections</h3>
                        <p class="data">142</p>
                        <p class="minor-data">Current</p>
                    </div>
                    <div class="card">
                        <h3>Peak Usage</h3>
                        <p class="data">2:00 PM</p>
                        <p class="minor-data">Daily peak time</p>
                    </div>
                </div>
            </section>

            <!-- User Analytics Section -->
            <section id="user-analytics" class="tab-content">
                <h2><i class="fas fa-chart-line"></i> User Behavior Analytics</h2>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4>Login Frequency Heatmap</h4>
                        <div id="login-heatmap" style="height: 200px; background: #f5f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                            Heatmap Visualization
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h4>Feature Usage</h4>
                        <div id="feature-usage-chart" style="height: 200px; background: #f5f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                            Feature Usage Chart
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h4>Peak Usage Times</h4>
                        <div id="usage-times-chart" style="height: 200px; background: #f5f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                            Usage Times Chart
                        </div>
                    </div>
                </div>
                
                <h3>User Engagement Metrics</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Avg. Session Duration</h3>
                        <p class="data">12.4m</p>
                        <p class="minor-data">+2.3% from last week</p>
                    </div>
                    <div class="card">
                        <h3>Daily Active Users</h3>
                        <p class="data">342</p>
                        <p class="minor-data">+15 from yesterday</p>
                    </div>
                    <div class="card">
                        <h3>Weekly Retention</h3>
                        <p class="data">78%</p>
                        <p class="minor-data">Stable</p>
                    </div>
                    <div class="card">
                        <h3>Feature Adoption</h3>
                        <p class="data">64%</p>
                        <p class="minor-data">+5% this month</p>
                    </div>
                </div>
            </section>

            <!-- Task Scheduler Section -->
            <section id="task-scheduler" class="tab-content">
                <h2><i class="fas fa-clock"></i> Automated Task Scheduler</h2>
                <div class="scheduled-tasks">
                    <div class="task-item">
                        <h4>Daily Backup</h4>
                        <select id="backup-time">
                            <option value="02:00">2:00 AM</option>
                            <option value="03:00" selected>3:00 AM</option>
                            <option value="04:00">4:00 AM</option>
                        </select>
                        <button onclick="scheduleBackup()" class="btn-action" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-save"></i> Schedule
                        </button>
                    </div>
                    <div class="task-item">
                        <h4>Weekly Reports</h4>
                        <select id="report-day">
                            <option value="monday">Monday</option>
                            <option value="sunday" selected>Sunday</option>
                        </select>
                        <button onclick="scheduleReports()" class="btn-action" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-chart-bar"></i> Schedule
                        </button>
                    </div>
                    <div class="task-item">
                        <h4>Clean Temp Files</h4>
                        <select id="cleanup-frequency">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        <button onclick="scheduleCleanup()" class="btn-action" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-broom"></i> Schedule
                        </button>
                    </div>
                    <div class="task-item">
                        <h4>System Health Check</h4>
                        <select id="health-check-frequency">
                            <option value="hourly">Hourly</option>
                            <option value="daily" selected>Daily</option>
                        </select>
                        <button onclick="scheduleHealthCheck()" class="btn-action" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-stethoscope"></i> Schedule
                        </button>
                    </div>
                </div>
                
                <h3>Scheduled Tasks Log</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Schedule</th>
                            <th>Last Run</th>
                            <th>Status</th>
                            <th>Next Run</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="scheduled-tasks-table">
                        <tr>
                            <td>Daily Database Backup</td>
                            <td>Daily at 3:00 AM</td>
                            <td>Today, 3:00 AM</td>
                            <td><span class="badge badge-success">Completed</span></td>
                            <td>Tomorrow, 3:00 AM</td>
                            <td>
                                <button class="btn-action"><i class="fas fa-play"></i> Run Now</button>
                                <button class="btn-warning"><i class="fas fa-pause"></i> Pause</button>
                            </td>
                        </tr>
                        <tr>
                            <td>Weekly Report Generation</td>
                            <td>Weekly on Sunday</td>
                            <td>Last Sunday, 2:00 AM</td>
                            <td><span class="badge badge-success">Completed</span></td>
                            <td>Next Sunday, 2:00 AM</td>
                            <td>
                                <button class="btn-action"><i class="fas fa-play"></i> Run Now</button>
                                <button class="btn-warning"><i class="fas fa-pause"></i> Pause</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Bulk Operations Section -->
            <section id="bulk-operations" class="tab-content">
                <h2><i class="fas fa-tasks"></i> Bulk Operations</h2>
                <div class="bulk-actions">
                    <select id="bulk-action">
                        <option value="email">Send Email to Selection</option>
                        <option value="status">Change Status</option>
                        <option value="export">Export Selected</option>
                        <option value="delete">Delete Selected</option>
                        <option value="notify">Send Notification</option>
                    </select>
                    <button onclick="executeBulkAction()" class="btn-action">
                        <i class="fas fa-play"></i> Execute Bulk Action
                    </button>
                </div>
                
                <h3>User Selection</h3>
                <div class="toolbar">
                    <input type="text" id="bulk-user-search" placeholder="Search users to select...">
                    <button class="btn-action" onclick="selectAllUsers()">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn-warning" onclick="clearSelection()">
                        <i class="fas fa-times-circle"></i> Clear Selection
                    </button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th width="50"><input type="checkbox" id="select-all-checkbox"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="bulk-users-table">
                        <tr>
                            <td><input type="checkbox" class="user-checkbox" data-user-id="1"></td>
                            <td>John Doe</td>
                            <td>john.doe@nchsm.ac.ke</td>
                            <td>Student</td>
                            <td><span class="badge badge-success">Active</span></td>
                            <td>2 hours ago</td>
                        </tr>
                        <tr>
                            <td><input type="checkbox" class="user-checkbox" data-user-id="2"></td>
                            <td>Jane Smith</td>
                            <td>jane.smith@nchsm.ac.ke</td>
                            <td>Lecturer</td>
                            <td><span class="badge badge-success">Active</span></td>
                            <td>1 day ago</td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="bulk-selection-results" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>Selected:</strong> <span id="selected-count">0</span> users</p>
                </div>
            </section>

            <!-- API Management Section -->
            <section id="api-management" class="tab-content">
                <h2><i class="fas fa-key"></i> API Key Management</h2>
                <div class="api-keys-list">
                    <div class="api-key-item">
                        <div>
                            <span class="key-name">Mobile App API</span>
                            <span class="key-token">sk_live_***789abc</span>
                        </div>
                        <button onclick="regenerateKey('mobile')" class="btn-danger">
                            <i class="fas fa-sync-alt"></i> Regenerate
                        </button>
                    </div>
                    <div class="api-key-item">
                        <div>
                            <span class="key-name">External Integration</span>
                            <span class="key-token">sk_test_***456def</span>
                        </div>
                        <button onclick="regenerateKey('external')" class="btn-danger">
                            <i class="fas fa-sync-alt"></i> Regenerate
                        </button>
                    </div>
                </div>
                
                <button onclick="generateNewAPIKey()" class="btn-action">
                    <i class="fas fa-plus"></i> Generate New API Key
                </button>
                
                <h3>API Usage Statistics</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Total API Calls</h3>
                        <p class="data">12,458</p>
                        <p class="minor-data">Last 30 days</p>
                    </div>
                    <div class="card">
                        <h3>Success Rate</h3>
                        <p class="data">99.2%</p>
                        <p class="minor-data">API response success</p>
                    </div>
                    <div class="card">
                        <h3>Avg Response Time</h3>
                        <p class="data">180ms</p>
                        <p class="minor-data">Across all endpoints</p>
                    </div>
                </div>
            </section>

            <!-- Notification Center Section -->
            <section id="notification-center" class="tab-content">
                <h2><i class="fas fa-bell"></i> System Notification Center</h2>
                <form id="custom-notification-form" class="inline-form">
                    <select id="notification-audience" required>
                        <option value="all">All Users</option>
                        <option value="students">Students Only</option>
                        <option value="staff">Staff Only</option>
                        <option value="admins">Admins Only</option>
                        <option value="custom">Custom Selection</option>
                    </select>
                    
                    <input type="text" id="notification-title" placeholder="Notification Title" required>
                    
                    <textarea id="notification-message" placeholder="Message" required rows="3"></textarea>
                    
                    <select id="notification-priority">
                        <option value="low">Low Priority</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">High Priority</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    
                    <button type="submit" class="btn-action">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                </form>
                
                <h3>Recent Notifications</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Audience</th>
                            <th>Priority</th>
                            <th>Sent By</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="notifications-table">
                        <tr>
                            <td>System Maintenance Tonight</td>
                            <td>All Users</td>
                            <td><span class="badge badge-warning">High</span></td>
                            <td>Super Admin</td>
                            <td>Today, 10:30 AM</td>
                            <td><span class="badge badge-success">Delivered</span></td>
                            <td>
                                <button class="btn-action"><i class="fas fa-eye"></i> View</button>
                                <button class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Quick Actions Section -->
            <section id="quick-actions" class="tab-content">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                <div class="quick-action-buttons">
                    <button onclick="quickAction('clearCache')" class="quick-btn">
                        <i class="fas fa-sync-alt" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Clear Cache
                    </button>
                    <button onclick="quickAction('runMaintenance')" class="quick-btn">
                        <i class="fas fa-tools" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Run Maintenance
                    </button>
                    <button onclick="quickAction('sendTestEmail')" class="quick-btn">
                        <i class="fas fa-envelope" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Test Email
                    </button>
                    <button onclick="quickAction('generateReports')" class="quick-btn">
                        <i class="fas fa-chart-bar" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Generate Reports
                    </button>
                    <button onclick="quickAction('checkUpdates')" class="quick-btn">
                        <i class="fas fa-cloud-download-alt" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Check Updates
                    </button>
                    <button onclick="quickAction('backupNow')" class="quick-btn">
                        <i class="fas fa-database" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Backup Now
                    </button>
                    <button onclick="quickAction('healthCheck')" class="quick-btn">
                        <i class="fas fa-stethoscope" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        Health Check
                    </button>
                    <button onclick="quickAction('userAudit')" class="quick-btn">
                        <i class="fas fa-user-shield" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        User Audit
                    </button>
                </div>
                
                <h3>Recent Quick Actions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>Initiated By</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="quick-actions-log">
                        <tr>
                            <td>Clear Cache</td>
                            <td>Super Admin</td>
                            <td>10 minutes ago</td>
                            <td><span class="badge badge-success">Completed</span></td>
                            <td>Cache cleared successfully</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Security & 2FA Section -->
            <section id="security-2fa" class="tab-content">
                <h2><i class="fas fa-lock"></i> Two-Factor Authentication Settings</h2>
                <div class="security-settings">
                    <label>
                        <input type="checkbox" id="force-2fa-admins" checked>
                        Require 2FA for all Admins
                    </label>
                    <label>
                        <input type="checkbox" id="force-2fa-lecturers">
                        Require 2FA for Lecturers
                    </label>
                    <label>
                        <input type="checkbox" id="force-2fa-students">
                        Require 2FA for Students (Optional)
                    </label>
                    
                    <button onclick="enable2FAForAll()" class="btn-action" style="margin-top: 15px;">
                        <i class="fas fa-shield-alt"></i> Enable 2FA System-wide
                    </button>
                </div>
                
                <h3>2FA Enrollment Status</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Admins with 2FA</h3>
                        <p class="data">12/15</p>
                        <p class="minor-data">80% enrolled</p>
                    </div>
                    <div class="card">
                        <h3>Lecturers with 2FA</h3>
                        <p class="data">8/24</p>
                        <p class="minor-data">33% enrolled</p>
                    </div>
                    <div class="card">
                        <h3>Students with 2FA</h3>
                        <p class="data">45/320</p>
                        <p class="minor-data">14% enrolled</p>
                    </div>
                </div>
            </section>

            <!-- Session Management Section -->
            <section id="session-management" class="tab-content">
                <h2><i class="fas fa-user-clock"></i> Active Sessions Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>IP Address</th>
                            <th>Login Time</th>
                            <th>Last Activity</th>
                            <th>Device/Browser</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="active-sessions-table">
                        <tr>
                            <td>John Doe</td>
                            <td>Student</td>
                            <td>192.168.1.105</td>
                            <td>Today, 09:15 AM</td>
                            <td>5 minutes ago</td>
                            <td>Chrome on Windows</td>
                            <td>
                                <button class="btn-warning"><i class="fas fa-sign-out-alt"></i> Terminate</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <button onclick="terminateAllSessions()" class="btn-danger" style="margin-top: 20px;">
                    <i class="fas fa-radiation-alt"></i> Terminate All Sessions
                </button>
                
                <h3>Session Statistics</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Active Sessions</h3>
                        <p class="data">18</p>
                        <p class="minor-data">Currently logged in</p>
                    </div>
                    <div class="card">
                        <h3>Avg Session Duration</h3>
                        <p class="data">34m</p>
                        <p class="minor-data">Across all users</p>
                    </div>
                    <div class="card">
                        <h3>Concurrent Peak</h3>
                        <p class="data">42</p>
                        <p class="minor-data">Today at 11:00 AM</p>
                    </div>
                </div>
            </section>

            <!-- Error Tracking Section -->
            <section id="error-tracking" class="tab-content">
                <h2><i class="fas fa-bug"></i> Error Tracking & Debugging</h2>
                <div class="error-logs">
                    <div class="error-severity-filters">
                        <button onclick="filterErrors('critical')" class="btn-danger">Critical</button>
                        <button onclick="filterErrors('warning')" class="btn-warning">Warnings</button>
                        <button onclick="filterErrors('info')" class="btn-info">Info</button>
                        <button onclick="filterErrors('all')" class="btn-action">All Errors</button>
                    </div>
                    
                    <table id="error-logs-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Severity</th>
                                <th>Error Message</th>
                                <th>User Affected</th>
                                <th>Page/Component</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Today, 10:22 AM</td>
                                <td><span class="badge badge-danger">Critical</span></td>
                                <td>Database connection timeout</td>
                                <td>Multiple users</td>
                                <td>Attendance module</td>
                                <td>
                                    <button class="btn-action"><i class="fas fa-search"></i> Investigate</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>Error Statistics</h3>
                <div class="cards">
                    <div class="card">
                        <h3>Errors Today</h3>
                        <p class="data">4</p>
                        <p class="minor-data">2 critical, 2 warnings</p>
                    </div>
                    <div class="card">
                        <h3>Error Rate</h3>
                        <p class="data">0.08%</p>
                        <p class="minor-data">Of total requests</p>
                    </div>
                    <div class="card">
                        <h3>Avg Resolution Time</h3>
                        <p class="data">2.4h</p>
                        <p class="minor-data">For critical errors</p>
                    </div>
                </div>
            </section>

            <!-- Data Visualization Section -->
            <section id="data-visualization" class="tab-content">
                <h2><i class="fas fa-chart-bar"></i> Advanced Data Visualization</h2>
                <div class="viz-controls">
                    <select id="viz-time-range">
                        <option value="7d">Last 7 Days</option>
                        <option value="30d" selected>Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                        <option value="1y">Last Year</option>
                    </select>
                    <select id="viz-metric">
                        <option value="logins">User Logins</option>
                        <option value="attendance">Attendance Rates</option>
                        <option value="performance">Academic Performance</option>
                        <option value="resources">Resource Usage</option>
                        <option value="engagement">User Engagement</option>
                    </select>
                    <button class="btn-action" onclick="updateVisualization()">
                        <i class="fas fa-sync-alt"></i> Update Charts
                    </button>
                </div>
                
                <div id="advanced-charts-container">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>User Activity Over Time</h4>
                            <div style="height: 250px; background: #f5f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                                Line Chart - User Activity
                            </div>
                        </div>
                        <div class="analytics-card">
                            <h4>Resource Usage by Type</h4>
                            <div style="height: 250px; background: #f5f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                                Pie Chart - Resource Types
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Original Sections (Keep existing functionality) -->
            <section id="users" class="tab-content">
                <h2>System Users</h2>
                <p>Manage all user accounts (Admin, Student, Lecturer, etc.) and assign roles.</p>
                <div class="toolbar">
                    <input type="text" id="user-search" placeholder="Search by Name or Email..." onkeyup="filterTable('user-search', 'users-table', [1, 2, 4])">
                    <button onclick="exportTableToCSV('users-table', 'System_Users_Export.csv')" class="btn-action export-btn">Export Users (CSV)</button>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Program</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="users-table">
                        <tr><td colspan="7">Loading users...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="pending" class="tab-content">
                <h2>Pending Approvals</h2>
                <p>Accounts listed below require approval before they can log in. <strong>Edit user details first, then approve.</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Program</th>
                            <th>Student ID</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pending-table">
                        <tr><td colspan="7">Loading pending users...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="enroll" class="tab-content"> 
                <h2>Enroll Accounts</h2>
                <p>Use the form below to **enroll new Student, Admin, or Lecturer accounts**.</p>
                <form id="add-account-form" class="inline-form">
                    <input type="text" id="account-name" placeholder="Full Name" required>
                    <input type="email" id="account-email" placeholder="Email" required>
                    <input type="password" id="account-password" placeholder="Password" required autocomplete="new-password"> 
                    <select id="account-role" required>
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                        <option value="lecturer">Lecturer</option> 
                    </select>
                    <input type="text" id="account-phone" placeholder="Phone" required>
                    <select id="account-program" required>
                        <option value="">-- Select Program --</option>
                        <option value="KRCHN">KRCHN Students</option>
                        <option value="TVET">TVET Students</option>
                    </select>
                    <select id="account-intake" required>
                        <option value="">-- Select Intake Year --</option>
                        <option value="2024">March 2024</option>
                        <option value="2025">March 2025</option>
                        <option value="2026">March 2026</option>
                        <option value="2027">March 2027</option>
                        <option value="2028">March 2028</option>
                    </select>
                    <select id="account-block-term" required>
                        <option value="">-- Select Block/Term --</option>
                    </select>
                    <button type="submit">Enroll Account</button>
                </form>
                
                <hr>
                
                <h3>Mass Student Block/Term Promotion (End of Term) ðŸš€</h3>
                <p>Advance all students from one Block/Term to the next.</p>
                <form id="mass-promotion-form" class="inline-form">
                    <select id="promote_intake" required>
                        <option value="">-- Select Intake Year --</option>
                        <option value="2024">March 2024</option>
                        <option value="2025">March 2025</option>
                    </select>
                    <select id="promote_from_block" required>
                        <option value="">-- Promote Students FROM --</option>
                    </select>
                    <select id="promote_to_block" required>
                        <option value="">-- Promote Students TO --</option>
                    </select>
                    <button type="submit" class="btn-danger">Execute Mass Promotion</button>
                </form>
                <p class="warning-text" id="promotion-warning" style="color: red; margin-top: 5px;">
                    **WARNING:** This action is irreversible and affects all active students in the 'FROM' group.
                </p>

                <hr>

                <h3>Enrolled Students (For quick reference)</h3>
                <div class="toolbar">
                    <button onclick="exportTableToCSV('students-table', 'Enrolled_Students_Export.csv')" class="btn-action export-btn">Export Student List (CSV)</button>
                </div>
                <input type="text" id="student-search" placeholder="Search Students..." onkeyup="filterTable('student-search', 'students-table', [1, 3, 5])">
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Program</th><th>Intake</th><th>Block/Term</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="students-table">
                        <tr><td colspan="9">Loading students...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="courses" class="tab-content">
                <h2>Courses</h2>

                <!-- Add Course Form -->
                <form id="add-course-form" class="inline-form">
                    <input type="text" id="course-name" placeholder="Course Name" required>
                    <input type="text" id="course-unit-code" placeholder="Unit Code (e.g., NURS101)" required>
                    <input type="text" id="course-description" placeholder="Description (Optional)">

                    <select id="course-program" required>
                        <option value="">-- Select Program Type --</option>
                        <option value="KRCHN">KRCHN</option>
                        <option value="TVET">TVET</option>
                    </select>

                    <select id="course-intake">
                        <option value="">-- Select Intake Year --</option>
                        <option value="2024">March 2024</option>
                        <option value="2025">March 2025</option>
                        <option value="2026">March 2026</option>
                        <option value="2027">March 2027</option>
                        <option value="2028">March 2028</option>
                    </select>

                    <select id="course-block">
                        <option value="">-- Select Block/Term --</option>
                    </select>

                    <button type="submit">Add Course</button>
                </form>

                <!-- Toolbar -->
                <div class="toolbar">
                    <input type="text" id="course-search" placeholder="Search Courses..." 
                           onkeyup="filterTable('course-search', 'courses-table', [0, 1, 3])">
                    <button onclick="exportTableToCSV('courses-table', 'Course_Catalog_Export.csv')" 
                            class="btn-action export-btn">
                        Export Courses (CSV)
                    </button>
                </div>

                <!-- Course Table -->
                <table>
                    <thead>
                        <tr>
                            <th>Course Name</th>
                            <th>Unit Code</th>
                            <th>Program</th>
                            <th>Intake</th>
                            <th>Block/Term</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="courses-table">
                        <tr><td colspan="6">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="sessions" class="tab-content">
                <h2>Manage Sessions (Class, Clinical, Events)</h2>
                <p>Add and manage scheduled sessions. These will be automatically linked to the <strong>System Calendar</strong>.</p>

                <h3>Add New Session</h3>
                <form id="add-session-form" class="inline-form">
                    <select id="new_session_type" required>
                        <option value="">-- Select Session Type --</option>
                        <option value="class">Class Session</option>
                        <option value="clinical">Clinical Rotation</option>
                        <option value="event">General Event</option>
                    </select>

                    <input type="text" id="new_session_title" placeholder="Title/Topic" required>
                    <input type="date" id="new_session_date" required>
                    <input type="time" id="new_session_start_time" placeholder="Start Time" required>
                    <input type="time" id="new_session_end_date" placeholder="End Time (Optional)">

                    <select id="new_session_program" required>
                        <option value="">-- Select Program --</option>
                        <option value="KRCHN">KRCHN</option>
                        <option value="TVET">TVET</option>
                    </select>

                    <select id="new_session_intake_year" required>
                        <option value="">-- Select Intake Year --</option>
                        <option value="2024">March 2024</option>
                        <option value="2025">March 2025</option>
                        <option value="2026">March 2026</option>
                        <option value="2027">March 2027</option>
                        <option value="2028">March 2028</option>
                    </select>

                    <select id="new_session_block_term" required>
                        <option value="">-- Select Block/Term --</option>
                        <option value="A">Block A</option>
                        <option value="B">Block B</option>
                        <option value="Term 1">Term 1</option>
                        <option value="Term 2">Term 2</option>
                        <option value="Term 3">Term 3</option>
                    </select>

                    <select id="new_session_course">
                        <option value="">-- Select Course (Optional) --</option>
                    </select>

                    <button type="submit">Schedule Session</button>
                </form>

                <hr>

                <h3>Scheduled Sessions</h3>
                <div class="toolbar">
                    <button onclick="exportTableToCSV('scheduledSessionsTableBody', 'Scheduled_Sessions_Export.csv')" class="btn-action export-btn">
                        Export Sessions (CSV)
                    </button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Date/Time</th>
                            <th>Program</th>
                            <th>Block/Term</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="scheduledSessionsTableBody">
                        <tr><td colspan="6">Loading scheduled sessions...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2 style="color: #4C1D95;">Daily Attendance & Geo Check-in</h2>
                <h3>Admin/Lecturer Self Check-in (Mark My Attendance) ðŸ“</h3>
                <p>Check in your own presence for the day. (Uses current location/time, requires Geo-location access).</p>
                <button onclick="adminCheckIn()" class="btn-action">Mark My Attendance Now</button>
                
                <hr>
                
                <h3>Admin/Super Admin Manual Student Check-in</h3>
                <p>Use this form to manually mark attendance for a student.</p>
                <form id="manual-attendance-form" class="inline-form">
                    <select id="att_student_id" required><option value="">-- Select Student --</option></select>
                    <select id="att_session_type" required>
                        <option value="">-- Select Session Type --</option>
                        <option value="classroom">Classroom</option>
                        <option value="clinical">Clinical Rotation</option>
                        <option value="virtual">Virtual</option>
                        <option value="call">On Call</option>
                    </select>
                    <input type="text" id="att_department" placeholder="Department/Area" required>
                    <select id="att_course_id"><option value="">-- Select Course (Optional) --</option></select>
                    <input id="att_location" placeholder="Location">
                    <input id="att_date" type="date" required>
                    <input id="att_time" type="time">
                    <button type="submit" class="btn-action">Mark Attendance</button>
                </form>

                <div id="attendance-records">
                    <h3 style="color: #4C1D95;">Today's Attendance Records (Pending & Verified)</h3>
                    <input type="text" id="attendance-search" placeholder="Search by Student Name..." onkeyup="filterTable('attendance-search', 'attendance-table', [0, 1, 2])">
                    <div class="toolbar">
                        <button onclick="exportTableToCSV('attendance-table', 'Todays_Attendance_Export.csv')" class="btn-action export-btn">Export Today's Records (CSV)</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Session Type</th>
                                <th>Target (Course/Clinical)</th>
                                <th>Department/Location</th>
                                <th>Date/Time</th>
                                <th>Geo Data</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table">
                            <tr><td colspan="7">Loading today's records...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="past-attendance-history">
                    <h3 style="color: #4C1D95;">Past Attendance History (All Users)</h3>
                    <p>Records from previous days for all users.</p>
                    <div class="toolbar">
                        <button onclick="exportTableToCSV('past-attendance-table', 'Past_Attendance_History_Export.csv')" class="btn-action export-btn">Export History (CSV)</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Session Type</th>
                                <th>Target (Course/Clinical)</th>
                                <th>Date/Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="past-attendance-table">
                            <tr><td colspan="6">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
       <section id="cats" class="tab-content">
    <h2>CATS / Exams Administration</h2>
    <p>
        Post online or manage scheduled assessments. Selecting a <strong>Program</strong>
        dynamically filters the <strong>Course</strong>, while <strong>Block/Term</strong> is now fixed.
    </p>

    <form id="add-exam-form" class="inline-form">
        <select id="exam_type" required>
            <option value="">-- Select Type --</option>
            <option value="EXAM">Final Exam</option>
            <option value="CAT">Continuous Assessment Test (CAT)</option>
            <option value="CAT_1">CAT 1</option>
            <option value="CAT_2">CAT 2</option>
            <option value="ASSIGNMENT">Assignment</option>
        </select>

        <select id="exam_program" required>
            <option value="">-- Select Program --</option>
            <option value="KRCHN">KRCHN</option>
            <option value="TVET">TVET</option>
        </select>

        <!-- Course now optional -->
        <select id="exam_course_id">
            <option value="">-- Optional: Select Course --</option>
        </select>

        <input type="text" id="exam_title" placeholder="Assessment Title" required>

        <input
            type="url"
            id="exam_link"
            placeholder="(Optional) Online Exam/Quiz Link"
        >

        <input
            type="number"
            id="exam_duration_minutes"
            placeholder="Duration (Minutes, e.g., 60)"
            required
            min="5"
        >

        <input type="date" id="exam_date" required>
        <input type="time" id="exam_start_time" required>

        <select id="exam_status">
            <option value="Upcoming">Upcoming</option>
            <option value="Completed">Completed</option>
            <option value="InProgress">In Progress</option>
        </select>

        <select id="exam_intake">
            <option value="">-- Select Intake Year --</option>
            <option value="2024">March 2024</option>
            <option value="2025">March 2025</option>
            <option value="2026">March 2026</option>
            <option value="2027">March 2027</option>
            <option value="2028">March 2028</option>
        </select>

        <!-- âœ… Hardcoded Block/Term -->
        <select id="exam_block_term" required>
            <option value="">-- Select Block/Term --</option>
            <option value="A">Block A</option>
            <option value="B">Block B</option>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
        </select>

        <button type="submit">Post Assessment</button>
    </form>

    <div class="toolbar">
        <input type="text" id="exam-search" placeholder="Search Assessments...">
        <button onclick="exportTableToCSV('exams-table', 'Assessments_Export.csv')" class="btn-action export-btn">Export Assessments (CSV)</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Type</th>
                <th>Program</th>
                <th>Course</th>
                <th>Title</th>
                <th>Date/Time</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="exams-table">
            <tr><td colspan="8">Loading assessments...</td></tr>
        </tbody>
    </table>

    <h3>Available Assessments (Students Portal Preview)</h3>
    <div id="student-exams">
        <p>Loading available assessments...</p>
    </div>
</section>

<!-- Exam Edit Modal -->
<div id="examEditModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Exam</h3>
            <span class="close" onclick="document.getElementById('examEditModal').style.display='none'">&times;</span>
        </div>
        <form id="edit-exam-form">
            <input type="hidden" id="edit_exam_id">
            
            <div class="form-group">
                <label>Exam Type *</label>
                <select id="edit_exam_type" class="form-input" required>
                    <option value="CAT_1">CAT 1</option>
                    <option value="CAT_2">CAT 2</option>
                    <option value="CAT">CAT (Generic)</option>
                    <option value="EXAM">Final Exam</option>
                    <option value="ASSIGNMENT">Assignment</option>
                </select>
            </div>

            <div class="form-group">
                <label>Exam Title *</label>
                <input type="text" id="edit_exam_title" class="form-input" required>
            </div>

            <div class="form-group">
                <label>Exam Date *</label>
                <input type="date" id="edit_exam_date" class="form-input" required>
            </div>

            <div class="form-group">
                <label>Exam Time *</label>
                <input type="time" id="edit_exam_start_time" class="form-input" required>
            </div>

            <div class="form-group">
                <label>Duration (minutes) *</label>
                <input type="number" id="edit_exam_duration" class="form-input" min="5" required>
            </div>

            <div class="form-group">
                <label>Online Link (Optional)</label>
                <input type="url" id="edit_exam_link" class="form-input" placeholder="https://...">
            </div>

            <div class="form-group">
                <label>Status</label>
                <select id="edit_exam_status" class="form-input">
                    <option value="Upcoming">Upcoming</option>
                    <option value="InProgress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-action">Save Changes</button>
                <button type="button" class="btn btn-delete" onclick="document.getElementById('examEditModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Grade Modal (Dynamic based on exam type) -->
<div id="gradeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 id="gradeModalTitle">Grade Students</h3>
            <span class="close" onclick="closeGradeModal()">&times;</span>
        </div>
        <div class="modal-body" id="gradeModalBody">
            <!-- Grade modal content will be loaded dynamically -->
            <div id="gradeModalLoading">
                <div class="loading-spinner"></div>
                <p>Loading grading interface...</p>
            </div>
        </div>
    </div>
</div>
            <section id="resources" class="tab-content">
                <h2>Resource Center</h2>
                <p>Upload files to share with students based on their program, intake year, and block/term.</p>

                <form id="upload-resource-form" class="inline-form">
                    <!-- Program -->
                    <select id="resource_program" required>
                        <option value="">-- Select Program --</option>
                        <option value="KRCHN">KRCHN</option>
                        <option value="TVET">TVET</option>
                    </select>

                    <!-- Intake Year -->
                    <select id="resource_intake" required>
                        <option value="">-- Select Intake Year --</option>
                        <option value="2024">March 2024</option>
                        <option value="2025">March 2025</option>
                        <option value="2026">March 2026</option>
                        <option value="2027">March 2027</option>
                        <option value="2028">March 2028</option>
                    </select>

                    <!-- Block / Term -->
                    <select id="resource_block" required>
                        <option value="">-- Select Block/Term --</option>
                        <option value="A">Block A</option>
                        <option value="B">Block B</option>
                        <option value="Term 1">Term 1</option>
                        <option value="Term 2">Term 2</option>
                        <option value="Term 3">Term 3</option>
                    </select>

                    <!-- File Upload -->
                    <input 
                        type="file" 
                        id="resource-file" 
                        required
                        accept=".pdf, .doc, .docx, .ppt, .pptx, .xls, .xlsx"
                        title="Accepts PDF and common Microsoft Office documents."
                    >

                    <!-- Title -->
                    <input type="text" id="resource-title" placeholder="Title for file" required>

                    <button type="submit">Upload</button>
                </form>

                <div class="toolbar">
                    <input 
                        type="text" 
                        id="resource-search" 
                        placeholder="Search Resources..." 
                        onkeyup="filterTable('resource-search', 'resources-list', [0,1,2,3])"
                    >
                    <button 
                        onclick="exportTableToCSV('resources-list', 'Resource_Index_Export.csv')" 
                        class="btn-action export-btn">
                        Export Resource List (CSV)
                    </button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Program</th>
                            <th>Title</th>
                            <th>Intake</th>
                            <th>Block/Term</th>
                            <th>Uploaded By</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resources-list">
                        <tr><td colspan="7">Loading resources...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="messages" class="tab-content">
                <h2>Inbox / Messages</h2>

                <form id="send-message-form" class="inline-form">
                    <select id="msg_program" required>
                        <option value="">-- Select Program --</option>
                        <option value="ALL">ALL Students</option>
                        <option value="KRCHN">KRCHN Students</option>
                        <option value="TVET">TVET Students</option>
                    </select>
                    
                    <input type="text" id="msg_subject" placeholder="Message Subject" required>
                    <textarea id="msg_body" placeholder="Message Body" rows="3"></textarea>
                    <button type="submit">Send Message</button>
                </form>

                <div id="admin-official-announcement" style="margin-top:20px;">
                    <h3>ðŸ“£ Official Announcement</h3>
                    <textarea id="announcement-body" rows="4" placeholder="Type the official announcement here..."></textarea>
                    <br/>
                    <button id="save-announcement">Save Announcement</button>
                    <span id="announcement-feedback"></span>
                </div>

                <h3>Recent Messages (Admin Table)</h3>
                <div class="toolbar">
                    <input type="text" id="message-search" placeholder="Search Messages..." onkeyup="filterTable('message-search', 'adminMessagesTableBody', [0, 1, 2, 3])">
                    <button onclick="exportTableToCSV('adminMessagesTableBody', 'Message_History_Export.csv')" class="btn-action export-btn">Export Messages (CSV)</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>To Program</th>
                            <th>Sender</th>
                            <th>Subject</th>
                            <th>Message Body</th>
                            <th>Date Sent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminMessagesTableBody">
                        <tr><td colspan="6">Loading admin messages...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="calendar" class="tab-content">
                <h2>System Calendar</h2>
                <p>This calendar will display all scheduled Sessions, Exams/CATS, and Clinical Rotations.</p>
                <div id="fullCalendarDisplay"></div> 
            </section>
            
            <section id="welcome-editor" class="tab-content">
                <h2>Edit Student Welcome Message</h2>
                <p>The **Save Welcome Message** button must update the live message on the student-facing site.</p>
                <form id="edit-welcome-form">
                    <textarea id="welcome-message-editor" rows="20" placeholder="Paste the HTML content for the Welcome Message here..."></textarea>
                    <button type="submit" class="btn-action">Save Welcome Message</button>
                </form>
                <h3>Current Live Preview</h3>
                <div id="live-preview">
                    <p>Loading live preview...</p>
                </div>
            </section>

            <section id="audit" class="tab-content">
                <h2>Audit & Security Logs ðŸ”</h2>
                <p>Track every critical administrative action (user changes, file deletions, major system updates).</p>
                
                <h3>Filter Logs</h3>
                <div class="toolbar">
                    <select id="log-filter-user"><option value="">-- Filter by User --</option></select>
                    <select id="log-filter-action"><option value="">-- Filter by Action Type --</option></select>
                    <input type="date" id="log-filter-date-start">
                    <input type="date" id="log-filter-date-end">
                    <button onclick="fetchAuditLogs()" class="btn-action">Apply Filters</button>
                    <button onclick="exportTableToCSV('audit-table', 'Audit_Log_Export.csv')" class="btn-action export-btn">Export All (CSV)</button>
                </div>
                
                <table>
                    <thead>
                        <tr><th>Timestamp</th><th>User/Role</th><th>Action Type</th><th>Details (Target ID)</th><th>Status</th></tr>
                    </thead>
                    <tbody id="audit-table">
                        <tr><td colspan="5">Loading recent critical events...</td></tr>
                    </tbody>
                </table>
            </section>
            
            <section id="security" class="tab-content">
                <h2>System Security & Settings</h2>
                
                <hr>
                <h3>Global System Status Management (The Kill Switch) ðŸ›‘</h3>
                <p>Allows immediate, controlled system status changes for maintenance or security incidents.</p>

                <div class="inline-form">
                    <label for="global_status" style="font-weight: bold;">Current System Status:</label>
                    <select id="global_status" onchange="updateSystemStatus(this.value)">
                        <option value="ACTIVE">System Online (ACTIVE)</option>
                        <option value="MAINTENANCE">Maintenance Mode (Login Disabled)</option>
                        <option value="EMERGENCY_LOCKDOWN">EMERGENCY LOCKDOWN (All Access Disabled)</option>
                    </select>
                </div>

                <div id="status_details" style="margin-top: 10px;">
                    <textarea id="maintenance_message" rows="3" placeholder="Enter the message users will see (e.g., 'System down for urgent maintenance. Back at 5 PM')."></textarea>
                    <button onclick="saveSystemMessage()" class="btn-action">Save System Message</button>
                </div>
                <hr>

                <h3>Force Password Reset</h3>
                <p>Use this tool for an immediate, targeted password reset for any user via their email.</p>
                <form id="global-password-reset-form" class="inline-form">
                    <input type="email" id="reset_user_email" placeholder="User Email Address" required>
                    <input type="password" id="new_password" placeholder="New Password" required autocomplete="new-password"> 
                    <button type="submit" class="btn-danger">Force Password Reset</button>
                </form>

                <hr>

                <h3>Account Deactivation</h3>
                <p>Block a user from logging in by entering their account ID.</p>
                <form id="account-deactivation-form" class="inline-form">
                    <input type="text" id="deactivate_user_id" placeholder="User ID to Deactivate" required>
                    <button type="submit" class="btn-danger">Deactivate Account</button>
                </form>
            </section>

            <section id="backup" class="tab-content">
                <h2>Database Backup & Restore</h2>
                <p>Manage database backups to prevent data loss. </p>
                
                <h3>Backup Actions</h3>
                <button onclick="triggerBackup()" class="btn-action">Generate New Backup (.sql)</button>
                
                <hr>

                <h3>Restore Database</h3>
                <p>WARNING: Restoring will overwrite current live data. Use with caution.</p>
                <form id="restore-form">
                    <input type="file" id="restore-file" accept=".sql" required>
                    <button type="submit" class="btn-danger">Restore from File</button>
                </form>
                
                <hr>
                
                <h3>Recent Backups</h3>
                <div class="toolbar">
                    <button onclick="exportTableToCSV('backup-history-table', 'Backup_History_Index_Export.csv')" class="btn-action export-btn">Export Backup Index (CSV)</button>
                </div>
                <table>
                    <thead><tr><th>File Name</th><th>Date</th><th>Size</th><th>Actions</th></tr></thead>
                    <tbody id="backup-history-table"><tr><td colspan="4">Loading backup history...</td></tr></tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('mapModal')">&times;</span>
            <h2>Geo Location Map</h2>
            <div id="mapbox-map" style="height: 400px;">Map will load here...</div> 
            <p id="map-details"></p>
        </div>
    </div>
    
    <div id="courseEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('courseEditModal')">&times;</span>
            <h2>Edit Course Details</h2>
            <form id="edit-course-form">
                <input type="hidden" id="edit_course_id"> 
                
                <label for="edit_course_name">Course Name</label>
                <input type="text" id="edit_course_name" required>
                
                <label for="edit_course_unit_code">Unit Code</label>
                <input type="text" id="edit_course_unit_code" required>
                
                <label for="edit_course_description">Description (Optional)</label>
                <textarea id="edit_course_description" rows="3"></textarea>
                
                <hr>

                <label for="edit_course_program">Target Program</label>
                <select id="edit_course_program" required onchange="updateBlockTermOptions('edit_course_program', 'edit_course_block')">
                    <option value="KRCHN">KRCHN</option>
                    <option value="TVET">TVET</option>
                </select>
                
                <label for="edit_course_intake">Intake Year</label>
                <select id="edit_course_intake">
                    <option value="2024">March 2024</option>
                    <option value="2025">March 2025</option>
                    <option value="2026">March 2026</option>
                    <option value="2027">March 2027</option>
                    <option value="2028">March 2028</option>
                </select>
                
                <label for="edit_course_block">Block/Term</label>
                <select id="edit_course_block">
                    <option value="">-- Select Block/Term --</option>
                </select>

                <div class="modal-actions">
                    <button type="submit" class="btn-action">Update Course</button>
                    <button type="button" onclick="closeModal('courseEditModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="userEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userEditModal')">&times;</span>
            <h2>Edit User Profile</h2>
            
            <form id="edit-user-form">
                <input type="hidden" id="edit_user_id"> 
                <p class="subtitle">Editing User ID: <span id="edit_user_id_display">N/A</span></p>

                <label for="edit_user_name">Full Name</label>
                <input type="text" id="edit_user_name" required>

                <label for="edit_user_email">Email</label>
                <input type="email" id="edit_user_email" required>

                <label for="edit_user_role">Role</label>
                <select id="edit_user_role" required>
                    <option value="student">Student</option>
                    <option value="lecturer">Lecturer</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
                
                <label for="edit_user_program">Program Type</label>
                <select id="edit_user_program" required>
                    <option value="KRCHN">KRCHN</option>
                    <option value="TVET">TVET</option>
                </select>

                <label for="edit_user_intake">Intake Year</label>
                <input type="text" id="edit_user_intake" placeholder="e.g., 2024" required>
                
                <label for="edit_user_block">Block/Term</label>
                <select id="edit_user_block" required>
                    <option value="">-- Select Block/Term --</option>
                </select>

                <label for="edit_user_block_status">Program Blocked Status</label>
                <select id="edit_user_block_status" required>
                    <option value="false">Active (Not Blocked)</option>
                    <option value="true">BLOCKED</option>
                </select>
                
                <hr>
                <h3>Password Reset (Optional)</h3>
                <p id="password-reset-feedback" style="color: red;"></p>
                <label for="edit_user_new_password">New Password</label>
                <input type="password" id="edit_user_new_password" placeholder="Leave blank to keep current password" autocomplete="new-password"> 
                
                <label for="edit_user_confirm_password">Confirm New Password</label>
                <input type="password" id="edit_user_confirm_password" placeholder="Confirm new password" autocomplete="new-password"> 
                
                <button type="submit" class="btn-action">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script> 
    <script src="script.js"></script>

    <script>
        // Mobile Navigation Toggle
        document.getElementById('mobileNavToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
            this.classList.toggle('active');
        });

        // Close sidebar when clicking on a nav link (mobile)
        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const mobileToggle = document.getElementById('mobileNavToggle');
                sidebar.classList.remove('active');
                mobileToggle.classList.remove('active');
            });
        });
    </script>
</body>
</html>
