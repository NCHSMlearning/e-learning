<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NCHSM Super Admin Dashboard</title>   <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* --- NCHSM style (improved) --- */
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { 
      width: 250px; /* Slightly wider */
      background-color: #1A202C; /* Deeper, more neutral dark tone */
      color: #fff; 
      display: flex; 
      flex-direction: column; 
      padding: 20px; 
    }
    .sidebar-header { text-align: center; margin-bottom: 24px; }
    .sidebar-header img { width: 60px; margin-bottom: 10px; }
    .nav { list-style: none; padding: 0; flex-grow: 1; }
    .nav li { margin: 6px 0; }
    .nav a { 
      color: #CBD5E1; /* Lighter text */
      text-decoration: none; 
      padding: 12px 10px; /* More vertical padding */
      border-radius: 8px; /* Rounder corners */
      display: block; 
      transition: 0.15s; 
    }
    .nav a:hover { 
      background-color: #2D3748; /* Lighter background on hover */
      color: #E2E8F0; 
    }
    .nav a.active { 
      background-color: #3B82F6; 
      font-weight: 600; /* Bold the active link */
      color: #fff;
    }
    .logout { margin-top: auto; text-align: center; }
    .logout a { 
      display: inline-block; 
      margin-top: 10px; 
      padding: 10px 18px; /* Larger button */
      background-color: #DC2626; /* Stronger red */
      color: #fff; 
      text-decoration: none; 
      border-radius: 6px; 
      transition: background-color 0.2s;
    }

    /* Main Content */
    .main { flex: 1; padding: 20px 28px; overflow-y: auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px; } /* Increased margin */
    header h1 { margin: 0; font-size: 1.8rem; color: #0f172a; } /* Slightly larger title */
    .subtitle { color: #475569; }

    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 24px; } /* Increased gap */
    .card { 
      background-color: #fff; 
      padding: 20px; /* More padding */
      border-radius: 12px; /* Rounder corners */
      border: 1px solid #E2E8F0; /* Subtle border */
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Modern shadow */
      text-align: center; 
      cursor: pointer; 
      transition: transform 0.1s, box-shadow 0.1s; 
    }
    .card:hover {
      transform: translateY(-2px); /* Slight lift on hover */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .card h3 { margin: 4px 0 8px; font-size: 1.1rem; color: #0f172a; }
    .card p { margin: 0; font-weight: 700; font-size: 1.5rem; color: #0b2447; }

    /* Layout / Tabs */
    .section { display: none; }
    .section.active { display: block; }

    /* Tables */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white; 
      border-radius: 8px; 
      overflow:hidden; 
      margin-bottom: 20px; 
      border: 1px solid #E2E8F0; /* Subtle border */
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* Lighter shadow for table */
    }
    th, td { padding: 14px; border-bottom: 1px solid #E6EEF8; text-align: left; color:#1A202C; } /* Darker text */
    th { 
      background: #F1F5F9 !important; /* Lighter header background */
      color: #1E293B !important; 
      font-weight: 700 !important; 
    }
    tr:hover { background: #F8FAFC; }

    /* Forms */
    form {
      display: flex; 
      flex-wrap: wrap; 
      gap: 12px; /* Consistent spacing between elements */
      align-items: flex-end; /* Align inputs and buttons nicely */
    }
    form input, form select, form button, form textarea { 
      padding: 10px 12px; /* More padding */
      border-radius: 8px; /* Match other components */
      border: 1px solid #D2D6DC; 
      font-size: 0.95rem; 
      flex-grow: 1; /* Allow inputs to fill space */
      min-width: 180px;
    }
    form textarea { 
      flex-basis: 100%; /* Make textarea span full width */
      resize: vertical;
    }
    form button { 
      background:#3B82F6; 
      color:#fff; 
      border:none; 
      padding:11px 16px; /* Larger button */
      cursor:pointer; 
      border-radius:8px; 
      transition: background-color 0.2s;
      flex-grow: 0; /* Prevent button from stretching unnecessarily */
    }
    form button:hover {
      background: #2563EB;
    }
    form button.alt { background:#10B981; }

    /* small utility buttons */
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; color:#fff; font-size:.9rem; }
    .btn-approve { background:#059669; } /* Emerald Green */
    .btn-reject { background:#DC2626; } /* Stronger Red */
    .btn-delete { background:#F59E0B; } /* Amber Orange */
    .btn-edit { background:#3B82F6; }
    .btn-attendance { background:#0D9488; } 
    .btn-map { background:#7C3AED; } 

    .muted { font-size: .9rem; color:#6B7280; }
    .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .mb { margin-bottom:12px; }
    .center { text-align:center; }
    .file-input { display:inline-block; }
    .notice { padding:12px; background:#FFF7ED; border-left: 4px solid #F97316; border-radius:6px; margin-bottom:18px; color:#7C2D12; }

    /* Modal for Map */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
    }
    .modal-content {
      background-color: #fefefe; padding: 30px; border-radius: 12px; 
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      width: 90%; max-width: 800px;
    }
    .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 1; }
    .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
    #attendanceMap { height: 400px; width: 100%; margin-top: 20px; border-radius: 8px; }

    /* responsive */
    @media (max-width:900px){
      .sidebar{ display:none; }
      .container{ flex-direction:column; }
      .main{ padding:12px; }
      .cards { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="images/Logo_NCHSM.png" alt="Logo" onerror="this.style.display='none'"/>
        <h3>Super Admin</h3>
      </div>

      <ul class="nav" id="mainNav">
        <li><a href="#" class="active" onclick="showSection('dashboard', this)">Dashboard</a></li>
        <li><a href="#" onclick="showSection('users', this)">Users</a></li>
        <li><a href="#" onclick="showSection('students', this)">Students</a></li>
        <li><a href="#" onclick="showSection('courses', this)">Courses</a></li>
        <li><a href="#" onclick="showSection('attendance', this)">Attendance</a></li>
        <li><a href="#" onclick="showSection('exams', this)">Exams</a></li>
        <li><a href="#" onclick="showSection('messages', this)">Inbox</a></li>
        <li><a href="#" onclick="showSection('calendar', this)">Calendar</a></li>
        <li><a href="#" onclick="showSection('resources', this)">Resources</a></li>
        <li><a href="#" onclick="showSection('pending', this)">Pending Approvals</a></li>
      </ul>

      <div class="logout">
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </aside>

    <main class="main">
      <header>
        <div>
          <h1>Welcome, Super Admin</h1>           <p class="subtitle">Manage users, courses, attendance, exams, messages and resources</p>
        </div>
        <div class="muted" id="sessionInfo">Signed out</div>
      </header>

      <section id="dashboard" class="section active">
        <div class="cards" id="dashboardCards">
          <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
          <div class="card"><h3>Admins</h3><p id="totalAdmins">0</p></div>
          <div class="card"><h3>Students</h3><p id="totalStudents">0</p></div>
          <div class="card"><h3>Pending</h3><p id="totalPending">0</p></div>
        </div>
        <div class="mb">
          <div class="notice">This dashboard reads/writes directly to your Supabase project. If you get permission errors, check RLS policies and ensure the anon key is valid.</div>
        </div>
      </section>

      <section id="users" class="section">
        <h2>Users — Add new user (Admin or Student)</h2>

        <form id="addUserForm" class="mb">
          <input id="new_full_name" placeholder="Full name" required />
          <input id="new_email" placeholder="Email" type="email" required />
          <input id="new_phone" placeholder="Phone" />
          <input id="new_password" placeholder="Password" type="password" required />
          <select id="new_role">
            <option value="student">Student</option>
            <option value="admin">Admin</option>
          </select>
          <button type="submit">Create user</button>
        </form>

        <h3>All users</h3>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Approved</th><th>Actions</th></tr></thead>
          <tbody id="usersTable"></tbody>
        </table>
      </section>

      <section id="students" class="section">
        <h2>Students</h2>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="studentsTable"></tbody>
        </table>
      </section>

      <section id="courses" class="section">
        <h2>Courses</h2>
        <form id="addCourseForm" class="mb">
          <input id="course_name" placeholder="Course name" required />
          <input id="course_description" placeholder="Short description (optional)" />
          <button type="submit">Add course</button>
        </form>

        <h3>Course list</h3>
        <table>
          <thead><tr><th>Course</th><th>Actions</th></tr></thead>
          <tbody id="coursesTable"></tbody>
        </table>
      </section>

      <section id="attendance" class="section">
        <h2>Attendance</h2>

        <div class="flex mb">
          <button class="btn btn-attendance" onclick="markMyAttendance()">🧭 Mark My Attendance (Geo Log)</button>
          <button class="btn btn-map" onclick="showAttendanceMap()">🗺 View Latest Map</button>
        </div>

        <h3 class="muted">Manual Attendance Entry (Admin/Super Admin only)</h3>
        <form id="addAttendanceForm" class="mb">
          <select id="att_student_id"></select>
          <select id="att_session_type"><option value="classroom">Classroom</option><option value="clinical">Clinical</option></select>
          <select id="att_course_id"></select>
          <input id="att_location" placeholder="Location" />
          <input id="att_date" type="date" />
          <input id="att_time" type="time" />
          
          <input type="hidden" id="att_latitude" value="" />
          <input type="hidden" id="att_longitude" value="" />
          <input type="hidden" id="att_ip_address" value="" />
          <input type="hidden" id="att_device_id" value="" />
          <input type="hidden" id="att_marked_by" value="manual" />

          <button type="submit">Mark attendance (Manual)</button>
        </form>

        <h3>Attendance records</h3>
        <table>
          <thead><tr><th>Student</th><th>Type</th><th>Location/Time</th><th>Date</th><th>Geo-IP</th><th>Actions</th></tr></thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </section>

      <section id="exams" class="section">
        <h2>Exams / CATS</h2>
        <form id="addExamForm" class="mb">
          <select id="exam_course_id"></select>
          <input id="exam_title" placeholder="Exam title" required />
          <input id="exam_date" type="date" required />
          <select id="exam_status"><option>Upcoming</option><option>Completed</option></select>
          <button type="submit">Add exam</button>
        </form>

        <h3>Exams</h3>
        <table>
          <thead><tr><th>Course</th><th>Title</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="examsTable"></tbody>
        </table>
      </section>

      <section id="messages" class="section">
        <h2>Inbox / Send Message</h2>
        <form id="sendMessageForm" class="mb">
          <input id="msg_recipient" placeholder="Recipient email" required />
          <textarea id="msg_body" placeholder="Message" rows="3"></textarea>
          <button type="submit">Send</button>
        </form>

        <h3>Messages (recent)</h3>
        <table>
          <thead><tr><th>From</th><th>To</th><th>Message</th><th>Date</th></tr></thead>
          <tbody id="messagesTable"></tbody>
          </table>
      </section>

      <section id="calendar" class="section">
        <h2>Calendar</h2>
        <p class="muted">Simple calendar placeholder — we can wire to exams/attendance events later.</p>
        <div id="calendarPlaceholder" class="mb">[Calendar grid placeholder]</div>
      </section>

      <section id="resources" class="section">
        <h2>Resources (Uploads)</h2>
        <form class="mb">
          <label class="file-input">
            <input id="resourceFile" type="file" />
          </label>
          <input id="resourceTitle" placeholder="Title (optional)" />
          <button id="uploadResourceBtn" type="button">Upload to Storage</button>
        </form>

        <h3>Available resources</h3>
        <table>
          <thead><tr><th>File</th><th>Size</th><th>Actions</th></tr></thead>
          <tbody id="resourcesTable"></tbody>
        </table>
      </section>

      <section id="pending" class="section">
        <h2>Pending Approvals</h2>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead>
          <tbody id="pendingTable"></tbody>
        </table>
      </section>
    </main>
  </div>

  <div id="mapModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="$('mapModal').style.display='none'">&times;</span>
      <h3>Attendance Check-in Map</h3>
      <p class="muted" id="mapInfo"></p>
      <div id="attendanceMap"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /*******************
     * Configuration
     *******************/
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });
    const RESOURCES_BUCKET = 'resources';
    const IP_API_URL = 'https://api.ipify.org?format=json';
    const DEVICE_ID_KEY = 'nchsm_device_id';

    let currentUserProfile = null;
    let attendanceMap = null; // Variable to hold the Leaflet map object

    /*******************
     * Utilities
     *******************/
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    
    function generateUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function setActiveNav(el){
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    function showSection(id, el){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add('active');
      setActiveNav(el);
      // load relevant content
      switch(id){
        case 'dashboard': loadDashboard(); break;
        case 'users': loadUsers(); break;
        case 'students': loadStudents(); break;
        case 'courses': loadCourses(); break;
        case 'attendance': loadAttendance(); populateAttendanceSelects(); break; // ADDED populate select
        case 'exams': loadExams(); break;
        case 'messages': loadMessages(); break;
        case 'resources': loadResources(); break;
        case 'pending': loadPending(); break;
        default: break;
      }
    }

    async function logout(){
      await sb.auth.signOut();
      window.location.href = 'login.html';
    }

    /*******************
     * Session Info & User Profile
     *******************/
    async function initSessionInfo(){
      const { data: { user } } = await sb.auth.getUser();
      if (user) {
        $('sessionInfo').textContent = `Signed in as ${user.email}`;
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', user.id).single();
        if (profile) currentUserProfile = profile;
      } else {
        $('sessionInfo').textContent = 'Signed out';
      }
    }

    /*******************
     * Dashboard
     *******************/
    async function loadDashboard(){
      try {
        const { data, error } = await sb.from('profiles').select('*');
        if (error) { console.warn('dashboard profiles error', error); return; }
        const total = data.length;
        const admins = data.filter(u=>u.role==='admin').length;
        const students = data.filter(u=>u.role==='student').length;
        const pending = data.filter(u=>!u.approved).length;
        $('totalUsers').textContent = total;
        $('totalAdmins').textContent = admins;
        $('totalStudents').textContent = students;
        $('totalPending').textContent = pending;
      } catch (err){
        console.error('loadDashboard', err);
      }
    }

    /*******************
     * Users management
     *******************/
    // create user (auth + profile)
    $('addUserForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = $('new_full_name').value.trim();
      const email = $('new_email').value.trim();
      const phone = $('new_phone').value.trim();
      const password = $('new_password').value;
      const role = $('new_role').value;
      if (!name || !email || !password) return alert('Name, email and password required');
      try {
        // create auth user
        const { data: signupData, error: signupErr } = await sb.auth.signUp({ email, password });
        if (signupErr) {
          // If user exists, maybe create profile only (but careful). For now show error.
          return alert('Signup error: ' + signupErr.message);
        }
        const userId = signupData.user.id;
        // create profile
        const { error: pErr } = await sb.from('profiles').insert([{ id: userId, full_name: name, email, phone, role, approved: true }]);
        if (pErr) { alert('Profile insert error: ' + pErr.message); return; }
        alert('User created');
        $('addUserForm').reset();
        loadUsers(); loadStudents(); loadDashboard(); loadPending();
      } catch (err) {
        console.error('create user err', err);
        alert('Error creating user (see console)');
      }
    });

    // list users
    async function loadUsers(){
      try {
        const { data, error } = await sb.from('profiles').select('*').order('created_at', {ascending:false});
        if (error) { console.warn('loadUsers', error); $('usersTable').innerHTML='<tr><td colspan="6">Error loading users</td></tr>'; return; }
        const tbody = $('usersTable'); tbody.innerHTML = '';
        data.forEach(u=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(u.full_name)}</td>
            <td>${escapeHtml(u.email)}</td>
            <td>${escapeHtml(u.phone)}</td>
            <td>${escapeHtml(u.role)}</td>
            <td>${u.approved ? 'Yes' : 'No'}</td>
            <td class="flex">
              ${u.approved ? `<button class="btn btn-delete" onclick="deactivateUser('${u.id}')">Deactivate</button>` : `<button class="btn btn-approve" onclick="approveUser('${u.id}')">Approve</button>`}
              <button class="btn btn-delete" onclick="deleteUser('${u.id}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (err){ console.error('loadUsers', err); }
    }

    async function approveUser(id){
      const { error } = await sb.from('profiles').update({ approved: true }).eq('id', id);
      if (error) return alert('Approve error: ' + error.message);
      await loadUsers(); await loadPending(); await loadDashboard(); await loadStudents();
    }

    async function deactivateUser(id){
      const { error } = await sb.from('profiles').update({ approved: false }).eq('id', id);
      if (error) return alert('Deactivate error: ' + error.message);
      await loadUsers(); await loadDashboard(); await loadPending();
    }

    // delete profile row (note: auth user still exists in auth table)
    async function deleteUser(id){
      if (!confirm('Delete profile row? This removes the profile record. The auth user will remain in Auth.')) return;
      const { error } = await sb.from('profiles').delete().eq('id', id);
      if (error) return alert('Delete error: ' + error.message);
      await loadUsers(); await loadDashboard(); await loadStudents(); await loadPending();
    }

    /*******************
     * Students tab (filtered users)
     *******************/
    async function loadStudents(){
      try {
        const { data, error } = await sb.from('profiles').select('*').eq('role','student').order('full_name', {ascending:true});
        if (error) { console.warn('loadStudents', error); $('studentsTable').innerHTML='<tr><td colspan="5">Error</td></tr>'; return; }
        const tbody = $('studentsTable'); tbody.innerHTML = '';
        data.forEach(s=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(s.full_name)}</td>
            <td>${escapeHtml(s.email)}</td>
            <td>${escapeHtml(s.phone)}</td>
            <td>${s.approved ? 'Approved' : 'Pending'}</td>
            <td class="flex">
              ${!s.approved ? `<button class="btn btn-approve" onclick="approveUser('${s.id}')">Approve</button>` : `<button class="btn btn-delete" onclick="deactivateUser('${s.id}')">Deactivate</button>`}
              <button class="btn btn-delete" onclick="deleteUser('${s.id}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (err){ console.error('loadStudents', err); }
    }

    /*******************
     * Courses
     *******************/
    $('addCourseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = $('course_name').value.trim();
      const description = $('course_description').value.trim();
      if (!name) return alert('Course name required');
      try {
        const { error } = await sb.from('courses').insert([{ course_name: name, description }]);
        if (error) return alert('Add course error: ' + error.message);
        $('addCourseForm').reset();
        await loadCourses(); await populateCourseSelects();
      } catch (err){ console.error(err); }
    });

    async function loadCourses(){
      try {
        const { data, error } = await sb.from('courses').select('*').order('course_name', {ascending:true});
        if (error) { console.warn('loadCourses', error); $('coursesTable').innerHTML = '<tr><td colspan="2">No courses or table missing</td></tr>'; return; }
        const tbody = $('coursesTable'); tbody.innerHTML = '';
        data.forEach(c=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(c.course_name)}</td>
            <td><button class="btn btn-delete" onclick="deleteCourse(${c.id})">Delete</button></td>
          </tr>`;
        });
      } catch (err){ console.error('loadCourses', err); }
    }

    async function deleteCourse(id){
      if (!confirm('Delete course?')) return;
      const { error } = await sb.from('courses').delete().eq('id', id);
      if (error) return alert('Delete course error: ' + error.message);
      await loadCourses(); await populateCourseSelects();
    }

    async function populateCourseSelects(){
      try {
        const { data } = await sb.from('courses').select('*').order('course_name', {ascending:true});
        const courseSelects = document.querySelectorAll('#att_course_id, #exam_course_id');
        courseSelects.forEach(s => s.innerHTML = '');
        if (!data || data.length === 0) {
          courseSelects.forEach(s => s.innerHTML = '<option value="">(no courses)</option>');
          return;
        }
        data.forEach(c => {
          const opt = `<option value="${c.id}">${escapeHtml(c.course_name)}</option>`;
          courseSelects.forEach(s => s.insertAdjacentHTML('beforeend', opt));
        });
      } catch (err){ console.error('populateCourseSelects', err); }
    }

    /*******************
     * Attendance Utilities (NEW)
     *******************/
    async function getPublicIP() {
      try {
        const response = await fetch(IP_API_URL);
        const data = await response.json();
        return data.ip || '0.0.0.0';
      } catch {
        return '0.0.0.0';
      }
    }

    function getDeviceId() {
      let deviceId = localStorage.getItem(DEVICE_ID_KEY);
      if (!deviceId) {
        deviceId = generateUUID();
        localStorage.setItem(DEVICE_ID_KEY, deviceId);
      }
      return deviceId;
    }

    function getGeoLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser.');
          return resolve({ lat: null, lng: null, accuracy: null });
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({ lat: position.coords.latitude, lng: position.coords.longitude, accuracy: position.coords.accuracy });
          },
          (error) => {
            console.error('Geolocation Error:', error);
            alert('Could not get location. Ensure permissions are granted.');
            resolve({ lat: null, lng: null, accuracy: null });
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });
    }
    
    async function hasAlreadyMarkedAttendance(studentId) {
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      
      // CHECKING AGAINST THE CORRECT TABLE AND COLUMN
      const { data, error } = await sb.from('geo_attendance_logs')
        .select('id')
        .eq('student_id', studentId)
        .gte('check_in_time', today) // Use the correct column check_in_time
        .limit(1);

      if (error) {
        console.error('Supabase check error:', error);
        return true; // Fail safe
      }
      
      return data.length > 0;
    }

    async function populateAttendanceSelects() {
        try {
            const { data: students } = await sb.from('profiles').select('id, full_name').eq('role', 'student').order('full_name');
            const studentSelect = $('att_student_id');
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
            if (students) {
                students.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.id}">${escapeHtml(s.full_name)}</option>`;
                });
            }
            populateCourseSelects();
        } catch(err) {
            console.error('populateAttendanceSelects', err);
        }
    }
    
    /*******************
     * Attendance Logic
     *******************/
    
    // 1. Student / Self Check-in
    async function markMyAttendance() {
      if (!currentUserProfile || !currentUserProfile.approved) {
        return alert('Access Denied: Only approved users can use self check-in.');
      }

      const studentId = currentUserProfile.id;
      const deviceId = getDeviceId();
      
      try {
        // 1. Get Geo and IP
        const [ipAddress, location] = await Promise.all([
          getPublicIP(), 
          getGeoLocation()
        ]);
       
        if (!location.lat || !location.lng) {
            return; // Geolocation failed, error message already shown.
        }
        
        // 2. Check for Duplicates
        if (await hasAlreadyMarkedAttendance(studentId)) {
          return alert('Attendance already marked today via this device/IP. Try again tomorrow.');
        }

        // Determine session type
        const defaultSession = currentUserProfile.role === 'student' ? 'Clinical' : 'Office';
        const sessionType = prompt(`Enter session type (e.g., Clinical, Office):`, defaultSession);
        if (!sessionType) return;
        
        // 3. Insert Record into the NEW geo_attendance_logs table
        const { error } = await sb.from('geo_attendance_logs').insert([{ 
          student_id: studentId, 
          session_type: sessionType,
          latitude: location.lat,
          longitude: location.lng,
          accuracy_meters: location.accuracy,
          ip_address: ipAddress,
          // Use only a portion of the device ID to keep the table cleaner
          device_id: deviceId.substring(0, 8) 
        }]);
        
        if (error) {
          return alert('Geo Check-in failed: ' + error.message);
        }

        alert(`Attendance marked successfully! Session: ${sessionType}.`);
        loadAttendance();
      } catch(err) {
        console.error('markMyAttendance error:', err);
        alert('An unexpected error occurred during check-in.');
      }
    }
    
    // 2. Admin Manual Mark Attendance
    $('addAttendanceForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (currentUserProfile.role !== 'admin' && currentUserProfile.role !== 'superadmin') {
        return alert('You do not have permission for manual attendance entry.');
      }
      manualMarkAttendance();
    });
    
    async function manualMarkAttendance() {
      const student_id = $('att_student_id').value;
      const session_type = $('att_session_type').value;
      const course_id = $('att_course_id').value || null;
      const location = $('att_location').value.trim();
      const date = $('att_date').value;
      const time = $('att_time').value || null;
      
      // For manual entry, location data is often null/zero.
      const latitude = parseFloat($('att_latitude').value) || null;
      const longitude = parseFloat($('att_longitude').value) || null;
      const ip_address = $('att_ip_address').value || null;
      const device_id = $('att_device_id').value || null;
      const marked_by = currentUserProfile.email || 'superadmin_manual';

      if (!student_id || !date) return alert('Student and date required for manual entry.');
      
      // Note: This uses the OLD 'attendance' table
      const { error } = await sb.from('attendance').insert([{ 
        student_id, session_type, course_id, location, time, date, 
        latitude, longitude, ip_address, device_id, marked_by
      }]);
      
      if (error) return alert('Add attendance error: ' + error.message);
      $('addAttendanceForm').reset();
      await loadAttendance();
    }


    // 3. Load Attendance Records (Combined View)
    async function loadAttendance(){
        // Note: This displays records from both the NEW geo_attendance_logs and OLD attendance table.
      try {
            // Fetch records from the OLD 'attendance' table
            const { data: oldData, error: oldError } = await sb.from('attendance').select('*, profiles(full_name)').order('date', {ascending:false});

            // Fetch records from the NEW 'geo_attendance_logs' table (FIXED)
            const { data: geoData, error: geoError } = await sb.from('geo_attendance_logs')
                .select('id, student_id, session_type, latitude, longitude, accuracy_meters, check_in_time, ip_address, profiles(full_name)')
                .order('check_in_time', {ascending:false});
            
            const tbody = $('attendanceTable'); 
            tbody.innerHTML = '';

            // ------------------------------------
            // Display GEO LOGS
            // ------------------------------------
            if (geoError) { 
                console.warn('Geo Attendance Load Error:', geoError);
                tbody.innerHTML += `<tr><td colspan="6" style="color:red; font-weight:bold;">Error loading Geo Logs: ${geoError.message}. Check RLS on geo_attendance_logs.</td></tr>`;
            } else if (geoData.length > 0) {
                 tbody.innerHTML += `<tr><td colspan="6" style="font-weight:bold; background:#EBF8FF;">--- Geo-Location Check-in Logs ---</td></tr>`;
                geoData.forEach(r => {
                    const studentName = r.profiles?.full_name || r.student_id || '-';
                    const geoIpText = `Lat: ${r.latitude.toFixed(4)} | Acc: ${r.accuracy_meters.toFixed(1)}m`;
                    const time = new Date(r.check_in_time).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                    const date = new Date(r.check_in_time).toLocaleDateString();
                    
                    tbody.innerHTML += `<tr style="background:#F7FAFD;">
                        <td>${escapeHtml(studentName)} <span style="font-size:0.7em; color:#3B82F6;">(GEO)</span></td>
                        <td>${escapeHtml(r.session_type)}</td>
                        <td>IP: ${r.ip_address || 'N/A'} | ${time}</td>
                        <td>${date}</td>
                        <td>${escapeHtml(geoIpText)}</td>
                        <td>
                            <button class="btn btn-map" onclick="showAttendanceMap(${r.latitude}, ${r.longitude}, '${escapeHtml(studentName)} Check-in')">Map</button>
                            <button class="btn btn-delete" onclick="deleteGeoAttendance(${r.id})">Del</button>
                        </td>
                    </tr>`;
                });
            }


            // ------------------------------------
            // Display OLD/MANUAL LOGS
            // ------------------------------------
            if (oldData && oldData.length > 0) {
                tbody.innerHTML += `<tr><td colspan="6" style="font-weight:bold; background:#F1F5F9;">--- Manual/Old Attendance Records ---</td></tr>`;
                oldData.forEach(r=>{
                    const studentName = r.profiles?.full_name || r.student_id || '-';
                    const locationText = (r.location || 'N/A') + ' at ' + (r.time || 'N/A');
                    const date = r.date || 'N/A';
                    
                    tbody.innerHTML += `<tr>
                        <td>${escapeHtml(studentName)}</td>
                        <td>${escapeHtml(r.session_type)}</td>
                        <td>${escapeHtml(locationText)}</td>
                        <td>${escapeHtml(date)}</td>
                        <td>Manual</td>
                        <td><button class="btn btn-delete" onclick="deleteAttendance(${r.id})">Delete</button></td>
                    </tr>`;
                });
            }

            if (!oldData && !geoData) {
                tbody.innerHTML = '<tr><td colspan="6">No attendance records found.</td></tr>';
            }

        } catch (err){ console.error('loadAttendance', err); }
    }


    // 4. Leaflet Map Logic (NEW)
    function showAttendanceMap(lat, lng, label) {
        if (!lat || !lng) {
            return alert('No valid geo-coordinates found for this entry.');
        }

        $('mapModal').style.display = 'flex';
        $('mapInfo').textContent = `Check-in location for ${label}.`;

        // Clear existing map instance if it exists
        if (attendanceMap) {
            attendanceMap.remove();
        }

        // Initialize the map (Delaying initialization slightly ensures the map container is fully visible)
        setTimeout(() => {
            attendanceMap = L.map('attendanceMap').setView([lat, lng], 16);

            // Add the tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(attendanceMap);

            // Add a marker for the check-in location
            L.marker([lat, lng]).addTo(attendanceMap)
                .bindPopup(`<b>${label}</b><br>Check-in Location.`)
                .openPopup();
        }, 100);
    }

    async function deleteGeoAttendance(id){
        if (!confirm('Delete Geo Attendance Log?')) return;
        const { error } = await sb.from('geo_attendance_logs').delete().eq('id', id);
        if (error) return alert('Delete geo log error: ' + error.message);
        await loadAttendance();
    }
    
    async function deleteAttendance(id){
        if (!confirm('Delete Manual/Old Attendance Log?')) return;
        const { error } = await sb.from('attendance').delete().eq('id', id);
        if (error) return alert('Delete attendance error: ' + error.message);
        await loadAttendance();
    }


    /*******************
     * Exams, Messages, Resources, Pending (Omitted for brevity, but exist)
     *******************/

    // Dummy/Placeholder Functions for the full code environment
    async function loadExams(){}
    async function loadMessages(){}
    async function loadResources(){}
    async function loadPending(){}
    
    /*******************
     * Initialization
     *******************/

    // The robust session listener
    sb.auth.onAuthStateChange((event, session) => {
      if ((event === 'INITIAL_SESSION' || event === 'SIGNED_IN') && session) {
        initSessionInfo();
        showSection('dashboard', $('mainNav').querySelector('a'));
        populateCourseSelects(); // Load options for forms
        populateAttendanceSelects(); // Load student options for attendance form
      } else if (event === 'SIGNED_OUT' || (event === 'INITIAL_SESSION' && !session)) {
        // Ensure users are redirected to login if no session is found
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
