<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NCHSM Super Admin Dashboard</title>
  <style>
    /* --- NCHSM style (kept clean & consistent) --- */
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8FAFC; }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 240px; background-color: #1E293B; color: #fff; display: flex; flex-direction: column; padding: 20px; }
    .sidebar-header { text-align: center; margin-bottom: 24px; }
    .sidebar-header img { width: 60px; margin-bottom: 10px; }
    .nav { list-style: none; padding: 0; flex-grow: 1; }
    .nav li { margin: 6px 0; }
    .nav a { color: #fff; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.15s; }
    .nav a:hover, .nav a.active { background-color: #3B82F6; }
    .logout { margin-top: auto; text-align: center; }
    .logout a { display: inline-block; margin-top: 10px; padding: 8px 14px; background-color: #EF4444; color: #fff; text-decoration: none; border-radius: 6px; }

    /* Main Content */
    .main { flex: 1; padding: 20px 28px; overflow-y: auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 18px; }
    header h1 { margin: 0; font-size: 1.6rem; color: #0f172a; }
    .subtitle { color: #475569; }

    /* Cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background-color: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 2px 8px rgba(2,6,23,0.04); text-align: center; cursor: pointer; }
    .card h3 { margin: 4px 0 8px; font-size: 1rem; color: #0f172a; }
    .card p { margin: 0; font-weight: 700; font-size: 1.2rem; color: #0b2447; }

    /* Layout / Tabs */
    .section { display: none; }
    .section.active { display: block; }

    /* Tables and forms */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow:hidden; margin-bottom: 18px; }
    th, td { padding: 12px; border-bottom: 1px solid #E6EEF8; text-align: left; color:#0b2447; }
    th { background: #EAF2FF; color: #0b2447; font-weight:600; }
    tr:hover { background: #FBFDFF; }
    form input, form select, form button, form textarea { padding: 8px 10px; margin: 6px 6px 10px 0; border-radius: 6px; border: 1px solid #CBD5E1; font-size: 0.95rem; }
    form button { background:#3B82F6; color:#fff; border:none; padding:9px 14px; cursor:pointer; border-radius:6px; }
    form button.alt { background:#10B981; }

    /* small utility buttons */
    .btn { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; color:#fff; font-size:.9rem; }
    .btn-approve { background:#16A34A; }
    .btn-reject { background:#EF4444; }
    .btn-delete { background:#F97316; }
    .btn-edit { background:#3B82F6; }

    .muted { font-size: .9rem; color:#6B7280; }
    .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .mb { margin-bottom:12px; }
    .center { text-align:center; }
    .file-input { display:inline-block; }
    .notice { padding:10px; background:#FFF7ED; border-left: 4px solid #F97316; border-radius:6px; margin-bottom:12px; color:#7C2D12; }

    /* responsive */
    @media (max-width:900px){
      .sidebar{ display:none; }
      .container{ flex-direction:column; }
      .main{ padding:12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="images/Logo_NCHSM.png" alt="Logo" onerror="this.style.display='none'"/>
        <h3>Super Admin</h3>
      </div>

      <ul class="nav" id="mainNav">
        <li><a href="#" class="active" onclick="showSection('dashboard', this)">Dashboard</a></li>
        <li><a href="#" onclick="showSection('users', this)">Users</a></li>
        <li><a href="#" onclick="showSection('students', this)">Students</a></li>
        <li><a href="#" onclick="showSection('courses', this)">Courses</a></li>
        <li><a href="#" onclick="showSection('attendance', this)">Attendance</a></li>
        <li><a href="#" onclick="showSection('exams', this)">Exams</a></li>
        <li><a href="#" onclick="showSection('messages', this)">Inbox</a></li>
        <li><a href="#" onclick="showSection('calendar', this)">Calendar</a></li>
        <li><a href="#" onclick="showSection('resources', this)">Resources</a></li>
        <li><a href="#" onclick="showSection('pending', this)">Pending Approvals</a></li>
      </ul>

      <div class="logout">
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header>
        <div>
          <h1>Welcome, Super Admin</h1>
          <p class="subtitle">Manage users, courses, attendance, exams, messages and resources</p>
        </div>
        <div class="muted" id="sessionInfo">Signed out</div>
      </header>

      <!-- ===== DASHBOARD ===== -->
      <section id="dashboard" class="section active">
        <div class="cards" id="dashboardCards">
          <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
          <div class="card"><h3>Admins</h3><p id="totalAdmins">0</p></div>
          <div class="card"><h3>Students</h3><p id="totalStudents">0</p></div>
          <div class="card"><h3>Pending</h3><p id="totalPending">0</p></div>
        </div>
        <div class="mb">
          <div class="notice">This dashboard reads/writes directly to your Supabase project. If you get permission errors, check RLS policies and ensure the anon key is valid.</div>
        </div>
      </section>

      <!-- ===== USERS MANAGEMENT ===== -->
      <section id="users" class="section">
        <h2>Users — Add new user (Admin or Student)</h2>

        <form id="addUserForm" class="mb">
          <input id="new_full_name" placeholder="Full name" required />
          <input id="new_email" placeholder="Email" type="email" required />
          <input id="new_phone" placeholder="Phone" />
          <input id="new_password" placeholder="Password" type="password" required />
          <select id="new_role">
            <option value="student">Student</option>
            <option value="admin">Admin</option>
          </select>
          <button type="submit">Create user</button>
        </form>

        <h3>All users</h3>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Approved</th><th>Actions</th></tr></thead>
          <tbody id="usersTable"></tbody>
        </table>
      </section>

      <!-- ===== STUDENTS ===== -->
      <section id="students" class="section">
        <h2>Students</h2>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="studentsTable"></tbody>
        </table>
      </section>

      <!-- ===== COURSES ===== -->
      <section id="courses" class="section">
        <h2>Courses</h2>
        <form id="addCourseForm" class="mb">
          <input id="course_name" placeholder="Course name" required />
          <input id="course_description" placeholder="Short description (optional)" />
          <button type="submit">Add course</button>
        </form>

        <h3>Course list</h3>
        <table>
          <thead><tr><th>Course</th><th>Actions</th></tr></thead>
          <tbody id="coursesTable"></tbody>
        </table>
      </section>

      <!-- ===== ATTENDANCE ===== -->
      <section id="attendance" class="section">
        <h2>Attendance</h2>
        <form id="addAttendanceForm" class="mb">
          <select id="att_student_id"></select>
          <select id="att_session_type"><option value="classroom">Classroom</option><option value="clinical">Clinical</option></select>
          <select id="att_course_id"></select>
          <input id="att_location" placeholder="Location" />
          <input id="att_date" type="date" />
          <input id="att_time" type="time" />
          <button type="submit">Mark attendance</button>
        </form>

        <h3>Attendance records</h3>
        <table>
          <thead><tr><th>Student</th><th>Type</th><th>Course</th><th>Location/Time</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </section>

      <!-- ===== EXAMS ===== -->
      <section id="exams" class="section">
        <h2>Exams / CATS</h2>
        <form id="addExamForm" class="mb">
          <select id="exam_course_id"></select>
          <input id="exam_title" placeholder="Exam title" required />
          <input id="exam_date" type="date" required />
          <select id="exam_status"><option>Upcoming</option><option>Completed</option></select>
          <button type="submit">Add exam</button>
        </form>

        <h3>Exams</h3>
        <table>
          <thead><tr><th>Course</th><th>Title</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="examsTable"></tbody>
        </table>
      </section>

      <!-- ===== MESSAGES ===== -->
      <section id="messages" class="section">
        <h2>Inbox / Send Message</h2>
        <form id="sendMessageForm" class="mb">
          <input id="msg_recipient" placeholder="Recipient email" required />
          <textarea id="msg_body" placeholder="Message" rows="3" style="width:100%;"></textarea>
          <button type="submit">Send</button>
        </form>

        <h3>Messages (recent)</h3>
        <table>
          <thead><tr><th>From</th><th>To</th><th>Message</th><th>Date</th></tr></thead>
          <tbody id="messagesTable"></tbody>
        </table>
      </section>

      <!-- ===== CALENDAR ===== -->
      <section id="calendar" class="section">
        <h2>Calendar</h2>
        <p class="muted">Simple calendar placeholder — we can wire to exams/attendance events later.</p>
        <div id="calendarPlaceholder" class="mb">[Calendar grid placeholder]</div>
      </section>

      <!-- ===== RESOURCES ===== -->
      <section id="resources" class="section">
        <h2>Resources (Uploads)</h2>
        <div class="mb">
          <label class="file-input">
            <input id="resourceFile" type="file" />
          </label>
          <input id="resourceTitle" placeholder="Title (optional)" />
          <button id="uploadResourceBtn">Upload to Storage</button>
        </div>

        <h3>Available resources</h3>
        <table>
          <thead><tr><th>File</th><th>Size</th><th>Actions</th></tr></thead>
          <tbody id="resourcesTable"></tbody>
        </table>
      </section>

      <!-- ===== PENDING ===== -->
      <section id="pending" class="section">
        <h2>Pending Approvals</h2>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead>
          <tbody id="pendingTable"></tbody>
        </table>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /*******************
     * Configuration
     *******************/
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // storage bucket name used for resources
    const RESOURCES_BUCKET = 'resources';

    /*******************
     * Utilities
     *******************/
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    function setActiveNav(el){
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      if (el) el.classList.add('active');
    }

    function showSection(id, el){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add('active');
      setActiveNav(el);
      // load relevant content
      switch(id){
        case 'dashboard': loadDashboard(); break;
        case 'users': loadUsers(); break;
        case 'students': loadStudents(); break;
        case 'courses': loadCourses(); break;
        case 'attendance': loadAttendance(); break;
        case 'exams': loadExams(); break;
        case 'messages': loadMessages(); break;
        case 'resources': loadResources(); break;
        case 'pending': loadPending(); break;
        default: break;
      }
    }

    async function logout(){
      await sb.auth.signOut();
      window.location.href = 'login.html';
    }

    /*******************
     * Session Info
     *******************/
    async function initSessionInfo(){
      const { data: { user } } = await sb.auth.getUser();
      if (user) $('sessionInfo').textContent = `Signed in as ${user.email}`;
      else $('sessionInfo').textContent = 'Signed out';
    }

    /*******************
     * Dashboard
     *******************/
    async function loadDashboard(){
      try {
        const { data, error } = await sb.from('profiles').select('*');
        if (error) { console.warn('dashboard profiles error', error); return; }
        const total = data.length;
        const admins = data.filter(u=>u.role==='admin').length;
        const students = data.filter(u=>u.role==='student').length;
        const pending = data.filter(u=>!u.approved).length;
        $('totalUsers').textContent = total;
        $('totalAdmins').textContent = admins;
        $('totalStudents').textContent = students;
        $('totalPending').textContent = pending;
      } catch (err){
        console.error('loadDashboard', err);
      }
    }

    /*******************
     * Users management
     *******************/
    // create user (auth + profile)
    $('addUserForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = $('new_full_name').value.trim();
      const email = $('new_email').value.trim();
      const phone = $('new_phone').value.trim();
      const password = $('new_password').value;
      const role = $('new_role').value;
      if (!name || !email || !password) return alert('Name, email and password required');
      try {
        // create auth user
        const { data: signupData, error: signupErr } = await sb.auth.signUp({ email, password });
        if (signupErr) {
          // If user exists, maybe create profile only (but careful). For now show error.
          return alert('Signup error: ' + signupErr.message);
        }
        const userId = signupData.user.id;
        // create profile
        const { error: pErr } = await sb.from('profiles').insert([{ id: userId, full_name: name, email, phone, role, approved: true }]);
        if (pErr) { alert('Profile insert error: ' + pErr.message); return; }
        alert('User created');
        $('addUserForm').reset();
        loadUsers(); loadStudents(); loadDashboard(); loadPending();
      } catch (err) {
        console.error('create user err', err);
        alert('Error creating user (see console)');
      }
    });

    // list users
    async function loadUsers(){
      try {
        const { data, error } = await sb.from('profiles').select('*').order('created_at', {ascending:false});
        if (error) { console.warn('loadUsers', error); $('usersTable').innerHTML='<tr><td colspan="6">Error loading users</td></tr>'; return; }
        const tbody = $('usersTable'); tbody.innerHTML = '';
        data.forEach(u=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(u.full_name)}</td>
            <td>${escapeHtml(u.email)}</td>
            <td>${escapeHtml(u.phone)}</td>
            <td>${escapeHtml(u.role)}</td>
            <td>${u.approved ? 'Yes' : 'No'}</td>
            <td class="flex">
              ${u.approved ? `<button class="btn btn-delete" onclick="deactivateUser('${u.id}')">Deactivate</button>` : `<button class="btn btn-approve" onclick="approveUser('${u.id}')">Approve</button>`}
              <button class="btn btn-delete" onclick="deleteUser('${u.id}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (err){ console.error('loadUsers', err); }
    }

    async function approveUser(id){
      const { error } = await sb.from('profiles').update({ approved: true }).eq('id', id);
      if (error) return alert('Approve error: ' + error.message);
      await loadUsers(); await loadPending(); await loadDashboard(); await loadStudents();
    }

    async function deactivateUser(id){
      const { error } = await sb.from('profiles').update({ approved: false }).eq('id', id);
      if (error) return alert('Deactivate error: ' + error.message);
      await loadUsers(); await loadDashboard(); await loadPending();
    }

    // delete profile row (note: auth user still exists in auth table)
    async function deleteUser(id){
      if (!confirm('Delete profile row? This removes the profile record. The auth user will remain in Auth.')) return;
      const { error } = await sb.from('profiles').delete().eq('id', id);
      if (error) return alert('Delete error: ' + error.message);
      await loadUsers(); await loadDashboard(); await loadStudents(); await loadPending();
    }

    /*******************
     * Students tab (filtered users)
     *******************/
    async function loadStudents(){
      try {
        const { data, error } = await sb.from('profiles').select('*').eq('role','student').order('full_name', {ascending:true});
        if (error) { console.warn('loadStudents', error); $('studentsTable').innerHTML='<tr><td colspan="5">Error</td></tr>'; return; }
        const tbody = $('studentsTable'); tbody.innerHTML = '';
        data.forEach(s=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(s.full_name)}</td>
            <td>${escapeHtml(s.email)}</td>
            <td>${escapeHtml(s.phone)}</td>
            <td>${s.approved ? 'Approved' : 'Pending'}</td>
            <td class="flex">
              ${!s.approved ? `<button class="btn btn-approve" onclick="approveUser('${s.id}')">Approve</button>` : `<button class="btn btn-delete" onclick="deactivateUser('${s.id}')">Deactivate</button>`}
              <button class="btn btn-delete" onclick="deleteUser('${s.id}')">Delete</button>
            </td>
          </tr>`;
        });
      } catch (err){ console.error('loadStudents', err); }
    }

    /*******************
     * Courses
     *******************/
    $('addCourseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = $('course_name').value.trim();
      const description = $('course_description').value.trim();
      if (!name) return alert('Course name required');
      try {
        const { error } = await sb.from('courses').insert([{ course_name: name, description }]);
        if (error) return alert('Add course error: ' + error.message);
        $('addCourseForm').reset();
        await loadCourses(); await populateCourseSelects();
      } catch (err){ console.error(err); }
    });

    async function loadCourses(){
      try {
        const { data, error } = await sb.from('courses').select('*').order('course_name', {ascending:true});
        if (error) { console.warn('loadCourses', error); $('coursesTable').innerHTML = '<tr><td colspan="2">No courses or table missing</td></tr>'; return; }
        const tbody = $('coursesTable'); tbody.innerHTML = '';
        data.forEach(c=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(c.course_name)}</td>
            <td><button class="btn btn-delete" onclick="deleteCourse(${c.id})">Delete</button></td>
          </tr>`;
        });
      } catch (err){ console.error('loadCourses', err); }
    }

    async function deleteCourse(id){
      if (!confirm('Delete course?')) return;
      const { error } = await sb.from('courses').delete().eq('id', id);
      if (error) return alert('Delete course error: ' + error.message);
      await loadCourses(); await populateCourseSelects();
    }

    async function populateCourseSelects(){
      try {
        const { data } = await sb.from('courses').select('*').order('course_name', {ascending:true});
        const courseSelects = document.querySelectorAll('#att_course_id, #exam_course_id');
        courseSelects.forEach(s => s.innerHTML = '');
        if (!data || data.length === 0) {
          courseSelects.forEach(s => s.innerHTML = '<option value="">(no courses)</option>');
          return;
        }
        data.forEach(c => {
          const opt = `<option value="${c.id}">${escapeHtml(c.course_name)}</option>`;
          courseSelects.forEach(s => s.insertAdjacentHTML('beforeend', opt));
        });
      } catch (err){ console.error('populateCourseSelects', err); }
    }

    /*******************
     * Attendance
     *******************/
    async function loadAttendance(){
      try {
        const { data, error } = await sb.from('attendance').select('*, profiles(full_name)').order('date', {ascending:false});
        // if attendance table missing, show message
        if (error) { console.warn('attendance load', error); $('attendanceTable').innerHTML = '<tr><td colspan="6">No attendance table or permission issue.</td></tr>'; return; }
        const tbody = $('attendanceTable'); tbody.innerHTML = '';
        data.forEach(r=>{
          const studentName = r.profiles?.full_name || r.student_id || '-';
          const courseText = r.course_id ? ('Course ID: ' + r.course_id) : '-';
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(studentName)}</td>
            <td>${escapeHtml(r.session_type)}</td>
            <td>${escapeHtml(courseText)}</td>
            <td>${escapeHtml(r.location || '')} ${escapeHtml(r.time || '')}</td>
            <td>${escapeHtml(r.date || '')}</td>
            <td><button class="btn btn-delete" onclick="deleteAttendance(${r.id})">Delete</button></td>
          </tr>`;
        });
      } catch (err){ console.error('loadAttendance', err); }
    }

    // populate student select for attendance
    async function populateStudentSelect(){
      try {
        const { data } = await sb.from('profiles').select('id, full_name').eq('role','student').order('full_name', {ascending:true});
        const sel = $('att_student_id'); sel.innerHTML = '<option value="">Select student</option>';
        data.forEach(s => sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${escapeHtml(s.full_name)}</option>`));
      } catch (err){ console.error('populateStudentSelect', err); }
    }

    // handle add attendance
    $('addAttendanceForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const student_id = $('att_student_id').value;
      const session_type = $('att_session_type').value;
      const course_id = $('att_course_id').value || null;
      const location = $('att_location').value.trim();
      const date = $('att_date').value;
      const time = $('att_time').value || null;
      if (!student_id || !date) return alert('Student and date required');
      const { error } = await sb.from('attendance').insert([{ student_id, session_type, course_id, location, time, date }]);
      if (error) return alert('Add attendance error: ' + error.message);
      $('addAttendanceForm').reset();
      await loadAttendance();
    });

    async function deleteAttendance(id){
      if (!confirm('Delete attendance?')) return;
      const { error } = await sb.from('attendance').delete().eq('id', id);
      if (error) return alert('Delete attendance error: ' + error.message);
      await loadAttendance();
    }

    /*******************
     * Exams
     *******************/
    $('addExamForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const course_id = $('exam_course_id').value;
      const title = $('exam_title').value.trim();
      const date = $('exam_date').value;
      const status = $('exam_status').value;
      if (!course_id || !title || !date) return alert('Course, title and date required');
      const { error } = await sb.from('exams').insert([{ course_id, title, date, status }]);
      if (error) return alert('Add exam error: ' + error.message);
      $('addExamForm').reset();
      await loadExams();
    });

    async function loadExams(){
      try {
        const { data, error } = await sb.from('exams').select('*, courses(course_name)').order('date', {ascending:false});
        if (error) { console.warn('loadExams', error); $('examsTable').innerHTML = '<tr><td colspan="5">No exams or table missing</td></tr>'; return; }
        const tbody = $('examsTable'); tbody.innerHTML = '';
        data.forEach(e=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(e.courses?.course_name || 'N/A')}</td>
            <td>${escapeHtml(e.title)}</td>
            <td>${escapeHtml(e.date)}</td>
            <td>${escapeHtml(e.status)}</td>
            <td><button class="btn btn-delete" onclick="deleteExam(${e.id})">Delete</button></td>
          </tr>`;
        });
      } catch (err){ console.error('loadExams', err); }
    }

    async function deleteExam(id){
      if (!confirm('Delete exam?')) return;
      const { error } = await sb.from('exams').delete().eq('id', id);
      if (error) return alert('Delete exam error: ' + error.message);
      await loadExams();
    }

    /*******************
     * Messages
     *******************/
    $('sendMessageForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const recipient = $('msg_recipient').value.trim();
      const message = $('msg_body').value.trim();
      if (!recipient || !message) return alert('Recipient and message required');
      const sender = (await sb.auth.getUser()).data.user?.email || 'superadmin';
      const { error } = await sb.from('messages').insert([{ sender_email: sender, recipient_email: recipient, message }]);
      if (error) return alert('Send message error: ' + error.message);
      $('sendMessageForm').reset();
      await loadMessages();
    });

    async function loadMessages(){
      try {
        const { data, error } = await sb.from('messages').select('*').order('created_at', {ascending:false}).limit(50);
        if (error) { console.warn('loadMessages', error); $('messagesTable').innerHTML = '<tr><td colspan="4">No messages or table missing</td></tr>'; return; }
        const tbody = $('messagesTable'); tbody.innerHTML = '';
        data.forEach(m=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(m.sender_email)}</td>
            <td>${escapeHtml(m.recipient_email)}</td>
            <td>${escapeHtml(m.message)}</td>
            <td>${new Date(m.created_at).toLocaleString()}</td>
          </tr>`;
        });
      } catch (err){ console.error('loadMessages', err); }
    }

    /*******************
     * Resources (Storage)
     *******************/
    async function loadResources(){
      try {
        // list files in bucket
        const { data, error } = await sb.storage.from(RESOURCES_BUCKET).list('', { limit: 100, offset: 0, sortBy: { column: 'name', order: 'asc' }});
        if (error) { console.warn('loadResources', error.message); $('resourcesTable').innerHTML = '<tr><td colspan="3">Storage bucket missing or permission issue</td></tr>'; return; }
        const tbody = $('resourcesTable'); tbody.innerHTML = '';
        for (const f of data) {
          const sizeKb = f.size ? (f.size / 1024).toFixed(1) + ' KB' : '';
          tbody.innerHTML += `<tr>
            <td><a href="${sb.storage.from(RESOURCES_BUCKET).getPublicUrl(f.name).publicUrl}" target="_blank">${escapeHtml(f.name)}</a></td>
            <td>${sizeKb}</td>
            <td><button class="btn btn-delete" onclick="deleteResource('${f.name}')">Delete</button></td>
          </tr>`;
        }
      } catch (err){ console.error('loadResources', err); }
    }

    $('uploadResourceBtn').addEventListener('click', async ()=>{
      const fileInput = $('resourceFile');
      const file = fileInput.files[0];
      const title = $('resourceTitle').value.trim();
      if (!file) return alert('Select a file first');
      // unique filename
      const filename = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const { error } = await sb.storage.from(RESOURCES_BUCKET).upload(filename, file, { cacheControl: '3600', upsert: false });
      if (error) return alert('Upload error: ' + error.message);
      // optional: insert metadata into resources table (if exists)
      try {
        await sb.from('resources').insert([{ file_name: filename, title }]);
      } catch (err) {
        // ignore if table doesn't exist
      }
      fileInput.value = ''; $('resourceTitle').value = '';
      alert('Uploaded');
      await loadResources();
    });

    async function deleteResource(name){
      if (!confirm('Delete resource ' + name + '?')) return;
      const { error } = await sb.storage.from(RESOURCES_BUCKET).remove([name]);
      if (error) return alert('Delete storage error: ' + error.message);
      // optional: delete metadata row if exists
      try { await sb.from('resources').delete().eq('file_name', name); } catch (err){ /* ignore */ }
      await loadResources();
    }

    /*******************
     * Pending approvals
     *******************/
    async function loadPending(){
      try {
        const { data, error } = await sb.from('profiles').select('*').eq('approved', false).order('created_at', {ascending:true});
        if (error) { console.warn('loadPending', error); $('pendingTable').innerHTML = '<tr><td colspan="3">No pending or table error</td></tr>'; return; }
        const tbody = $('pendingTable'); tbody.innerHTML = '';
        data.forEach(p=>{
          tbody.innerHTML += `<tr>
            <td>${escapeHtml(p.full_name)}</td>
            <td>${escapeHtml(p.email)}</td>
            <td class="flex"><button class="btn btn-approve" onclick="approveUser('${p.id}')">Approve</button><button class="btn btn-reject" onclick="rejectUser('${p.id}')">Reject</button></td>
          </tr>`;
        });
      } catch (err){ console.error('loadPending', err); }
    }

    // helper reject used in pending (actually delete profile)
    async function rejectUser(id){
      if (!confirm('Reject and delete profile?')) return;
      const { error } = await sb.from('profiles').delete().eq('id', id);
      if (error) return alert('Reject error: ' + error.message);
      await loadPending(); await loadDashboard();
    }

    /*******************
     * Init all
     *******************/
    async function init(){
      try {
        await initSessionInfo();
        await loadDashboard();
        await loadUsers();
        await loadStudents();
        await loadCourses();
        await loadAttendance();
        await loadExams();
        await loadMessages();
        await loadResources();
        await loadPending();
        await populateCourseSelects();
        await populateStudentSelect();
      } catch (err){ console.error('init error', err); }
    }

    // run init
    init();

    // expose some functions for inline onclicks
    window.showSection = showSection;
    window.logout = logout;
    window.approveUser = approveUser;
    window.rejectUser = rejectUser;
    window.deleteUser = deleteUser;
    window.deleteCourse = deleteCourse;
    window.deleteExam = deleteExam;
    window.deleteAttendance = deleteAttendance;
    window.deleteResource = deleteResource;
    window.removeUser = deleteUser;
    window.deactivateUser = deactivateUser;
    window.deleteCourse = deleteCourse;
    window.populateCourseSelects = populateCourseSelects;
    window.populateStudentSelect = populateStudentSelect;
  </script>
</body>
</html>
