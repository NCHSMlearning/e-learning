<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Lecturer Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
  <link rel="stylesheet" href="lecturer_style.css">
</head>
<body>
    <div class="container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo" onerror="this.style.display='none'">
                <h2>Lecturer Panel</h2>
            </div>
            <ul class="nav" id="mainNav">
                <li><a href="#" data-tab="dashboard" class="active">Dashboard</a></li>
                <li><a href="#" data-tab="my-courses">My Courses & Students</a></li>
                <li><a href="#" data-tab="sessions">Manage Sessions</a></li> 
                <li><a href="#" data-tab="attendance">Attendance & Check-in</a></li> 
                <li><a href="#" data-tab="cats">CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">Resources</a></li>
                <li><a href="#" data-tab="messages">Inbox / Messages</a></li>
                <li><a href="#" data-tab="calendar">System Calendar</a></li> 
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Lecturer!</h1>
                <p class="subtitle">Manage your classes, assessments, and communication</p>
            </header>

            <section id="dashboard" class="tab-content active">
                <div id="lecturer-welcome-message">
                    <p>Welcome to your personal dashboard. Start by viewing your courses.</p>
                </div>
                <div class="cards">
                    <div class="card" onclick="showTab('my-courses')"><h3>My Active Courses</h3><p class="data" id="lecturerActiveCourses">0</p></div>
                    <div class="card" onclick="showTab('cats')"><h3>Pending Grading</h3><p class="data" id="pendingGrading">0</p></div>
                    <div class="card" onclick="showTab('attendance')"><h3>Today's Scheduled Sessions</h3><p class="data" id="todaysSessions">0</p></div>
                    <div class="card" onclick="showTab('messages')"><h3>New Messages</h3><p class="data" id="newMessagesCount">0</p></div>
                </div>
            </section>
            
            <section id="my-courses" class="tab-content">
                <h2>My Assigned Courses & Students</h2>
                
                <h3>1. My Courses</h3>
                <p>Courses you are currently assigned to teach.</p>
                <div class="toolbar">
                    <input type="text" id="my-course-search" placeholder="Search my courses..." onkeyup="filterTable('my-course-search', 'lecturer-courses-table', [0, 1])">
                    <button onclick="exportTableToCSV('lecturer-courses-table', 'My_Courses_Export.csv')" class="btn-action export-btn">Export My Courses (CSV)</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Course Name</th>
                            <th>Unit Code</th>
                            <th>Program</th>
                            <th>Block/Term</th>
                            <th>Total Students</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lecturer-courses-table">
                        <tr><td colspan="6">Loading your assigned courses...</td></tr>
                    </tbody>
                </table>
                
                <hr>

                <h3>2. Students in My Assigned Groups</h3>
                <p>Students enrolled in the Programs, Intakes, and Blocks you are currently assigned to teach.</p>
                <div class="toolbar inline-form">
                    <select id="lecturer_student_filter_program" onchange="loadLecturerStudents()"><option value="">-- Filter by Program --</option></select>
                    <select id="lecturer_student_filter_block" onchange="loadLecturerStudents()"><option value="">-- Filter by Block/Term --</option></select>
                    <input type="text" id="lecturer-student-search" placeholder="Search students by name..." onkeyup="filterTable('lecturer-student-search', 'lecturer-students-table', [0, 1])">
                    <button onclick="exportTableToCSV('lecturer-students-table', 'My_Student_List_Export.csv')" class="btn-action export-btn">Export List (CSV)</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Email</th>
                            <th>Program</th>
                            <th>Intake</th>
                            <th>Block/Term</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lecturer-students-table">
                        <tr><td colspan="7">Loading students...</td></tr>
                    </tbody>
                </table>
            </section>
            
            <section id="sessions" class="tab-content">
                <h2>Manage Sessions (Class, Clinical, Events)</h2>
                <p>Schedule sessions for the programs/groups you are assigned to. These will appear in the System Calendar.</p>
                
                <h3>Add New Session</h3>
                <form id="add-session-form" class="inline-form" onsubmit="handleScheduleSession(event)">
                    <select id="new_session_type" required>
                        <option value="">-- Select Session Type --</option>
                        <option value="class">Class Session</option>
                        <option value="clinical">Clinical Rotation</option>
                        <option value="event">General Event</option>
                    </select>
                    <input type="text" id="new_session_title" placeholder="Title/Topic" required>
                    <input type="date" id="new_session_date" required>
                    <input type="time" id="new_session_start_time" placeholder="Start Time" required>
                    <input type="time" id="new_session_end_time" placeholder="End Time (Optional)">

                    <select id="new_session_program" required>
                        <option value="">-- Select Program --</option>
                    </select>
                    <select id="new_session_intake_year" required>
                        <option value="">-- Select Intake Year --</option>
                    </select>
                    <select id="new_session_block_term" required>
                        <option value="">-- Select Block/Term --</option>
                    </select>
                    <select id="new_session_course"><option value="">-- Select Course (Optional) --</select>
                    <button type="submit">Schedule Session</button>
                </form>
                
                <hr>
                
                <h3>Scheduled Sessions (My Sessions)</h3>
                <div class="toolbar">
                    <button onclick="exportTableToCSV('scheduledSessionsTableBody', 'Scheduled_Sessions_Export.csv')" class="btn-action export-btn">Export My Sessions (CSV)</button>
                </div>
                <table>
                    <thead><tr><th>Type</th><th>Title</th><th>Date/Time</th><th>Program</th><th>Block/Term</th><th>Actions</th></tr></thead>
                    <tbody id="scheduledSessionsTableBody">
                        <tr><td colspan="6">Loading your scheduled sessions...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2>Daily Attendance & Geo Check-in</h2>
                
                <h3>Lecturer Self Check-in (Mark My Attendance) üìç</h3>
                <p>Confirm your presence for the day. (Uses current location/time).</p>
                <button onclick="lecturerCheckIn()" class="btn-action">Mark My Attendance Now</button>
                
                <hr>
                
                <h3>Manual Student Check-in</h3>
                <p>Manually mark attendance for a student in one of your assigned sessions.</p>
                <form id="manual-attendance-form" class="inline-form">
                    <select id="att_student_id" required><option value="">-- Select Student --</option></select>
                    <select id="att_session_type" required>
                        <option value="">-- Select Session Type --</option>
                        <option value="classroom">Classroom</option>
                        <option value="clinical">Clinical Rotation</option>
                        <option value="virtual">Virtual</option>
                        <option value="call">On Call</option>
                    </select>
                    <input type="text" id="att_department" placeholder="Department/Area" required>
                    <select id="att_course_id"><option value="">-- Select Course (Optional) --</select>
                    <input id="att_location" placeholder="Location">
                    <input id="att_date" type="date" required>
                    <input id="att_time" type="time">
                    <button type="submit" class="btn-action">Mark Attendance</button>
                </form>

                <div id="attendance-records">
                    <h3>Today's Attendance Records (My Classes/Groups)</h3>
                    <input type="text" id="attendance-search" placeholder="Search by Student Name...">
                    <div class="toolbar">
                        <button onclick="exportTableToCSV('attendance-table', 'Todays_Attendance_Export.csv')" class="btn-action export-btn">Export Today's Records (CSV)</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Session Type</th>
                                <th>Target (Course/Clinical)</th>
                                <th>Department/Location</th>
                                <th>Date/Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table">
                            <tr><td colspan="7">Loading today's records...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="cats" class="tab-content">
                <h2>CATS / Exams Administration</h2>
                <p>Post and manage assessments for your assigned courses.</p>

                <form id="add-exam-form" class="inline-form">
                    <select id="exam_type" required>
                        <option value="">-- Select Type --</option>
                        <option value="EXAM">Final Exam</option>
                        <option value="CAT">Continuous Assessment Test (CAT)</option>
                    </select>
                    <select id="exam_program" required><option value="">-- Select Program --</option></select>
                    <select id="exam_course_id" required><option value="">-- Select Course --</option></select>
                    <input type="text" id="exam_title" placeholder="Assessment Title" required>
                    <input type="url" id="exam_link" placeholder="(Optional) Online Exam/Quiz Link">
                    <input type="number" id="exam_duration_minutes" placeholder="Duration (Minutes)" required min="5">
                    <input type="date" id="exam_date" required>
                    <input type="time" id="exam_start_time" required>

                    <select id="exam_status">
                        <option value="Upcoming">Upcoming</option>
                        <option value="Completed">Completed</option>
                        <option value="InProgress">In Progress</option>
                    </select>
                    <select id="exam_intake"><option value="">-- Select Intake Year --</option></select>
                    <select id="exam_block_term"><option value="">-- Select Block/Term --</option></select>
                    <button type="submit">Post Assessment</button>
                </form>

                <div class="toolbar">
                    <input type="text" id="exam-search" placeholder="Search My Assessments...">
                    <button class="btn-action export-btn">Export My Assessments (CSV)</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Course</th>
                            <th>Title</th>
                            <th>Date/Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exams-table">
                        <tr><td colspan="7">Loading your assessments...</td></tr>
                    </tbody>
                </table>

                <div id="gradeModal" class="modal">
                    <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Grade Assessment</h2>
                    <p id="gradeExamTitle">Assessment: <em>Loading...</em></p>
                    <form id="grade-form">
                        <div id="grade-students-list">
                        <p>Loading enrolled students...</p>
                        </div>
                        <button type="submit">Save Grades</button>
                    </form>
                    </div>
                </div>
            </section>

            <section id="resources" class="tab-content">
                <h2>Resource Center</h2>
                <p>Upload files to share with students in your assigned courses and groups.</p>

                <form id="upload-resource-form" class="inline-form">
                    <select id="resource_program" required><option value="">-- Select Program --</option></select>
                    <select id="resource_intake" required><option value="">-- Select Intake Year --</option></select>
                    <select id="resource_block" required><option value="">-- Select Block/Term --</option></select>
                    
                    <input 
                        type="file" 
                        id="resource-file" 
                        required
                        accept=".pdf, .doc, .docx, .ppt, .pptx, .xls, .xlsx" 
                        title="Accepts PDF and common Microsoft Office documents."
                    >
                    <input type="text" id="resource-title" placeholder="Title for file" required>
                    <button type="submit">Upload</button>
                </form>

                <div class="toolbar">
                    <input 
                        type="text" 
                        id="resource-search" 
                        placeholder="Search My Resources..." 
                    >
                    <button 
                        onclick="exportTableToCSV('resources-list', 'My_Resources_Index_Export.csv')" 
                        class="btn-action export-btn">
                        Export Resource List (CSV)
                    </button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Program</th>
                            <th>Title</th>
                            <th>Intake</th>
                            <th>Block/Term</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resources-list">
                        <tr><td colspan="6">Loading your resources...</td></tr>
                    </tbody>
                </table>
            </section>
            
            <section id="messages" class="tab-content">
                <h2>Inbox / Messages</h2>

                <form id="send-message-form" class="inline-form">
                    <select id="msg_program" required>
                        <option value="">-- Select Program/Group --</option>
                    </select>
                    <textarea id="msg_body" placeholder="Message Body" rows="3"></textarea>
                    <button type="submit">Send Message</button>
                </form>

                <div id="messages-list" style="margin-top:20px;">
                    Loading student messages and announcements...
                </div>

                <h3>Sent Messages (Lecturer History)</h3>
                <div class="toolbar">
                    <button onclick="exportTableToCSV('lecturerMessagesTableBody', 'Sent_Message_History_Export.csv')" class="btn-action export-btn">Export Sent Messages (CSV)</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>To Program/Group</th>
                            <th>Subject</th>
                            <th>Message Body</th>
                            <th>Date Sent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lecturerMessagesTableBody">
                        <tr><td colspan="5">Loading sent messages...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="calendar" class="tab-content">
                <h2>System Calendar</h2>
                <p>View all relevant scheduled Sessions, Exams/CATS, and Clinical Rotations.</p>
                <div id="fullCalendarDisplay"></div> 
            </section>
        </main>
    </div>
    
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('mapModal').style.display='none'">&times;</span>
            <h2>Geo Location Map</h2>
            <div id="mapbox-map" style="height: 400px;">Map will load here...</div> 
            <p id="map-details"></p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script> 
    <script src="lecturer_script.js"></script>
    
</body>
</html>
