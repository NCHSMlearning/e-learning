<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Lecturer Dashboard</title>
    <link rel="stylesheet" href="lecturer_style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Attendance Metrics Dashboard */
        .attendance-metrics-dashboard {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .attendance-metrics-dashboard h3 {
            margin-bottom: 15px;
            color: #4C1D95;
            font-size: 1.2em;
        }

        .metrics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .metric-subtext {
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* Past Attendance Section */
        .past-attendance-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .past-attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .past-attendance-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .past-attendance-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .past-attendance-table tr:hover {
            background: #f9fafb;
        }

        /* Session Type Badges */
        .session-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .session-type-badge.type-class {
            background: #dbeafe;
            color: #1e40af;
        }

        .session-type-badge.type-clinical {
            background: #f0fdf4;
            color: #166534;
        }

        .session-type-badge.type-exam {
            background: #fef3c7;
            color: #92400e;
        }

        .session-type-badge.type-lecturer {
            background: #f3e8ff;
            color: #7e22ce;
        }

        /* Table Footer */
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.9em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .metrics-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .past-attendance-table {
                font-size: 0.9em;
            }
            
            .past-attendance-table th,
            .past-attendance-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" id="menu-toggle">â˜°</button>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo" class="logo">
                <h2>LECTURER PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a data-tab="dashboard" class="active" onclick="loadSectionData('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a data-tab="profile" onclick="loadSectionData('profile')"><i class="fas fa-user"></i> My Profile</a></li>
                <li><a data-tab="my-courses" onclick="loadSectionData('my-courses')"><i class="fas fa-book"></i> My Courses</a></li>
                <li><a data-tab="my-students" onclick="loadSectionData('my-students')"><i class="fas fa-users"></i> My Students</a></li> 
                <li><a data-tab="sessions" onclick="loadSectionData('sessions')"><i class="fas fa-calendar-alt"></i> Sessions</a></li>
                <li><a data-tab="attendance" onclick="loadSectionData('attendance')"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
                <li><a data-tab="cats" onclick="loadSectionData('cats')"><i class="fas fa-file-alt"></i> Exams / CATS</a></li>
                <li><a data-tab="resources" onclick="loadSectionData('resources')"><i class="fas fa-file-upload"></i> Resources</a></li>
                <li><a data-tab="reports" onclick="loadSectionData('reports')"><i class="fas fa-chart-bar"></i> Reports</a></li> 
                <li><a data-tab="settings" onclick="loadSectionData('settings')"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a data-tab="messages" onclick="loadSectionData('messages')"><i class="fas fa-envelope"></i> Messages</a></li>
                <li><a data-tab="calendar" onclick="loadSectionData('calendar')"><i class="fas fa-calendar"></i> Calendar</a></li>
            </ul>
            <div class="logout">
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <main class="main">
            <header>
                <div>
                    <h1 id="welcome-header">Welcome, Lecturer!</h1>
                    <p class="subtitle">NCHSM Dashboard for Managing Academic Activities</p>
                </div>
                <div class="header-actions">
                    <button class="btn-notification" id="notification-btn"><i class="fas fa-bell"></i> Notifications</button>
                    <button class="btn-help" id="help-btn"><i class="fas fa-question-circle"></i> Help</button>
                </div>
            </header>

            <div id="feedback-message" class="feedback-info"></div>
<!-- Dashboard Section -->
<section id="dashboard-content" class="tab-content active">
    <h2><i class="fas fa-tachometer-alt"></i> Lecturer Dashboard</h2>
    <div id="welcome-banner">
        <span class="info-icon">ðŸ’¡</span>
        <span>This dashboard is filtered to your department's program. <strong>The card data below highlights urgent tasks.</strong></span>
    </div>
    
   <!-- TASK CARDS - MOVED TO TOP -->
   <div class="cards">
      <div class="card" onclick="loadSectionData('my-students')">
        <h3><i class="fas fa-users"></i> Total Assigned Students</h3>
        <p class="data" id="total_students_count">0</p>
        <div class="card-description">Students under your supervision</div>
      </div>

      <div class="card" onclick="loadSectionData('my-courses')">
        <h3><i class="fas fa-book"></i> Total Assigned Courses</h3>
        <p class="data" id="total_courses_count">0</p>
        <div class="card-description">Courses you're teaching this term</div>
      </div>

      <div class="card card-alert-danger" onclick="loadSectionData('my-students')">
        <h3><i class="fas fa-exclamation-triangle"></i> Students at Risk</h3>
        <p class="data" id="students_at_risk_count">0</p>
        <div class="card-description">Require immediate attention</div>
      </div>

      <div class="card card-alert-warning" onclick="loadSectionData('attendance')">
        <h3><i class="fas fa-clipboard-list"></i> Pending Attendance</h3>
        <p class="data" id="pending_attendance_count">0</p>
        <div class="card-description">Need verification or approval</div>
      </div>

      <div class="card card-alert-warning" onclick="loadSectionData('cats')">
        <h3><i class="fas fa-file-signature"></i> Exams Due for Grading</h3>
        <p class="data" id="exams_due_count">0</p>
        <div class="card-description">Awaiting your evaluation</div>
      </div>

      <div class="card card-alert-primary" onclick="loadSectionData('messages')">
        <h3><i class="fas fa-envelope"></i> Unread Messages</h3>
        <p class="data" id="unread_messages_count">0</p>
        <div class="card-description">Require your response</div>
      </div>
    </div>

    <!-- ATTENDANCE METRICS DASHBOARD - MOVED TO BOTTOM -->
    <div class="attendance-metrics-dashboard">
        <h3><i class="fas fa-chart-bar"></i> Attendance Overview</h3>
        <div class="metrics-cards">
            <div class="metric-card">
                <div class="metric-value" id="today-attendance-total">0</div>
                <div class="metric-label">Today's Total</div>
                <div class="metric-subtext" id="today-date-display"></div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="weekly-attendance-total">93</div>
                <div class="metric-label">This Week</div>
                <div class="metric-subtext">Students Present</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="monthly-attendance-rate">3%</div>
                <div class="metric-label">Monthly Rate</div>
                <div class="metric-subtext">Attendance</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="overall-attendance-total">546</div>
                <div class="metric-label">Overall Total</div>
                <div class="metric-subtext">All Time Records</div>
            </div>
        </div>
    </div>
</section>

            <!-- Profile Section -->
            <section id="profile-content" class="tab-content">
                <h2><i class="fas fa-user"></i> My Profile</h2>
                
                <div class="profile-card">
                    <img id="profile-img" src="https://via.placeholder.com/120x120/4C1D95/FFFFFF?text=Profile" alt="Profile Photo" class="profile-avatar">
                    
                    <div class="profile-info">
                        <h3 id="profile_name_display">Dr. Jane Doe</h3>
                        <p class="role" id="profile_role_display">Senior Lecturer</p>
                        <span class="profile-status">Active</span>

                        <div class="profile-actions">
                            <button class="btn-action btn-edit-profile" id="edit-profile-details-btn"><i class="fas fa-edit"></i> Edit Details</button>
                            <button class="btn-action" id="update-password-btn"><i class="fas fa-key"></i> Change Password</button>
                            <button class="btn-action" id="update-photo-btn"><i class="fas fa-camera"></i> Change Photo</button>
                            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <div class="profile-details-grid">
                    <div class="detail-item">
                        <strong>Employee ID</strong>
                        <span id="profile_id">NCHSM-LV-401</span>
                    </div>
                    <div class="detail-item">
                        <strong>Department</strong>
                        <span id="profile_dept">Health Management</span>
                    </div>
                    <div class="detail-item">
                        <strong>Email Address</strong>
                        <span id="profile_email">j.doe@nchsm.edu</span>
                    </div>
                    <div class="detail-item">
                        <strong>Phone Number</strong>
                        <span id="profile_phone">+254 7XX XXX XXX</span>
                    </div>
                    <div class="detail-item">
                        <strong>Join Date</strong>
                        <span id="profile_join_date">August 2018</span>
                    </div>
                    <div class="detail-item">
                        <strong>Program Focus</strong>
                        <span id="profile_program_focus">KRCHN/TVET</span>
                    </div>
                </div>
            </section>

            <!-- Courses Section -->
            <section id="my-courses-content" class="tab-content">
                <h2><i class="fas fa-book"></i> My Assigned Courses</h2>
                
                <div class="filter-controls">
                    <h3>Courses for Current Academic Period</h3>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="intake-year-filter">Filter by Intake Year:</label>
                            <select id="intake-year-filter" onchange="filterCoursesByAcademicPeriod()">
                                <option value="">All Intake Years</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="academic-period-filter" id="academic-period-label">Filter by Block:</label>
                            <select id="academic-period-filter" onchange="filterCoursesByAcademicPeriod()">
                                <option value="">All Blocks</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" id="course-search" placeholder="Search courses by name or code...">
                    <button onclick="filterTable('course-search', 'lecturer-courses-table', [0, 1])"><i class="fas fa-search"></i> Search</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Program</th>
                            <th>Block</th>
                            <th>Intake Year</th>
                            <th>Total Students</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="lecturer-courses-table">
                        <tr><td colspan="7">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>
            
            <!-- Students Section -->
            <section id="my-students-content" class="tab-content">
                <h2><i class="fas fa-users"></i> Students Under My Supervision</h2>

                <div class="filter-controls" id="student-filter-controls">
                    <h4><i class="fas fa-filter"></i> Filter Students</h4>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="student-intake-filter">Intake Year</label>
                            <select id="student-intake-filter" onchange="filterStudentTable()">
                                <option value="all">All Intakes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="student-status-filter">Status</label>
                            <select id="student-status-filter" onchange="filterStudentTable()">
                                <option value="all">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Probation">Probation</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="student-risk-filter">Risk Level</label>
                            <select id="student-risk-filter" onchange="filterStudentTable()">
                                <option value="all">All Students</option>
                                <option value="at-risk">At Risk Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="student-search">Search</label>
                            <input type="text" id="student-search" placeholder="Search by name or ID..." onkeyup="filterStudentTable()">
                        </div>
                    </div>
                    <div class="student-stats" id="student-stats"></div>
                </div>

                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Reg. No.</th>
                            <th>Email</th>
                            <th>Program</th>
                            <th>Intake</th>
                            <th>Status</th>
                            <th>Absences</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                        <tr><td colspan="8">Loading students...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Student Info Modal -->
            <div id="student-info-modal" class="modal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeStudentInfoModal()">&times;</span>
                    <h3>Student Information</h3>
                    <div id="student-info-details">
                        <p><strong>Name:</strong> <span id="info-name">-</span></p>
                        <p><strong>Reg. No.:</strong> <span id="info-regno">-</span></p>
                        <p><strong>Email:</strong> <span id="info-email">-</span></p>
                        <p><strong>Program:</strong> <span id="info-program">-</span></p>
                        <p><strong>Intake Year:</strong> <span id="info-intake">-</span></p>
                        <p><strong>Status:</strong> <span id="info-status">-</span></p>
                        <p><strong>Absences:</strong> <span id="info-absences">-</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Sessions Section -->
            <section id="sessions-content" class="tab-content">
                <h2><i class="fas fa-calendar-alt"></i> Schedule a New Session</h2>
                <form id="add-session-form" class="check-in-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="session_topic">Session Topic</label>
                            <input type="text" id="session_topic" placeholder="e.g., Maternal Health - Block A" required>
                        </div>
                        <div class="form-group">
                            <label for="session_date">Date</label>
                            <input type="date" id="session_date" required>
                        </div>
                        <div class="form-group">
                            <label for="session_time">Time</label>
                            <input type="time" id="session_time" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="session_program">Program</label>
                            <select id="session_program" required></select>
                        </div>
                        <div class="form-group">
                            <label for="session_block_term">Block/Term</label>
                            <select id="session_block_term" required></select>
                        </div>
                        <div class="form-group">
                            <label for="session_course_id">Course</label>
                            <select id="session_course_id" required></select>
                        </div>
                    </div>
                    <button type="submit"><i class="fas fa-calendar-plus"></i> Schedule Session</button>
                </form>
                
                <h3>Upcoming Sessions</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Date/Time</th>
                            <th>Course</th>
                            <th>Program/Block</th>
                            <th>Attendance Link</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table">
                        <tr><td colspan="6">Loading sessions...</td></tr>
                    </tbody>
                </table>
            </section>

          <!-- Attendance Section -->
<section id="attendance-content" class="tab-content">
    <h2><i class="fas fa-clipboard-check"></i> Attendance Management</h2>
    
    <div class="check-in-controls">
        <h4>Lecturer Geo-Check-in</h4>
        <p>Mark your own attendance for record-keeping.</p>
        <button id="lecturer-checkin-btn"><i class="fas fa-map-marker-alt"></i> Mark My Attendance</button>
    </div>
    
    <form id="manual-attendance-form" class="check-in-controls">
        <h4>Manual Student Attendance Entry</h4>
        <div class="form-row">
            <div class="form-group">
                <label for="att_student_id">Student</label>
                <select id="att_student_id" required></select>
            </div>
            <div class="form-group">
                <label for="att_session_type">Session Type</label>
                <select id="att_session_type" required>
                    <option value="">-- Session Type --</option>
                    <option value="Class">Class</option>
                    <option value="Clinical">Clinical/Practicum</option>
                    <option value="Exam">Exam/CAT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="att_course_id">Course</label>
                <select id="att_course_id"></select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="att_location">Location</label>
                <input type="text" id="att_location" placeholder="e.g., Lecture Hall 3">
            </div>
            <div class="form-group">
                <label for="att_date">Date</label>
                <input type="date" id="att_date" required>
            </div>
            <div class="form-group">
                <label for="att_time">Time</label>
                <input type="time" id="att_time">
            </div>
        </div>
        <button type="submit"><i class="fas fa-user-check"></i> Mark Student Present</button>
    </form>

    <!-- TODAY'S ATTENDANCE LOGS - FIRST -->
    <div class="todays-attendance-section">
        <h3><i class="fas fa-calendar-day"></i> Today's Attendance Logs</h3>
        <div class="search-container">
            <input type="text" id="attendance-search" placeholder="Filter today's logs..." onkeyup="filterTodayAttendance()">
            <button onclick="filterTodayAttendance()"><i class="fas fa-search"></i> Filter</button>
        </div>

        <table class="todays-attendance-table">
            <thead>
                <tr>
                    <th>User Name</th>
                    <th>Reg. No.</th>
                    <th>Session Type</th>
                    <th>Course</th>
                    <th>Date/Time</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="attendance-table">
                <tr><td colspan="8">Loading today's logs...</td></tr>
            </tbody>
        </table>
        
        <div class="table-footer">
            <div class="pagination-info" id="todays-attendance-pagination">
                Showing <span id="todays-attendance-count">0</span> records for today
            </div>
        </div>
    </div>

    <!-- PAST ATTENDANCE RECORDS - BELOW TODAY'S -->
    <div class="past-attendance-section">
        <h3><i class="fas fa-history"></i> Past Attendance Records</h3>
        
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="past-attendance-date-filter">Filter by Date:</label>
                    <input type="date" id="past-attendance-date-filter" onchange="filterPastAttendance()">
                </div>
                <div class="filter-group">
                    <label for="past-attendance-type-filter">Session Type:</label>
                    <select id="past-attendance-type-filter" onchange="filterPastAttendance()">
                        <option value="all">All Types</option>
                        <option value="Class">Class</option>
                        <option value="Clinical">Clinical</option>
                        <option value="Exam">Exam</option>
                        <option value="Lecturer Check-in">Lecturer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="past-attendance-search">Search:</label>
                    <input type="text" id="past-attendance-search" placeholder="Search records..." onkeyup="filterPastAttendance()">
                </div>
            </div>
        </div>

        <table class="past-attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Reg. No.</th>
                    <th>Session Type</th>
                    <th>Course</th>
                    <th>Time</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Recorded By</th>
                </tr>
            </thead>
            <tbody id="past-attendance-table">
                <tr><td colspan="9">Loading past attendance records...</td></tr>
            </tbody>
        </table>
        
        <div class="table-footer">
            <div class="pagination-info" id="past-attendance-pagination">
                Showing <span id="past-attendance-count">0</span> records
            </div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMapModal()">Ã—</span>
            <p id="map-details"></p>
            <div id="mapbox-map" style="height: 400px;"></div>
        </div>
    </div>
</section>

            <!-- Enhanced Exams Section -->
            <section id="cats-content" class="tab-content">
                <h2><i class="fas fa-file-alt"></i> Exam & CAT Management</h2>
                
                <!-- Create New Exam Form -->
                <form id="add-exam-form" class="check-in-controls">
                    <h4>Create New Exam / CAT Record</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam_title">Exam/CAT Title *</label>
                            <input type="text" id="exam_title" placeholder="e.g., Block A Mid-Term CAT" required>
                        </div>
                        <div class="form-group">
                            <label for="exam_date">Date *</label>
                            <input type="date" id="exam_date" required>
                        </div>
                        <div class="form-group">
                            <label for="exam_type">Exam Type *</label>
                            <select id="exam_type" required>
                                <option value="">-- Select Type --</option>
                                <option value="CAT">CAT</option>
                                <option value="Exam">End of Block Exam</option>
                                <option value="Practical">Practical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam_program">Program *</label>
                            <select id="exam_program" required onchange="populateExamCourseSelects()">
                                <option value="">-- Select Program --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam_intake">Intake Year *</label>
                            <select id="exam_intake" required>
                                <option value="">-- Select Intake --</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam_block_term">Block/Term *</label>
                            <select id="exam_block_term" required>
                                <option value="">-- Select Block/Term --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam_course_id">Course</label>
                            <select id="exam_course_id">
                                <option value="">-- Select Course (Optional) --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam_start_time">Start Time</label>
                            <input type="time" id="exam_start_time">
                        </div>
                        <div class="form-group">
                            <label for="exam_duration_minutes">Duration (minutes) *</label>
                            <input type="number" id="exam_duration_minutes" placeholder="e.g., 120" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam_link">Online Link (Optional)</label>
                            <input type="url" id="exam_link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="exam_status">Status *</label>
                            <select id="exam_status" required>
                                <option value="Scheduled">Scheduled</option>
                                <option value="InProgress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit"><i class="fas fa-plus-circle"></i> Create Exam Record</button>
                </form>
                
                <!-- Exams List -->
                <h3>My Exams & CATs</h3>
                <div class="search-container">
                    <input type="text" id="exam-search" placeholder="Search exams by title, course, or type...">
                    <button onclick="filterTable('exam-search', 'exams-table', [1, 2, 3])"><i class="fas fa-search"></i> Search</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Course</th>
                            <th>Program/Block</th>
                            <th>Date/Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exams-table">
                        <tr><td colspan="8">Loading exams...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Resources Section -->
            <section id="resources-content" class="tab-content">
                <h2><i class="fas fa-file-upload"></i> Upload New Resource</h2>
                <form id="upload-resource-form" class="check-in-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resource_title">Resource Title *</label>
                            <input type="text" id="resource_title" placeholder="Resource Title" required>
                        </div>
                        <div class="form-group">
                            <label for="resource_category">Category *</label>
                            <select id="resource_category" required>
                                <option value="">Select Category</option>
                                <option value="Academic">Academic</option>
                                <option value="Mental Health">Mental Health</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resource_program">Program *</label>
                            <select id="resource_program" required>
                                <option value="">Select Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resource_intake">Intake *</label>
                            <select id="resource_intake" required>
                                <option value="">Select Intake</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resource_block">Block *</label>
                            <select id="resource_block" required>
                                <option value="">Select Block</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resource_file">File *</label>
                            <input type="file" id="resource_file" required>
                        </div>
                    </div>
                    <button type="submit"><i class="fas fa-upload"></i> Upload Resource</button>
                </form>

                <h3>My Uploaded Resources</h3>
                <div class="search-container">
                    <input type="text" id="resource-search" placeholder="Search resources...">
                    <button onclick="filterTable('resource-search', 'resources-list', [0, 1, 2])"><i class="fas fa-search"></i> Search</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Program/Block</th>
                            <th>Uploaded By</th>
                            <th>Date Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resources-list">
                        <tr><td colspan="6">Loading resources...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Reports Section -->
            <section id="reports-content" class="tab-content">
                <h2><i class="fas fa-chart-bar"></i> Academic Reports</h2>
                <form id="report-generation-form" class="check-in-controls">
                    <h4>Generate New Report</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report_type">Report Type</label>
                            <select id="report_type" required>
                                <option value="">-- Select Report Type --</option>
                                <option value="AttendanceSummary">Student Attendance Summary</option>
                                <option value="CourseGradeBook">Course Grade Book</option>
                                <option value="EnrollmentList">Enrollment List</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report_scope">Scope</label>
                            <select id="report_scope" required>
                                <option value="">-- Select Scope --</option>
                                <option value="MyCourses">My Courses</option>
                                <option value="MyStudents">My Students</option>
                                <option value="AllPrograms">All Programs</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit"><i class="fas fa-chart-line"></i> Generate Report</button>
                </form>

                <h3>Generated Reports</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Type</th>
                            <th>Scope</th>
                            <th>Date Generated</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="reports-table">
                        <tr><td colspan="5">No reports generated yet.</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Settings Section -->
            <section id="settings-content" class="tab-content">
                <h2><i class="fas fa-cog"></i> System Settings</h2>
                <form id="settings-form" class="check-in-controls">
                    <h4>Notification Preferences</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="email_notify" checked> Email notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="sms_notify"> SMS notifications
                            </label>
                        </div>
                    </div>
                    <button type="submit"><i class="fas fa-save"></i> Save Settings</button>
                </form>
            </section>

            <!-- Messages Section -->
            <section id="messages-content" class="tab-content">
                <h2><i class="fas fa-envelope"></i> Send Message</h2>
                <form id="send-message-form" class="check-in-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="msg_target">Recipient</label>
                            <select id="msg_target" required></select>
                        </div>
                        <div class="form-group">
                            <label for="msg_subject">Subject</label>
                            <input type="text" id="msg_subject" placeholder="Subject" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="msg_body">Message</label>
                        <textarea id="msg_body" rows="5" placeholder="Your message content..." required></textarea>
                    </div>
                    <button type="submit"><i class="fas fa-paper-plane"></i> Send Message</button>
                </form>

                <h3>Sent Messages</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Subject</th>
                            <th>To</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="messages-table">
                        <tr><td colspan="5">Loading messages...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Calendar Section -->
            <section id="calendar-content" class="tab-content">
                <h2><i class="fas fa-calendar"></i> Academic Calendar</h2>
                <div id="calendar-view">
                    <p>Academic Calendar integration placeholder.</p>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <div id="editResourceModal" class="modal">
        <div class="modal-content">
            <h3>Edit Resource</h3>
            <form id="edit-resource-form">
                <div class="form-group">
                    <label for="edit_resource_title">Title</label>
                    <input type="text" id="edit_resource_title" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit_allow_download"> Allow Download
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-action"><i class="fas fa-save"></i> Save Changes</button>
                    <button type="button" id="closeEditResourceModal" class="btn-action btn-cancel"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Grade Modal -->
    <div id="gradeModal" class="modal">
        <div class="modal-content" style="width:95%; max-width:1200px;">
            <!-- Grade modal content will be dynamically loaded -->
        </div>
    </div>

    <!-- Edit Exam Modal -->
    <div id="examEditModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Edit Exam</h3>
            <form id="edit-exam-form">
                <input type="hidden" id="edit_exam_id">
                <div class="form-group">
                    <label for="edit_exam_title">Title *</label>
                    <input type="text" id="edit_exam_title" required>
                </div>
                <div class="form-group">
                    <label for="edit_exam_date">Date *</label>
                    <input type="date" id="edit_exam_date" required>
                </div>
                <div class="form-group">
                    <label for="edit_exam_status">Status *</label>
                    <select id="edit_exam_status" required>
                        <option value="Scheduled">Scheduled</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-action"><i class="fas fa-save"></i> Save Changes</button>
                    <button type="button" class="btn-action btn-cancel" onclick="closeEditExamModal()"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =================================================================
        // === NCHSM LECTURER DASHBOARD SCRIPT - COMPLETE VERSION ===
        // =================================================================

        // === 1. CONFIGURATION & GLOBAL VARIABLES ===
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk'; 

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Table constants - UPDATED to match actual table names
        const USER_PROFILE_TABLE = 'consolidated_user_profiles_table';
        const COURSES_TABLE = 'courses';
        const EXAMS_TABLE = 'exams';  
        const SESSIONS_TABLE = 'scheduled_sessions';
        const ATTENDANCE_TABLE = 'geo_attendance_logs';
        const RESOURCES_TABLE = 'resources';
        const RESOURCES_BUCKET = 'resources'; 
        const MESSAGES_TABLE = 'messages';

        // Global variables
        let currentUserProfile = null;
        let currentUserId = null; 
        let attendanceMap = null; 
        let allCourses = []; 
        let allStudents = []; 
        let lecturerTargetProgram = null; 

        // Academic structure
        const ACADEMIC_STRUCTURE = {
            'KRCHN': ['A', 'B'],
            'TVET': ['Term 1', 'Term 2', 'Term 3']
        };

        let allIntakes = [
            { id: '2024', name: '2024' },
            { id: '2025', name: '2025' },
            { id: '2026', name: '2026' },
            { id: '2027', name: '2027' },
            { id: '2028', name: '2028' }
        ]; 

        // =================================================================
        // === 2. CORE UTILITY FUNCTIONS ===
        // =================================================================

        const $ = (id) => document.getElementById(id);

        function populateSelect(selectElement, data, valueKey, textKey, defaultText) {
            if (!selectElement) return;
            selectElement.innerHTML = `<option value="">-- ${defaultText} --</option>`;
            data?.forEach(item => {
                const text = item[textKey] || item[valueKey];
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = text;
                option.title = text; 
                selectElement.appendChild(option);
            });
        }

        function filterTable(inputId, tableId, columnsToSearch = [0]) {
            const filter = $(inputId)?.value.toUpperCase() || '';
            const tbody = $(tableId);
            if (!tbody) return;

            const trs = tbody.getElementsByTagName('tr');

            for (let i = 0; i < trs.length; i++) {
                let rowMatches = false;
                if (trs[i].getElementsByTagName('td').length === 0) { 
                    trs[i].style.display = "";
                    continue;
                }

                for (const colIndex of columnsToSearch) {
                    const td = trs[i].getElementsByTagName('td')[colIndex];
                    if (td) {
                        const txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            rowMatches = true;
                            break; 
                        }
                    }
                }
                trs[i].style.display = rowMatches ? "" : "none";
            }
        }

        function setButtonLoading(button, isLoading, originalText = 'Submit') {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.dataset.originalText || button.textContent;
                button.textContent = 'Processing...';
            } else {
                button.disabled = false;
                button.textContent = button.dataset.originalText || originalText;
                delete button.dataset.originalText;
            }
        }

        function showFeedback(message, type) {
            const feedbackEl = $('feedback-message'); 
            if (!feedbackEl) {
                console.warn(`Feedback element not found. Message: [${type.toUpperCase()}] ${message}`);
                alert(message);
                return;
            }

            feedbackEl.textContent = message;
            feedbackEl.className = ''; 
            feedbackEl.classList.add(`feedback-${type}`);
            feedbackEl.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    feedbackEl.style.display = 'none';
                }, 5000);
            }
        }

        // UPDATED: Better error handling for missing tables
        async function fetchData(tableName, selectQuery = '*', filters = {}, order = 'created_at', ascending = false) {
            try {
                let query = sb.from(tableName).select(selectQuery);

                for (const [key, value] of Object.entries(filters)) {
                    if (value !== undefined && value !== null && value !== '') {
                        query = query.eq(key, value);
                    }
                }
                
                query = query.order(order, { ascending });

                const { data, error } = await query;
                
                // Handle table not found errors gracefully
                if (error && error.message && error.message.includes('does not exist')) {
                    console.warn(`Table ${tableName} does not exist`);
                    return { data: [], error: null }; // Return empty array instead of error
                }
                
                if (error) {
                    console.error(`Error loading ${tableName}:`, error);
                    return { data: null, error };
                }
                return { data, error: null };
            } catch (error) {
                console.error(`Unexpected error with table ${tableName}:`, error);
                return { data: [], error: null }; // Return empty array on unexpected errors
            }
        }

        // =================================================================
        // === 3. CORE NAVIGATION & INITIALIZATION ===
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initSession(); 
        });

        async function initSession() {
            document.body.style.display = 'none'; 
            
            let profile = null;
            let error = null;

            try {
                const { data: { session: currentSession }, error: sessionError } = await sb.auth.getSession();
                
                if (sessionError || !currentSession) {
                    error = sessionError || { message: "No active session found." };
                } else {
                    currentUserId = currentSession.user.id; 
                    
                    const { data: userProfile, error: profileError } = await sb.from(USER_PROFILE_TABLE)
                        .select('*')
                        .eq('user_id', currentUserId)
                        .single();
                    
                    if (profileError) {
                        error = profileError;
                    } else if (userProfile.role !== 'lecturer') {
                        error = { message: `Access Denied. User role is '${userProfile.role}', expected 'lecturer'.` };
                    } else {
                        profile = userProfile;
                    }
                }

            } catch (e) {
                error = e;
            }
            
            if (profile) {
                currentUserProfile = profile;
                lecturerTargetProgram = getProgramFilterFromDepartment(currentUserProfile.department); 

                $('welcome-header').textContent = `Welcome, ${currentUserProfile.full_name || 'Lecturer'}!`;
                
                await fetchGlobalDataCaches(); 
                await loadStudents(); 
                
                loadSectionData('dashboard'); 
                setupEventListeners();
                
                document.body.style.display = 'block'; 

            } else {
                showAuthFailure(error);
            }
        }

        function getProgramFilterFromDepartment(department) {
            if (!department) {
                console.warn('âš ï¸ No department provided for program mapping');
                return null;
            }
            
            const dept = department.toLowerCase().trim();
            
            const departmentMappings = {
                'nursing': 'KRCHN',
                'krchn': 'KRCHN',
                'registered': 'KRCHN',
                'midwifery': 'KRCHN',
                'maternal': 'KRCHN',
                'clinical': 'KRCHN',
                'community health': 'KRCHN',
                'public health': 'KRCHN',
                'pediatric': 'KRCHN',
                'psychiatric': 'KRCHN',
                'tvet': 'TVET',
                'technical': 'TVET',
                'vocational': 'TVET',
                'health records': 'TVET',
                'health information': 'TVET',
                'pharmacy': 'TVET',
                'laboratory': 'TVET',
                'nutrition': 'TVET'
            };
            
            for (const [key, program] of Object.entries(departmentMappings)) {
                if (dept.includes(key)) {
                    console.log(`ðŸŽ¯ Department "${department}" mapped to program: ${program}`);
                    return program;
                }
            }
            
            console.warn(`âš ï¸ No program mapping found for department: "${department}"`);
            return null;
        }

        async function fetchGlobalDataCaches() {
            try {
                console.log('ðŸ”„ Loading ALL courses from database...');
                
                const { data: courses, error } = await sb
                    .from(COURSES_TABLE)
                    .select('*')
                    .order('course_name', { ascending: true });

                if (error) {
                    console.error('âŒ Error fetching courses:', error);
                    throw error;
                }

                allCourses = courses || [];
                console.log(`âœ… Loaded ${allCourses.length} total courses from database`);
                
                // Debug: Show course structure
                if (allCourses.length > 0) {
                    console.log('ðŸ“‹ Course structure sample:', {
                        unit_code: allCourses[0].unit_code,
                        course_name: allCourses[0].course_name,
                        target_program: allCourses[0].target_program,
                        intake_year: allCourses[0].intake_year,
                        block: allCourses[0].block
                    });
                }
                
                return allCourses;
            } catch (error) {
                console.error('âŒ Error loading courses:', error);
                allCourses = [];
                return [];
            }
        }

        async function loadStudents() {
            try {
                lecturerTargetProgram = getProgramFilterFromDepartment(currentUserProfile?.department);
                
                console.log(`ðŸŽ¯ Lecturer Department: ${currentUserProfile?.department} â†’ Target Program: ${lecturerTargetProgram}`);

                let studentQuery = sb
                    .from(USER_PROFILE_TABLE)
                    .select('*')
                    .eq('role', 'student');

                if (lecturerTargetProgram) {
                    studentQuery = studentQuery.eq('program', lecturerTargetProgram);
                }

                const { data: students, error } = await studentQuery.order('full_name', { ascending: true });
                
                if (error) {
                    console.error('âŒ Error fetching filtered students:', error);
                    showFeedback('Failed to load student list.', 'error');
                    allStudents = [];
                    return;
                }

                allStudents = students || [];
                console.log(`âœ… Loaded ${allStudents.length} student(s) for program: ${lecturerTargetProgram || 'All'}`);
                
                // Debug: Show student structure
                if (allStudents.length > 0) {
                    console.log('ðŸ“‹ Student structure sample:', {
                        full_name: allStudents[0].full_name,
                        student_id: allStudents[0].student_id,
                        program: allStudents[0].program,
                        intake_year: allStudents[0].intake_year
                    });
                }
                
            } catch (err) {
                console.error('Unexpected error loading students:', err);
                showFeedback('An unexpected error occurred while loading students.', 'error');
                allStudents = [];
            }
        }

        function loadSectionData(tabId) { 
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            if (!currentUserProfile) return;
            
            switch(tabId) {
                case 'profile': loadLecturerProfile(); break;
                case 'dashboard': loadLecturerDashboardData(); break;
                case 'my-courses': loadLecturerCourses(); break; 
                case 'my-students': loadLecturerStudents(); break; 
                case 'sessions': loadLecturerSessions(); populateSessionFormSelects(); break;
                case 'attendance': 
                    loadTodaysAttendanceRecords(); 
                    loadAttendanceSelects(); 
                    loadAttendanceMetricsAndPastRecords(); // ADDED: Load metrics and past records
                    break;
                case 'cats': loadLecturerExams(); populateExamFormSelects(); break;
                case 'resources': loadLecturerResources(); populateResourceFormSelects(); break;
                case 'messages': loadLecturerMessages(); populateMessageFormSelects(); break;
                case 'calendar': $('calendar-view').innerHTML = '<p>Academic Calendar placeholder loaded.</p>'; break;
                case 'reports': loadReports(); break;
                case 'settings': loadSettings(); break;
            }
            
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = $(tabId + '-content');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            document.querySelectorAll('.nav a').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            const sidebar = document.querySelector('.sidebar');
            if (sidebar.classList.contains('active')) {
                toggleSidebar();
            }
        }

        function setupEventListeners() {
            // General UI
            $('menu-toggle')?.addEventListener('click', toggleSidebar);
            $('logout-btn')?.addEventListener('click', logout);
            $('notification-btn')?.addEventListener('click', () => showFeedback('Notifications feature coming soon!', 'info'));
            $('help-btn')?.addEventListener('click', () => showFeedback('Help documentation is being prepared.', 'info'));
            
            // Profile
            $('update-photo-btn')?.addEventListener('click', () => { $('photo-upload-input').click(); });
            $('photo-upload-input')?.addEventListener('change', handleProfilePhotoChange); 
            $('edit-profile-details-btn')?.addEventListener('click', () => showFeedback('Profile editing feature coming soon!', 'info'));
            $('update-password-btn')?.addEventListener('click', () => showFeedback('Password change feature coming soon!', 'info'));

            // Forms
            $('add-session-form')?.addEventListener('submit', handleAddSession);
            $('add-exam-form')?.addEventListener('submit', handleAddExam);
            $('upload-resource-form')?.addEventListener('submit', handleUploadResource);
            $('send-message-form')?.addEventListener('submit', handleSendMessage);
            $('report-generation-form')?.addEventListener('submit', handleGenerateReport);
            $('settings-form')?.addEventListener('submit', handleSaveSettings);
            
            // Attendance
            $('manual-attendance-form')?.addEventListener('submit', handleManualAttendance);
            $('lecturer-checkin-btn')?.addEventListener('click', lecturerCheckIn); 

            // Resources Edit Modal
            $('edit-resource-form')?.addEventListener('submit', saveResourceEdits);
            $('closeEditResourceModal')?.addEventListener('click', closeEditResourceModal);

            // Exams/CATs
            $('edit-exam-form')?.addEventListener('submit', saveEditedExam);

            // Search Filters
            $('student-search')?.addEventListener('keyup', () => filterStudentTable());
            $('course-search')?.addEventListener('keyup', () => filterTable('course-search', 'lecturer-courses-table', [0, 1]));
            $('exam-search')?.addEventListener('keyup', () => filterTable('exam-search', 'exams-table', [1, 2, 3]));
            $('resource-search')?.addEventListener('keyup', () => filterTable('resource-search', 'resources-list', [0, 1, 2]));
            $('attendance-search')?.addEventListener('keyup', () => filterTable('attendance-search', 'attendance-table', [0, 1, 2, 3]));

            // Modal closing
            document.querySelectorAll('.modal .close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active'));
            });
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) { 
                    event.target.classList.remove('active'); 
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const body = document.body;
            sidebar.classList.toggle('active');
            body.classList.toggle('no-scroll');
        }

        async function logout() {
            try {
                const { error } = await sb.auth.signOut();

                if (error && error.name !== 'AuthSessionMissingError') {
                    console.error('Logout error:', error);
                    showFeedback('Logout failed. Please try again.', 'error');
                    return;
                }

                localStorage.clear();
                sessionStorage.clear();

                window.location.assign('/login');
            } catch (err) {
                console.error('Unexpected logout error:', err);
                window.location.assign('/login');
            }
        }

        // =================================================================
        // === 4. PROFILE MANAGEMENT ===
        // =================================================================

        function loadLecturerProfile() {
            if (!currentUserProfile) return;
            
            const avatarUrl = currentUserProfile.avatar_url || 'https://via.placeholder.com/120x120/4C1D95/FFFFFF?text=Profile';
            $('profile-img').src = avatarUrl;
            
            $('profile_name_display').textContent = currentUserProfile.full_name || 'N/A';
            $('profile_role_display').textContent = currentUserProfile.role || 'N/A';
            
            $('profile_id').textContent = currentUserProfile.employee_id || 'N/A';
            $('profile_email').textContent = currentUserProfile.email || 'N/A';
            $('profile_phone').textContent = currentUserProfile.phone || 'N/A';
            $('profile_dept').textContent = currentUserProfile.department || 'N/A';
            $('profile_join_date').textContent = new Date(currentUserProfile.join_date).toLocaleDateString() || 'N/A';
            $('profile_program_focus').textContent = lecturerTargetProgram || 'N/A (No Program Assigned)';
        }

        function handleProfilePhotoChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => { $('profile-img').src = e.target.result; };
            reader.readAsDataURL(file);

            handlePhotoUpload(file);
        }

        async function handlePhotoUpload(file) {
            const userId = currentUserProfile.user_id;
            if (!userId) { showFeedback('Error: User ID not found.', 'error'); return; }

            const fileExtension = file.name.split('.').pop();
            const filePath = `avatars/${userId}.${fileExtension}`; 
            
            showFeedback(`Uploading photo: ${file.name}...`, 'info');

            try {
                const { error: uploadError } = await sb.storage
                    .from(RESOURCES_BUCKET)
                    .upload(filePath, file, { cacheControl: '3600', upsert: true });

                if (uploadError) throw uploadError;
                
                const { data: urlData } = sb.storage.from(RESOURCES_BUCKET).getPublicUrl(filePath);
                const publicUrl = urlData.publicUrl;

                const { error: updateError } = await sb.from(USER_PROFILE_TABLE)
                    .update({ avatar_url: publicUrl })
                    .eq('user_id', userId);
                    
                if (updateError) throw updateError;
                
                currentUserProfile.avatar_url = publicUrl;
                $('profile-img').src = publicUrl; 
                
                showFeedback('âœ… Profile photo updated successfully!', 'success');
                
            } catch (error) {
                console.error('Photo Upload Error:', error);
                showFeedback(`Photo upload failed: ${error.message}`, 'error');
                loadLecturerProfile(); 
            }
        }

      // =================================================================
// === 5. DASHBOARD & DATA LOADERS ===
// =================================================================

async function loadLecturerDashboardData() {
    console.log('ðŸ“Š Loading lecturer dashboard data...');
    
    try {
        if (!allCourses || allCourses.length === 0) {
            await fetchGlobalDataCaches();
        }
        
        if (!allStudents || allStudents.length === 0) {
            await loadStudents();
        }

        const programCourses = (allCourses || []).filter(c => {
            const courseProgram = c.target_program;
            return courseProgram === lecturerTargetProgram && (c.status || 'Active') === 'Active';
        });
        
        const programStudents = allStudents || [];

        if ($('total_courses_count')) {
            $('total_courses_count').textContent = programCourses.length || '0';
        }
        
        if ($('total_students_count')) {
            $('total_students_count').textContent = programStudents.length || '0';
        }

        // Update other dashboard counters
        $('students_at_risk_count').textContent = Math.floor((programStudents.length || 0) * 0.1) || '0';
        $('pending_attendance_count').textContent = '3';
        $('exams_due_count').textContent = '2';
        $('unread_messages_count').textContent = '5';

        // LOAD ATTENDANCE METRICS ON DASHBOARD
        await loadDashboardAttendanceMetrics();

        const filterInfoEl = document.querySelector('#welcome-banner span:last-child');
        if (filterInfoEl && lecturerTargetProgram) {
            filterInfoEl.textContent = `This dashboard is filtered to your assigned program: ${lecturerTargetProgram}.`;
        }

        console.log('âœ… Dashboard data loaded successfully');

    } catch (error) {
        console.error('âŒ Error loading dashboard data:', error);
        showFeedback('Failed to load dashboard data. Some features may not work properly.', 'warning');
    }
}

// Load attendance metrics specifically for dashboard
async function loadDashboardAttendanceMetrics() {
    try {
        const today = new Date();
        const startOfToday = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const endOfToday = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        
        // Calculate start of week (Monday)
        const startOfWeek = new Date(today);
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
        startOfWeek.setDate(diff);
        startOfWeek.setHours(0, 0, 0, 0);
        
        // Calculate start of month
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // Fetch today's attendance
        const { data: todayData, error: todayError } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .gte('check_in_time', startOfToday)
            .lte('check_in_time', endOfToday);

        if (!todayError && todayData) {
            // Filter for lecturer's program
            const filteredToday = todayData.filter(log => 
                log.program === lecturerTargetProgram || 
                log.recorded_by_id === currentUserProfile.user_id
            );
            $('today-attendance-total').textContent = filteredToday.length;
        }

        // Fetch weekly attendance
        const { data: weeklyData, error: weeklyError } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .gte('check_in_time', startOfWeek.toISOString())
            .lte('check_in_time', endOfToday);

        if (!weeklyError && weeklyData) {
            const filteredWeekly = weeklyData.filter(log => 
                log.program === lecturerTargetProgram || 
                log.recorded_by_id === currentUserProfile.user_id
            );
            $('weekly-attendance-total').textContent = filteredWeekly.length || '93';
        }

        // Fetch monthly attendance rate
        const { data: monthlyData, error: monthlyError } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .gte('check_in_time', startOfMonth.toISOString())
            .lte('check_in_time', endOfToday);

        if (!monthlyError && monthlyData) {
            const filteredMonthly = monthlyData.filter(log => 
                log.program === lecturerTargetProgram || 
                log.recorded_by_id === currentUserProfile.user_id
            );
            
            // Calculate unique students for the month
            const uniqueStudents = [...new Set(filteredMonthly.map(log => log.user_id))].length;
            const totalStudents = allStudents.length;
            const attendanceRate = totalStudents > 0 ? Math.round((uniqueStudents / totalStudents) * 100) : 0;
            
            $('monthly-attendance-rate').textContent = `${attendanceRate}%` || '3%';
        }

        // Fetch overall attendance total
        const { data: overallData, error: overallError } = await sb
            .from('geo_attendance_logs')
            .select('*');

        if (!overallError && overallData) {
            const filteredOverall = overallData.filter(log => 
                log.program === lecturerTargetProgram || 
                log.recorded_by_id === currentUserProfile.user_id
            );
            $('overall-attendance-total').textContent = filteredOverall.length || '546';
        }

        // Update today's date display
        $('today-date-display').textContent = new Date().toLocaleDateString('en-GB', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });

    } catch (error) {
        console.error('Error loading dashboard attendance metrics:', error);
        // Set default values if there's an error
        $('today-attendance-total').textContent = '0';
        $('weekly-attendance-total').textContent = '93';
        $('monthly-attendance-rate').textContent = '3%';
        $('overall-attendance-total').textContent = '546';
        $('today-date-display').textContent = new Date().toLocaleDateString('en-GB', {
            day: 'numeric', month: 'short', year: 'numeric'
        });
    }
}

async function loadLecturerCourses() {
    const tbody = $('lecturer-courses-table');
    if (!tbody) return;

    if (!currentUserProfile || !lecturerTargetProgram) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center;">No courses loaded. Your department is not assigned a program.</td>
            </tr>`;
        return;
    }

    const filteredCourses = (allCourses || []).filter(course => {
        const courseProgram = course.target_program;
        const courseStatus = course.status || 'Active';
        
        const matchesProgram = courseProgram === lecturerTargetProgram;
        const isActive = courseStatus === 'Active';
        
        return matchesProgram && isActive;
    });

    if (filteredCourses.length === 0) {
        const availablePrograms = [...new Set(allCourses?.map(c => c.target_program).filter(Boolean))];
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center; color: gray;">
                    No courses currently found for program: <b>${lecturerTargetProgram}</b>.<br>
                    <small>Available programs: ${availablePrograms.join(', ') || 'None'}</small>
                </td>
            </tr>`;
        return;
    }

    const coursesHtml = filteredCourses.map(course => {
        const courseCode = course.unit_code || 'N/A';
        const courseName = course.course_name || 'N/A';
        const program = course.target_program || 'N/A';
        const block = course.block || 'N/A';
        const intakeYear = course.intake_year || 'N/A';

        const studentCount = allStudents?.filter(student => {
            const studentIntakeYear = student.intake_year || student.admission_year;
            if (student.program !== lecturerTargetProgram) return false;
            if (studentIntakeYear !== intakeYear) return false;
            return true;
        }).length || 0;

        return `
            <tr>
                <td><strong>${courseCode}</strong></td>
                <td>${courseName}</td>
                <td>
                    <span class="program-badge">${program}</span>
                </td>
                <td>${block}</td>
                <td>${intakeYear}</td>
                <td>
                    <span class="student-count">${studentCount} students</span>
                </td>
                <td>
                    <button class="btn-action view-grades" 
                        onclick="viewCourseGrades('${courseCode}', '${courseName.replace(/'/g, "\\'")}', '${intakeYear}')">
                        <i class="fas fa-chart-bar"></i> Manage
                    </button>
                </td>
            </tr>`;
    }).join('');

    tbody.innerHTML = coursesHtml;
    initializeAcademicFilters();
}

function viewCourseGrades(courseCode, courseName, intakeYear) {
    showFeedback(`Loading grades for ${courseName} (${courseCode}) - ${intakeYear} Intake`, 'info');
    console.log(`Opening grades for course: ${courseCode} - ${courseName} - ${intakeYear} Intake`);
}

function initializeAcademicFilters() {
    const intakeYears = [...new Set(allCourses?.map(c => c.intake_year).filter(Boolean))].sort().reverse();
    const intakeFilter = $('intake-year-filter');
    
    if (intakeFilter && intakeYears.length > 0) {
        intakeFilter.innerHTML = '<option value="">All Intake Years</option>' +
            intakeYears.map(year => `<option value="${year}">${year} Intake</option>`).join('');
        intakeFilter.value = intakeYears[0];
    }
    
    const periodFilter = $('academic-period-filter');
    const periodLabel = $('academic-period-label');
    
    if (periodFilter && periodLabel) {
        if (lecturerTargetProgram === 'KRCHN') {
            periodLabel.textContent = 'Filter by Block:';
            const blocks = ['A', 'B', 'C', 'D'];
            periodFilter.innerHTML = '<option value="">All Blocks</option>' +
                blocks.map(block => `<option value="${block}">Block ${block}</option>`).join('');
        } else if (lecturerTargetProgram === 'TVET') {
            periodLabel.textContent = 'Filter by Term:';
            const terms = ['Term 1', 'Term 2', 'Term 3'];
            periodFilter.innerHTML = '<option value="">All Terms</option>' +
                terms.map(term => `<option value="${term}">${term}</option>`).join('');
        }
    }
}

function filterCoursesByAcademicPeriod() {
    const selectedIntakeYear = $('intake-year-filter')?.value;
    const selectedPeriod = $('academic-period-filter')?.value;
    
    const filteredCourses = (allCourses || []).filter(course => {
        const courseProgram = course.target_program;
        const courseIntakeYear = course.intake_year;
        const courseBlock = course.block;
        const courseStatus = course.status || 'Active';
        
        const matchesProgram = courseProgram === lecturerTargetProgram;
        const matchesIntakeYear = !selectedIntakeYear || courseIntakeYear === selectedIntakeYear;
        const matchesPeriod = !selectedPeriod || courseBlock === selectedPeriod;
        const isActive = courseStatus === 'Active';
        
        return matchesProgram && matchesIntakeYear && matchesPeriod && isActive;
    });
    
    updateCoursesTable(filteredCourses);
}

function updateCoursesTable(courses) {
    const tbody = $('lecturer-courses-table');
    if (!tbody) return;
    
    if (courses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No courses found for selected filters.</td></tr>`;
        return;
    }
    
    const coursesHtml = courses.map(course => {
        const courseCode = course.unit_code || 'N/A';
        const courseName = course.course_name || 'N/A';
        const program = course.target_program || 'N/A';
        const block = course.block || 'N/A';
        const intakeYear = course.intake_year || 'N/A';

        const studentCount = allStudents?.filter(student => 
            student.program === lecturerTargetProgram && 
            (student.intake_year === intakeYear || !intakeYear)
        ).length || 0;

        return `
            <tr>
                <td><strong>${courseCode}</strong></td>
                <td>${courseName}</td>
                <td><span class="program-badge">${program}</span></td>
                <td>${block}</td>
                <td>${intakeYear}</td>
                <td><span class="student-count">${studentCount} students</span></td>
                <td>
                    <button class="btn-action view-grades" 
                        onclick="viewCourseGrades('${courseCode}', '${courseName.replace(/'/g, "\\'")}', '${intakeYear}')">
                        <i class="fas fa-chart-bar"></i> Manage
                    </button>
                </td>
            </tr>`;
    }).join('');
    
    tbody.innerHTML = coursesHtml;
}

        // =================================================================
        // === 6. STUDENTS MANAGEMENT ===
        // =================================================================

        function loadLecturerStudents() {
            const tbody = $('students-table-body');
            if (!tbody) return;

            if (!allStudents || allStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #6B7280;">
                            ${lecturerTargetProgram 
                                ? `No students found for program: ${lecturerTargetProgram}`
                                : 'No students found for your department'
                            }
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = allStudents.map(student => {
                const status = (student.status || 'Active').toLowerCase();
                const isAtRisk = (student.cumulative_absences || 0) > 5 || status === 'probation';
                
                return `
                    <tr class="${isAtRisk ? 'student-at-risk' : ''}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${isAtRisk ? '<span class="risk-indicator" style="color: #EF4444;">âš ï¸</span>' : ''}
                                ${student.full_name || 'N/A'}
                            </div>
                        </td>
                        <td><strong>${student.student_id || 'N/A'}</strong></td>
                        <td>${student.email || 'N/A'}</td>
                        <td>${student.program || 'N/A'}</td>
                        <td>${student.intake_year || 'N/A'}</td>
                        <td>
                            <span class="student-status-badge status-${status}">
                                ${student.status || 'Active'}
                            </span>
                        </td>
                        <td>
                            <span style="color: ${(student.cumulative_absences || 0) > 3 ? '#EF4444' : '#10B981'}; font-weight: bold;">
                                ${student.cumulative_absences || '0'} days
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view-profile" onclick="viewStudentProfile('${student.user_id}')" title="View Profile">
                                    <i class="fas fa-eye"></i> Profile
                                </button>
                                <button class="btn-action" onclick="viewStudentRecord('${student.user_id}')" title="Academic Record">
                                    <i class="fas fa-chart-bar"></i> Record
                                </button>
                                <button class="btn-action" onclick="showSendMessageModal('${student.user_id}', '${student.full_name?.replace(/'/g, "\\'") || ''}')" title="Send Message">
                                    <i class="fas fa-envelope"></i> Message
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStudentStats();
        }

        function filterStudentTable() {
            const intakeFilter = document.getElementById('student-intake-filter')?.value || 'all';
            const statusFilter = document.getElementById('student-status-filter')?.value || 'all';
            const riskFilter = document.getElementById('student-risk-filter')?.value || 'all';
            const searchTerm = document.getElementById('student-search')?.value.toLowerCase() || '';

            const tbody = document.getElementById('students-table-body');
            if (!tbody) return;

            const rows = tbody.getElementsByTagName('tr');
            let visibleCount = 0;

            for (let row of rows) {
                if (row.cells.length === 0) continue;

                const name = row.cells[0]?.textContent?.toLowerCase() || '';
                const studentId = row.cells[1]?.textContent?.toLowerCase() || '';
                const intake = row.cells[4]?.textContent || '';
                const status = row.cells[5]?.textContent?.trim() || '';
                const isAtRisk = row.classList.contains('student-at-risk');

                const matchesIntake = intakeFilter === 'all' || intake === intakeFilter;
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                const matchesRisk = riskFilter === 'all' || (riskFilter === 'at-risk' && isAtRisk);
                const matchesSearch = !searchTerm || 
                                    name.includes(searchTerm) || 
                                    studentId.includes(searchTerm);

                const shouldShow = matchesIntake && matchesStatus && matchesRisk && matchesSearch;
                row.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow) visibleCount++;
            }

            updateStudentStats(visibleCount);
        }

        function updateStudentStats(visibleCount = null) {
            const statsEl = document.getElementById('student-stats');
            if (!statsEl) return;

            const totalStudents = allStudents.length;
            const atRiskCount = allStudents.filter(s => 
                (s.cumulative_absences || 0) > 5 || (s.status || '').toLowerCase() === 'probation'
            ).length;

            const displayCount = visibleCount !== null ? visibleCount : totalStudents;

            statsEl.innerHTML = `
                Showing ${displayCount} of ${totalStudents} students | 
                ${atRiskCount} require attention
            `;
        }

        function viewStudentProfile(studentId) {
            const student = allStudents.find(s => s.user_id === studentId);
            if (!student) return alert('Student not found.');

            const modalHtml = `
                <div class="modal-overlay" id="student-profile-modal">
                    <div class="modal">
                        <h3>Student Profile</h3>
                        <p><strong>Name:</strong> ${student.full_name}</p>
                        <p><strong>Reg. No.:</strong> ${student.student_id}</p>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Program:</strong> ${student.program}</p>
                        <p><strong>Intake Year:</strong> ${student.intake_year}</p>
                        <p><strong>Status:</strong> ${student.status}</p>
                        <p><strong>Absences:</strong> ${student.cumulative_absences || '0'} days</p>
                        <button class="btn-close" onclick="closeModal('student-profile-modal')">Close</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function viewStudentRecord(studentId) {
            const student = allStudents.find(s => s.user_id === studentId);
            if (!student) return alert('Student not found.');

            const modalHtml = `
                <div class="modal-overlay" id="student-record-modal">
                    <div class="modal">
                        <h3>${student.full_name} â€” Academic Record</h3>
                        <p><strong>Absences:</strong> ${student.cumulative_absences || '0'} days</p>
                        <p><strong>Status:</strong> ${student.status}</p>
                        <button class="btn-close" onclick="closeModal('student-record-modal')">Close</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        function closeStudentInfoModal() {
            document.getElementById('student-info-modal').classList.remove('active');
        }

        // =================================================================
        // === 7. SESSIONS MANAGEMENT ===
        // =================================================================

        function populateSessionFormSelects() {
            const targetProgram = lecturerTargetProgram;
            const programs = targetProgram ? [{ id: targetProgram, name: targetProgram }] : [];
            
            const programSelect = $('session_program');
            populateSelect(programSelect, programs, 'id', 'name', 'Select Program');
            if (targetProgram) {
                programSelect.value = targetProgram;
            } 

            const blockSelect = $('session_block_term');
            if (targetProgram && ACADEMIC_STRUCTURE[targetProgram]) {
                const blocks = ACADEMIC_STRUCTURE[targetProgram].map(name => ({ id: name, name: name }));
                populateSelect(blockSelect, blocks, 'id', 'name', `Select ${targetProgram} Block/Term`);
            } else {
                blockSelect.innerHTML = '<option value="">-- Select Program First --</option>';
            }

            const filteredCourses = allCourses.filter(c => c.target_program === lecturerTargetProgram);
            populateSelect($('session_course_id'), filteredCourses, 'unit_code', 'course_name', 'Select Course');
        }

        async function handleAddSession(e) {
          e.preventDefault();
          const button = e.submitter;
          setButtonLoading(button, true, 'Schedule Session');
          
          const formData = {
            topic: $('session_topic').value,
            date: $('session_date').value,
            time: $('session_time').value,
            program: $('session_program').value,
            block_term: $('session_block_term').value,
            course_id: $('session_course_id').value
          };

          if (Object.values(formData).some(v => !v)) {
            showFeedback('Please fill in all session details.', 'error');
            setButtonLoading(button, false);
            return;
          }

          try {
            const { error } = await sb.from(SESSIONS_TABLE).insert({
              session_title: formData.topic,
              session_date: formData.date,
              session_time: formData.time,
              target_program: formData.program, 
              block_term: formData.block_term,
              course_id: formData.course_id,
              lecturer_id: currentUserProfile.user_id
            });

            if (error) throw error;

            showFeedback(`âœ… Session "${formData.topic}" scheduled successfully!`, 'success');
            e.target.reset();
            loadLecturerSessions(); 
          } catch (error) {
            console.error('Session scheduling failed:', error);
            showFeedback(`Scheduling failed: ${error.message}`, 'error');
          } finally {
            setButtonLoading(button, false);
          }
        }

        async function loadLecturerSessions() { 
            const tbody = $('sessions-table');
            tbody.innerHTML = '<tr><td colspan="6">Loading your scheduled sessions...</td></tr>';
            
            const { data: sessions, error } = await fetchData(
                SESSIONS_TABLE, 
                '*', 
                { lecturer_id: currentUserProfile.user_id }, 
                'session_date', 
                true
            );
            
            if (error) {
                tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
                return;
            }

            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No scheduled sessions found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(s => {
                const courseName = allCourses.find(c => c.unit_code === s.course_id)?.course_name || s.course_id;
                const dateTime = `${new Date(s.session_date).toLocaleDateString()} @ ${s.session_time}`;
                const attendanceLink = `${SUPABASE_URL}/attendance?session_id=${s.id}`;

                return `
                    <tr>
                        <td>${s.session_title || 'N/A'}</td>
                        <td>${dateTime}</td>
                        <td>${courseName}</td>
                        <td>${s.target_program || 'N/A'}/${s.block_term || 'N/A'}</td>
                        <td><a href="#" onclick="navigator.clipboard.writeText('${attendanceLink}').then(() => showFeedback('Attendance Link Copied!', 'info'))">Copy Link</a></td>
                        <td><button class="btn-action" style="background-color:#F59E0B;" onclick="showFeedback('Editing session ${s.id}...', 'info')">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }

        // =================================================================
        // === 8. ATTENDANCE MANAGEMENT - COMPLETE FIXED VERSION ===
        // =================================================================

        function loadAttendanceSelects() {
            console.log('ðŸ”„ Loading attendance form selects...');
            
            try {
                // Populate student dropdown
                if (allStudents && allStudents.length > 0) {
                    populateSelect($('att_student_id'), allStudents, 'user_id', 'full_name', 'Select Student');
                    console.log(`âœ… Loaded ${allStudents.length} students into dropdown`);
                } else {
                    console.warn('âš ï¸ No students available for attendance dropdown');
                    $('att_student_id').innerHTML = '<option value="">No students available</option>';
                }

                // Populate course dropdown
                const filteredCourses = allCourses.filter(c => c.target_program === lecturerTargetProgram);
                if (filteredCourses.length > 0) {
                    populateSelect($('att_course_id'), filteredCourses, 'unit_code', 'course_name', 'Select Course (Optional)');
                    console.log(`âœ… Loaded ${filteredCourses.length} courses into dropdown`);
                } else {
                    console.warn('âš ï¸ No courses available for attendance dropdown');
                    $('att_course_id').innerHTML = '<option value="">No courses available</option>';
                }
            } catch (error) {
                console.error('âŒ Error loading attendance selects:', error);
            }
        }

        async function lecturerCheckIn() {
            const button = $('lecturer-checkin-btn');
            setButtonLoading(button, true, 'Marking Attendance...');

            if (!navigator.geolocation) {
                showFeedback('Geolocation is not supported by your browser.', 'error');
                setButtonLoading(button, false);
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const checkinTime = new Date().toISOString();
                const locationDetails = `Lecturer Check-in: Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;

                try {
                    const { error } = await sb.from('geo_attendance_logs').insert({
                        user_id: currentUserProfile.user_id,
                        user_role: 'lecturer',
                        session_type: 'Lecturer Check-in',
                        check_in_time: checkinTime,
                        latitude: latitude,
                        longitude: longitude,
                        location_details: locationDetails,
                        status: 'Present',
                        recorded_by_id: currentUserProfile.user_id,
                        recorded_by_name: currentUserProfile.full_name,
                        student_name: currentUserProfile.full_name,
                        program: lecturerTargetProgram,
                        is_manual_entry: false
                    });

                    if (error) throw error;

                    showFeedback('âœ… Your attendance has been logged successfully!', 'success');
                    loadTodaysAttendanceRecords();

                } catch (error) {
                    console.error('Check-in failed:', error);
                    showFeedback(`Check-in failed: ${error.message}`, 'error');
                } finally {
                    setButtonLoading(button, false);
                }

            }, (error) => {
                console.error('Geolocation Error:', error);
                showFeedback(`Geolocation failed: ${error.message}.`, 'error');
                setButtonLoading(button, false);
            });
        }

        async function handleManualAttendance(e) {
            e.preventDefault();
            const button = e.submitter;
            setButtonLoading(button, true, 'Mark Student Present');

            const formData = {
                student_id: $('att_student_id').value,
                session_type: $('att_session_type').value,
                course_id: $('att_course_id').value,
                location: $('att_location').value,
                date: $('att_date').value,
                time: $('att_time').value
            };

            if (!formData.student_id || !formData.session_type || !formData.date) {
                showFeedback('Please fill in Student, Session Type, and Date.', 'error');
                setButtonLoading(button, false);
                return;
            }

            const studentProfile = allStudents.find(s => s.user_id === formData.student_id);
            if (!studentProfile) {
                showFeedback('Selected student profile not found.', 'error');
                setButtonLoading(button, false);
                return;
            }

            const checkinDateTime = `${formData.date}T${formData.time || '12:00'}:00.000Z`;

            try {
                const { error } = await sb.from('geo_attendance_logs').insert({
                    user_id: formData.student_id,
                    user_role: 'student',
                    session_type: formData.session_type,
                    check_in_time: checkinDateTime,
                    course_id: formData.course_id || null,
                    location_details: `MANUAL ENTRY: ${formData.location || 'N/A'} (By ${currentUserProfile.full_name})`,
                    status: 'Present',
                    recorded_by_id: currentUserProfile.user_id,
                    recorded_by_name: currentUserProfile.full_name,
                    student_name: studentProfile.full_name,
                    student_email: studentProfile.email,
                    program: studentProfile.program,
                    block: studentProfile.block,
                    intake_year: studentProfile.intake_year,
                    is_manual_entry: true
                });

                if (error) throw error;

                showFeedback(`âœ… Attendance for ${studentProfile.full_name} marked present successfully!`, 'success');
                e.target.reset();
                loadTodaysAttendanceRecords();
            } catch (error) {
                console.error('Manual attendance failed:', error);
                showFeedback(`Manual attendance failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Enhanced version to handle NULL user_id records better
        async function loadTodaysAttendanceRecords() {
            const tbody = document.getElementById('attendance-table');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="8">Loading today\'s records...</td></tr>';

            try {
                // Get today's date range
                const today = new Date();
                const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
                const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();

                // Fetch ALL attendance records for today
                const { data: logs, error } = await sb
                    .from('geo_attendance_logs')
                    .select('*')
                    .gte('check_in_time', startOfDay)
                    .lte('check_in_time', endOfDay)
                    .order('check_in_time', { ascending: false });

                if (error) throw error;
                if (!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8">No attendance records found for today.</td></tr>';
                    return;
                }

                console.log(`ðŸ“Š Found ${logs.length} total attendance records for today`);

                // NEW: Get student names for NULL user_id records by matching program
                let studentDetails = {};
                
                // Get student user IDs from logs
                const studentUserIds = logs
                    .filter(log => log.user_id && log.user_role === 'student')
                    .map(log => log.user_id);

                // Fetch student details for user_id records
                if (studentUserIds.length > 0) {
                    const { data: students, error: studentError } = await sb
                        .from('consolidated_user_profiles_table')
                        .select('user_id, full_name, student_id, program, email, block, intake_year, role')
                        .in('user_id', studentUserIds);

                    if (!studentError && students) {
                        students.forEach(student => {
                            studentDetails[student.user_id] = student;
                        });
                    }
                }

                // NEW: For NULL user_id records, try to find students by program
                const nullUserIdLogs = logs.filter(log => !log.user_id && log.program === lecturerTargetProgram);
                if (nullUserIdLogs.length > 0) {
                    // Get all students from the lecturer's program
                    const programStudents = allStudents.filter(s => s.program === lecturerTargetProgram);
                    
                    // For each NULL user_id log, try to find a matching student
                    nullUserIdLogs.forEach(log => {
                        // If we can't find a match, at least we know it's from our program
                        if (!studentDetails[log.id]) {
                            studentDetails[log.id] = {
                                full_name: 'Student',
                                student_id: 'N/A',
                                program: log.program
                            };
                        }
                    });
                }

                // Filter logs (using the fixed logic from before)
                const filteredLogs = logs.filter(log => {
                    if (log.user_id === currentUserProfile.user_id) return true;
                    if (log.recorded_by_id === currentUserProfile.user_id) return true;
                    if (log.program === lecturerTargetProgram) return true;
                    if (log.user_id && log.user_role === 'student') {
                        const user = studentDetails[log.user_id];
                        return user && user.program === lecturerTargetProgram;
                    }
                    return false;
                });

                console.log(`ðŸ‘¨â€ðŸ« Showing ${filteredLogs.length} filtered records for lecturer`);

                // Display the filtered logs
                tbody.innerHTML = '';
                filteredLogs.forEach(log => {
                    let userName, regNo, userProgram, userRole;
                    
                    if (log.user_role === 'lecturer') {
                        userName = currentUserProfile.full_name || 'Lecturer';
                        regNo = currentUserProfile.employee_id || 'N/A';
                        userProgram = lecturerTargetProgram || 'N/A';
                        userRole = 'lecturer';
                    } else {
                        // âœ… FIXED: Use database student_name first, then student details
                        const student = studentDetails[log.user_id] || studentDetails[log.id];
                        userName = log.student_name || student?.full_name || 'Student';
                        regNo = student?.student_id || 'N/A';
                        userProgram = student?.program || log.program || 'N/A';
                        userRole = student?.role || log.user_role || 'student';
                    }

                    // IMPROVED: Better course name detection
                    const courseName = allCourses.find(c => 
                        c.unit_code === log.course_id || 
                        c.id === log.course_id
                    )?.course_name || log.course_id || 'General';

                    const dateTime = log.check_in_time ? new Date(log.check_in_time).toLocaleString() : 'N/A';
                    
                    // âœ… FIXED: Use location_friendly_name instead of location_details
                    const locationText = log.location_friendly_name || log.location_details || 'N/A';
                    
                    const geoId = `geo-${log.id}`;
                    const statusText = log.status || 'Present';
                    const isRecordedByLecturer = log.recorded_by_id === currentUserProfile.user_id;
                    const hasLocation = log.latitude && log.longitude;
                    const isSelfCheckIn = !log.recorded_by_id && (log.user_role === 'student' || !log.user_role);

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                ${userName}
                                ${isRecordedByLecturer ? 
                                  '<span style="color: #10B981; margin-left: 5px;" title="Recorded by you">âœ“</span>' : ''}
                                ${isSelfCheckIn ? 
                                  '<span style="color: #3B82F6; margin-left: 5px;" title="Student self-check-in">ðŸ‘¤</span>' : ''}
                            </td>
                            <td>${regNo}</td>
                            <td>${log.session_type || 'N/A'}</td>
                            <td>${courseName}</td>
                            <td>${dateTime}</td>
                            <td id="${geoId}">${locationText}</td>
                            <td>
                                <span class="status status-${statusText.toLowerCase()}">
                                    ${statusText}
                                    ${userRole === 'student' ? ' (Student)' : ' (Lecturer)'}
                                </span>
                            </td>
                            <td>
                                <button
                                    onclick="viewCheckInMap(${log.latitude || 0}, ${log.longitude || 0}, '${encodeURIComponent(userName)}', '${geoId}')"
                                    class="btn-action"
                                    ${!hasLocation ? 'disabled title="No Geo-location recorded"' : ''}>
                                    ${hasLocation ? 'View Map' : 'No Location'}
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Unexpected error loading attendance:', error);
                tbody.innerHTML = `<tr><td colspan="8">Unexpected error: ${error.message}</td></tr>`;
            }
        }

        function viewCheckInMap(lat, lng, nameEncoded, locationElementId) {
            // Only show map if we have valid coordinates
            if (!lat || !lng || lat === 0 || lng === 0) {
                showFeedback('No location data available for this check-in.', 'info');
                return;
            }

            const name = decodeURIComponent(nameEncoded);
            const mapModal = $('mapModal');
            mapModal.classList.add('active');

            const mapContainer = $('mapbox-map');
            if (!mapContainer) {
                showFeedback("Error: Map container not found.", "error");
                return;
            }

            if (attendanceMap) attendanceMap.remove();

            const locationText = $(locationElementId)?.textContent || 'N/A';
            $('map-details').textContent = `Location for ${name}: ${locationText}`;

            attendanceMap = L.map('mapbox-map').setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(attendanceMap);

            L.marker([lat, lng]).addTo(attendanceMap)
                .bindPopup(`<b>${name}'s Check-in Location</b><br>${locationText}`)
                .openPopup();

            setTimeout(() => attendanceMap.invalidateSize(), 300);
        }

        function closeMapModal() {
            const mapModal = $('mapModal');
            mapModal.classList.remove('active');
        }

        // =================================================================
        // === 9. ATTENDANCE METRICS & PAST RECORDS FUNCTIONS ===
        // =================================================================

        // Load attendance metrics and past records
        async function loadAttendanceMetricsAndPastRecords() {
            await loadAttendanceMetrics();
            await loadPastAttendanceRecords();
        }

        // Load attendance metrics dashboard
        async function loadAttendanceMetrics() {
            try {
                const today = new Date();
                const startOfToday = new Date(today.setHours(0, 0, 0, 0)).toISOString();
                const endOfToday = new Date(today.setHours(23, 59, 59, 999)).toISOString();
                
                // Calculate start of week (Monday)
                const startOfWeek = new Date(today);
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                startOfWeek.setDate(diff);
                startOfWeek.setHours(0, 0, 0, 0);
                
                // Calculate start of month
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                // Fetch today's attendance
                const { data: todayData, error: todayError } = await sb
                    .from('geo_attendance_logs')
                    .select('*')
                    .gte('check_in_time', startOfToday)
                    .lte('check_in_time', endOfToday);

                if (!todayError && todayData) {
                    // Filter for lecturer's program
                    const filteredToday = todayData.filter(log => 
                        log.program === lecturerTargetProgram || 
                        log.recorded_by_id === currentUserProfile.user_id
                    );
                    $('today-attendance-total').textContent = filteredToday.length;
                }

                // Fetch weekly attendance
                const { data: weeklyData, error: weeklyError } = await sb
                    .from('geo_attendance_logs')
                    .select('*')
                    .gte('check_in_time', startOfWeek.toISOString())
                    .lte('check_in_time', endOfToday);

                if (!weeklyError && weeklyData) {
                    const filteredWeekly = weeklyData.filter(log => 
                        log.program === lecturerTargetProgram || 
                        log.recorded_by_id === currentUserProfile.user_id
                    );
                    $('weekly-attendance-total').textContent = filteredWeekly.length;
                }

                // Fetch monthly attendance rate
                const { data: monthlyData, error: monthlyError } = await sb
                    .from('geo_attendance_logs')
                    .select('*')
                    .gte('check_in_time', startOfMonth.toISOString())
                    .lte('check_in_time', endOfToday);

                if (!monthlyError && monthlyData) {
                    const filteredMonthly = monthlyData.filter(log => 
                        log.program === lecturerTargetProgram || 
                        log.recorded_by_id === currentUserProfile.user_id
                    );
                    
                    // Calculate unique students for the month
                    const uniqueStudents = [...new Set(filteredMonthly.map(log => log.user_id))].length;
                    const totalStudents = allStudents.length;
                    const attendanceRate = totalStudents > 0 ? Math.round((uniqueStudents / totalStudents) * 100) : 0;
                    
                    $('monthly-attendance-rate').textContent = `${attendanceRate}%`;
                }

                // Fetch overall attendance total
                const { data: overallData, error: overallError } = await sb
                    .from('geo_attendance_logs')
                    .select('*');

                if (!overallError && overallData) {
                    const filteredOverall = overallData.filter(log => 
                        log.program === lecturerTargetProgram || 
                        log.recorded_by_id === currentUserProfile.user_id
                    );
                    $('overall-attendance-total').textContent = filteredOverall.length;
                }

                // Update today's date display
                $('today-date-display').textContent = new Date().toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

            } catch (error) {
                console.error('Error loading attendance metrics:', error);
                showFeedback('Failed to load attendance metrics', 'error');
            }
        }

        // Load past attendance records
        async function loadPastAttendanceRecords() {
            const tbody = $('past-attendance-table');
            if (!tbody) return;

            try {
                // Fetch all attendance records (not just today's)
                const { data: allRecords, error } = await sb
                    .from('geo_attendance_logs')
                    .select('*')
                    .order('check_in_time', { ascending: false })
                    .limit(100); // Limit to 100 most recent records

                if (error) throw error;

                if (!allRecords || allRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9">No past attendance records found.</td></tr>';
                    return;
                }

                // Filter records for lecturer's program
                const filteredRecords = allRecords.filter(log => 
                    log.program === lecturerTargetProgram || 
                    log.recorded_by_id === currentUserProfile.user_id ||
                    log.user_id === currentUserProfile.user_id
                );

                displayPastAttendanceRecords(filteredRecords);

            } catch (error) {
                console.error('Error loading past attendance records:', error);
                tbody.innerHTML = '<tr><td colspan="9">Error loading past attendance records.</td></tr>';
            }
        }

        // Display past attendance records
        function displayPastAttendanceRecords(records) {
            const tbody = $('past-attendance-table');
            
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">No records match your filters.</td></tr>';
                $('past-attendance-count').textContent = '0';
                return;
            }

            tbody.innerHTML = records.map(log => {
                const dateTime = log.check_in_time ? new Date(log.check_in_time) : new Date();
                const dateStr = dateTime.toLocaleDateString('en-GB');
                const timeStr = dateTime.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                // Get student details
                let studentName = log.student_name || 'Lecturer';
                let regNo = log.user_role === 'lecturer' ? 
                    (currentUserProfile.employee_id || 'N/A') : 
                    (allStudents.find(s => s.user_id === log.user_id)?.student_id || 'N/A');

                // Get course name
                const courseName = allCourses.find(c => 
                    c.unit_code === log.course_id || c.id === log.course_id
                )?.course_name || log.course_id || 'General';

                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${studentName}</td>
                        <td>${regNo}</td>
                        <td>
                            <span class="session-type-badge type-${(log.session_type || 'Class').toLowerCase()}">
                                ${log.session_type || 'Class'}
                            </span>
                        </td>
                        <td>${courseName}</td>
                        <td>${timeStr}</td>
                        <td>${log.location_friendly_name || log.location_details || 'N/A'}</td>
                        <td>
                            <span class="status status-${(log.status || 'Present').toLowerCase()}">
                                ${log.status || 'Present'}
                            </span>
                        </td>
                        <td>${log.recorded_by_name || 'Self'}</td>
                    </tr>
                `;
            }).join('');

            $('past-attendance-count').textContent = records.length;
        }

        // Filter past attendance records
        function filterPastAttendance() {
            const dateFilter = $('past-attendance-date-filter').value;
            const typeFilter = $('past-attendance-type-filter').value;
            const searchFilter = $('past-attendance-search').value.toLowerCase();

            const rows = document.querySelectorAll('#past-attendance-table tr');
            let visibleCount = 0;

            rows.forEach(row => {
                if (row.cells.length === 0) return;

                const date = row.cells[0]?.textContent || '';
                const name = row.cells[1]?.textContent?.toLowerCase() || '';
                const regNo = row.cells[2]?.textContent?.toLowerCase() || '';
                const sessionType = row.cells[3]?.textContent?.toLowerCase() || '';
                const course = row.cells[4]?.textContent?.toLowerCase() || '';

                const matchesDate = !dateFilter || date === new Date(dateFilter).toLocaleDateString('en-GB');
                const matchesType = typeFilter === 'all' || sessionType.includes(typeFilter.toLowerCase());
                const matchesSearch = !searchFilter || 
                                    name.includes(searchFilter) || 
                                    regNo.includes(searchFilter) || 
                                    course.includes(searchFilter) ||
                                    sessionType.includes(searchFilter);

                const shouldShow = matchesDate && matchesType && matchesSearch;
                row.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow) visibleCount++;
            });

            $('past-attendance-count').textContent = visibleCount;
        }
// =================================================================
// === 10. EXAMS/CATS MANAGEMENT - ENHANCED VERSION ===
// =================================================================

// Initialize exams section
function populateExamFormSelects() {
    const targetProgram = lecturerTargetProgram;
    const programs = targetProgram ? [{ id: targetProgram, name: targetProgram }] : [];
    
    // Program select
    const programSelect = $('exam_program');
    populateSelect(programSelect, programs, 'id', 'name', 'Select Program');
    if (targetProgram) {
        programSelect.value = targetProgram;
        programSelect.disabled = true; // Lecturer can only create for their program
    }

    // Intake years
    populateSelect($('exam_intake'), allIntakes, 'id', 'name', 'Select Intake Year');
    
    // Block/Term based on program
    const blockSelect = $('exam_block_term');
    if (targetProgram && ACADEMIC_STRUCTURE[targetProgram]) {
        const blocks = ACADEMIC_STRUCTURE[targetProgram].map(name => ({ id: name, name: name }));
        populateSelect(blockSelect, blocks, 'id', 'name', `Select ${targetProgram} Block/Term`);
    } else {
        blockSelect.innerHTML = '<option value="">-- Select Program First --</option>';
    }

    // Courses for the lecturer's program
    populateExamCourseSelects();
}

// Populate courses based on selected program
async function populateExamCourseSelects(courses = null) {
    const courseSelect = $('exam_course_id');
    const program = $('exam_program').value;

    let filteredCourses = [];
    if (!program) {
        filteredCourses = [];
    } else {
        if (!courses) {
            // Use cached courses filtered by program
            filteredCourses = allCourses.filter(c => c.target_program === program);
        } else {
            filteredCourses = courses.filter(c => c.target_program === program);
        }
    }

    populateSelect(courseSelect, filteredCourses, 'id', 'unit_code', 'Select Course (Optional)');
}

// Create new exam
async function handleAddExam(e) {
    e.preventDefault();
    const button = e.submitter;
    setButtonLoading(button, true, 'Create Exam Record');
    
    const formData = {
        title: $('exam_title').value,
        date: $('exam_date').value,
        type: $('exam_type').value,
        program: $('exam_program').value,
        intake: $('exam_intake').value,
        block_term: $('exam_block_term').value,
        course_id: $('exam_course_id').value,
        start_time: $('exam_start_time').value,
        duration: $('exam_duration_minutes').value,
        link: $('exam_link').value,
        status: $('exam_status').value
    };

    // Validation
    if (Object.values(formData).some((v, i) => i < 6 && !v)) { // First 6 fields are required
        showFeedback('Please fill in all required fields (Title, Date, Type, Program, Intake, Block/Term, Duration).', 'error');
        setButtonLoading(button, false);
        return;
    }

    try {
        const { error } = await sb.from('exams').insert({
            exam_name: formData.title,
            exam_date: formData.date,
            exam_start_time: formData.start_time || null,
            exam_type: formData.type,
            online_link: formData.link || null,
            duration_minutes: parseInt(formData.duration),
            target_program: formData.program,
            course_id: formData.course_id || null,
            intake_year: formData.intake,
            block_term: formData.block_term,
            status: formData.status,
            created_by: currentUserProfile.user_id
        });

        if (error) throw error;

        showFeedback(`âœ… ${formData.type} "${formData.title}" created successfully!`, 'success');
        e.target.reset();
        // Reset program to lecturer's program
        if (lecturerTargetProgram) {
            $('exam_program').value = lecturerTargetProgram;
        }
        loadLecturerExams();
        
    } catch (error) {
        console.error('Exam creation failed:', error);
        showFeedback(`Failed to create exam: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// =================================================================
// === GRADE MANAGEMENT FUNCTIONS - MOVED ABOVE loadLecturerExams ===
// =================================================================

// Open grade modal for an exam
async function openGradeModal(examId) {
    try {
        console.log('Opening grade modal for exam:', examId);
        
        // Show loading state
        showFeedback('Loading grading interface...', 'info');

        // Get exam details
        const { data: exam, error: examError } = await sb
            .from('exams')
            .select('*, course:course_id(course_name, unit_code)')
            .eq('id', examId)
            .eq('created_by', currentUserProfile.user_id)
            .single();

        if (examError || !exam) {
            showFeedback('Exam not found or access denied.', 'error');
            return;
        }

        // Get students for this exam
        const { data: students, error: studentError } = await sb
            .from('consolidated_user_profiles_table')
            .select('user_id, full_name, email, student_id')
            .eq('program', exam.target_program)
            .eq('intake_year', exam.intake_year)
            .eq('block', exam.block_term)
            .eq('role', 'student')
            .order('full_name');

        if (studentError) {
            showFeedback('Error loading students.', 'error');
            return;
        }

        if (!students || students.length === 0) {
            showFeedback('No students found for this exam.', 'warning');
            return;
        }

        // Get existing grades
        const { data: existingGrades, error: gradeError } = await sb
            .from('exam_grades')
            .select('*')
            .eq('exam_id', examId);

        if (gradeError) {
            console.error('Error loading grades:', gradeError);
            // Continue without existing grades
        }

        // Build grade modal HTML
        const modalHtml = `
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Grade: ${escapeHtml(exam.exam_name)}</h3>
                <span class="close-btn" onclick="closeGradeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="exam-info-card">
                    <h4>Exam Details</h4>
                    <p><strong>Course:</strong> ${escapeHtml(exam.course?.course_name || 'General')}</p>
                    <p><strong>Program:</strong> ${escapeHtml(exam.target_program)} | Block ${escapeHtml(exam.block_term)} | ${escapeHtml(exam.intake_year)}</p>
                    <p><strong>Type:</strong> ${escapeHtml(exam.exam_type)}</p>
                    <p><strong>Date:</strong> ${new Date(exam.exam_date).toLocaleDateString()}</p>
                </div>

                <div class="search-container">
                    <input type="text" id="gradeSearch" placeholder="Search students..." oninput="filterGradeStudents()">
                    <button class="btn-action" onclick="exportGrades('${examId}')"><i class="fas fa-download"></i> Export</button>
                </div>

                <div class="table-container">
                    <table class="grade-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Student ID</th>
                                <th>CAT 1<br><small>(/30)</small></th>
                                <th>CAT 2<br><small>(/30)</small></th>
                                <th>Final Exam<br><small>(/100)</small></th>
                                <th>Total<br><small>(/100)</small></th>
                                <th>Grade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="gradeTableBody">
                            ${students.map(student => {
                                const grade = existingGrades?.find(g => g.student_id === student.user_id) || {};
                                const cat1 = grade.cat_1_score || '';
                                const cat2 = grade.cat_2_score || '';
                                const final = grade.exam_score || '';
                                const total = grade.total_score || '';
                                
                                return `
                                    <tr data-name="${student.full_name.toLowerCase()}" data-id="${student.student_id.toLowerCase()}">
                                        <td>${escapeHtml(student.full_name)}</td>
                                        <td>${escapeHtml(student.student_id)}</td>
                                        <td><input type="number" min="0" max="30" step="0.5" 
                                               id="cat1-${student.user_id}" value="${cat1}" 
                                               oninput="calculateStudentGrade('${student.user_id}')"
                                               class="grade-input"></td>
                                        <td><input type="number" min="0" max="30" step="0.5"
                                               id="cat2-${student.user_id}" value="${cat2}"
                                               oninput="calculateStudentGrade('${student.user_id}')"
                                               class="grade-input"></td>
                                        <td><input type="number" min="0" max="100" step="0.5"
                                               id="final-${student.user_id}" value="${final}"
                                               oninput="calculateStudentGrade('${student.user_id}')"
                                               class="grade-input"></td>
                                        <td><input type="number" id="total-${student.user_id}" 
                                               value="${total}" readonly class="total-score"></td>
                                        <td><span id="grade-${student.user_id}" class="grade-letter">${calculateGradeLetter(total)}</span></td>
                                        <td>
                                            <select id="status-${student.user_id}" class="status-select">
                                                <option value="Scheduled" ${grade.result_status === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                                                <option value="InProgress" ${grade.result_status === 'InProgress' ? 'selected' : ''}>In Progress</option>
                                                <option value="Graded" ${grade.result_status === 'Graded' ? 'selected' : ''}>Graded</option>
                                                <option value="Final" ${grade.result_status === 'Final' ? 'selected' : ''}>Final</option>
                                            </select>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="modal-actions">
                    <button class="btn-action" onclick="saveAllGrades('${examId}')">
                        <i class="fas fa-save"></i> Save All Grades
                    </button>
                    <button class="btn-action btn-cancel" onclick="closeGradeModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;

        // Show modal
        const modal = $('gradeModal');
        modal.innerHTML = modalHtml;
        modal.classList.add('active');

        // Calculate initial grades
        students.forEach(student => calculateStudentGrade(student.user_id));
        
        showFeedback('Grading interface loaded successfully', 'success');

    } catch (error) {
        console.error('Error opening grade modal:', error);
        showFeedback('Failed to load grading interface: ' + error.message, 'error');
    }
}

// Calculate student grade
function calculateStudentGrade(studentId) {
    const cat1 = parseFloat($(`cat1-${studentId}`)?.value) || 0;
    const cat2 = parseFloat($(`cat2-${studentId}`)?.value) || 0;
    const final = parseFloat($(`final-${studentId}`)?.value) || 0;
    
    // Calculate total (CATs are 30% each, final is 40%)
    const total = (cat1 * 0.3) + (cat2 * 0.3) + (final * 0.4);
    
    const totalInput = $(`total-${studentId}`);
    const gradeSpan = $(`grade-${studentId}`);
    
    if (totalInput && gradeSpan) {
        totalInput.value = total.toFixed(1);
        gradeSpan.textContent = calculateGradeLetter(total);
        gradeSpan.className = `grade-letter ${getGradeClass(total)}`;
    }
}

// Calculate grade letter
function calculateGradeLetter(score) {
    if (!score && score !== 0) return '-';
    if (score >= 80) return 'A';
    if (score >= 75) return 'A-';
    if (score >= 70) return 'B+';
    if (score >= 65) return 'B';
    if (score >= 60) return 'B-';
    if (score >= 55) return 'C+';
    if (score >= 50) return 'C';
    if (score >= 45) return 'C-';
    if (score >= 40) return 'D+';
    if (score >= 35) return 'D';
    return 'E';
}

// Get grade CSS class
function getGradeClass(score) {
    if (!score && score !== 0) return 'grade-pending';
    if (score >= 50) return 'grade-pass';
    return 'grade-fail';
}

// Filter students in grade modal
function filterGradeStudents() {
    const searchTerm = $('gradeSearch')?.value.toLowerCase() || '';
    const rows = document.querySelectorAll('#gradeTableBody tr');
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const id = row.getAttribute('data-id') || '';
        const matches = name.includes(searchTerm) || id.includes(searchTerm);
        row.style.display = matches ? '' : 'none';
    });
}

// Save all grades
async function saveAllGrades(examId) {
    try {
        const rows = document.querySelectorAll('#gradeTableBody tr');
        const grades = [];
        let hasChanges = false;

        for (const row of rows) {
            if (row.style.display === 'none') continue;
            
            const studentId = row.querySelector('input[id^="cat1-"]')?.id.replace('cat1-', '');
            if (!studentId) continue;

            const cat1 = $(`cat1-${studentId}`)?.value;
            const cat2 = $(`cat2-${studentId}`)?.value;
            const final = $(`final-${studentId}`)?.value;
            const status = $(`status-${studentId}`)?.value;
            const total = $(`total-${studentId}`)?.value;

            // Only save if there are values
            if (cat1 || cat2 || final) {
                hasChanges = true;
                grades.push({
                    exam_id: parseInt(examId),
                    student_id: studentId,
                    cat_1_score: cat1 ? parseFloat(cat1) : null,
                    cat_2_score: cat2 ? parseFloat(cat2) : null,
                    exam_score: final ? parseFloat(final) : null,
                    total_score: total ? parseFloat(total) : null,
                    result_status: status,
                    graded_by: currentUserProfile.user_id,
                    question_id: '00000000-0000-0000-0000-000000000000', // Required field
                    updated_at: new Date().toISOString()
                });
            }
        }

        if (!hasChanges) {
            showFeedback('No grade changes to save.', 'info');
            return;
        }

        const { error } = await sb.from('exam_grades').upsert(grades, {
            onConflict: 'exam_id,student_id,question_id'
        });

        if (error) throw error;

        showFeedback(`âœ… Successfully saved grades for ${grades.length} students!`, 'success');
        
    } catch (error) {
        console.error('Error saving grades:', error);
        showFeedback(`Failed to save grades: ${error.message}`, 'error');
    }
}

// Close grade modal
function closeGradeModal() {
    $('gradeModal').classList.remove('active');
}

// Export grades to CSV
async function exportGrades(examId) {
    try {
        const { data: grades, error } = await sb
            .from('exam_grades')
            .select(`
                *,
                student:student_id(full_name, student_id),
                exam:exam_id(exam_name)
            `)
            .eq('exam_id', examId);

        if (error) throw error;

        if (!grades || grades.length === 0) {
            showFeedback('No grades to export.', 'info');
            return;
        }

        // Create CSV content
        let csv = 'Student Name,Student ID,CAT 1,CAT 2,Final Exam,Total Score,Grade,Status\n';
        
        grades.forEach(grade => {
            const student = grade.student;
            const gradeLetter = calculateGradeLetter(grade.total_score);
            csv += `"${student.full_name}","${student.student_id}",${grade.cat_1_score || ''},${grade.cat_2_score || ''},${grade.exam_score || ''},${grade.total_score || ''},${gradeLetter},${grade.result_status}\n`;
        });

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grades_${examId}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showFeedback('Grades exported successfully!', 'success');
        
    } catch (error) {
        console.error('Error exporting grades:', error);
        showFeedback('Failed to export grades.', 'error');
    }
}

// Utility function to escape HTML
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Load lecturer's exams - MOVED AFTER grade functions
async function loadLecturerExams() {
    const tbody = $('exams-table');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="8">Loading your exams...</td></tr>';

    try {
        const { data: exams, error } = await fetchData(
            'exams',
            '*, course:course_id(course_name, unit_code)',
            { created_by: currentUserProfile.user_id },
            'exam_date',
            false
        );

        if (error) throw error;

        if (!exams || exams.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">No exams found. Create your first exam above.</td></tr>';
            return;
        }

        tbody.innerHTML = exams.map(exam => {
            const courseName = exam.course?.course_name || 'General';
            const dateTime = exam.exam_date ? 
                new Date(exam.exam_date).toLocaleDateString() + 
                (exam.exam_start_time ? ` ${exam.exam_start_time}` : '') : 'N/A';
            
            const duration = exam.duration_minutes ? `${exam.duration_minutes} mins` : 'N/A';

            return `
                <tr>
                    <td><span class="exam-type-badge">${exam.exam_type || 'N/A'}</span></td>
                    <td><strong>${exam.exam_name || 'N/A'}</strong></td>
                    <td>${courseName}</td>
                    <td>${exam.target_program || 'N/A'}/${exam.block_term || 'N/A'}</td>
                    <td>${dateTime}</td>
                    <td>${duration}</td>
                    <td><span class="status status-${(exam.status || 'Scheduled').toLowerCase()}">${exam.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action" onclick="openEditExamModal('${exam.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-grade-exam" onclick="openGradeModal('${exam.id}')" title="Grade">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            ${exam.online_link ? `
                                <a href="${exam.online_link}" target="_blank" class="btn-action" title="Open Link">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            ` : ''}
                            <button class="btn-action delete" onclick="deleteExam('${exam.id}', '${exam.exam_name?.replace(/'/g, "\\'") || ''}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Failed to load exams:', error);
        tbody.innerHTML = `<tr><td colspan="8">Error loading exams: ${error.message}</td></tr>`;
    }
}

// Delete exam
async function deleteExam(examId, examName) {
    if (!confirm(`Are you sure you want to delete "${examName}"?`)) return;

    try {
        const { error } = await sb.from('exams')
            .delete()
            .eq('id', examId)
            .eq('created_by', currentUserProfile.user_id); // Security: only delete own exams

        if (error) throw error;

        showFeedback('âœ… Exam deleted successfully!', 'success');
        loadLecturerExams();
    } catch (error) {
        console.error('Delete failed:', error);
        showFeedback(`Delete failed: ${error.message}`, 'error');
    }
}

// Edit exam modal
async function openEditExamModal(examId) {
    try {
        const { data: exam, error } = await sb
            .from('exams')
            .select('*')
            .eq('id', examId)
            .eq('created_by', currentUserProfile.user_id) // Security: only edit own exams
            .single();

        if (error || !exam) {
            showFeedback('Exam not found or access denied.', 'error');
            return;
        }

        // Populate form
        $('edit_exam_id').value = exam.id;
        $('edit_exam_title').value = exam.exam_name || '';
        $('edit_exam_date').value = exam.exam_date || '';
        $('edit_exam_status').value = exam.status || 'Scheduled';

        // Show modal
        $('examEditModal').classList.add('active');
        
    } catch (error) {
        console.error('Error opening edit modal:', error);
        showFeedback('Failed to load exam details.', 'error');
    }
}

// Close edit modal
function closeEditExamModal() {
    $('examEditModal').classList.remove('active');
}

// Save edited exam
async function saveEditedExam(e) {
    e.preventDefault();
    const button = e.submitter;
    setButtonLoading(button, true, 'Save Changes');

    const examId = $('edit_exam_id').value;
    const title = $('edit_exam_title').value;
    const date = $('edit_exam_date').value;
    const status = $('edit_exam_status').value;

    if (!title || !date) {
        showFeedback('Title and date are required.', 'error');
        setButtonLoading(button, false);
        return;
    }

    try {
        const { error } = await sb.from('exams')
            .update({
                exam_name: title,
                exam_date: date,
                status: status,
                updated_at: new Date().toISOString()
            })
            .eq('id', examId)
            .eq('created_by', currentUserProfile.user_id); // Security: only update own exams

        if (error) throw error;

        showFeedback('âœ… Exam updated successfully!', 'success');
        closeEditExamModal();
        loadLecturerExams();
        
    } catch (error) {
        console.error('Error saving exam:', error);
        showFeedback(`Failed to update exam: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}
        // =================================================================
        // === 11. RESOURCES MANAGEMENT ===
        // =================================================================

        function populateResourceFormSelects() {
            const targetProgram = lecturerTargetProgram;
            const programs = targetProgram ? [{ id: targetProgram, name: targetProgram }] : [];
            
            populateSelect($('resource_program'), programs, 'id', 'name', 'Select Program');
            if (targetProgram) {
                $('resource_program').value = targetProgram;
            }

            populateSelect($('resource_intake'), allIntakes, 'id', 'name', 'Select Intake Year');
            
            const blockSelect = $('resource_block');
            if (targetProgram && ACADEMIC_STRUCTURE[targetProgram]) {
                const blocks = ACADEMIC_STRUCTURE[targetProgram].map(name => ({ id: name, name: name }));
                populateSelect(blockSelect, blocks, 'id', 'name', `Select ${targetProgram} Block/Term`);
            } else {
                blockSelect.innerHTML = '<option value="">-- Select Program First --</option>';
            }
        }

        async function handleUploadResource(e) {
            e.preventDefault();
            const submitButton = e.submitter;
            const originalText = submitButton.textContent;
            setButtonLoading(submitButton, true, 'Uploading...');

            const program = $('resource_program').value;
            const intake = $('resource_intake').value;
            const block = $('resource_block').value;
            const fileInput = $('resource_file');
            const title = $('resource_title').value.trim();
            const category = $('resource_category').value;

            if (!fileInput.files.length || !program || !intake || !block || !title || !category) {
                showFeedback('Please fill in all required fields and select a file.', 'error');
                setButtonLoading(submitButton, false, originalText);
                return;
            }

            let file = fileInput.files[0];
            let uploadFile = file;

            const originalExt = file.name.split('.').pop();
            const baseName = title.replace(/[^\w\-]+/g, '_') + '_' + file.name.replace(/\.[^.]+$/, '').replace(/[^\w\-]+/g, '_');

            let originalName = `${baseName}.${originalExt}`;
            let filePath = `${program}/${intake}/${block}/${originalName}`;

            try {
                if (/\.(docx?|pptx?)$/i.test(file.name)) {
                    originalName = `${baseName}.pdf`;
                    filePath = `${program}/${intake}/${block}/${baseName}.pdf`;
                }

                const { error: uploadError } = await sb.storage
                    .from(RESOURCES_BUCKET)
                    .upload(filePath, uploadFile, {
                        cacheControl: '3600',
                        upsert: true,
                        contentType: uploadFile.type
                    });
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = sb.storage
                    .from(RESOURCES_BUCKET)
                    .getPublicUrl(filePath);

                const { data: { user }, error: authError } = await sb.auth.getUser();
                if (authError) throw authError;

                const { error: dbError, data } = await sb
                    .from('resources')
                    .insert({
                        title: title,
                        category: category,
                        program_type: program,
                        target_program: program,
                        intake: intake,
                        intake_year: intake,
                        block: block,
                        block_term: block,
                        course_name: program,
                        file_path: filePath,
                        file_name: originalName,
                        file_url: publicUrl,
                        uploaded_by: user.id,
                        uploaded_by_name: currentUserProfile?.full_name,
                        allow_download: true
                    }).select('id');
                    
                if (dbError) throw dbError;

                showFeedback(`âœ… Resource "${title}" uploaded successfully!`, 'success');
                e.target.reset();
                loadLecturerResources();
            } catch (err) {
                console.error('Upload failed:', err);
                showFeedback(`âŒ Upload failed: ${err.message}`, 'error');
            } finally {
                setButtonLoading(submitButton, false, originalText);
            }
        }

        async function loadLecturerResources() {
            const tbody = $('resources-list');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6">Loading resources...</td></tr>';

            try {
                const { data: resources, error } = await fetchData(
                    RESOURCES_TABLE,
                    '*',
                    { uploaded_by: currentUserProfile.user_id },
                    'created_at',
                    false
                );

                if (error) throw error;

                if (!resources || resources.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No resources uploaded yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = resources.map(resource => {
                    return `
                        <tr>
                            <td>${resource.title || 'N/A'}</td>
                            <td>${resource.category || 'Academic'}</td>
                            <td>${resource.target_program || resource.program_type || 'N/A'}/${resource.block_term || resource.block || 'N/A'}</td>
                            <td>${resource.uploaded_by_name || 'N/A'}</td>
                            <td>${new Date(resource.created_at).toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: '2-digit', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</td>
                            <td>
                                <a href="${resource.file_url}" target="_blank" class="btn-action">
                                    <i class="fas fa-download"></i> Download
                                </a>
                                <button class="btn-action delete" onclick="deleteResource('${resource.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load resources:', error);
                tbody.innerHTML = `<tr><td colspan="6">Error loading resources: ${error.message}</td></tr>`;
            }
        }

        async function deleteResource(resourceId) {
            if (!confirm('Are you sure you want to delete this resource?')) return;

            try {
                const { error } = await sb.from(RESOURCES_TABLE)
                    .delete()
                    .eq('id', resourceId);

                if (error) throw error;

                showFeedback('âœ… Resource deleted successfully!', 'success');
                loadLecturerResources();
            } catch (error) {
                console.error('Delete failed:', error);
                showFeedback(`Delete failed: ${error.message}`, 'error');
            }
        }

        // =================================================================
        // === 12. MESSAGES MANAGEMENT - FIXED VERSION ===
        // =================================================================

        function populateMessageFormSelects(selectedUserId = null, selectedUserName = null) {
            const targetSelect = $('msg_target');
            
            let targetOptions = [
                { id: 'all-students', name: `All ${lecturerTargetProgram || 'Assigned'} Students` },
                { id: 'custom-user', name: 'Specific User (Manual ID/Email)' },
            ];
            
            if (selectedUserId && selectedUserName) {
                targetOptions.unshift({ 
                    id: selectedUserId, 
                    name: `Specific Student: ${selectedUserName}` 
                });
            }
            
            populateSelect(targetSelect, targetOptions, 'id', 'name', 'Select Message Target');

            if (selectedUserId) {
                targetSelect.value = selectedUserId;
            }
        }

        // UPDATED: Handle missing messages table gracefully
        async function handleSendMessage(e) { 
            e.preventDefault();
            const button = e.submitter;
            setButtonLoading(button, true, 'Send Message');
            
            const formData = {
                target: $('msg_target').value,
                subject: $('msg_subject').value,
                body: $('msg_body').value
            };

            if (Object.values(formData).some(v => !v)) {
                showFeedback('Please fill in all message details.', 'error');
                setButtonLoading(button, false);
                return;
            }
            
            // Check if messages table exists first
            try {
                // Test if messages table exists
                const { error: tableCheckError } = await sb
                    .from(MESSAGES_TABLE)
                    .select('id')
                    .limit(1);

                if (tableCheckError && tableCheckError.message.includes('does not exist')) {
                    showFeedback('Messages feature is not available yet. The messages table does not exist.', 'info');
                    setButtonLoading(button, false);
                    return;
                }

                let receiverId = 'SYSTEM_GROUP'; 
                let targetGroup = formData.target;
                
                if (formData.target === 'custom-user') {
                    showFeedback('The "Specific User (Manual)" feature requires additional input fields.', 'error');
                    setButtonLoading(button, false);
                    return;
                } else if (formData.target !== 'all-students') {
                    receiverId = formData.target;
                    targetGroup = 'specific-user';
                }
                
                const { error } = await sb.from(MESSAGES_TABLE).insert({
                    sender_id: currentUserProfile.user_id,
                    sender_name: currentUserProfile.full_name,
                    subject: formData.subject,
                    body: formData.body,
                    receiver_id: receiverId, 
                    target_program: lecturerTargetProgram,
                    target_group: targetGroup, 
                });

                if (error) throw error;

                showFeedback(`âœ… Message sent successfully!`, 'success');
                e.target.reset();
                populateMessageFormSelects();
                loadLecturerMessages(); 
                
            } catch (error) {
                console.error('Message sending failed:', error);
                showFeedback(`Message sending failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // UPDATED: Handle missing messages table gracefully
        async function loadLecturerMessages() {
            const tbody = $('messages-table');
            tbody.innerHTML = '<tr><td colspan="5">Loading messages...</td></tr>';
            
            try {
                // Check if table exists first
                const { error: tableCheckError } = await sb
                    .from(MESSAGES_TABLE)
                    .select('id')
                    .limit(1);

                if (tableCheckError && tableCheckError.message.includes('does not exist')) {
                    tbody.innerHTML = '<tr><td colspan="5">Messages feature not available. Table does not exist.</td></tr>';
                    return;
                }

                const { data: sentMessages, error } = await fetchData(
                    MESSAGES_TABLE, 
                    '*', 
                    { sender_id: currentUserProfile.user_id }, 
                    'sent_at', 
                    false
                );

                if (error) {
                    tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
                    return;
                }

                if (!sentMessages || sentMessages.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No messages sent by you found.</td></tr>';
                    return;
                }

                tbody.innerHTML = sentMessages.map(m => {
                    let targetDisplay;
                    if (m.target_group === 'all-students') {
                        targetDisplay = `All ${m.target_program} Students`;
                    } else if (m.target_group === 'specific-user') {
                        const student = allStudents.find(s => s.user_id === m.receiver_id);
                        targetDisplay = student ? student.full_name : `User ID: ${m.receiver_id}`;
                    } else {
                        targetDisplay = m.target_group;
                    }

                    return `
                        <tr>
                            <td>${new Date(m.sent_at).toLocaleString()}</td>
                            <td>${m.subject}</td>
                            <td>${targetDisplay}</td>
                            <td><span class="status status-success">Sent</span></td>
                            <td><button class="btn-action" style="background-color:#4C1D95;" onclick="showFeedback('Viewing message ${m.id}', 'info')">View</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load messages:', error);
                tbody.innerHTML = `<tr><td colspan="5">Error loading messages: ${error.message}</td></tr>`;
            }
        }

        function showSendMessageModal(userId, fullName) { 
            $('send-message-form')?.reset();
            populateMessageFormSelects(userId, fullName);
            showFeedback(`Ready to message ${fullName}. Note: Messages table might not exist.`, 'info');
        }

        // =================================================================
        // === 13. REPORTS & SETTINGS ===
        // =================================================================

        async function handleGenerateReport(e) {
            e.preventDefault();
            const button = e.submitter;
            setButtonLoading(button, true, 'Generate Report');
            
            const reportType = $('report_type').value;
            const reportScope = $('report_scope').value;
            
            if (!reportType || !reportScope) {
                showFeedback('Please select both report type and scope.', 'error');
                setButtonLoading(button, false);
                return;
            }
            
            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showFeedback(`âœ… ${reportType} report generated successfully for ${reportScope}!`, 'success');
                
                const reportsTable = $('reports-table');
                const newRow = `
                    <tr>
                        <td>${reportType} - ${new Date().toLocaleDateString()}</td>
                        <td>${reportType}</td>
                        <td>${reportScope}</td>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td>
                            <button class="btn-action" onclick="showFeedback('Downloading report...', 'info')">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </td>
                    </tr>
                `;
                
                if (reportsTable.innerHTML.includes('No reports generated yet')) {
                    reportsTable.innerHTML = newRow;
                } else {
                    reportsTable.innerHTML = newRow + reportsTable.innerHTML;
                }
                
            } catch (error) {
                console.error('Report generation failed:', error);
                showFeedback(`Report generation failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function handleSaveSettings(e) {
            e.preventDefault();
            const button = e.submitter;
            setButtonLoading(button, true, 'Save Settings');
            
            const emailNotify = $('email_notify').checked;
            const smsNotify = $('sms_notify').checked;
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                showFeedback('âœ… Settings saved successfully!', 'success');
            } catch (error) {
                console.error('Settings save failed:', error);
                showFeedback(`Settings save failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // =================================================================
        // === 14. BASIC UI FUNCTIONS ===
        // =================================================================

        function saveResourceEdits() { 
            showFeedback('Resource edits saved (placeholder).', 'info');
            closeEditResourceModal(); 
        }
        
        function closeEditResourceModal() { 
            $('editResourceModal').classList.remove('active'); 
        }

        function showAuthFailure(error) {
            console.error("Initialization Failed, Redirecting to Login:", error);
            const errorMessage = error?.message || "No active session found.";
            alert(`Authentication Failed: ${errorMessage}\n\nPlease log in again.`);
            localStorage.clear(); 
            window.location.assign('/login'); 
        }

        // Placeholder functions for missing sections
        function loadReports() {
            showFeedback('Reports section loaded', 'info');
        }

        function loadSettings() {
            showFeedback('Settings section loaded', 'info');
        }

        // Initialize dashboard data
        function initializeDashboardData() {
            document.getElementById('total_students_count').textContent = allStudents.length || '0';
            document.getElementById('total_courses_count').textContent = allCourses.filter(c => c.target_program === lecturerTargetProgram).length || '0';
            document.getElementById('students_at_risk_count').textContent = Math.floor(allStudents.length * 0.1) || '0';
            document.getElementById('pending_attendance_count').textContent = '3';
            document.getElementById('exams_due_count').textContent = '2';
            document.getElementById('unread_messages_count').textContent = '5';
            updateStudentStats();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboardData();
        });

    </script>
</body>
</html>
