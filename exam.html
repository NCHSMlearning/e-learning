<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam - NCHSM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- General and Reset --- */
body { 
    font-family: 'Poppins', sans-serif; 
    background: #F8F9FA; 
    margin: 0; 
    padding: 10px; 
}
/* Disable all forms of selection and context menu for lockdown */
body, .exam-main, .question, .options, .options li, label { user-select: none; }
h1 { text-align: center; color: #073450; margin-bottom: 20px; font-size: 1.8rem; } 

/* --- Main Layout: Grid for Sidebar + Content (Mobile First) --- */
.page-wrapper {
    display: grid;
    grid-template-columns: 1fr; 
    gap: 20px; 
    max-width: 1200px;
    margin: 10px auto;
}
.sidebar {
    background: #fff;
    padding: 15px; 
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    position: static; 
    top: 20px;
    height: auto;
    order: 2; 
}
.exam-main {
    background: #fff;
    padding: 20px; 
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    order: 1; 
}

/* --- Desktop/Tablet Layout Adjustment (Min-width 992px) --- */
@media (min-width: 992px) {
    body { padding: 20px; }
    .page-wrapper {
        grid-template-columns: 300px 1fr; 
        gap: 30px;
        margin: 20px auto;
    }
    .sidebar {
        position: sticky; 
        order: 1; 
    }
    .exam-main {
        order: 2;
        padding: 30px;
    }
}

/* --- Question Status Table Styling (Responsive Grid) --- */
.status-title { font-size: 1.1rem; font-weight: 600; color: #073450; margin-bottom: 15px; border-bottom: 2px solid #E2E8F0; padding-bottom: 10px; }
#question-status-table {
    display: grid;
    grid-template-columns: repeat(6, 1fr); 
    gap: 8px; 
}
@media (min-width: 576px) {
    #question-status-table {
        grid-template-columns: repeat(8, 1fr); 
    }
}
@media (min-width: 992px) {
    #question-status-table {
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px;
    }
}
.status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 45px; 
    background: #F1F5F9;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.8rem;
    font-weight: 500;
    color: #475569;
    border: 2px solid #F1F5F9;
}
.status-item:hover { background: #E2E8F0; transform: translateY(-1px); }
.status-item.current { border-color: #0A3D62; background: #E2E8F0; font-weight: 700; }
.status-item.answered { background: #D1FAE5; border-color: #38A169; color: #064E3B; }
.status-item.answered::after { content: '✓'; font-size: 1.2rem; margin-top: 3px; color: #38A169; }
.status-number { font-weight: 600; }
.status-item.answered .status-number { display: none; }

/* --- Exam Header/Timer --- */
#timer { font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; color: #DC2626; } 

/* --- Progress and Question Content --- */
#progress { margin-top: 15px; margin-bottom: 10px; color: #475569; font-weight: 500;}
.progress-bar { height: 8px; margin-bottom: 20px; } 
.progress-fill { height: 100%; background: #38A169; width: 0%; transition: width 0.3s ease; }
.question-area { border-top: 1px solid #E2E8F0; padding-top: 20px; }
.question { margin-bottom: 20px; font-size: 1rem; font-weight: 600; color: #073450;}
.options { list-style: none; padding: 0; }
.options li { margin: 10px 0; }
.options label { padding: 10px; border-radius: 6px;}

/* --- Navigation Buttons (Streamlined) --- */
#nav-buttons {
    margin-top: 20px;
    display: flex;
    flex-direction: column; 
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #E2E8F0;
}
.left-nav {
    display: flex;
    justify-content: space-between;
    width: 100%;
    justify-content: space-around; 
}
.left-nav button { flex-grow: 1; margin: 0 10px; } 

button {
    padding: 10px 20px; 
    font-size: 0.9rem;
    border-radius: 6px;
    transition: all 0.2s ease; 
}
@media (min-width: 576px) {
    #nav-buttons {
        flex-direction: row; 
        justify-content: space-between;
    }
    .left-nav { width: auto; }
    .left-nav button { margin-right: 10px; }
    button { padding: 12px 25px; font-size: 1rem; }
}
button#submit-exam-btn { background: #DC2626; }
button#submit-exam-btn:hover:enabled { background: #B91C1C; }
button:disabled { background: #94D3A2; cursor: not-allowed; opacity: 0.6; }
button:hover:enabled { background: #2F855A; }
button#submit-exam-btn:disabled { background: #FCA5A5; cursor: not-allowed; box-shadow: none; }

/* --- Messages --- */
#answer-saved { 
    padding: 6px 12px; 
    margin: 10px auto 20px; 
}
#error { color: #EF4444; font-weight: 600; text-align: center; margin-bottom: 15px; }
#final-msg { text-align: center; font-size: 1.3rem; color: #064E3B; margin-top: 30px; }


/* =============================== */
/* --- SUBMISSION MODAL STYLES --- */
/* =============================== */
.modal-overlay {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000; /* Ensure it's above everything */
    align-items: center;
    justify-content: center;
}
.modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    text-align: center;
}
.modal-content h3 {
    color: #DC2626;
    margin-top: 0;
    font-weight: 700;
}
.modal-content p {
    color: #475569;
    font-size: 1rem;
    margin-bottom: 25px;
    font-weight: 500;
}
.modal-buttons button {
    margin: 0 10px;
    padding: 10px 20px;
    font-weight: 600;
    width: 120px; /* Uniform width */
}
#confirm-submit-btn {
    background: #38A169;
}
#confirm-submit-btn:hover {
    background: #2F855A;
}
#cancel-submit-btn {
    background: #E5E7EB;
    color: #475569;
}
#cancel-submit-btn:hover {
    background: #D1D5DB;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="page-wrapper">
    <div class="sidebar">
        <div id="timer">Loading timer...</div>
        <div class="status-title">Question Status</div>
        <div id="question-status-table">
            </div>
    </div>
    
    <div class="exam-main">
        <h1>Examination</h1>
        
        <div id="progress">
            Question <span id="current">0</span> of <span id="total">0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        
        <div class="question-area">
            <div id="error"></div>
            
            <div id="exam-container">Loading question...</div>
            
            <div id="answer-saved">✅ Answer saved!</div>

            <div id="nav-buttons">
                <div class="left-nav">
                    <button id="prev-btn" disabled>Previous</button>
                    <button id="next-btn" disabled>Next</button>
                </div>
                <button id="submit-exam-btn" disabled>Submit Exam</button>
            </div>
        </div>
        
        <div id="final-msg"></div>
    </div>
</div>

<div id="submission-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Final Submission Confirmation</h3>
        <p>
            You are about to submit your exam. Please confirm.
        </p>
        <div class="modal-buttons">
            <button id="cancel-submit-btn">Cancel</button>
            <button id="confirm-submit-btn">Confirm & Submit</button>
        </div>
    </div>
</div>

<script>
// IMPORTANT: Ensure your Supabase exam_grades table has a composite unique constraint/primary key on (student_id, exam_id, question_id) for upsert to work correctly.

// --- CONFIGURATION ---
const SUPABASE_URL='https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const REDIRECT_URL = 'https://nakurucollegeofhealthelearning.site/exam_dashboard.html';

const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const params=new URLSearchParams(window.location.search);
const EXAM_ID=params.get('exam_id');
let studentId=localStorage.getItem('currentUserId'); 
let questions=[], currentIndex=0, duration=0, timerInterval;
let answers={}; 
let hasAnsweredAtLeastOne = false; 

// References to the modal elements
const submissionModal = document.getElementById('submission-modal');
const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
const finalSubmitBtn = document.getElementById('submit-exam-btn');


if(!studentId){ 
    window.location.href='exam_login.html'; 
}

// --- NAVIGATION FUNCTIONS ---
function nextQuestion(){
    if(currentIndex < questions.length - 1){
        renderQuestion(currentIndex + 1);
    }
}
function prevQuestion(){
    if(currentIndex > 0){
        renderQuestion(currentIndex - 1);
    }
}

// --- CORE FUNCTIONS ---
async function initExam(){
    try{
        const { data: examData } = await sb.from('exams_with_courses').select('*').eq('id',EXAM_ID).maybeSingle();
        if(!examData){ document.getElementById('error').innerText='Exam not found'; return; }
        duration=examData.duration_minutes||30;

        const { data: qData, error: qError } = await sb.from('questions').select('*').eq('exam_id',EXAM_ID);
        if(qError || !qData || qData.length===0){ 
            document.getElementById('exam-container').innerText='No questions found or failed to load questions.'; 
            console.error(qError);
            return; 
        }
        questions=qData;

        await loadExistingAnswers();
        
        document.getElementById('total').innerText=questions.length;
        renderQuestionStatusTable();
        renderQuestion();
        startTimer(duration*60);
        lockDown();
    }catch(err){ 
        console.error(err); 
        document.getElementById('error').innerText='Error loading exam.'; 
    }
}

async function loadExistingAnswers() {
    try {
        const { data, error } = await sb.from('exam_grades')
            .select('question_id, selected_answer')
            .eq('student_id', studentId)
            .eq('exam_id', EXAM_ID);

        if (error) throw error;
        
        if (data && data.length > 0) {
            data.forEach(item => {
                // Only load if an answer was actually selected (not null/skipped)
                if (item.selected_answer !== null) { 
                    answers[item.question_id] = item.selected_answer;
                    hasAnsweredAtLeastOne = true;
                }
            });
            if (hasAnsweredAtLeastOne) {
                finalSubmitBtn.disabled = false;
            }
        }
    } catch (err) {
        console.error('Error loading existing answers:', err);
    }
}

function renderQuestion(index = currentIndex){
    currentIndex = index;
    const q=questions[currentIndex];
    const container=document.getElementById('exam-container');
    
    container.innerHTML='';

    const questionText = document.createElement('div');
    questionText.className = 'question';
    questionText.innerHTML = `<p><strong>Q${currentIndex+1}:</strong> ${q.question}</p>`;
    container.appendChild(questionText);

    const ul=document.createElement('ul'); ul.className='options';
    // Ensure options are parsed if they are stored as JSON string
    const opts=Array.isArray(q.options)?q.options:JSON.parse(q.options); 
    
    opts.forEach(opt=>{
        const li=document.createElement('li');
        li.innerHTML=`<label><input type="radio" name="q${q.id}" value="${opt}"> <span>${opt}</span></label>`; 
        ul.appendChild(li);
    });
    container.appendChild(ul);

    // RESTORE STATE
    if(answers[q.id]){
        const input=document.querySelector(`input[name="q${q.id}"][value="${answers[q.id]}"]`);
        if(input) input.checked=true;
    }

    updateProgressUI();
    updateStatusTableUI();

    // Add event listener for auto-save and Submit button enablement
    const radios=document.querySelectorAll(`input[name="q${q.id}"]`);
    radios.forEach(r=>{
        r.addEventListener('change', ()=>{ 
            saveAnswer(r.value);
            if (!hasAnsweredAtLeastOne) {
                hasAnsweredAtLeastOne = true;
                finalSubmitBtn.disabled = false;
            }
            updateStatusTableUI(); 
        });
    });
}

// --- STATUS TABLE FUNCTIONS ---
function renderQuestionStatusTable() {
    const tableEl = document.getElementById('question-status-table');
    tableEl.innerHTML = '';

    questions.forEach((q, index) => {
        const item = document.createElement('div');
        item.className = 'status-item';
        item.id = `q-status-${index}`;
        item.innerHTML = `<span class="status-number">${index + 1}</span>`;
        item.dataset.index = index;
        
        item.addEventListener('click', () => {
            renderQuestion(index);
        });

        tableEl.appendChild(item);
    });

    updateStatusTableUI();
}

function updateStatusTableUI() {
    questions.forEach((q, index) => {
        const item = document.getElementById(`q-status-${index}`);
        if (!item) return;

        item.classList.remove('current', 'answered');

        if (index === currentIndex) {
            item.classList.add('current');
        }

        if (answers.hasOwnProperty(q.id) && answers[q.id] !== null) {
            item.classList.add('answered');
        }
    });
}

function updateProgressUI() {
    document.getElementById('current').innerText = currentIndex + 1;
    
    const progressPercent = ((currentIndex + 1) / questions.length) * 100;
    document.getElementById('progress-fill').style.width = progressPercent + '%';

    document.getElementById('prev-btn').disabled = (currentIndex === 0);
    document.getElementById('next-btn').disabled = (currentIndex === questions.length - 1);
}

// --- PERSISTENCE AND SUBMISSION ---
async function saveAnswer(selectedAnswerValue){
    const q=questions[currentIndex];
    const answer = selectedAnswerValue;
    
    answers[q.id] = answer; 

    document.getElementById('answer-saved').style.display='block';
    setTimeout(()=>{ document.getElementById('answer-saved').style.display='none'; },1000);

    const marks = answer === q.correct_answer ? (q.marks || 1) : 0;
    
    try{
        await sb.from('exam_grades').upsert(
            [{
                student_id: studentId, 
                exam_id: EXAM_ID, 
                question_id: q.id, 
                selected_answer: answer, 
                marks, 
                graded_at: new Date()
            }],
            {onConflict:['student_id','exam_id','question_id']}
        );
    }catch(err){ 
        console.error('Error saving answer', err);
        document.getElementById('error').innerText='Warning: Could not save answer to server!';
    }
}

// MODIFIED: This function now calculates skipped count and updates/shows the modal
function submitExam(){
    let skippedCount = 0;
    
    // Count skipped questions
    questions.forEach(q => {
        // If question ID is missing from answers OR the value is null (was skipped/unanswered)
        if (!answers.hasOwnProperty(q.id) || answers[q.id] === null) {
            skippedCount++;
        }
    });

    const modalMessageEl = submissionModal.querySelector('.modal-content p');
    let message = `You are about to submit your exam. Please confirm.`;

    if (skippedCount > 0) {
        // Display a strong warning about the skipped questions
        message += ` **Warning:** You have **${skippedCount}** unanswered question(s). These will be marked as incorrect (0 marks).`;
    } else {
        message += ` All questions have been answered.`;
    }
    
    modalMessageEl.innerHTML = message;
    submissionModal.style.display = 'flex';
}

// NEW FUNCTION: Handles the actual submission after confirmation
async function executeSubmission(){
    // Disable all buttons to prevent double-clicks
    document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    submissionModal.style.display = 'none';
    document.getElementById('error').innerText = 'Submitting final answers...';

    // Logic to record all skipped/unanswered questions with 0 marks (CRITICAL)
    const skippedEntries = [];
    questions.forEach(q => {
        const questionId = q.id;
        if (!answers.hasOwnProperty(questionId) || answers[questionId] === null) {
            skippedEntries.push({
                student_id: studentId, 
                exam_id: EXAM_ID, 
                question_id: questionId, 
                selected_answer: null, 
                marks: 0, 
                graded_at: new Date()
            });
        }
    });

    if (skippedEntries.length > 0) {
        // Upsert the zero-mark entries for skipped questions
        const { error } = await sb.from('exam_grades').upsert(skippedEntries, {onConflict:['student_id','exam_id','question_id']});
        if (error) {
            console.error('Error saving skipped answers:', error);
            document.getElementById('error').innerText = 'CRITICAL ERROR: Submission failed to finalize skipped questions in the database. (Check Supabase constraint!)';
            return;
        }
    }
    
    showFinalScreen();

    document.getElementById('error').innerText = '';
    document.getElementById('final-msg').innerText = '✅ Exam submitted successfully! Redirecting to dashboard...';
    
    // --- REDIRECT TO DASHBOARD ---
    setTimeout(() => {
        window.location.href = REDIRECT_URL; 
    }, 1500); 
}


function showFinalScreen(){
    clearInterval(timerInterval);
    window.removeEventListener('beforeunload', beforeUnloadHandler); 
    
    document.getElementById('exam-container').innerHTML = '';
    document.getElementById('nav-buttons').style.display = 'none';
    document.getElementById('progress').style.display = 'none'; 
    document.getElementById('answer-saved').style.display = 'none';
    document.getElementById('timer').innerText = "Exam Ended.";
    document.getElementById('final-msg').innerText='Exam submitted! Processing results...';
}


// --- TIMER AND LOCKDOWN ---
function startTimer(seconds){
    const timerEl=document.getElementById('timer');
    function updateTimer(){
        const m=Math.floor(seconds/60), s=seconds%60;
        const timeString = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        timerEl.innerText=`Time Remaining: ${timeString}`;
        if(seconds-- <=0) {
            // Timer expiry triggers submission automatically
            executeSubmission(); 
            return;
        }
    }
    updateTimer();
    timerInterval=setInterval(updateTimer,1000);
}

function lockDown(){
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('cut', e => e.preventDefault());
    document.addEventListener('paste', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    window.addEventListener('beforeunload', beforeUnloadHandler);
    
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // Automatic submission if student leaves the page/tab
            executeSubmission(); 
            alert('Warning: The exam was automatically submitted due to unauthorized page context change (leaving the tab/window).'); 
        }
    });
}

function beforeUnloadHandler(e){
    e.preventDefault();
    e.returnValue='Warning: Leaving this page will submit your exam immediately.';
}

// --- EVENT LISTENERS ---
document.getElementById('prev-btn').addEventListener('click', prevQuestion);
document.getElementById('next-btn').addEventListener('click', nextQuestion);
finalSubmitBtn.addEventListener('click', submitExam); // Shows the modal with the warning
confirmSubmitBtn.addEventListener('click', executeSubmission); // Executes submission after confirmation
cancelSubmitBtn.addEventListener('click', () => { // Hides the modal
    submissionModal.style.display = 'none';
});

window.addEventListener('DOMContentLoaded', initExam);
</script>
</body>
</html>
