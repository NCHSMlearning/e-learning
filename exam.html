<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam - NCHSM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body{ font-family:'Poppins',sans-serif; background:#F8F9FA; margin:0; padding:20px; user-select:none;}
.container{ max-width:700px; margin:20px auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.05);}
h1{text-align:center; color:#073450; user-select:none;}
#timer{ text-align:center; font-weight:600; font-size:1.2rem; margin-bottom:15px; color:#073450;}
#progress{ margin-bottom:15px;}
.progress-bar{ width:100%; height:15px; background:#E5E7EB; border-radius:8px; overflow:hidden; margin-bottom:15px;}
.progress-fill{ height:100%; background:#38A169; width:0%; transition: width 0.3s ease;}
.question{ margin-bottom:20px; user-select:none;}
.options{ list-style:none; padding:0;}
.options li{ margin:8px 0;}
button{
    padding:12px 25px; background:#38A169; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;
    transition: all 0.2s ease; margin-right:10px;
}
button:disabled{ background:#94D3A2; cursor:not-allowed;}
button:hover:enabled{ background:#2F855A; }
#score{ margin-top:20px; font-weight:600; font-size:1.2rem; color:#064E3B; text-align:center; }
#error{ color:#EF4444; font-weight:600; text-align:center; margin-bottom:15px; }
#final-msg{text-align:center; font-size:1.3rem; color:#064E3B; margin-top:30px;}
#answer-saved{ color:#064E3B; font-weight:600; margin-bottom:10px; display:none;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
    <h1>Exam</h1>
    <div id="timer">Loading timer...</div>
    <div id="progress">
        Question <span id="current">0</span> of <span id="total">0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <div id="error"></div>
    <div id="answer-saved">Answer saved!</div>
    <div id="exam-container">Loading question...</div>
    <div id="nav-buttons" style="margin-top:15px;">
        <button id="prev-btn" disabled>Previous</button>
        <button id="next-btn" disabled>Next</button>
    </div>
    <div id="score"></div>
    <div id="final-msg"></div>
</div>

<script>
const SUPABASE_URL='https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const params=new URLSearchParams(window.location.search);
const EXAM_ID=params.get('exam_id');
let studentId=localStorage.getItem('currentUserId');
let questions=[],currentIndex=0,duration=0,timerInterval;
let answers={}; // Store selected answers locally

if(!studentId){ window.location.href='exam_login.html'; }

async function initExam(){
    try{
        const { data: examData } = await sb.from('exams_with_courses').select('*').eq('id',EXAM_ID).maybeSingle();
        if(!examData){ document.getElementById('error').innerText='Exam not found'; return; }
        duration=examData.duration_minutes||30;

        const { data: qData } = await sb.from('questions').select('*').eq('exam_id',EXAM_ID);
        if(!qData || qData.length===0){ document.getElementById('exam-container').innerText='No questions found'; return; }
        questions=qData;

        document.getElementById('total').innerText=questions.length;
        renderQuestion();
        startTimer(duration*60);
        lockDown();
    }catch(err){ console.error(err); document.getElementById('error').innerText='Error loading exam.'; }
}

function renderQuestion(){
    const q=questions[currentIndex];
    const container=document.getElementById('exam-container');
    container.innerHTML=`<div class="question"><p><strong>Q${currentIndex+1}:</strong> ${q.question}</p></div>`;
    const ul=document.createElement('ul'); ul.className='options';
    const opts=Array.isArray(q.options)?q.options:JSON.parse(q.options);
    opts.forEach(opt=>{
        const li=document.createElement('li');
        li.innerHTML=`<label><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label>`;
        ul.appendChild(li);
    });
    container.appendChild(ul);

    // Restore previous answer if exists
    if(answers[q.id]){
        const input=document.querySelector(`input[name="q${q.id}"][value="${answers[q.id]}"]`);
        if(input) input.checked=true;
        document.getElementById('next-btn').disabled=false;
    } else {
        document.getElementById('next-btn').disabled=true;
    }

    // Update progress
    document.getElementById('current').innerText=currentIndex+1;
    document.getElementById('progress-fill').style.width=((currentIndex)/questions.length*100)+'%';

    // Enable next button when answer selected
    const radios=document.querySelectorAll(`input[name="q${q.id}"]`);
    radios.forEach(r=>{
        r.addEventListener('change', ()=>{ 
            document.getElementById('next-btn').disabled=false;
            saveAnswer();
        });
    });

    // Update prev button
    document.getElementById('prev-btn').disabled=currentIndex===0;
}

async function saveAnswer(){
    const q=questions[currentIndex];
    const selected=document.querySelector(`input[name="q${q.id}"]:checked`);
    const answer=selected?selected.value:null;
    if(answer===null) return;

    answers[q.id]=answer;
    document.getElementById('answer-saved').style.display='block';
    setTimeout(()=>{ document.getElementById('answer-saved').style.display='none'; },1000);

    const marks=answer===q.correct_answer?(q.marks||1):0;
    try{
        await sb.from('exam_grades').upsert(
            [{student_id:studentId, exam_id:EXAM_ID, question_id:q.id, marks, graded_at:new Date()}],
            {onConflict:['student_id','exam_id','question_id']}
        );
    }catch(err){ console.error('Error saving answer',err);}
}

async function nextQuestion(){
    if(currentIndex<questions.length-1){
        currentIndex++;
        renderQuestion();
    } else {
        showFinalScreen();
    }
}

function prevQuestion(){
    if(currentIndex>0){
        currentIndex--;
        renderQuestion();
    }
}

function showFinalScreen(){
    clearInterval(timerInterval);
    const container=document.getElementById('exam-container');
    container.innerHTML='';
    document.getElementById('nav-buttons').style.display='none';
    document.getElementById('progress-fill').style.width='100%';
    document.getElementById('final-msg').innerText='âœ… Exam submitted! Please wait for results.';
}

function startTimer(seconds){
    const timerEl=document.getElementById('timer');
    function updateTimer(){
        const m=Math.floor(seconds/60), s=seconds%60;
        timerEl.innerText=`Time Remaining: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(seconds-- <=0) showFinalScreen();
    }
    updateTimer();
    timerInterval=setInterval(updateTimer,1000);
}

function lockDown(){
    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('copy', e=>e.preventDefault());
    document.addEventListener('cut', e=>e.preventDefault());
    document.addEventListener('paste', e=>e.preventDefault());
    document.addEventListener('selectstart', e=>e.preventDefault());
    window.addEventListener('beforeunload',beforeUnloadHandler);
    document.addEventListener('visibilitychange',()=>{
        if(document.hidden){ showFinalScreen(); alert('Exam submitted because you left the page!'); }
    });
}

function beforeUnloadHandler(e){
    e.preventDefault();
    e.returnValue='Exam submitted because you left the page!';
}

document.getElementById('next-btn').addEventListener('click',nextQuestion);
document.getElementById('prev-btn').addEventListener('click',prevQuestion);
window.addEventListener('DOMContentLoaded',initExam);
</script>
</body>
</html>
