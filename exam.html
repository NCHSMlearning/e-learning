<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam - NCHSM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body{ font-family:'Poppins',sans-serif; background:#F8F9FA; margin:0; padding:20px; }
.container{ max-width:900px; margin:20px auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.05);}
h1{ text-align:center; color:#073450; }
.question{ margin-bottom:20px; }
.options{ list-style:none; padding:0; }
.options li{ margin:8px 0; }
button{ padding:12px 25px; background:#38A169; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
button:hover{ background:#2F855A; }
#score{ margin-top:20px; font-weight:600; font-size:1.2rem; color:#064E3B; text-align:center; }
#error{ color:#EF4444; font-weight:600; text-align:center; margin-bottom:15px; }
#timer{ text-align:center; font-weight:600; font-size:1.2rem; margin-bottom:15px; color:#073450;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
    <h1>Exam</h1>
    <div id="timer">Loading timer...</div>
    <div id="error"></div>
    <div id="exam-container">Loading questions...</div>
    <button id="submit-btn">Submit Exam</button>
    <div id="score"></div>
</div>

<script>
const SUPABASE_URL='https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const params=new URLSearchParams(window.location.search);
const EXAM_ID=params.get('exam_id');
let studentId=localStorage.getItem('currentUserId');
let questions=[],duration=0,timerInterval;

if(!studentId){ window.location.href='exam_login.html'; }

async function initExam(){
    try{
        // fetch exam details
        const { data: examData, error: examError } = await sb.from('exams_with_courses').select('*').eq('id',EXAM_ID).maybeSingle();
        if(examError || !examData){ document.getElementById('error').innerText='Exam not found'; return; }
        duration = examData.duration_minutes || 30;

        // fetch questions
        const { data: qData, error: qError } = await sb.from('questions').select('*').eq('exam_id',EXAM_ID);
        if(qError || !qData || qData.length===0){ document.getElementById('exam-container').innerText='No questions found'; return; }
        questions=qData;
        renderQuestions();
        startTimer(duration*60);
        lockDown();
    }catch(err){ console.error(err); document.getElementById('error').innerText='Error loading exam.'; }
}

function renderQuestions(){
    const container=document.getElementById('exam-container');
    container.innerHTML='';
    questions.forEach((q,idx)=>{
        const div=document.createElement('div');
        div.className='question';
        div.innerHTML=`<p><strong>Q${idx+1}:</strong> ${q.question}</p>`;
        const ul=document.createElement('ul'); ul.className='options';
        const opts=Array.isArray(q.options)?q.options:JSON.parse(q.options);
        opts.forEach(opt=>{
            const li=document.createElement('li');
            li.innerHTML=`<label><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label>`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
    });
}

function startTimer(seconds){
    const timerEl=document.getElementById('timer');
    function updateTimer(){
        const m=Math.floor(seconds/60), s=seconds%60;
        timerEl.innerText=`Time Remaining: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(seconds-- <=0){ submitExam(); clearInterval(timerInterval); }
    }
    updateTimer();
    timerInterval=setInterval(updateTimer,1000);
}

async function submitExam(){
    clearInterval(timerInterval);
    let score=0;
    const answers={};
    questions.forEach(q=>{
        const selected=document.querySelector(`input[name="q${q.id}"]:checked`);
        answers[q.id]=selected?selected.value:null;
        if(answers[q.id]===q.correct_answer) score+=q.marks||1;
    });
    document.getElementById('score').innerText=`Your Score: ${score} / ${questions.length}`;

    try{
        const { error } = await sb.from('exam_grades').insert([{ student_id:studentId, exam_id:EXAM_ID, marks:score, graded_at:new Date() }]);
        if(error){ console.error('Error saving results:', error); document.getElementById('error').innerText='Error saving results.'; }
        else{ console.log('Result saved successfully'); }
    }catch(err){ console.error(err); document.getElementById('error').innerText='Error saving results.'; }
}

// --- Exam Lockdown ---
function lockDown(){
    // disable right click
    document.addEventListener('contextmenu', e => e.preventDefault());
    // disable copy/paste
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('cut', e => e.preventDefault());
    document.addEventListener('paste', e => e.preventDefault());
    // warn before leaving page
    window.addEventListener('beforeunload', e=>{
        e.preventDefault(); e.returnValue='';
    });
}

document.getElementById('submit-btn').addEventListener('click', submitExam);
window.addEventListener('DOMContentLoaded', initExam);
</script>
</body>
</html>
