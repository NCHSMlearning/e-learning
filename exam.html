<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Portal - NCHSM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Poppins', sans-serif;
    background: #F8F9FA;
    margin:0;
    padding:0;
    overflow:hidden; /* Prevent scrolling */
}
.container{
    max-width: 900px;
    margin:20px auto;
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 5px 20px rgba(0,0,0,0.05);
}
h1{text-align:center;color:#073450;}
.question{margin-bottom:20px;}
.options{list-style:none;padding:0;}
.options li{margin:8px 0;}
button{
    padding:12px 25px;
    background:#38A169;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
}
button:hover{background:#2F855A;}
#score{margin-top:20px;font-weight:600;font-size:1.2rem;color:#064E3B;text-align:center;}
#error{color:#EF4444;font-weight:600;text-align:center;margin-bottom:15px;}
#timer{text-align:center;font-weight:600;font-size:1.2rem;margin-bottom:15px;color:#073450;}
#savedMsg{color:#064E3B;font-weight:600;text-align:center;margin-bottom:15px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
    <h1>Exam</h1>
    <div id="timer">Loading timer...</div>
    <div id="error"></div>
    <div id="savedMsg"></div>
    <div id="exam-container">Loading questions...</div>
    <button id="next-btn">Next</button>
    <div id="score"></div>
</div>

<script>
const SUPABASE_URL='https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const params=new URLSearchParams(window.location.search);
const EXAM_ID=params.get('exam_id');
let student=JSON.parse(localStorage.getItem('currentUserProfile'));
let questions=[],duration=0,timerInterval;
let currentPage=0;
const pageSize=3;
if(!student){ window.location.href='exam_login.html'; }

async function initExam(){
    try{
        const { data: examData, error: examError } = await sb.from('exams_with_courses').select('*').eq('id',EXAM_ID).maybeSingle();
        if(examError || !examData){ document.getElementById('error').innerText='Exam not found'; return; }
        duration = examData.duration_minutes || 30;

        const { data: qData, error: qError } = await sb.from('questions').select('*').eq('exam_id',EXAM_ID);
        if(qError || !qData || qData.length===0){ document.getElementById('exam-container').innerText='No questions found'; return; }
        questions=qData;

        startTimer(duration*60);
        renderPage();
        lockDown();

    }catch(err){ console.error(err); document.getElementById('error').innerText='Error loading exam.'; }
}

function renderPage(){
    const container=document.getElementById('exam-container');
    container.innerHTML='';
    document.getElementById('savedMsg').innerText='';
    const start=currentPage*pageSize;
    const end=Math.min(start+pageSize,questions.length);
    for(let idx=start;idx<end;idx++){
        const q=questions[idx];
        const div=document.createElement('div');
        div.className='question';
        div.innerHTML=`<p><strong>Q${idx+1}:</strong> ${q.question}</p>`;
        const ul=document.createElement('ul'); ul.className='options';
        const opts=Array.isArray(q.options)?q.options:JSON.parse(q.options);
        opts.forEach(opt=>{
            const li=document.createElement('li');
            li.innerHTML=`<label><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label>`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
    }
    if((currentPage+1)*pageSize >= questions.length){
        document.getElementById('next-btn').innerText='Submit Exam';
    } else{
        document.getElementById('next-btn').innerText='Next';
    }
}

async function saveAnswers(){
    const start=currentPage*pageSize;
    const end=Math.min(start+pageSize,questions.length);
    let answers=[];
    for(let idx=start;idx<end;idx++){
        const q=questions[idx];
        const selected=document.querySelector(`input[name="q${q.id}"]:checked`);
        answers.push({question_id:q.id,answer:selected?selected.value:null});
    }
    try{
        for(const a of answers){
            const existing=await sb.from('exam_grades').select('*').eq('student_id',student.user_id).eq('exam_id',EXAM_ID).maybeSingle();
            if(existing.data){
                await sb.from('exam_grades').update({marks:a.answer===questions.find(q=>q.id===a.question_id).correct_answer?1:0}).eq('student_id',student.user_id).eq('exam_id',EXAM_ID);
            } else{
                await sb.from('exam_grades').insert([{student_id:student.user_id, exam_id:EXAM_ID, marks:a.answer===questions.find(q=>q.id===a.question_id).correct_answer?1:0, graded_at:new Date()}]);
            }
        }
        document.getElementById('savedMsg').innerText='Answer Saved!';
    }catch(err){ console.error(err); document.getElementById('error').innerText='Error saving answers.'; }
}

async function nextPage(){
    await saveAnswers();
    if((currentPage+1)*pageSize >= questions.length){
        submitExam();
    } else{
        currentPage++;
        renderPage();
    }
}

function startTimer(seconds){
    const timerEl=document.getElementById('timer');
    function updateTimer(){
        const m=Math.floor(seconds/60), s=seconds%60;
        timerEl.innerText=`Time Remaining: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(seconds-- <=0){ submitExam(); clearInterval(timerInterval); }
    }
    updateTimer();
    timerInterval=setInterval(updateTimer,1000);
}

async function submitExam(){
    clearInterval(timerInterval);
    let totalScore=0;
    const { data: saved, error } = await sb.from('exam_grades').select('*').eq('student_id',student.user_id).eq('exam_id',EXAM_ID);
    if(saved && saved.length>0){
        saved.forEach(s=>totalScore+=s.marks||0);
    }
    document.getElementById('score').innerText=`Your Score: ${totalScore} / ${questions.length}`;
    document.getElementById('next-btn').disabled=true;
}

function lockDown(){
    // Full screen
    document.documentElement.requestFullscreen?.();
    // Disable context menu
    document.addEventListener('contextmenu', e=>e.preventDefault());
    // Disable copy/paste
    document.addEventListener('copy', e=>e.preventDefault());
    document.addEventListener('cut', e=>e.preventDefault());
    document.addEventListener('paste', e=>e.preventDefault());
    // Warn before leaving page
    window.addEventListener('beforeunload', e=>{ e.preventDefault(); e.returnValue=''; submitExam(); });
    // Detect tab change
    document.addEventListener('visibilitychange', ()=>{
        if(document.hidden) submitExam();
    });
}

document.getElementById('next-btn').addEventListener('click', nextPage);
window.addEventListener('DOMContentLoaded', initExam);
</script>
</body>
</html>
