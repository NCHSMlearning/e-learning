<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mental Health & Psychiatry CAT I - Exam Portal</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">

<link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"></noscript>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
    --nchsm-blue-dark: #073450;
    --nchsm-green: #38A169;
    --nchsm-green-hover: #2F855A;
    --background: #FFFFFF;
    --page-bg: #F8F9FA;
    --shadow-light: rgba(10,61,98,0.05);
    --shadow-dark: rgba(10,61,98,0.15);
    --input-border: #DDE1E6;
    --text-muted: #6C757D;
    --focus-ring: 0 0 0 4px rgba(56,161,105,0.2);
}

body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--page-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
}

.container {
    background: var(--background);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 10px 30px var(--shadow-dark), 0 3px 10px var(--shadow-light);
    width: 100%;
    max-width: 900px;
    text-align: left;
    border: 1px solid #f1f1f1;
}

h1 {
    text-align: center;
    color: var(--nchsm-blue-dark);
    margin-bottom: 10px;
}

#timer {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--nchsm-green);
    margin-bottom: 20px;
}

.question { margin-bottom: 25px; }
.options { list-style:none; padding:0; }
.options li { margin: 8px 0; }
input[type="radio"] { margin-right: 8px; }
button {
    padding: 12px 25px;
    background: var(--nchsm-green);
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 5px 15px rgba(56,161,105,0.4);
}
button:hover {
    background: var(--nchsm-green-hover);
    transform: translateY(-1px);
    box-shadow: 0 7px 20px rgba(56,161,105,0.5);
}
button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

#error { color: #EF4444; font-weight: 600; margin-bottom:15px; text-align:center;}
#score { margin-top:20px; font-size:1.2rem; font-weight:600; color: var(--nchsm-green); }
</style>
</head>
<body>

<div class="container">
    <h1>MENTAL HEALTH & PSYCHIATRY CAT I</h1>
    <div id="timer">Time Remaining: 00:00</div>
    <div id="error"></div>
    <div id="exam-container">Loading questions...</div>
    <button id="submit-btn">Submit Exam</button>
    <div id="score"></div>
</div>

<script>
const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const EXAM_ID = 27; // replace with your exam ID
let studentProfile = JSON.parse(localStorage.getItem('currentUserProfile'));
let questions = [];
let timerDuration = 15 * 60; // 15 minutes in seconds
let timerInterval = null;

if(!studentProfile){
    document.getElementById('error').innerText = 'No logged-in user found. Please login first.';
    document.getElementById('exam-container').innerHTML = '';
    document.getElementById('submit-btn').disabled = true;
}

// ---------------- Load Exam ----------------
async function loadExam(){
    try {
        // Check if student already submitted
        const { data: existingResult } = await sb.from('results').select('*')
            .eq('student_id', studentProfile.user_id)
            .eq('exam_id', EXAM_ID)
            .maybeSingle();
        if(existingResult){
            document.getElementById('exam-container').innerHTML = `You have already submitted this exam. Your score: ${existingResult.score}`;
            document.getElementById('submit-btn').disabled = true;
            return;
        }

        // Load questions
        const { data, error } = await sb.from('questions')
            .select('*')
            .eq('exam_id', EXAM_ID);
        if(error) throw error;

        if(!data || data.length===0){
            document.getElementById('exam-container').innerHTML = 'No questions found for this exam.';
            document.getElementById('submit-btn').disabled = true;
            return;
        }

        questions = data;
        renderQuestions();
        startTimer();

    } catch(err){
        console.error(err);
        document.getElementById('error').innerText = 'Error loading exam.';
    }
}

function renderQuestions(){
    const container = document.getElementById('exam-container');
    container.innerHTML = '';
    questions.forEach((q, idx)=>{
        const div = document.createElement('div');
        div.className = 'question';
        div.innerHTML = `<p><strong>Q${idx+1}:</strong> ${q.question}</p>`;
        const ul = document.createElement('ul');
        ul.className = 'options';
        const opts = Array.isArray(q.options) ? q.options : JSON.parse(q.options);
        opts.forEach(opt=>{
            const li = document.createElement('li');
            li.innerHTML = `<label><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label>`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
    });
}

// ---------------- Timer ----------------
function startTimer(){
    updateTimerDisplay();
    timerInterval = setInterval(()=>{
        timerDuration--;
        updateTimerDisplay();
        if(timerDuration <= 0){
            clearInterval(timerInterval);
            submitExam(); // auto-submit
        }
    }, 1000);
}

function updateTimerDisplay(){
    const minutes = String(Math.floor(timerDuration/60)).padStart(2,'0');
    const seconds = String(timerDuration%60).padStart(2,'0');
    document.getElementById('timer').innerText = `Time Remaining: ${minutes}:${seconds}`;
}

// ---------------- Submit Exam ----------------
async function submitExam(){
    if(questions.length===0) return;

    // Disable button
    document.getElementById('submit-btn').disabled = true;
    clearInterval(timerInterval);

    const answers = {};
    questions.forEach(q=>{
        const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
        answers[q.id] = selected ? selected.value : null;
    });

    let score = 0;
    questions.forEach(q=>{
        if(answers[q.id] === q.correct_answer) score += q.marks || 1;
    });

    document.getElementById('score').textContent = `Your Score: ${score} / ${questions.length}`;

    try{
        const { error } = await sb.from('results').insert([{
            student_id: studentProfile.user_id,
            exam_id: EXAM_ID,
            answers,
            score,
            submitted_at: new Date()
        }]);
        if(error){
            console.error('Error saving result:', error);
            document.getElementById('error').innerText = 'Error saving results.';
        } else {
            console.log('Results saved successfully!');
        }
    } catch(err){
        console.error('Unexpected error:', err);
        document.getElementById('error').innerText = 'Unexpected error saving results.';
    }
}

document.getElementById('submit-btn').addEventListener('click', submitExam);

// ---------------- Initialize ----------------
window.addEventListener('DOMContentLoaded', loadExam);
</script>
</body>
</html>
