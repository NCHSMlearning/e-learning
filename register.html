<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NCHSM Digital Portal | Registration</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32" />

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet" />

<style>
  /* --- DARK MODE/VAPORWAVE VARIABLES --- */
  :root {
    --primary: #00ffc8; /* Neon Green/Cyan */
    --primary-hover: #00e0b0;
    --secondary: #95a5a6; /* Light gray text */
    --bg-dark: #1f2937; /* Dark Slate Background */
    --card-dark: #2c3e50; /* Slightly lighter card surface */
    --white: #ecf0f1; /* Off-white for readability */
    --error: #e74c3c; /* Red */
    --success: var(--primary); 
    --shadow-glow: 0 0 15px rgba(0, 255, 200, 0.4); /* Neon glow effect */
    --input-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
  }
  
  /* --- Global Reset and Body Styling --- */
  * { box-sizing: border-box; }
  body { 
    margin: 0; 
    font-family: 'Montserrat', sans-serif; 
    background: var(--bg-dark); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    min-height: 100vh; 
    padding: 20px; 
    color: var(--white);
  }

  /* --- Container (The Dark Card) --- */
  .container { 
    background: var(--card-dark); 
    padding: 40px 50px; 
    border-radius: 20px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.5), var(--shadow-glow); /* Deep shadow + neon glow */
    max-width: 500px; 
    width: 100%; 
    text-align: center; 
    animation: slideIn 0.6s cubic-bezier(0.2, 0.8, 0.4, 1) forwards;
    border: 1px solid rgba(0, 255, 200, 0.2); /* Subtle neon border */
  }
  @keyframes slideIn { 
    from { opacity: 0; transform: translateY(30px) scale(0.95); } 
    to { opacity: 1; transform: translateY(0) scale(1); } 
  }

  /* --- Header Content --- */
  img { 
    width: 80px; 
    margin-bottom: 20px; 
    filter: drop-shadow(0 0 8px var(--primary)); /* Neon logo glow */
  }
  h2 { 
    font-weight: 800; 
    font-size: 2.2rem;
    color: var(--primary); 
    text-shadow: 0 0 5px rgba(0, 255, 200, 0.8);
    margin-bottom: 5px; 
  }
  p.subtitle { 
    color: var(--secondary); 
    margin-bottom: 30px; 
    font-weight: 400;
  }

  /* --- Form and Inputs --- */
  form { 
    display: flex; 
    flex-direction: column; 
    gap: 18px; 
    text-align: left; 
  }
  label { 
    font-weight: 600; 
    font-size: 0.95rem; 
    color: var(--white); 
    display: block;
    margin-bottom: 5px;
  }
  input, select { 
    padding: 14px 18px; 
    border: 1px solid rgba(0, 255, 200, 0.1); 
    border-radius: 10px; 
    font-size: 1rem; 
    width: 100%; 
    background: #1a232f; /* Darker input field */
    color: var(--white);
    box-shadow: var(--input-shadow);
    transition: all 0.3s ease;
    appearance: none;
  }
  select {
    /* Custom arrow for dark mode */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2395a5a6'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
  }
  input:focus, select:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(0, 255, 200, 0.4), var(--input-shadow); 
    outline: none; 
    background: #151e29;
  }

  /* --- Button --- */
  button { 
    background: var(--primary); 
    color: var(--bg-dark); /* Dark text on bright button */
    border: none; 
    border-radius: 10px; 
    padding: 16px; 
    font-weight: 700; 
    font-size: 1.1rem; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    margin-top: 20px; 
    box-shadow: 0 4px 15px rgba(0, 255, 200, 0.4);
    letter-spacing: 1px;
  }
  button:hover { 
    background: var(--primary-hover); 
    transform: translateY(-3px) scale(1.02); 
    box-shadow: 0 6px 20px rgba(0, 255, 200, 0.6);
  }
  button:active {
    transform: translateY(-1px);
  }
  button:disabled { 
    background: #566573; 
    color: #ccc;
    box-shadow: none;
    cursor: not-allowed; 
    transform: none;
  }

  /* --- Messages and Links --- */
  .message { 
    text-align: center; 
    margin-top: 20px; 
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 600; 
  }
  .error { 
    color: var(--error); 
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid var(--error);
  }
  .success { 
    color: var(--success); 
    background: rgba(0, 255, 200, 0.1);
    border: 1px solid var(--primary);
  }
  .login-link { 
    margin-top: 30px; 
    color: var(--secondary); 
    font-size: 1rem; 
  }
  .login-link a { 
    color: var(--primary); 
    text-decoration: none; 
    font-weight: 700;
    text-shadow: 0 0 3px rgba(0, 255, 200, 0.5);
    transition: all 0.2s;
  }
  .login-link a:hover { 
    color: var(--primary-hover);
    text-decoration: underline; 
  }

  /* Dynamic Fields Animation (Smooth Show/Hide) */
  #student-fields, #lecturer-fields {
    display: grid; 
    grid-template-columns: 1fr;
    gap: 18px;
    transition: all 0.4s ease-in-out;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    padding-top: 0;
    margin-top: -10px; /* Adjust spacing when collapsed */
  }
  .visible-fields {
    max-height: 300px !important; 
    opacity: 1 !important;
    padding-top: 0 !important;
    margin-top: 0 !important; 
  }

  /* Simple Loading Spinner for Button */
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
  .spinner { 
    display: inline-block; 
    width: 1.1em; 
    height: 1.1em; 
    border: 3px solid rgba(255, 255, 255, 0.2); 
    border-radius: 50%; 
    border-top-color: var(--card-dark); /* Contrast spinner color */
    animation: spin 0.8s linear infinite; 
    margin-right: 8px; 
    vertical-align: middle; 
  }
</style>
</head>
<body>
<div class="container">
  <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo" />
  <h2>PORTAL REGISTRATION</h2>
  <p class="subtitle">Secure your NCHSM account in the digital realm.</p>

  <form id="register-form">
    <div class="input-group">
      <label for="role">Register Access Level</label>
      <select id="role" name="role" required>
        <option value="">-- Select Role --</option>
        <option value="student">Student</option>
        <option value="lecturer">Lecturer</option>
      </select>
    </div>

    <div class="input-group">
      <label for="full_name">Full Name</label>
      <input type="text" id="full_name" name="full_name" placeholder="Enter your full name" required />
    </div>

    <div class="input-group">
      <label for="email">Email Address</label>
      <input type="email" id="email" name="email" placeholder="email@nchsm.ac.ke" required />
    </div>

        <div id="student-fields">
      <div class="input-group">
        <label for="student_id_number">Admission / Student ID</label>
        <input type="text" id="student_id_number" name="student_id_number" placeholder="e.g. NCHSM2025/001" />
      </div>
      <div class="input-group">
        <label for="program_type">Program</label>
        <select id="program_type" name="program_type">
          <option value="">-- Select Your Program --</option>
          <option value="KRCHN">KRCHN Nursing</option>
          <option value="TIVET">TIVET Program</option>
        </select>
      </div>
    </div>

        <div id="lecturer-fields">
      <div class="input-group">
        <label for="staff_id">Staff ID</label>
        <input type="text" id="staff_id" name="staff_id" placeholder="e.g. NCHSM-LECT-001" />
      </div>
      <div class="input-group">
        <label for="department">Department</label>
        <select id="department" name="department">
          <option value="">-- Select Department --</option>
          <option value="Nursing">Nursing</option>
          <option value="TIVET">TIVET</option>
        </select>
      </div>
    </div>

    <div class="input-group">
      <label for="phone">Phone Number</label>
      <input type="tel" id="phone" name="phone" placeholder="07XXXXXXXX" required />
    </div>

    <div class="input-group">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" placeholder="Create secure password" required />
    </div>

    <div class="input-group">
      <label for="confirm_password">Confirm Password</label>
      <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm password" required />
    </div>

    <button type="submit" id="register-btn">ACCESS REGISTRATION PROTOCOL</button>
    <p id="message" class="message"></p>
  </form>

  <div class="login-link">
    Already have an account? <a href="login.html">Login to System</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // --- JavaScript Logic (Refined for UX and new structure) ---

  // Remove .html from URL if present
  if (window.location.pathname.endsWith('.html')) {
    const cleanPath = window.location.pathname.replace(/\.html$/, '');
    window.history.replaceState({}, '', cleanPath);
  }

  const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const roleSelect = document.getElementById('role');
  const studentFieldsDiv = document.getElementById('student-fields');
  const lecturerFieldsDiv = document.getElementById('lecturer-fields');
  const studentInputs = studentFieldsDiv.querySelectorAll('input, select');
  const lecturerInputs = lecturerFieldsDiv.querySelectorAll('input, select');

  const form = document.getElementById('register-form');
  const message = document.getElementById('message');
  const registerBtn = document.getElementById('register-btn');

  // MODIFIED: Use CSS classes for smooth transition
  const manageRequiredFields = (role) => {
    const isStudent = role === 'student';
    const isLecturer = role === 'lecturer';

    // Toggle CSS class for smooth show/hide
    studentFieldsDiv.classList.toggle('visible-fields', isStudent);
    lecturerFieldsDiv.classList.toggle('visible-fields', isLecturer);

    // Manage 'required' attribute
    studentInputs.forEach(input => input.required = isStudent);
    lecturerInputs.forEach(input => input.required = isLecturer);

    // Reset values of hidden fields to prevent accidental submission of old data
    if (!isStudent) studentInputs.forEach(input => input.value = input.tagName === 'SELECT' ? '' : '');
    if (!isLecturer) lecturerInputs.forEach(input => input.value = input.tagName === 'SELECT' ? '' : '');
  };

  roleSelect.addEventListener('change', () => manageRequiredFields(roleSelect.value));
  manageRequiredFields(roleSelect.value); // Initial call

  // Supabase Submission Logic
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    message.textContent = '';
    message.className = 'message';
    registerBtn.disabled = true;
    registerBtn.innerHTML = '<span class="spinner"></span> ACCESSING DATABASE...'; // Modern loading text

    const role = roleSelect.value;
    const password = document.getElementById('password').value.trim();
    const confirmPassword = document.getElementById('confirm_password').value.trim();
    const email = document.getElementById('email').value.trim();

    if (password !== confirmPassword) {
      message.textContent = '❌ PASSWORD MISMATCH. Verification failed.';
      message.classList.add('error');
      registerBtn.disabled = false;
      registerBtn.innerHTML = 'ACCESS REGISTRATION PROTOCOL';
      return;
    }

    // Gather data...
    const userMetadata = {
      full_name: document.getElementById('full_name').value.trim(),
      role,
      phone: document.getElementById('phone').value.trim(),
      admission_number: role === 'student' ? document.getElementById('student_id_number').value.trim() : null,
      course: role === 'student' ? document.getElementById('program_type').value : null,
      staff_id: role === 'lecturer' ? document.getElementById('staff_id').value.trim() : null,
      department: role === 'lecturer' ? document.getElementById('department').value : null
    };

    try {
      const { error } = await sb.auth.signUp({
        email,
        password,
        options: { data: userMetadata }
      });
  
      if (error) {
        message.textContent = `❌ REGISTRATION ERROR: ${error.message}`;
        message.classList.add('error');
      } else {
        message.textContent = '✅ REGISTRATION SUCCESSFUL! Please check your email to **VERIFY ACCESS**. Await system admin approval.';
        message.classList.add('success');
        form.reset();
        manageRequiredFields(''); // Hide fields after successful reset
      }
    } catch (err) {
      message.textContent = '❌ CRITICAL SYSTEM ERROR. Please contact support.';
      message.classList.add('error');
    }

    registerBtn.disabled = false;
    registerBtn.innerHTML = 'ACCESS REGISTRATION PROTOCOL';
  });
</script>
</body>
</html>
