<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password - NCHSM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --primary-color: #4C1D95;
    --primary-dark: #3B0E7A;
    --success-color: #10B981;
    --error-color: #EF4444;
    --warning-color: #F59E0B;
    --text-color: #6B7280;
    --border-color: #CBD5E1;
    --bg-color: #F1F5F9;
    --white: #fff;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-color); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    min-height: 100vh; 
    margin: 0; 
    line-height: 1.5;
  }
  
  .container { 
    background: var(--white); 
    padding: 2rem; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    max-width: 400px; 
    width: 100%; 
    text-align: center; 
    border-top: 5px solid var(--primary-color);
  }
  
  h2, h1 { 
    color: var(--primary-color); 
    margin-bottom: 0.5rem; 
  }
  
  p { 
    color: var(--text-color); 
    margin-bottom: 1.5rem;
  }
  
  input, button { 
    width: 100%; 
    padding: 12px; 
    margin: 10px 0; 
    border-radius: 6px; 
    font-size: 1rem; 
    box-sizing: border-box; 
    transition: all 0.2s ease;
  }
  
  input { 
    border: 1px solid var(--border-color);
    outline: none;
  }
  
  input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.1);
  }
  
  button { 
    background: var(--primary-color); 
    color: var(--white); 
    border: none; 
    cursor: pointer; 
    font-weight: 600; 
    margin-top: 1rem;
  }
  
  button:hover { 
    background: var(--primary-dark); 
  }
  
  button:disabled {
    background: #9CA3AF;
    cursor: not-allowed;
  }
  
  #status, #reset-status { 
    margin-top: 1rem; 
    font-weight: 600; 
    min-height: 22px;
    border-radius: 4px;
    padding: 8px 12px;
  }
  
  .success { 
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
  }
  
  .error { 
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
  }
  
  .warning { 
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
  }
  
  .info { 
    background-color: rgba(76, 29, 149, 0.1);
    color: var(--primary-color);
  }
  
  .password-strength {
    text-align: left;
    margin: 5px 0;
    font-size: 0.85rem;
  }
  
  .strength-meter {
    height: 5px;
    border-radius: 5px;
    margin: 5px 0 10px;
    background: #E5E7EB;
    overflow: hidden;
  }
  
  .strength-meter-fill {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background 0.3s ease;
  }
  
  .password-requirements {
    text-align: left;
    font-size: 0.85rem;
    margin: 10px 0;
  }
  
  .requirement {
    display: flex;
    align-items: center;
    margin: 5px 0;
    color: var(--text-color);
  }
  
  .requirement.met {
    color: var(--success-color);
  }
  
  .requirement-icon {
    margin-right: 8px;
    font-size: 0.9rem;
  }
  
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
    vertical-align: middle;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .back-link {
    display: inline-block;
    margin-top: 1rem;
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
  }
  
  .back-link:hover {
    text-decoration: underline;
  }
  
  .hidden {
    display: none;
  }
</style>
</head>
<body>

<!-- REQUEST RESET EMAIL -->
<div class="container" id="email-container">
  <h2>Forgot Your Password?</h2>
  <p>Enter your email and we'll send you a reset link.</p>
  <input type="email" id="reset-email" placeholder="you@example.com" required>
  <button id="send-reset-btn">
    <span class="btn-text">Send Reset Email</span>
  </button>
  <div id="status"></div>
  <a href="login.html" class="back-link">Back to Login</a>
</div>

<!-- SET NEW PASSWORD -->
<div class="container" id="reset-container" style="display:none;">
  <h1>Create a New Password</h1>
  <input type="password" id="new-password" placeholder="New Password" required minlength="8">
  <div class="strength-meter">
    <div class="strength-meter-fill" id="strength-meter-fill"></div>
  </div>
  <div class="password-strength" id="password-strength-text">Password strength: Very weak</div>
  
  <div class="password-requirements">
    <div class="requirement" id="length-req">
      <span class="requirement-icon">❌</span>
      <span>At least 8 characters</span>
    </div>
    <div class="requirement" id="lowercase-req">
      <span class="requirement-icon">❌</span>
      <span>Contains lowercase letter</span>
    </div>
    <div class="requirement" id="uppercase-req">
      <span class="requirement-icon">❌</span>
      <span>Contains uppercase letter</span>
    </div>
    <div class="requirement" id="number-req">
      <span class="requirement-icon">❌</span>
      <span>Contains number</span>
    </div>
    <div class="requirement" id="special-req">
      <span class="requirement-icon">❌</span>
      <span>Contains special character</span>
    </div>
  </div>
  
  <input type="password" id="confirm-password" placeholder="Confirm Password" required minlength="8">
  <div id="password-match" class="password-strength"></div>
  
  <button id="update-btn" disabled>
    <span class="btn-text">Update Password</span>
  </button>
  <div id="reset-status"></div>
  <a href="login.html" class="back-link">Back to Login</a>
</div>

<script>
const SUPABASE_URL = "https://lwhtjozfsmbyihenfunw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const emailContainer = document.getElementById('email-container');
const resetContainer = document.getElementById('reset-container');
const sendResetBtn = document.getElementById('send-reset-btn');
const updateBtn = document.getElementById('update-btn');

// Password requirements
const requirements = {
  length: false,
  lowercase: false,
  uppercase: false,
  number: false,
  special: false
};

// 1. Parse hash parameters from URL
function parseHashParameters() {
    const hash = window.location.hash.substring(1); // Remove the #
    const params = new URLSearchParams(hash);
    const result = {};
    
    for (const [key, value] of params) {
        result[key] = value;
    }
    
    return result;
}

// 2. Check if this is a password reset callback
async function initResetFlow() {
    const hashParams = parseHashParameters();
    const type = hashParams.type;
    const access_token = hashParams.access_token;
    const refresh_token = hashParams.refresh_token;
    
    console.log('Hash params:', hashParams); // Debug log
    
    // If this is a password reset callback with tokens
    if (type === 'recovery' && access_token) {
        try {
            showStatus('info', 'Verifying your reset link...', 'status');
            
            // Set the session using the tokens from hash
            const { data, error } = await sb.auth.setSession({
                access_token: access_token,
                refresh_token: refresh_token
            });
            
            if (error) {
                console.error('Session error:', error);
                throw error;
            }
            
            // Verify we have a valid session and user
            const { data: { user }, error: userError } = await sb.auth.getUser();
            
            if (userError || !user) {
                throw new Error('Invalid user session');
            }
            
            console.log('User authenticated:', user.email); // Debug log
            
            // Session established -> show password form
            emailContainer.style.display = 'none';
            resetContainer.style.display = 'block';
            showStatus('success', `Reset link verified for ${user.email}. Please set your new password.`, 'reset-status');
            
            // Clear the URL hash to prevent re-triggering
            window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
            
        } catch (error) {
            console.error('Reset flow error:', error);
            showStatus('error', 'Invalid or expired reset link. Please request a new one.', 'status');
        }
    } else {
        // Check for query parameters as fallback (standard Supabase reset)
        const urlParams = new URLSearchParams(window.location.search);
        const queryType = urlParams.get('type');
        const token = urlParams.get('token');
        
        if (queryType === 'recovery' && token) {
            await handleQueryParamReset(token);
        }
    }
}

// 3. Handle traditional query parameter reset (fallback)
async function handleQueryParamReset(token) {
    try {
        showStatus('info', 'Verifying your reset link...', 'status');
        
        const { error } = await sb.auth.setSession({
            access_token: token,
            refresh_token: ''
        });
        
        if (error) throw error;
        
        const { data: { user } } = await sb.auth.getUser();
        if (!user) throw new Error('Invalid session');
        
        emailContainer.style.display = 'none';
        resetContainer.style.display = 'block';
        showStatus('success', `Reset link verified for ${user.email}. Please set your new password.`, 'reset-status');
        
    } catch (error) {
        console.error('Query param reset error:', error);
        showStatus('error', 'Invalid or expired reset link.', 'status');
    }
}

// 4. Show status message with appropriate styling
function showStatus(type, message, elementId) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = type;
}

// 5. Set button loading state
function setButtonLoading(button, isLoading) {
    const btnText = button.querySelector('.btn-text');
    if (isLoading) {
        button.disabled = true;
        const loadingSpan = document.createElement('span');
        loadingSpan.className = 'loading';
        button.insertBefore(loadingSpan, btnText);
        btnText.textContent = 'Processing...';
    } else {
        button.disabled = false;
        const loadingSpan = button.querySelector('.loading');
        if (loadingSpan) {
            loadingSpan.remove();
        }
        // Reset button text based on button type
        if (button.id === 'send-reset-btn') {
            btnText.textContent = 'Send Reset Email';
        } else if (button.id === 'update-btn') {
            btnText.textContent = 'Update Password';
        }
    }
}

// 6. Send reset email (updated redirect URL)
async function sendResetEmail() {
    const email = document.getElementById('reset-email').value.trim();
    
    if (!email) {
        showStatus('error', 'Please enter your email address.', 'status');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showStatus('error', 'Please enter a valid email address.', 'status');
        return;
    }
    
    setButtonLoading(sendResetBtn, true);
    showStatus('info', 'Sending reset link...', 'status');
    
    try {
        // Use the current page URL as redirect, but Supabase will add the hash
        const { error } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href.split('#')[0] // Remove existing hash
        });

        if (error) {
            throw error;
        }
        
        showStatus('success', 'Check your inbox for the reset link. It may take a few minutes to arrive.', 'status');
        
    } catch (error) {
        console.error('Reset email error:', error);
        // Security: Don't reveal if email exists
        showStatus('success', 'If an account with that email exists, you will receive a password reset link.', 'status');
    } finally {
        setButtonLoading(sendResetBtn, false);
    }
}

// 7. Validate password strength
function checkPasswordStrength(password) {
    // Reset requirements
    Object.keys(requirements).forEach(key => {
        requirements[key] = false;
    });
    
    // Check length
    requirements.length = password.length >= 8;
    
    // Check for lowercase
    requirements.lowercase = /[a-z]/.test(password);
    
    // Check for uppercase
    requirements.uppercase = /[A-Z]/.test(password);
    
    // Check for numbers
    requirements.number = /\d/.test(password);
    
    // Check for special characters
    requirements.special = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
    
    // Update UI
    updateRequirementsUI();
    
    // Calculate strength score (0-5)
    const score = Object.values(requirements).filter(Boolean).length;
    
    // Update strength meter
    const strengthMeter = document.getElementById('strength-meter-fill');
    const strengthText = document.getElementById('password-strength-text');
    
    let strengthPercentage = (score / 5) * 100;
    let strengthLabel = '';
    let strengthColor = '';
    
    if (score <= 1) {
        strengthLabel = 'Very weak';
        strengthColor = '#EF4444'; // red
    } else if (score <= 2) {
        strengthLabel = 'Weak';
        strengthColor = '#F59E0B'; // amber
    } else if (score <= 3) {
        strengthLabel = 'Fair';
        strengthColor = '#F59E0B'; // amber
    } else if (score === 4) {
        strengthLabel = 'Strong';
        strengthColor = '#10B981'; // green
    } else {
        strengthLabel = 'Very strong';
        strengthColor = '#10B981'; // green
    }
    
    strengthMeter.style.width = `${strengthPercentage}%`;
    strengthMeter.style.background = strengthColor;
    strengthText.textContent = `Password strength: ${strengthLabel}`;
    strengthText.style.color = strengthColor;
    
    return score >= 3; // Require at least "Fair" strength
}

// 8. Update requirements UI
function updateRequirementsUI() {
    const requirementIds = {
        length: 'length-req',
        lowercase: 'lowercase-req',
        uppercase: 'uppercase-req',
        number: 'number-req',
        special: 'special-req'
    };
    
    Object.keys(requirements).forEach(key => {
        const element = document.getElementById(requirementIds[key]);
        const icon = element.querySelector('.requirement-icon');
        
        if (requirements[key]) {
            element.classList.add('met');
            icon.textContent = '✅';
        } else {
            element.classList.remove('met');
            icon.textContent = '❌';
        }
    });
}

// 9. Check if passwords match
function checkPasswordMatch() {
    const password = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const matchElement = document.getElementById('password-match');
    
    if (!password || !confirmPassword) {
        matchElement.textContent = '';
        return false;
    }
    
    if (password === confirmPassword) {
        matchElement.textContent = 'Passwords match';
        matchElement.style.color = '#10B981';
        return true;
    } else {
        matchElement.textContent = 'Passwords do not match';
        matchElement.style.color = '#EF4444';
        return false;
    }
}

// 10. Enhanced password validation
function validatePasswordStrength(password) {
    const requirements = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
    };
    
    const score = Object.values(requirements).filter(Boolean).length;
    return score >= 3; // Require at least 3 out of 5 requirements
}

// 11. Validate form and enable/disable update button
function validateForm() {
    const password = document.getElementById('new-password').value;
    const isStrongEnough = checkPasswordStrength(password);
    const passwordsMatch = checkPasswordMatch();
    
    updateBtn.disabled = !(isStrongEnough && passwordsMatch);
}

// 12. Update password (with enhanced validation)
async function updatePassword() {
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    // Validation
    if (newPassword !== confirmPassword) {
        showStatus('error', 'Passwords do not match.', 'reset-status');
        return;
    }
    
    if (!validatePasswordStrength(newPassword)) {
        showStatus('error', 'Please choose a stronger password.', 'reset-status');
        return;
    }
    
    setButtonLoading(updateBtn, true);
    showStatus('info', 'Updating your password...', 'reset-status');
    
    try {
        // Verify we still have a valid session
        const { data: { user }, error: userError } = await sb.auth.getUser();
        
        if (userError || !user) {
            throw new Error('Your session has expired. Please request a new reset link.');
        }
        
        // Update the password
        const { error } = await sb.auth.updateUser({ 
            password: newPassword 
        });

        if (error) {
            throw error;
        }
        
        showStatus('success', 'Password updated successfully! Redirecting to login...', 'reset-status');
        
        // Optional: Sign out after password reset for security
        await sb.auth.signOut();
        
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        
    } catch (error) {
        console.error('Password update error:', error);
        showStatus('error', error.message || 'Failed to update password. Please try again.', 'reset-status');
    } finally {
        setButtonLoading(updateBtn, false);
    }
}

// 13. Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing reset flow...');
    initResetFlow();
});

// Event listeners
document.getElementById('send-reset-btn').addEventListener('click', sendResetEmail);
document.getElementById('update-btn').addEventListener('click', updatePassword);

// Real-time password validation
document.getElementById('new-password').addEventListener('input', validateForm);
document.getElementById('confirm-password').addEventListener('input', validateForm);

// Enter key support
document.getElementById('reset-email').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendResetEmail();
});

document.getElementById('new-password').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') updatePassword();
});

document.getElementById('confirm-password').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') updatePassword();
});
</script>

</body>
</html>
