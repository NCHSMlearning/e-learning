<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Dashboard - NCHSM</title>
<link rel="icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background:#F8F9FA; margin:0; padding:20px; }
header { text-align:center; margin-bottom:30px; }
h1 { color:#073450; }
.exam-list { max-width:800px; margin:0 auto; }
.exam-card { background:#fff; padding:20px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 20px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; }
.exam-card button { padding:10px 20px; border:none; border-radius:8px; background:#38A169; color:#fff; font-weight:600; cursor:pointer; }
.exam-card button:hover{ background:#2F855A; }
.exam-card button:disabled { background:#6B7280; cursor:not-allowed; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
    <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" width="80" alt="Logo">
    <h1>Exam Dashboard</h1>
    <p id="userInfo">Loading user info...</p>
</header>

<div class="exam-list" id="examList">Loading exams...</div>

<script>
const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentUserEmail = null;

async function loadExams() {
    try {
        // Get current user from localStorage
        currentUserId = localStorage.getItem('currentUserId');
        currentUserEmail = localStorage.getItem('studentEmail');
        
        if (!currentUserId || !currentUserEmail) {
            window.location.href = 'exam_login.html';
            return;
        }

        // Display user info
        document.getElementById('userInfo').innerHTML = 
            `Logged in as: <strong>${currentUserEmail}</strong> | 
             <button onclick="logout()" style="background:#DC2626; padding:5px 10px; border-radius:4px; color:white; border:none; cursor:pointer;">Logout</button>`;

        // Load available exams for this student
        // First get student details from consolidated table
        const { data: studentProfile, error: profileError } = await sb
            .from('consolidated_user_profiles_table')
            .select('program, block, intake_year')
            .eq('user_id', currentUserId)
            .single();

        if (profileError) {
            console.error('Error loading student profile:', profileError);
            document.getElementById('examList').innerText = 'Error loading your student profile.';
            return;
        }

        console.log('Student Profile:', studentProfile);

        // FIXED: Better query for exams
        let query = sb
            .from('exams_with_courses')
            .select('*')
            .eq('intake_year', studentProfile.intake_year)
            .eq('status', 'Upcoming');

        // Apply filters for program and block
        // Exams can be: Specific to program OR General
        // Exams can be: Specific to block OR null OR General
        query = query.or(`program_type.eq.${studentProfile.program},program_type.eq.General`);
        
        // For block: can be student's block OR null OR General
        if (studentProfile.block) {
            query = query.or(`block_term.eq.${studentProfile.block},block_term.is.null,block_term.eq.General`);
        }

        const { data: exams, error: examsError } = await query.order('exam_date', { ascending: true });

        if (examsError) {
            console.error('Error loading exams:', examsError);
            document.getElementById('examList').innerText = 'Failed to load exams.';
            return;
        }

        console.log('Available exams:', exams);

        // Also check which exams the student has already taken
        const { data: takenExams, error: takenError } = await sb
            .from('exam_grades')
            .select('exam_id')
            .eq('student_id', currentUserId)
            .eq('result_status', 'Final');

        const takenExamIds = takenExams?.map(e => e.exam_id) || [];

        const container = document.getElementById('examList');
        container.innerHTML = '';

        if (!exams || exams.length === 0) {
            container.innerHTML = '<div class="exam-card">No upcoming exams found for your program.</div>';
            return;
        }

        exams.forEach(exam => {
            const div = document.createElement('div');
            div.className = 'exam-card';
            
            // Check if exam already taken
            const isTaken = takenExamIds.includes(exam.id);
            const buttonText = isTaken ? 'View Results' : 'Start Exam';
            const buttonColor = isTaken ? '#6B7280' : '#38A169';
            
            div.innerHTML = `
                <div>
                    <strong>${exam.exam_name}</strong><br>
                    <small>Course: ${exam.course_name || 'General'}</small><br>
                    <small>Date: ${exam.exam_date} | Duration: ${exam.duration_minutes || 30} min</small><br>
                    <small>Type: ${exam.exam_type || 'EXAM'} | Program: ${exam.program_type || 'General'}</small>
                </div>
                <button onclick="${isTaken ? 'viewResults' : 'startExam'}('${exam.id}')" 
                        style="background:${buttonColor}"
                        ${isTaken ? 'disabled' : ''}>
                    ${buttonText}
                </button>
            `;
            container.appendChild(div);
        });

    } catch (err) {
        console.error('Unexpected error:', err);
        document.getElementById('examList').innerText = 'Error loading exams.';
    }
}

function startExam(examId) {
    // CRITICAL FIX: Pass user ID in the URL
    const userId = localStorage.getItem('currentUserId');
    window.location.href = `exam.html?exam_id=${examId}&user_id=${userId}`;
}

function viewResults(examId) {
    // You can implement a results viewing page here
    alert('Results viewing feature coming soon!');
}

function logout() {
    localStorage.removeItem('currentUserId');
    localStorage.removeItem('studentEmail');
    window.location.href = 'exam_login.html';
}

window.addEventListener('DOMContentLoaded', loadExams);
</script>
</body>
</html>
