<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Dashboard - NCHSM</title>
<link rel="icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background:#F8F9FA; margin:0; padding:20px; }
header { text-align:center; margin-bottom:30px; }
h1 { color:#073450; }
.exam-list { max-width:800px; margin:0 auto; }
.exam-card { background:#fff; padding:20px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 20px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; }
.exam-card button { padding:10px 20px; border:none; border-radius:8px; background:#38A169; color:#fff; font-weight:600; cursor:pointer; }
.exam-card button:hover{ background:#2F855A; }
.exam-card button:disabled { background:#6B7280; cursor:not-allowed; }
.filter-info { background:#E2E8F0; padding:10px; border-radius:8px; margin-bottom:20px; text-align:center; }
.debug-info { background:#FEF3C7; padding:10px; border-radius:8px; margin-bottom:20px; font-size:12px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
    <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" width="80" alt="Logo">
    <h1>Exam Dashboard</h1>
    <p id="userInfo">Loading user info...</p>
</header>

<div class="exam-list">
    <div id="debugInfo" class="debug-info"></div>
    <div id="filterInfo" class="filter-info"></div>
    <div id="examList">Loading exams...</div>
</div>

<script>
const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentUserEmail = null;

// Debug function to show all localStorage
function showLocalStorageDebug() {
    let debugHTML = '<strong>DEBUG INFO:</strong><br>';
    
    debugHTML += `currentUserId: <code>${localStorage.getItem('currentUserId') || 'NULL'}</code><br>`;
    debugHTML += `studentEmail: <code>${localStorage.getItem('studentEmail') || 'NULL'}</code><br>`;
    
    debugHTML += 'All localStorage items:<br>';
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        debugHTML += `<code>${key}</code>: ${localStorage.getItem(key)}<br>`;
    }
    
    return debugHTML;
}

async function loadExams() {
    try {
        // Show debug info immediately
        document.getElementById('debugInfo').innerHTML = showLocalStorageDebug();
        
        // Get current user from localStorage
        currentUserId = localStorage.getItem('currentUserId');
        currentUserEmail = localStorage.getItem('studentEmail');
        
        console.log('=== DASHBOARD LOADED ===');
        console.log('localStorage currentUserId:', currentUserId);
        console.log('localStorage studentEmail:', currentUserEmail);
        console.log('sessionStorage currentUserId:', sessionStorage.getItem('currentUserId'));
        
        if (!currentUserId || currentUserId === 'null') {
            console.error('ERROR: currentUserId is null or empty!');
            
            // Try to get from sessionStorage as backup
            const sessionUserId = sessionStorage.getItem('currentUserId');
            if (sessionUserId && sessionUserId !== 'null') {
                console.log('Found user ID in sessionStorage, restoring...');
                localStorage.setItem('currentUserId', sessionUserId);
                localStorage.setItem('studentEmail', sessionStorage.getItem('studentEmail') || '');
                currentUserId = sessionUserId;
                currentUserEmail = sessionStorage.getItem('studentEmail');
            } else {
                console.log('No user ID found, redirecting to login...');
                window.location.href = 'exam_login.html';
                return;
            }
        }

        if (!currentUserEmail || currentUserEmail === 'null') {
            console.error('ERROR: studentEmail is null or empty!');
            
            // Try to get from sessionStorage
            const sessionEmail = sessionStorage.getItem('studentEmail');
            if (sessionEmail) {
                localStorage.setItem('studentEmail', sessionEmail);
                currentUserEmail = sessionEmail;
            }
        }

        // Display user info
        document.getElementById('userInfo').innerHTML = 
            `Logged in as: <strong>${currentUserEmail}</strong> | 
             <button onclick="logout()" style="background:#DC2626; padding:5px 10px; border-radius:4px; color:white; border:none; cursor:pointer;">Logout</button>`;

        // Load student details
        const { data: studentProfile, error: profileError } = await sb
            .from('consolidated_user_profiles_table')
            .select('program, block, intake_year')
            .eq('user_id', currentUserId)
            .single();

        if (profileError) {
            console.error('Error loading student profile:', profileError);
            document.getElementById('examList').innerHTML = 
                `<div class="exam-card">
                    <strong>Error loading your student profile.</strong><br>
                    <small>User ID: ${currentUserId}</small><br>
                    <small>Error: ${profileError.message}</small>
                </div>`;
            return;
        }

        // Show filter info
        document.getElementById('filterInfo').innerHTML = 
            `Showing exams for: <strong>${studentProfile.program}</strong> | 
             Block: <strong>${studentProfile.block || 'Any'}</strong> | 
             Intake: <strong>${studentProfile.intake_year}</strong>`;

        console.log('Student Profile:', studentProfile);
        console.log('Student intake_year type:', typeof studentProfile.intake_year);

        // Get ALL upcoming exams
        const { data: exams, error: examsError } = await sb
            .from('exams_with_courses')
            .select('*')
            .eq('status', 'Upcoming')
            .order('exam_date', { ascending: true });

        if (examsError) {
            console.error('Error loading exams:', examsError);
            document.getElementById('examList').innerHTML = 
                `<div class="exam-card">
                    <strong>Failed to load exams.</strong><br>
                    <small>Error: ${examsError.message}</small>
                </div>`;
            return;
        }

        console.log('All upcoming exams:', exams);
        
        // DEBUG: Check exam 44 specifically
        const exam44 = exams.find(e => e.id === 44);
        if (exam44) {
            console.log('=== DEBUG EXAM 44 ===');
            console.log('Exam 44 properties:', {
                id: exam44.id,
                name: exam44.exam_name,
                intake_year: exam44.intake_year,
                intake_year_type: typeof exam44.intake_year,
                program_type: exam44.program_type,
                block_term: exam44.block_term,
                status: exam44.status
            });
            
            console.log('Direct comparison (exam44.intake_year === studentProfile.intake_year):', 
                exam44.intake_year === studentProfile.intake_year);
            console.log('String comparison:', 
                String(exam44.intake_year) === String(studentProfile.intake_year));
        }

        // FIXED: Filter exams with proper data type handling
        const filteredExams = exams.filter(exam => {
            console.log(`\nChecking: ${exam.exam_name}`);
            
            // 1. Convert intake years to string for reliable comparison
            const examYear = String(exam.intake_year || '');
            const studentYear = String(studentProfile.intake_year || '');
            
            console.log(`  intake_year: exam=${examYear} student=${studentYear}`);
            
            if (examYear !== studentYear) {
                console.log(`  ❌ intake_year mismatch`);
                return false;
            }
            console.log(`  ✅ intake_year matches`);
            
            // 2. Check program type
            const examProgram = exam.program_type || '';
            const studentProgram = studentProfile.program || '';
            
            console.log(`  program_type: exam=${examProgram} student=${studentProgram}`);
            
            if (examProgram !== studentProgram && examProgram !== 'General') {
                console.log(`  ❌ program_type mismatch`);
                return false;
            }
            console.log(`  ✅ program_type matches`);
            
            // 3. Check block term
            const examBlock = exam.block_term || '';
            const studentBlock = studentProfile.block || '';
            
            console.log(`  block_term: exam=${examBlock} student=${studentBlock}`);
            
            if (examBlock && examBlock !== studentBlock && examBlock !== 'General') {
                console.log(`  ❌ block_term mismatch`);
                return false;
            }
            console.log(`  ✅ block_term matches`);
            
            console.log(`  ✅ INCLUDED: ${exam.exam_name}`);
            return true;
        });

        console.log('Filtered exams for student:', filteredExams);

        // Check which exams the student has already taken
        const { data: takenExams, error: takenError } = await sb
            .from('exam_grades')
            .select('exam_id')
            .eq('student_id', currentUserId)
            .eq('result_status', 'Final');

        const takenExamIds = takenExams?.map(e => e.exam_id) || [];

        const container = document.getElementById('examList');
        container.innerHTML = '';

        if (!filteredExams || filteredExams.length === 0) {
            container.innerHTML = `
                <div class="exam-card">
                    <strong>No upcoming exams found</strong><br>
                    <small>Matching criteria: ${studentProfile.program}, ${studentProfile.intake_year}</small>
                </div>
                <div class="exam-card" style="background:#FEF3C7;">
                    <strong>Debug Info:</strong><br>
                    <small>Total upcoming exams in system: ${exams?.length || 0}</small><br>
                    <small>Student: ${studentProfile.program}, Block ${studentProfile.block}, Intake ${studentProfile.intake_year}</small><br>
                    <small>Check browser console for detailed filtering info</small>
                </div>
            `;
            return;
        }

        filteredExams.forEach(exam => {
            const div = document.createElement('div');
            div.className = 'exam-card';
            
            // Check if exam already taken
            const isTaken = takenExamIds.includes(exam.id);
            const buttonText = isTaken ? 'View Results' : 'Start Exam';
            const buttonColor = isTaken ? '#6B7280' : '#38A169';
            
            div.innerHTML = `
                <div style="flex-grow:1;">
                    <strong>${exam.exam_name}</strong><br>
                    <small>Course: ${exam.course_name || 'General'} | Type: ${exam.exam_type || 'EXAM'}</small><br>
                    <small>Date: ${exam.exam_date} | Duration: ${exam.duration_minutes || 30} min</small><br>
                    <small>Program: ${exam.program_type || 'General'} | Block: ${exam.block_term || 'Any'}</small>
                </div>
                <button onclick="${isTaken ? 'viewResults' : 'startExam'}('${exam.id}')" 
                        style="background:${buttonColor}"
                        ${isTaken ? 'disabled' : ''}>
                    ${buttonText}
                </button>
            `;
            container.appendChild(div);
        });

        // Update debug info after loading
        document.getElementById('debugInfo').innerHTML = showLocalStorageDebug() + 
            `<br>Total upcoming exams: ${exams?.length || 0} | Filtered for you: ${filteredExams.length} | Taken by you: ${takenExamIds.length}`;

    } catch (err) {
        console.error('Unexpected error:', err);
        document.getElementById('examList').innerHTML = 
            `<div class="exam-card">
                <strong>Error loading exams.</strong><br>
                <small>${err.message}</small>
            </div>`;
    }
}

function startExam(examId) {
    // CRITICAL FIX: Get user ID with validation
    const userId = localStorage.getItem('currentUserId');
    const email = localStorage.getItem('studentEmail');
    
    console.log('=== STARTING EXAM ===');
    console.log('Exam ID:', examId);
    console.log('User ID from localStorage:', userId);
    console.log('Email from localStorage:', email);
    
    if (!userId || userId === 'null') {
        console.error('ERROR: User ID is null! Cannot start exam.');
        
        // Try sessionStorage as backup
        const sessionUserId = sessionStorage.getItem('currentUserId');
        if (sessionUserId && sessionUserId !== 'null') {
            console.log('Using sessionStorage user ID:', sessionUserId);
            const examUrl = `exam.html?exam_id=${examId}&user_id=${sessionUserId}`;
            console.log('Redirecting to:', examUrl);
            window.location.href = examUrl;
            return;
        }
        
        alert('ERROR: Your login session has expired. Please login again.');
        logout();
        return;
    }
    
    // Build the URL
    const examUrl = `exam.html?exam_id=${examId}&user_id=${userId}`;
    console.log('Redirecting to exam page:', examUrl);
    
    window.location.href = examUrl;
}

function viewResults(examId) {
    alert('Results viewing feature coming soon!');
}

function logout() {
    console.log('Logging out...');
    
    // Clear all storage
    localStorage.removeItem('currentUserId');
    localStorage.removeItem('studentEmail');
    sessionStorage.removeItem('currentUserId');
    sessionStorage.removeItem('studentEmail');
    
    // Sign out from Supabase
    sb.auth.signOut();
    
    // Redirect to login
    window.location.href = 'exam_login.html';
}

// Add click handler for logout button (if user clicks the button in userInfo)
document.addEventListener('click', function(e) {
    if (e.target && e.target.textContent === 'Logout') {
        logout();
    }
});

window.addEventListener('DOMContentLoaded', loadExams);
</script>
</body>
</html>
