<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NurseIQ Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
    <!-- Loader -->
    <div id="config-loader">
        <div class="loader-spinner"></div>
        <h2>NurseIQ Admin Panel</h2>
        <p>Initializing...</p>
    </div>
    
    <!-- Main Container -->
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-stethoscope"></i> NurseIQ Admin Panel</h1>
                <p class="text-muted">Manage assessments, courses, and user progress</p>
            </div>
            <div class="admin-status">
                <div class="status-indicator">
                    <span class="status-dot connecting"></span>
                    <span>Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="admin-tab" data-tab="assessments">
                <i class="fas fa-clipboard-list"></i> Assessments
            </button>
            <button class="admin-tab" data-tab="courses">
                <i class="fas fa-book-medical"></i> Courses
            </button>
            <button class="admin-tab" data-tab="users">
                <i class="fas fa-users"></i> Users
            </button>
            <button class="admin-tab" data-tab="settings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="admin-tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-assessments">0</h3>
                        <p>Total Assessments</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-courses">0</h3>
                        <p>Active Courses</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="active-users">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="completion-rate">0%</h3>
                        <p>Avg. Completion</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-btn" onclick="openAddAssessmentModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New Assessment</span>
                    </button>
                    <button class="action-btn" onclick="openAddCourseModal()">
                        <i class="fas fa-book-medical"></i>
                        <span>Add New Course</span>
                    </button>
                    <button class="action-btn" onclick="openImportModal()">
                        <i class="fas fa-file-import"></i>
                        <span>Import Questions</span>
                    </button>
                    <button class="action-btn" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i>
                        <span>Generate Report</span>
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div id="activity-list" class="activity-list">
                    <div class="activity-item">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading recent activity...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessments Tab -->
        <div id="assessments-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-clipboard-list"></i> Manage Assessments</h2>
                <div>
                    <button class="btn btn-primary" onclick="openAddAssessmentModal()">
                        <i class="fas fa-plus"></i> Add Assessment
                    </button>
                    <button class="btn btn-outline" onclick="refreshAssessments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="filters">
                <input type="text" id="search-assessments" placeholder="Search assessments..." class="search-input">
                <select id="filter-course" class="filter-select">
                    <option value="all">All Courses</option>
                </select>
                <select id="filter-difficulty" class="filter-select">
                    <option value="all">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="filter-status" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>

            <div class="table-responsive">
                <table id="assessments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Topic</th>
                            <th>Course</th>
                            <th>Difficulty</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading assessments...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Courses Tab -->
        <div id="courses-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-book-medical"></i> Manage Courses</h2>
                <div>
                    <button class="btn btn-primary" onclick="openAddCourseModal()">
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                    <button class="btn btn-outline" onclick="refreshCourses()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="courses-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Course Name</th>
                            <th>Unit Code</th>
                            <th>Program</th>
                            <th>Intake Year</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading courses...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-users"></i> User Progress</h2>
                <div>
                    <input type="text" id="search-users" placeholder="Search users..." class="search-input">
                    <button class="btn btn-outline" onclick="refreshUsers()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Program</th>
                            <th>Completed</th>
                            <th>Accuracy</th>
                            <th>Avg Time</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="admin-tab-content">
            <div class="settings-grid">
                <div class="settings-card">
                    <h3><i class="fas fa-database"></i> Database Connection</h3>
                    <div class="connection-info">
                        <div class="info-item">
                            <label>Status:</label>
                            <span id="connection-status" class="status-badge connecting">Connecting...</span>
                        </div>
                        <div class="info-item">
                            <label>URL:</label>
                            <code id="connection-url">Not connected</code>
                        </div>
                        <div class="info-item">
                            <label>Last Check:</label>
                            <span id="last-check">Never</span>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="testConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button class="btn btn-outline" onclick="showConnectionDetails()">
                        <i class="fas fa-info-circle"></i> Show Details
                    </button>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-new" checked>
                            <span>New assessments added</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-errors" checked>
                            <span>System errors</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-user-activity">
                            <span>User activity</span>
                        </label>
                    </div>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-palette"></i> Appearance</h3>
                    <div class="setting-item">
                        <label>Theme</label>
                        <select id="theme-select" class="form-control">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Items per page</label>
                        <select id="page-size" class="form-control">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-tools"></i> Maintenance</h3>
                    <button class="btn btn-outline" onclick="clearCache()">
                        <i class="fas fa-broom"></i> Clear Cache
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="btn btn-danger" onclick="resetSettings()">
                        <i class="fas fa-redo"></i> Reset Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-assessment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add New Assessment</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assessment-form">
                    <div class="form-group">
                        <label>Question Text *</label>
                        <textarea id="question-text" class="form-control" rows="3" required placeholder="Enter the question..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Course *</label>
                            <select id="assessment-course" class="form-control" required>
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficulty *</label>
                            <select id="assessment-difficulty" class="form-control" required>
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Topic</label>
                            <input type="text" id="assessment-topic" class="form-control" placeholder="Enter topic...">
                        </div>
                        <div class="form-group">
                            <label>Marks</label>
                            <input type="number" id="assessment-marks" class="form-control" value="1" min="1" max="10">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Type</label>
                        <select id="assessment-type" class="form-control">
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="short_answer">Short Answer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="assessment-published" checked>
                            <span>Publish immediately</span>
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="add-course-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-medical"></i> Add New Course</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="course-form">
                    <div class="form-group">
                        <label>Course Name *</label>
                        <input type="text" id="course-name" class="form-control" required placeholder="e.g., Anatomy and Physiology">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit Code *</label>
                            <input type="text" id="course-code" class="form-control" required placeholder="e.g., NUR101">
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="color" id="course-color" class="form-control-color" value="#4f46e5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="course-description" class="form-control" rows="2" placeholder="Course description..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Target Program</label>
                            <select id="course-program" class="form-control">
                                <option value="">All Programs</option>
                                <option value="KRCHN">KRCHN</option>
                                <option value="TVET">TVET</option>
                                <option value="Nursing">Nursing</option>
                                <option value="Clinical Medicine">Clinical Medicine</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Intake Year</label>
                            <input type="number" id="course-year" class="form-control" min="2020" max="2030" value="2024">
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Course
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <!-- JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== NURSEIQ ADMIN PANEL - COMPLETE SCRIPT ====================
        console.log('ðŸš€ NurseIQ Admin Panel loading...');

        class NurseIQAdmin {
            constructor() {
                console.log('âœ… NurseIQAdmin constructor called');
                
                this.supabase = null;
                this.config = {
                    supabaseUrl: 'https://lwhtjozfsmbyihenfunw.supabase.co',
                    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk',
                    environment: 'production',
                    loaded: false
                };
                
                this.currentTab = 'dashboard';
                this.assessments = [];
                this.courses = [];
                this.users = [];
                
                this.initialize();
            }
            
            async initialize() {
                try {
                    console.log('ðŸ”§ Initializing NurseIQ Admin Panel...');
                    
                    // Show loader
                    this.showLoader('Initializing...');
                    
                    // Wait for DOM
                    await this.waitForDOM();
                    
                    // Initialize Supabase
                    await this.initializeSupabase();
                    
                    // Verify connection
                    await this.verifyConnection();
                    
                    // Show admin interface
                    this.showAdminInterface();
                    
                    // Load initial data
                    await this.loadInitialData();
                    
                    console.log('âœ… Admin panel initialized successfully!');
                    
                } catch (error) {
                    console.error('âŒ Initialization failed:', error);
                    this.showError('Initialization failed', error.message);
                }
            }
            
            waitForDOM() {
                return new Promise((resolve) => {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', resolve);
                    } else {
                        resolve();
                    }
                });
            }
            
            async initializeSupabase() {
                this.showLoader('Connecting to database...');
                
                try {
                    if (!window.supabase || !window.supabase.createClient) {
                        throw new Error('Supabase client not loaded. Check CDN URL.');
                    }
                    
                    this.supabase = window.supabase.createClient(
                        this.config.supabaseUrl,
                        this.config.supabaseKey,
                        {
                            auth: { persistSession: false }
                        }
                    );
                    
                    console.log('âœ… Supabase client initialized');
                    
                } catch (error) {
                    console.error('âŒ Supabase initialization failed:', error);
                    throw new Error(`Failed to initialize Supabase: ${error.message}`);
                }
            }
            
            async verifyConnection() {
                this.showLoader('Verifying database connection...');
                
                try {
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .select('id')
                        .limit(1);
                    
                    if (error && error.code !== 'PGRST116') {
                        throw new Error(`Database error: ${error.message}`);
                    }
                    
                    console.log('âœ… Database connection verified');
                    this.updateConnectionStatus('connected');
                    
                } catch (error) {
                    console.error('âŒ Connection verification failed:', error);
                    this.updateConnectionStatus('error');
                    throw new Error(`Database connection failed: ${error.message}`);
                }
            }
            
            showAdminInterface() {
                const loader = document.getElementById('config-loader');
                const container = document.querySelector('.admin-container');
                
                if (loader) loader.style.display = 'none';
                if (container) container.style.display = 'block';
                
                this.showNotification('Connected to database successfully!', 'success');
            }
            
            async loadInitialData() {
                try {
                    this.setupEventListeners();
                    await this.loadDashboardData();
                    await this.loadCourses();
                    await this.loadAssessments();
                    await this.loadUsers();
                    
                    console.log('âœ… All initial data loaded');
                    
                } catch (error) {
                    console.error('âŒ Error loading initial data:', error);
                    this.showNotification('Some data failed to load', 'warning');
                }
            }
            
            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Search assessments
                const searchInput = document.getElementById('search-assessments');
                if (searchInput) {
                    searchInput.addEventListener('input', () => this.filterAssessments());
                }
                
                // Forms
                const assessmentForm = document.getElementById('assessment-form');
                if (assessmentForm) {
                    assessmentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveAssessment();
                    });
                }
                
                const courseForm = document.getElementById('course-form');
                if (courseForm) {
                    courseForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveCourse();
                    });
                }
                
                // Close modals on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
            }
            
            // ==================== DASHBOARD ====================
            async loadDashboardData() {
                try {
                    // Total assessments
                    const { count: assessmentsCount } = await this.supabase
                        .from('medical_assessments')
                        .select('*', { count: 'exact', head: true })
                        .eq('is_active', true);
                    
                    document.getElementById('total-assessments').textContent = assessmentsCount || 0;
                    
                    // Total courses
                    const { count: coursesCount } = await this.supabase
                        .from('courses')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'Active');
                    
                    document.getElementById('total-courses').textContent = coursesCount || 0;
                    
                    // Active users (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const { data: progress } = await this.supabase
                        .from('user_assessment_progress')
                        .select('user_id')
                        .gte('completed_at', thirtyDaysAgo.toISOString());
                    
                    const uniqueUsers = new Set(progress?.map(u => u.user_id) || []);
                    document.getElementById('active-users').textContent = uniqueUsers.size;
                    
                    // Completion rate
                    document.getElementById('completion-rate').textContent = '0%';
                    
                    // Recent activity
                    await this.loadRecentActivity();
                    
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                }
            }
            
            async loadRecentActivity() {
                try {
                    const { data: activity } = await this.supabase
                        .from('user_assessment_progress')
                        .select('completed_at, is_correct, assessment_id')
                        .order('completed_at', { ascending: false })
                        .limit(5);
                    
                    const activityList = document.getElementById('activity-list');
                    if (!activityList) return;
                    
                    if (!activity || activity.length === 0) {
                        activityList.innerHTML = '<div class="activity-item">No recent activity</div>';
                        return;
                    }
                    
                    activityList.innerHTML = activity.map(item => {
                        const timeAgo = this.formatTimeAgo(item.completed_at);
                        return `
                            <div class="activity-item">
                                <i class="fas fa-${item.is_correct ? 'check-circle' : 'times-circle'}"></i>
                                <span>Assessment ${item.is_correct ? 'correct' : 'incorrect'} (${timeAgo})</span>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading activity:', error);
                }
            }
            
            // ==================== ASSESSMENTS ====================
            async loadAssessments() {
                try {
                    const { data: assessments, error } = await this.supabase
                        .from('medical_assessments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (error) throw error;
                    
                    this.assessments = assessments || [];
                    this.renderAssessmentsTable();
                    
                    this.showNotification(`Loaded ${this.assessments.length} assessments`, 'success');
                    
                } catch (error) {
                    console.error('Error loading assessments:', error);
                    this.showNotification('Failed to load assessments', 'error');
                    this.assessments = [];
                    this.renderAssessmentsTable();
                }
            }
            
            renderAssessmentsTable() {
                const tableBody = document.querySelector('#assessments-table tbody');
                if (!tableBody) return;
                
                if (this.assessments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No assessments found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = this.assessments.map(assessment => {
                    const date = new Date(assessment.created_at);
                    const formattedDate = date.toLocaleDateString();
                    
                    let statusBadge = '';
                    if (!assessment.is_active) {
                        statusBadge = '<span class="badge inactive">Inactive</span>';
                    } else if (!assessment.is_published) {
                        statusBadge = '<span class="badge draft">Draft</span>';
                    } else {
                        statusBadge = '<span class="badge published">Published</span>';
                    }
                    
                    return `
                        <tr>
                            <td>${assessment.id.substring(0, 8)}...</td>
                            <td>${assessment.topic || 'No topic'}</td>
                            <td>${assessment.course_id || 'No course'}</td>
                            <td><span class="difficulty-badge ${assessment.difficulty}">${assessment.difficulty || 'medium'}</span></td>
                            <td>${statusBadge}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <button onclick="admin.editAssessment('${assessment.id}')" class="btn-action">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="admin.toggleAssessmentStatus('${assessment.id}')" class="btn-action">
                                    <i class="fas ${assessment.is_published ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                </button>
                                <button onclick="admin.deleteAssessment('${assessment.id}')" class="btn-action">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            filterAssessments() {
                const searchTerm = document.getElementById('search-assessments')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#assessments-table tbody tr');
                
                rows.forEach(row => {
                    const topic = row.cells[1]?.textContent.toLowerCase() || '';
                    const matches = !searchTerm || topic.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            }
            
            async saveAssessment() {
                try {
                    const formData = {
                        question_text: document.getElementById('question-text').value,
                        course_id: document.getElementById('assessment-course').value,
                        difficulty: document.getElementById('assessment-difficulty').value,
                        topic: document.getElementById('assessment-topic').value || null,
                        marks: parseInt(document.getElementById('assessment-marks').value) || 1,
                        question_type: document.getElementById('assessment-type').value,
                        is_published: document.getElementById('assessment-published').checked,
                        is_active: true,
                        curriculum: 'KRCHN',
                        created_at: new Date().toISOString()
                    };
                    
                    if (!formData.question_text || !formData.course_id) {
                        this.showNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    this.showNotification('Assessment saved successfully!', 'success');
                    this.closeModal();
                    await this.loadAssessments();
                    await this.loadDashboardData();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error saving assessment:', error);
                    this.showNotification('Failed to save assessment', 'error');
                }
            }
            
            async editAssessment(assessmentId) {
                try {
                    const { data: assessment, error } = await this.supabase
                        .from('medical_assessments')
                        .select('*')
                        .eq('id', assessmentId)
                        .single();
                    
                    if (error) throw error;
                    
                    document.getElementById('question-text').value = assessment.question_text || '';
                    document.getElementById('assessment-course').value = assessment.course_id || '';
                    document.getElementById('assessment-difficulty').value = assessment.difficulty || 'medium';
                    document.getElementById('assessment-topic').value = assessment.topic || '';
                    document.getElementById('assessment-marks').value = assessment.marks || 1;
                    document.getElementById('assessment-type').value = assessment.question_type || 'multiple_choice';
                    document.getElementById('assessment-published').checked = assessment.is_published;
                    
                    const form = document.getElementById('assessment-form');
                    form.dataset.editId = assessmentId;
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await this.updateAssessment(assessmentId);
                    };
                    
                    this.openModal('add-assessment-modal');
                    
                } catch (error) {
                    console.error('Error loading assessment:', error);
                    this.showNotification('Failed to load assessment', 'error');
                }
            }
            
            async updateAssessment(assessmentId) {
                try {
                    const formData = {
                        question_text: document.getElementById('question-text').value,
                        course_id: document.getElementById('assessment-course').value,
                        difficulty: document.getElementById('assessment-difficulty').value,
                        topic: document.getElementById('assessment-topic').value || null,
                        marks: parseInt(document.getElementById('assessment-marks').value) || 1,
                        question_type: document.getElementById('assessment-type').value,
                        is_published: document.getElementById('assessment-published').checked,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .update(formData)
                        .eq('id', assessmentId);
                    
                    if (error) throw error;
                    
                    this.showNotification('Assessment updated successfully!', 'success');
                    this.closeModal();
                    await this.loadAssessments();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error updating assessment:', error);
                    this.showNotification('Failed to update assessment', 'error');
                }
            }
            
            async deleteAssessment(assessmentId) {
                if (!confirm('Are you sure you want to delete this assessment?')) return;
                
                try {
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .delete()
                        .eq('id', assessmentId);
                    
                    if (error) throw error;
                    
                    this.showNotification('Assessment deleted successfully!', 'success');
                    await this.loadAssessments();
                    await this.loadDashboardData();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error deleting assessment:', error);
                    this.showNotification('Failed to delete assessment', 'error');
                }
            }
            
            async toggleAssessmentStatus(assessmentId) {
                try {
                    const { data: assessment } = await this.supabase
                        .from('medical_assessments')
                        .select('is_published')
                        .eq('id', assessmentId)
                        .single();
                    
                    const newStatus = !assessment.is_published;
                    
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .update({ is_published: newStatus })
                        .eq('id', assessmentId);
                    
                    if (error) throw error;
                    
                    this.showNotification(`Assessment ${newStatus ? 'published' : 'unpublished'}!`, 'success');
                    await this.loadAssessments();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error toggling assessment status:', error);
                    this.showNotification('Failed to update assessment status', 'error');
                }
            }
            
            // ==================== COURSES ====================
            async loadCourses() {
                try {
                    const { data: courses, error } = await this.supabase
                        .from('courses')
                        .select('*')
                        .order('course_name');
                    
                    if (error) throw error;
                    
                    this.courses = courses || [];
                    this.renderCoursesTable();
                    
                    // Populate course dropdown
                    const courseSelect = document.getElementById('assessment-course');
                    if (courseSelect && this.courses.length > 0) {
                        courseSelect.innerHTML = '<option value="">Select Course</option>' +
                            this.courses.filter(c => c.status === 'Active').map(course => `
                                <option value="${course.id}">${course.course_name}</option>
                            `).join('');
                    }
                    
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.showNotification('Failed to load courses', 'error');
                    this.courses = [];
                    this.renderCoursesTable();
                }
            }
            
            renderCoursesTable() {
                const tableBody = document.querySelector('#courses-table tbody');
                if (!tableBody) return;
                
                if (this.courses.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No courses found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = this.courses.map(course => {
                    return `
                        <tr>
                            <td>${course.id.substring(0, 8)}...</td>
                            <td>${course.course_name}</td>
                            <td>${course.unit_code || 'N/A'}</td>
                            <td>${course.target_program || 'All'}</td>
                            <td>${course.intake_year || 'All'}</td>
                            <td><span class="status-badge ${course.status === 'Active' ? 'active' : 'inactive'}">${course.status}</span></td>
                            <td>
                                <button onclick="admin.editCourse('${course.id}')" class="btn-action">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="admin.toggleCourseStatus('${course.id}')" class="btn-action">
                                    <i class="fas fa-power-off"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            async saveCourse() {
                try {
                    const formData = {
                        course_name: document.getElementById('course-name').value,
                        unit_code: document.getElementById('course-code').value,
                        color: document.getElementById('course-color').value,
                        description: document.getElementById('course-description').value || null,
                        target_program: document.getElementById('course-program').value || null,
                        intake_year: parseInt(document.getElementById('course-year').value) || null,
                        status: 'Active',
                        created_at: new Date().toISOString()
                    };
                    
                    if (!formData.course_name || !formData.unit_code) {
                        this.showNotification('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    const { error } = await this.supabase
                        .from('courses')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    this.showNotification('Course saved successfully!', 'success');
                    this.closeModal();
                    await this.loadCourses();
                    await this.loadDashboardData();
                    await this.loadAssessments();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error saving course:', error);
                    this.showNotification('Failed to save course', 'error');
                }
            }
            
            async editCourse(courseId) {
                try {
                    const { data: course, error } = await this.supabase
                        .from('courses')
                        .select('*')
                        .eq('id', courseId)
                        .single();
                    
                    if (error) throw error;
                    
                    document.getElementById('course-name').value = course.course_name || '';
                    document.getElementById('course-code').value = course.unit_code || '';
                    document.getElementById('course-color').value = course.color || '#4f46e5';
                    document.getElementById('course-description').value = course.description || '';
                    document.getElementById('course-program').value = course.target_program || '';
                    document.getElementById('course-year').value = course.intake_year || '2024';
                    
                    const form = document.getElementById('course-form');
                    form.dataset.editId = courseId;
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await this.updateCourse(courseId);
                    };
                    
                    this.openModal('add-course-modal');
                    
                } catch (error) {
                    console.error('Error loading course:', error);
                    this.showNotification('Failed to load course', 'error');
                }
            }
            
            async updateCourse(courseId) {
                try {
                    const formData = {
                        course_name: document.getElementById('course-name').value,
                        unit_code: document.getElementById('course-code').value,
                        color: document.getElementById('course-color').value,
                        description: document.getElementById('course-description').value || null,
                        target_program: document.getElementById('course-program').value || null,
                        intake_year: parseInt(document.getElementById('course-year').value) || null,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('courses')
                        .update(formData)
                        .eq('id', courseId);
                    
                    if (error) throw error;
                    
                    this.showNotification('Course updated successfully!', 'success');
                    this.closeModal();
                    await this.loadCourses();
                    await this.loadAssessments();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error updating course:', error);
                    this.showNotification('Failed to update course', 'error');
                }
            }
            
            async toggleCourseStatus(courseId) {
                try {
                    const { data: course } = await this.supabase
                        .from('courses')
                        .select('status')
                        .eq('id', courseId)
                        .single();
                    
                    const newStatus = course.status === 'Active' ? 'Inactive' : 'Active';
                    
                    const { error } = await this.supabase
                        .from('courses')
                        .update({ status: newStatus })
                        .eq('id', courseId);
                    
                    if (error) throw error;
                    
                    this.showNotification(`Course ${newStatus.toLowerCase()}d!`, 'success');
                    await this.loadCourses();
                    await this.loadDashboardData();
                    await this.loadAssessments();
                    this.triggerStudentUpdate();
                    
                } catch (error) {
                    console.error('Error toggling course status:', error);
                    this.showNotification('Failed to update course status', 'error');
                }
            }
            
            // ==================== USERS ====================
            async loadUsers() {
                try {
                    const { data: users, error } = await this.supabase
                        .from('profiles')
                        .select('*')
                        .limit(20);
                    
                    if (error) {
                        console.warn('Could not load users:', error.message);
                        this.users = [];
                        this.renderUsersTable();
                        return;
                    }
                    
                    this.users = users || [];
                    this.renderUsersTable();
                    
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.users = [];
                    this.renderUsersTable();
                }
            }
            
            renderUsersTable() {
                const tableBody = document.querySelector('#users-table tbody');
                if (!tableBody) return;
                
                if (this.users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = this.users.map(user => {
                    return `
                        <tr>
                            <td>
                                <strong>${user.full_name || 'Unknown User'}</strong>
                                <div style="color: #6b7280; font-size: 12px;">${user.email || ''}</div>
                            </td>
                            <td>${user.program || user.department || 'N/A'}</td>
                            <td>0</td>
                            <td>0%</td>
                            <td>0m</td>
                            <td>Never</td>
                            <td>
                                <button onclick="admin.viewUserProgress('${user.id}')" class="btn-action">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // ==================== UTILITIES ====================
            switchTab(tabId) {
                this.currentTab = tabId;
                
                document.querySelectorAll('.admin-tab').forEach(t => {
                    t.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            }
            
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            closeModal() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
                
                const assessmentForm = document.getElementById('assessment-form');
                if (assessmentForm) {
                    assessmentForm.reset();
                    delete assessmentForm.dataset.editId;
                    assessmentForm.onsubmit = (e) => {
                        e.preventDefault();
                        this.saveAssessment();
                    };
                }
                
                const courseForm = document.getElementById('course-form');
                if (courseForm) {
                    courseForm.reset();
                    delete courseForm.dataset.editId;
                    courseForm.onsubmit = (e) => {
                        e.preventDefault();
                        this.saveCourse();
                    };
                }
            }
            
            showLoader(message) {
                const loader = document.getElementById('config-loader');
                if (loader) {
                    const messageEl = loader.querySelector('p');
                    if (messageEl && message) {
                        messageEl.textContent = message;
                    }
                }
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) {
                    const containerDiv = document.createElement('div');
                    containerDiv.id = 'notification-container';
                    containerDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 9999;
                        max-width: 400px;
                    `;
                    document.body.appendChild(containerDiv);
                }
                
                const finalContainer = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    animation: slideIn 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <div>
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span style="margin-left: 10px;">${message}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 0 5px;">
                        &times;
                    </button>
                `;
                
                finalContainer.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            updateConnectionStatus(status) {
                const indicator = document.querySelector('.status-indicator');
                if (indicator) {
                    const dot = indicator.querySelector('.status-dot');
                    const text = indicator.querySelector('span:last-child');
                    
                    if (dot) {
                        dot.className = 'status-dot';
                        dot.classList.add(status);
                    }
                    
                    if (text) {
                        text.textContent = status === 'connected' ? 'Connected' : 'Error';
                    }
                }
            }
            
            formatTimeAgo(dateString) {
                if (!dateString) return 'Never';
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            }
            
            triggerStudentUpdate() {
                const updateEvent = {
                    type: 'nurseiq_update',
                    timestamp: new Date().toISOString(),
                    message: 'New assessments available'
                };
                
                localStorage.setItem('nurseiq_last_update', JSON.stringify(updateEvent));
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'nurseiq_last_update',
                    newValue: JSON.stringify(updateEvent)
                }));
                sessionStorage.setItem('force_refresh_nurseiq', 'true');
                
                this.showNotification('Student view will be updated', 'success');
            }
            
            showError(title, message) {
                const loader = document.getElementById('config-loader');
                if (loader) {
                    loader.innerHTML = `
                        <div style="text-align: center; color: white; max-width: 500px; padding: 40px;">
                            <div style="font-size: 60px; color: #ff6b6b; margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 style="margin-bottom: 10px;">${title}</h3>
                            <p style="margin-bottom: 30px;">${message}</p>
                            <button onclick="location.reload()" style="background: white; color: #4f46e5; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
            }
            
            viewUserProgress(userId) {
                this.showNotification(`Viewing progress for user ${userId.substring(0, 8)}...`, 'info');
            }
            
            async testConnection() {
                try {
                    this.showNotification('Testing connection...', 'info');
                    const { error } = await this.supabase
                        .from('medical_assessments')
                        .select('id')
                        .limit(1);
                    
                    if (error) throw error;
                    
                    this.showNotification('Connection test successful!', 'success');
                    this.updateConnectionStatus('connected');
                    
                } catch (error) {
                    this.showNotification('Connection test failed', 'error');
                    this.updateConnectionStatus('error');
                }
            }
        }

        // ==================== GLOBAL FUNCTIONS ====================
        let adminInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ“„ DOM loaded, initializing admin panel...');
            adminInstance = new NurseIQAdmin();
        });

        window.openAddAssessmentModal = () => adminInstance?.openModal('add-assessment-modal');
        window.openAddCourseModal = () => adminInstance?.openModal('add-course-modal');
        window.openImportModal = () => adminInstance?.showNotification('Import feature coming soon!', 'info');
        window.generateReport = () => adminInstance?.showNotification('Report generation coming soon!', 'info');
        window.testConnection = () => adminInstance?.testConnection();
        window.showConnectionDetails = () => alert(`Connection Details:\nURL: ${adminInstance?.config.supabaseUrl}`);
        window.clearCache = () => {
            localStorage.clear();
            adminInstance?.showNotification('Cache cleared!', 'success');
        };
        window.exportData = () => adminInstance?.showNotification('Export feature coming soon!', 'info');
        window.resetSettings = () => {
            if (confirm('Reset all settings?')) {
                localStorage.clear();
                location.reload();
            }
        };
        window.refreshAssessments = () => adminInstance?.loadAssessments();
        window.refreshCourses = () => adminInstance?.loadCourses();
        window.refreshUsers = () => adminInstance?.loadUsers();
        window.closeModal = () => adminInstance?.closeModal();
        window.admin = adminInstance;
    </script>
</body>
</html>
