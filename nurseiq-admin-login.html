<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NurseIQ Admin - Complete</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Simple Container -->
    <div id="app">
        <!-- Login Section (Shown first) -->
        <div id="login-section">
            <div style="text-align: center; padding: 50px 20px;">
                <h1><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                <p style="color: #666; margin-bottom: 30px;">Complete question & student management</p>
                
                <div style="max-width: 400px; margin: 0 auto; background: #f8f9fa; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 20px;">Admin Login</h2>
                    
                    <div id="login-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
                    </div>
                    
                    <div id="login-success" style="background: #dfd; color: #070; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <i class="fas fa-check-circle"></i> <span id="success-message"></span>
                    </div>
                    
                    <form id="login-form">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                            <input type="email" id="login-email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="admin@example.com" required>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password</label>
                            <input type="password" id="login-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        
                        <button type="submit" id="login-button" style="width: 100%; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 16px; cursor: pointer;">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        <p><i class="fas fa-info-circle"></i> Use any email/password for demo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard (Hidden initially) -->
        <div id="admin-section" style="display: none;">
            <!-- Header -->
            <div style="background: #4f46e5; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; font-size: 24px;"><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                    <p style="margin: 5px 0 0 0; opacity: 0.8;">Complete Management System</p>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="user-info" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                        <i class="fas fa-user"></i> <span id="dashboard-username">Admin</span>
                    </div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div style="display: flex; min-height: calc(100vh - 80px);">
                <!-- Sidebar -->
                <div style="width: 250px; background: #f8f9fa; padding: 20px;">
                    <h3 style="margin-top: 0; color: #4f46e5;"><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    <div style="margin-bottom: 30px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #4f46e5; font-size: 24px; margin-bottom: 5px;" id="total-questions">0</div>
                            <div style="color: #666; font-size: 14px;">Total Questions</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #10b981; font-size: 24px; margin-bottom: 5px;" id="total-students">0</div>
                            <div style="color: #666; font-size: 14px;">Total Students</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #666; margin-bottom: 10px;">Quick Actions</h4>
                    <button onclick="showPage('create-question')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-plus-circle" style="color: #4f46e5;"></i> Create Question
                    </button>
                    <button onclick="showPage('manage-questions')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-list-check" style="color: #f59e0b;"></i> Manage Questions
                    </button>
                    <button onclick="showPage('ai-generate')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-robot" style="color: #10b981;"></i> AI Generate
                    </button>
                    <button onclick="showPage('manage-students')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-users" style="color: #3b82f6;"></i> Manage Students
                    </button>
                    <button onclick="showPage('upload')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-upload" style="color: #8b5cf6;"></i> Bulk Upload
                    </button>
                </div>

                <!-- Main Panel -->
                <div style="flex: 1; padding: 20px;">
                    <!-- Page: Create Question -->
                    <div id="page-create-question" class="page">
                        <h2><i class="fas fa-plus-circle"></i> Create New Question</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <form id="question-form">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Question Text *</label>
                                    <textarea id="question-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px;" 
                                              placeholder="Enter your nursing question..." required></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Topic/Category</label>
                                        <select id="question-topic" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <option value="anatomy">Anatomy</option>
                                            <option value="physiology">Physiology</option>
                                            <option value="pharmacology">Pharmacology</option>
                                            <option value="nursing_care">Nursing Care</option>
                                            <option value="ethics">Ethics</option>
                                            <option value="pathology">Pathology</option>
                                            <option value="microbiology">Microbiology</option>
                                            <option value="community_health">Community Health</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty</label>
                                        <select id="question-difficulty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Correct Answer *</label>
                                    <input type="text" id="correct-answer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                           placeholder="Enter the correct answer..." required>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Explanation</label>
                                    <textarea id="question-explanation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 60px;" 
                                              placeholder="Explain why this answer is correct..."></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="saveQuestion()" style="background: #4f46e5; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-save"></i> Save Question
                                    </button>
                                    <button type="button" onclick="resetQuestionForm()" style="background: #6b7280; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-redo"></i> Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Page: Manage Questions (Bulk Actions) -->
                    <div id="page-manage-questions" class="page" style="display: none;">
                        <h2><i class="fas fa-list-check"></i> Manage Questions (Bulk Actions)</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <!-- Bulk Action Toolbar -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div>
                                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()" style="margin-right: 8px;">
                                        <label for="select-all" style="font-weight: bold;">Select All</label>
                                    </div>
                                    <div style="color: #666; font-size: 14px;">
                                        <span id="selected-count">0</span> of <span id="total-count">0</span> selected
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="exportSelectedQuestions()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                        <i class="fas fa-download"></i> Export Selected
                                    </button>
                                    <button onclick="deleteSelectedQuestions()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filter Controls -->
                            <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Search</label>
                                    <input type="text" id="search-questions" placeholder="Search questions..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Topic</label>
                                    <select id="filter-topic" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="all">All Topics</option>
                                        <option value="anatomy">Anatomy</option>
                                        <option value="physiology">Physiology</option>
                                        <option value="pharmacology">Pharmacology</option>
                                        <option value="nursing_care">Nursing Care</option>
                                        <option value="ethics">Ethics</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Difficulty</label>
                                    <select id="filter-difficulty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="all">All Difficulties</option>
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Sort By</label>
                                    <select id="sort-questions" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="newest">Newest First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="topic">Topic A-Z</option>
                                        <option value="difficulty">Difficulty</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Questions Table -->
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f8f9fa;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 40px;">
                                                <input type="checkbox" id="header-checkbox" onchange="toggleSelectAll()">
                                            </th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Question</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 120px;">Topic</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 100px;">Difficulty</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 120px;">Date</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="questions-table-body">
                                        <tr>
                                            <td colspan="6" style="padding: 30px; text-align: center; color: #666;">
                                                <i class="fas fa-spinner fa-spin"></i> Loading questions...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #666; font-size: 14px;">
                                    Showing <span id="page-start">1</span>-<span id="page-end">10</span> of <span id="total-items">0</span> questions
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="changePage(-1)" id="prev-page" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; disabled">‚Üê Previous</button>
                                    <button onclick="changePage(1)" id="next-page" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Next ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Manage Students -->
                    <div id="page-manage-students" class="page" style="display: none;">
                        <h2><i class="fas fa-users"></i> Manage Students</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <!-- Student Stats -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="color: #3b82f6; font-size: 24px; font-weight: bold;" id="total-students-count">0</div>
                                    <div style="color: #666; font-size: 14px;">Total Students</div>
                                </div>
                                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="color: #10b981; font-size: 24px; font-weight: bold;" id="active-students-count">0</div>
                                    <div style="color: #666; font-size: 14px;">Active Students</div>
                                </div>
                                <div style="background: #fef3f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <div style="color: #ef4444; font-size: 24px; font-weight: bold;" id="inactive-students-count">0</div>
                                    <div style="color: #666; font-size: 14px;">Inactive Students</div>
                                </div>
                                <div style="background: #faf5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                    <div style="color: #8b5cf6; font-size: 24px; font-weight: bold;" id="avg-score">0%</div>
                                    <div style="color: #666; font-size: 14px;">Average Score</div>
                                </div>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                                <div style="flex: 1;">
                                    <input type="text" id="search-students" placeholder="Search students by name, email, or program..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <select id="filter-program" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="all">All Programs</option>
                                        <option value="KRCHN">KRCHN</option>
                                        <option value="TVET">TVET</option>
                                        <option value="Nursing">Nursing</option>
                                        <option value="Clinical Medicine">Clinical Medicine</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="filter-status" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="all">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <button onclick="loadStudents()" style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            
                            <!-- Students Table -->
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: #f8f9fa;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Student</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Program</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Completed</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Accuracy</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Last Active</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Status</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="students-table-body">
                                        <tr>
                                            <td colspan="7" style="padding: 30px; text-align: center; color: #666;">
                                                <i class="fas fa-spinner fa-spin"></i> Loading students...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: AI Generate -->
                    <div id="page-ai-generate" class="page" style="display: none;">
                        <h2><i class="fas fa-robot"></i> AI Question Generator</h2>
                        <!-- ... (same as before) ... -->
                    </div>

                    <!-- Page: Upload CSV -->
                    <div id="page-upload" class="page" style="display: none;">
                        <h2><i class="fas fa-upload"></i> Bulk Upload</h2>
                        <!-- ... (same as before) ... -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Question Details</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <div id="student-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Student Details</h3>
                <button onclick="closeStudentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="student-modal-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
        
        // ==================== GLOBAL VARIABLES ====================
        let supabase = null;
        let currentUser = null;
        let allQuestions = [];
        let allStudents = [];
        let selectedQuestionIds = new Set();
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Starting NurseIQ Admin...');
            
            // Initialize Supabase
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false }
                });
                console.log('‚úÖ Supabase connected');
            } catch (error) {
                console.error('‚ùå Supabase error:', error);
            }
            
            // Check if already logged in
            checkLoginStatus();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // ==================== AUTHENTICATION ====================
        function checkLoginStatus() {
            const userData = localStorage.getItem('nurseiq_simple_admin');
            
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    showAdminDashboard();
                    loadDashboardStats();
                    loadQuestions();
                    loadStudents();
                } catch (e) {
                    console.log('Invalid session data');
                    localStorage.removeItem('nurseiq_simple_admin');
                }
            }
        }
        
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            // Show loading
            document.getElementById('login-error').style.display = 'none';
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // For demo, accept any email/password
                const userData = {
                    email: email,
                    full_name: email.split('@')[0],
                    role: 'admin',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('nurseiq_simple_admin', JSON.stringify(userData));
                currentUser = userData;
                
                document.getElementById('success-message').textContent = 'Login successful!';
                document.getElementById('login-success').style.display = 'block';
                
                setTimeout(() => {
                    showAdminDashboard();
                    loadDashboardStats();
                    loadQuestions();
                    loadStudents();
                }, 1000);
                
            } catch (error) {
                document.getElementById('error-message').textContent = error.message || 'Login failed';
                document.getElementById('login-error').style.display = 'block';
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        });
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('nurseiq_simple_admin');
                currentUser = null;
                showLoginPage();
            }
        }
        
        function showLoginPage() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-section').style.display = 'none';
        }
        
        function showAdminDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            
            if (currentUser) {
                const usernameElement = document.getElementById('dashboard-username');
                if (usernameElement) {
                    usernameElement.textContent = currentUser.full_name || currentUser.email || 'Admin';
                }
            }
            
            showPage('create-question');
        }
        
        // ==================== QUESTION MANAGEMENT ====================
        async function saveQuestion() {
            const questionText = document.getElementById('question-text').value.trim();
            const correctAnswer = document.getElementById('correct-answer').value.trim();
            const topic = document.getElementById('question-topic').value;
            const difficulty = document.getElementById('question-difficulty').value;
            const explanation = document.getElementById('question-explanation').value.trim();
            
            if (!questionText || !correctAnswer) {
                alert('Please fill in question and correct answer');
                return;
            }
            
            try {
                const questionData = {
                    question_text: questionText,
                    correct_answer: correctAnswer,
                    topic: topic,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    created_at: new Date().toISOString(),
                    created_by: currentUser?.email || 'admin'
                };
                
                if (supabase) {
                    const { error } = await supabase
                        .from('medical_assessments')
                        .insert([questionData]);
                    
                    if (error) throw error;
                }
                
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                localQuestions.push({
                    id: 'local_' + Date.now(),
                    ...questionData
                });
                localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
                
                alert('‚úÖ Question saved successfully!');
                resetQuestionForm();
                loadQuestions();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving question:', error);
                
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                localQuestions.push({
                    id: 'local_' + Date.now(),
                    question_text: questionText,
                    correct_answer: correctAnswer,
                    topic: topic,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    created_at: new Date().toISOString(),
                    created_by: currentUser?.email || 'admin'
                });
                localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
                
                alert('‚úÖ Question saved locally!');
                resetQuestionForm();
                loadQuestions();
                loadDashboardStats();
            }
        }
        
        async function loadQuestions() {
            try {
                let questions = [];
                
                if (supabase) {
                    const { data, error } = await supabase
                        .from('medical_assessments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(200);
                    
                    if (!error && data) {
                        questions = data;
                    }
                }
                
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                const allQuestionsMap = new Map();
                
                questions.forEach(q => allQuestionsMap.set(q.id, q));
                localQuestions.forEach(q => {
                    if (!allQuestionsMap.has(q.id)) {
                        allQuestionsMap.set(q.id, q);
                    }
                });
                
                allQuestions = Array.from(allQuestionsMap.values());
                allQuestions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                updateQuestionsTable();
                
            } catch (error) {
                console.error('Error loading questions:', error);
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                allQuestions = localQuestions;
                updateQuestionsTable();
            }
        }
        
        function updateQuestionsTable() {
            const tbody = document.getElementById('questions-table-body');
            if (!tbody) return;
            
            // Apply filters
            let filtered = [...allQuestions];
            const searchTerm = document.getElementById('search-questions')?.value.toLowerCase() || '';
            const topicFilter = document.getElementById('filter-topic')?.value;
            const difficultyFilter = document.getElementById('filter-difficulty')?.value;
            const sortBy = document.getElementById('sort-questions')?.value;
            
            if (searchTerm) {
                filtered = filtered.filter(q => 
                    q.question_text?.toLowerCase().includes(searchTerm) ||
                    q.explanation?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (topicFilter && topicFilter !== 'all') {
                filtered = filtered.filter(q => q.topic === topicFilter);
            }
            
            if (difficultyFilter && difficultyFilter !== 'all') {
                filtered = filtered.filter(q => q.difficulty === difficultyFilter);
            }
            
            // Apply sorting
            switch (sortBy) {
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'topic':
                    filtered.sort((a, b) => (a.topic || '').localeCompare(b.topic || ''));
                    break;
                case 'difficulty':
                    const difficultyOrder = { 'easy': 1, 'medium': 2, 'hard': 3 };
                    filtered.sort((a, b) => difficultyOrder[a.difficulty] - difficultyOrder[b.difficulty]);
                    break;
                default: // newest
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            // Pagination
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filtered.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('total-count').textContent = totalItems;
            document.getElementById('selected-count').textContent = selectedQuestionIds.size;
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('page-start').textContent = totalItems > 0 ? startIndex + 1 : 0;
            document.getElementById('page-end').textContent = endIndex;
            
            // Update buttons
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // Render table
            if (pageItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 30px; text-align: center; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: #e5e7eb; margin-bottom: 10px; display: block;"></i>
                            No questions found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pageItems.map(q => {
                const difficultyColor = {
                    'easy': '#10b981',
                    'medium': '#f59e0b',
                    'hard': '#ef4444'
                }[q.difficulty] || '#6b7280';
                
                const isSelected = selectedQuestionIds.has(q.id);
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb; ${isSelected ? 'background-color: #f0f9ff;' : ''}">
                        <td style="padding: 12px;">
                            <input type="checkbox" value="${q.id}" ${isSelected ? 'checked' : ''} onchange="toggleQuestionSelection('${q.id}')">
                        </td>
                        <td style="padding: 12px;">
                            <div style="font-weight: 500; margin-bottom: 4px;">${q.question_text?.substring(0, 80) || 'No question'}${q.question_text?.length > 80 ? '...' : ''}</div>
                            <div style="font-size: 12px; color: #6b7280;">${q.explanation?.substring(0, 50) || 'No explanation'}${q.explanation?.length > 50 ? '...' : ''}</div>
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${q.topic || 'General'}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <span style="color: ${difficultyColor}; font-weight: bold;">
                                ${q.difficulty || 'medium'}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 14px; color: #6b7280;">
                            ${q.created_at ? new Date(q.created_at).toLocaleDateString() : 'Unknown'}
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewQuestion('${q.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editQuestion('${q.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteQuestion('${q.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==================== BULK QUESTION ACTIONS ====================
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('#questions-table-body input[type="checkbox"]');
            
            if (selectAll.checked) {
                // Select all visible questions
                checkboxes.forEach(cb => {
                    const questionId = cb.value;
                    selectedQuestionIds.add(questionId);
                    cb.checked = true;
                });
            } else {
                // Deselect all
                selectedQuestionIds.clear();
                checkboxes.forEach(cb => cb.checked = false);
            }
            
            updateSelectionCount();
        }
        
        function toggleQuestionSelection(questionId) {
            if (selectedQuestionIds.has(questionId)) {
                selectedQuestionIds.delete(questionId);
            } else {
                selectedQuestionIds.add(questionId);
            }
            
            updateSelectionCount();
            updateSelectAllCheckbox();
        }
        
        function updateSelectionCount() {
            document.getElementById('selected-count').textContent = selectedQuestionIds.size;
        }
        
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('#questions-table-body input[type="checkbox"]');
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            selectAll.checked = allChecked;
        }
        
        async function deleteSelectedQuestions() {
            if (selectedQuestionIds.size === 0) {
                alert('Please select questions to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedQuestionIds.size} question(s)?`)) {
                return;
            }
            
            try {
                const questionsToDelete = Array.from(selectedQuestionIds);
                
                // Delete from Supabase
                if (supabase) {
                    const supabaseIds = questionsToDelete.filter(id => !id.startsWith('local_') && !id.startsWith('ai_') && !id.startsWith('csv_'));
                    if (supabaseIds.length > 0) {
                        const { error } = await supabase
                            .from('medical_assessments')
                            .delete()
                            .in('id', supabaseIds);
                        
                        if (error) throw error;
                    }
                }
                
                // Delete from local storage
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                const updatedQuestions = localQuestions.filter(q => !selectedQuestionIds.has(q.id));
                localStorage.setItem('nurseiq_questions', JSON.stringify(updatedQuestions));
                
                // Update UI
                allQuestions = allQuestions.filter(q => !selectedQuestionIds.has(q.id));
                selectedQuestionIds.clear();
                
                updateQuestionsTable();
                loadDashboardStats();
                
                alert(`‚úÖ Successfully deleted ${questionsToDelete.length} question(s)`);
                
            } catch (error) {
                console.error('Error deleting questions:', error);
                alert('Error deleting questions. Some may have been deleted locally.');
                
                // Delete from local only
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                const updatedQuestions = localQuestions.filter(q => !selectedQuestionIds.has(q.id));
                localStorage.setItem('nurseiq_questions', JSON.stringify(updatedQuestions));
                
                allQuestions = allQuestions.filter(q => !selectedQuestionIds.has(q.id));
                selectedQuestionIds.clear();
                
                updateQuestionsTable();
                loadDashboardStats();
            }
        }
        
        function exportSelectedQuestions() {
            if (selectedQuestionIds.size === 0) {
                alert('Please select questions to export');
                return;
            }
            
            const selectedQuestions = allQuestions.filter(q => selectedQuestionIds.has(q.id));
            
            // Convert to CSV
            let csv = 'question,correct_answer,topic,difficulty,explanation\n';
            selectedQuestions.forEach(q => {
                const escape = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                csv += `${escape(q.question_text)},${escape(q.correct_answer)},${escape(q.topic)},${escape(q.difficulty)},${escape(q.explanation)}\n`;
            });
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nurseiq-questions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exported ${selectedQuestions.length} question(s) to CSV`);
        }
        
        function changePage(direction) {
            const totalItems = allQuestions.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateQuestionsTable();
            }
        }
        
        // ==================== STUDENT MANAGEMENT ====================
        async function loadStudents() {
            try {
                let students = [];
                
                if (supabase) {
                    // Try consolidated table
                    const { data: consolidatedData } = await supabase
                        .from('consolidated_user_profiles_table')
                        .select('*');
                    
                    if (consolidatedData) {
                        students = consolidatedData;
                    } else {
                        // Try profiles table
                        const { data: profilesData } = await supabase
                            .from('profiles')
                            .select('*');
                        
                        if (profilesData) {
                            students = profilesData;
                        }
                    }
                }
                
                // Mock data for demo
                if (students.length === 0) {
                    students = generateMockStudents();
                }
                
                allStudents = students;
                updateStudentsTable();
                updateStudentStats();
                
            } catch (error) {
                console.error('Error loading students:', error);
                allStudents = generateMockStudents();
                updateStudentsTable();
                updateStudentStats();
            }
        }
        
        function generateMockStudents() {
            const programs = ['KRCHN', 'TVET', 'Nursing', 'Clinical Medicine'];
            const firstNames = ['John', 'Mary', 'James', 'Elizabeth', 'Robert', 'Patricia', 'Michael', 'Jennifer', 'William', 'Linda'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
            
            return Array.from({ length: 50 }, (_, i) => ({
                id: `student_${i + 1}`,
                full_name: `${firstNames[i % firstNames.length]} ${lastNames[i % lastNames.length]}`,
                email: `student${i + 1}@college.edu`,
                program: programs[i % programs.length],
                status: i % 5 === 0 ? 'inactive' : 'active', // 20% inactive
                completed_questions: Math.floor(Math.random() * 100),
                accuracy: Math.floor(Math.random() * 30) + 70, // 70-100%
                last_active: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
            }));
        }
        
        function updateStudentsTable() {
            const tbody = document.getElementById('students-table-body');
            if (!tbody) return;
            
            // Apply filters
            let filtered = [...allStudents];
            const searchTerm = document.getElementById('search-students')?.value.toLowerCase() || '';
            const programFilter = document.getElementById('filter-program')?.value;
            const statusFilter = document.getElementById('filter-status')?.value;
            
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.full_name?.toLowerCase().includes(searchTerm) ||
                    s.email?.toLowerCase().includes(searchTerm) ||
                    s.program?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (programFilter && programFilter !== 'all') {
                filtered = filtered.filter(s => s.program === programFilter);
            }
            
            if (statusFilter && statusFilter !== 'all') {
                filtered = filtered.filter(s => s.status === statusFilter);
            }
            
            // Sort by last active (most recent first)
            filtered.sort((a, b) => new Date(b.last_active) - new Date(a.last_active));
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 30px; text-align: center; color: #666;">
                            <i class="fas fa-users" style="font-size: 48px; color: #e5e7eb; margin-bottom: 10px; display: block;"></i>
                            No students found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(student => {
                const accuracyColor = student.accuracy >= 90 ? '#10b981' : 
                                    student.accuracy >= 75 ? '#f59e0b' : '#ef4444';
                
                const statusColor = student.status === 'active' ? '#10b981' : '#ef4444';
                const lastActive = student.last_active ? 
                    formatTimeAgo(student.last_active) : 'Never';
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${student.full_name ? student.full_name.charAt(0).toUpperCase() : 'S'}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${student.full_name || 'Unknown Student'}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${student.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                ${student.program || 'Unknown'}
                            </span>
                        </td>
                        <td style="padding: 12px; font-weight: 500;">
                            ${student.completed_questions || 0}
                        </td>
                        <td style="padding: 12px;">
                            <span style="color: ${accuracyColor}; font-weight: bold;">
                                ${student.accuracy || 0}%
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 14px; color: #6b7280;">
                            ${lastActive}
                        </td>
                        <td style="padding: 12px;">
                            <span style="background: ${statusColor === '#10b981' ? '#d1fae5' : '#fee2e2'}; color: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                ${student.status === 'active' ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewStudentDetails('${student.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="toggleStudentStatus('${student.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button onclick="resetStudentProgress('${student.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStudentStats() {
            const total = allStudents.length;
            const active = allStudents.filter(s => s.status === 'active').length;
            const inactive = total - active;
            
            // Calculate average accuracy
            const avgAccuracy = allStudents.length > 0 ?
                Math.round(allStudents.reduce((sum, s) => sum + (s.accuracy || 0), 0) / allStudents.length) : 0;
            
            document.getElementById('total-students-count').textContent = total;
            document.getElementById('active-students-count').textContent = active;
            document.getElementById('inactive-students-count').textContent = inactive;
            document.getElementById('avg-score').textContent = `${avgAccuracy}%`;
            
            // Update sidebar stat
            document.getElementById('total-students').textContent = total;
        }
        
        function viewStudentDetails(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const content = document.getElementById('student-modal-content');
            content.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                        ${student.full_name ? student.full_name.charAt(0).toUpperCase() : 'S'}
                    </div>
                    <div>
                        <h3 style="margin: 0 0 5px 0;">${student.full_name || 'Unknown Student'}</h3>
                        <p style="margin: 0; color: #6b7280;">${student.email || 'No email'}</p>
                        <span style="background: ${student.status === 'active' ? '#d1fae5' : '#fee2e2'}; color: ${student.status === 'active' ? '#065f46' : '#991b1b'}; padding: 4px 12px; border-radius: 12px; font-size: 14px; margin-top: 8px; display: inline-block;">
                            ${student.status === 'active' ? 'Active Student' : 'Inactive Student'}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Program</h4>
                        <p style="margin: 0; font-size: 18px; font-weight: 500;">${student.program || 'Not specified'}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Student ID</h4>
                        <p style="margin: 0; font-size: 18px; font-weight: 500;">${student.id}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Questions Completed</h4>
                        <p style="margin: 0; font-size: 24px; font-weight: bold; color: #4f46e5;">${student.completed_questions || 0}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Accuracy Rate</h4>
                        <p style="margin: 0; font-size: 24px; font-weight: bold; color: ${student.accuracy >= 90 ? '#10b981' : student.accuracy >= 75 ? '#f59e0b' : '#ef4444'};">${student.accuracy || 0}%</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #666; font-size: 16px;">Last Active</h4>
                    <p style="margin: 0; font-size: 16px;">${student.last_active ? new Date(student.last_active).toLocaleString() : 'Never'}</p>
                </div>
                
                <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; display: flex; gap: 10px;">
                    <button onclick="toggleStudentStatus('${student.id}')" style="flex: 1; background: ${student.status === 'active' ? '#ef4444' : '#10b981'}; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-power-off"></i> ${student.status === 'active' ? 'Deactivate' : 'Activate'} Student
                    </button>
                    <button onclick="resetStudentProgress('${student.id}')" style="flex: 1; background: #f59e0b; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-redo"></i> Reset Progress
                    </button>
                </div>
            `;
            
            document.getElementById('student-modal').style.display = 'flex';
        }
        
        function toggleStudentStatus(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const newStatus = student.status === 'active' ? 'inactive' : 'active';
            
            if (confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} ${student.full_name || 'this student'}?`)) {
                student.status = newStatus;
                updateStudentsTable();
                updateStudentStats();
                
                // Close modal if open
                closeStudentModal();
                
                alert(`‚úÖ Student ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            }
        }
        
        function resetStudentProgress(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            if (confirm(`Reset progress for ${student.full_name || 'this student'}? This will set completed questions to 0 and accuracy to 0%.`)) {
                student.completed_questions = 0;
                student.accuracy = 0;
                updateStudentsTable();
                updateStudentStats();
                
                alert('‚úÖ Student progress reset');
            }
        }
        
        function closeStudentModal() {
            document.getElementById('student-modal').style.display = 'none';
        }
        
        // ==================== DASHBOARD FUNCTIONS ====================
        function loadDashboardStats() {
            try {
                // Count questions
                const totalQuestions = allQuestions.length;
                const totalElement = document.getElementById('total-questions');
                if (totalElement) {
                    totalElement.textContent = totalQuestions;
                }
                
                // Count students
                const totalStudents = allStudents.length;
                const studentsElement = document.getElementById('total-students');
                if (studentsElement) {
                    studentsElement.textContent = totalStudents;
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                if (page.style) {
                    page.style.display = 'none';
                }
            });
            
            // Show selected page
            const pageElement = document.getElementById('page-' + pageName);
            if (pageElement) {
                pageElement.style.display = 'block';
                
                // Load data for specific pages
                if (pageName === 'manage-questions') {
                    loadQuestions();
                } else if (pageName === 'manage-students') {
                    loadStudents();
                }
            }
        }
        
        function closeModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        function setupEventListeners() {
            // Question filters
            const searchQuestions = document.getElementById('search-questions');
            const filterTopic = document.getElementById('filter-topic');
            const filterDifficulty = document.getElementById('filter-difficulty');
            const sortQuestions = document.getElementById('sort-questions');
            
            if (searchQuestions) searchQuestions.addEventListener('input', updateQuestionsTable);
            if (filterTopic) filterTopic.addEventListener('change', updateQuestionsTable);
            if (filterDifficulty) filterDifficulty.addEventListener('change', updateQuestionsTable);
            if (sortQuestions) sortQuestions.addEventListener('change', updateQuestionsTable);
            
            // Student filters
            const searchStudents = document.getElementById('search-students');
            const filterProgram = document.getElementById('filter-program');
            const filterStatus = document.getElementById('filter-status');
            
            if (searchStudents) searchStudents.addEventListener('input', updateStudentsTable);
            if (filterProgram) filterProgram.addEventListener('change', updateStudentsTable);
            if (filterStatus) filterStatus.addEventListener('change', updateStudentsTable);
            
            // Close modals on background click
            document.addEventListener('click', function(e) {
                if (e.target.id === 'question-modal') closeModal();
                if (e.target.id === 'student-modal') closeStudentModal();
            });
            
            // Close modals on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeStudentModal();
                }
            });
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .fa-spin {
                animation: spin 1s linear infinite;
            }
        `;
        document.head.appendChild(style);
        
        console.log('‚úÖ NurseIQ Admin ready!');
    </script>
</body>
</html>
