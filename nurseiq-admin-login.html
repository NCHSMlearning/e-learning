<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NurseIQ Admin - Real Database</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="nurseiq-admin-style.css">
</head>
<body>
    <!-- Simple Container -->
    <div id="app">
        <!-- Login Section -->
        <div id="login-section">
            <div style="text-align: center; padding: 50px 20px;">
                <h1><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                <p style="color: #666; margin-bottom: 30px;">Complete question & student management</p>
                
                <div style="max-width: 400px; margin: 0 auto; background: #f8f9fa; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 20px;">Admin Login</h2>
                    
                    <div id="login-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
                    </div>
                    
                    <div id="login-success" style="background: #dfd; color: #070; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <i class="fas fa-check-circle"></i> <span id="success-message"></span>
                    </div>
                    
                    <form id="login-form">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                            <input type="email" id="login-email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="admin@example.com" required>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password</label>
                            <input type="password" id="login-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        
                        <button type="submit" id="login-button" style="width: 100%; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 16px; cursor: pointer;">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        <p><i class="fas fa-info-circle"></i> Use any email/password for admin access</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-section" style="display: none;">
            <!-- Header -->
            <div style="background: #4f46e5; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; font-size: 24px;"><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                    <p style="margin: 5px 0 0 0; opacity: 0.8;">Real Database Management System</p>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="user-info" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                        <i class="fas fa-user"></i> <span id="dashboard-username">Admin</span>
                    </div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div style="display: flex; min-height: calc(100vh - 80px);">
                <!-- Sidebar -->
                <div style="width: 250px; background: #f8f9fa; padding: 20px;">
                    <h3 style="margin-top: 0; color: #4f46e5;"><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    <div style="margin-bottom: 30px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #4f46e5; font-size: 24px; margin-bottom: 5px;" id="total-questions">0</div>
                            <div style="color: #666; font-size: 14px;">Total Questions</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #10b981; font-size: 24px; margin-bottom: 5px;" id="total-students">0</div>
                            <div style="color: #666; font-size: 14px;">Total Students</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #8b5cf6; font-size: 24px; margin-bottom: 5px;" id="total-courses">0</div>
                            <div style="color: #666; font-size: 14px;">Total Courses</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #666; margin-bottom: 10px;">Quick Actions</h4>
                    <button onclick="showPage('create-question')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-plus-circle" style="color: #4f46e5;"></i> Create Question
                    </button>
                    <button onclick="showPage('manage-questions')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-list-check" style="color: #f59e0b;"></i> Manage Questions
                    </button>
                    <button onclick="showPage('document-upload')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-file-upload" style="color: #10b981;"></i> Upload Document
                    </button>
                    <button onclick="showPage('manage-students')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-users" style="color: #3b82f6;"></i> Manage Students
                    </button>
                    <button onclick="showPage('manage-courses')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-book-medical" style="color: #8b5cf6;"></i> Manage Courses
                    </button>
                    <!-- In your sidebar section (around line 178), add this button: -->
<button onclick="showPage('generate-questions')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
    <i class="fas fa-robot" style="color: #8b5cf6;"></i> Generate Questions
</button>
                </div>

                <!-- Main Panel -->
                <div style="flex: 1; padding: 20px;">
                    <!-- Page: Create Question -->
                    <div id="page-create-question" class="page">
                        <h2><i class="fas fa-plus-circle"></i> Create New Question</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <form id="question-form">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Course *</label>
                                    <select id="question-course" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                                        <option value="">Loading courses...</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Question Text *</label>
                                    <textarea id="question-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px;" 
                                              placeholder="Enter your nursing question..." required></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Topic/Category</label>
                                        <input type="text" id="question-topic" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                               placeholder="e.g., Anatomy, Pharmacology">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty</label>
                                        <select id="question-difficulty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Correct Answer *</label>
                                    <input type="text" id="correct-answer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                           placeholder="Enter the correct answer..." required>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Options (for multiple choice)</label>
                                    <div style="display: grid; gap: 10px;">
                                        <input type="text" id="option-a" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Option A">
                                        <input type="text" id="option-b" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Option B">
                                        <input type="text" id="option-c" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Option C">
                                        <input type="text" id="option-d" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Option D">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Explanation</label>
                                    <textarea id="question-explanation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 60px;" 
                                              placeholder="Explain why this answer is correct..."></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="saveQuestion()" style="background: #4f46e5; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-save"></i> Save Question
                                    </button>
                                    <button type="button" onclick="resetQuestionForm()" style="background: #6b7280; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-redo"></i> Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
<!-- Page: Document Upload (PDF/Word) -->
<div id="page-document-upload" class="page" style="display: none;">
    <h2><i class="fas fa-file-upload"></i> Bulk Add Questions (Copy-Paste)</h2>
    
    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="margin-bottom: 25px;">
            <h3 style="margin-top: 0; color: #4f46e5;">Copy-Paste Questions</h3>
            <p style="color: #666; margin-bottom: 15px;">Simply copy-paste questions from any document. Each question should be on a new line with answers.</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Course *</label>
                <select id="document-course" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select a course</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Paste Questions Here *</label>
                <textarea id="questions-text" style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 300px; font-family: monospace; line-height: 1.5;" 
                          placeholder="Paste your questions here. Use any format!

Examples:
1. What is normal BP?
Answer: 120/80 mmHg
Explanation: Normal adult reading.

Q2. Vitamin from sunlight?
Ans: Vitamin D
Explanation: Skin produces it.

3) Heart chambers?
- Right atrium
- Right ventricle  
- Left atrium
- Left ventricle
Answer: All of the above

Or simple format:
Question: What is CPR?
Answer: Cardiopulmonary resuscitation
"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Question Format</label>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="format-type" value="auto" checked> Auto-detect
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="format-type" value="numbered"> Numbered (1., 2., etc.)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="format-type" value="qprefix"> Q-prefix (Q1, Q2, etc.)
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="processTextQuestions()" id="process-btn" style="background: #4f46e5; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-cogs"></i> Extract Questions
                </button>
                <button onclick="clearTextArea()" style="background: #6b7280; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Clear
                </button>
                <button onclick="showExample()" style="background: #f59e0b; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-question-circle"></i> Show Example
                </button>
            </div>
        </div>
        
        <!-- Extracted Questions Preview -->
        <div id="extraction-results" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0;">Extracted Questions</h3>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                            Found <span id="questions-count" style="font-weight: bold; color: #4f46e5;">0</span> questions
                            <span id="saved-count" style="margin-left: 15px; color: #10b981; font-weight: bold;">0 saved</span>
                        </p>
                    </div>
                    <div>
                        <button onclick="saveAllExtractedQuestions()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-save"></i> Save All Questions
                        </button>
                        <button onclick="clearExtractionResults()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div id="questions-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Questions will be listed here -->
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="saveAllExtractedQuestions()" style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-save"></i> Save All Now
                    </button>
                    <button onclick="editInBulk()" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
                    <!-- Page: Document Upload (PDF/Word) -->
                    <div id="page-document-upload" class="page" style="display: none;">
                        <h2><i class="fas fa-file-upload"></i> Upload Document & Extract Questions</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin-top: 0; color: #4f46e5;">Upload Document</h3>
                                <p style="color: #666; margin-bottom: 15px;">Upload PDF or Word documents to extract questions. Each page will be treated as a separate question.</p>
                                
                                <div style="border: 2px dashed #d1d5db; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 20px;">
                                    <i class="fas fa-file-pdf" style="font-size: 48px; color: #ef4444; margin-bottom: 15px;"></i>
                                    <i class="fas fa-file-word" style="font-size: 48px; color: #2563eb; margin-bottom: 15px; margin-left: 20px;"></i>
                                    <p style="color: #6b7280; margin-bottom: 15px;">Drag & drop PDF or Word files here, or click to browse</p>
                                    <input type="file" id="document-file" accept=".pdf,.doc,.docx,.txt" style="display: none;">
                                    <button onclick="document.getElementById('document-file').click()" style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-folder-open"></i> Browse Files
                                    </button>
                                    <p id="selected-file" style="margin-top: 10px; color: #6b7280;"></p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Course for these questions</label>
                                    <select id="document-course" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="">Loading courses...</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Document Type</label>
                                    <div style="display: flex; gap: 20px;">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" name="doc-type" value="single" checked> Single question per page
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" name="doc-type" value="multiple"> Multiple questions per page
                                        </label>
                                    </div>
                                </div>
                                
                                <button onclick="processDocument()" id="process-btn" style="background: #10b981; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-cogs"></i> Process Document
                                </button>
                            </div>
                            
                            <!-- Extracted Questions Preview -->
                            <div id="extraction-results" style="display: none;">
                                <h3>Extracted Questions Preview</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            <strong>Found <span id="questions-count">0</span> questions</strong>
                                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Review and edit before saving</p>
                                        </div>
                                        <div>
                                            <button onclick="saveAllExtractedQuestions()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                                <i class="fas fa-save"></i> Save All Questions
                                            </button>
                                            <button onclick="clearExtractionResults()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Questions Navigation -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div style="color: #666;">
                                            Question <span id="current-question-num">1</span> of <span id="total-questions-num">0</span>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="prevQuestion()" id="prev-btn" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                                <i class="fas fa-chevron-left"></i> Previous
                                            </button>
                                            <button onclick="nextQuestion()" id="next-btn" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                                Next <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Question Editor -->
                                    <div id="question-editor" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Question Text</label>
                                            <textarea id="extracted-question" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 80px;"></textarea>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Correct Answer</label>
                                                <input type="text" id="extracted-answer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty</label>
                                                <select id="extracted-difficulty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                                    <option value="medium">Medium</option>
                                                    <option value="easy">Easy</option>
                                                    <option value="hard">Hard</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div style="margin-bottom: 10px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Explanation (Optional)</label>
                                            <textarea id="extracted-explanation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 60px;"></textarea>
                                        </div>
                                        
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            <button onclick="saveCurrentQuestion()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                                <i class="fas fa-check"></i> Save This Question
                                            </button>
                                            <button onclick="skipCurrentQuestion()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                                <i class="fas fa-forward"></i> Skip
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- Page: Generate Questions -->
<div id="page-generate-questions" class="page" style="display: none;">
    <h2><i class="fas fa-robot"></i> AI Question Generator</h2>
    
    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="margin-bottom: 20px;">
            <p style="color: #666; margin-bottom: 20px;">Generate up to 100 nursing questions with proper options and answers. Paste existing MCQs to auto-generate similar questions.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Left Column: Input -->
                <div>
                    <h3 style="color: #4f46e5; margin-bottom: 15px;">Input Settings</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Course *</label>
                        <select id="generate-course" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Loading courses...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Topics / Keywords *</label>
                        <textarea id="generate-topics" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; min-height: 120px; font-size: 14px;" 
                                  placeholder="Enter specific nursing topics or paste existing questions...

Example (Paste up to 100 MCQs):
1. What is the normal BP range for adults?
A) 90/60 mmHg
B) 120/80 mmHg ‚úì
C) 140/90 mmHg
D) 160/100 mmHg

2. Which vitamin is produced by sunlight?
A) Vitamin A
B) Vitamin B12
C) Vitamin C
D) Vitamin D ‚úì"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Questions Count (1-100)</label>
                            <input type="number" id="question-count" min="1" max="100" value="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty</label>
                            <select id="difficulty-level" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Generation Mode</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px;">
                                <input type="radio" name="gen-mode" value="ai" checked> AI Generate
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px;">
                                <input type="radio" name="gen-mode" value="template"> From Template
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px;">
                                <input type="radio" name="gen-mode" value="paste"> Analyze Pasted
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="generateQuestions()" id="generate-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; width: 100%;">
                        <i class="fas fa-magic"></i> Generate Questions
                    </button>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="quickGenerate100()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-bolt"></i> Quick 100 Questions
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Examples -->
                <div>
                    <h3 style="color: #10b981; margin-bottom: 15px;">Quick Examples</h3>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #4f46e5; font-size: 16px;">üìã Example 1: Paste 100 MCQs</h4>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px; max-height: 100px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px;">
                            <div>1. Normal adult BP? A) 90/60 B) 120/80‚úì C) 140/90 D) 160/100</div>
                            <div>2. Vitamin from sunlight? A) A B) B12 C) C D) D‚úì</div>
                            <div>3. CPR compression rate? A) 60/min B) 100-120/min‚úì C) 140/min</div>
                        </div>
                        <button onclick="loadPasteExample()" style="background: #4f46e5; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                            <i class="fas fa-paste"></i> Load Paste Example
                        </button>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #4f46e5; font-size: 16px;">üíä Pharmacology Template</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Antibiotics, dosage, side effects, drug interactions, medication administration</p>
                        <button onclick="loadExample1()" style="background: #4f46e5; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                            <i class="fas fa-play"></i> Load Template
                        </button>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #4f46e5; font-size: 16px;">ü´Ä Anatomy Template</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Heart anatomy, circulation, blood vessels, chambers, valves, cardiac cycle</p>
                        <button onclick="loadExample2()" style="background: #4f46e5; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                            <i class="fas fa-play"></i> Load Template
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff7ed; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="margin-top: 0; color: #f59e0b; font-size: 16px;">üí° Tips for 100 Questions</h4>
                        <ul style="color: #666; font-size: 14px; padding-left: 20px; margin-bottom: 0;">
                            <li><strong>Paste existing MCQs</strong> with ‚úì mark for correct answers</li>
                            <li>Use <strong>specific keywords</strong> separated by commas</li>
                            <li>For 100 questions, use <strong>"Quick 100 Questions"</strong> button</li>
                            <li>Questions auto-generate with <strong>proper options</strong></li>
                            <li>Edit generated questions before saving</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Generated Questions Results -->
        <div id="generation-results" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; color: #4f46e5;">Generated Questions</h3>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                            <span id="generated-count" style="font-weight: bold; color: #4f46e5;">0</span> questions generated
                            <span id="saved-count" style="margin-left: 15px; color: #10b981; font-weight: bold;">0 saved</span>
                            <span id="mcq-count" style="margin-left: 15px; color: #8b5cf6; font-weight: bold;">0 MCQs</span>
                        </p>
                    </div>
                    <div>
                        <button onclick="saveAllGeneratedQuestions()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-save"></i> Save All
                        </button>
                        <button onclick="regenerateQuestions()" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-redo"></i> Regenerate
                        </button>
                        <button onclick="exportGeneratedQuestions()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button onclick="clearGenerationResults()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Generated Questions List -->
                <div id="generated-questions-list" style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px;">
                    <!-- Questions will appear here -->
                </div>
                
                <!-- Pagination for 100 questions -->
                <div id="generation-pagination" style="display: none; text-align: center; margin-top: 20px;">
                    <div style="display: inline-flex; gap: 10px; align-items: center;">
                        <button onclick="prevGeneratedPage()" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span style="color: #666;">
                            Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                        </span>
                        <button onclick="nextGeneratedPage()" style="background: #e5e7eb; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                    <!-- Page: Manage Questions -->
                    <div id="page-manage-questions" class="page" style="display: none;">
                        <h2><i class="fas fa-list-check"></i> Manage Questions</h2>
                        <div id="questions-management-content">
                            <!-- Content loaded dynamically -->
                        </div>
                    </div>

                    <!-- Page: Manage Students -->
                    <div id="page-manage-students" class="page" style="display: none;">
                        <h2><i class="fas fa-users"></i> Manage Students</h2>
                        <div id="students-management-content">
                            <!-- Content loaded dynamically -->
                        </div>
                    </div>

                    <!-- Page: Manage Courses -->
                    <div id="page-manage-courses" class="page" style="display: none;">
                        <h2><i class="fas fa-book-medical"></i> Manage Courses</h2>
                        <div id="courses-management-content">
                            <!-- Content loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Question Details</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
        
        // ==================== GLOBAL VARIABLES ====================
        let supabase = null;
        let currentUser = null;
        let extractedQuestions = [];
        let currentQuestionIndex = 0;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Starting NurseIQ Admin (Real Database)...');
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false }
                });
                console.log('‚úÖ Supabase connected');
            } catch (error) {
                console.error('‚ùå Supabase error:', error);
                showError('Database Connection Error', 'Cannot connect to database');
                return;
            }
            
            checkLoginStatus();
        });
        
        function showError(title, message) {
            const errorDiv = document.getElementById('login-error');
            const errorMsg = document.getElementById('error-message');
            if (errorDiv && errorMsg) {
                errorMsg.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                alert(`${title}: ${message}`);
            }
        }
        // ==================== DEBUG FUNCTION ====================
async function debugSupabase() {
    console.log('üîç Debugging Supabase connection...');
    
    try {
        // Test 1: Check if we can query the table
        console.log('Test 1: Querying table...');
        const { data: allUsers, error: allError } = await supabase
            .from('consolidated_user_profiles_table')
            .select('*')
            .limit(3);
        
        console.log('All users (first 3):', allUsers);
        console.log('All users error:', allError);
        
        // Test 2: Try to find the specific email
        console.log('Test 2: Searching for specific email...');
        const testEmail = 'tiongikevin99@gmail.com';
        const { data: specificUser, error: specificError } = await supabase
            .from('consolidated_user_profiles_table')
            .select('*')
            .eq('email', testEmail)
            .limit(1);
        
        console.log('Specific user query result:', specificUser);
        console.log('Specific user error:', specificError);
        console.log('User found?', specificUser && specificUser.length > 0 ? 'YES' : 'NO');
        
        if (specificUser && specificUser.length > 0) {
            console.log('User details:', specificUser[0]);
            console.log('User role:', specificUser[0].role);
        }
        
    } catch (err) {
        console.error('Debug error:', err);
    }
}

// Call this function after initializing Supabase
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Starting NurseIQ Admin (Real Database)...');
    
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: false }
        });
        console.log('‚úÖ Supabase connected');
        
        // Run debug
        await debugSupabase();
        
    } catch (error) {
        console.error('‚ùå Supabase error:', error);
        showError('Database Connection Error', 'Cannot connect to database');
        return;
    }
    
    checkLoginStatus();
});
        // ==================== AUTHENTICATION ====================
        function checkLoginStatus() {
            const userData = localStorage.getItem('nurseiq_admin_session');
            
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    showAdminDashboard();
                    loadInitialData();
                } catch (e) {
                    console.log('Invalid session data');
                    localStorage.removeItem('nurseiq_admin_session');
                }
            }
        }
        
    document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    document.getElementById('login-error').style.display = 'none';
    const loginButton = document.getElementById('login-button');
    loginButton.disabled = true;
    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
    
    try {
        // REAL DATABASE CHECK: Verify admin user
        // Use .limit(1) instead of .single() to avoid 406 error
        const { data: profiles, error } = await supabase
            .from('consolidated_user_profiles_table')
            .select('*')
            .eq('email', email)
            .limit(1);  // CHANGED: Use limit instead of single
        
        if (error) {
            console.error('Supabase error:', error);
            throw new Error('Database connection error');
        }
        
        if (!profiles || profiles.length === 0) {
            throw new Error('User not found in database');
        }
        
        const profile = profiles[0];  // Get first result
        
        // Check if user has admin role
        if (profile.role !== 'superadmin' && profile.role !== 'admin') {
            throw new Error('Admin access required. Current role: ' + profile.role);
        }
        
        // Store session
        const userData = {
            id: profile.id,
            email: profile.email,
            full_name: profile.full_name,
            role: profile.role,
            program: profile.program,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('nurseiq_admin_session', JSON.stringify(userData));
        currentUser = userData;
        
        document.getElementById('success-message').textContent = 'Login successful!';
        document.getElementById('login-success').style.display = 'block';
        
        setTimeout(() => {
            showAdminDashboard();
            loadInitialData();
        }, 1000);
        
    } catch (error) {
        console.error('Login error:', error);
        showError('Login Failed', error.message || 'Invalid credentials');
        loginButton.disabled = false;
        loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
    }
});
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('nurseiq_admin_session');
                currentUser = null;
                showLoginPage();
            }
        }
        
        function showLoginPage() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-section').style.display = 'none';
        }
        
        function showAdminDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            
            if (currentUser) {
                const usernameElement = document.getElementById('dashboard-username');
                if (usernameElement) {
                    usernameElement.textContent = currentUser.full_name || currentUser.email || 'Admin';
                }
            }
            
            showPage('create-question');
        }
        
        // ==================== INITIAL DATA LOADING ====================
        async function loadInitialData() {
            try {
                // Load courses for dropdowns
                await loadCourses();
                
                // Load dashboard stats
                await loadDashboardStats();
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        async function loadCourses() {
            try {
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('course_name');
                
                if (error) throw error;
                
                // Populate course dropdowns
                populateCourseDropdown('question-course', courses);
                populateCourseDropdown('document-course', courses);
                
                console.log(`‚úÖ Loaded ${courses?.length || 0} courses`);
                
            } catch (error) {
                console.error('Error loading courses:', error);
                showError('Courses Error', 'Failed to load courses');
            }
        }
        
        function populateCourseDropdown(dropdownId, courses) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            if (!courses || courses.length === 0) {
                dropdown.innerHTML = '<option value="">No courses available</option>';
                return;
            }
            
            const options = courses.map(course => 
                `<option value="${course.id}">${course.course_name} (${course.unit_code || 'No code'})</option>`
            ).join('');
            
            dropdown.innerHTML = '<option value="">Select a course</option>' + options;
        }
        
        async function loadDashboardStats() {
            try {
                // Count questions
                const { count: questionsCount } = await supabase
                    .from('medical_assessments')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('total-questions').textContent = questionsCount || 0;
                
                // Count students (from consolidated_user_profiles_table)
                const { count: studentsCount } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('total-students').textContent = studentsCount || 0;
                
                // Count courses
                const { count: coursesCount } = await supabase
                    .from('courses')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('total-courses').textContent = coursesCount || 0;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // ==================== QUESTION MANAGEMENT ====================
        async function saveQuestion() {
            const courseId = document.getElementById('question-course').value;
            const questionText = document.getElementById('question-text').value.trim();
            const correctAnswer = document.getElementById('correct-answer').value.trim();
            const topic = document.getElementById('question-topic').value.trim();
            const difficulty = document.getElementById('question-difficulty').value;
            const explanation = document.getElementById('question-explanation').value.trim();
            const optionA = document.getElementById('option-a').value.trim();
            const optionB = document.getElementById('option-b').value.trim();
            const optionC = document.getElementById('option-c').value.trim();
            const optionD = document.getElementById('option-d').value.trim();
            
            if (!courseId) {
                alert('Please select a course');
                return;
            }
            
            if (!questionText || !correctAnswer) {
                alert('Please fill in question and correct answer');
                return;
            }
            
            try {
                const questionData = {
                    question_text: questionText,
                    correct_answer: correctAnswer,
                    course_id: courseId,
                    topic: topic || null,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    option_a: optionA || 'Option A',
                    option_b: optionB || 'Option B',
                    option_c: optionC || 'Option C',
                    option_d: optionD || 'Option D',
                    curriculum: 'KRCHN',
                    is_published: true,
                    is_active: true,
                    created_at: new Date().toISOString(),
                    question_type: optionA ? 'multiple_choice' : 'short_answer',
                    marks: 1,
                    estimated_time: 2
                };
                
                const { error } = await supabase
                    .from('medical_assessments')
                    .insert([questionData]);
                
                if (error) throw error;
                
                alert('‚úÖ Question saved successfully!');
                resetQuestionForm();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Error saving question: ' + error.message);
            }
        }
        
        function resetQuestionForm() {
            document.getElementById('question-form').reset();
        }
        // ==================== SIMPLE COPY-PASTE QUESTION EXTRACTION ====================

let savedQuestionsCount = 0;

function clearTextArea() {
    document.getElementById('questions-text').value = '';
}

function showExample() {
    const exampleText = `1. What is the normal range for adult blood pressure?
Answer: 120/80 mmHg
Explanation: Normal adult blood pressure is typically around 120/80 mmHg.

2. Which vitamin is produced by the skin when exposed to sunlight?
Answer: Vitamin D
Explanation: Vitamin D is synthesized in the skin upon exposure to UVB radiation.

3. What is the primary function of red blood cells?
Answer: Transport oxygen
Explanation: Red blood cells contain hemoglobin which carries oxygen.

Q4. Name the chambers of the human heart.
Ans: Right atrium, right ventricle, left atrium, left ventricle
Explain: The heart has four chambers that work together.

5) What does "ABC" stand for in basic life support?
- Airway
- Breathing  
- Circulation
Correct answer: All of the above`;

    document.getElementById('questions-text').value = exampleText;
}

function processTextQuestions() {
    const text = document.getElementById('questions-text').value.trim();
    const courseId = document.getElementById('document-course').value;
    
    if (!text) {
        alert('Please paste some questions first');
        return;
    }
    
    if (!courseId) {
        alert('Please select a course for these questions');
        return;
    }
    
    const processBtn = document.getElementById('process-btn');
    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    try {
        // Clear previous results
        extractedQuestions = [];
        
        // Process the text based on format type
        const formatType = document.querySelector('input[name="format-type"]:checked').value;
        
        switch(formatType) {
            case 'auto':
                extractedQuestions = extractExamPaperQuestions(text);
                break;
            case 'numbered':
                extractedQuestions = extractNumberedQuestions(text);
                break;
            case 'qprefix':
                extractedQuestions = extractQPrefixQuestions(text);
                break;
        }
        
        console.log(`Extracted ${extractedQuestions.length} questions`);
        
        if (extractedQuestions.length === 0) {
            throw new Error('No questions found. Try selecting a different format.');
        }
        
        // Display results
        displayQuestionsList();
        
    } catch (error) {
        console.error('Error processing text:', error);
        alert('Error: ' + error.message);
    } finally {
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-cogs"></i> Extract Questions';
    }
}

function extractExamPaperQuestions(text) {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    let section = '';
    let currentQuestion = null;
    let options = [];
    let correctAnswer = '';
    let inMcqSection = false;
    let inShortAnswerSection = false;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Detect sections
        if (line.includes('SECTION A:') || line.includes('MULTIPLE CHOICE')) {
            section = 'MCQ';
            inMcqSection = true;
            inShortAnswerSection = false;
            continue;
        }
        
        if (line.includes('SECTION B:') || line.includes('SHORT ANSWER')) {
            section = 'Short Answer';
            inMcqSection = false;
            inShortAnswerSection = true;
            continue;
        }
        
        // Extract numbered questions (both MCQ and Short Answer)
        const questionMatch = line.match(/^(\d+\.|\d+\))\s+(.+)$/);
        
        if (questionMatch) {
            // Save previous question if exists
            if (currentQuestion) {
                const questionObj = {
                    id: questions.length + 1,
                    question: currentQuestion,
                    answer: correctAnswer || '',
                    explanation: '',
                    type: section === 'MCQ' ? 'multiple_choice' : 'short_answer',
                    options: options.length > 0 ? options : null,
                    saved: false
                };
                questions.push(questionObj);
            }
            
            // Start new question
            currentQuestion = questionMatch[2].trim();
            options = [];
            correctAnswer = '';
            
            // For MCQs, collect options from following lines
            if (inMcqSection) {
                let j = i + 1;
                while (j < lines.length && !lines[j].match(/^\d+[\.\)]/)) {
                    const optionMatch = lines[j].match(/^([A-D])\.\s+(.+)$/);
                    if (optionMatch) {
                        options.push(optionMatch[2].trim());
                    }
                    j++;
                }
                
                // Try to find correct answer in question text
                const answerMatch = currentQuestion.match(/correct.*answer.*is.*([A-D])/i);
                if (answerMatch && answerMatch[1] && options.length > 0) {
                    const answerIndex = answerMatch[1].charCodeAt(0) - 65; // A=0, B=1, etc.
                    correctAnswer = options[answerIndex] || options[0];
                } else if (options.length > 0) {
                    // If no answer specified, use first option
                    correctAnswer = options[0];
                }
            }
            
        } 
        // Detect standalone questions ending with ?
        else if (line.endsWith('?') && line.length > 10 && !currentQuestion) {
            currentQuestion = line;
            section = inShortAnswerSection ? 'Short Answer' : 'General';
        }
        // Collect options for current MCQ
        else if (currentQuestion && inMcqSection && line.match(/^[A-D]\.\s+.+$/)) {
            const optionMatch = line.match(/^[A-D]\.\s+(.+)$/);
            if (optionMatch) {
                options.push(optionMatch[1].trim());
            }
        }
        // Detect answer indicators
        else if (currentQuestion && (line.toLowerCase().includes('answer:') || 
                 line.toLowerCase().includes('correct:'))) {
            const answerText = line.replace(/.*(answer|correct):?\s*/i, '').trim();
            if (answerText) {
                correctAnswer = answerText;
            }
        }
        // Continue question text
        else if (currentQuestion && !inMcqSection && line.length < 200 && 
                 !line.match(/^\d+[\.\)]/) && !line.includes('SECTION')) {
            currentQuestion += ' ' + line;
        }
    }
    
    // Add the last question
    if (currentQuestion) {
        const questionObj = {
            id: questions.length + 1,
            question: currentQuestion,
            answer: correctAnswer || '',
            explanation: '',
            type: (section === 'MCQ' || options.length > 0) ? 'multiple_choice' : 'short_answer',
            options: options.length > 0 ? options : null,
            saved: false
        };
        questions.push(questionObj);
    }
    
    // Post-process: Clean up questions
    return questions.map(q => {
        // Remove question numbers from beginning
        q.question = q.question.replace(/^\d+[\.\)]\s*/, '');
        
        // Ensure question ends with ?
        if (!q.question.endsWith('?')) {
            q.question = q.question + '?';
        }
        
        return q;
    });
}

function extractNumberedQuestions(text) {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim());
    
    let currentQuestion = null;
    let currentAnswer = '';
    let currentExplanation = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Find numbered questions
        const questionMatch = line.match(/^(\d+[\.\)])\s+(.+)$/);
        
        if (questionMatch) {
            // Save previous question
            if (currentQuestion) {
                questions.push({
                    id: questions.length + 1,
                    question: currentQuestion.endsWith('?') ? currentQuestion : currentQuestion + '?',
                    answer: currentAnswer,
                    explanation: currentExplanation,
                    saved: false
                });
            }
            
            // Start new question
            currentQuestion = questionMatch[2];
            currentAnswer = '';
            currentExplanation = '';
            
            // Look for answer in next lines
            for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
                if (lines[j].match(/^[A-D]\.\s+.+$/)) {
                    // Option line
                    if (!currentAnswer) {
                        currentAnswer = lines[j].replace(/^[A-D]\.\s+/, '');
                    }
                } else if (lines[j].toLowerCase().includes('answer:')) {
                    currentAnswer = lines[j].replace(/.*answer:?\s*/i, '').trim();
                    break;
                } else if (lines[j].length < 100 && lines[j] && !lines[j].match(/^\d+[\.\)]/)) {
                    // Short line might be answer
                    currentAnswer = lines[j];
                    break;
                }
            }
            
        }
        // Find answer lines
        else if (currentQuestion && line.toLowerCase().includes('answer:')) {
            currentAnswer = line.replace(/.*answer:?\s*/i, '').trim();
        }
        // Find explanation lines
        else if (currentQuestion && line.toLowerCase().includes('explanation:')) {
            currentExplanation = line.replace(/.*explanation:?\s*/i, '').trim();
        }
    }
    
    // Add last question
    if (currentQuestion) {
        questions.push({
            id: questions.length + 1,
            question: currentQuestion.endsWith('?') ? currentQuestion : currentQuestion + '?',
            answer: currentAnswer,
            explanation: currentExplanation,
            saved: false
        });
    }
    
    return questions;
}

function extractQPrefixQuestions(text) {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim());
    
    let currentQuestion = null;
    let currentAnswer = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Find Q-prefixed questions
        const questionMatch = line.match(/^(Q\d+\.?\s*|Question\s*\d+:?\s*)(.+)$/i);
        
        if (questionMatch) {
            // Save previous
            if (currentQuestion) {
                questions.push({
                    id: questions.length + 1,
                    question: currentQuestion.endsWith('?') ? currentQuestion : currentQuestion + '?',
                    answer: currentAnswer,
                    explanation: '',
                    saved: false
                });
            }
            
            // Start new
            currentQuestion = questionMatch[2];
            currentAnswer = '';
            
            // Look for answer
            for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                if (lines[j].toLowerCase().includes('answer:') || 
                    lines[j].toLowerCase().includes('ans:')) {
                    currentAnswer = lines[j].replace(/.*(answer|ans):?\s*/i, '').trim();
                    break;
                } else if (lines[j].length < 150 && lines[j]) {
                    currentAnswer = lines[j];
                    break;
                }
            }
        }
    }
    
    // Add last
    if (currentQuestion) {
        questions.push({
            id: questions.length + 1,
            question: currentQuestion.endsWith('?') ? currentQuestion : currentQuestion + '?',
            answer: currentAnswer,
            explanation: '',
            saved: false
        });
    }
    
    return questions;
}

function displayQuestionsList() {
    const questionsList = document.getElementById('questions-list');
    const questionsCount = document.getElementById('questions-count');
    
    questionsCount.textContent = extractedQuestions.length;
    savedQuestionsCount = extractedQuestions.filter(q => q.saved).length;
    document.getElementById('saved-count').textContent = savedQuestionsCount + ' saved';
    
    let html = '<div style="display: grid; gap: 15px;">';
    
    extractedQuestions.forEach((q, index) => {
        const statusColor = q.saved ? '#10b981' : '#6b7280';
        const statusIcon = q.saved ? 'fa-check-circle' : 'fa-clock';
        const questionType = q.options ? 'MCQ' : 'Short Answer';
        const typeColor = q.options ? '#8b5cf6' : '#f59e0b';
        
        html += `
            <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; color: #4f46e5; font-weight: bold; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                Q${index + 1}
                            </span>
                            <span style="background: ${typeColor}20; color: ${typeColor}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                <i class="fas ${q.options ? 'fa-list-check' : 'fa-pen'}"></i> ${questionType}
                            </span>
                            <span style="color: ${statusColor}; font-size: 14px;">
                                <i class="fas ${statusIcon}"></i> ${q.saved ? 'Saved' : 'Pending'}
                            </span>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 16px; color: #1f2937;">${q.question}</div>
                        
                        ${q.options ? `
                            <div style="margin-bottom: 12px;">
                                <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;"><strong>Options:</strong></div>
                                <div style="display: grid; gap: 8px;">
                                    ${q.options.map((opt, optIndex) => `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: ${opt === q.answer ? '#d1fae5' : '#f9fafb'}; border-radius: 6px; border: 1px solid ${opt === q.answer ? '#10b981' : '#e5e7eb'};">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: ${opt === q.answer ? '#10b981' : '#e5e7eb'}; color: ${opt === q.answer ? 'white' : '#6b7280'}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                ${String.fromCharCode(65 + optIndex)}
                                            </span>
                                            <span style="${opt === q.answer ? 'color: #065f46; font-weight: 500;' : 'color: #4b5563;'}">
                                                ${opt}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: ${q.options ? '#f0f9ff' : '#f9fafb'}; padding: 12px; border-radius: 6px; margin-bottom: ${q.explanation ? '12px' : '0'};">
                            <strong style="color: ${q.options ? '#3b82f6' : '#10b981'};">Correct Answer:</strong> 
                            <span style="color: #1f2937; font-weight: 500; margin-left: 8px;">${q.answer}</span>
                        </div>
                        
                        ${q.explanation ? `
                            <div style="color: #666; font-size: 14px; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                <strong style="color: #f59e0b;">Explanation:</strong> 
                                <span style="margin-left: 8px;">${q.explanation}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div style="margin-left: 15px; min-width: 100px;">
                        <button onclick="saveSingleQuestion(${index})" style="width: 100%; background: ${q.saved ? '#6b7280' : '#4f46e5'}; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;" ${q.saved ? 'disabled' : ''}>
                            <i class="fas ${q.saved ? 'fa-check' : 'fa-save'}"></i> ${q.saved ? 'Saved' : 'Save'}
                        </button>
                        <button onclick="editQuestion(${index})" style="width: 100%; background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 8px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    questionsList.innerHTML = html;
    
    // Show results section
    document.getElementById('extraction-results').style.display = 'block';
    document.getElementById('extraction-results').scrollIntoView({ behavior: 'smooth' });
}

function editQuestion(index) {
    const question = extractedQuestions[index];
    
    // Create edit form
    const editHtml = `
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h4>Edit Question ${index + 1}</h4>
            <div style="margin-bottom: 15px;">
                <label>Question:</label>
                <textarea id="edit-question-${index}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 80px;">${question.question}</textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Answer:</label>
                <input type="text" id="edit-answer-${index}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" value="${question.answer}">
            </div>
            ${question.options ? `
                <div style="margin-bottom: 15px;">
                    <label>Options (one per line):</label>
                    <textarea id="edit-options-${index}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px;">${question.options.join('\n')}</textarea>
                </div>
            ` : ''}
            <div style="display: flex; gap: 10px;">
                <button onclick="saveEditedQuestion(${index})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-check"></i> Save Changes
                </button>
                <button onclick="cancelEdit(${index})" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    `;
    
    // Replace question with edit form
    const questionElement = document.querySelectorAll('#questions-list > div > div')[index];
    if (questionElement) {
        questionElement.parentElement.innerHTML = editHtml;
    }
}

function saveEditedQuestion(index) {
    const questionText = document.getElementById(`edit-question-${index}`).value.trim();
    const answerText = document.getElementById(`edit-answer-${index}`).value.trim();
    const optionsText = document.getElementById(`edit-options-${index}`)?.value.trim();
    
    if (!questionText || !answerText) {
        alert('Question and answer are required');
        return;
    }
    
    extractedQuestions[index].question = questionText;
    extractedQuestions[index].answer = answerText;
    
    if (optionsText) {
        extractedQuestions[index].options = optionsText.split('\n').map(o => o.trim()).filter(o => o);
    }
    
    // Redisplay
    displayQuestionsList();
    alert('Question updated!');
}

function cancelEdit(index) {
    displayQuestionsList();
}
async function saveSingleQuestion(index) {
    const courseId = document.getElementById('document-course').value;
    const question = extractedQuestions[index];
    
    if (!question || question.saved) return;
    
    try {
        const questionData = {
            question_text: question.question,
            correct_answer: question.answer,
            course_id: courseId,
            difficulty: 'medium',
            explanation: question.explanation || null,
            curriculum: 'KRCHN',
            is_published: true,
            is_active: true,
            created_at: new Date().toISOString(),
            question_type: 'short_answer',
            marks: 1,
            estimated_time: 2
        };
        
        const { error } = await supabase
            .from('medical_assessments')
            .insert([questionData]);
        
        if (error) throw error;
        
        // Mark as saved
        extractedQuestions[index].saved = true;
        savedQuestionsCount++;
        
        // Update display
        document.getElementById('saved-count').textContent = savedQuestionsCount + ' saved';
        
        // Update the button
        const buttons = document.querySelectorAll(`button[onclick="saveSingleQuestion(${index})"]`);
        buttons.forEach(btn => {
            btn.innerHTML = '<i class="fas fa-check"></i> Saved';
            btn.style.background = '#6b7280';
            btn.disabled = true;
        });
        
        // Update dashboard stats
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error saving question:', error);
        alert('Error saving question: ' + error.message);
    }
}

async function saveAllExtractedQuestions() {
    const courseId = document.getElementById('document-course').value;
    
    if (!courseId) {
        alert('Please select a course');
        return;
    }
    
    const unsavedQuestions = extractedQuestions.filter(q => !q.saved);
    
    if (unsavedQuestions.length === 0) {
        alert('All questions are already saved!');
        return;
    }
    
    if (!confirm(`Save ${unsavedQuestions.length} unsaved questions?`)) {
        return;
    }
    
    try {
        const questionsToSave = unsavedQuestions.map(q => ({
            question_text: q.question,
            correct_answer: q.answer,
            course_id: courseId,
            difficulty: 'medium',
            explanation: q.explanation || null,
            curriculum: 'KRCHN',
            is_published: true,
            is_active: true,
            created_at: new Date().toISOString(),
            question_type: 'short_answer',
            marks: 1,
            estimated_time: 2
        }));
        
        const { error } = await supabase
            .from('medical_assessments')
            .insert(questionsToSave);
        
        if (error) throw error;
        
        // Mark all as saved
        extractedQuestions.forEach(q => q.saved = true);
        savedQuestionsCount = extractedQuestions.length;
        
        // Update display
        displayQuestionsList();
        
        alert(`‚úÖ Successfully saved ${questionsToSave.length} questions!`);
        
        // Update dashboard stats
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error saving questions:', error);
        alert('Error saving questions: ' + error.message);
    }
}

function clearExtractionResults() {
    if (extractedQuestions.filter(q => !q.saved).length > 0) {
        if (!confirm('You have unsaved questions. Clear anyway?')) {
            return;
        }
    }
    
    extractedQuestions = [];
    savedQuestionsCount = 0;
    document.getElementById('extraction-results').style.display = 'none';
    document.getElementById('questions-text').value = '';
}

function editInBulk() {
    // Simple bulk edit - just reload the text with current questions
    let text = '';
    extractedQuestions.forEach((q, i) => {
        text += `${i + 1}. ${q.question}\n`;
        text += `Answer: ${q.answer}\n`;
        if (q.explanation) {
            text += `Explanation: ${q.explanation}\n`;
        }
        text += '\n';
    });
    
    document.getElementById('questions-text').value = text;
    document.getElementById('extraction-results').style.display = 'none';
    alert('Questions loaded back into editor. Edit and re-extract.');
}
        // ==================== DOCUMENT UPLOAD & PROCESSING ====================
        document.getElementById('document-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileName = document.getElementById('selected-file');
            
            if (file) {
                fileName.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileName.style.color = '#10b981';
            } else {
                fileName.textContent = '';
            }
        });
        
        async function processDocument() {
            const fileInput = document.getElementById('document-file');
            const file = fileInput.files[0];
            const courseId = document.getElementById('document-course').value;
            
            if (!file) {
                alert('Please select a document file');
                return;
            }
            
            if (!courseId) {
                alert('Please select a course for these questions');
                return;
            }
            
            const processBtn = document.getElementById('process-btn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                // For now, we'll simulate document processing
                // In real implementation, you would:
                // 1. Upload file to server
                // 2. Use OCR/text extraction
                // 3. Parse questions
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simulate extracted questions
                extractedQuestions = [
                    {
                        id: 1,
                        question: "What is the normal range for adult blood pressure?",
                        answer: "120/80 mmHg",
                        explanation: "Normal adult blood pressure is typically around 120/80 mmHg."
                    },
                    {
                        id: 2,
                        question: "Which vitamin is produced by the skin when exposed to sunlight?",
                        answer: "Vitamin D",
                        explanation: "Vitamin D is synthesized in the skin upon exposure to UVB radiation."
                    },
                    {
                        id: 3,
                        question: "What is the primary function of red blood cells?",
                        answer: "Transport oxygen",
                        explanation: "Red blood cells contain hemoglobin which carries oxygen throughout the body."
                    }
                ];
                
                // Display results
                displayExtractedQuestions();
                
            } catch (error) {
                console.error('Error processing document:', error);
                alert('Error processing document: ' + error.message);
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-cogs"></i> Process Document';
            }
        }
        
        function displayExtractedQuestions() {
            if (extractedQuestions.length === 0) {
                alert('No questions found in document');
                return;
            }
            
            document.getElementById('questions-count').textContent = extractedQuestions.length;
            document.getElementById('total-questions-num').textContent = extractedQuestions.length;
            document.getElementById('extraction-results').style.display = 'block';
            
            // Scroll to results
            document.getElementById('extraction-results').scrollIntoView({ behavior: 'smooth' });
            
            // Show first question
            currentQuestionIndex = 0;
            showCurrentQuestion();
        }
        
        function showCurrentQuestion() {
            if (currentQuestionIndex < 0 || currentQuestionIndex >= extractedQuestions.length) return;
            
            const question = extractedQuestions[currentQuestionIndex];
            document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
            document.getElementById('extracted-question').value = question.question || '';
            document.getElementById('extracted-answer').value = question.answer || '';
            document.getElementById('extracted-explanation').value = question.explanation || '';
            
            // Update button states
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').disabled = currentQuestionIndex === extractedQuestions.length - 1;
        }
        
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showCurrentQuestion();
            }
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < extractedQuestions.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
            }
        }
        
        async function saveCurrentQuestion() {
            const courseId = document.getElementById('document-course').value;
            const questionText = document.getElementById('extracted-question').value.trim();
            const answer = document.getElementById('extracted-answer').value.trim();
            const difficulty = document.getElementById('extracted-difficulty').value;
            const explanation = document.getElementById('extracted-explanation').value.trim();
            
            if (!questionText || !answer) {
                alert('Please fill in question and answer');
                return;
            }
            
            try {
                const questionData = {
                    question_text: questionText,
                    correct_answer: answer,
                    course_id: courseId,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    curriculum: 'KRCHN',
                    is_published: true,
                    is_active: true,
                    created_at: new Date().toISOString(),
                    question_type: 'short_answer',
                    marks: 1,
                    estimated_time: 2
                };
                
                const { error } = await supabase
                    .from('medical_assessments')
                    .insert([questionData]);
                
                if (error) throw error;
                
                // Remove saved question from array
                extractedQuestions.splice(currentQuestionIndex, 1);
                
                if (extractedQuestions.length === 0) {
                    alert('‚úÖ All questions saved successfully!');
                    clearExtractionResults();
                } else {
                    // Adjust index if needed
                    if (currentQuestionIndex >= extractedQuestions.length) {
                        currentQuestionIndex = extractedQuestions.length - 1;
                    }
                    
                    showCurrentQuestion();
                    document.getElementById('questions-count').textContent = extractedQuestions.length;
                    document.getElementById('total-questions-num').textContent = extractedQuestions.length;
                    
                    alert('‚úÖ Question saved! ' + extractedQuestions.length + ' remaining');
                }
                
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Error saving question: ' + error.message);
            }
        }
        
        function skipCurrentQuestion() {
            if (currentQuestionIndex < extractedQuestions.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
            } else {
                alert('No more questions to skip');
            }
        }
        
        async function saveAllExtractedQuestions() {
            const courseId = document.getElementById('document-course').value;
            
            if (!courseId) {
                alert('Please select a course');
                return;
            }
            
            if (extractedQuestions.length === 0) {
                alert('No questions to save');
                return;
            }
            
            if (!confirm(`Save all ${extractedQuestions.length} questions?`)) {
                return;
            }
            
            try {
                const questionsToSave = extractedQuestions.map(q => ({
                    question_text: q.question || '',
                    correct_answer: q.answer || '',
                    course_id: courseId,
                    difficulty: 'medium',
                    explanation: q.explanation || null,
                    curriculum: 'KRCHN',
                    is_published: true,
                    is_active: true,
                    created_at: new Date().toISOString(),
                    question_type: 'short_answer',
                    marks: 1,
                    estimated_time: 2
                }));
                
                const { error } = await supabase
                    .from('medical_assessments')
                    .insert(questionsToSave);
                
                if (error) throw error;
                
                alert(`‚úÖ Successfully saved ${questionsToSave.length} questions!`);
                clearExtractionResults();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving questions:', error);
                alert('Error saving questions: ' + error.message);
            }
        }
        
        function clearExtractionResults() {
            extractedQuestions = [];
            currentQuestionIndex = 0;
            document.getElementById('extraction-results').style.display = 'none';
            document.getElementById('document-file').value = '';
            document.getElementById('selected-file').textContent = '';
        }
       // ==================== ENHANCED AI QUESTION GENERATOR ====================

let generatedQuestions = [];
let generationInProgress = false;
let currentPage = 1;
const questionsPerPage = 10;

// Comprehensive nursing question database
const enhancedNursingDB = {
    // Pharmacology (20+ questions)
    pharmacology: [
        {
            question: "Which antibiotic requires trough level monitoring to prevent nephrotoxicity?",
            answer: "Vancomycin",
            options: ["Penicillin", "Cephalexin", "Vancomycin", "Azithromycin"],
            explanation: "Vancomycin trough levels (10-20 mg/L) are monitored to ensure efficacy and prevent kidney damage.",
            difficulty: "medium"
        },
        {
            question: "What is the antidote for heparin overdose?",
            answer: "Protamine sulfate",
            options: ["Vitamin K", "Protamine sulfate", "Naloxone", "Flumazenil"],
            explanation: "Protamine sulfate neutralizes heparin by forming an inactive complex.",
            difficulty: "medium"
        },
        {
            question: "Which medication should be taken with food to reduce GI upset?",
            answer: "Metformin",
            options: ["Aspirin", "Metformin", "Levothyroxine", "Warfarin"],
            explanation: "Metformin is best taken with meals to minimize gastrointestinal side effects.",
            difficulty: "easy"
        }
    ],
    
    // Anatomy & Physiology (20+ questions)
    anatomy: [
        {
            question: "How many chambers does the human heart have?",
            answer: "Four",
            options: ["Two", "Three", "Four", "Five"],
            explanation: "The heart has four chambers: right atrium, right ventricle, left atrium, left ventricle.",
            difficulty: "easy"
        },
        {
            question: "Which blood type is the universal donor?",
            answer: "O negative",
            options: ["A positive", "B negative", "AB positive", "O negative"],
            explanation: "O negative blood lacks A, B, and Rh antigens, making it safe for most recipients.",
            difficulty: "medium"
        }
    ],
    
    // Nursing Care (20+ questions)
    nursing_care: [
        {
            question: "What is the normal respiratory rate for adults?",
            answer: "12-20 breaths per minute",
            options: ["8-12 bpm", "12-20 bpm", "20-30 bpm", "30-40 bpm"],
            explanation: "Normal adult respiratory rate is 12-20 breaths per minute at rest.",
            difficulty: "easy"
        },
        {
            question: "How often should a patient with a stage 2 pressure ulcer be repositioned?",
            answer: "Every 2 hours",
            options: ["Every hour", "Every 2 hours", "Every 4 hours", "Every 6 hours"],
            explanation: "Repositioning every 2 hours helps relieve pressure and promote healing.",
            difficulty: "easy"
        }
    ],
    
    // Immunization (20+ questions)
    immunization: [
        {
            question: "Which vaccine is given at birth?",
            answer: "Hepatitis B",
            options: ["BCG", "Hepatitis B", "Polio", "MMR"],
            explanation: "First dose of Hepatitis B vaccine is recommended within 24 hours of birth.",
            difficulty: "easy"
        },
        {
            question: "What is the recommended storage temperature for most vaccines?",
            answer: "2-8¬∞C (35-46¬∞F)",
            options: ["-20¬∞C", "2-8¬∞C", "15-25¬∞C", "Room temperature"],
            explanation: "Most vaccines require refrigeration at 2-8¬∞C to maintain potency.",
            difficulty: "medium"
        }
    ],
    
    // Emergency Care (20+ questions)
    emergency: [
        {
            question: "What is the compression to ventilation ratio for adult CPR?",
            answer: "30:2",
            options: ["15:2", "30:2", "15:1", "30:1"],
            explanation: "For adult CPR, use 30 chest compressions followed by 2 rescue breaths.",
            difficulty: "medium"
        },
        {
            question: "Which medication is used for anaphylaxis?",
            answer: "Epinephrine",
            options: ["Diphenhydramine", "Epinephrine", "Prednisone", "Albuterol"],
            explanation: "Epinephrine is the first-line treatment for anaphylaxis (0.3-0.5 mg IM).",
            difficulty: "medium"
        }
    ]
};

// Example loaders
function loadPasteExample() {
    document.getElementById('generate-topics').value = `1. What is normal BP for adults?
A) 90/60 mmHg
B) 120/80 mmHg ‚úì
C) 140/90 mmHg
D) 160/100 mmHg

2. Vitamin from sunlight?
A) Vitamin A
B) Vitamin B12
C) Vitamin C
D) Vitamin D ‚úì

3. Normal adult pulse?
A) 40-60 bpm
B) 60-100 bpm ‚úì
C) 100-120 bpm
D) 120-140 bpm

4. CPR compression rate?
A) 60/min
B) 100-120/min ‚úì
C) 140/min
D) 160/min

5. Universal blood donor?
A) A+
B) B-
C) AB+
D) O- ‚úì

6. Heparin antidote?
A) Vitamin K
B) Protamine sulfate ‚úì
C) Naloxone
D) Flumazenil`;
    document.getElementById('question-count').value = 50;
    document.querySelector('input[name="gen-mode"][value="paste"]').checked = true;
}

function loadExample1() {
    document.getElementById('generate-topics').value = `Pharmacology Topics:
- Antibiotics: Penicillin, Cephalosporins, Macrolides
- Anticoagulants: Warfarin, Heparin, DOACs
- Cardiac meds: Beta-blockers, ACE inhibitors
- Diabetes: Insulin, Metformin, Sulfonylureas
- Pain management: NSAIDs, Opioids`;
    document.getElementById('question-count').value = 25;
}

function loadExample2() {
    document.getElementById('generate-topics').value = `Anatomy & Physiology:
- Cardiovascular system
- Respiratory system
- Renal system
- Gastrointestinal system
- Nervous system
- Endocrine system`;
    document.getElementById('question-count').value = 30;
}

// Quick generate 100 questions
function quickGenerate100() {
    document.getElementById('question-count').value = 100;
    document.getElementById('generate-topics').value = `Nursing Comprehensive Topics:
1. Pharmacology & Medications
2. Anatomy & Physiology
3. Patient Assessment
4. Nursing Procedures
5. Emergency Care
6. Maternal-Child Health
7. Mental Health
8. Community Health
9. Legal/Ethical Issues
10. Documentation`;
    generateQuestions();
}

// Main generation function - ENHANCED
async function generateQuestions() {
    if (generationInProgress) return;
    
    const courseId = document.getElementById('generate-course').value;
    const topics = document.getElementById('generate-topics').value.trim();
    const count = parseInt(document.getElementById('question-count').value) || 10;
    const difficulty = document.getElementById('difficulty-level').value;
    const genMode = document.querySelector('input[name="gen-mode"]:checked').value;
    
    if (!courseId) {
        alert('Please select a course');
        return;
    }
    
    if (!topics) {
        alert('Please enter topics or paste questions');
        return;
    }
    
    if (count < 1 || count > 100) {
        alert('Please enter between 1-100 questions');
        return;
    }
    
    const generateBtn = document.getElementById('generate-btn');
    generateBtn.disabled = true;
    generationInProgress = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
        console.log(`Generating ${count} questions in ${genMode} mode`);
        
        // Generate questions based on mode
        switch(genMode) {
            case 'paste':
                generatedQuestions = generateFromPastedQuestions(topics, count);
                break;
            case 'template':
                generatedQuestions = generateFromTemplate(topics, count, difficulty);
                break;
            case 'ai':
            default:
                generatedQuestions = generateAIQuestions(topics, count, difficulty);
                break;
        }
        
        console.log(`Generated ${generatedQuestions.length} questions`);
        
        if (generatedQuestions.length === 0) {
            throw new Error('No questions generated. Try different keywords or paste existing questions.');
        }
        
        // Display results
        displayGeneratedQuestions();
        
        // Show success message
        const mcqCount = generatedQuestions.filter(q => q.type === 'mcq').length;
        alert(`‚úÖ Successfully generated ${generatedQuestions.length} questions (${mcqCount} MCQs)`);
        
    } catch (error) {
        console.error('Error generating questions:', error);
        alert('Error: ' + error.message);
    } finally {
        generateBtn.disabled = false;
        generationInProgress = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Questions';
    }
}

// Generate from pasted questions (with ‚úì marks)
function generateFromPastedQuestions(text, count) {
    const questions = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    let currentQuestion = null;
    let currentOptions = [];
    let currentCorrectAnswer = '';
    let questionNumber = 1;
    
    // First pass: Extract existing questions
    const extractedQuestions = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Detect numbered questions
        const questionMatch = line.match(/^(\d+[\.\)])\s+(.+[?])$/i);
        const altMatch = line.match(/^Q?(\d+)[\.\:]\s+(.+[?])$/i);
        
        if (questionMatch || altMatch) {
            // Save previous question if exists
            if (currentQuestion && currentOptions.length > 0) {
                extractedQuestions.push({
                    question: currentQuestion,
                    options: [...currentOptions],
                    answer: currentCorrectAnswer,
                    type: 'mcq'
                });
            }
            
            // Start new question
            const match = questionMatch || altMatch;
            currentQuestion = match[2];
            currentOptions = [];
            currentCorrectAnswer = '';
            
            // Look for options in next lines
            for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                const optionLine = lines[j];
                const optionMatch = optionLine.match(/^([A-D])[\.\)]\s+(.+?)(?:\s+[‚úì‚úî‚àö])?$/i);
                
                if (optionMatch) {
                    const optionText = optionMatch[2].trim();
                    currentOptions.push(optionText);
                    
                    // Check if this is correct answer (has ‚úì symbol)
                    if (optionLine.includes('‚úì') || optionLine.includes('‚úî') || optionLine.includes('‚àö')) {
                        currentCorrectAnswer = optionText;
                    }
                } else if (!optionLine.match(/^[A-D][\.\)]/)) {
                    // Stop if not an option line
                    break;
                }
            }
        }
    }
    
    // Add last question
    if (currentQuestion && currentOptions.length > 0) {
        extractedQuestions.push({
            question: currentQuestion,
            options: [...currentOptions],
            answer: currentCorrectAnswer,
            type: 'mcq'
        });
    }
    
    console.log(`Extracted ${extractedQuestions.length} questions from paste`);
    
    // Generate new questions based on extracted patterns
    for (let i = 0; i < count && i < extractedQuestions.length * 3; i++) {
        const source = extractedQuestions[i % extractedQuestions.length];
        
        // Create variations
        const newQuestion = createQuestionVariation(source.question);
        const newOptions = createOptionsVariation(source.options, source.answer);
        
        questions.push({
            id: questions.length + 1,
            question: newQuestion,
            answer: newOptions.correct,
            options: newOptions.all,
            type: 'mcq',
            difficulty: getRandomDifficulty(),
            topic: 'Generated',
            saved: false,
            explanation: generateExplanation(newQuestion, newOptions.correct)
        });
    }
    
    // Fill remaining with database questions
    if (questions.length < count) {
        const remaining = count - questions.length;
        const dbQuestions = getAllDatabaseQuestions();
        const shuffled = [...dbQuestions].sort(() => Math.random() - 0.5);
        
        shuffled.slice(0, Math.min(remaining, shuffled.length)).forEach((q, idx) => {
            questions.push({
                id: questions.length + 1,
                question: q.question,
                answer: q.answer,
                options: q.options || null,
                type: q.options ? 'mcq' : 'short',
                difficulty: q.difficulty || 'medium',
                topic: 'Database',
                saved: false,
                explanation: q.explanation || generateExplanation(q.question, q.answer)
            });
        });
    }
    
    return questions.slice(0, count);
}

// Generate from template
function generateFromTemplate(topics, count, difficulty) {
    const questions = [];
    const topicArray = topics.toLowerCase().split(/[,\n‚Ä¢\-]/).map(t => t.trim()).filter(t => t);
    
    // Get all database questions
    const allQuestions = getAllDatabaseQuestions();
    const filtered = allQuestions.filter(q => 
        topicArray.some(topic => 
            q.question.toLowerCase().includes(topic) || 
            q.explanation?.toLowerCase().includes(topic)
        )
    );
    
    // Use filtered or all questions
    const sourceQuestions = filtered.length > 0 ? filtered : allQuestions;
    const shuffled = [...sourceQuestions].sort(() => Math.random() - 0.5);
    
    // Generate questions
    for (let i = 0; i < Math.min(count, shuffled.length * 2); i++) {
        const source = shuffled[i % shuffled.length];
        
        questions.push({
            id: i + 1,
            question: source.question,
            answer: source.answer,
            options: source.options || null,
            type: source.options ? 'mcq' : 'short',
            difficulty: difficulty,
            topic: getTopicFromKeywords(topicArray),
            saved: false,
            explanation: source.explanation || generateExplanation(source.question, source.answer)
        });
    }
    
    // If we need more questions, create variations
    if (questions.length < count) {
        for (let i = questions.length; i < count; i++) {
            const source = shuffled[i % shuffled.length];
            const newQuestion = createQuestionVariation(source.question);
            
            questions.push({
                id: i + 1,
                question: newQuestion,
                answer: source.answer,
                options: source.options ? createOptionsVariation(source.options, source.answer).all : null,
                type: source.options ? 'mcq' : 'short',
                difficulty: difficulty,
                topic: getTopicFromKeywords(topicArray),
                saved: false,
                explanation: generateExplanation(newQuestion, source.answer)
            });
        }
    }
    
    return questions.slice(0, count);
}

// AI Question Generation
function generateAIQuestions(topics, count, difficulty) {
    const questions = [];
    const topicArray = topics.toLowerCase().split(/[,\n‚Ä¢\-]/).map(t => t.trim()).filter(t => t);
    
    // Question templates for different topics
    const templates = {
        'pharmacology': [
            "What is the mechanism of action of {drug}?",
            "Which of the following is a side effect of {drug}?",
            "What is the recommended dosage for {drug} in adults?",
            "Which medication interacts with {drug}?",
            "How should {drug} be administered?"
        ],
        'anatomy': [
            "Where is the {organ} located in the body?",
            "What is the function of the {organ}?",
            "Which artery supplies blood to the {organ}?",
            "What nerves innervate the {organ}?",
            "What are the anatomical landmarks for {procedure}?"
        ],
        'nursing': [
            "What is the correct procedure for {skill}?",
            "How often should {action} be performed?",
            "What assessment findings indicate {condition}?",
            "What is the priority intervention for {situation}?",
            "How would you educate a patient about {topic}?"
        ]
    };
    
    // Generate questions
    for (let i = 0; i < count; i++) {
        const topic = topicArray[i % topicArray.length] || 'nursing';
        const templateCategory = getTemplateCategory(topic);
        const templatesForCategory = templates[templateCategory] || templates['nursing'];
        const template = templatesForCategory[Math.floor(Math.random() * templatesForCategory.length)];
        
        const filledQuestion = template.replace('{drug}', getRandomDrug())
                                      .replace('{organ}', getRandomOrgan())
                                      .replace('{skill}', getRandomSkill())
                                      .replace('{action}', getRandomAction())
                                      .replace('{condition}', getRandomCondition())
                                      .replace('{situation}', getRandomSituation())
                                      .replace('{topic}', getRandomTopic())
                                      .replace('{procedure}', getRandomProcedure());
        
        // Create MCQs (80% MCQs, 20% short answer for variety)
        const isMCQ = Math.random() < 0.8;
        
        if (isMCQ) {
            const { correct, options } = generateMCQOptions(filledQuestion, difficulty);
            
            questions.push({
                id: i + 1,
                question: filledQuestion,
                answer: correct,
                options: options,
                type: 'mcq',
                difficulty: difficulty,
                topic: topic,
                saved: false,
                explanation: generateExplanation(filledQuestion, correct)
            });
        } else {
            questions.push({
                id: i + 1,
                question: filledQuestion,
                answer: generateShortAnswer(filledQuestion),
                options: null,
                type: 'short',
                difficulty: difficulty,
                topic: topic,
                saved: false,
                explanation: generateExplanation(filledQuestion, generateShortAnswer(filledQuestion))
            });
        }
    }
    
    return questions;
}

// Helper functions
function getAllDatabaseQuestions() {
    const allQuestions = [];
    Object.values(enhancedNursingDB).forEach(category => {
        allQuestions.push(...category);
    });
    return allQuestions;
}

function createQuestionVariation(question) {
    const variations = {
        'What is': ['Define', 'Explain', 'Describe', 'Identify'],
        'Which of': ['Select', 'Choose', 'Pick'],
        'How should': ['What is the correct way to', 'What procedure should be followed to'],
        'What are': ['List', 'Name', 'Identify']
    };
    
    let newQuestion = question;
    Object.entries(variations).forEach(([from, toArray]) => {
        if (question.startsWith(from)) {
            newQuestion = question.replace(from, toArray[Math.floor(Math.random() * toArray.length)]);
        }
    });
    
    return newQuestion;
}

function createOptionsVariation(options, correctAnswer) {
    if (!options || options.length < 2) {
        // Create new options if none provided
        const newOptions = [
            "Option A: First choice",
            "Option B: Second choice",
            "Option C: Third choice",
            "Option D: Fourth choice"
        ];
        
        const correctIndex = Math.floor(Math.random() * newOptions.length);
        return {
            all: newOptions,
            correct: newOptions[correctIndex]
        };
    }
    
    // Shuffle options but keep track of correct one
    const shuffled = [...options].sort(() => Math.random() - 0.5);
    const correctIndex = shuffled.findIndex(opt => opt === correctAnswer);
    const newCorrectIndex = Math.floor(Math.random() * shuffled.length);
    
    // If correct answer not found in shuffled, use first option
    const finalCorrect = correctIndex >= 0 ? shuffled[newCorrectIndex] : shuffled[0];
    
    // Ensure we have exactly 4 options
    while (shuffled.length < 4) {
        shuffled.push(`Additional option ${shuffled.length + 1}`);
    }
    
    return {
        all: shuffled.slice(0, 4),
        correct: finalCorrect
    };
}

function generateMCQOptions(question, difficulty) {
    const baseAnswers = {
        easy: [
            "Yes",
            "No",
            "Sometimes",
            "It depends"
        ],
        medium: [
            "Apply pressure to stop bleeding",
            "Administer oxygen immediately",
            "Check vital signs first",
            "Call for emergency assistance"
        ],
        hard: [
            "Administer 0.5 mg epinephrine IM",
            "Start IV normal saline at 1000 mL/hr",
            "Intubate immediately",
            "Perform emergency thoracotomy"
        ]
    };
    
    const answers = baseAnswers[difficulty] || baseAnswers.medium;
    const shuffled = [...answers].sort(() => Math.random() - 0.5);
    const correctIndex = Math.floor(Math.random() * shuffled.length);
    
    // Make answers more specific
    const specificAnswers = shuffled.map((ans, idx) => {
        if (question.includes('medication') || question.includes('drug')) {
            return `Option ${String.fromCharCode(65 + idx)}: ${getRandomDrug()} ${ans}`;
        } else if (question.includes('procedure')) {
            return `Option ${String.fromCharCode(65 + idx)}: ${getRandomProcedure()} ${ans}`;
        } else {
            return `Option ${String.fromCharCode(65 + idx)}: ${ans}`;
        }
    });
    
    return {
        all: specificAnswers.slice(0, 4),
        correct: specificAnswers[correctIndex]
    };
}

function generateShortAnswer(question) {
    const shortAnswers = [
        "Follow standard protocol for the procedure",
        "Based on hospital policy and patient condition",
        "Consult the physician for specific orders",
        "Use evidence-based practice guidelines",
        "Assess the patient before proceeding"
    ];
    
    return shortAnswers[Math.floor(Math.random() * shortAnswers.length)];
}

function generateExplanation(question, answer) {
    return `This question addresses ${getTopicFromQuestion(question)}. The correct answer is based on current nursing guidelines and best practices. ${answer} is the most appropriate choice because it aligns with standard protocols.`;
}

function getRandomDifficulty() {
    const difficulties = ['easy', 'medium', 'hard'];
    return difficulties[Math.floor(Math.random() * difficulties.length)];
}

function getTopicFromKeywords(keywords) {
    if (keywords.some(k => k.includes('drug') || k.includes('med'))) return 'Pharmacology';
    if (keywords.some(k => k.includes('heart') || k.includes('lung'))) return 'Anatomy';
    if (keywords.some(k => k.includes('care') || k.includes('nursing'))) return 'Nursing Care';
    return 'General Nursing';
}

function getTopicFromQuestion(question) {
    const q = question.toLowerCase();
    if (q.includes('drug') || q.includes('medication') || q.includes('dose')) return 'pharmacology';
    if (q.includes('organ') || q.includes('anatomy') || q.includes('body')) return 'anatomy';
    if (q.includes('procedure') || q.includes('technique') || q.includes('skill')) return 'nursing skills';
    return 'general nursing';
}

function getTemplateCategory(topic) {
    const t = topic.toLowerCase();
    if (t.includes('drug') || t.includes('med') || t.includes('pharma')) return 'pharmacology';
    if (t.includes('anatomy') || t.includes('organ') || t.includes('body')) return 'anatomy';
    return 'nursing';
}

function getRandomDrug() {
    const drugs = ['Penicillin', 'Vancomycin', 'Metformin', 'Warfarin', 'Insulin', 'Morphine', 'Furosemide', 'Metoprolol'];
    return drugs[Math.floor(Math.random() * drugs.length)];
}

function getRandomOrgan() {
    const organs = ['heart', 'lungs', 'liver', 'kidneys', 'brain', 'stomach', 'intestines', 'pancreas'];
    return organs[Math.floor(Math.random() * organs.length)];
}

function getRandomSkill() {
    const skills = ['IV insertion', 'wound dressing', 'catheter care', 'vital signs', 'medication administration'];
    return skills[Math.floor(Math.random() * skills.length)];
}

function getRandomAction() {
    const actions = ['vital signs', 'turning', 'assessment', 'documentation', 'medication rounds'];
    return actions[Math.floor(Math.random() * actions.length)];
}

function getRandomCondition() {
    const conditions = ['shock', 'infection', 'hypertension', 'diabetes', 'heart failure'];
    return conditions[Math.floor(Math.random() * conditions.length)];
}

function getRandomSituation() {
    const situations = ['cardiac arrest', 'allergic reaction', 'fall risk', 'post-operative care', 'pediatric emergency'];
    return situations[Math.floor(Math.random() * situations.length)];
}

function getRandomTopic() {
    const topics = ['medication side effects', 'diet restrictions', 'exercise precautions', 'home care', 'follow-up appointments'];
    return topics[Math.floor(Math.random() * topics.length)];
}

function getRandomProcedure() {
    const procedures = ['CPR', 'sterile dressing', 'IV start', 'NG tube insertion', 'urinary catheterization'];
    return procedures[Math.floor(Math.random() * procedures.length)];
}

// Display generated questions with pagination
function displayGeneratedQuestions() {
    const questionsList = document.getElementById('generated-questions-list');
    const generatedCount = document.getElementById('generated-count');
    const savedCount = document.getElementById('saved-count');
    const mcqCount = document.getElementById('mcq-count');
    
    generatedCount.textContent = generatedQuestions.length;
    const savedQuestions = generatedQuestions.filter(q => q.saved).length;
    savedCount.textContent = savedQuestions + ' saved';
    const mcqs = generatedQuestions.filter(q => q.type === 'mcq').length;
    mcqCount.textContent = mcqs + ' MCQs';
    
    // Calculate pagination
    const totalPages = Math.ceil(generatedQuestions.length / questionsPerPage);
    currentPage = Math.min(currentPage, totalPages);
    
    // Get questions for current page
    const startIndex = (currentPage - 1) * questionsPerPage;
    const endIndex = Math.min(startIndex + questionsPerPage, generatedQuestions.length);
    const pageQuestions = generatedQuestions.slice(startIndex, endIndex);
    
    let html = '<div style="display: grid; gap: 15px;">';
    
    pageQuestions.forEach((q, index) => {
        const globalIndex = startIndex + index;
        const statusColor = q.saved ? '#10b981' : '#6b7280';
        const typeColor = q.type === 'mcq' ? '#8b5cf6' : q.type === 'short' ? '#f59e0b' : '#ef4444';
        const typeText = q.type === 'mcq' ? 'MCQ' : q.type === 'short' ? 'Short Answer' : 'True/False';
        
        html += `
            <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <span style="background: #f3f4f6; color: #4f46e5; font-weight: bold; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                Q${globalIndex + 1}
                            </span>
                            <span style="background: ${typeColor}20; color: ${typeColor}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                ${typeText}
                            </span>
                            <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                ${q.difficulty}
                            </span>
                            <span style="color: ${statusColor}; font-size: 14px;">
                                <i class="fas ${q.saved ? 'fa-check-circle' : 'fa-clock'}"></i> ${q.saved ? 'Saved' : 'Pending'}
                            </span>
                        </div>
                        
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 16px; color: #1f2937;">${q.question}</div>
                        
                        ${q.options ? `
                            <div style="margin-bottom: 12px;">
                                <div style="color: #6b7280; font-size: 14px; margin-bottom: 8px;"><strong>Options:</strong></div>
                                <div style="display: grid; gap: 8px;">
                                    ${q.options.map((opt, optIndex) => `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: ${opt === q.answer ? '#d1fae5' : '#f9fafb'}; border-radius: 6px; border: 1px solid ${opt === q.answer ? '#10b981' : '#e5e7eb'};">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: ${opt === q.answer ? '#10b981' : '#e5e7eb'}; color: ${opt === q.answer ? 'white' : '#6b7280'}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                ${String.fromCharCode(65 + optIndex)}
                                            </span>
                                            <span style="${opt === q.answer ? 'color: #065f46; font-weight: 500;' : 'color: #4b5563;'}">
                                                ${opt}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <strong style="color: #3b82f6;">Correct Answer:</strong> 
                            <span style="color: #1f2937; font-weight: 500; margin-left: 8px;">${q.answer}</span>
                        </div>
                        
                        <div style="color: #666; font-size: 14px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <strong style="color: #6b7280;">Topic:</strong> 
                            <span style="margin-left: 8px;">${q.topic}</span>
                            <span style="margin-left: 15px; color: #6b7280;">|</span>
                            <strong style="color: #6b7280; margin-left: 15px;">Explanation:</strong> 
                            <span style="margin-left: 8px;">${q.explanation}</span>
                        </div>
                    </div>
                    
                    <div style="margin-left: 15px; min-width: 100px;">
                        <button onclick="saveGeneratedQuestion(${globalIndex})" style="width: 100%; background: ${q.saved ? '#6b7280' : '#4f46e5'}; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;" ${q.saved ? 'disabled' : ''}>
                            <i class="fas ${q.saved ? 'fa-check' : 'fa-save'}"></i> ${q.saved ? 'Saved' : 'Save'}
                        </button>
                        <button onclick="editGeneratedQuestion(${globalIndex})" style="width: 100%; background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 8px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    questionsList.innerHTML = html;
    
    // Show/hide pagination
    const pagination = document.getElementById('generation-pagination');
    if (totalPages > 1) {
        pagination.style.display = 'block';
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
    } else {
        pagination.style.display = 'none';
    }
    
    // Show results section
    document.getElementById('generation-results').style.display = 'block';
    document.getElementById('generation-results').scrollIntoView({ behavior: 'smooth' });
}

// Pagination functions
function prevGeneratedPage() {
    if (currentPage > 1) {
        currentPage--;
        displayGeneratedQuestions();
    }
}

function nextGeneratedPage() {
    const totalPages = Math.ceil(generatedQuestions.length / questionsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayGeneratedQuestions();
    }
}

// Save single generated question
async function saveGeneratedQuestion(index) {
    const courseId = document.getElementById('generate-course').value;
    const question = generatedQuestions[index];
    
    if (!question || question.saved) return;
    
    try {
        const questionData = {
            question_text: question.question,
            correct_answer: question.answer,
            course_id: courseId,
            difficulty: question.difficulty,
            topic: question.topic,
            explanation: question.explanation || null,
            option_a: question.options ? question.options[0] || null : null,
            option_b: question.options ? question.options[1] || null : null,
            option_c: question.options ? question.options[2] || null : null,
            option_d: question.options ? question.options[3] || null : null,
            curriculum: 'KRCHN',
            is_published: true,
            is_active: true,
            created_at: new Date().toISOString(),
            question_type: question.type === 'mcq' ? 'multiple_choice' : 
                          question.type === 'truefalse' ? 'true_false' : 'short_answer',
            marks: question.difficulty === 'hard' ? 2 : 1
        };
        
        const { error } = await supabase
            .from('medical_assessments')
            .insert([questionData]);
        
        if (error) throw error;
        
        // Mark as saved
        generatedQuestions[index].saved = true;
        
        // Update display
        const savedQuestions = generatedQuestions.filter(q => q.saved).length;
        document.getElementById('saved-count').textContent = savedQuestions + ' saved';
        
        // Update button
        const buttons = document.querySelectorAll(`button[onclick="saveGeneratedQuestion(${index})"]`);
        buttons.forEach(btn => {
            btn.innerHTML = '<i class="fas fa-check"></i> Saved';
            btn.style.background = '#6b7280';
            btn.disabled = true;
        });
        
        // Update dashboard stats
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error saving generated question:', error);
        alert('Error saving question: ' + error.message);
    }
}

// Save all generated questions
async function saveAllGeneratedQuestions() {
    const courseId = document.getElementById('generate-course').value;
    
    if (!courseId) {
        alert('Please select a course');
        return;
    }
    
    const unsavedQuestions = generatedQuestions.filter(q => !q.saved);
    
    if (unsavedQuestions.length === 0) {
        alert('All questions are already saved!');
        return;
    }
    
    if (!confirm(`Save ${unsavedQuestions.length} unsaved questions?`)) {
        return;
    }
    
    try {
        const questionsToSave = unsavedQuestions.map(q => ({
            question_text: q.question,
            correct_answer: q.answer,
            course_id: courseId,
            difficulty: q.difficulty,
            topic: q.topic,
            explanation: q.explanation || null,
            option_a: q.options ? q.options[0] || null : null,
            option_b: q.options ? q.options[1] || null : null,
            option_c: q.options ? q.options[2] || null : null,
            option_d: q.options ? q.options[3] || null : null,
            curriculum: 'KRCHN',
            is_published: true,
            is_active: true,
            created_at: new Date().toISOString(),
            question_type: q.type === 'mcq' ? 'multiple_choice' : 
                          q.type === 'truefalse' ? 'true_false' : 'short_answer',
            marks: q.difficulty === 'hard' ? 2 : 1
        }));
        
        const { error } = await supabase
            .from('medical_assessments')
            .insert(questionsToSave);
        
        if (error) throw error;
        
        // Mark all as saved
        generatedQuestions.forEach(q => q.saved = true);
        
        // Update display
        displayGeneratedQuestions();
        
        alert(`‚úÖ Successfully saved ${questionsToSave.length} questions!`);
        
        // Update dashboard stats
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error saving generated questions:', error);
        alert('Error saving questions: ' + error.message);
    }
}

// Export generated questions
async function exportGeneratedQuestions() {
    try {
        const exportData = generatedQuestions.map((q, index) => ({
            '#': index + 1,
            'Question': q.question,
            'Correct Answer': q.answer,
            'Options': q.options ? q.options.join(' | ') : 'N/A',
            'Type': q.type,
            'Difficulty': q.difficulty,
            'Topic': q.topic,
            'Explanation': q.explanation || '',
            'Status': q.saved ? 'Saved' : 'Unsaved'
        }));
        
        // Create CSV
        const headers = ['#', 'Question', 'Correct Answer', 'Options', 'Type', 'Difficulty', 'Topic', 'Explanation', 'Status'];
        const csvContent = [
            headers.join(','),
            ...exportData.map(row => 
                headers.map(header => {
                    const cell = row[header] || '';
                    const escaped = String(cell).replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                }).join(',')
            )
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const fileName = `generated_questions_${new Date().toISOString().split('T')[0]}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`‚úÖ Exported ${generatedQuestions.length} questions to CSV`);
        
    } catch (error) {
        console.error('Error exporting questions:', error);
        alert('Error exporting questions: ' + error.message);
    }
}

// Regenerate questions
function regenerateQuestions() {
    generateQuestions();
}

// Clear results
function clearGenerationResults() {
    if (generatedQuestions.filter(q => !q.saved).length > 0) {
        if (!confirm('You have unsaved questions. Clear anyway?')) {
            return;
        }
    }
    
    generatedQuestions = [];
    currentPage = 1;
    document.getElementById('generation-results').style.display = 'none';
}

// Edit generated question
function editGeneratedQuestion(index) {
    const question = generatedQuestions[index];
    
    // Simple edit using prompt for quick editing
    const newQuestion = prompt('Edit the question:', question.question);
    if (newQuestion !== null && newQuestion.trim()) {
        const newAnswer = prompt('Edit the correct answer:', question.answer);
        if (newAnswer !== null && newAnswer.trim()) {
            generatedQuestions[index].question = newQuestion;
            generatedQuestions[index].answer = newAnswer;
            
            // If it has options, offer to edit them
            if (question.options && question.options.length > 0) {
                const currentOptions = question.options.join('\n');
                const newOptions = prompt('Edit options (one per line):', currentOptions);
                if (newOptions !== null) {
                    generatedQuestions[index].options = newOptions.split('\n')
                        .map(opt => opt.trim())
                        .filter(opt => opt)
                        .slice(0, 4); // Keep max 4 options
                }
            }
            
            displayGeneratedQuestions();
            alert('Question updated! Remember to save it.');
        }
    }
}
// Update showPage function to load courses for generator
function showPage(pageName) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        if (page.style) {
            page.style.display = 'none';
        }
    });
    
    // Show selected page
    const pageElement = document.getElementById('page-' + pageName);
    if (pageElement) {
        pageElement.style.display = 'block';
        
        // Load specific page data
        switch(pageName) {
            case 'manage-questions':
                loadManageQuestionsPage();
                break;
            case 'manage-students':
                loadManageStudentsPage();
                break;
            case 'manage-courses':
                loadManageCoursesPage();
                break;
            case 'create-question':
                loadCourses();
                break;
            case 'document-upload':
                loadCourses();
                break;
            case 'generate-questions':
                loadGenerateQuestionsPage();
                break;
        }
    }
}
        // ==================== PAGE MANAGEMENT ====================
function showPage(pageName) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        if (page.style) {
            page.style.display = 'none';
        }
    });
    
    // Show selected page
    const pageElement = document.getElementById('page-' + pageName);
    if (pageElement) {
        pageElement.style.display = 'block';
        
        // Load specific page data
        switch(pageName) {
            case 'manage-questions':
                loadManageQuestionsPage();
                break;
            case 'manage-students':
                loadManageStudentsPage();
                break;
            case 'manage-courses':
                loadManageCoursesPage();
                break;
            case 'create-question':
                loadCourses(); // Ensure courses are loaded
                break;
            case 'document-upload':
                loadCourses(); // Ensure courses are loaded
                break;
            case 'generate-questions':
                loadGenerateQuestionsPage(); // Load the generate questions page
                break;
        }
    }
}
        
async function loadManageQuestionsPage() {
    const contentDiv = document.getElementById('questions-management-content');
    contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading questions...</div>';
    
    try {
        // Fetch courses with their question counts
        const { data: courses, error: coursesError } = await supabase
            .from('courses')
            .select(`
                id,
                course_name,
                unit_code,
                target_program,
                description,
                status,
                color,
                medical_assessments!inner (
                    id,
                    is_active,
                    difficulty,
                    question_type,
                    created_at
                )
            `)
            .order('course_name');
        
        if (coursesError) throw coursesError;
        
        if (!courses || courses.length === 0) {
            contentDiv.innerHTML = `
                <div style="background: white; padding: 60px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #e5e7eb, #d1d5db); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-book" style="font-size: 36px; color: #6b7280;"></i>
                    </div>
                    <h3 style="color: #374151; margin-bottom: 10px;">No courses found</h3>
                    <p style="color: #9ca3af; max-width: 400px; margin: 0 auto 25px auto;">Create your first course to start adding questions</p>
                    <button onclick="showPage('manage-courses')" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-plus-circle"></i> Create Course
                    </button>
                </div>
            `;
            return;
        }
        
        // Calculate stats for each course
        const coursesWithStats = courses.map(course => {
            const questions = course.medical_assessments || [];
            const totalQuestions = questions.length;
            const activeQuestions = questions.filter(q => q.is_active).length;
            const mcqQuestions = questions.filter(q => q.question_type === 'multiple_choice').length;
            const hardQuestions = questions.filter(q => q.difficulty === 'hard').length;
            
            return {
                ...course,
                stats: {
                    totalQuestions,
                    activeQuestions,
                    mcqQuestions,
                    hardQuestions,
                    accuracy: totalQuestions > 0 ? Math.round((activeQuestions / totalQuestions) * 100) : 0,
                    lastUpdated: questions.length > 0 
                        ? new Date(questions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0].created_at)
                        : new Date()
                }
            };
        });
        
        // Calculate overall stats
        const overallStats = {
            totalCourses: coursesWithStats.length,
            totalQuestions: coursesWithStats.reduce((sum, course) => sum + course.stats.totalQuestions, 0),
            activeQuestions: coursesWithStats.reduce((sum, course) => sum + course.stats.activeQuestions, 0),
            avgAccuracy: Math.round(coursesWithStats.reduce((sum, course) => sum + course.stats.accuracy, 0) / coursesWithStats.length)
        };
        
        // Render the folder interface
        const foldersHtml = `
            <div style="max-width: 1400px; margin: 0 auto;">
                <!-- Header Stats -->
                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 15px; padding: 25px; color: white; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; font-size: 28px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-folder-tree"></i> Question Bank
                            </h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9;">Organized by courses with detailed statistics</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="loadManageQuestionsPage()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button onclick="showBulkDeleteInterface()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #fee2e2; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-trash-alt"></i> Bulk Delete
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <div style="font-size: 36px; font-weight: bold;">${overallStats.totalCourses}</div>
                            <div style="opacity: 0.9; font-size: 14px;">Total Courses</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <div style="font-size: 36px; font-weight: bold;">${overallStats.totalQuestions}</div>
                            <div style="opacity: 0.9; font-size: 14px;">Total Questions</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <div style="font-size: 36px; font-weight: bold;">${overallStats.activeQuestions}</div>
                            <div style="opacity: 0.9; font-size: 14px;">Active Questions</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <div style="font-size: 36px; font-weight: bold;">${overallStats.avgAccuracy}%</div>
                            <div style="opacity: 0.9; font-size: 14px;">Avg. Active Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Search and Filters -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px;">
                            <div style="position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                                <input type="text" id="search-courses" placeholder="Search courses..." style="width: 100%; padding: 12px 15px 12px 45px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;" 
                                       onkeyup="filterCourses()">
                            </div>
                        </div>
                        <select id="filter-program" style="padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-width: 180px;" onchange="filterCourses()">
                            <option value="">All Programs</option>
                            <option value="BSCN">BSCN</option>
                            <option value="KRCHN">KRCHN</option>
                            <option value="DIPLOMA">Diploma</option>
                            <option value="DEGREE">Degree</option>
                        </select>
                        <select id="filter-status" style="padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-width: 150px;" onchange="filterCourses()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Course Folders Grid -->
                <div id="courses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px;">
                    ${coursesWithStats.map(course => {
                        const courseColor = course.color || getRandomColor();
                        const isActive = course.status === 'Active';
                        const accuracyColor = course.stats.accuracy >= 90 ? '#10b981' : 
                                            course.stats.accuracy >= 75 ? '#f59e0b' : '#ef4444';
                        
                        return `
                            <div class="course-folder" data-course-id="${course.id}" 
                                 style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;"
                                 onclick="openCourseFolder('${course.id}')">
                                <!-- Folder Header -->
                                <div style="background: linear-gradient(135deg, ${courseColor}, ${darkenColor(courseColor, 20)}); padding: 25px; color: white; position: relative;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-book-medical" style="font-size: 20px;"></i>
                                                </div>
                                                <div>
                                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${course.course_name}</h3>
                                                    <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">${course.unit_code || 'No Code'}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                            ${course.target_program || 'ALL'}
                                        </span>
                                    </div>
                                    
                                    <div style="position: absolute; bottom: -20px; right: 20px; width: 70px; height: 70px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                                        <div style="text-align: center;">
                                            <div style="font-size: 20px; font-weight: bold; color: ${courseColor};">${course.stats.totalQuestions}</div>
                                            <div style="font-size: 10px; color: #6b7280;">QS</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Folder Body -->
                                <div style="padding: 25px; padding-top: 35px;">
                                    <!-- Progress Bar -->
                                    <div style="margin-bottom: 20px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="font-size: 13px; color: #6b7280;">Active Questions</span>
                                            <span style="font-size: 13px; color: ${accuracyColor}; font-weight: 500;">${course.stats.accuracy}%</span>
                                        </div>
                                        <div style="height: 6px; background: #f3f4f6; border-radius: 3px; overflow: hidden;">
                                            <div style="height: 100%; width: ${course.stats.accuracy}%; background: ${accuracyColor}; border-radius: 3px;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Stats -->
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 22px; font-weight: bold; color: #4f46e5;">${course.stats.activeQuestions}</div>
                                            <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">ACTIVE</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 22px; font-weight: bold; color: #8b5cf6;">${course.stats.mcqQuestions}</div>
                                            <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">MCQ</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 22px; font-weight: bold; color: #f59e0b;">${course.stats.hardQuestions}</div>
                                            <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">HARD</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 22px; font-weight: bold; color: #10b981;">${course.stats.lastUpdated.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                            <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">UPDATED</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status and Actions -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f3f4f6; padding-top: 15px;">
                                        <span style="background: ${isActive ? '#d1fae5' : '#fee2e2'}; 
                                               color: ${isActive ? '#065f46' : '#991b1b'}; 
                                               padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                            <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                            ${course.status || 'Unknown'}
                                        </span>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="event.stopPropagation(); addQuestionToCourse('${course.id}')" 
                                                    style="background: ${courseColor}; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                                    title="Add question">
                                                <i class="fas fa-plus" style="font-size: 12px;"></i>
                                            </button>
                                            <button onclick="event.stopPropagation(); viewCourseQuestions('${course.id}')" 
                                                    style="background: #4f46e5; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                                    title="View questions">
                                                <i class="fas fa-eye" style="font-size: 12px;"></i>
                                            </button>
                                            <button onclick="event.stopPropagation(); confirmDeleteQuestionBank('${course.id}', '${course.course_name.replace(/'/g, "\\'")}')" 
                                                    style="background: #ef4444; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                                    title="Delete question bank">
                                                <i class="fas fa-trash" style="font-size: 12px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Empty State -->
                <div id="no-courses-message" style="display: none; text-align: center; padding: 60px 20px; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                    <div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-search" style="font-size: 36px; color: #9ca3af;"></i>
                    </div>
                    <h3 style="color: #374151; margin-bottom: 10px;">No courses match your search</h3>
                    <p style="color: #9ca3af;">Try adjusting your filters or search terms</p>
                </div>
                
                <!-- Bulk Delete Section (Initially Hidden) -->
                <div id="bulk-delete-section" style="display: none; margin-top: 30px;">
                    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); border: 2px solid #fee2e2;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #dc2626;">
                                <i class="fas fa-exclamation-triangle"></i> Bulk Question Deletion
                            </h3>
                            <button onclick="hideBulkDeleteInterface()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                        
                        <div style="background: #fef2f2; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <p style="color: #7f1d1d; margin-bottom: 15px;">
                                <i class="fas fa-info-circle"></i> Select courses below to delete ALL questions from them. This action cannot be undone!
                            </p>
                            
                            <div style="display: flex; gap: 15px; margin-top: 20px;">
                                <button onclick="selectAllCourses()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button onclick="deselectAllCourses()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                                <button onclick="exportSelectedCourses()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-download"></i> Export Selected
                                </button>
                            </div>
                        </div>
                        
                        <div id="bulk-delete-courses-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                            <!-- Course checkboxes will be populated here -->
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: #dc2626;">Selected: <span id="selected-count">0</span> courses</h4>
                                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">
                                        Total questions to delete: <span id="total-questions-selected">0</span>
                                    </p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="confirmBulkDelete()" id="bulk-delete-btn" style="background: #ef4444; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; opacity: 0.5;" disabled>
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        contentDiv.innerHTML = foldersHtml;
        
        // Store courses data for filtering
        window.allCourses = coursesWithStats;
        
        // Initialize bulk delete interface
        initializeBulkDeleteInterface();
        
    } catch (error) {
        console.error('Error loading questions:', error);
        contentDiv.innerHTML = `
            <div style="background: #fee; color: #c00; padding: 30px; border-radius: 12px; text-align: center;">
                <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                <h3 style="margin: 0 0 10px 0;">Error loading questions</h3>
                <p style="margin: 0;">${error.message}</p>
            </div>
        `;
    }
}

// ==================== QUESTION BANK DELETION FUNCTIONS ====================

// Confirm and delete entire question bank for a course
async function confirmDeleteQuestionBank(courseId, courseName) {
    if (!courseId || !courseName) return;
    
    // First, get the count of questions to delete
    try {
        const { count, error: countError } = await supabase
            .from('medical_assessments')
            .select('*', { count: 'exact', head: true })
            .eq('course_id', courseId);
        
        if (countError) throw countError;
        
        const questionCount = count || 0;
        
        if (questionCount === 0) {
            alert(`No questions found in the "${courseName}" question bank.`);
            return;
        }
        
        // Show confirmation modal with details
        const confirmation = `
            <div style="max-width: 500px;">
                <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="color: #dc2626; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> Warning: Delete Question Bank
                    </h3>
                    <p style="color: #7f1d1d; margin-bottom: 10px;">
                        You are about to delete <strong>ALL ${questionCount} questions</strong> from the course:
                    </p>
                    <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #fecaca;">
                        <strong style="color: #dc2626;">${courseName}</strong>
                        <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Course ID: ${courseId}</p>
                    </div>
                    <p style="color: #7f1d1d; font-size: 14px;">
                        <i class="fas fa-info-circle"></i> This action <strong>cannot be undone</strong>. All questions will be permanently deleted.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #374151;">
                        <input type="checkbox" id="confirm-delete-checkbox" style="margin-right: 8px;">
                        I understand this action is permanent and cannot be reversed
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-keyboard" style="color: #6b7280;"></i>
                        <input type="text" id="confirm-delete-text" placeholder="Type 'DELETE ${courseName.replace(/"/g, '&quot;')}' to confirm" 
                               style="flex: 1; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"
                               oninput="updateDeleteButton()">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="execute-delete-btn" onclick="deleteQuestionBank('${courseId}', '${courseName.replace(/'/g, "\\'")}')" 
                            style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; opacity: 0.5;" disabled>
                        <i class="fas fa-trash"></i> Delete Question Bank
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('modal-content').innerHTML = confirmation;
        document.getElementById('question-modal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error counting questions:', error);
        alert('Error checking question count: ' + error.message);
    }
}

// Update delete button state based on confirmation
function updateDeleteButton() {
    const checkbox = document.getElementById('confirm-delete-checkbox');
    const confirmText = document.getElementById('confirm-delete-text');
    const deleteBtn = document.getElementById('execute-delete-btn');
    
    if (!checkbox || !confirmText || !deleteBtn) return;
    
    // Extract course name from placeholder
    const placeholder = confirmText.placeholder;
    const match = placeholder.match(/Type 'DELETE (.+)' to confirm/);
    const courseName = match ? match[1] : '';
    
    const isConfirmed = checkbox.checked && confirmText.value === `DELETE ${courseName}`;
    
    deleteBtn.disabled = !isConfirmed;
    deleteBtn.style.opacity = isConfirmed ? '1' : '0.5';
    deleteBtn.style.cursor = isConfirmed ? 'pointer' : 'not-allowed';
}

// Execute the deletion of all questions in a course
async function deleteQuestionBank(courseId, courseName) {
    const deleteBtn = document.getElementById('execute-delete-btn');
    if (!deleteBtn || deleteBtn.disabled) return;
    
    // Disable button and show loading
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    try {
        // First, get count for confirmation
        const { count, error: countError } = await supabase
            .from('medical_assessments')
            .select('*', { count: 'exact', head: true })
            .eq('course_id', courseId);
        
        if (countError) throw countError;
        
        const questionCount = count || 0;
        
        // Show progress modal for deletion
        document.getElementById('modal-content').innerHTML = `
            <div style="max-width: 500px;">
                <h3 style="color: #374151; margin-bottom: 15px;">Deleting Questions...</h3>
                <div style="background: #f3f4f6; height: 10px; border-radius: 5px; margin-bottom: 15px; overflow: hidden;">
                    <div id="delete-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ef4444, #dc2626); transition: width 0.3s;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <span id="delete-progress-text" style="color: #6b7280;">0 of ${questionCount} questions deleted</span>
                    <span id="delete-percentage" style="color: #4f46e5; font-weight: 500;">0%</span>
                </div>
                <div id="delete-status" style="color: #6b7280; font-size: 14px; text-align: center;">Starting deletion process...</div>
            </div>
        `;
        
        // Delete using batch method for better performance
        const result = await deleteQuestionBankBatch(courseId, questionCount);
        
        if (result.success) {
            // Show success message
            const successMessage = `
                <div style="text-align: center; padding: 30px;">
                    <div style="width: 80px; height: 80px; background: #d1fae5; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-check" style="font-size: 36px; color: #10b981;"></i>
                    </div>
                    <h3 style="color: #065f46; margin-bottom: 10px;">Question Bank Deleted Successfully!</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Successfully deleted <strong>${result.deleted} questions</strong> from 
                        <strong>${courseName}</strong>.
                    </p>
                    <button onclick="closeModalAndRefresh()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-check-circle"></i> OK
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = successMessage;
            
            // Update dashboard stats
            loadDashboardStats();
            
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        console.error('Error deleting question bank:', error);
        
        const errorMessage = `
            <div style="text-align: center; padding: 30px;">
                <div style="width: 80px; height: 80px; background: #fee2e2; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle" style="font-size: 36px; color: #dc2626;"></i>
                </div>
                <h3 style="color: #dc2626; margin-bottom: 10px;">Deletion Failed</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">Error: ${error.message}</p>
                <button onclick="closeModal()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-times-circle"></i> Close
                </button>
            </div>
        `;
        
        document.getElementById('modal-content').innerHTML = errorMessage;
    }
}

// Batch delete questions with progress tracking
async function deleteQuestionBankBatch(courseId, totalQuestions) {
    const BATCH_SIZE = 100;
    let deletedCount = 0;
    let hasMore = true;
    
    try {
        // Delete in batches
        while (hasMore) {
            // Get a batch of question IDs
            const { data: batch } = await supabase
                .from('medical_assessments')
                .select('id')
                .eq('course_id', courseId)
                .limit(BATCH_SIZE);
            
            if (!batch || batch.length === 0) {
                hasMore = false;
                break;
            }
            
            // Delete the batch
            const questionIds = batch.map(q => q.id);
            const { error } = await supabase
                .from('medical_assessments')
                .delete()
                .in('id', questionIds);
            
            if (error) throw error;
            
            deletedCount += batch.length;
            
            // Update progress
            const progress = Math.min(100, Math.round((deletedCount / totalQuestions) * 100));
            document.getElementById('delete-progress-bar').style.width = `${progress}%`;
            document.getElementById('delete-percentage').textContent = `${progress}%`;
            document.getElementById('delete-progress-text').textContent = `${deletedCount} of ${totalQuestions} questions deleted`;
            document.getElementById('delete-status').textContent = `Deleted ${deletedCount} questions...`;
            
            // Small delay to show progress
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // If we got less than batch size, we're done
            if (batch.length < BATCH_SIZE) {
                hasMore = false;
            }
        }
        
        return { success: true, deleted: deletedCount };
        
    } catch (error) {
        console.error('Batch deletion error:', error);
        return { success: false, error: error.message };
    }
}

// Close modal and refresh the page
function closeModalAndRefresh() {
    closeModal();
    
    // Refresh the current page based on which one is active
    if (document.getElementById('page-manage-questions').style.display === 'block') {
        loadManageQuestionsPage();
    } else if (document.getElementById('page-manage-courses').style.display === 'block') {
        loadManageCoursesPage();
    }
}

// Bulk Delete Interface Functions
function showBulkDeleteInterface() {
    document.getElementById('bulk-delete-section').style.display = 'block';
    document.getElementById('bulk-delete-section').scrollIntoView({ behavior: 'smooth' });
}

function hideBulkDeleteInterface() {
    document.getElementById('bulk-delete-section').style.display = 'none';
}

function initializeBulkDeleteInterface() {
    const coursesList = document.getElementById('bulk-delete-courses-list');
    if (!coursesList || !window.allCourses) return;
    
    let html = '';
    window.allCourses.forEach(course => {
        html += `
            <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                <input type="checkbox" class="course-checkbox" value="${course.id}" 
                       data-name="${course.course_name}" 
                       data-count="${course.stats.totalQuestions}"
                       onchange="updateBulkDeleteSelection()"
                       style="margin-right: 12px;">
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #374151;">${course.course_name}</div>
                    <div style="display: flex; gap: 10px; margin-top: 4px;">
                        <span style="font-size: 12px; color: #6b7280;">${course.unit_code || 'No Code'}</span>
                        <span style="font-size: 12px; color: #6b7280;">‚Ä¢</span>
                        <span style="font-size: 12px; color: #ef4444; font-weight: 500;">
                            ${course.stats.totalQuestions} questions
                        </span>
                    </div>
                </div>
            </div>
        `;
    });
    
    coursesList.innerHTML = html;
}

function updateBulkDeleteSelection() {
    const checkboxes = document.querySelectorAll('.course-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    // Calculate total questions
    let totalQuestions = 0;
    checkboxes.forEach(checkbox => {
        totalQuestions += parseInt(checkbox.dataset.count) || 0;
    });
    
    // Update display
    document.getElementById('selected-count').textContent = selectedCount;
    document.getElementById('total-questions-selected').textContent = totalQuestions;
    
    // Update delete button
    const deleteBtn = document.getElementById('bulk-delete-btn');
    deleteBtn.disabled = selectedCount === 0;
    deleteBtn.style.opacity = selectedCount > 0 ? '1' : '0.5';
}

function selectAllCourses() {
    document.querySelectorAll('.course-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateBulkDeleteSelection();
}

function deselectAllCourses() {
    document.querySelectorAll('.course-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkDeleteSelection();
}

async function exportSelectedCourses() {
    const checkboxes = document.querySelectorAll('.course-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one course to export');
        return;
    }
    
    const courseIds = Array.from(checkboxes).map(cb => cb.value);
    
    try {
        const { data: questions, error } = await supabase
            .from('medical_assessments')
            .select('*, courses(course_name, unit_code)')
            .in('course_id', courseIds);
        
        if (error) throw error;
        
        if (!questions || questions.length === 0) {
            alert('No questions found in selected courses');
            return;
        }
        
        // Format for export
        const exportData = questions.map((q, index) => ({
            '#': index + 1,
            'Course': q.courses?.course_name || 'Unknown',
            'Unit Code': q.courses?.unit_code || 'N/A',
            'Question': q.question_text,
            'Correct Answer': q.correct_answer,
            'Options': q.option_a && q.option_b ? 
                `A: ${q.option_a}\nB: ${q.option_b}\nC: ${q.option_c || ''}\nD: ${q.option_d || ''}` : 
                'N/A',
            'Type': q.question_type,
            'Difficulty': q.difficulty,
            'Explanation': q.explanation || '',
            'Created': new Date(q.created_at).toLocaleDateString()
        }));
        
        // Create CSV
        const headers = ['#', 'Course', 'Unit Code', 'Question', 'Correct Answer', 'Options', 'Type', 'Difficulty', 'Explanation', 'Created'];
        const csvContent = [
            headers.join(','),
            ...exportData.map(row => 
                headers.map(header => {
                    const cell = row[header] || '';
                    const escaped = String(cell).replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                }).join(',')
            )
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const fileName = `selected_courses_export_${new Date().toISOString().split('T')[0]}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`‚úÖ Exported ${questions.length} questions from ${checkboxes.length} course(s)`);
        
    } catch (error) {
        console.error('Error exporting questions:', error);
        alert('Error exporting questions: ' + error.message);
    }
}

async function confirmBulkDelete() {
    const checkboxes = document.querySelectorAll('.course-checkbox:checked');
    if (checkboxes.length === 0) return;
    
    const courseIds = Array.from(checkboxes).map(cb => cb.value);
    const courseNames = Array.from(checkboxes).map(cb => cb.dataset.name);
    const totalQuestions = Array.from(checkboxes).reduce((sum, cb) => sum + parseInt(cb.dataset.count), 0);
    
    // Show confirmation modal
    const confirmation = `
        <div style="max-width: 600px;">
            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="color: #dc2626; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Bulk Delete Confirmation
                </h3>
                <p style="color: #7f1d1d; margin-bottom: 15px;">
                    You are about to delete <strong>${totalQuestions} questions</strong> from <strong>${courseIds.length} courses</strong>.
                </p>
                
                <div style="max-height: 200px; overflow-y: auto; margin: 15px 0; padding: 10px; background: white; border-radius: 6px; border: 1px solid #fecaca;">
                    <ul style="margin: 0; padding-left: 20px;">
                        ${courseNames.map(name => `<li style="color: #374151; margin-bottom: 5px;">${name}</li>`).join('')}
                    </ul>
                </div>
                
                <p style="color: #7f1d1d; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> This action <strong>cannot be undone</strong>. All questions will be permanently deleted.
                </p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #374151;">
                    <input type="checkbox" id="confirm-bulk-delete-checkbox" style="margin-right: 8px;">
                    I understand this action is permanent and cannot be reversed
                </label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <i class="fas fa-keyboard" style="color: #6b7280;"></i>
                    <input type="text" id="confirm-bulk-delete-text" placeholder="Type 'DELETE ALL' to confirm" 
                           style="flex: 1; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"
                           oninput="updateBulkDeleteButton()">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Cancel
                </button>
                <button id="execute-bulk-delete-btn" onclick="executeBulkDelete(['${courseIds.join("','")}'], ['${courseNames.join("','")}'], ${totalQuestions})" 
                        style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; opacity: 0.5;" disabled>
                    <i class="fas fa-trash"></i> Delete All Selected
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('modal-content').innerHTML = confirmation;
    document.getElementById('question-modal').style.display = 'flex';
}

function updateBulkDeleteButton() {
    const checkbox = document.getElementById('confirm-bulk-delete-checkbox');
    const confirmText = document.getElementById('confirm-bulk-delete-text');
    const deleteBtn = document.getElementById('execute-bulk-delete-btn');
    
    if (!checkbox || !confirmText || !deleteBtn) return;
    
    const isConfirmed = checkbox.checked && confirmText.value === 'DELETE ALL';
    
    deleteBtn.disabled = !isConfirmed;
    deleteBtn.style.opacity = isConfirmed ? '1' : '0.5';
    deleteBtn.style.cursor = isConfirmed ? 'pointer' : 'not-allowed';
}

async function executeBulkDelete(courseIds, courseNames, totalQuestions) {
    const deleteBtn = document.getElementById('execute-bulk-delete-btn');
    if (!deleteBtn || deleteBtn.disabled) return;
    
    // Disable button and show loading
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    try {
        // Show progress modal
        document.getElementById('modal-content').innerHTML = `
            <div style="max-width: 600px;">
                <h3 style="color: #374151; margin-bottom: 15px;">Bulk Deleting Questions...</h3>
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #6b7280;">Progress</span>
                        <span id="bulk-delete-percentage" style="color: #4f46e5; font-weight: 500;">0%</span>
                    </div>
                    <div style="background: #f3f4f6; height: 10px; border-radius: 5px; margin-bottom: 15px; overflow: hidden;">
                        <div id="bulk-delete-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ef4444, #dc2626); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f9fafb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span id="bulk-delete-progress-text" style="color: #6b7280;">Processing course 1 of ${courseIds.length}</span>
                        <span id="bulk-delete-stats" style="color: #ef4444; font-weight: 500;">0/${totalQuestions} questions</span>
                    </div>
                    <div id="bulk-delete-current-course" style="color: #374151; font-weight: 500;"></div>
                </div>
                
                <div id="bulk-delete-status" style="color: #6b7280; font-size: 14px; text-align: center;">Starting bulk deletion...</div>
            </div>
        `;
        
        let totalDeleted = 0;
        
        // Process each course
        for (let i = 0; i < courseIds.length; i++) {
            const courseId = courseIds[i];
            const courseName = courseNames[i];
            
            // Update current course display
            document.getElementById('bulk-delete-current-course').textContent = `Current: ${courseName}`;
            document.getElementById('bulk-delete-progress-text').textContent = `Processing course ${i + 1} of ${courseIds.length}`;
            
            // Get count for this course
            const { count } = await supabase
                .from('medical_assessments')
                .select('*', { count: 'exact', head: true })
                .eq('course_id', courseId);
            
            const courseQuestionCount = count || 0;
            
            if (courseQuestionCount > 0) {
                // Delete questions for this course
                const { error } = await supabase
                    .from('medical_assessments')
                    .delete()
                    .eq('course_id', courseId);
                
                if (error) throw error;
                
                totalDeleted += courseQuestionCount;
            }
            
            // Update overall progress
            const overallProgress = Math.min(100, Math.round(((i + 1) / courseIds.length) * 100));
            const questionProgress = Math.min(100, Math.round((totalDeleted / totalQuestions) * 100));
            
            document.getElementById('bulk-delete-progress-bar').style.width = `${overallProgress}%`;
            document.getElementById('bulk-delete-percentage').textContent = `${overallProgress}%`;
            document.getElementById('bulk-delete-stats').textContent = `${totalDeleted}/${totalQuestions} questions`;
            document.getElementById('bulk-delete-status').textContent = `Deleted ${courseName} (${courseQuestionCount} questions)...`;
            
            // Small delay
            await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        // Show success message
        const successMessage = `
            <div style="text-align: center; padding: 30px;">
                <div style="width: 80px; height: 80px; background: #d1fae5; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <i class="fas fa-check" style="font-size: 36px; color: #10b981;"></i>
                </div>
                <h3 style="color: #065f46; margin-bottom: 10px;">Bulk Deletion Complete!</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Successfully deleted <strong>${totalDeleted} questions</strong> from 
                    <strong>${courseIds.length} courses</strong>.
                </p>
                <button onclick="closeModalAndRefreshBulk()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-check-circle"></i> OK
                </button>
            </div>
        `;
        
        document.getElementById('modal-content').innerHTML = successMessage;
        
        // Update dashboard stats
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error in bulk delete:', error);
        
        const errorMessage = `
            <div style="text-align: center; padding: 30px;">
                <div style="width: 80px; height: 80px; background: #fee2e2; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle" style="font-size: 36px; color: #dc2626;"></i>
                </div>
                <h3 style="color: #dc2626; margin-bottom: 10px;">Bulk Deletion Failed</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">Error: ${error.message}</p>
                <button onclick="closeModal()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-times-circle"></i> Close
                </button>
            </div>
        `;
        
        document.getElementById('modal-content').innerHTML = errorMessage;
    }
}

function closeModalAndRefreshBulk() {
    closeModal();
    loadManageQuestionsPage();
}

// Filter courses based on search and filters
function filterCourses() {
    const searchTerm = document.getElementById('search-courses').value.toLowerCase();
    const programFilter = document.getElementById('filter-program').value;
    const statusFilter = document.getElementById('filter-status').value;
    
    const coursesGrid = document.getElementById('courses-grid');
    const noCoursesMessage = document.getElementById('no-courses-message');
    
    if (!coursesGrid || !window.allCourses) return;
    
    const filteredCourses = window.allCourses.filter(course => {
        // Search filter
        const matchesSearch = searchTerm === '' || 
            course.course_name.toLowerCase().includes(searchTerm) ||
            course.unit_code?.toLowerCase().includes(searchTerm) ||
            course.description?.toLowerCase().includes(searchTerm);
        
        // Program filter
        const matchesProgram = programFilter === '' || 
            course.target_program === programFilter ||
            (programFilter === 'ALL' && !course.target_program);
        
        // Status filter
        const matchesStatus = statusFilter === '' || 
            (statusFilter === 'active' && course.status === 'Active') ||
            (statusFilter === 'inactive' && course.status !== 'Active');
        
        return matchesSearch && matchesProgram && matchesStatus;
    });
    
    // Hide/show message
    if (filteredCourses.length === 0) {
        coursesGrid.style.display = 'none';
        if (noCoursesMessage) noCoursesMessage.style.display = 'block';
    } else {
        coursesGrid.style.display = 'grid';
        if (noCoursesMessage) noCoursesMessage.style.display = 'none';
        
        // Re-render filtered courses
        const courseCards = coursesGrid.querySelectorAll('.course-folder');
        courseCards.forEach(card => {
            const courseId = card.getAttribute('data-course-id');
            const shouldShow = filteredCourses.some(course => course.id === courseId);
            card.style.display = shouldShow ? 'block' : 'none';
        });
    }
}

// Open course folder to view questions
function openCourseFolder(courseId) {
    const course = window.allCourses?.find(c => c.id === courseId);
    if (!course) return;
    
    // Show course questions in a modal
    viewCourseQuestions(courseId);
}

// View all questions for a course
async function viewCourseQuestions(courseId) {
    const course = window.allCourses?.find(c => c.id === courseId);
    if (!course) return;
    
    try {
        // Fetch detailed questions for this course
        const { data: questions, error } = await supabase
            .from('medical_assessments')
            .select(`
                *,
                courses!inner (
                    course_name,
                    unit_code,
                    target_program
                )
            `)
            .eq('course_id', courseId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Create modal content
        const modalContent = `
            <div style="max-width: 1200px; max-height: 80vh; overflow-y: auto; padding-right: 10px;">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, ${course.color || '#4f46e5'}, ${darkenColor(course.color || '#4f46e5', 20)}); 
                           border-radius: 12px; padding: 25px; color: white; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h2 style="margin: 0; font-size: 24px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-book-medical"></i> ${course.course_name}
                            </h2>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                                    <i class="fas fa-hashtag"></i> ${course.unit_code || 'No Code'}
                                </span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                                    <i class="fas fa-graduation-cap"></i> ${course.target_program || 'All Programs'}
                                </span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                                    <i class="fas fa-file-alt"></i> ${questions?.length || 0} Questions
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Sets (Like in your image) -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #374151; margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-layer-group"></i> Question Sets
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0; color: #4f46e5; font-size: 16px;">All Questions</h4>
                                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 13px;">Complete question bank</p>
                                </div>
                                <div style="background: #4f46e5; color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                    ${questions?.length || 0}
                                </div>
                            </div>
                            <button onclick="startSession('${courseId}', 'all')" style="width: 100%; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; margin-top: 10px;">
                                <i class="fas fa-play-circle"></i> Start Session
                            </button>
                        </div>
                        
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0; color: #10b981; font-size: 16px;">Active Questions</h4>
                                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 13px;">Only published questions</p>
                                </div>
                                <div style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                    ${questions?.filter(q => q.is_active).length || 0}
                                </div>
                            </div>
                            <button onclick="startSession('${courseId}', 'active')" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; margin-top: 10px;">
                                <i class="fas fa-play-circle"></i> Start Session
                            </button>
                        </div>
                        
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0; color: #f59e0b; font-size: 16px;">Hard Questions</h4>
                                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 13px;">High difficulty level</p>
                                </div>
                                <div style="background: #f59e0b; color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                    ${questions?.filter(q => q.difficulty === 'hard').length || 0}
                                </div>
                            </div>
                            <button onclick="startSession('${courseId}', 'hard')" style="width: 100%; background: #f59e0b; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; margin-top: 10px;">
                                <i class="fas fa-play-circle"></i> Start Session
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.08); margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #374151; font-size: 18px;">
                            <i class="fas fa-list-check"></i> Questions List (${questions?.length || 0})
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportCourseQuestions('${courseId}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button onclick="addQuestionToCourse('${courseId}')" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 50px;">#</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Question</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 120px;">Type</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 100px;">Difficulty</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 80px;">Marks</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 100px;">Status</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${questions?.map((q, index) => {
                                    const difficultyColor = {
                                        'easy': '#10b981',
                                        'medium': '#f59e0b',
                                        'hard': '#ef4444'
                                    }[q.difficulty] || '#6b7280';
                                    
                                    const typeColor = {
                                        'multiple_choice': '#8b5cf6',
                                        'short_answer': '#f59e0b',
                                        'true_false': '#ef4444'
                                    }[q.question_type] || '#6b7280';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 12px; font-weight: bold; color: #6b7280;">${index + 1}</td>
                                            <td style="padding: 12px;">
                                                <div style="font-weight: 500; color: #4b5563; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    ${q.question_text || 'No question text'}
                                                </div>
                                            </td>
                                            <td style="padding: 12px;">
                                                <span style="background: ${typeColor}20; color: ${typeColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                                    ${q.question_type?.replace('_', ' ') || 'unknown'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;">
                                                <span style="color: ${difficultyColor}; font-weight: 500;">
                                                    <i class="fas fa-circle" style="font-size: 10px;"></i> ${q.difficulty || 'medium'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; font-weight: bold; color: #4f46e5;">
                                                ${q.marks || 1}
                                            </td>
                                            <td style="padding: 12px;">
                                                <span style="background: ${q.is_active ? '#d1fae5' : '#fee2e2'}; 
                                                       color: ${q.is_active ? '#065f46' : '#991b1b'}; 
                                                       padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                                    ${q.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;">
                                                <div style="display: flex; gap: 5px;">
                                                    <button onclick="viewQuestion('${q.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="editQuestion('${q.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteQuestion('${q.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') || '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">No questions found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Show in modal
        document.getElementById('modal-content').innerHTML = modalContent;
        document.getElementById('question-modal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading course questions:', error);
        alert('Error loading course questions: ' + error.message);
    }
}

// Start a question session (like in your images)
function startSession(courseId, filterType) {
    alert(`Starting ${filterType} session for course ${courseId}\n\nThis would open a practice session interface like in your images.`);
    // In a real implementation, this would redirect to a practice session page
}

// Utility functions
function getRandomColor() {
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#3b82f6', '#ec4899'];
    return colors[Math.floor(Math.random() * colors.length)];
}

function darkenColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

// Add CSS for hover effects
const courseStyle = document.createElement('style');
courseStyle.textContent = `
    .course-folder:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    }
    
    .course-folder {
        transition: all 0.3s ease;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }
`;
document.head.appendChild(courseStyle);
   async function viewQuestion(questionId) {
    // Fetch full question details
    const { data: question, error } = await supabase
        .from('medical_assessments')
        .select(`
            *,
            courses (
                course_name,
                unit_code
            )
        `)
        .eq('id', questionId)
        .single();
    
    if (error) {
        console.error('Error fetching question:', error);
        alert('Error loading question details');
        return;
    }
    
    // Show in modal
    const modalContent = `
        <div style="max-width: 600px;">
            <h3 style="color: #4f46e5; margin-bottom: 20px;">Question Details</h3>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <div style="margin-bottom: 15px;">
                    <strong>Course:</strong>
                    <div style="background: #e0e7ff; color: #4f46e5; padding: 6px 12px; border-radius: 20px; display: inline-block; margin-left: 10px;">
                        ${question.courses?.course_name || 'Unknown'} (${question.courses?.unit_code || 'No code'})
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Question:</strong>
                    <div style="padding: 15px; background: white; border-radius: 6px; margin-top: 8px; border: 1px solid #e5e7eb;">
                        ${question.question_text || 'No question text'}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Correct Answer:</strong>
                    <div style="padding: 15px; background: #d1fae5; border-radius: 6px; margin-top: 8px; border: 1px solid #10b981;">
                        ${question.correct_answer || 'No answer'}
                    </div>
                </div>
                
                ${question.explanation ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Explanation:</strong>
                        <div style="padding: 15px; background: #fef3c7; border-radius: 6px; margin-top: 8px;">
                            ${question.explanation}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>Type:</strong>
                        <div style="margin-top: 5px;">${question.question_type?.replace('_', ' ') || 'Unknown'}</div>
                    </div>
                    <div>
                        <strong>Difficulty:</strong>
                        <div style="margin-top: 5px;">${question.difficulty || 'Medium'}</div>
                    </div>
                    <div>
                        <strong>Marks:</strong>
                        <div style="margin-top: 5px;">${question.marks || 1}</div>
                    </div>
                    <div>
                        <strong>Created:</strong>
                        <div style="margin-top: 5px;">${question.created_at ? new Date(question.created_at).toLocaleDateString() : 'Unknown'}</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('modal-content').innerHTML = modalContent;
    document.getElementById('question-modal').style.display = 'flex';
}     
  // ==================== QUESTION DELETION FUNCTIONS ====================

// Function for deleting questions from Manage Questions page
async function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('medical_assessments')
            .delete()
            .eq('id', questionId);
        
        if (error) throw error;
        
        alert('‚úÖ Question deleted successfully!');
        loadManageQuestionsPage();
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error deleting question:', error);
        alert('Error deleting question: ' + error.message);
    }
}

// Function for deleting generated questions (if needed)
async function deleteGeneratedQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this generated question?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('medical_assessments')
            .delete()
            .eq('id', questionId);
        
        if (error) throw error;
        
        alert('‚úÖ Generated question deleted successfully!');
        
        // If we're on the generate questions page, refresh it
        if (document.getElementById('page-generate-questions').style.display === 'block') {
            // Find and remove the question from generatedQuestions array
            const index = generatedQuestions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                generatedQuestions.splice(index, 1);
                displayGeneratedQuestions();
            }
        }
        
        loadDashboardStats();
        
    } catch (error) {
        console.error('Error deleting generated question:', error);
        alert('Error deleting question: ' + error.message);
    }
}

// Function for editing generated questions
function editGeneratedQuestion(index) {
    const question = generatedQuestions[index];
    
    // Simple edit using prompt for quick editing
    const newQuestion = prompt('Edit the question:', question.question);
    if (newQuestion !== null) {
        const newAnswer = prompt('Edit the correct answer:', question.answer);
        if (newAnswer !== null) {
            generatedQuestions[index].question = newQuestion;
            generatedQuestions[index].answer = newAnswer;
            
            // If it has options, offer to edit them
            if (question.options && question.options.length > 0) {
                const newOptions = prompt('Edit options (separate by commas):', question.options.join(', '));
                if (newOptions !== null) {
                    generatedQuestions[index].options = newOptions.split(',').map(opt => opt.trim()).filter(opt => opt);
                }
            }
            
            displayGeneratedQuestions();
            alert('Question updated! Remember to save it.');
        }
    }
}
        async function loadManageStudentsPage() {
            const contentDiv = document.getElementById('students-management-content');
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';
            
            try {
                // REAL DATABASE: Fetch students from consolidated_user_profiles_table
                const { data: students, error } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .order('full_name')
                    .limit(100);
                
                if (error) throw error;
                
                if (!students || students.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="background: white; padding: 40px; border-radius: 10px; text-align: center;">
                            <i class="fas fa-users" style="font-size: 48px; color: #e5e7eb;"></i>
                            <h3 style="color: #6b7280;">No students found</h3>
                            <p style="color: #9ca3af;">Students will appear here when they register</p>
                        </div>
                    `;
                    return;
                }
                
                // Get student progress data
                const studentIds = students.map(s => s.id);
                const { data: progressData } = await supabase
                    .from('user_assessment_progress')
                    .select('user_id, is_correct')
                    .in('user_id', studentIds);
                
                // Calculate stats for each student
                const studentsWithStats = students.map(student => {
                    const studentProgress = progressData?.filter(p => p.user_id === student.id) || [];
                    const completed = studentProgress.length;
                    const correct = studentProgress.filter(p => p.is_correct).length;
                    const accuracy = completed > 0 ? Math.round((correct / completed) * 100) : 0;
                    
                    return {
                        ...student,
                        completed,
                        accuracy,
                        last_active: student.updated_at || student.created_at
                    };
                });
                
                // Render students table
                const tableHtml = `
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">${studentsWithStats.length} Students</h3>
                            <button onclick="loadManageStudentsPage()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div style="color: #3b82f6; font-size: 24px; font-weight: bold;">${studentsWithStats.length}</div>
                                <div style="color: #666; font-size: 14px;">Total Students</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="color: #10b981; font-size: 24px; font-weight: bold;">${studentsWithStats.filter(s => s.role === 'student').length}</div>
                                <div style="color: #666; font-size: 14px;">Regular Students</div>
                            </div>
                            <div style="background: #faf5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="color: #8b5cf6; font-size: 24px; font-weight: bold;">
                                    ${studentsWithStats.length > 0 ? 
                                        Math.round(studentsWithStats.reduce((sum, s) => sum + s.accuracy, 0) / studentsWithStats.length) : 0}%
                                </div>
                                <div style="color: #666; font-size: 14px;">Average Accuracy</div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Student</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Program</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Completed</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Accuracy</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Role</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${studentsWithStats.map(student => {
                                        const accuracyColor = student.accuracy >= 90 ? '#10b981' : 
                                                            student.accuracy >= 75 ? '#f59e0b' : '#ef4444';
                                        
                                        const roleColor = student.role === 'admin' ? '#ef4444' : 
                                                         student.role === 'superadmin' ? '#8b5cf6' : '#3b82f6';
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                                <td style="padding: 12px;">
                                                    <div style="display: flex; align-items: center; gap: 12px;">
                                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, ${roleColor}, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                            ${student.full_name ? student.full_name.charAt(0).toUpperCase() : 'S'}
                                                        </div>
                                                        <div>
                                                            <div style="font-weight: 500;">${student.full_name || 'Unknown Student'}</div>
                                                            <div style="font-size: 12px; color: #6b7280;">${student.email || 'No email'}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 12px;">
                                                    <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                                        ${student.program || 'Unknown'}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px; font-weight: 500;">
                                                    ${student.completed || 0}
                                                </td>
                                                <td style="padding: 12px;">
                                                    <span style="color: ${accuracyColor}; font-weight: bold;">
                                                        ${student.accuracy || 0}%
                                                    </span>
                                                </td>
                                                <td style="padding: 12px;">
                                                    <span style="background: ${roleColor === '#ef4444' ? '#fee2e2' : roleColor === '#8b5cf6' ? '#f5f3ff' : '#dbeafe'}; 
                                                           color: ${roleColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                                        ${student.role || 'student'}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px;">
                                                    <span style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                                        Active
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = tableHtml;
                
            } catch (error) {
                console.error('Error loading students:', error);
                contentDiv.innerHTML = `
                    <div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">
                        <i class="fas fa-exclamation-circle"></i> Error loading students: ${error.message}
                    </div>
                `;
            }
        }
        
        async function loadManageCoursesPage() {
            const contentDiv = document.getElementById('courses-management-content');
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading courses...</div>';
            
            try {
                const { data: courses, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('course_name');
                
                if (error) throw error;
                
                if (!courses || courses.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="background: white; padding: 40px; border-radius: 10px; text-align: center;">
                            <i class="fas fa-book" style="font-size: 48px; color: #e5e7eb;"></i>
                            <h3 style="color: #6b7280;">No courses found</h3>
                            <p style="color: #9ca3af;">Add your first course using the "Create Question" page</p>
                        </div>
                    `;
                    return;
                }
                
                // Get question counts for each course
                const courseStats = await Promise.all(courses.map(async (course) => {
                    const { count } = await supabase
                        .from('medical_assessments')
                        .select('*', { count: 'exact', head: true })
                        .eq('course_id', course.id);
                    
                    return {
                        ...course,
                        question_count: count || 0
                    };
                }));
                
                // Render courses table
                const tableHtml = `
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">${courseStats.length} Courses</h3>
                            <div>
                                <button onclick="addNewCourse()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                    <i class="fas fa-plus"></i> Add Course
                                </button>
                                <button onclick="loadManageCoursesPage()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            ${courseStats.map(course => `
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${course.color || '#4f46e5'};"></div>
                                        <h4 style="margin: 0; flex: 1;">${course.course_name}</h4>
                                    </div>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">${course.unit_code || 'No code'}</div>
                                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${course.target_program || 'All programs'}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                            ${course.question_count} questions
                                        </span>
                                        <span style="background: ${course.status === 'Active' ? '#d1fae5' : '#fee2e2'}; 
                                               color: ${course.status === 'Active' ? '#065f46' : '#991b1b'}; 
                                               padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                            ${course.status || 'Unknown'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Course Name</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Unit Code</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Program</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Questions</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${courseStats.map(course => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px;">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${course.color || '#4f46e5'};"></div>
                                                    <div style="font-weight: 500;">${course.course_name}</div>
                                                </div>
                                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${course.description || 'No description'}</div>
                                            </td>
                                            <td style="padding: 12px;">
                                                <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                                    ${course.unit_code || 'N/A'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;">
                                                ${course.target_program || 'All'}
                                            </td>
                                            <td style="padding: 12px; font-weight: 500; color: #4f46e5;">
                                                ${course.question_count}
                                            </td>
                                            <td style="padding: 12px;">
                                                <span style="background: ${course.status === 'Active' ? '#d1fae5' : '#fee2e2'}; 
                                                       color: ${course.status === 'Active' ? '#065f46' : '#991b1b'}; 
                                                       padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                                    ${course.status || 'Unknown'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px;">
                                                <div style="display: flex; gap: 5px;">
                                                    <button onclick="editCourse('${course.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="toggleCourseStatus('${course.id}')" style="background: ${course.status === 'Active' ? '#ef4444' : '#10b981'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                        <i class="fas fa-power-off"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = tableHtml;
                
            } catch (error) {
                console.error('Error loading courses:', error);
                contentDiv.innerHTML = `
                    <div style="background: #fee; color: #c00; padding: 20px; border-radius: 10px;">
                        <i class="fas fa-exclamation-circle"></i> Error loading courses: ${error.message}
                    </div>
                `;
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function closeModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .fa-spin {
                animation: spin 1s linear infinite;
            }
            input[type="file"] {
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                width: 100%;
            }
        `;
        document.head.appendChild(style);
        
        console.log('‚úÖ NurseIQ Admin (Real Database) ready!');
    </script>
</body>
</html>
