<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NurseIQ Admin - Simple</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Simple Container -->
    <div id="app">
        <!-- Login Section (Shown first) -->
        <div id="login-section">
            <div style="text-align: center; padding: 50px 20px;">
                <h1><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                <p style="color: #666; margin-bottom: 30px;">Simple question management for nursing students</p>
                
                <div style="max-width: 400px; margin: 0 auto; background: #f8f9fa; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 20px;">Admin Login</h2>
                    
                    <div id="login-error" style="background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
                    </div>
                    
                    <form id="login-form">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                            <input type="email" id="login-email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="admin@example.com" required>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password</label>
                            <input type="password" id="login-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        
                        <button type="submit" id="login-button" style="width: 100%; background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 16px; cursor: pointer;">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        <p><i class="fas fa-info-circle"></i> Use any email/password for demo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard (Hidden initially) -->
        <div id="admin-section" style="display: none;">
            <!-- Header -->
            <div style="background: #4f46e5; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; font-size: 24px;"><i class="fas fa-stethoscope"></i> NurseIQ Admin</h1>
                    <p style="margin: 5px 0 0 0; opacity: 0.8;">Simple Question Management</p>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="user-info" style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
                        <i class="fas fa-user"></i> <span id="user-name">Admin</span>
                    </div>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div style="display: flex; min-height: calc(100vh - 80px);">
                <!-- Sidebar -->
                <div style="width: 250px; background: #f8f9fa; padding: 20px;">
                    <h3 style="margin-top: 0; color: #4f46e5;"><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    <div style="margin-bottom: 30px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #4f46e5; font-size: 24px; margin-bottom: 5px;" id="total-questions">0</div>
                            <div style="color: #666; font-size: 14px;">Total Questions</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="color: #10b981; font-size: 24px; margin-bottom: 5px;" id="active-students">0</div>
                            <div style="color: #666; font-size: 14px;">Active Students</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #666; margin-bottom: 10px;">Quick Actions</h4>
                    <button onclick="showPage('create-question')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-plus-circle" style="color: #4f46e5;"></i> Create Question
                    </button>
                    <button onclick="showPage('ai-generate')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-robot" style="color: #10b981;"></i> AI Generate
                    </button>
                    <button onclick="showPage('view-questions')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-list" style="color: #f59e0b;"></i> View Questions
                    </button>
                    <button onclick="showPage('upload')" style="width: 100%; text-align: left; background: white; border: 1px solid #e5e7eb; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-upload" style="color: #3b82f6;"></i> Upload CSV
                    </button>
                </div>

                <!-- Main Panel -->
                <div style="flex: 1; padding: 20px;">
                    <!-- Page: Create Question -->
                    <div id="page-create-question" class="page">
                        <h2><i class="fas fa-plus-circle"></i> Create New Question</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <form id="question-form">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Question Text *</label>
                                    <textarea id="question-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px;" 
                                              placeholder="Enter your nursing question..." required></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Topic/Category</label>
                                        <select id="question-topic" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <option value="anatomy">Anatomy</option>
                                            <option value="physiology">Physiology</option>
                                            <option value="pharmacology">Pharmacology</option>
                                            <option value="nursing_care">Nursing Care</option>
                                            <option value="ethics">Ethics</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty</label>
                                        <select id="question-difficulty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Correct Answer *</label>
                                    <input type="text" id="correct-answer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                           placeholder="Enter the correct answer..." required>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Explanation</label>
                                    <textarea id="question-explanation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 60px;" 
                                              placeholder="Explain why this answer is correct..."></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="saveQuestion()" style="background: #4f46e5; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-save"></i> Save Question
                                    </button>
                                    <button type="button" onclick="resetQuestionForm()" style="background: #6b7280; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-redo"></i> Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Page: AI Generate -->
                    <div id="page-ai-generate" class="page" style="display: none;">
                        <h2><i class="fas fa-robot"></i> AI Question Generator</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Generate questions about:</label>
                                <input type="text" id="ai-topic" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                       placeholder="e.g., Cardiac Nursing, Pharmacology, Pediatric Care...">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of questions:</label>
                                <select id="ai-count" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="1">1 question</option>
                                    <option value="5" selected>5 questions</option>
                                    <option value="10">10 questions</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty level:</label>
                                <select id="ai-difficulty" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            
                            <button onclick="generateAIQuestions()" id="ai-generate-btn" style="background: #10b981; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-magic"></i> Generate Questions
                            </button>
                            
                            <div id="ai-loading" style="display: none; margin-top: 20px; text-align: center;">
                                <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; margin: 0 auto 10px; animation: spin 1s linear infinite;"></div>
                                <p>Generating questions with AI...</p>
                            </div>
                            
                            <div id="ai-results" style="margin-top: 30px; display: none;">
                                <h3>Generated Questions</h3>
                                <div id="ai-questions-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: View Questions -->
                    <div id="page-view-questions" class="page" style="display: none;">
                        <h2><i class="fas fa-list"></i> View Questions</h2>
                        
                        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                            <input type="text" id="search-questions" placeholder="Search questions..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <button onclick="loadQuestions()" style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="questions-table" style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e5e7eb;">ID</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e5e7eb;">Question</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e5e7eb;">Topic</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e5e7eb;">Difficulty</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e5e7eb;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="questions-list">
                                    <tr>
                                        <td colspan="5" style="padding: 30px; text-align: center; color: #666;">No questions yet. Create your first question!</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Page: Upload CSV -->
                    <div id="page-upload" class="page" style="display: none;">
                        <h2><i class="fas fa-upload"></i> Upload Questions CSV</h2>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="margin-bottom: 20px;">
                                <h3>Upload CSV File</h3>
                                <p style="color: #666; margin-bottom: 15px;">Upload a CSV file with questions. Format: question,correct_answer,topic,difficulty,explanation</p>
                                
                                <input type="file" id="csv-file" accept=".csv" style="margin-bottom: 15px;">
                                
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                    <h4 style="margin-top: 0;">CSV Format Example:</h4>
                                    <pre style="background: white; padding: 10px; border-radius: 5px; overflow-x: auto;">
question,correct_answer,topic,difficulty,explanation
"What is the normal heart rate for adults?","60-100 bpm","physiology","easy","Normal adult resting heart rate ranges from 60-100 beats per minute."
"What drug class is Metformin?","Biguanide","pharmacology","medium","Metformin is an oral biguanide used for type 2 diabetes."</pre>
                                </div>
                                
                                <button onclick="uploadCSV()" style="background: #3b82f6; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-upload"></i> Upload CSV
                                </button>
                            </div>
                            
                            <div id="upload-results" style="display: none;">
                                <h3>Upload Results</h3>
                                <div id="upload-stats"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Modal for Viewing Questions -->
    <div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Question Details</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
        
        // ==================== GLOBAL VARIABLES ====================
        let supabase = null;
        let currentUser = null;
        let allQuestions = [];
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Starting Simple NurseIQ Admin...');
            
            // Initialize Supabase
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false }
                });
                console.log('‚úÖ Supabase connected');
            } catch (error) {
                console.error('‚ùå Supabase error:', error);
            }
            
            // Check if already logged in
            checkLoginStatus();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // ==================== AUTHENTICATION ====================
        function checkLoginStatus() {
            const userData = localStorage.getItem('nurseiq_simple_admin');
            
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    showAdminDashboard();
                    loadDashboardStats();
                    loadQuestions();
                } catch (e) {
                    console.log('Invalid session data');
                    localStorage.removeItem('nurseiq_simple_admin');
                }
            }
        }
        
        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            // Show loading
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // For demo, accept any email/password
                // In real app, verify with Supabase
                const userData = {
                    email: email,
                    full_name: email.split('@')[0],
                    role: 'admin',
                    timestamp: new Date().toISOString()
                };
                
                // Store in localStorage
                localStorage.setItem('nurseiq_simple_admin', JSON.stringify(userData));
                currentUser = userData;
                
                // Show success message
                document.getElementById('success-message').textContent = 'Login successful!';
                document.getElementById('login-success').style.display = 'block';
                
                // Wait a bit then show admin
                setTimeout(() => {
                    showAdminDashboard();
                    loadDashboardStats();
                    loadQuestions();
                }, 1000);
                
            } catch (error) {
                document.getElementById('error-message').textContent = error.message || 'Login failed';
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-button').disabled = false;
                document.getElementById('login-button').innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        });
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('nurseiq_simple_admin');
                currentUser = null;
                showLoginPage();
            }
        }
        
        function showLoginPage() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-section').style.display = 'none';
        }
        
        function showAdminDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            
            // Update user info
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.full_name || currentUser.email || 'Admin';
            }
            
            // Show first page
            showPage('create-question');
        }
        
        // ==================== QUESTION MANAGEMENT ====================
        async function saveQuestion() {
            const questionText = document.getElementById('question-text').value.trim();
            const correctAnswer = document.getElementById('correct-answer').value.trim();
            const topic = document.getElementById('question-topic').value;
            const difficulty = document.getElementById('question-difficulty').value;
            const explanation = document.getElementById('question-explanation').value.trim();
            
            if (!questionText || !correctAnswer) {
                alert('Please fill in question and correct answer');
                return;
            }
            
            try {
                const questionData = {
                    question_text: questionText,
                    correct_answer: correctAnswer,
                    topic: topic,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    created_at: new Date().toISOString(),
                    created_by: currentUser?.email || 'admin'
                };
                
                // Try to save to Supabase if available
                if (supabase) {
                    const { error } = await supabase
                        .from('medical_assessments')
                        .insert([questionData]);
                    
                    if (error) throw error;
                }
                
                // Also save locally
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                localQuestions.push({
                    id: 'local_' + Date.now(),
                    ...questionData
                });
                localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
                
                alert('‚úÖ Question saved successfully!');
                resetQuestionForm();
                loadQuestions();
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Error saving question. Saved locally only.');
                
                // Save locally as fallback
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                localQuestions.push({
                    id: 'local_' + Date.now(),
                    question_text: questionText,
                    correct_answer: correctAnswer,
                    topic: topic,
                    difficulty: difficulty,
                    explanation: explanation || null,
                    created_at: new Date().toISOString(),
                    created_by: currentUser?.email || 'admin'
                });
                localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
                
                alert('‚úÖ Question saved locally!');
                resetQuestionForm();
                loadQuestions();
                loadDashboardStats();
            }
        }
        
        function resetQuestionForm() {
            document.getElementById('question-form').reset();
        }
        
        async function loadQuestions() {
            try {
                let questions = [];
                
                // Try to load from Supabase
                if (supabase) {
                    const { data, error } = await supabase
                        .from('medical_assessments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (!error && data) {
                        questions = data;
                    }
                }
                
                // Also load from local storage
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                
                // Combine and deduplicate
                const allQuestionsMap = new Map();
                
                // Add Supabase questions first
                questions.forEach(q => allQuestionsMap.set(q.id, q));
                
                // Add local questions (they won't overwrite Supabase ones with same id)
                localQuestions.forEach(q => {
                    if (!allQuestionsMap.has(q.id)) {
                        allQuestionsMap.set(q.id, q);
                    }
                });
                
                allQuestions = Array.from(allQuestionsMap.values());
                
                // Sort by date
                allQuestions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Update UI
                updateQuestionsTable(allQuestions);
                
            } catch (error) {
                console.error('Error loading questions:', error);
                
                // Fallback to local storage only
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                allQuestions = localQuestions;
                updateQuestionsTable(allQuestions);
            }
        }
        
        function updateQuestionsTable(questions) {
            const tbody = document.getElementById('questions-list');
            
            if (questions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="padding: 30px; text-align: center; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: #e5e7eb; margin-bottom: 10px; display: block;"></i>
                            No questions yet. Create your first question!
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = questions.map(q => {
                const difficultyColor = {
                    'easy': '#10b981',
                    'medium': '#f59e0b',
                    'hard': '#ef4444'
                }[q.difficulty] || '#6b7280';
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 15px;">${q.id.substring(0, 8)}...</td>
                        <td style="padding: 15px;">${q.question_text.substring(0, 80)}${q.question_text.length > 80 ? '...' : ''}</td>
                        <td style="padding: 15px;">
                            <span style="background: #f3f4f6; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                ${q.topic || 'General'}
                            </span>
                        </td>
                        <td style="padding: 15px;">
                            <span style="color: ${difficultyColor}; font-weight: bold;">
                                ${q.difficulty}
                            </span>
                        </td>
                        <td style="padding: 15px;">
                            <button onclick="viewQuestion('${q.id}')" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteQuestion('${q.id}')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function deleteQuestion(questionId) {
            if (!confirm('Delete this question?')) return;
            
            try {
                // Try to delete from Supabase
                if (supabase && !questionId.startsWith('local_')) {
                    const { error } = await supabase
                        .from('medical_assessments')
                        .delete()
                        .eq('id', questionId);
                    
                    if (error) throw error;
                }
                
                // Delete from local storage
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                const updatedQuestions = localQuestions.filter(q => q.id !== questionId);
                localStorage.setItem('nurseiq_questions', JSON.stringify(updatedQuestions));
                
                // Update UI
                allQuestions = allQuestions.filter(q => q.id !== questionId);
                updateQuestionsTable(allQuestions);
                loadDashboardStats();
                
                alert('‚úÖ Question deleted');
                
            } catch (error) {
                console.error('Error deleting question:', error);
                
                // Delete from local only
                const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                const updatedQuestions = localQuestions.filter(q => q.id !== questionId);
                localStorage.setItem('nurseiq_questions', JSON.stringify(updatedQuestions));
                
                allQuestions = allQuestions.filter(q => q.id !== questionId);
                updateQuestionsTable(allQuestions);
                loadDashboardStats();
                
                alert('‚úÖ Question deleted locally');
            }
        }
        
        function viewQuestion(questionId) {
            const question = allQuestions.find(q => q.id === questionId);
            if (!question) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #4f46e5;">Question:</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 5px;">${question.question_text}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #10b981;">Correct Answer:</h4>
                    <p style="background: #f0fdf4; padding: 15px; border-radius: 5px; border-left: 4px solid #10b981;">
                        ${question.correct_answer}
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #666;">Topic:</h4>
                        <p>${question.topic || 'Not specified'}</p>
                    </div>
                    <div>
                        <h4 style="color: #666;">Difficulty:</h4>
                        <p><span style="color: ${question.difficulty === 'easy' ? '#10b981' : question.difficulty === 'medium' ? '#f59e0b' : '#ef4444'}; font-weight: bold;">
                            ${question.difficulty}
                        </span></p>
                    </div>
                </div>
                
                ${question.explanation ? `
                <div>
                    <h4 style="color: #666;">Explanation:</h4>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 5px;">${question.explanation}</p>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 12px;">
                    Created: ${new Date(question.created_at).toLocaleDateString()}
                    ${question.created_by ? `<br>By: ${question.created_by}` : ''}
                </div>
            `;
            
            document.getElementById('question-modal').style.display = 'flex';
        }
        
        // ==================== AI QUESTION GENERATION ====================
        async function generateAIQuestions() {
            const topic = document.getElementById('ai-topic').value.trim();
            const count = parseInt(document.getElementById('ai-count').value);
            const difficulty = document.getElementById('ai-difficulty').value;
            
            if (!topic) {
                alert('Please enter a topic for AI to generate questions about');
                return;
            }
            
            // Show loading
            document.getElementById('ai-generate-btn').disabled = true;
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-results').style.display = 'none';
            
            try {
                // Mock AI generation (in real app, call an AI API)
                // Here we'll create sample questions based on the topic
                const generatedQuestions = [];
                
                for (let i = 0; i < count; i++) {
                    generatedQuestions.push({
                        question_text: `Sample question about ${topic} ${i + 1}: What is an important concept?`,
                        correct_answer: `Sample correct answer for ${topic}`,
                        explanation: `This is a sample explanation about ${topic}.`,
                        topic: topic.toLowerCase(),
                        difficulty: difficulty
                    });
                }
                
                // Show results
                document.getElementById('ai-questions-list').innerHTML = generatedQuestions.map((q, index) => `
                    <div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #4f46e5;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <strong>Question ${index + 1}:</strong>
                            <button onclick="saveAIGeneratedQuestion(${index})" style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                        <p style="margin-bottom: 10px;">${q.question_text}</p>
                        <p style="color: #10b981; margin-bottom: 5px;"><strong>Answer:</strong> ${q.correct_answer}</p>
                        <p style="color: #666; font-size: 14px;"><strong>Explanation:</strong> ${q.explanation}</p>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                            <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 10px; margin-right: 10px;">${q.topic}</span>
                            <span style="color: ${q.difficulty === 'easy' ? '#10b981' : q.difficulty === 'medium' ? '#f59e0b' : '#ef4444'}">${q.difficulty}</span>
                        </div>
                    </div>
                `).join('');
                
                // Store generated questions for saving
                window.generatedAIQuestions = generatedQuestions;
                
                // Show results
                document.getElementById('ai-results').style.display = 'block';
                
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating questions. Please try again.');
            } finally {
                document.getElementById('ai-generate-btn').disabled = false;
                document.getElementById('ai-loading').style.display = 'none';
            }
        }
        
        function saveAIGeneratedQuestion(index) {
            if (!window.generatedAIQuestions || !window.generatedAIQuestions[index]) return;
            
            const question = window.generatedAIQuestions[index];
            
            // Save to database
            const questionData = {
                question_text: question.question_text,
                correct_answer: question.correct_answer,
                topic: question.topic,
                difficulty: question.difficulty,
                explanation: question.explanation,
                created_at: new Date().toISOString(),
                created_by: currentUser?.email || 'admin',
                ai_generated: true
            };
            
            // Save locally
            const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
            localQuestions.push({
                id: 'ai_' + Date.now() + '_' + index,
                ...questionData
            });
            localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
            
            alert('‚úÖ Question saved!');
            loadQuestions();
            loadDashboardStats();
        }
        
        // ==================== CSV UPLOAD ====================
        function uploadCSV() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const rows = csvText.split('\n');
                    
                    let savedCount = 0;
                    let errorCount = 0;
                    
                    // Skip header row
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i].trim();
                        if (!row) continue;
                        
                        const columns = row.split(',').map(col => col.trim());
                        
                        if (columns.length >= 2) {
                            const questionData = {
                                question_text: columns[0],
                                correct_answer: columns[1],
                                topic: columns[2] || 'General',
                                difficulty: columns[3] || 'medium',
                                explanation: columns[4] || '',
                                created_at: new Date().toISOString(),
                                created_by: currentUser?.email || 'admin',
                                csv_import: true
                            };
                            
                            // Save locally
                            const localQuestions = JSON.parse(localStorage.getItem('nurseiq_questions') || '[]');
                            localQuestions.push({
                                id: 'csv_' + Date.now() + '_' + i,
                                ...questionData
                            });
                            localStorage.setItem('nurseiq_questions', JSON.stringify(localQuestions));
                            
                            savedCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    // Show results
                    document.getElementById('upload-stats').innerHTML = `
                        <div style="background: ${errorCount > 0 ? '#fef3f2' : '#f0fdf4'}; padding: 15px; border-radius: 5px;">
                            <h4 style="margin-top: 0;">Upload Complete</h4>
                            <p>‚úÖ Successfully imported: ${savedCount} questions</p>
                            ${errorCount > 0 ? `<p>‚ùå Failed to import: ${errorCount} rows (invalid format)</p>` : ''}
                        </div>
                    `;
                    
                    document.getElementById('upload-results').style.display = 'block';
                    
                    // Refresh questions
                    loadQuestions();
                    loadDashboardStats();
                    
                } catch (error) {
                    console.error('CSV parse error:', error);
                    alert('Error parsing CSV file. Check the format.');
                }
            };
            
            reader.readAsText(file);
        }
        
        // ==================== DASHBOARD FUNCTIONS ====================
        async function loadDashboardStats() {
            try {
                // Count questions
                const totalQuestions = allQuestions.length;
                document.getElementById('total-questions').textContent = totalQuestions;
                
                // Count active students (mock)
                const activeStudents = Math.min(totalQuestions * 2, 100);
                document.getElementById('active-students').textContent = activeStudents;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // ==================== UI HELPER FUNCTIONS ====================
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById('page-' + pageName).style.display = 'block';
            
            // Update active button style (optional)
        }
        
        function closeModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        function setupEventListeners() {
            // Search questions
            document.getElementById('search-questions').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filtered = allQuestions.filter(q => 
                    q.question_text.toLowerCase().includes(searchTerm) ||
                    (q.topic && q.topic.toLowerCase().includes(searchTerm)) ||
                    (q.explanation && q.explanation.toLowerCase().includes(searchTerm))
                );
                updateQuestionsTable(filtered);
            });
            
            // Close modal on background click
            document.getElementById('question-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Close modal on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }
        
        // Add CSS animation for loader
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .alert-success {
                background: #d1fae5;
                color: #065f46;
                padding: 12px;
                border-radius: 6px;
                border: 1px solid #a7f3d0;
            }
        `;
        document.head.appendChild(style);
        
        // Initialize
        console.log('‚úÖ Simple NurseIQ Admin ready!');
    </script>
</body>
</html>
