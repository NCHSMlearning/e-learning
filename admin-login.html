<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NurseIQ Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
    <!-- Loader -->
    <div id="config-loader">
        <div class="loader-spinner"></div>
        <h2>NurseIQ Admin Panel</h2>
        <p id="loader-message">Initializing...</p>
    </div>
    
    <!-- Login Overlay -->
    <div id="login-overlay" class="login-overlay" style="display: none;">
        <div class="login-container">
            <div class="login-box">
                <h2><i class="fas fa-lock"></i> Authentication Required</h2>
                <p>You need to login to access the admin panel.</p>
                <button onclick="redirectToLoginPage()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Go to Login Page
                </button>
                
                <!-- Debug Section -->
                <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                    <p style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">Debug Options:</p>
                    <button onclick="debugAuth()" class="btn btn-outline" style="margin-bottom: 10px; width: 100%;">
                        <i class="fas fa-bug"></i> Debug Authentication
                    </button>
                    <button onclick="forceLogin()" class="btn btn-outline" style="width: 100%;">
                        <i class="fas fa-user-secret"></i> Force Login (Dev)
                    </button>
                </div>
                
                <p class="login-note">Requires admin or superadmin privileges</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="admin-container" style="display: none;">
        <!-- Header -->
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-stethoscope"></i> NurseIQ Admin Panel</h1>
                <p class="text-muted">Manage assessments, courses, and user progress</p>
            </div>
            
            <!-- User Profile Section -->
            <div class="user-profile-section" id="user-profile-section">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="user-name">Loading...</div>
                        <div class="user-role" id="user-role">Admin</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-profile" onclick="admin.showProfileModal()" title="Profile">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="btn-logout" onclick="admin.logout()" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profile-modal" class="modal">
            <div class="modal-content modal-sm">
                <div class="modal-header">
                    <h3><i class="fas fa-user-circle"></i> User Profile</h3>
                    <button class="modal-close" onclick="admin.closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-info">
                        <div class="profile-avatar-large" id="profile-avatar">A</div>
                        <div class="profile-details">
                            <h4 id="profile-name">Loading...</h4>
                            <div class="profile-role-badge" id="profile-role-badge">Admin</div>
                            <div class="profile-info-item">
                                <i class="fas fa-envelope"></i>
                                <span id="profile-email">loading...</span>
                            </div>
                            <div class="profile-info-item">
                                <i class="fas fa-graduation-cap"></i>
                                <span id="profile-program">loading...</span>
                            </div>
                            <div class="profile-info-item">
                                <i class="fas fa-calendar"></i>
                                <span id="profile-last-login">loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="admin.closeModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="admin-tab" data-tab="assessments">
                <i class="fas fa-clipboard-list"></i> Assessments
            </button>
            <button class="admin-tab" data-tab="courses">
                <i class="fas fa-book-medical"></i> Courses
            </button>
            <button class="admin-tab" data-tab="users">
                <i class="fas fa-users"></i> Users
            </button>
            <button class="admin-tab" data-tab="settings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="admin-tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-assessments">0</h3>
                        <p>Total Assessments</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-courses">0</h3>
                        <p>Active Courses</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="active-users">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="completion-rate">0%</h3>
                        <p>Avg. Completion</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-btn" onclick="openAddAssessmentModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New Assessment</span>
                    </button>
                    <button class="action-btn" onclick="openAddCourseModal()">
                        <i class="fas fa-book-medical"></i>
                        <span>Add New Course</span>
                    </button>
                    <button class="action-btn" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i>
                        <span>Generate Report</span>
                    </button>
                    <button class="action-btn" onclick="testConnection()">
                        <i class="fas fa-plug"></i>
                        <span>Test Connection</span>
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div id="activity-list" class="activity-list">
                    <div class="activity-item">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading recent activity...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessments Tab -->
        <div id="assessments-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-clipboard-list"></i> Manage Assessments</h2>
                <div>
                    <button class="btn btn-primary" onclick="openAddAssessmentModal()">
                        <i class="fas fa-plus"></i> Add Assessment
                    </button>
                    <button class="btn btn-outline" onclick="refreshAssessments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="filters">
                <input type="text" id="search-assessments" placeholder="Search assessments..." class="search-input">
                <select id="filter-course" class="filter-select">
                    <option value="all">All Courses</option>
                </select>
                <select id="filter-difficulty" class="filter-select">
                    <option value="all">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="filter-status" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>

            <div class="table-responsive">
                <table id="assessments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Question</th>
                            <th>Course</th>
                            <th>Difficulty</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading assessments...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Courses Tab -->
        <div id="courses-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-book-medical"></i> Manage Courses</h2>
                <div>
                    <button class="btn btn-primary" onclick="openAddCourseModal()">
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                    <button class="btn btn-outline" onclick="refreshCourses()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="courses-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Course Name</th>
                            <th>Unit Code</th>
                            <th>Program</th>
                            <th>Intake Year</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading courses...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="admin-tab-content">
            <div class="table-header">
                <h2><i class="fas fa-users"></i> User Progress</h2>
                <div>
                    <input type="text" id="search-users" placeholder="Search users..." class="search-input">
                    <button class="btn btn-outline" onclick="refreshUsers()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Program</th>
                            <th>Completed</th>
                            <th>Accuracy</th>
                            <th>Avg Time</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="admin-tab-content">
            <div class="settings-grid">
                <div class="settings-card">
                    <h3><i class="fas fa-database"></i> Database Connection</h3>
                    <div class="connection-info">
                        <div class="info-item">
                            <label>Status:</label>
                            <span id="connection-status" class="status-badge connecting">Connecting...</span>
                        </div>
                        <div class="info-item">
                            <label>URL:</label>
                            <code id="connection-url">Not connected</code>
                        </div>
                        <div class="info-item">
                            <label>Last Check:</label>
                            <span id="last-check">Never</span>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="testConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button class="btn btn-outline" onclick="showConnectionDetails()">
                        <i class="fas fa-info-circle"></i> Show Details
                    </button>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-new" checked>
                            <span>New assessments added</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-errors" checked>
                            <span>System errors</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notify-user-activity">
                            <span>User activity</span>
                        </label>
                    </div>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-palette"></i> Appearance</h3>
                    <div class="setting-item">
                        <label>Theme</label>
                        <select id="theme-select" class="form-control">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Items per page</label>
                        <select id="page-size" class="form-control">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>

                <div class="settings-card">
                    <h3><i class="fas fa-tools"></i> Maintenance</h3>
                    <button class="btn btn-outline" onclick="clearCache()">
                        <i class="fas fa-broom"></i> Clear Cache
                    </button>
                    <button class="btn btn-danger" onclick="resetSettings()">
                        <i class="fas fa-redo"></i> Reset Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-assessment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add New Assessment</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assessment-form">
                    <div class="form-group">
                        <label>Question Text *</label>
                        <textarea id="question-text" class="form-control" rows="3" required placeholder="Enter the question..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Course *</label>
                            <select id="assessment-course" class="form-control" required>
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficulty *</label>
                            <select id="assessment-difficulty" class="form-control" required>
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Topic</label>
                            <input type="text" id="assessment-topic" class="form-control" placeholder="Enter topic...">
                        </div>
                        <div class="form-group">
                            <label>Marks</label>
                            <input type="number" id="assessment-marks" class="form-control" value="1" min="1" max="10">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Type</label>
                        <select id="assessment-type" class="form-control">
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="short_answer">Short Answer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="assessment-published" checked>
                            <span>Publish immediately</span>
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="add-course-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-medical"></i> Add New Course</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="course-form">
                    <div class="form-group">
                        <label>Course Name *</label>
                        <input type="text" id="course-name" class="form-control" required placeholder="e.g., Anatomy and Physiology">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit Code *</label>
                            <input type="text" id="course-code" class="form-control" required placeholder="e.g., NUR101">
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="color" id="course-color" class="form-control-color" value="#4f46e5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="course-description" class="form-control" rows="2" placeholder="Course description..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Target Program</label>
                            <select id="course-program" class="form-control">
                                <option value="">All Programs</option>
                                <option value="KRCHN">KRCHN</option>
                                <option value="TVET">TVET</option>
                                <option value="Nursing">Nursing</option>
                                <option value="Clinical Medicine">Clinical Medicine</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Intake Year</label>
                            <input type="number" id="course-year" class="form-control" min="2020" max="2030" value="2024">
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Course
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== DEBUG FUNCTIONS ====================
        window.debugAuth = function() {
            console.clear();
            console.log('=== AUTHENTICATION DEBUG ===');
            
            const session = localStorage.getItem('nurseiq_admin_session');
            console.log('1. Session in localStorage:', session);
            
            if (session) {
                try {
                    const parsed = JSON.parse(session);
                    console.log('2. Parsed session:', parsed);
                    console.log('3. Email:', parsed.email);
                    console.log('4. Role:', parsed.role);
                    console.log('5. Timestamp:', parsed.timestamp);
                    
                    if (parsed.timestamp) {
                        const age = (new Date() - new Date(parsed.timestamp)) / (1000 * 60 * 60);
                        console.log('6. Session age (hours):', age.toFixed(2));
                        console.log('7. Session valid?', age < 24 ? 'YES' : 'NO');
                    }
                    
                    console.log('8. Current URL:', window.location.href);
                    console.log('9. Page loaded from:', document.referrer);
                    
                } catch (e) {
                    console.error('Parse error:', e);
                }
            } else {
                console.log('‚ùå No session found in localStorage');
            }
            
            alert('Check console (F12) for debug info');
        };
        
        window.forceLogin = function() {
            if (confirm('Create a test admin session?')) {
                const testSession = {
                    id: 'test-' + Date.now(),
                    email: 'admin@example.com',
                    full_name: 'Test Administrator',
                    role: 'admin',
                    program: 'Nursing',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('nurseiq_admin_session', JSON.stringify(testSession));
                console.log('‚úÖ Test session created');
                alert('Session created. Reloading...');
                location.reload();
            }
        };
        
        window.redirectToLoginPage = function() {
            console.log('Redirecting to login...');
            localStorage.removeItem('nurseiq_admin_session');
            window.location.href = 'https://nakurucollegeofhealthelearning.site/nurseiq-admin-login.html';
        };

        // ==================== NURSEIQ ADMIN PANEL ====================
        console.log('üöÄ Loading NurseIQ Admin Panel...');

        class NurseIQAdmin {
            constructor() {
                console.log('‚úÖ NurseIQAdmin constructor called');
                
                this.supabase = null;
                this.config = {
                    supabaseUrl: 'https://lwhtjozfsmbyihenfunw.supabase.co',
                    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk',
                    environment: 'production',
                    loaded: false
                };
                
                this.currentUser = null;
                this.currentTab = 'dashboard';
                this.assessments = [];
                this.courses = [];
                this.users = [];
                
                this.initialize();
            }
            
            async initialize() {
                try {
                    console.log('üîß Starting initialization...');
                    
                    // Show loader
                    this.showLoader('Checking authentication...');
                    
                    // Wait for DOM
                    await this.waitForDOM();
                    
                    // FIRST: Check authentication BEFORE Supabase
                    const isAuthenticated = this.checkLocalAuthentication();
                    
                    if (isAuthenticated) {
                        console.log('‚úÖ User authenticated from localStorage');
                        
                        // Initialize Supabase
                        await this.initializeSupabase();
                        
                        // Show admin interface immediately
                        this.showAdminInterface();
                        
                        // Load data in background
                        this.loadDataInBackground();
                        
                    } else {
                        console.log('‚ùå User not authenticated');
                        this.showLoginOverlay();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Initialization failed:', error);
                    
                    // If we have user but error occurred, still show admin
                    if (this.currentUser) {
                        console.log('‚ö†Ô∏è Error but user exists, showing admin interface');
                        this.showAdminInterface();
                        this.showNotification('Connected in offline mode', 'warning');
                    } else {
                        this.showLoginOverlay();
                    }
                }
            }
            
            checkLocalAuthentication() {
                try {
                    console.log('üîê Checking local authentication...');
                    
                    // Get session from localStorage
                    const sessionData = localStorage.getItem('nurseiq_admin_session');
                    
                    if (!sessionData) {
                        console.log('‚ùå No session data found');
                        return false;
                    }
                    
                    const session = JSON.parse(sessionData);
                    console.log('üìã Session found for:', session.email);
                    
                    // Basic validation
                    if (!session.email || !session.role) {
                        console.log('‚ùå Session missing required fields');
                        return false;
                    }
                    
                    // Check role
                    if (session.role !== 'superadmin' && session.role !== 'admin') {
                        console.log('‚ùå Invalid role:', session.role);
                        return false;
                    }
                    
                    // Check if expired (24 hours)
                    if (session.timestamp) {
                        const sessionTime = new Date(session.timestamp);
                        const currentTime = new Date();
                        const hoursDiff = (currentTime - sessionTime) / (1000 * 60 * 60);
                        
                        if (hoursDiff > 24) {
                            console.log('‚ùå Session expired');
                            localStorage.removeItem('nurseiq_admin_session');
                            return false;
                        }
                    }
                    
                    // Session is valid
                    this.currentUser = session;
                    console.log('‚úÖ Authentication successful');
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Authentication check error:', error);
                    return false;
                }
            }
            
            async initializeSupabase() {
                try {
                    console.log('üîå Initializing Supabase...');
                    
                    if (!window.supabase || !window.supabase.createClient) {
                        throw new Error('Supabase client not loaded');
                    }
                    
                    this.supabase = window.supabase.createClient(
                        this.config.supabaseUrl,
                        this.config.supabaseKey,
                        { auth: { persistSession: false } }
                    );
                    
                    console.log('‚úÖ Supabase initialized');
                    
                    // Try to verify connection (but don't fail if it doesn't work)
                    try {
                        const { error } = await this.supabase
                            .from('medical_assessments')
                            .select('id')
                            .limit(1);
                        
                        if (error && error.code !== 'PGRST116') {
                            console.warn('‚ö†Ô∏è Database warning:', error.message);
                        } else {
                            console.log('‚úÖ Database connection verified');
                        }
                    } catch (dbError) {
                        console.warn('‚ö†Ô∏è Database check failed (continuing offline):', dbError.message);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Supabase initialization failed:', error);
                    // Don't throw - we can work offline
                }
            }
            
            showAdminInterface() {
                console.log('üñ•Ô∏è Showing admin interface...');
                
                const loader = document.getElementById('config-loader');
                const loginOverlay = document.getElementById('login-overlay');
                const container = document.querySelector('.admin-container');
                
                if (loader) loader.style.display = 'none';
                if (loginOverlay) loginOverlay.style.display = 'none';
                if (container) container.style.display = 'block';
                
                // Update user profile
                this.updateUserProfile();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Show welcome message
                if (this.currentUser) {
                    this.showNotification(`Welcome back, ${this.currentUser.full_name || 'Admin'}!`, 'success');
                }
            }
            
            showLoginOverlay() {
                console.log('üîí Showing login overlay...');
                
                const loader = document.getElementById('config-loader');
                const loginOverlay = document.getElementById('login-overlay');
                
                if (loader) loader.style.display = 'none';
                if (loginOverlay) loginOverlay.style.display = 'flex';
            }
            
            updateUserProfile() {
                if (!this.currentUser) return;
                
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');
                const userRole = document.getElementById('user-role');
                
                if (userAvatar && this.currentUser.full_name) {
                    userAvatar.textContent = this.currentUser.full_name.charAt(0).toUpperCase();
                    userAvatar.style.background = 'linear-gradient(135deg, #4f46e5, #7c3aed)';
                    userAvatar.style.color = 'white';
                }
                
                if (userName) {
                    userName.textContent = this.currentUser.full_name || 'Admin User';
                }
                
                if (userRole) {
                    userRole.textContent = this.currentUser.role || 'Admin';
                    userRole.className = 'user-role ' + 
                        (this.currentUser.role === 'superadmin' ? 'superadmin' : 'admin');
                }
            }
            
            async loadDataInBackground() {
                try {
                    console.log('üìä Loading data in background...');
                    
                    if (!this.supabase) {
                        console.log('‚ö†Ô∏è Supabase not available, skipping data load');
                        return;
                    }
                    
                    // Load dashboard data
                    await this.loadDashboardData();
                    
                    // Load courses
                    await this.loadCourses();
                    
                    // Load assessments
                    await this.loadAssessments();
                    
                    // Load users
                    await this.loadUsers();
                    
                    console.log('‚úÖ All data loaded');
                    
                } catch (error) {
                    console.error('‚ùå Error loading data:', error);
                    this.showNotification('Some data failed to load', 'warning');
                }
            }
            
            showProfileModal() {
                if (!this.currentUser) return;
                
                const profileAvatar = document.getElementById('profile-avatar');
                const profileName = document.getElementById('profile-name');
                const profileRoleBadge = document.getElementById('profile-role-badge');
                const profileEmail = document.getElementById('profile-email');
                const profileProgram = document.getElementById('profile-program');
                const profileLastLogin = document.getElementById('profile-last-login');
                
                if (profileAvatar) {
                    profileAvatar.textContent = this.currentUser.full_name ? 
                        this.currentUser.full_name.charAt(0).toUpperCase() : 'A';
                }
                
                if (profileName) {
                    profileName.textContent = this.currentUser.full_name || 'Admin User';
                }
                
                if (profileRoleBadge) {
                    profileRoleBadge.textContent = this.currentUser.role || 'Admin';
                    profileRoleBadge.className = 'profile-role-badge ' + 
                        (this.currentUser.role === 'superadmin' ? 'superadmin' : 'admin');
                }
                
                if (profileEmail) {
                    profileEmail.textContent = this.currentUser.email || 'No email';
                }
                
                if (profileProgram) {
                    profileProgram.textContent = this.currentUser.program || 'Not specified';
                }
                
                if (profileLastLogin) {
                    profileLastLogin.textContent = this.currentUser.timestamp ? 
                        this.formatTimeAgo(this.currentUser.timestamp) : 'Never';
                }
                
                this.openModal('profile-modal');
            }
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('nurseiq_admin_session');
                    document.cookie = 'nurseiq_admin=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = 'https://nakurucollegeofhealthelearning.site/nurseiq-admin-login.html';
                }
            }
            
            waitForDOM() {
                return new Promise((resolve) => {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', resolve);
                    } else {
                        resolve();
                    }
                });
            }
            
            showLoader(message) {
                const loader = document.getElementById('config-loader');
                if (loader) {
                    const messageEl = loader.querySelector('p');
                    if (messageEl && message) {
                        messageEl.textContent = message;
                    }
                }
            }
            
            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Search assessments
                const searchInput = document.getElementById('search-assessments');
                if (searchInput) {
                    searchInput.addEventListener('input', () => this.filterAssessments());
                }
                
                // Search users
                const userSearch = document.getElementById('search-users');
                if (userSearch) {
                    userSearch.addEventListener('input', () => this.filterUsers());
                }
                
                // Forms
                const assessmentForm = document.getElementById('assessment-form');
                if (assessmentForm) {
                    assessmentForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveAssessment();
                    });
                }
                
                const courseForm = document.getElementById('course-form');
                if (courseForm) {
                    courseForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveCourse();
                    });
                }
                
                // Close modals on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
                
                // Close modal on background click
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.closeModal();
                    }
                });
            }
            
            // ==================== DASHBOARD ====================
            async loadDashboardData() {
                try {
                    if (!this.supabase) {
                        document.getElementById('total-assessments').textContent = '0';
                        document.getElementById('total-courses').textContent = '0';
                        document.getElementById('active-users').textContent = '0';
                        document.getElementById('completion-rate').textContent = '0%';
                        return;
                    }
                    
                    console.log('üìä Loading dashboard data...');
                    
                    // Total assessments
                    const { count: assessmentsCount } = await this.supabase
                        .from('medical_assessments')
                        .select('*', { count: 'exact', head: true });
                    
                    document.getElementById('total-assessments').textContent = assessmentsCount || 0;
                    
                    // Total courses
                    const { count: coursesCount } = await this.supabase
                        .from('courses')
                        .select('*', { count: 'exact', head: true });
                    
                    document.getElementById('total-courses').textContent = coursesCount || 0;
                    
                    // Active users (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const { data: progress } = await this.supabase
                        .from('user_assessment_progress')
                        .select('user_id')
                        .gte('completed_at', thirtyDaysAgo.toISOString())
                        .limit(100);
                    
                    const uniqueUsers = new Set(progress?.map(u => u.user_id) || []);
                    document.getElementById('active-users').textContent = uniqueUsers.size;
                    
                    // Completion rate
                    const { data: allProgress } = await this.supabase
                        .from('user_assessment_progress')
                        .select('is_correct')
                        .limit(100);
                    
                    if (allProgress && allProgress.length > 0) {
                        const correctCount = allProgress.filter(p => p.is_correct).length;
                        const completionRate = Math.round((correctCount / allProgress.length) * 100);
                        document.getElementById('completion-rate').textContent = `${completionRate}%`;
                    }
                    
                    // Recent activity
                    await this.loadRecentActivity();
                    
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    document.getElementById('total-assessments').textContent = '0';
                    document.getElementById('total-courses').textContent = '0';
                    document.getElementById('active-users').textContent = '0';
                    document.getElementById('completion-rate').textContent = '0%';
                }
            }
            
            async loadRecentActivity() {
                try {
                    if (!this.supabase) return;
                    
                    const { data: activity } = await this.supabase
                        .from('user_assessment_progress')
                        .select('completed_at, is_correct, assessment_id')
                        .order('completed_at', { ascending: false })
                        .limit(5);
                    
                    const activityList = document.getElementById('activity-list');
                    if (!activityList) return;
                    
                    if (!activity || activity.length === 0) {
                        activityList.innerHTML = '<div class="activity-item">No recent activity</div>';
                        return;
                    }
                    
                    activityList.innerHTML = activity.map(item => {
                        const timeAgo = this.formatTimeAgo(item.completed_at);
                        return `
                            <div class="activity-item">
                                <i class="fas fa-${item.is_correct ? 'check-circle' : 'times-circle'}"></i>
                                <span>Assessment ${item.is_correct ? 'correct' : 'incorrect'} (${timeAgo})</span>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading activity:', error);
                }
            }
            
            // ==================== ASSESSMENTS ====================
            async loadAssessments() {
                console.log('üìù Loading assessments...');
                
                try {
                    if (!this.supabase) {
                        this.assessments = [];
                        this.renderAssessmentsTable();
                        return;
                    }
                    
                    const { data: assessments, error } = await this.supabase
                        .from('medical_assessments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (error) {
                        console.error('Error fetching assessments:', error);
                        throw error;
                    }
                    
                    this.assessments = assessments || [];
                    console.log(`‚úÖ Loaded ${this.assessments.length} assessments`);
                    this.renderAssessmentsTable();
                    
                } catch (error) {
                    console.error('Error loading assessments:', error);
                    this.showNotification('Failed to load assessments', 'error');
                    this.assessments = [];
                    this.renderAssessmentsTable();
                }
            }
            
            renderAssessmentsTable() {
                const tableBody = document.querySelector('#assessments-table tbody');
                if (!tableBody) return;
                
                if (this.assessments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No assessments found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = this.assessments.map(assessment => {
                    const date = new Date(assessment.created_at);
                    const formattedDate = date.toLocaleDateString();
                    
                    let statusBadge = '';
                    if (!assessment.is_active) {
                        statusBadge = '<span class="badge inactive">Inactive</span>';
                    } else if (!assessment.is_published) {
                        statusBadge = '<span class="badge draft">Draft</span>';
                    } else {
                        statusBadge = '<span class="badge published">Published</span>';
                    }
                    
                    const courseName = this.getCourseName(assessment.course_id);
                    
                    return `
                        <tr>
                            <td>${assessment.id.substring(0, 8)}...</td>
                            <td>${assessment.question_text?.substring(0, 50) || 'No question'}...</td>
                            <td>${courseName}</td>
                            <td><span class="difficulty-badge ${assessment.difficulty}">${assessment.difficulty || 'medium'}</span></td>
                            <td>${statusBadge}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <button onclick="admin.editAssessment('${assessment.id}')" class="btn-action" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="admin.toggleAssessmentStatus('${assessment.id}')" class="btn-action" title="${assessment.is_published ? 'Unpublish' : 'Publish'}">
                                    <i class="fas ${assessment.is_published ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                </button>
                                <button onclick="admin.deleteAssessment('${assessment.id}')" class="btn-action" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            getCourseName(courseId) {
                if (!courseId) return 'No course';
                const course = this.courses.find(c => c.id === courseId);
                return course?.course_name || 'Unknown course';
            }
            
            filterAssessments() {
                const searchTerm = document.getElementById('search-assessments')?.value.toLowerCase() || '';
                const rows = document.querySelectorAll('#assessments-table tbody tr');
                
                rows.forEach(row => {
                    const question = row.cells[1]?.textContent.toLowerCase() || '';
                    const matches = !searchTerm || question.includes(searchTerm);
                    row.style.display = matches ? '' : 'none';
                });
            }
            
            // ==================== COURSES ====================
            async loadCourses() {
                console.log('üìö Loading courses...');
                
                try {
                    if (!this.supabase) {
                        this.courses = [];
                        this.renderCoursesTable();
                        return;
                    }
                    
                    const { data: courses, error } = await this.supabase
                        .from('courses')
                        .select('*')
                        .order('course_name');
                    
                    if (error) {
                        console.error('Error fetching courses:', error);
                        throw error;
                    }
                    
                    this.courses = courses || [];
                    console.log(`‚úÖ Loaded ${this.courses.length} courses`);
                    this.renderCoursesTable();
                    this.populateCourseDropdown();
                    
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.showNotification('Failed to load courses', 'error');
                    this.courses = [];
                    this.renderCoursesTable();
                }
            }
            
            renderCoursesTable() {
                const tableBody = document.querySelector('#courses-table tbody');
                if (!tableBody) return;
                
                if (this.courses.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">
                                <div style="padding: 40px; text-align: center;">
                                    <i class="fas fa-book" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                                    <h3 style="color: #6b7280; margin-bottom: 8px;">No Courses Found</h3>
                                    <p style="color: #9ca3af; margin-bottom: 20px;">Add your first course to get started</p>
                                    <button onclick="openAddCourseModal()" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Add First Course
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = this.courses.map(course => {
                    const courseColor = course.color || '#4f46e5';
                    
                    return `
                        <tr>
                            <td>${course.id.substring(0, 8)}...</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${courseColor};"></div>
                                    <strong>${course.course_name || 'Unnamed Course'}</strong>
                                </div>
                            </td>
                            <td>${course.unit_code || 'N/A'}</td>
                            <td>${course.target_program || 'All'}</td>
                            <td>${course.intake_year || 'All'}</td>
                            <td>
                                <span class="status-badge ${course.status === 'Active' ? 'active' : 'inactive'}">
                                    ${course.status || 'Unknown'}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="admin.editCourse('${course.id}')" class="btn-action" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="admin.toggleCourseStatus('${course.id}')" class="btn-action" title="${course.status === 'Active' ? 'Deactivate' : 'Activate'}">
                                        <i class="fas fa-power-off"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            populateCourseDropdown() {
                const courseSelect = document.getElementById('assessment-course');
                if (!courseSelect) return;
                
                const activeCourses = this.courses.filter(c => c.status === 'Active');
                
                if (activeCourses.length === 0) {
                    courseSelect.innerHTML = '<option value="">No courses available</option>';
                    return;
                }
                
                const options = activeCourses.map(course => {
                    const displayName = course.course_name || 'Unnamed Course';
                    const displayCode = course.unit_code || '';
                    return `<option value="${course.id}">${displayName} ${displayCode ? `(${displayCode})` : ''}</option>`;
                }).join('');
                
                courseSelect.innerHTML = '<option value="">Select Course</option>' + options;
            }
            
            // ==================== USERS ====================
            async loadUsers() {
                console.log('üë• Loading users...');
                
                try {
                    if (!this.supabase) {
                        this.users = [];
                        this.renderUsersTable();
                        return;
                    }
                    
                    let users = [];
                    
                    // Try consolidated table
                    const { data: consolidatedData } = await this.supabase
                        .from('consolidated_user_profiles_table')
                        .select('*')
                        .limit(50);
                    
                    if (consolidatedData) {
                        users = consolidatedData;
                    }
                    
                    this.users = users || [];
                    console.log(`‚úÖ Loaded ${this.users.length} users`);
                    this.renderUsersTable();
                    
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.users = [];
                    this.renderUsersTable();
                }
            }
            
            // ==================== UTILITIES ====================
            switchTab(tabId) {
                this.currentTab = tabId;
                
                document.querySelectorAll('.admin-tab').forEach(t => {
                    t.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            }
            
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            closeModal() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
                
                // Reset forms
                const assessmentForm = document.getElementById('assessment-form');
                if (assessmentForm) {
                    assessmentForm.reset();
                    delete assessmentForm.dataset.editId;
                    assessmentForm.onsubmit = (e) => {
                        e.preventDefault();
                        this.saveAssessment();
                    };
                }
                
                const courseForm = document.getElementById('course-form');
                if (courseForm) {
                    courseForm.reset();
                    delete courseForm.dataset.editId;
                    courseForm.onsubmit = (e) => {
                        e.preventDefault();
                        this.saveCourse();
                    };
                }
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                if (!container) {
                    const containerDiv = document.createElement('div');
                    containerDiv.id = 'notification-container';
                    containerDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 9999;
                        max-width: 400px;
                    `;
                    document.body.appendChild(containerDiv);
                }
                
                const finalContainer = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                `;
                
                notification.innerHTML = `
                    <div>
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span style="margin-left: 10px;">${message}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 0 5px;">
                        &times;
                    </button>
                `;
                
                finalContainer.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            formatTimeAgo(dateString) {
                if (!dateString) return 'Never';
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            }
            
            // Keep all other methods (saveAssessment, saveCourse, etc.) the same as before
            // ... (Your existing methods for CRUD operations)
        }

        // ==================== GLOBAL FUNCTIONS ====================
        let adminInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM loaded, initializing admin panel...');
            adminInstance = new NurseIQAdmin();
        });

        // Global functions
        window.openAddAssessmentModal = () => adminInstance?.openModal('add-assessment-modal');
        window.openAddCourseModal = () => adminInstance?.openModal('add-course-modal');
        window.generateReport = () => adminInstance?.showNotification('Report generation coming soon!', 'info');
        window.testConnection = () => adminInstance?.testConnection();
        window.showConnectionDetails = () => {
            if (adminInstance) {
                alert(`Connection Details:\nURL: ${adminInstance.config.supabaseUrl}\nEnvironment: ${adminInstance.config.environment}`);
            }
        };
        window.clearCache = () => {
            localStorage.clear();
            adminInstance?.showNotification('Cache cleared!', 'success');
        };
        window.resetSettings = () => {
            if (confirm('Reset all settings? This will clear all local data.')) {
                localStorage.clear();
                location.reload();
            }
        };
        window.refreshAssessments = () => adminInstance?.loadAssessments();
        window.refreshCourses = () => adminInstance?.loadCourses();
        window.refreshUsers = () => adminInstance?.loadUsers();
        window.closeModal = () => adminInstance?.closeModal();
        window.admin = adminInstance;
    </script>
</body>
</html>
