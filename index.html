<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard - Deep Purple Theme</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* -------------------------------------- */
        /* SUPABASE STUDENT PORTAL STYLE (Deep Purple Theme) */
        /* -------------------------------------- */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F1F5F9; }
        .container { display: flex; min-height: 100vh; }

        /* Sidebar - Deep Purple Theme */
        .sidebar { 
            width: 250px;
            background-color: #4C1D95;
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
        }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header img { width: 60px; margin-bottom: 10px; filter: invert(1); }
        .nav { list-style: none; padding: 0; flex-grow: 1; }
        .nav li { margin: 10px 0; }
        .nav a { color: #E5E7EB; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.2s; }
        .nav a:hover { background-color: #5B21B6; }
        .nav a.active { 
            background-color: #FCD34D;
            color: #1F2937;
            font-weight: bold;
        }
        .logout { margin-top: auto; text-align: center; }
        .logout a { 
            display: inline-block; 
            margin-top: 20px; 
            padding: 10px 20px; 
            background-color: #EF4444; 
            color: #fff; 
            text-decoration: none; 
            border-radius: 6px; 
        }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        header h1 { margin: 0; font-size: 2.2rem; color: #4C1D95; }
        .subtitle { color: #6B7280; margin-bottom: 25px; }

        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .card { 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            transition: transform 0.2s, box-shadow 0.2s; 
            border: 1px solid #E2E8F0;
            text-align: center;
            border-left: 5px solid #4C1D95; 
        }
        .card:hover { transform: translateY(-7px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .card h3 { margin-top: 0; font-size: 1.1em; color: #4C1D95;}
        .card p.data { font-size: 2em; font-weight: 800; margin: 5px 0 0; color: #F59E0B; } 
        
        /* Dashboard Welcome Banner (Admin Message) */
        #welcome-banner {
            background-color: #FEE7D1; 
            color: #9A3412; 
            border: 1px solid #FDBA74; 
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.0rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcome-banner strong {
            font-weight: bold;
            color: #F59E0B; 
        }
        .info-icon {
            font-size: 1.5rem;
            color: #F59E0B;
        }

        /* Tabs, Tables, Forms */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; background-color: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid #E2E8F0; text-align: left; }
        th { background-color: #E5E7EB; color: #1F2937; }
        tr:hover { background-color: #F8FAFC; }
        
        /* Calendar Specific Styles */
        #calendar-table th.session-type-col { width: 15%; }
        #calendar-table th.date-col { width: 15%; }
        #calendar-table td.Clinical { background-color: #fce7f3; } /* Light Pink */
        #calendar-table td.Class { background-color: #e0f2f1; } /* Light Teal */
        #calendar-table td.Exam { background-color: #fef3c7; } /* Light Yellow */


        /* Forms */
        form input, form select, form button, form textarea {
            padding: 10px 12px; margin: 5px 5px 10px 0; border-radius: 6px; border: 1px solid #CBD5E1;
            box-sizing: border-box; 
            min-width: 150px;
        }
        form button { background-color: #4C1D95; color: #fff; cursor: pointer; }
        form button:hover { background-color: #5B21B6; }
        
        /* Profile Specific Styles */
        #profile-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95; 
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        .profile-details {
            /* Use grid for better layout of details */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .profile-media {
            grid-column: 1 / 3; /* Span across both columns on smaller screens/layouts */
        }
        .form-field {
            min-width: 100%;
        }
        .form-field.full-width {
            grid-column: 1 / 3;
        }

        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            margin-top: 15px; 
            color: #4C1D95;
        }
        .form-field input[readonly] {
            background-color: #E5E7EB;
            color: #4B5563;
        }
        .profile-button {
            background-color: #4C1D95; 
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            margin-top: 15px;
            border: none;
            cursor: pointer;
        }
        
        /* Check-in Controls */
        .check-in-controls {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .check-in-controls button {
            background-color: #10B981; 
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }
        
        .resource-item {
            background-color: #fff;
            border: 1px solid #E2E8F0;
            border-left: 4px solid #F59E0B;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .resource-item a {
            color: #4C1D95;
            font-weight: 600;
            text-decoration: none;
        }
        .resource-item a:hover {
            text-decoration: underline;
        }

        /* Messages Styles */
        #message-form textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
            resize: vertical;
        }
        .message-item {
            padding: 15px; 
            margin-bottom: 10px; 
            background-color: white; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid #F59E0B; /* Default unread */
        }
        .message-item.read {
            border-left: 4px solid #10B981;
        }
        .message-item .message-status {
            font-size: 0.8em; 
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; padding: 20px 0; height: auto; }
            .nav { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 10px; }
            .nav li { width: 30%; margin: 5px 0; }
            .nav a { text-align: center; padding: 8px 10px; font-size: 0.8rem; }
            .main { padding: 20px; }
            .cards { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .check-in-controls select { width: 100%; min-width: unset; }
            #profile-form { flex-direction: column; padding: 20px; }
            .profile-details { grid-template-columns: 1fr; }
            .form-field.full-width { grid-column: 1 / 2; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo" style="width: 100px; margin-bottom: 10px; filter: none;"> 
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1 id="welcome-header">Hello, Student!</h1>
                <p class="subtitle">Your academic resources and tools.</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-banner">
                    <span class="info-icon">üì£</span>
                    <strong>THE OFFICIAL ANNOUNCEMENT IS HERE:</strong> 
                    <span id="student-welcome-message">Loading message...</span>
                </div>
                
                <h2 style="margin-top: 30px; color: #4C1D95;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Last 30 days</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600; color: #4C1D95;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last updated week</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: #4C1D95;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #F59E0B; cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #F59E0B;">View Resources</button>
                    </div>
                </div>
            </section>

            <section id="profile" class="tab-content">
                <h2 style="color: #4C1D95;">My Profile & Account</h2>
                <form id="profile-form">
                    
                    <div class="profile-media">
                      <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                      <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                             <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                        
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>

                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>

            <section id="calendar" class="tab-content">
                <h2 style="color: #4C1D95;">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter" onchange="loadAcademicCalendar()">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th class="date-col">Date & Time</th>
                            <th>Event / Details</th>
                            <th class="session-type-col">Type</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-table">
                        <tr><td colspan="3">Loading academic schedule...</td></tr>
                    </tbody>
                </table>
            </section>
            
           <section id="courses" class="tab-content">
                <h2 style="color: #4C1D95;">My Courses (Real-Time Enrollment)</h2>
                <p>Courses shown here are filtered by your *Program, **Block, and **Intake Year* for relevance.</p>
                <table>
                    <thead><tr><th>Course Name</th><th>Status</th></tr></thead>
                    <tbody id="courses-table">
                        <tr><td colspan="2">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>


         <section id="attendance" class="tab-content">
                <h2 style="color: #4C1D95;">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Select a **Session Type** and then a specific **Department or Course** to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: #4C1D95;">Past Attendance History (Check-in Logs)</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Target</th><th>Location</th><th>Accuracy (m)</th><th>Verified</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="6">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

           <section id="cats" class="tab-content">
                <h2 style="color: #4C1D95;">CATS / Exams Schedule</h2>
                <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse; text-align: left;">
                    <thead style="background-color: #f3f4f6;">
                        <tr>
                            <th>Exam Name</th>
                            <th>Block</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="exams-table">
                        <tr>
                            <td colspan="4">Loading exam schedule...</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="resources" class="tab-content">
                <h2 style="color: #4C1D95;">Learning Resources</h2>
                <div id="resources-list">Loading resources...</div>
            </section>

            <section id="messages" class="tab-content">
                <h2 style="color: #4C1D95;">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
                
                <h3 style="color: #4C1D95; margin-top: 30px;">Received Messages / Announcements</h3>
                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>

<script>
    // Hides the .html extension in the URL
    if (window.location.pathname.endsWith('.html')) {
        const cleanPath = window.location.pathname.replace(/\.html$/, '');
        window.history.replaceState({}, '', cleanPath);
    }

    // *************************************************************************
    // *** 1. CONFIGURATION AND GLOBAL DECLARATIONS ***
    // *************************************************************************
    
    // ** SUPABASE CONFIGURATION **
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co'; // <--- Update with your actual Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk'; // <--- Update with your actual Anon Key
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ** LOCATIONIQ CONFIGURATION (Geocoding API) **
    const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c'; 
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';
    
    // ** GLOBAL STATE VARIABLES **
    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = [];
    let cachedExams = [];
    let cachedClinicalAreas = [];
    
    // ** UI ELEMENT REFERENCES **
    const welcomeHeader = document.getElementById('welcome-header'); 
    const sessionTypeSelect = document.getElementById('session-type'); 
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const geoMessage = document.getElementById('geo-message');

    // ** GLOBAL CONSTANTS **
    const SETTINGS_TABLE = 'app_settings'; 
    const MESSAGE_KEY = 'welcome_message_html'; 
    const FALLBACK_LAT = 0.00; // Define safe fallback coordinates
    const FALLBACK_LON = 0.00;
    const FALLBACK_ACCURACY = 9999;


// *************************************************************************
// *** 2. UI AND NAVIGATION LOGIC ***
// *************************************************************************
const navLinks = document.querySelectorAll('.nav a');
const tabs = document.querySelectorAll('.tab-content');

function showTab(tabId) {
    navLinks.forEach(l => l.classList.remove('active'));
    const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
    if (activeLink) activeLink.classList.add('active');

    tabs.forEach(tab => tab.classList.remove('active'));
    const activeTab = document.getElementById(tabId);
    if (activeTab) activeTab.classList.add('active');
    
    // Load data specific to the tab being activated
    if (tabId === 'profile' && currentUserId) loadProfile(currentUserId);
    if (tabId === 'attendance' && currentUserId) {
        // This is where loadGeoAttendanceHistory is called when switching tabs
        loadGeoAttendanceHistory(currentUserId); 
        updateTargetSelect(); 
    }
    if (tabId === 'dashboard' && currentUserId) {
        loadWelcomeDetails();
        loadCourses(); 
        loadExams();
        loadResources();
        setTimeout(() => loadDashboardMetrics(currentUserId), 500);
    }
    if (tabId === 'courses' && currentUserId) loadCourses(); 
    if (tabId === 'resources' && currentUserId) loadResources();
    if (tabId === 'cats' && currentUserId) loadExams();
    if (tabId === 'messages' && currentUserId) loadStudentMessages();
    if (tabId === 'calendar' && currentUserId) loadAcademicCalendar();
}

navLinks.forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        showTab(link.dataset.tab);
    });
});

async function logout() {
    sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
    await sb.auth.signOut();
    // NOTE: Redirect path is assumed to be 'login.html'
    window.location.href = "login.html"; 
}

// *************************************************************************
// *** 3. CORE DATA AND DASHBOARD FUNCTIONS ***
// *************************************************************************
async function loadWelcomeDetails() {
    let studentName = 'Student'; // Default name

    if (currentUserProfile && currentUserProfile.full_name) {
        const parts = currentUserProfile.full_name.trim().split(/\s+/);
        if (parts.length > 0) {
            studentName = parts[0];
        }
    }

    if (welcomeHeader) welcomeHeader.textContent = `Welcome, ${studentName}!`;
    await loadStudentWelcomeMessage();
}

async function loadStudentWelcomeMessage() {
    const messageDiv = document.getElementById('student-welcome-message');
    if (!messageDiv) return;

    messageDiv.textContent = 'Loading official announcement...';

    const { data, error } = await sb
        .from(SETTINGS_TABLE)
        .select('value')
        .eq('key', MESSAGE_KEY)
        .single();

    if (!error && data) {
        messageDiv.innerHTML = data.value;
    } else {
        messageDiv.innerHTML = 'Welcome to the Student Portal! Stay informed and use the navigation on the left.';
    }

    sb.channel('student_welcome_updates')
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: SETTINGS_TABLE,
                filter: `key=eq.${MESSAGE_KEY}`,
            },
            (payload) => {
                const newValue = payload.new?.value;
                if (newValue) {
                    messageDiv.innerHTML = newValue;
                    console.log("Admin message updated in real-time.");
                }
            }
        )
        .subscribe();
}

async function loadDashboardMetrics(userId) {
    document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;

    try {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const monday = new Date(now);
        monday.setDate(now.getDate() - ((dayOfWeek + 6) % 7));
        monday.setHours(0, 0, 0, 0);

        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23, 59, 59, 999);

        const { data: logs, error } = await sb
            .from('geo_attendance_logs')
            .select('check_in_time, is_verified')
            .eq('student_id', userId)
            // Filtering for a relevant period (e.g., last week or 30 days) is ideal for a metric
            .limit(100); 

        if (error) throw error;

        // Simplified rate calculation (assuming logs represent total possible sessions)
        const totalSessions = logs.length || 1;
        const attended = logs.filter(l => l.is_verified === true).length;
        const attendanceRate = totalSessions > 0 ? Math.round((attended / totalSessions) * 100) : 0;

        document.getElementById('dashboard-attendance-rate').textContent = `${attendanceRate}%`;
    } catch (err) {
        console.error("Failed to load weekly attendance:", err);
        document.getElementById('dashboard-attendance-rate').textContent = 'N/A';
    }

    let nextExamText = 'None Scheduled';
    if (cachedExams && cachedExams.length > 0) {
        const now = new Date();
        const upcomingExam = cachedExams.find(e => new Date(e.exam_date) >= now);
        if (upcomingExam) {
            nextExamText = `${new Date(upcomingExam.exam_date).toLocaleDateString()} (${upcomingExam.exam_name})`;
        } else {
            nextExamText = 'Semester Complete';
        }
    }
    document.getElementById('dashboard-upcoming-exam').textContent = nextExamText;

    const passportCard = document.getElementById('action-passport');
    let profileIncomplete = !(currentUserProfile && currentUserProfile.passport_url);
    if (passportCard) passportCard.style.display = profileIncomplete ? 'block' : 'none';

    const actionsContainer = document.getElementById('dashboard-actions');
    const actionTitle = document.getElementById('actions-title');

    if (actionTitle && actionsContainer) {
        const visibleActions = Array.from(actionsContainer.children).filter(child => child.style.display !== 'none').length;
        actionTitle.style.display = visibleActions === 0 ? 'none' : 'block';
    }
}

// *************************************************************************
// *** 4. AUTHENTICATION AND PROFILE MANAGEMENT ***
// *************************************************************************

async function checkAuthAndLoad() {
    const { data: { user } } = await sb.auth.getUser();

    if (user) {
        currentUserId = user.id;

        await loadProfile(currentUserId);

        // Load all data sources once profile is available
        await loadCourses(true); // Load courses globally
        await loadExams();
        await loadResources();
        await loadClinicalTargets(); 

        await loadWelcomeDetails();

        showTab('dashboard');
        setTimeout(() => loadDashboardMetrics(currentUserId), 500);

    } else {
        console.warn("No active user session found. Redirecting to login.");
        window.location.href = "login.html";
    }
}

const profileForm = document.getElementById('profile-form');
const passportFileInput = document.getElementById('passport-file-input');
const passportPreview = document.getElementById('passport-preview');
const uploadButton = document.getElementById('upload-button');
const profileStatus = document.getElementById('profile-status');
const editProfileButton = document.getElementById('edit-profile-button');
const saveProfileButton = document.getElementById('save-profile-button');
const uploadLabel = document.getElementById('upload-label');


async function loadProfile(userId) {
    if (profileStatus) profileStatus.textContent = 'Loading profile...';

    const { data: profile, error } = await sb
        .from('consolidated_user_profiles_table')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error || !profile) {
        console.error('Error loading consolidated profile:', error);
        if (profileStatus) profileStatus.textContent = 'Profile data missing or restricted. Contact Admin.';
        currentUserProfile = {
            full_name: 'Unknown Student',
            program: 'N/A',
            block: 'N/A',
            intake_year: 'N/A',
            email: 'N/A',
            phone: 'N/A',
            role_id: 'N/A',
            department: 'N/A' 
        };
    } else {
        currentUserProfile = profile;
        if (profileStatus) profileStatus.textContent = '';
    }

    if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').value = currentUserProfile.role_id || 'N/A';
    if (document.getElementById('profile-name')) document.getElementById('profile-name').value = currentUserProfile.full_name || 'N/A';
    if (document.getElementById('profile-email')) document.getElementById('profile-email').value = currentUserProfile.email || 'N/A';
    if (document.getElementById('profile-phone')) document.getElementById('profile-phone').value = currentUserProfile.phone || 'N/A';
    if (document.getElementById('profile-program')) document.getElementById('profile-program').value = currentUserProfile.department || currentUserProfile.program || 'N/A'; 
    if (document.getElementById('profile-block')) document.getElementById('profile-block').value = currentUserProfile.block || 'N/A';
    if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').value = currentUserProfile.intake_year || 'N/A';

    let photoUrl = 'https://via.placeholder.com/150x150?text=NO+PHOTO';
    if (currentUserProfile.passport_url) {
        const publicUrlResponse = sb.storage.from('passports').getPublicUrl(currentUserProfile.passport_url);
        if (publicUrlResponse.data) {
            photoUrl = publicUrlResponse.data.publicUrl;
        }
    }
    if (document.getElementById('passport-preview')) document.getElementById('passport-preview').src = photoUrl;

    toggleProfileEdit(false);
    if (uploadLabel && !currentUserProfile.passport_url) {
        uploadLabel.style.display = 'block';
    }
}

function toggleProfileEdit(enable) {
    const editableFields = ['profile-name', 'profile-phone'];

    editableFields.forEach(id => {
        const input = document.getElementById(id);
        if (input) input.readOnly = !enable;
    });

    if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').readOnly = true;
    if (document.getElementById('profile-email')) document.getElementById('profile-email').readOnly = true;
    if (document.getElementById('profile-program')) document.getElementById('profile-program').readOnly = true;
    if (document.getElementById('profile-block')) document.getElementById('profile-block').readOnly = true;
    if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').readOnly = true;

    if (editProfileButton) editProfileButton.style.display = enable ? 'none' : 'block';
    if (saveProfileButton) saveProfileButton.style.display = enable ? 'block' : 'none';

    if (uploadLabel) {
        if (enable || !(currentUserProfile && currentUserProfile.passport_url)) {
            uploadLabel.style.display = 'block';
        } else {
            uploadLabel.style.display = 'none';
        }
    }

    if (document.getElementById('upload-button')) document.getElementById('upload-button').style.display = 'none';
}

if (editProfileButton) editProfileButton.addEventListener('click', () => toggleProfileEdit(true));

if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (profileStatus) profileStatus.textContent = 'Saving changes...';

        const updates = {
            full_name: document.getElementById('profile-name').value,
            phone: document.getElementById('profile-phone').value,
            updated_at: new Date().toISOString()
        };

        const { error } = await sb
            .from('consolidated_user_profiles_table')
            .update(updates)
            .eq('user_id', currentUserId);

        if (error) {
            if (profileStatus) profileStatus.textContent = `Error saving profile: ${error.message}`;
        } else {
            if (profileStatus) profileStatus.textContent = 'Profile updated successfully!';
            loadProfile(currentUserId);
        }
    });
}

if (passportFileInput) {
    passportFileInput.addEventListener('change', () => {
        const file = passportFileInput.files[0];
        if (file) {
            if (passportPreview) passportPreview.src = URL.createObjectURL(file);
            if (uploadButton) uploadButton.style.display = 'block';
            if (uploadLabel) uploadLabel.style.display = 'none';
        }
    });
}

if (uploadButton) {
    uploadButton.addEventListener('click', async () => {
        const file = passportFileInput.files[0];
        if (!file) {
            if (profileStatus) profileStatus.textContent = 'Please select a file first.';
            return;
        }

        if (profileStatus) profileStatus.textContent = 'Uploading photo...';
        if (uploadButton) uploadButton.disabled = true;

        const fileExt = file.name.split('.').pop();
        const filePath = `${currentUserId}.${fileExt}`;

        const { error: uploadError } = await sb.storage
            .from('passports')
            .upload(filePath, file, { cacheControl: '3600', upsert: true });

        if (uploadError) {
            if (profileStatus) profileStatus.textContent = `Upload failed: ${uploadError.message}`;
            if (uploadButton) uploadButton.disabled = false;
            return;
        }

        const { error: updateError } = await sb
            .from('consolidated_user_profiles_table')
            .update({ passport_url: filePath, updated_at: new Date().toISOString() })
            .eq('user_id', currentUserId);

        if (updateError) {
            if (profileStatus) profileStatus.textContent = `Database update failed: ${updateError.message}`;
        } else {
            if (profileStatus) profileStatus.textContent = 'Photo uploaded and saved successfully!';
            if (passportFileInput) passportFileInput.value = '';
            if (uploadButton) uploadButton.style.display = 'none';
            loadProfile(currentUserId);
        }

        if (uploadButton) uploadButton.disabled = false;
    });
}

// *************************************************************************
// *** 5. ATTENDANCE LOGIC (GeoCheckIn) ***
// *************************************************************************
 
async function loadClinicalTargets() {
    if (!currentUserProfile || !currentUserProfile.department || !currentUserProfile.intake_year) {
        cachedClinicalAreas = [];
        return;
    }
    
    const program = currentUserProfile.department; 
    const block = currentUserProfile.block;
    const intakeYear = currentUserProfile.intake_year;

    try {
        let query = sb
            .from('clinical_areas')
            .select('id, name')
            .eq('program', program)
            .eq('intake_year', intakeYear);
            
        if (block) {
             const blockFilter = `block.eq.${block},block.is.null`; 
             query = query.or(blockFilter);
        } else {
             query = query.is('block', null); 
        }

        const { data, error } = await query.order('name');

        if (error) throw error;
        
        cachedClinicalAreas = data.map(area => ({ id: area.id, name: area.name }));
        
    } catch (error) {
        console.error("Error loading clinical areas:", error);
        cachedClinicalAreas = [];
    }
}
 
async function loadCourses(isGlobalCache = false) {
    const tableBody = document.getElementById('courses-table');
    if (!tableBody && !isGlobalCache) return;
    if (tableBody) tableBody.innerHTML = '<tr><td colspan="2">Loading courses from Supabase...</td></tr>';
    
    if (!currentUserProfile || !currentUserProfile.department || !currentUserProfile.intake_year) {
        cachedCourses = [];
        if (tableBody) tableBody.innerHTML = '<tr><td colspan="2">No profile info to load courses.</td></tr>';
        return;
    }

    const program = currentUserProfile.department; 
    const block = currentUserProfile.block; 
    const intakeYear = currentUserProfile.intake_year;

    try {
        let query = sb
            .from('courses_sections') 
            .select('id, name, code')
            .eq('program', program)
            .eq('intake_year', intakeYear);
            
        if (block) {
             const blockFilter = `block.eq.${block},block.is.null`; 
             query = query.or(blockFilter);
        } else {
             query = query.is('block', null); 
        }

        const { data, error } = await query.order('name');

        if (error) throw error;
        
        cachedCourses = data.map(course => ({ 
            id: course.id, 
            name: course.name,
            code: course.code 
        }));
        
        if (tableBody) {
             tableBody.innerHTML = '';
             if (cachedCourses.length > 0) {
                 cachedCourses.forEach(c => {
                     tableBody.innerHTML += `
                         <tr>
                             <td>${c.code ? c.code + ' - ' : ''}${c.name}</td>
                             <td>Active</td>
                         </tr>
                     `;
                 });
             } else {
                 tableBody.innerHTML = '<tr><td colspan="2">No courses found for your block/year.</td></tr>';
             }
        }
        
    } catch (error) {
        console.error("Error loading courses:", error);
        if (tableBody) tableBody.innerHTML = `<tr><td colspan="2" style="color:#EF4444;">Error loading courses: ${error.message}</td></tr>`;
        cachedCourses = [];
    }
    
    if (document.getElementById('dashboard-active-courses')) document.getElementById('dashboard-active-courses').textContent = cachedCourses.length || 0;
}


function updateTargetSelect() {
    if (!sessionTypeSelect || !attendanceTargetSelect || !geoMessage) return; 
    
    const sessionType = sessionTypeSelect.value;
    attendanceTargetSelect.innerHTML = '';
    
    let targetList = [];
    let label = 'Department/Course:';

    if (sessionType === 'Clinical') {
        targetList = cachedClinicalAreas.map(d => ({ 
            id: d.id, 
            name: d.name, 
            text: `${d.name} (Clinical)` 
        }));
        label = 'Department/Area:';
    } else if (sessionType === 'Class') {
        targetList = cachedCourses.map(c => ({ 
            id: c.id, 
            name: c.name,
            code: c.code,
            text: `${c.code ? c.code + ' - ' : ''}${c.name} (Class)` 
        }));
        label = 'Course/Subject:';
    }

    const targetLabel = document.getElementById('target-label');
    if (targetLabel) targetLabel.textContent = label;

    if (targetList.length === 0) {
        const message = sessionType === 'Class' ? 'No active courses found for your block.' : 'No clinical areas assigned to your block.';
        attendanceTargetSelect.innerHTML = `<option value="">${message}</option>`;
    } else {
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = `-- Select a ${label.replace(':', '')} --`;
        attendanceTargetSelect.appendChild(defaultOption);
        
        targetList.forEach(target => {
            const option = document.createElement('option');
            option.value = `${target.id}|${target.name}`; 
            option.textContent = target.text;
            attendanceTargetSelect.appendChild(option);
        });
    }
    geoMessage.innerHTML = `Please select a specific **${label.replace(':', '')}** to check in.`;
}

async function geoCheckIn() {
    const sessionType = sessionTypeSelect.value;
    const targetSelect = attendanceTargetSelect.value;
    const checkInTime = new Date().toISOString();
    const button = document.getElementById('check-in-button');
    
    if (!sessionType || !targetSelect || targetSelect === '') {
        geoMessage.textContent = 'Error: Please select both a Session Type and a valid Department/Course.';
        return;
    }

    if (button) button.disabled = true;
    geoMessage.textContent = 'Attempting to get **high-accuracy location** and check in...';

    // --- Geolocation Logic ---
    const getLocation = () => new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'Fallback Location (Geolocation Disabled)' }); 
        }
        
        navigator.geolocation.getCurrentPosition(
            (pos) => resolve({ 
                lat: pos.coords.latitude, 
                lon: pos.coords.longitude, 
                acc: pos.coords.accuracy, 
                friendly: null 
            }),
            (err) => {
                console.warn(`Geolocation error (${err.code}): ${err.message}. Using fallback.`);
                resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'Fallback Location (GPS Error)' }); 
            },
            { 
                enableHighAccuracy: true, 
                timeout: 7000, 
                maximumAge: 0 
            }
        );
    });

    try {
        let location = await getLocation();

        // --- Geocoding Logic ---
        if (location.friendly === null) {
            const geocodeUrl = `${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${location.lat}&lon=${location.lon}&format=json`;
            const response = await fetch(geocodeUrl);
            if (response.ok) {
                const geoData = await response.json();
                location.friendly = geoData.display_name || `Lat: ${location.lat.toFixed(4)}, Lon: ${location.lon.toFixed(4)}`;
            } else {
                location.friendly = `Geocoding Failed. Lat: ${location.lat.toFixed(4)}, Lon: ${location.lon.toFixed(4)}`;
            }
        }
        
        const [targetId, targetName] = targetSelect.split('|');

        // CRITICAL: Call the database function (RPC)
        const { error } = await sb.rpc('check_in_and_defer_fk', {
            p_student_id: currentUserId,
            p_check_in_time: checkInTime,
            p_session_type: sessionType === 'Clinical' ? 'Clinical' : 'Class',
            p_target_id: targetId,
            p_target_name: targetName,
            p_latitude: location.lat,
            p_longitude: location.lon,
            p_accuracy_m: location.acc,
            p_location_friendly_name: location.friendly,
            p_program: currentUserProfile ? currentUserProfile.department : null, 
            p_block: currentUserProfile ? currentUserProfile.block : null, 
            p_intake_year: currentUserProfile ? currentUserProfile.intake_year : null
        });

        if (error) {
            console.error("Check-in failed:", error);
            geoMessage.textContent = `Check-in failed: Error: ${error.message}`;
        } else {
            geoMessage.textContent = `Check-in successful! Logged at ${new Date(checkInTime).toLocaleTimeString()} near **${location.friendly}**.`;
            // ‚úÖ FIX: Now that the function is defined below, this call works!
            loadGeoAttendanceHistory(currentUserId); 
        }

    } catch (e) {
        console.error("GeoCheckIn major failure:", e);
        // The error you were getting landed here
        geoMessage.textContent = `A critical error occurred during check-in: ${e.message}`; 
    } finally {
        if (button) button.disabled = false;
    }
}

// *************************************************************************
// *** 5.1. NEW FUNCTION: Loads Geo Attendance History (Fix for Check-In Error) ***
// *************************************************************************
async function loadGeoAttendanceHistory(userId) {
    const tableBody = document.getElementById('geo-attendance-history');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="6">Loading check-in history...</td></tr>';

    try {
        const { data: logs, error } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .eq('student_id', userId)
            .order('check_in_time', { ascending: false })
            .limit(20); // Limit to last 20 entries for performance

        if (error) throw error;

        tableBody.innerHTML = '';
        if (logs.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">No check-in history found.</td></tr>';
            return;
        }

        logs.forEach(log => {
            const timeStr = new Date(log.check_in_time).toLocaleString();
            const verifiedText = log.is_verified === true ? '‚úÖ Yes' : log.is_verified === false ? '‚ùå No' : '‚è≥ Pending';
            const verifiedStyle = log.is_verified === true ? 'color: #10B981;' : log.is_verified === false ? 'color: #EF4444;' : 'color: #F59E0B;';

            tableBody.innerHTML += `
                <tr>
                    <td>${timeStr}</td>
                    <td>${log.session_type}</td>
                    <td>${log.target_name}</td>
                    <td>${log.location_friendly_name.substring(0, 40)}...</td>
                    <td>${log.accuracy_m.toFixed(1)}</td>
                    <td style="${verifiedStyle}">${verifiedText}</td>
                </tr>
            `;
        });

    } catch (error) {
        console.error("Failed to load geo attendance history:", error);
        tableBody.innerHTML = `<tr><td colspan="6" style="color:#EF4444;">Error: ${error.message}</td></tr>`;
    }
}


// *************************************************************************
// *** 6. SUPABASE DATA LOADING FUNCTIONS (Exams, Resources, Calendar) ***
// *************************************************************************

// ‚úÖ Load user exams
async function loadExams() {
    const tableBody = document.getElementById('exams-table');
    if (!tableBody) {
        console.error("‚ùå Missing <tbody id='exams-table'> in HTML");
        return;
    }

    tableBody.innerHTML = '<tr><td colspan="4">Loading exam schedule...</td></tr>';

    try {
        const program = currentUserProfile?.department;
        const block = currentUserProfile?.block;
        const intakeYear = currentUserProfile?.intake_year;

        if (!program || !block || !intakeYear) {
            tableBody.innerHTML = '<tr><td colspan="4">Missing department, block, or intake year info. Cannot load exams.</td></tr>';
            cachedExams = [];
            return;
        }

        const { data: exams, error } = await sb
            .from('exams_with_courses')
            .select('exam_name, exam_date, status, block_term, program_type, intake_year')
            .or(`program_type.eq.${program},program_type.eq.General`)
            .eq('block_term', block)
            .eq('intake_year', intakeYear)
            .order('exam_date', { ascending: true });

        if (error) throw error;

        cachedExams = exams || [];
        tableBody.innerHTML = '';

        if (cachedExams.length > 0) {
            cachedExams.forEach(exam => {
                const dateStr = exam.exam_date ? new Date(exam.exam_date).toLocaleDateString() : 'N/A';
                tableBody.innerHTML += `
                    <tr>
                        <td>${exam.exam_name || 'N/A'}</td>
                        <td>${exam.block_term || 'N/A'}</td>
                        <td>${dateStr}</td>
                        <td>${exam.status || 'N/A'}</td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="4">No exams or CATs scheduled for your department, block, and intake year yet.</td></tr>';
        }

    } catch (error) {
        console.error("‚ùå Failed to load exams:", error);
        tableBody.innerHTML = `<tr><td colspan="4" style="color:#EF4444;">Error loading exams: ${error.message}</td></tr>`;
        cachedExams = [];
    }

    loadDashboardMetrics(currentUserId);
}

// ‚úÖ Load learning resources
async function loadResources() {
    const resourceList = document.getElementById('resources-list');
    if (!resourceList) return;
    resourceList.innerHTML = 'Loading resources from Supabase...';

    try {
        const program = currentUserProfile?.department;
        const block = currentUserProfile?.block;

        if (!program || !block) {
            resourceList.innerHTML = '<p>Missing enrollment details (department or block).</p>';
            return;
        }

        const { data: resources, error } = await sb
            .from('resources')
            .select('id, title, file_path, program_type, block_term, uploaded_by_name, created_at')
            .or(`program_type.eq.${program},program_type.eq.General`)
            .eq('block_term', block)
            .order('created_at', { ascending: false });

        if (error) throw error;

        resourceList.innerHTML = '';
        if (!resources.length) {
            resourceList.innerHTML = `<p>No learning resources found for ${program}, Block ${block}.</p>`;
            if (document.getElementById('dashboard-new-resources')) document.getElementById('dashboard-new-resources').textContent = '0';
            return;
        }

        resources.forEach(res => {
            const publicUrl = sb.storage.from('materials').getPublicUrl(res.file_path).data.publicUrl;
            resourceList.innerHTML += `
                <div class="resource-item">
                    <div>
                        <a href="${publicUrl}" target="_blank">${res.title}</a>
                        <p style="margin:5px 0 0;font-size:0.9em;color:#6B7280;">
                            ${res.program_type === 'General' ? 'General' : `${res.program_type}, Block ${res.block_term}`} - 
                            Uploaded: ${new Date(res.created_at).toLocaleDateString()}
                        </p>
                    </div>
                    <span style="font-size:1.5em;">&#x1F4C4;</span>
                </div>
            `;
        });

        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const newCount = resources.filter(r => new Date(r.created_at) > oneWeekAgo).length;
        if (document.getElementById('dashboard-new-resources')) document.getElementById('dashboard-new-resources').textContent = newCount;

    } catch (error) {
        console.error("‚ùå Failed to load resources:", error);
        resourceList.innerHTML = `<p style="color:#EF4444;">Error loading resources: ${error.message}</p>`;
    }
}


// *************************************************************************
// *** 7. ACADEMIC CALENDAR LOGIC ***
// *************************************************************************

async function fetchAllScheduleData() {
    const program = currentUserProfile?.department || currentUserProfile?.program; 
    const block = currentUserProfile?.block;
    const intakeYear = currentUserProfile?.intake_year;

    if (!program || !block || !intakeYear) return [];
    
    // 1. Placeholder for Sessions/Clinical Schedules (requires complex table structure)
    const sessionsPromise = Promise.resolve([]); 
    const examsPromise = Promise.resolve([]);

    // 3. Holidays/Academic Events
    const eventsPromise = sb
        .from('calendar_events')
        .select('event_name, event_date, type, description, target_program, target_block, target_intake_year')
        .or(`target_program.eq.${program},target_program.eq.General`)
        .eq('target_block', block)
        .eq('target_intake_year', intakeYear)
        .then(({ data, error }) => {
            if (error) { console.error("Events error:", error); return []; }
            return (data || []).map(e => ({
                date: e.event_date,
                title: e.event_name,
                type: e.type,
                details: e.description
            }));
        });

    const results = await Promise.all([sessionsPromise, examsPromise, eventsPromise]);
    return results.flat();
}

async function loadAcademicCalendar() {
    const tableBody = document.getElementById('calendar-table');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="3">Loading academic schedule...</td></tr>';

    try {
        const allEvents = await fetchAllScheduleData();
        const filterType = document.getElementById('calendar-filter').value;

        // Filtering logic
        const filteredEvents = allEvents
            .filter(e => filterType === 'all' || e.type === filterType)
            .sort((a, b) => new Date(a.date) - new Date(b.date)); 

        tableBody.innerHTML = '';

        if (filteredEvents.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3">No scheduled events found for the selected filter (${filterType}).</td></tr>`;
            return;
        }

        filteredEvents.forEach(event => {
            const dateStr = new Date(event.date).toLocaleString();
            const row = `
                <tr>
                    <td class="date-col">${dateStr}</td>
                    <td>${event.title} (${event.details})</td>
                    <td class="session-type-col ${event.type}">${event.type}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        console.error("Failed to load academic calendar:", error);
        tableBody.innerHTML = '<tr><td colspan="3" style="color:#EF4444;">Error loading calendar data.</td></tr>';
    }
}


// *************************************************************************
// *** 8. MESSAGES LOGIC (Fix for "Error loading messages") ***
// *************************************************************************

async function loadStudentMessages() {
    const messageContainer = document.getElementById('messages-list'); 
    if (!messageContainer) return;
    messageContainer.innerHTML = 'Loading student messages...';
    
    try {
        // Ensure profile is loaded before trying to access department
        if (!currentUserProfile || !currentUserProfile.department) {
             messageContainer.innerHTML = '<p style="color:#F59E0B;">Cannot load messages: Missing enrollment details.</p>';
             return;
        }

        const { data: messages, error } = await sb
            .from('student_messages')
            .select('*')
            // Query: Messages targeted directly at user OR targetted to ALL OR targetted to the student's PROGRAM
            .or(`recipient_id.eq.${currentUserId},recipient_type.eq.All,recipient_program.eq.${currentUserProfile.department}`)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        messageContainer.innerHTML = '';
        if (messages.length === 0) {
            messageContainer.innerHTML = '<p>No new personal or general announcements.</p>';
            return;
        }
        
        messages.forEach(msg => {
            const isRead = msg.is_read ? 'read' : 'unread'; 
            messageContainer.innerHTML += `
                <div class="message-item ${isRead}">
                    <div class="message-header" style="display: flex; justify-content: space-between; font-weight: bold; color: #4C1D95;">
                        <span class="message-title">${msg.subject}</span>
                        <span class="message-date" style="font-weight: normal; color: #6B7280;">${new Date(msg.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="message-body" style="margin-top: 5px; color: #374151;">${msg.body.substring(0, 150)}${msg.body.length > 150 ? '...' : ''}</div>
                    <span class="message-status" style="font-size: 0.8em; color: ${msg.is_read ? '#10B981' : '#F59E0B'}; margin-top: 5px; display: inline-block;">Status: ${isRead.toUpperCase()}</span>
                </div>
            `;
        });
        
    } catch (error) {
        console.error("Failed to load student messages:", error);
        messageContainer.innerHTML = `<p style="color:#EF4444;">Error loading messages: ${error.message}</p>`;
    }
}

const messageForm = document.getElementById('message-form');
if (messageForm) {
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageBody = document.getElementById('student-message-body').value;
        const messageStatus = document.getElementById('message-status');

        if (!messageBody.trim()) {
            messageStatus.textContent = "Message cannot be empty.";
            return;
        }

        messageStatus.textContent = 'Sending message...';
        
        // This assumes a 'student_outbox' or similar table for messages sent TO admin
        const { error } = await sb
            .from('student_outbox') 
            .insert([
                { 
                    student_id: currentUserId,
                    subject: `Message from ${currentUserProfile.full_name}`,
                    body: messageBody,
                    // Additional fields might be needed, like recipient_role ('Admin')
                }
            ]);

        if (error) {
            messageStatus.textContent = `Error sending message: ${error.message}`;
        } else {
            messageStatus.textContent = 'Message sent successfully to Administration!';
            document.getElementById('student-message-body').value = ''; 
        }
    });
}


// *************************************************************************
// *** 9. INITIALIZATION ***
// *************************************************************************

// Start the authentication check once the script is loaded
checkAuthAndLoad();

</script>
</body>
</html>
