<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
        * CRITICAL FIX: Only show the active tab content
        */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Set Inter font and warmer background */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f8f9fa; /* Light background */
        }

        /* Sidebar link styling */
        .nav-link {
            transition: all 0.2s ease-in-out;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            border-radius: 0.75rem; /* Smoother corners */
        }
        .nav-link:hover {
            background-color: #1e293b; /* Slate 800 on hover */
        }
        .nav-link.active {
            background-color: #10b981; /* Emerald 500 for active link */
            color: #ffffff;
            font-weight: 600;
        }
        
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #e2e8f0; /* Light grey */
            border-top: 4px solid #10b981; /* Emerald */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        /* Small Loader for async content */
        .loader-small {
            border: 3px solid #f3f3f3; /* Light grey */
            border-top: 3px solid #10b981; /* Emerald */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Styling */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;} 
            to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
    </style>
    <!-- Use lucide-react icons equivalent for visual elements -->
    <!-- Dummy icon styles for the sake of presentation -->
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Main Content Wrapper -->
    <div id="app-container" class="flex flex-col lg:flex-row min-h-screen">

        <!-- Sidebar (Hidden on mobile by default) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:relative lg:flex lg:flex-col w-64 bg-slate-900 text-white p-4 space-y-4 transition-transform duration-300 z-50 shadow-2xl">
            <div class="text-2xl font-bold text-emerald-400 mb-6">
                NCHSM Portal
            </div>
            
            <nav class="flex-grow space-y-2">
                <a href="#" data-tab="dashboard" class="nav-link active" id="dashboard-link">
                    <!-- Icon for Dashboard -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Dashboard
                </a>
                <a href="#" data-tab="attendance" class="nav-link" id="attendance-link">
                    <!-- Icon for Attendance -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 10V6"/><path d="M18 10V6"/><path d="M20 18v-8"/></svg>
                    Attendance Check-in
                </a>
                <a href="#" data-tab="docs" class="nav-link" id="docs-link">
                    <!-- Icon for Documents -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Documents
                </a>
            </nav>

            <a href="#" class="nav-link bg-red-700 hover:bg-red-800" id="logout-link">
                <!-- Icon for Logout -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                Logout
            </a>
            
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 transition-all duration-300 overflow-y-auto">
            <!-- Header for Mobile -->
            <header class="flex justify-between items-center lg:hidden mb-4">
                <div class="text-xl font-bold text-slate-800">NCHSM Portal</div>
                <button id="menu-toggle" class="p-2 rounded-md text-slate-800 hover:bg-gray-200 focus:outline-none">
                    <!-- Menu Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="18" y2="18"/></svg>
                </button>
            </header>

            <!-- Loading Screen / Authentication required -->
            <div id="loading-screen" class="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center z-40 transition-opacity duration-500">
                <div class="loader mb-4"></div>
                <p class="text-lg font-medium text-slate-600" id="loading-message">Initializing...</p>
            </div>

            <!-- Content Tabs -->
            <div id="content-area" class="hidden">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-6">Student Dashboard</h1>
                
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active bg-white p-6 md:rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-2 text-emerald-600">Welcome!</h2>
                    <div id="welcome-message" class="bg-gray-50 p-4 rounded-xl shadow-inner text-gray-700 italic border-l-4 border-emerald-500 min-h-[5rem] flex items-center justify-center">
                        <span class="loader-small"></span> Loading welcome message...
                    </div>
                    <p class="mt-4 text-gray-600">This is your main student portal. Please use the navigation on the left to manage your attendance and view documents.</p>
                </div>

                <!-- Attendance Check-in Tab -->
                <div id="tab-attendance" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-6 border-b pb-2">Daily Attendance Check-in</h2>
                    
                    <div class="mb-6 bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                        <p class="text-sm font-semibold text-emerald-700">User ID:</p>
                        <p id="current-user-id" class="break-all font-mono text-xs text-emerald-600 mt-1"></p>
                    </div>

                    <form id="attendance-form" class="space-y-4 max-w-lg">
                        <div>
                            <label for="session-type-select" class="block text-sm font-medium text-gray-700 mb-1">Session Type:</label>
                            <select id="session-type-select" name="session-type" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm bg-white">
                                <option value="" disabled selected>Select Session Type</option>
                                <option value="class">On Class</option>
                                <option value="clinicals">On Clinicals</option>
                            </select>
                        </div>

                        <div>
                            <label id="session-detail-label" for="session-detail-select" class="block text-sm font-medium text-gray-700 mb-1">Detail (Course/Department):</label>
                            <select id="session-detail-select" name="session-detail" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm bg-white" disabled>
                                <option value="" disabled selected>Select a Detail</option>
                            </select>
                        </div>
                        
                        <button id="check-in-button" type="submit" disabled
                            class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-xl text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            Check In
                        </button>
                    </form>

                    <h3 class="text-xl font-bold text-slate-700 mt-8 mb-4 border-b pb-2">Recent Attendance</h3>
                    <div id="recent-attendance-list" class="space-y-3">
                        <div class="text-gray-500">Loading attendance history...</div>
                    </div>
                </div>

                <!-- Documents Tab (Placeholder) -->
                <div id="tab-docs" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">Academic Documents</h2>
                    <p class="text-gray-600">This section will contain links to important academic resources, handbooks, and clinical protocols.</p>
                    <ul class="mt-4 space-y-2 text-emerald-600">
                        <li><a href="#" class="hover:underline">Student Handbook 2024 (PDF)</a></li>
                        <li><a href="#" class="hover:underline">Clinical Rotation Schedule (XLSX)</a></li>
                        <li><a href="#" class="hover:underline">Emergency Protocol Checklist</a></li>
                    </ul>
                </div>
            </div>
        </main>

        <!-- Toast Notification -->
        <div id="toast" class="toast-hidden"></div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App variables
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = 'Anonymous';

        // Firestore Paths
        const ATTENDANCE_COLLECTION_NAME = 'attendance';
        const SETTINGS_PATH = 'settings';
        const WELCOME_DOC_ID = 'welcome_message';

        // Mock Data for dynamic dropdowns
        const COURSES = [
            { id: 'anatomy', name: 'Anatomy 101' },
            { id: 'physiology', name: 'Physiology 202' },
            { id: 'pharm', name: 'Pharmacology 303' },
            { id: 'pathology', name: 'Pathology 404' },
        ];

        const DEPARTMENTS = [
            { id: 'pediatrics', name: 'Pediatrics' },
            { id: 'surgery', name: 'General Surgery' },
            { id: 'er', name: 'Emergency Room' },
            { id: 'icu', name: 'Intensive Care Unit (ICU)' },
            { id: 'obgyn', name: 'Obstetrics/Gynecology (OB-GYN)' },
        ];

        // UI Elements
        const loadingScreen = document.getElementById('loading-screen');
        const contentArea = document.getElementById('content-area');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const logoutLink = document.getElementById('logout-link');
        const checkInButton = document.getElementById('check-in-button');
        const sessionTypeSelect = document.getElementById('session-type-select');
        const sessionDetailSelect = document.getElementById('session-detail-select');
        const attendanceForm = document.getElementById('attendance-form');
        const attendanceList = document.getElementById('recent-attendance-list');
        const userIdDisplay = document.getElementById('current-user-id');
        const welcomeMessageElement = document.getElementById('welcome-message');

        // --- Utility Functions ---

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'show';
            toast.style.backgroundColor = isError ? '#ef4444' : '#10b981';
            setTimeout(function(){ toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function showLogoutToast() {
            showToast("Logging out...", false);
        }

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-tab') === tabId) {
                    link.classList.add('active');
                }
            });
        }

        // --- Attendance Functions ---

        // Function to validate the form state
        function validateAttendanceForm() {
            const typeSelected = sessionTypeSelect.value !== '';
            const detailSelected = sessionDetailSelect.value !== '';
            
            if (typeSelected && detailSelected) {
                checkInButton.disabled = false;
            } else {
                checkInButton.disabled = true;
            }
            // Ensure the detail select is enabled if a type is chosen
            sessionDetailSelect.disabled = !typeSelected;
        }

        // Function to update the detail dropdown based on session type
        function updateAttendanceDetail(sessionType) {
            const sessionDetailSelect = document.getElementById('session-detail-select');
            sessionDetailSelect.innerHTML = '<option value="" disabled selected>Select a Detail</option>';
            let details = [];
            let labelText = 'Detail (Course/Department):'; 

            if (sessionType === 'class') {
                details = COURSES;
                labelText = 'Course:';
            } else if (sessionType === 'clinicals') {
                details = DEPARTMENTS;
                labelText = 'Hospital Department:';
            }

            // Update the label dynamically
            document.getElementById('session-detail-label').textContent = labelText;
            
            // Populate options
            details.forEach(detail => {
                const option = document.createElement('option');
                option.value = detail.id;
                option.textContent = detail.name;
                sessionDetailSelect.appendChild(option);
            });

            // Re-validate the form after updating details
            validateAttendanceForm();
        }

        // --- Firestore Functions ---

        // Function to set default welcome message if it doesn't exist (simulating admin setup)
        async function ensureDefaultWelcomeMessage(db, appId) {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', SETTINGS_PATH, WELCOME_DOC_ID);
            
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.log("Setting default welcome message...");
                    await setDoc(docRef, {
                        message: "A warm welcome to the NCHSM Student Portal! This is a default message. Admins can update this message anytime.",
                        lastUpdated: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error ensuring default welcome message:", e);
            }
        }


        // Function to load the welcome message in real-time
        function loadWelcomeMessage(db, appId) {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', SETTINGS_PATH, WELCOME_DOC_ID);

            // Set up real-time listener
            return onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().message) {
                    welcomeMessageElement.classList.remove('justify-center');
                    welcomeMessageElement.innerHTML = docSnap.data().message;
                } else {
                    welcomeMessageElement.classList.add('justify-center');
                    welcomeMessageElement.innerHTML = "No welcome message configured by the admin yet.";
                }
            }, (error) => {
                console.error("Error loading welcome message:", error);
                welcomeMessageElement.classList.add('justify-center');
                welcomeMessageElement.innerHTML = "Error loading message. Please try refreshing.";
            });
        }

        function loadRecentAttendance(db, appId, userId) {
            const attendancePath = `artifacts/${appId}/users/${userId}/${ATTENDANCE_COLLECTION_NAME}`;
            const q = collection(db, attendancePath); // No orderBy to avoid index errors, will sort client-side.

            // Clear previous list content and show loading
            attendanceList.innerHTML = '<div class="flex items-center text-gray-500"><span class="loader-small"></span> Loading history...</div>';

            onSnapshot(q, (snapshot) => {
                const attendanceRecords = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate();
                    }
                    attendanceRecords.push(data);
                });

                // Sort the records client-side by timestamp (latest first)
                attendanceRecords.sort((a, b) => b.timestamp - a.timestamp);

                if (attendanceRecords.length === 0) {
                    attendanceList.innerHTML = '<p class="text-gray-500 italic">No attendance records found yet. Check in to start!</p>';
                    return;
                }

                attendanceList.innerHTML = ''; // Clear loading message

                attendanceRecords.slice(0, 10).forEach(record => {
                    const dateStr = record.timestamp ? record.timestamp.toLocaleString() : 'N/A';
                    const typeDisplay = record.type === 'class' ? 'Class' : 'Clinical';
                    
                    let detailName = 'N/A';
                    if (record.type === 'class') {
                        const course = COURSES.find(c => c.id === record.detail);
                        detailName = course ? course.name : record.detail;
                    } else if (record.type === 'clinicals') {
                        const department = DEPARTMENTS.find(d => d.id === record.detail);
                        detailName = department ? department.name : record.detail;
                    }

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200';
                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-slate-700">${typeDisplay} Check-in</p>
                            <p class="text-sm text-gray-600">${detailName}</p>
                        </div>
                        <span class="text-xs text-gray-500">${dateStr}</span>
                    `;
                    attendanceList.appendChild(item);
                });

            }, (error) => {
                console.error("Error fetching attendance records:", error);
                attendanceList.innerHTML = '<p class="text-red-500">Error loading attendance history. Check console for details.</p>';
            });
        }


        async function handleCheckIn(e) {
            e.preventDefault();
            checkInButton.disabled = true;
            checkInButton.textContent = 'Checking In...';
            
            const sessionType = sessionTypeSelect.value;
            const sessionDetail = sessionDetailSelect.value;

            if (!sessionType || !sessionDetail) {
                showToast("Please select both Session Type and Detail.", true);
                checkInButton.disabled = false;
                checkInButton.textContent = 'Check In';
                return;
            }

            try {
                const attendancePath = `artifacts/${appId}/users/${currentUserId}/${ATTENDANCE_COLLECTION_NAME}`;
                const colRef = collection(db, attendancePath);
                
                const attendanceData = {
                    userId: currentUserId,
                    userName: currentUserEmail || currentUserId,
                    timestamp: serverTimestamp(),
                    type: sessionType,
                    detail: sessionDetail,
                };

                await addDoc(colRef, attendanceData);
                
                showToast("Attendance successfully recorded!", false);
                
                // Reset form state
                sessionTypeSelect.value = '';
                sessionDetailSelect.innerHTML = '<option value="" disabled selected>Select a Detail</option>';
                document.getElementById('session-detail-label').textContent = 'Detail (Course/Department):';
                validateAttendanceForm();

            } catch (error) {
                console.error("Error checking in:", error);
                showToast(`Check-in failed: ${error.message}`, true);
            } finally {
                checkInButton.textContent = 'Check In';
                validateAttendanceForm();
            }
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // CRITICAL: Initialize Firebase from global config
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (Object.keys(firebaseConfig).length === 0) {
                 document.getElementById('loading-message').textContent = 'Firebase configuration missing.';
                 return;
            }

            try {
                // Set Firestore log level for debugging
                setLogLevel('Debug');
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('loading-message').textContent = 'Firebase initialization failed. Check console.';
                return;
            }

            // CRITICAL: Authentication listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email || 'Anonymous';
                    userIdDisplay.textContent = currentUserId;

                    loadingScreen.classList.add('hidden');
                    contentArea.classList.remove('hidden');

                    // NEW: Load and ensure welcome message
                    await ensureDefaultWelcomeMessage(db, appId);
                    loadWelcomeMessage(db, appId);

                    // Load user-specific attendance records
                    loadRecentAttendance(db, appId, currentUserId);
                    
                    showToast(`Welcome back, ${currentUserEmail}!`);

                } else {
                    currentUserId = null;
                    currentUserEmail = 'Anonymous';
                    
                    // Attempt sign in
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        document.getElementById('loading-message').textContent = 'Authentication required.';
                        loadingScreen.classList.remove('hidden');
                        contentArea.classList.add('hidden');
                    }
                }
            });

            // --- Event Listeners ---
            
            // Attendance check-in event
            attendanceForm.addEventListener('submit', handleCheckIn);

            menuToggle.addEventListener('click', toggleSidebar);

            // Navigation handler
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (link.id === 'logout-link') return;
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        showTab(tabId);
                    }
                    // Close sidebar on small screens after clicking a link
                    if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            });

            // CRITICAL FIX: Logout functionality implemented
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                showLogoutToast();
                if (auth) {
                    try {
                        await signOut(auth);
                        // onAuthStateChanged will handle the UI update after successful sign out
                    } catch (error) {
                        console.error("Logout failed:", error);
                        showToast("Logout failed.", true);
                    }
                }
            });

            // NEW: Handle session type change to update details
            sessionTypeSelect.addEventListener('change', (e) => {
                updateAttendanceDetail(e.target.value);
            });

            // Detail change triggers validation (user must select an item)
            sessionDetailSelect.addEventListener('change', validateAttendanceForm);

            // Initial form validation on load
            validateAttendanceForm();
        });
    </script>
</body>
</html>
