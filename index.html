<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Digital Student Dashboard</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="indexstyle.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4C1D95">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Windows PWA Support -->
    <meta name="msapplication-TileColor" content="#4C1D95">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Mobile PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- EMERGENCY FIX -->
    <style>
    /* Immediate fix to hide footer from sidebar */
    aside.sidebar .app-footer,
    aside.sidebar footer {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Hide any dashboard content in sidebar */
    aside.sidebar .tab-content,
    aside.sidebar .card,
    aside.sidebar .welcome-card,
    aside.sidebar .cards {
        display: none !important;
    }
    
    /* Ensure sidebar only shows nav */
    .sidebar {
        display: flex !important;
        flex-direction: column !important;
    }
    
    .sidebar > *:not(.sidebar-header):not(.nav):not(.logout) {
        display: none !important;
    }
    
    .sidebar-header, .nav, .logout {
        display: block !important;
    }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i> You are offline. Some features may be unavailable.
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <div class="header-title-container">
            <span>NCHSM Digital Student Portal</span>
            <img 
                id="header-passport-preview" 
                src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" 
                alt="Profile Photo" 
                class="header-profile-photo"
            />
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="overlay" onclick="closeMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar Navigation - CLEANED UP -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
                <li><a href="#" data-tab="nurseiq" class="nurseiq-nav">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-brain"></i>
                        <span class="nav-pulse"></span>
                    </div>
                    <span class="nav-text">NurseIQ</span>
                    <span class="nav-subtitle">Assessment Center</span>
                    <span class="nav-badge" id="nurseiqBadge">0</span>
                </a></li>
                <li><a href="#" data-tab="coming-soon-quizlets">üìù Coming Soon: Quizlets</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
            <!-- NO FOOTER HERE! -->
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <div id="welcome-section" class="welcome-card">
                    <h2 id="welcome-header">Welcome back, Student!</h2>
                    <p id="student-welcome-message">Access your courses, schedule, and check your attendance status.</p>
                </div>

                <div id="announcement-banner">
                    <span class="info-icon">üì£</span>
                    <div>
                        <strong>Official Announcement:</strong>
                        <p id="student-announcement">Loading latest announcement...</p>
                    </div>
                </div>

                <h2 style="margin-top: 20px; color: var(--color-primary); font-weight: 700;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card alert-card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Verified Check-ins: <strong id="dashboard-verified-count">0</strong> / <strong id="dashboard-total-count">0</strong></small>
                        <small style="display:block; margin-top: 5px; color:var(--color-alert);">Pending Review: <strong id="dashboard-pending-count">0</strong></small>
                    </div>

                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 700; color: #F97316;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>

                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>

                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last 7 days</small>
                    </div>

                    <!-- NurseIQ Card on Dashboard -->
                    <div class="card nurseiq-card" onclick="showTab('nurseiq')" style="border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-brain" style="color: #8B5CF6; font-size: 1.2rem;"></i>
                            <h3 style="margin: 0;">NurseIQ Progress</h3>
                        </div>
                        <p class="data" id="dashboard-nurseiq-progress">--%</p>
                        <small>Accuracy: <strong id="dashboard-nurseiq-accuracy">--%</strong></small>
                        <small style="display:block; margin-top: 5px; color: var(--color-primary);">Questions: <strong id="dashboard-nurseiq-questions">0</strong> completed</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: var(--color-primary); font-weight: 700;">Action Required</h2>
                <div id="dashboard-actions">
                    <div id="action-passport" class="card" style="border-left-color: var(--color-alert); cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    
                    <div class="card" style="border-left-color: var(--color-warning); cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: var(--color-warning);">View Resources</button>
                    </div>
                    
                    <div id="latest-announcement-card" class="card" style="border-left-color: var(--color-success); display: none; cursor: pointer;">
                        <h4><span id="announcement-title" style="color: var(--color-primary);">Loading...</span></h4>
                        <p id="announcement-body" style="margin-bottom: 10px;">Loading message body...</p>
                        <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                            <span id="announcement-date"></span> | 
                            <span id="announcement-status" style="font-weight: bold;"></span>
                        </div>
                        <button onclick="showTab('messages')" class="profile-button" style="background-color: var(--color-primary); margin-top: 15px;">Go to Messages Tab</button>
                    </div>

                    <!-- NurseIQ Action Card -->
                    <div id="nurseiq-action-card" class="card" style="border-left-color: #8B5CF6; cursor: pointer; display: none;">
                        <h3><i class="fas fa-brain" style="margin-right: 8px;"></i> NurseIQ Practice Needed</h3>
                        <p id="nurseiq-action-message">Complete your NurseIQ assessments to improve your scores.</p>
                        <button onclick="showTab('nurseiq')" class="profile-button" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); margin-top: 10px;">
                            <i class="fas fa-play-circle"></i> Start Practicing
                        </button>
                    </div>
                </div>
            </section>

            <!-- Profile Tab -->
            <section id="profile" class="tab-content">
                <h2 style="color: var(--color-primary);">My Profile & Account</h2>
                <form id="profile-form">
                    <div class="profile-media">
                        <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>
                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>

            <!-- Calendar Tab -->
            <section id="calendar" class="tab-content">
                <h2 style="color: var(--color-primary);">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter" onchange="loadAcademicCalendar()">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <div style="overflow-x: auto;"> 
                    <table>
                        <thead>
                            <tr>
                                <th class="date-col">Date & Time</th>
                                <th>Event / Details</th>
                                <th class="session-type-col">Type</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-table">
                            <tr><td colspan="3">Loading academic schedule...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses Tab -->
            <section id="courses" class="tab-content">
                <h2 style="color: var(--color-primary);">My Courses</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Unit Code</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table">
                            <tr><td colspan="4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Attendance Tab -->
            <section id="attendance" class="tab-content">
                <h2 style="color: var(--color-primary);">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>

                    <p id="geo-message">Select a <strong>Session Type</strong> and then a specific <strong>Department or Course</strong> to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: var(--color-primary);">Past Attendance History (Check-in Logs)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Session Type</th>
                                <th>Target</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="geo-attendance-history">
                            <tr><td colspan="4">Loading geo check-in history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Exams Tab -->
            <section id="cats" class="tab-content">
                <h2 style="color: var(--color-primary); font-size: 1.6rem; margin-bottom: 5px;">CATS / Exams & Grades</h2>
                <p style="color: #6B7280; margin-bottom: 20px;">Provisional results</p>

                <div class="exam-controls" style="margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
                    <label for="exam-type-filter" style="font-weight:600; color:#374151;">Filter by Type:</label>
                    <select id="exam-type-filter" onchange="loadExams()" 
                            style="padding:6px 10px; border:1px solid #D1D5DB; border-radius:6px; background:white; color:#111827;">
                        <option value="all">Show All (CATS & Exams)</option>
                        <option value="CAT">Show Only CATS</option>
                        <option value="Final">Show Only Final Exams</option>
                    </select>
                </div>

                <div style="overflow-x: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius:8px;">
                    <table id="exams-grades-table" style="width:100%; border-collapse:collapse; min-width:700px;">
                        <thead style="background-color:#F3F4F6; color:#111827; font-weight:600;">
                            <tr>
                                <th style="padding:10px 12px;">Exam Name</th>
                                <th style="padding:10px 12px;">Block</th>
                                <th style="padding:10px 12px;">Date</th>
                                <th style="padding:10px 12px;">Status</th>
                                <th style="padding:10px 12px;">CAT 1</th>
                                <th style="padding:10px 12px;">CAT 2</th>
                                <th style="padding:10px 12px;">Final Exam</th>
                                <th style="padding:10px 12px;">Total (%)</th>
                                <th style="padding:10px 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table" style="background:white;">
                            <tr>
                                <td colspan="9" style="padding:12px; text-align:center; color:#6B7280;">Loading your exams and grades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Enhanced Resources Tab - VIEW ONLY -->
            <section id="resources" class="tab-content">
                <div class="resources-header">
                    <h2 style="color: var(--color-primary); margin-bottom: 8px;">Learning Resources</h2>
                    <p class="subtitle" style="margin-bottom: 20px;">View your course materials and study resources</p>
                    
                    <!-- Mobile-Optimized Controls -->
                    <div class="resources-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="resource-search" placeholder="Search resources...">
                        </div>
                        
                        <div class="filter-group">
                            <select id="resource-filter">
                                <option value="all">All Resources</option>
                                <option value="pdf">PDF Notes</option>
                                <option value="video">Video Lectures</option>
                                <option value="slides">Presentation Slides</option>
                            </select>
                            
                            <select id="course-filter">
                                <option value="all">All Courses</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile-First Resources Grid -->
                <div class="resources-grid" id="resources-grid">
                    <!-- Resources will be loaded here dynamically -->
                    <div class="loading-state">Loading resources...</div>
                </div>

                <!-- Mobile Reader View -->
                <div id="mobile-reader" class="mobile-reader" style="display: none;">
                    <div class="reader-header">
                        <button class="reader-back" onclick="closeReader()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 id="reader-title">Resource Title</h3>
                        <div class="view-only-badge">
                            <i class="fas fa-eye"></i> View Only
                        </div>
                    </div>
                    <div class="reader-content" id="reader-content">
                        <!-- Resource content will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Messages Tab -->
            <section id="messages" class="tab-content">
                <h2 style="color: var(--color-primary);">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>

                <div id="messages-list"></div>
            </section>
<!-- NurseIQ Tab -->
<section id="nurseiq" class="tab-content">
    <h1>NurseIQ Question Bank</h1>
    <p class="subtitle">KRCHN Curriculum practice questions for Kenya Registered Community Health Nursing program</p>
    
    <!-- Only Question Bank Mode -->
    <div id="questionBankModeContent">
        <!-- Student Question Bank -->
        <div class="question-bank-section" style="background: white; border-radius: 12px; padding: 25px; margin: 25px 0; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; color: #4f46e5; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-database"></i>
                        Question Bank
                    </h2>
                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">
                        Browse KRCHN questions organized by courses - Click any course to start a test
                    </p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="background: #4f46e5; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                        <i class="fas fa-play-circle"></i> Interactive Tests
                    </div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1; position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                        <input type="text" id="studentQuestionBankSearch" placeholder="Search courses..." 
                               style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    <button onclick="loadQuestionBankCards()" style="background: #4f46e5; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button onclick="clearQuestionBankSearch()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-redo"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="studentQuestionBankLoading" style="display: none; text-align: center; padding: 40px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 15px; color: #6b7280;">Loading courses...</p>
            </div>
            
            <!-- Main Content Area -->
            <div id="studentQuestionBankContent">
                <!-- Initial welcome message -->
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="display: inline-block; width: 80px; height: 80px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-book-medical" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="color: #4f46e5; margin-bottom: 10px;">NurseIQ Question Bank</h3>
                    <p style="color: #6b7280; max-width: 500px; margin: 0 auto 30px;">
                        Access practice questions organized by KRCHN courses. Click any course card to start a practice test.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #4f46e5;">62</div>
                            <div style="font-size: 13px; color: #6b7280;">Total Questions</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">2</div>
                            <div style="font-size: 13px; color: #6b7280;">Total Courses</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">62</div>
                            <div style="font-size: 13px; color: #6b7280;">Active Questions</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">100%</div>
                            <div style="font-size: 13px; color: #6b7280;">Active Rate</div>
                        </div>
                    </div>
                    
                    <button onclick="loadQuestionBankCards()" 
                            style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s;">
                        <i class="fas fa-play-circle"></i>
                        Load Course Catalog
                    </button>
                    
                    <p style="margin-top: 20px; color: #6b7280; font-size: 13px;">
                        <i class="fas fa-info-circle"></i> Courses will load with detailed statistics
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

/* Course card animations */
.course-card {
    animation: fadeIn 0.5s ease forwards;
    transition: all 0.3s ease;
}

.course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12) !important;
}

/* Question card animations */
.question-card {
    animation: slideIn 0.3s ease forwards;
    transition: all 0.3s ease;
}

.question-card:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* Button hover effects */
.start-test-btn {
    transition: all 0.3s ease !important;
}

.start-test-btn:hover {
    transform: scale(1.02) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

/* Test navigation dot animations */
.question-dot {
    transition: all 0.2s ease;
}

.question-dot:hover {
    transform: scale(1.1);
}

/* Progress bar animation */
.progress-fill {
    transition: width 0.5s ease-in-out;
}

/* Option hover effects */
.option {
    transition: all 0.2s ease !important;
}

.option:hover {
    transform: translateX(5px) !important;
    border-color: #4f46e5 !important;
}

/* Flag animation */
@keyframes flagWave {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
    100% { transform: rotate(0deg); }
}

.flagged {
    animation: flagWave 0.5s ease;
}

/* Loading animation for stats */
@keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.stat-number {
    animation: countUp 0.8s ease-out;
}

/* Search input focus effect */
#studentQuestionBankSearch:focus {
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
    outline: none;
}

/* Test container animations */
.test-container {
    animation: fadeIn 0.4s ease forwards;
}

/* Results animations */
.results-container {
    animation: slideIn 0.5s ease forwards;
}

.results-card {
    animation: fadeIn 0.6s ease forwards;
    animation-delay: 0.1s;
}
</style>

            <!-- Coming Soon Quizlets Tab -->
            <section id="coming-soon-quizlets" class="tab-content">
                <div style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-tools" style="font-size: 4rem; color: #9CA3AF; margin-bottom: 20px;"></i>
                    <h2 style="color: #4C1D95;">Coming Soon: Quizlets</h2>
                    <p style="color: #6B7280; max-width: 500px; margin: 0 auto 30px;">
                        We're working on interactive quizlets to help you study better. 
                        This feature will be available soon!
                    </p>
                    <div class="progress-bar" style="width: 300px; height: 10px; background: #E5E7EB; border-radius: 5px; margin: 30px auto;">
                        <div class="progress-fill" style="width: 65%; height: 100%; background: linear-gradient(135deg, #4C1D95, #7C3AED); border-radius: 5px;"></div>
                    </div>
                    <p style="color: #9CA3AF; font-size: 0.9rem;">Development in progress - 65% complete</p>
                </div>
            </section>

            <!-- Toast Notification -->
            <div class="toast" id="toast" style="display: none;"></div>

            <!-- FOOTER MOVED INSIDE MAIN (Correct location) -->
            <footer class="app-footer">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>Nakuru College of Health Sciences and Management (NCHSM)</h3>
                        <p>Providing quality health sciences and management education with practical skills and digital innovation.</p>
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Kiamunyi Off Nakuru - Kabarak Rd, Along Canon Ndungu Street, Nakuru</span>
                        </div>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Contact Information</h3>
                        <div class="footer-contact">
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span>portal.nchsm@gmail.com</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span>0790969743</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-map-pin"></i>
                                <span>P. O. Box 12906 - 20100, Nakuru</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-clock"></i>
                                <span>Mon - Fri: 8:00 AM - 5:00 PM</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="#" onclick="showTab('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                            <li><a href="#" onclick="showTab('courses')"><i class="fas fa-book"></i> My Courses</a></li>
                            <li><a href="#" onclick="showTab('calendar')"><i class="fas fa-calendar"></i> Academic Calendar</a></li>
                            <li><a href="#" onclick="showTab('resources')"><i class="fas fa-file-pdf"></i> Resources</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#" onclick="showTab('messages')"><i class="fas fa-question-circle"></i> Contact Admin</a></li>
                            <li><a href="#" id="clearCacheBtn"><i class="fas fa-broom"></i> Clear Cache</a></li>
                            <li><a href="#" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</a></li>
                            <li><a href="#" onclick="showSystemInfo()"><i class="fas fa-info-circle"></i> System Info</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="copyright">
                        ¬© 2025 Nakuru College of Health Sciences and Management. All rights reserved.
                        <span id="appVersion" style="margin-left: 10px; opacity: 0.7;">v2.1</span>
                    </div>
                    <div class="footer-social">
                        <a href="https://facebook.com" class="social-icon" target="_blank" aria-label="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://twitter.com" class="social-icon" target="_blank" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://instagram.com" class="social-icon" target="_blank" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="mailto:portal.nchsm@gmail.com" class="social-icon" aria-label="Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Transcript Modal - No Print -->
    <div id="transcript-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:16px; border-radius:8px; max-width:350px; width:90%; position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <button onclick="closeTranscriptModal()" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:1.2em; cursor:pointer; color:#6B7280; padding:4px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%;">√ó</button>
            
            <!-- Header -->
            <div style="text-align:center; margin-bottom:15px; padding-bottom:8px; border-bottom:1px solid var(--color-primary, #4F46E5);">
                <h4 style="margin:0; color: var(--color-primary, #4F46E5); font-size:1.1em; font-weight:600;">
                    <i class="fas fa-file-alt" style="margin-right:6px;"></i> Exam Transcript
                </h4>
                <p id="transcript-exam-name" style="margin:5px 0 0; font-size:0.85em; color:#6B7280;"></p>
            </div>
            
            <!-- Scores Table -->
            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:10px;">
                <tr>
                    <td style="font-weight:600; padding:6px 0; width:50%;">CAT 1 (30):</td>
                    <td id="transcript-cat1" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 2 (30):</td>
                    <td id="transcript-cat2" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Final (40):</td>
                    <td id="transcript-final" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr style="border-top:1px solid #e5e7eb;">
                    <td style="font-weight:700; padding:8px 0;">Total Score:</td>
                    <td id="transcript-total" style="padding:8px 0; font-weight:700; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:700; padding:6px 0;">Status:</td>
                    <td id="transcript-status" style="padding:6px 0; font-weight:700; text-align:right;"></td>
                </tr>
            </table>
            
            <!-- Note -->
            <div style="margin-top:10px; padding:8px; background:#f0f9ff; border-radius:4px; font-size:0.8em; color:#0369a1; border-left:3px solid #0ea5e9;">
                <i class="fas fa-info-circle" style="margin-right:5px;"></i>
                Provisional - subject to moderation
            </div>
            
            <!-- Close Button Only -->
            <div style="margin-top:15px; text-align:center;">
                <button onclick="closeTranscriptModal()" style="padding:8px 20px; background:var(--color-primary, #4F46E5); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.9em; font-weight:500; width:100%;">
                    Close Transcript
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // *************************************************************************
        // *** SECURE CONFIGURATION - Loads from GitHub Secrets via config.js ***
        // *************************************************************************

        // Hides the .html extension in the URL
        if (window.location.pathname.endsWith('.html')) {
            const cleanPath = window.location.pathname.replace(/\.html$/, '');
            window.history.replaceState({}, '', cleanPath);
        }

        // Configuration validation
        function validateConfig() {
            if (!window.APP_CONFIG) {
                console.error('‚ùå APP_CONFIG not loaded - check config.js');
                return false;
            }

            const required = ['SUPABASE_URL', 'SUPABASE_ANON_KEY', 'LOCATIONIQ_API_KEY'];
            const missing = required.filter(key => !window.APP_CONFIG[key]);
            
            if (missing.length > 0) {
                console.error('‚ùå Missing configuration:', missing);
                return false;
            }
            
            console.log('‚úÖ Configuration loaded successfully from GitHub Secrets');
            console.log('Build:', window.APP_CONFIG.BUILD_TIME, 'Commit:', window.APP_CONFIG.COMMIT_SHA);
            return true;
        }

        // Show configuration error
        function showConfigurationError() {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: 'Inter', sans-serif; background: #f8f8f8; height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div style="max-width: 500px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h2 style="color: #EF4444; margin-bottom: 20px;">üö´ Configuration Error</hh2>
                        <p style="color: #6B7280; margin-bottom: 20px;">The application failed to load configuration.</p>
                        <div style="background: #FEF2F2; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                            <strong>Possible issues:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>GitHub Secrets not configured</li>
                                <li>Deployment in progress</li>
                                <li>Configuration file missing</li>
                            </ul>
                        </div>
                        <button onclick="window.location.reload()" style="background: #4C1D95; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                            Retry
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize application with secure configuration
        function initializeApplication() {
            if (!validateConfig()) {
                showConfigurationError();
                return;
            }

            // Extract configuration from GitHub Secrets
            const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
            const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
            const LOCATIONIQ_API_KEY = window.APP_CONFIG.LOCATIONIQ_API_KEY;
            
            console.log('üîß Initializing Supabase with secure configuration...');
            
            // Initialize Supabase client
            const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';
            
            // Set PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Start the main application
            startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL);
        }

        // *************************************************************************
        // *** OFFLINE SUPPORT & SERVICE WORKER ***
        // *************************************************************************
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swUrl = '/sw.js';
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ New Service Worker found:', newWorker.state);
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('New version available! Refresh to update.', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // Offline Support System
        const OfflineManager = {
            queue: [],
            isOnline: navigator.onLine,
            isSyncing: false,

            init() {
                this.loadQueue();
                this.setupEventListeners();
                this.startSyncInterval();
                this.updateConnectionStatus();
            },

            loadQueue() {
                const saved = localStorage.getItem('offlineQueue');
                this.queue = saved ? JSON.parse(saved) : [];
                this.updateQueueDisplay();
            },

            saveQueue() {
                localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
                this.updateQueueDisplay();
            },

            addToQueue(action, data) {
                const queueItem = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    action,
                    data,
                    timestamp: new Date().toISOString(),
                    attempts: 0,
                    maxAttempts: 3
                };

                this.queue.push(queueItem);
                this.saveQueue();
                
                if (this.isOnline) {
                    this.processQueue();
                } else {
                    showToast('Action saved offline. Will sync when online.', 'warning');
                }
            },

            async processQueue() {
                if (this.isSyncing || this.queue.length === 0 || !this.isOnline) return;

                this.isSyncing = true;
                this.updateSyncStatus('syncing');

                try {
                    while (this.queue.length > 0) {
                        const item = this.queue[0];
                        const success = await this.executeAction(item);

                        if (success) {
                            this.queue.shift(); // Remove successful item
                        } else {
                            item.attempts++;
                            if (item.attempts >= item.maxAttempts) {
                                console.warn(`Failed after ${item.maxAttempts} attempts:`, item);
                                this.queue.shift(); // Remove failed item
                                showToast('Failed to sync action after multiple attempts', 'error');
                            }
                            break; // Stop processing on first failure
                        }
                        
                        this.saveQueue();
                    }
                    
                    if (this.queue.length === 0) {
                        showToast('All offline actions synced', 'success');
                    }
                } catch (error) {
                    console.error('Queue processing error:', error);
                } finally {
                    this.isSyncing = false;
                    this.updateSyncStatus(this.queue.length > 0 ? 'offline' : 'idle');
                }
            },

            async executeAction(item) {
                try {
                    // Simulate API call - replace with actual Supabase calls
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return true;
                } catch (error) {
                    console.error('Action execution failed:', error);
                    return false;
                }
            },

            updateQueueDisplay() {
                const queueElement = document.getElementById('offlineQueue');
                const countElement = document.getElementById('queueCount');
                
                if (this.queue.length > 0) {
                    if (queueElement) queueElement.classList.add('show');
                    if (countElement) countElement.textContent = this.queue.length;
                } else {
                    if (queueElement) queueElement.classList.remove('show');
                }
            },

            updateSyncStatus(status) {
                const syncElement = document.getElementById('syncStatus');
                if (!syncElement) return;

                syncElement.className = 'status-badge';
                
                switch(status) {
                    case 'syncing':
                        syncElement.classList.add('syncing');
                        syncElement.innerHTML = '<i class="fas fa-sync sync-animation"></i><span>Syncing...</span>';
                        break;
                    case 'idle':
                        syncElement.classList.add('online');
                        syncElement.innerHTML = '<i class="fas fa-check"></i><span>Synced</span>';
                        break;
                    case 'offline':
                        syncElement.classList.add('offline');
                        syncElement.innerHTML = '<i class="fas fa-cloud"></i><span>Offline</span>';
                        break;
                }
            },

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    this.processQueue();
                    showToast('You are back online', 'success');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus();
                    this.updateSyncStatus('offline');
                    showToast('You are offline. Changes will sync when back online.', 'warning');
                });
            },

            startSyncInterval() {
                // Try to sync every 30 seconds when online
                setInterval(() => {
                    if (this.isOnline && this.queue.length > 0) {
                        this.processQueue();
                    }
                }, 30000);
            },

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const iconElement = document.getElementById('connectionIcon');
                const offlineIndicator = document.getElementById('offlineIndicator');
                
                if (this.isOnline) {
                    if (statusElement) statusElement.textContent = 'Online';
                    if (iconElement) {
                        iconElement.className = 'fas fa-wifi status-icon status-online';
                    }
                    if (offlineIndicator) offlineIndicator.style.display = 'none';
                } else {
                    if (statusElement) statusElement.textContent = 'Offline';
                    if (iconElement) {
                        iconElement.className = 'fas fa-wifi-slash status-icon status-offline';
                    }
                    if (offlineIndicator) offlineIndicator.style.display = 'block';
                }
            }
        };

        // Cache Manager
        const CacheManager = {
            async estimateCache() {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    try {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                        const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
                        
                        const cacheElement = document.getElementById('cacheStatus');
                        if (cacheElement) {
                            cacheElement.textContent = `Cache: ${usedMB}MB / ${quotaMB}MB`;
                        }
                    } catch (error) {
                        console.error('Cache estimation failed:', error);
                    }
                }
            },

            async clearCache() {
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        
                        // Clear localStorage except essential data
                        const essentialKeys = ['offlineQueue', 'userPreferences'];
                        Object.keys(localStorage).forEach(key => {
                            if (!essentialKeys.includes(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        showToast('Cache cleared successfully', 'success');
                        this.estimateCache();
                    } catch (error) {
                        console.error('Cache clearing failed:', error);
                        showToast('Failed to clear cache', 'error');
                    }
                }
            },

            async exportData() {
                try {
                    const data = {
                        profile: currentUserProfile || {},
                        courses: cachedCourses || [],
                        exams: cachedExams || [],
                        resources: cachedResources || [],
                        exportDate: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nchsm-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('Data exported successfully', 'success');
                } catch (error) {
                    console.error('Data export failed:', error);
                    showToast('Failed to export data', 'error');
                }
            }
        };

        // PWA Installation
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 5 seconds
            setTimeout(() => {
                if (deferredPrompt && !isAppInstalled()) {
                    installPrompt.classList.add('show');
                }
            }, 5000);
        });

        function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted install');
                    showToast('App installation started', 'success');
                }
                deferredPrompt = null;
                closeInstallPrompt();
            });
        }

        function closeInstallPrompt() {
            installPrompt.classList.remove('show');
        }

        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // System Info Modal
        function showSystemInfo() {
            const info = `
                <div style="padding: 20px;">
                    <h3 style="color: #4C1D95; margin-bottom: 15px;">System Information</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>App Version:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">v2.1</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Browser:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${navigator.userAgent.split(' ')[0]}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Online:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${navigator.onLine ? 'Yes' : 'No'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Service Worker:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${'serviceWorker' in navigator ? 'Active' : 'Not Supported'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Cache Size:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;" id="cacheSizeInfo">Calculating...</td>
                        </tr>
                    </table>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="closeModal()" class="profile-button">Close</button>
                    </div>
                </div>
            `;
            
            showModal('System Information', info);
        }

        function showModal(title, content) {
            // Create modal dynamically
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #4C1D95;">${title}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div>${content}</div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Real-time Clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) timeElement.textContent = timeString;
        }

        // Initialize all systems
        function initializeSystems() {
            // Start clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Initialize offline manager
            OfflineManager.init();
            
            // Update cache size periodically
            CacheManager.estimateCache();
            setInterval(() => CacheManager.estimateCache(), 60000);
            
            // Setup footer button listeners
            document.getElementById('clearCacheBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Clear all cached data? This will not delete your submissions.')) {
                    CacheManager.clearCache();
                }
            });
            
            document.getElementById('exportDataBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                CacheManager.exportData();
            });
            
            // Update system info cache size
            window.showSystemInfo = async function() {
                await CacheManager.estimateCache();
                const cacheElement = document.getElementById('cacheSizeInfo');
                if (cacheElement) {
                    const statusElement = document.getElementById('cacheStatus');
                    cacheElement.textContent = statusElement.textContent;
                }
                showSystemInfo();
            };
        }

        // YOUR EXISTING APPLICATION CODE - MODIFIED FOR SECURITY
        async function startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL) {
            // *************************************************************************
            // *** CONFIGURATION AND INITIALIZATION ***
            // *************************************************************************
            
            // Global State
            let currentUserId = null;
            let currentUserProfile = null;
            let cachedCourses = []; 
            let cachedExams = [];
            let cachedClinicalAreas = [];
            let cachedResources = [];
            
            // Initialize offline systems
            initializeSystems();
            
            // Constants
            const MAX_ALLOWED_ACCURACY = 30;
            const MAX_DISTANCE_RADIUS = 200;
            const FALLBACK_LAT = 0.00;
            const FALLBACK_LON = 0.00;
            const FALLBACK_ACCURACY = 9999;
            const RESOURCES_BUCKET = 'resources';
            
            // *************************************************************************
            // *** UTILITY FUNCTIONS ***
            // *************************************************************************
            
            const AppUtils = {
                // Show loading state
                showLoading(element, message = 'Loading...') {
                    if (element) {
                        element.innerHTML = `<div class="loading-state">${message}</div>`;
                    }
                },
            
                // Show error state
                showError(element, message) {
                    if (element) {
                        element.innerHTML = `<div class="error-state">${message}</div>`;
                    }
                },
            
                // Safe API call wrapper
                async safeApiCall(apiCall, errorMessage = 'Operation failed') {
                    try {
                        return await apiCall();
                    } catch (error) {
                        console.error(errorMessage, error);
                        this.showToast(errorMessage, 'error');
                        return null;
                    }
                },
            
                // Toast notification
                showToast(message, type = 'info') {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
            
                    setTimeout(() => {
                        toast.remove();
                    }, 4000);
                }
            };
            
            // Simple cache implementation
            const cache = {
                data: new Map(),
                set(key, value, ttl = 5 * 60 * 1000) {
                    this.data.set(key, {
                        value,
                        expiry: Date.now() + ttl,
                        timestamp: new Date().toISOString()
                    });
                },
                get(key) {
                    const item = this.data.get(key);
                    if (!item) return null;
                    if (Date.now() > item.expiry) {
                        this.data.delete(key);
                        return null;
                    }
                    return item.value;
                },
                clear() {
                    this.data.clear();
                }
            };
            
            // *************************************************************************
            // *** AUTHENTICATION ***
            // *************************************************************************
            
            // Enforce authentication
            (async function enforceAuth() {
                try {
                    console.log("üîê Checking authentication...");
                    const { data: { session }, error } = await sb.auth.getSession();
                    
                    if (error) {
                        console.error("Session error:", error);
                        AppUtils.showToast('Authentication error - redirecting to login', 'error');
                        setTimeout(() => window.location.href = "login.html", 2000);
                        return;
                    }
                    
                    if (!session || !session.user) {
                        console.warn("No active session found");
                        AppUtils.showToast('Please log in to continue', 'warning');
                        window.location.href = "login.html";
                        return;
                    }
                    
                    currentUserId = session.user.id;
                    console.log("‚úÖ User authenticated:", currentUserId);
                    
                    // Update user status in status bar
                    const userStatusElement = document.getElementById('userStatus');
                    if (userStatusElement) {
                        userStatusElement.textContent = 'Loading...';
                    }
                    
                    await checkAuthAndLoad();
                    
                } catch (err) {
                    console.error("Auth enforcement failed:", err);
                    AppUtils.showToast('Login check failed - redirecting', 'error');
                    window.location.href = "login.html";
                }
            })();
            
            // Initialize dashboard after auth
            async function checkAuthAndLoad() {
                try {
                    if (!currentUserId) {
                        window.location.href = "login.html"; 
                        return;
                    }
            
                    console.log("üîÑ Loading dashboard data...");
                    
                    // Load data with proper error handling
                    await Promise.allSettled([
                        loadProfile(currentUserId).catch(err => {
                            console.error("Profile load failed:", err);
                            AppUtils.showToast('Failed to load profile', 'error');
                        }),
                        loadClinicalTargets().catch(err => {
                            console.error("Clinical targets failed:", err);
                            AppUtils.showToast('Clinical data incomplete', 'warning');
                        }),
                        loadClassTargets().catch(err => {
                            console.error("Class targets failed:", err);
                        }),
                        loadCourses().catch(err => {
                            console.error("Courses failed:", err);
                            AppUtils.showToast('Course data unavailable', 'warning');
                        }),
                        loadExams().catch(err => {
                            console.error("Exams failed:", err);
                        }),
                        loadResources().catch(err => {
                            console.error("Resources failed:", err);
                        })
                    ]);
            
                    // Load UI components
                    await loadWelcomeDetails();
                    showTab('dashboard');
                    loadDashboardMetrics(currentUserId);
                    
                    console.log("‚úÖ Dashboard initialization complete");
                    
                } catch (error) {
                    console.error("üö® Initialization failed:", error);
                    AppUtils.showToast('Failed to load dashboard - some features may be unavailable', 'error');
                }
            }
            
            // Logout function
            async function logout() {
                try {
                    sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
                    await sb.auth.signOut();
                    window.location.href = "login.html";
                } catch (error) {
                    console.error("Logout error:", error);
                    window.location.href = "login.html";
                }
            }
            
            // *************************************************************************
            // *** UI AND NAVIGATION ***
            // *************************************************************************
            
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            const navLinks = document.querySelectorAll('.nav a');
            const tabs = document.querySelectorAll('.tab-content');
            
            // Mobile menu functions
            function toggleMenu() {
                if (sidebar.classList.contains('open')) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }
            
            function openMenu() {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeMenu() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
// Tab navigation - FIXED VERSION
function showTab(tabId) {
    // Highlight active link
    navLinks.forEach(l => l.classList.remove('active'));
    const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
    if (activeLink) activeLink.classList.add('active');

    // Show active tab content
    tabs.forEach(tab => tab.classList.remove('active'));
    const activeTab = document.getElementById(tabId);
    if (activeTab) activeTab.classList.add('active');

    // Close mobile menu if open
    if (sidebar.classList.contains('open')) {
        closeMenu();
    }

    // Load tab-specific data
    switch(tabId) {
        case 'profile':
            if (currentUserId) loadProfile(currentUserId);
            break;
        case 'attendance':
            if (currentUserId) {
                loadGeoAttendanceHistory(currentUserId);
                updateTargetSelect();
            }
            break;
        case 'dashboard':
            if (currentUserId) {
                loadWelcomeDetails();
                loadDashboardMetrics(currentUserId);
            }
            break;
        case 'courses':
            if (currentUserId) loadCourses();
            break;
        case 'resources':
            if (currentUserId) loadResources();
            break;
        case 'cats':
            if (currentUserId) loadExams();
            break;
        case 'messages':
            if (currentUserId) loadStudentMessagesAndAnnouncements();
            break;
        case 'calendar':
            if (currentUserId) loadAcademicCalendar();
            break;
        case 'nurseiq':
            if (currentUserId) {
                console.log('Initializing NurseIQ tab...');
                
                // Make sure NurseIQ mode buttons exist
                const assessmentModeBtn = document.getElementById('assessmentModeBtn');
                const questionBankModeBtn = document.getElementById('questionBankModeBtn');
                
                if (assessmentModeBtn && questionBankModeBtn) {
                    // Default to assessment mode
                    showNurseIQMode('assessment');
                    
                    // Load data
                    setTimeout(() => {
                        if (typeof loadNurseIQAssessments === 'function') {
                            loadNurseIQAssessments();
                        }
                        if (typeof loadQuestionBankCourses === 'function') {
                            loadQuestionBankCourses();
                        }
                    }, 100);
                } else {
                    console.error('NurseIQ buttons not found');
                }
            }
            break;
        case 'coming-soon-quizlets':
            if (currentUserId) {
                // Add a simple content loader
                const tabContent = document.getElementById('coming-soon-quizlets');
                if (tabContent && tabContent.innerHTML.trim() === '') {
                    tabContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-tools" style="font-size: 4rem; color: #9CA3AF; margin-bottom: 20px;"></i>
                            <h2 style="color: #4C1D95;">Coming Soon: Quizlets</h2>
                            <p style="color: #6B7280; max-width: 500px; margin: 0 auto 30px;">
                                We're working on interactive quizlets to help you study better. 
                                This feature will be available soon!
                            </p>
                            <div class="progress-bar" style="width: 300px; height: 10px; background: #E5E7EB; border-radius: 5px; margin: 30px auto;">
                                <div class="progress-fill" style="width: 65%; height: 100%; background: linear-gradient(135deg, #4C1D95, #7C3AED); border-radius: 5px;"></div>
                            </div>
                            <p style="color: #9CA3AF; font-size: 0.9rem;">Development in progress - 65% complete</p>
                        </div>
                    `;
                }
            }
            break;
        default:
            console.log(`Tab ${tabId} not found`);
            break;
    }

    // Always refresh latest announcement
    if (currentUserId) loadLatestOfficialAnnouncement();
}
      // ‚úÖ CRITICAL FIX: Add event listeners to all navigation links
navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const tabId = this.getAttribute('data-tab');
        console.log(`Clicked on tab: ${tabId}`);
        showTab(tabId);
    });
});

// ‚úÖ Also add event listeners for footer links that use onclick="showTab()"
document.querySelectorAll('[onclick*="showTab"]').forEach(element => {
    const oldOnClick = element.getAttribute('onclick');
    const match = oldOnClick.match(/showTab\('([^']+)'\)/);
    if (match) {
        const tabId = match[1];
        element.removeAttribute('onclick');
        element.addEventListener('click', function(e) {
            e.preventDefault();
            showTab(tabId);
        });
    }
});
            // *************************************************************************
            // *** DASHBOARD FUNCTIONS ***
            // *************************************************************************
            
            // Load welcome details with live clock
            async function loadWelcomeDetails() {
                const studentName = currentUserProfile?.full_name || 'Student';
                const welcomeHeader = document.getElementById('welcome-header');
            
                function getGreeting(hour) {
                    if (hour >= 5 && hour < 12) return "Good Morning";
                    if (hour >= 12 && hour < 17) return "Good Afternoon";
                    if (hour >= 17 && hour < 21) return "Good Evening";
                    return "Good Night";
                }
            
                function updateHeader() {
                    const now = new Date();
                    const hour = now.getHours();
                    const minute = now.getMinutes().toString().padStart(2, '0');
                    const second = now.getSeconds().toString().padStart(2, '0');
                    
                    if (welcomeHeader) {
                        welcomeHeader.textContent = `${getGreeting(hour)}, ${studentName} ‚Äî ${hour.toString().padStart(2,'0')}:${minute}:${second}`;
                    }
                }
            
                // Initialize and start the live clock
                updateHeader();
                setInterval(updateHeader, 1000);
            
                // Load other messages
                await loadStudentMessage('student_welcome', 'student-welcome-message');
                await loadLatestOfficialAnnouncement();
            }
            
            // Load student message from app_settings
            async function loadStudentMessage(key, elementId) {
                const element = document.getElementById(elementId);
                if (!element) return;
            
                AppUtils.showLoading(element, 'Loading...');
            
                try {
                    const { data, error } = await sb
                        .from('app_settings')
                        .select('value')
                        .eq('key', key)
                        .maybeSingle();
            
                    if (error) throw error;
            
                    if (data && data.value) {
                        element.innerHTML = data.value;
                    } else {
                        element.textContent = 'No message available.';
                    }
                } catch (err) {
                    console.error(`‚ùå Failed to load ${key}:`, err);
                    AppUtils.showError(element, 'Failed to load message. Please refresh.');
                }
            }
            
            // Load latest official announcement
            async function loadLatestOfficialAnnouncement() {
                const element = document.getElementById('student-announcement');
                if (!element) return;
            
                AppUtils.showLoading(element, 'Loading latest announcement...');
            
                try {
                    const { data, error } = await sb
                        .from('notifications')
                        .select('*')
                        .eq('subject', 'Official Announcement')
                        .order('created_at', { ascending: false })
                        .limit(1);
            
                    if (error) throw error;
            
                    if (data && data.length > 0) {
                        element.textContent = data[0].message;
                    } else {
                        element.textContent = 'No official announcements at this time.';
                    }
                } catch (err) {
                    console.error('Failed to load official announcement:', err);
                    AppUtils.showError(element, 'Failed to load announcement. Please refresh.');
                }
            }
            
            // Load system messages for dashboard
            async function loadSystemMessages(studentProgram) {
                const card = document.getElementById('latest-announcement-card');
                const titleElement = document.getElementById('announcement-title');
                const bodyElement = document.getElementById('announcement-body');
                const dateElement = document.getElementById('announcement-date');
                const statusElement = document.getElementById('announcement-status');
            
                if (!card || !studentProgram) return;
            
                card.style.display = 'none';
            
                try {
                    // Fetch the single latest notification for the student's program
                    const { data: messages, error } = await sb
                        .from('notifications')
                        .select('created_at, subject, message, is_read, target_program')
                        .or(`target_program.eq.${studentProgram},target_program.is.null`)
                        .order('created_at', { ascending: false })
                        .limit(1);
            
                    if (error) throw error;
            
                    if (messages && messages.length > 0) {
                        const latestMsg = messages[0];
                        const date = new Date(latestMsg.created_at).toLocaleDateString('en-GB');
                        const statusColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-success)';
                        const statusText = !latestMsg.is_read ? 'New' : 'Seen';
                        const cardBorderColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-primary)';
            
                        titleElement.textContent = (latestMsg.subject || 'New Announcement').toUpperCase();
                        bodyElement.textContent = latestMsg.message;
                        dateElement.textContent = date;
                        statusElement.textContent = `Status: ${statusText}`;
                        statusElement.style.color = statusColor;
            
                        card.style.display = 'block';
                        card.style.borderLeftColor = cardBorderColor;
            
                    } else {
                        card.style.display = 'none';
                    }
            
                } catch (error) {
                    console.error('Error loading notifications for dashboard:', error.message);
                    card.style.display = 'none';
                }
            }
            
            // Load dashboard metrics
            async function loadDashboardMetrics(userId) {
                try {
                    // Show loading states
                    AppUtils.showLoading(document.getElementById('dashboard-attendance-rate'), '--%');
                    AppUtils.showLoading(document.getElementById('dashboard-active-courses'), '0');
                    AppUtils.showLoading(document.getElementById('dashboard-upcoming-exam'), 'Loading...');
            
                    // Load data in parallel for better performance
                    const [attendanceData, coursesData, examsData, resourcesData] = await Promise.all([
                        AppUtils.safeApiCall(() => loadAttendanceMetrics(userId)),
                        AppUtils.safeApiCall(() => loadCoursesMetrics()),
                        AppUtils.safeApiCall(() => loadExamsMetrics()),
                        AppUtils.safeApiCall(() => loadResourcesMetrics())
                    ]);
            
                    // Update UI with actual data
                    updateDashboardUI(attendanceData, coursesData, examsData, resourcesData);
                    
                    // Load profile photo
                    loadProfilePhoto();
                    
                    // Load system messages
                    if (currentUserProfile?.program) {
                        loadSystemMessages(currentUserProfile.program);
                    }
            
                } catch (error) {
                    console.error('Dashboard metrics loading failed:', error);
                    AppUtils.showToast('Failed to load dashboard data', 'error');
                }
            }
            
            // Helper functions for metrics
            async function loadAttendanceMetrics(userId) {
                const { data: logs, error } = await sb
                    .from('geo_attendance_logs')
                    .select('is_verified')
                    .eq('student_id', userId);
            
                if (error) throw error;
            
                const totalLogs = logs.length;
                const verifiedCount = logs.filter(l => l.is_verified === true).length;
                const pendingCount = logs.filter(l => !l.is_verified).length;
                const attendanceRate = totalLogs > 0 ? Math.round((verifiedCount / totalLogs) * 100) : 0;
            
                return { attendanceRate, verifiedCount, totalLogs, pendingCount };
            }
            
            async function loadCoursesMetrics() {
                return { count: cachedCourses.length };
            }
            
            async function loadExamsMetrics() {
                const upcomingExams = cachedExams
                    .filter(exam => new Date(exam.exam_date) > new Date())
                    .sort((a, b) => new Date(a.exam_date) - new Date(b.exam_date));
            
                return { upcomingExam: upcomingExams[0] };
            }
            
            async function loadResourcesMetrics() {
                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const newResourcesCount = cachedResources.filter(r => r.created_at >= oneWeekAgo).length;
                return { newResourcesCount };
            }
            
            function updateDashboardUI(attendance, courses, exams, resources) {
                // Update attendance
                if (attendance) {
                    document.getElementById('dashboard-attendance-rate').textContent = attendance.attendanceRate + '%';
                    document.getElementById('dashboard-verified-count').textContent = attendance.verifiedCount;
                    document.getElementById('dashboard-total-count').textContent = attendance.totalLogs;
                    document.getElementById('dashboard-pending-count').textContent = attendance.pendingCount;
                }
            
                // Update courses
                if (courses) {
                    document.getElementById('dashboard-active-courses').textContent = courses.count;
                }
            
                // Update exams
                if (exams?.upcomingExam) {
                    const examDate = new Date(exams.upcomingExam.exam_date).toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric' 
                    });
                    document.getElementById('dashboard-upcoming-exam').textContent = 
                        `${exams.upcomingExam.exam_name || 'Exam'} on ${examDate}`;
                } else {
                    document.getElementById('dashboard-upcoming-exam').textContent = 'No Exams Scheduled';
                }
            
                // Update resources
                if (resources) {
                    document.getElementById('dashboard-new-resources').textContent = resources.newResourcesCount;
                }
            }
            
            // Load profile photo
            function loadProfilePhoto() {
                const passportImg = document.getElementById('passport-preview');
                const headerPassportImg = document.getElementById('header-passport-preview');
                const passportCard = document.getElementById('action-passport');
            
                const photoUrl = currentUserProfile?.passport_url;
            
                if (passportCard) {
                    passportCard.style.display = photoUrl ? 'none' : 'block';
                }
            
                // Determine the photo source (URL or fallback)
                let finalPhotoSrc = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                
                if (photoUrl) {
                    // Construct proper Supabase URL
                    finalPhotoSrc = `${window.APP_CONFIG.SUPABASE_URL}/storage/v1/object/public/passports/${photoUrl}?t=${new Date().getTime()}`;
                }
            
                // Update both profile and header images
                if (passportImg) {
                    passportImg.src = finalPhotoSrc;
                    passportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }
            
                if (headerPassportImg) {
                    headerPassportImg.src = finalPhotoSrc;
                    headerPassportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }
            }
            
            // *************************************************************************
            // *** PROFILE MANAGEMENT ***
            // *************************************************************************
            
            const profileForm = document.getElementById('profile-form');
            const passportFileInput = document.getElementById('passport-file-input');
            const passportPreview = document.getElementById('passport-preview');
            const uploadButton = document.getElementById('upload-button');
            const profileStatus = document.getElementById('profile-status');
            const editProfileButton = document.getElementById('edit-profile-button');
            const saveProfileButton = document.getElementById('save-profile-button');
            const uploadLabel = document.getElementById('upload-label');
            
            // Load profile from consolidated_user_profiles_table
            async function loadProfile(userId) {
                if (profileStatus) profileStatus.textContent = 'Loading profile...';
            
                const { data: profile, error } = await sb
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
            
                if (error || !profile) {
                    console.error('Error loading consolidated profile:', error);
                    if (profileStatus) profileStatus.textContent = 'Profile data missing or restricted. Contact Admin.';
                    currentUserProfile = {};
                } else {
                    currentUserProfile = profile;
                    if (profileStatus) profileStatus.textContent = '';
                    
                    // Update user status in status bar
                    const userStatusElement = document.getElementById('userStatus');
                    if (userStatusElement && profile.full_name) {
                        userStatusElement.textContent = profile.full_name;
                    }
                }
            
                // Populate form fields
                if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').value = currentUserProfile.student_id || 'N/A';
                if (document.getElementById('profile-name')) document.getElementById('profile-name').value = currentUserProfile.full_name || 'N/A';
                if (document.getElementById('profile-email')) document.getElementById('profile-email').value = currentUserProfile.email || 'N/A';
                if (document.getElementById('profile-phone')) document.getElementById('profile-phone').value = currentUserProfile.phone || 'N/A';
                if (document.getElementById('profile-program')) document.getElementById('profile-program').value = currentUserProfile.program || currentUserProfile.department || 'N/A'; 
                if (document.getElementById('profile-block')) document.getElementById('profile-block').value = currentUserProfile.block || 'N/A';
                if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').value = currentUserProfile.intake_year || 'N/A';
            
                // Load profile photo
                loadProfilePhoto();
            
                toggleProfileEdit(false);
                if (uploadLabel && !currentUserProfile.passport_url) {
                    uploadLabel.style.display = 'block';
                }
            }
            
            // Toggle profile edit mode
            function toggleProfileEdit(enable) {
                const editableFields = ['profile-name', 'profile-phone'];
            
                editableFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.readOnly = !enable;
                });
            
                // Non-editable fields
                if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').readOnly = true;
                if (document.getElementById('profile-email')) document.getElementById('profile-email').readOnly = true;
                if (document.getElementById('profile-program')) document.getElementById('profile-program').readOnly = true;
                if (document.getElementById('profile-block')) document.getElementById('profile-block').readOnly = true;
                if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').readOnly = true;
            
                // Toggle buttons
                if (editProfileButton) editProfileButton.style.display = enable ? 'none' : 'block';
                if (saveProfileButton) saveProfileButton.style.display = enable ? 'block' : 'none';
            
                // Upload label visibility
                if (uploadLabel) {
                    if (enable || !(currentUserProfile && currentUserProfile.passport_url)) {
                        uploadLabel.style.display = 'block';
                    } else {
                        uploadLabel.style.display = 'none';
                    }
                }
            
                if (document.getElementById('upload-button')) document.getElementById('upload-button').style.display = 'none';
            }
            
            // Edit profile button event
            if (editProfileButton) {
                editProfileButton.addEventListener('click', () => toggleProfileEdit(true));
            }
            
            // Save profile
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (profileStatus) profileStatus.textContent = 'Saving changes...';
            
                    const updates = {
                        full_name: document.getElementById('profile-name').value,
                        phone: document.getElementById('profile-phone').value,
                        updated_at: new Date().toISOString()
                    };
            
                    const { error } = await sb
                        .from('consolidated_user_profiles_table')
                        .update(updates)
                        .eq('user_id', currentUserId);
            
                    if (error) {
                        if (profileStatus) profileStatus.textContent = `Error saving profile: ${error.message}`;
                    } else {
                        if (profileStatus) profileStatus.textContent = 'Profile updated successfully!';
                        loadProfile(currentUserId);
                    }
                });
            }
            
            // Passport photo upload
            if (passportFileInput) {
                passportFileInput.addEventListener('change', () => {
                    const file = passportFileInput.files[0];
                    if (file) {
                        // Display temporary object URL for preview
                        if (passportPreview) passportPreview.src = URL.createObjectURL(file);
                        if (uploadButton) uploadButton.style.display = 'block';
                        if (uploadLabel) uploadLabel.style.display = 'none';
                    }
                });
            }
            
            // Upload photo button
            if (uploadButton) {
                uploadButton.addEventListener('click', async () => {
                    const file = passportFileInput.files[0];
                    if (!file) {
                        if (profileStatus) profileStatus.textContent = 'Please select a file first.';
                        return;
                    }
            
                    if (profileStatus) profileStatus.textContent = 'Uploading photo... (This may take a few seconds)';
                    if (uploadButton) uploadButton.disabled = true;
            
                    const fileExt = file.name.split('.').pop();
                    const filePath = `${currentUserId}.${fileExt}`;
            
                    const { error: uploadError } = await sb.storage
                        .from('passports')
                        .upload(filePath, file, { cacheControl: '3600', upsert: true });
            
                    if (uploadError) {
                        if (profileStatus) profileStatus.textContent = `Upload failed: ${uploadError.message}`;
                        if (uploadButton) uploadButton.disabled = false;
                        return;
                    }
            
                    const { error: updateError } = await sb
                        .from('consolidated_user_profiles_table')
                        .update({ passport_url: filePath, updated_at: new Date().toISOString() })
                        .eq('user_id', currentUserId);
            
                    if (updateError) {
                        if (profileStatus) profileStatus.textContent = `Database update failed: ${updateError.message}`;
                    } else {
                        if (profileStatus) profileStatus.textContent = 'Photo uploaded and saved successfully! Refreshing profile...';
                        
                        // Clear file input and hide buttons after successful upload
                        if (passportFileInput) passportFileInput.value = ''; 
                        if (uploadButton) uploadButton.style.display = 'none';
                        if (uploadLabel) uploadLabel.style.display = 'none';
                        
                        // Reload profile and dashboard to reflect change
                        await loadProfile(currentUserId);
                        loadDashboardMetrics(currentUserId);
                        
                        // Set final status message
                        if (profileStatus) profileStatus.textContent = 'Photo updated successfully!';
                    }
            
                    if (uploadButton) uploadButton.disabled = false;
                });
            }
// ==================== ENHANCED NURSEIQ QUESTION BANK SYSTEM ====================

// Global variables
let currentTestQuestions = [];
let currentQuestionIndex = 0;
let userTestAnswers = {};
let currentCourseForTest = null;
let currentCourseQuestions = [];
let currentStudyMode = 'practice'; // practice, test, review, flashcards
let timerInterval = null;
let timeRemaining = 0;
let testStatistics = {
    totalAttempted: 0,
    totalCorrect: 0,
    totalIncorrect: 0,
    averageTime: 0,
    weakAreas: []
};

// Study modes configuration
const STUDY_MODES = {
    PRACTICE: {
        id: 'practice',
        name: 'Practice Mode',
        icon: 'fas fa-graduation-cap',
        description: 'Learn at your own pace with instant feedback',
        features: ['Instant feedback', 'Unlimited time', 'Detailed explanations']
    },
    TEST: {
        id: 'test',
        name: 'Test Mode',
        icon: 'fas fa-clock',
        description: 'Simulate real exam conditions',
        features: ['Timed questions', 'Exam simulation', 'Score tracking']
    },
    REVIEW: {
        id: 'review',
        name: 'Review Mode',
        icon: 'fas fa-redo',
        description: 'Focus on weak areas and mistakes',
        features: ['Focus on mistakes', 'Weak area targeting', 'Progress tracking']
    },
    FLASHCARDS: {
        id: 'flashcards',
        name: 'Flashcards',
        icon: 'fas fa-layer-group',
        description: 'Quick memorization and recall',
        features: ['Quick review', 'Active recall', 'Spaced repetition']
    }
};

// ==================== INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Enhanced NurseIQ Question Bank Initializing...');
    
    // Initialize with saved preferences
    loadUserPreferences();
    
    // Load question bank
    loadQuestionBankCards();
    
    // Initialize search
    initQuestionBankSearch();
    
    // Initialize keyboard shortcuts
    initKeyboardShortcuts();
    
    // Initialize service worker for offline support
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw-nursequestions.js')
            .then(() => console.log('‚úÖ Service Worker Registered'))
            .catch(err => console.log('‚ùå Service Worker Registration Failed:', err));
    }
    
    console.log('‚úÖ Enhanced NurseIQ Question Bank Ready');
});

// Load user preferences from localStorage
function loadUserPreferences() {
    const savedMode = localStorage.getItem('nursequestions_studyMode');
    if (savedMode && STUDY_MODES[savedMode.toUpperCase()]) {
        currentStudyMode = savedMode;
    }
    
    const savedStats = localStorage.getItem('nursequestions_statistics');
    if (savedStats) {
        testStatistics = JSON.parse(savedStats);
    }
}

// Initialize keyboard shortcuts
function initKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Only activate in question view
        if (!document.getElementById('questionText')) return;
        
        switch(e.key) {
            case '1':
            case '2':
            case '3':
            case '4':
                selectOptionByNumber(parseInt(e.key) - 1);
                break;
            case ' ':
                e.preventDefault();
                if (currentStudyMode === 'flashcards') flipFlashcard();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextQuestion();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                prevQuestion();
                break;
            case 'Enter':
                checkAnswer();
                break;
            case 'r':
                resetQuestion();
                break;
            case 'm':
                markForReview();
                break;
        }
    });
}

// ==================== ENHANCED QUESTION BANK CARD VIEW ====================

async function loadQuestionBankCards() {
    try {
        showLoading('Loading question bank...');
        
        // Fetch ALL questions with enhanced data
        const { data: questions, error } = await sb
            .from('medical_assessments')
            .select(`
                *,
                courses (
                    id,
                    course_name,
                    unit_code,
                    color,
                    description,
                    category
                )
            `)
            .eq('is_active', true)
            .eq('is_published', true)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Process and enhance questions
        const enhancedQuestions = await enhanceQuestionsData(questions);
        
        // Group by course with advanced analytics
        const coursesMap = createCoursesMap(enhancedQuestions);
        
        // Calculate adaptive learning metrics
        calculateAdaptiveMetrics(coursesMap);
        
        // Display enhanced card view
        displayEnhancedQuestionBankCards(coursesMap);
        
    } catch (error) {
        console.error('‚ùå Error loading question bank:', error);
        showError('Failed to load question bank', error.message);
    } finally {
        hideLoading();
    }
}

// Enhance questions with additional metadata
async function enhanceQuestionsData(questions) {
    return questions.map(q => {
        // Calculate estimated reading time
        const wordCount = q.question_text?.split(/\s+/).length || 0;
        const readingTime = Math.ceil(wordCount / 200); // 200 words per minute
        
        // Add tags based on content
        const tags = extractTagsFromQuestion(q);
        
        return {
            ...q,
            metadata: {
                readingTime,
                tags,
                wordCount,
                estimatedTime: readingTime * 60, // in seconds
                complexity: calculateQuestionComplexity(q)
            }
        };
    });
}

// Create enhanced courses map
function createCoursesMap(questions) {
    const coursesMap = {};
    
    questions.forEach(question => {
        const courseId = question.course_id || 'general';
        const course = question.courses || {
            id: 'general',
            course_name: 'General Nursing',
            unit_code: 'KRCHN',
            color: '#4f46e5',
            description: 'General nursing questions',
            category: 'General'
        };
        
        if (!coursesMap[courseId]) {
            coursesMap[courseId] = {
                id: courseId,
                name: course.course_name,
                unit_code: course.unit_code,
                color: course.color,
                description: course.description,
                category: course.category,
                questions: [],
                stats: {
                    total: 0,
                    active: 0,
                    byDifficulty: { hard: 0, medium: 0, easy: 0 },
                    byType: {},
                    avgComplexity: 0,
                    totalReadingTime: 0,
                    lastUpdated: null,
                    userPerformance: {
                        attempted: 0,
                        correct: 0,
                        accuracy: 0,
                        avgTime: 0
                    }
                }
            };
        }
        
        coursesMap[courseId].questions.push(question);
        coursesMap[courseId].stats.total++;
        coursesMap[courseId].stats.active++;
        
        // Update difficulty stats
        const difficulty = question.difficulty || 'medium';
        coursesMap[courseId].stats.byDifficulty[difficulty]++;
        
        // Update question type stats
        const qType = question.question_type || 'multiple_choice';
        coursesMap[courseId].stats.byType[qType] = 
            (coursesMap[courseId].stats.byType[qType] || 0) + 1;
        
        // Update reading time
        coursesMap[courseId].stats.totalReadingTime += question.metadata?.readingTime || 1;
        
        // Track last updated
        if (question.updated_at) {
            const updatedDate = new Date(question.updated_at);
            if (!coursesMap[courseId].stats.lastUpdated || updatedDate > coursesMap[courseId].stats.lastUpdated) {
                coursesMap[courseId].stats.lastUpdated = updatedDate;
            }
        }
        
        // Update complexity
        coursesMap[courseId].stats.avgComplexity = 
            ((coursesMap[courseId].stats.avgComplexity * (coursesMap[courseId].stats.total - 1)) + 
            (question.metadata?.complexity || 3)) / coursesMap[courseId].stats.total;
    });
    
    return coursesMap;
}

// Calculate adaptive learning metrics
function calculateAdaptiveMetrics(coursesMap) {
    // Load user performance data
    const userPerformance = JSON.parse(localStorage.getItem('nursequestions_userPerformance') || '{}');
    
    Object.values(coursesMap).forEach(course => {
        const coursePerformance = userPerformance[course.id] || {};
        course.stats.userPerformance = {
            attempted: coursePerformance.attempted || 0,
            correct: coursePerformance.correct || 0,
            accuracy: coursePerformance.attempted ? 
                Math.round((coursePerformance.correct / coursePerformance.attempted) * 100) : 0,
            avgTime: coursePerformance.avgTime || 0,
            weakAreas: coursePerformance.weakAreas || []
        };
    });
}

// Display enhanced question bank cards
function displayEnhancedQuestionBankCards(coursesMap) {
    const contentEl = document.getElementById('studentQuestionBankContent');
    if (!contentEl) return;
    
    const coursesArray = Object.values(coursesMap);
    const searchTerm = getSearchTerm();
    const filteredCourses = filterCourses(coursesArray, searchTerm);
    
    // Calculate overall statistics
    const overallStats = calculateOverallStats(coursesArray);
    
    // Generate HTML
    contentEl.innerHTML = generateQuestionBankHTML(filteredCourses, overallStats, searchTerm);
    
    // Add interactivity
    initializeCourseCardsInteractivity();
    initializeStudyModeSelector();
}

// ==================== ENHANCED INTERACTIVE QUESTIONS ====================

async function startEnhancedCourseTest(courseId, courseName, mode = 'practice') {
    try {
        showLoading('Preparing questions...');
        
        currentStudyMode = mode;
        currentCourseForTest = { id: courseId, name: courseName };
        
        // Fetch questions with caching
        const questions = await fetchQuestionsWithCache(courseId);
        
        if (!questions || questions.length === 0) {
            showNotification('No questions available for this course yet.', 'info');
            loadQuestionBankCards();
            return;
        }
        
        // Initialize test session
        initializeTestSession(questions, mode);
        
        // Display based on study mode
        if (mode === 'flashcards') {
            displayFlashcardsMode(questions, courseName, courseId);
        } else {
            displayEnhancedQuestions(questions, courseName, courseId);
        }
        
        // Start timer if in test mode
        if (mode === 'test') {
            startTestTimer(questions.length * 60); // 1 minute per question
        }
        
        // Track analytics
        trackEvent('test_started', {
            courseId,
            courseName,
            mode,
            questionCount: questions.length
        });
        
    } catch (error) {
        console.error('‚ùå Error starting test:', error);
        showError('Failed to start test', error.message);
    } finally {
        hideLoading();
    }
}

// Fetch questions with caching
async function fetchQuestionsWithCache(courseId) {
    const cacheKey = `questions_cache_${courseId}`;
    const cached = localStorage.getItem(cacheKey);
    const cacheTime = localStorage.getItem(`${cacheKey}_time`);
    
    // Use cache if less than 1 hour old
    if (cached && cacheTime && (Date.now() - cacheTime < 3600000)) {
        return JSON.parse(cached);
    }
    
    // Fetch fresh data
    const { data: questions, error } = await sb
        .from('medical_assessments')
        .select(`
            *,
            courses (
                id,
                course_name,
                unit_code,
                color
            )
        `)
        .eq('course_id', courseId)
        .eq('is_active', true)
        .eq('is_published', true)
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    // Enhance and cache
    const enhancedQuestions = await enhanceQuestionsData(questions);
    localStorage.setItem(cacheKey, JSON.stringify(enhancedQuestions));
    localStorage.setItem(`${cacheKey}_time`, Date.now());
    
    return enhancedQuestions;
}

// Initialize test session
function initializeTestSession(questions, mode) {
    currentCourseQuestions = questions;
    currentQuestionIndex = 0;
    userTestAnswers = {};
    
    // Initialize tracking for each question
    questions.forEach((q, index) => {
        userTestAnswers[index] = {
            selected: false,
            answered: false,
            correct: false,
            marked: false,
            timeSpent: 0,
            attempts: 0,
            firstInteraction: null,
            lastInteraction: null
        };
    });
    
    // Start time tracking
    window.testStartTime = Date.now();
}

// Display enhanced questions interface
function displayEnhancedQuestions(questions, courseName, courseId) {
    const contentEl = document.getElementById('studentQuestionBankContent');
    if (!contentEl) return;
    
    const courseColor = questions[0]?.courses?.color || '#4f46e5';
    
    contentEl.innerHTML = generateEnhancedQuestionsHTML(questions, courseName, courseId, courseColor);
    
    // Initialize components
    initializeQuestionNavigation();
    initializeQuestionTimer();
    initializeAnswerTracking();
    initializeExplanationToggle();
    initializeProgressBar();
    
    // Load first question
    loadEnhancedQuestion();
}

// Generate enhanced questions HTML
function generateEnhancedQuestionsHTML(questions, courseName, courseId, courseColor) {
    return `
        <div class="enhanced-questions-container">
            <!-- Enhanced Header -->
            ${generateQuestionsHeader(courseName, questions, courseColor)}
            
            <!-- Progress & Stats Bar -->
            ${generateProgressStatsBar(questions, courseColor)}
            
            <!-- Main Content - VERTICAL LAYOUT -->
            <div class="questions-main-content">
                <!-- Question Section -->
                <div class="question-section">
                    ${generateQuestionCard(questions[0], 0, courseColor)}
                    ${generateOptionsContainer()}
                    ${generateActionButtons(courseColor)}
                </div>
                
                <!-- Explanation Section (BELOW) -->
                <div class="explanation-section" id="explanationSection">
                    ${generateExplanationPlaceholder()}
                </div>
                
                <!-- Additional Resources (Optional) -->
                <div class="resources-section" id="resourcesSection" style="display: none;">
                    ${generateResourcesSection()}
                </div>
            </div>
            
            <!-- Enhanced Navigation -->
            ${generateEnhancedNavigation(questions, courseColor)}
            
            <!-- Analytics Panel -->
            ${generateAnalyticsPanel()}
        </div>
    `;
}

// Generate questions header
function generateQuestionsHeader(courseName, questions, courseColor) {
    return `
        <div class="questions-header" style="background: ${courseColor}">
            <div class="header-content">
                <button onclick="loadQuestionBankCards()" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="header-info">
                    <h3>${courseName} - ${STUDY_MODES[currentStudyMode.toUpperCase()]?.name || 'Practice'}</h3>
                    <div class="header-stats">
                        <span><i class="fas fa-question-circle"></i> ${questions.length} questions</span>
                        <span><i class="fas fa-clock"></i> ${calculateTotalTime(questions)} min</span>
                        <span><i class="fas fa-chart-line"></i> ${currentStudyMode === 'test' ? 'Timed' : 'Untimed'}</span>
                    </div>
                </div>
                <div class="header-controls">
                    <button onclick="toggleStudyMode()" class="btn-mode">
                        <i class="${STUDY_MODES[currentStudyMode.toUpperCase()]?.icon || 'fas fa-graduation-cap'}"></i>
                        ${STUDY_MODES[currentStudyMode.toUpperCase()]?.name || 'Practice'}
                    </button>
                    <button onclick="showTestSettings()" class="btn-settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Generate progress stats bar
function generateProgressStatsBar(questions, courseColor) {
    return `
        <div class="progress-stats-bar">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%; background: ${courseColor}"></div>
                </div>
                <div class="progress-text">
                    <span id="progressText">0/${questions.length} questions</span>
                    <span id="progressPercent">0% complete</span>
                </div>
            </div>
            <div class="live-stats">
                <div class="stat" id="timerStat">
                    <i class="fas fa-clock"></i>
                    <span id="timerDisplay">--:--</span>
                </div>
                <div class="stat" id="accuracyStat">
                    <i class="fas fa-bullseye"></i>
                    <span id="accuracyDisplay">0%</span>
                </div>
                <div class="stat" id="streakStat">
                    <i class="fas fa-fire"></i>
                    <span id="streakDisplay">0</span>
                </div>
            </div>
        </div>
    `;
}

// Generate question card
function generateQuestionCard(question, index, courseColor) {
    const difficulty = question.difficulty || 'medium';
    const difficultyColors = {
        easy: '#10b981',
        medium: '#f59e0b',
        hard: '#ef4444'
    };
    
    return `
        <div class="question-card" style="border-color: ${courseColor}">
            <div class="question-header">
                <div class="question-meta">
                    <span class="question-number" style="background: ${courseColor}">
                        ${index + 1}
                    </span>
                    <div class="question-tags">
                        <span class="difficulty-tag" style="background: ${difficultyColors[difficulty]}">
                            ${difficulty.toUpperCase()}
                        </span>
                        <span class="type-tag">${question.question_type?.replace('_', ' ') || 'MCQ'}</span>
                        <span class="time-tag">
                            <i class="fas fa-clock"></i> ${question.metadata?.readingTime || 1} min read
                        </span>
                    </div>
                </div>
                <div class="question-actions">
                    <button onclick="markForReview()" class="btn-mark" id="markBtn">
                        <i class="fas fa-flag"></i>
                        <span id="markBtnText">Mark</span>
                    </button>
                    <button onclick="showHint()" class="btn-hint">
                        <i class="fas fa-lightbulb"></i> Hint
                    </button>
                </div>
            </div>
            
            <div class="question-body">
                <div id="questionText" class="question-text">
                    ${question.question_text || 'No question text available'}
                </div>
                
                ${question.image_url ? `
                    <div class="question-image">
                        <img src="${question.image_url}" alt="Question image" onerror="this.style.display='none'">
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Generate options container
function generateOptionsContainer() {
    return `
        <div class="options-container" id="optionsContainer">
            <div class="options-loading">
                <div class="spinner"></div>
                <p>Loading options...</p>
            </div>
        </div>
    `;
}

// Generate action buttons
function generateActionButtons(courseColor) {
    return `
        <div class="action-buttons">
            <button onclick="checkAnswer()" id="checkAnswerBtn" class="btn-action btn-primary" style="background: ${courseColor}">
                <i class="fas fa-check-circle"></i> Check Answer
            </button>
            <button onclick="showAnswer()" id="showAnswerBtn" class="btn-action btn-secondary">
                <i class="fas fa-eye"></i> Reveal Answer
            </button>
            <button onclick="resetQuestion()" id="resetBtn" class="btn-action btn-outline">
                <i class="fas fa-redo"></i> Reset
            </button>
            <button onclick="skipQuestion()" id="skipBtn" class="btn-action btn-outline">
                <i class="fas fa-forward"></i> Skip
            </button>
        </div>
    `;
}

// Generate explanation placeholder
function generateExplanationPlaceholder() {
    return `
        <div class="explanation-placeholder" id="explanationPlaceholder">
            <div class="placeholder-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <h4>Explanation</h4>
            <p>Answer the question to see detailed explanation here</p>
            <div class="placeholder-hint">
                <i class="fas fa-lightbulb"></i>
                <span>Select an option and click "Check Answer"</span>
            </div>
        </div>
        
        <div class="explanation-content" id="explanationContent" style="display: none;">
            <div class="explanation-header">
                <h4><i class="fas fa-info-circle"></i> Detailed Explanation</h4>
                <button onclick="toggleExplanation()" class="btn-toggle">
                    <i class="fas fa-chevron-up"></i> Collapse
                </button>
            </div>
            <div class="explanation-body" id="explanationText">
                <!-- Explanation will be loaded here -->
            </div>
            <div class="explanation-footer">
                <button onclick="showMoreResources()" class="btn-resources">
                    <i class="fas fa-book"></i> Show Related Resources
                </button>
                <button onclick="saveExplanation()" class="btn-save">
                    <i class="fas fa-bookmark"></i> Save Note
                </button>
            </div>
        </div>
    `;
}

// Generate enhanced navigation
function generateEnhancedNavigation(questions, courseColor) {
    return `
        <div class="enhanced-navigation">
            <!-- Question Dots -->
            <div class="question-dots-container">
                <div class="dots-header">
                    <span>Quick Navigation</span>
                    <div class="dots-legend">
                        <span class="legend-item"><i class="fas fa-circle" style="color: ${courseColor}"></i> Current</span>
                        <span class="legend-item"><i class="fas fa-circle" style="color: #10b981"></i> Correct</span>
                        <span class="legend-item"><i class="fas fa-circle" style="color: #ef4444"></i> Incorrect</span>
                        <span class="legend-item"><i class="fas fa-circle" style="color: #f59e0b"></i> Marked</span>
                    </div>
                </div>
                <div class="question-dots" id="questionDots">
                    ${generateQuestionDots(questions, courseColor)}
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button onclick="prevQuestion()" id="prevBtn" class="btn-nav">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                
                <div class="nav-center">
                    <button onclick="showQuestionList()" class="btn-nav-outline">
                        <i class="fas fa-list"></i> Question List
                    </button>
                    <button onclick="pauseTest()" class="btn-nav-outline">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                </div>
                
                <button onclick="nextQuestion()" id="nextBtn" class="btn-nav" style="background: ${courseColor}">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    `;
}

// Generate question dots
function generateQuestionDots(questions, courseColor) {
    let dotsHTML = '';
    const maxDots = Math.min(questions.length, 50); // Limit for performance
    
    for (let i = 0; i < maxDots; i++) {
        const status = getUserAnswerStatus(i);
        dotsHTML += `
            <button onclick="goToQuestion(${i})" 
                    class="question-dot ${status}" 
                    id="questionDot${i}"
                    title="Question ${i + 1}">
                ${i + 1}
            </button>
        `;
    }
    
    if (questions.length > maxDots) {
        dotsHTML += `
            <div class="more-dots">
                +${questions.length - maxDots} more
                <div class="dots-dropdown">
                    ${Array.from({length: questions.length - maxDots}, (_, i) => i + maxDots)
                        .map(i => `<button onclick="goToQuestion(${i})">Q${i + 1}</button>`)
                        .join('')}
                </div>
            </div>
        `;
    }
    
    return dotsHTML;
}

// Generate analytics panel
function generateAnalyticsPanel() {
    return `
        <div class="analytics-panel">
            <div class="analytics-header">
                <h5><i class="fas fa-chart-bar"></i> Live Analytics</h5>
                <button onclick="toggleAnalytics()" class="btn-toggle">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div class="analytics-content">
                <div class="analytics-grid">
                    <div class="analytic-item">
                        <div class="analytic-value" id="analyticCorrect">0</div>
                        <div class="analytic-label">Correct</div>
                    </div>
                    <div class="analytic-item">
                        <div class="analytic-value" id="analyticIncorrect">0</div>
                        <div class="analytic-label">Incorrect</div>
                    </div>
                    <div class="analytic-item">
                        <div class="analytic-value" id="analyticSkipped">0</div>
                        <div class="analytic-label">Skipped</div>
                    </div>
                    <div class="analytic-item">
                        <div class="analytic-value" id="analyticTime">0s</div>
                        <div class="analytic-label">Avg Time</div>
                    </div>
                </div>
                
                <div class="progress-chart">
                    <canvas id="progressChart"></canvas>
                </div>
                
                <div class="weak-areas">
                    <h6>Weak Areas</h6>
                    <div id="weakAreasList">
                        <div class="weak-area-item">
                            <span class="area-name">Loading...</span>
                            <div class="area-progress">
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: 50%"></div>
                                </div>
                                <span class="area-percent">50%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ==================== ENHANCED QUESTION LOADING ====================

function loadEnhancedQuestion() {
    if (!currentCourseQuestions || currentCourseQuestions.length === 0) return;
    
    const question = currentCourseQuestions[currentQuestionIndex];
    if (!question) return;
    
    // Update UI
    updateQuestionUI(question);
    updateOptionsUI(question);
    updateNavigationUI();
    updateProgressUI();
    updateAnalyticsUI();
    
    // Start question timer
    startQuestionTimer();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateQuestionUI(question) {
    // Update question text
    const questionTextEl = document.getElementById('questionText');
    if (questionTextEl) {
        questionTextEl.innerHTML = formatQuestionText(question.question_text);
    }
    
    // Update question number
    const questionNumberEl = document.querySelector('.question-number');
    if (questionNumberEl) {
        questionNumberEl.textContent = currentQuestionIndex + 1;
    }
    
    // Update difficulty tag
    const difficultyTag = document.querySelector('.difficulty-tag');
    if (difficultyTag) {
        const difficultyColors = {
            easy: '#10b981',
            medium: '#f59e0b',
            hard: '#ef4444'
        };
        difficultyTag.textContent = (question.difficulty || 'medium').toUpperCase();
        difficultyTag.style.background = difficultyColors[question.difficulty] || '#f59e0b';
    }
    
    // Update question image
    const imageContainer = document.querySelector('.question-image');
    if (imageContainer) {
        if (question.image_url) {
            imageContainer.innerHTML = `<img src="${question.image_url}" alt="Question image" onerror="this.style.display='none'">`;
            imageContainer.style.display = 'block';
        } else {
            imageContainer.style.display = 'none';
        }
    }
}

function updateOptionsUI(question) {
    const optionsContainer = document.getElementById('optionsContainer');
    if (!optionsContainer) return;
    
    const userAnswer = userTestAnswers[currentQuestionIndex];
    const isAnswered = userAnswer?.answered;
    const isCorrect = userAnswer?.correct;
    const selectedAnswer = userAnswer?.answer;
    
    let optionsHTML = '';
    
    if (question.question_type === 'multiple_choice') {
        const options = getQuestionOptions(question);
        
        optionsHTML = '<div class="options-grid">';
        
        options.forEach((option, index) => {
            const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
            const isSelected = selectedAnswer === option.text;
            const isCorrectAnswer = question.correct_answer?.trim().toLowerCase() === option.text.trim().toLowerCase();
            
            let optionClass = 'option-item';
            if (isAnswered) {
                if (isSelected && isCorrect) optionClass += ' option-correct';
                else if (isSelected && !isCorrect) optionClass += ' option-incorrect';
                else if (!isSelected && isCorrectAnswer) optionClass += ' option-correct';
            } else if (isSelected) {
                optionClass += ' option-selected';
            }
            
            optionsHTML += `
                <div class="${optionClass}" 
                     onclick="${!isAnswered ? `selectOption(${index})` : ''}"
                     data-option="${index}">
                    <div class="option-letter">${optionLetter}</div>
                    <div class="option-text">${option.text}</div>
                    ${isAnswered ? `
                        <div class="option-status">
                            ${isSelected && isCorrect ? '<i class="fas fa-check-circle success"></i>' : ''}
                            ${isSelected && !isCorrect ? '<i class="fas fa-times-circle error"></i>' : ''}
                            ${!isSelected && isCorrectAnswer ? '<i class="fas fa-check-circle success"></i>' : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        optionsHTML += '</div>';
    } else {
        // Short answer question
        optionsHTML = `
            <div class="short-answer-container">
                <div class="answer-input-group">
                    <label for="shortAnswerInput">Your Answer:</label>
                    <textarea id="shortAnswerInput" 
                              placeholder="Type your answer here..." 
                              rows="3"
                              ${isAnswered ? 'disabled' : ''}
                              oninput="updateShortAnswer(this.value)">${selectedAnswer || ''}</textarea>
                </div>
                ${isAnswered ? `
                    <div class="correct-answer-box">
                        <h5><i class="fas fa-check"></i> Correct Answer:</h5>
                        <p>${question.correct_answer || 'No answer provided'}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    optionsContainer.innerHTML = optionsHTML;
    
    // Update action buttons
    updateActionButtons(isAnswered, isCorrect);
    
    // Update explanation if answered
    if (isAnswered) {
        showExplanation(question);
    }
}

function updateActionButtons(isAnswered, isCorrect) {
    const checkBtn = document.getElementById('checkAnswerBtn');
    const showBtn = document.getElementById('showAnswerBtn');
    const resetBtn = document.getElementById('resetBtn');
    const skipBtn = document.getElementById('skipBtn');
    
    if (checkBtn) {
        if (isAnswered) {
            checkBtn.innerHTML = '<i class="fas fa-check-circle"></i> Already Answered';
            checkBtn.disabled = true;
            checkBtn.style.opacity = '0.6';
        } else {
            checkBtn.innerHTML = '<i class="fas fa-check-circle"></i> Check Answer';
            checkBtn.disabled = false;
            checkBtn.style.opacity = '1';
        }
    }
    
    if (showBtn) {
        showBtn.disabled = isAnswered;
    }
    
    if (resetBtn) {
        resetBtn.disabled = !isAnswered;
    }
    
    if (skipBtn) {
        skipBtn.style.display = currentStudyMode === 'practice' ? 'flex' : 'none';
    }
}

// ==================== ENHANCED FEATURES ====================

// Select option
function selectOption(optionIndex) {
    if (!currentCourseQuestions || !currentCourseQuestions[currentQuestionIndex]) return;
    
    const question = currentCourseQuestions[currentQuestionIndex];
    const options = getQuestionOptions(question);
    
    if (optionIndex >= options.length) return;
    
    const selectedAnswer = options[optionIndex].text;
    
    userTestAnswers[currentQuestionIndex] = {
        ...userTestAnswers[currentQuestionIndex],
        answer: selectedAnswer,
        selected: true,
        firstInteraction: userTestAnswers[currentQuestionIndex]?.firstInteraction || new Date(),
        lastInteraction: new Date(),
        attempts: (userTestAnswers[currentQuestionIndex]?.attempts || 0) + 1
    };
    
    // Update UI
    updateOptionsUI(question);
    
    // Auto-check if enabled in settings
    const autoCheck = localStorage.getItem('nursequestions_autoCheck') === 'true';
    if (autoCheck && currentStudyMode === 'practice') {
        setTimeout(() => checkAnswer(), 500);
    }
}

// Check answer with enhanced feedback
function checkAnswer() {
    if (!currentCourseQuestions || !currentCourseQuestions[currentQuestionIndex]) return;
    
    const question = currentCourseQuestions[currentQuestionIndex];
    const userAnswer = userTestAnswers[currentQuestionIndex]?.answer;
    
    if (!userAnswer && question.question_type === 'multiple_choice') {
        showNotification('Please select an answer first.', 'warning');
        return;
    }
    
    const isCorrect = isAnswerCorrect(question, userAnswer);
    
    // Update user answer data
    userTestAnswers[currentQuestionIndex] = {
        ...userTestAnswers[currentQuestionIndex],
        answered: true,
        correct: isCorrect,
        checked: true,
        timeSpent: (userTestAnswers[currentQuestionIndex]?.timeSpent || 0) + (Date.now() - window.questionStartTime) / 1000
    };
    
    // Update performance data
    updateUserPerformance(isCorrect);
    
    // Update UI
    updateOptionsUI(question);
    showExplanation(question);
    
    // Show enhanced feedback
    showEnhancedFeedback(isCorrect, question);
    
    // Auto-advance if enabled
    const autoAdvance = localStorage.getItem('nursequestions_autoAdvance') === 'true';
    if (autoAdvance && currentStudyMode === 'practice') {
        setTimeout(() => {
            if (currentQuestionIndex < currentCourseQuestions.length - 1) {
                nextQuestion();
            }
        }, 2000);
    }
    
    // Track analytics
    trackEvent('answer_checked', {
        questionId: question.id,
        isCorrect,
        timeSpent: userTestAnswers[currentQuestionIndex].timeSpent,
        attempts: userTestAnswers[currentQuestionIndex].attempts
    });
}

// Show enhanced feedback
function showEnhancedFeedback(isCorrect, question) {
    const feedbackMessages = {
        correct: [
            "Excellent! üéâ You nailed it!",
            "Perfect! That's absolutely right!",
            "Great job! You're really getting this!",
            "Brilliant! Keep up the good work!",
            "Spot on! Your understanding is solid!"
        ],
        incorrect: [
            "Almost there! The correct answer was:",
            "Good attempt! Remember this for next time:",
            "Don't worry! Learning from mistakes is key:",
            "Let's review this concept. Correct answer:",
            "Good effort! Here's the right answer:"
        ]
    };
    
    const messages = isCorrect ? feedbackMessages.correct : feedbackMessages.incorrect;
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    
    const feedbackHTML = `
        <div class="feedback-toast ${isCorrect ? 'success' : 'error'}">
            <div class="feedback-icon">
                <i class="fas fa-${isCorrect ? 'check-circle' : 'exclamation-circle'}"></i>
            </div>
            <div class="feedback-content">
                <h5>${randomMessage}</h5>
                ${!isCorrect ? `
                    <p><strong>${question.correct_answer}</strong></p>
                ` : ''}
            </div>
            <button onclick="this.parentElement.remove()" class="btn-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Insert feedback
    const questionSection = document.querySelector('.question-section');
    if (questionSection) {
        const existingFeedback = questionSection.querySelector('.feedback-toast');
        if (existingFeedback) existingFeedback.remove();
        
        questionSection.insertAdjacentHTML('beforeend', feedbackHTML);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const toast = questionSection.querySelector('.feedback-toast');
            if (toast) toast.remove();
        }, 5000);
    }
}

// Show explanation with enhanced features
function showExplanation(question) {
    const explanationContent = document.getElementById('explanationContent');
    const explanationPlaceholder = document.getElementById('explanationPlaceholder');
    const explanationText = document.getElementById('explanationText');
    
    if (!explanationContent || !explanationPlaceholder || !explanationText) return;
    
    // Show explanation section
    explanationPlaceholder.style.display = 'none';
    explanationContent.style.display = 'block';
    
    // Format explanation text
    let explanationHTML = question.explanation || 
        'No detailed explanation available. This answer is correct based on nursing standards and guidelines.';
    
    // Enhance explanation with formatting
    explanationHTML = formatExplanationText(explanationHTML);
    
    // Add references if available
    if (question.references) {
        explanationHTML += `
            <div class="explanation-references">
                <h6><i class="fas fa-book"></i> References:</h6>
                <ul>
                    ${question.references.split(',').map(ref => `<li>${ref.trim()}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    explanationText.innerHTML = explanationHTML;
    
    // Show resources section if available
    if (question.resources || question.links) {
        showResources(question);
    }
    
    // Scroll to explanation
    setTimeout(() => {
        explanationContent.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 300);
}

// Format explanation text with enhanced features
function formatExplanationText(text) {
    // Convert markdown-like syntax
    let formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>') // Code blocks
        .replace(/`(.*?)`/g, '<code>$1</code>') // Inline code
        .replace(/# (.*?)(\n|$)/g, '<h6>$1</h6>') // Headers
        .replace(/\n/g, '<br>') // Line breaks
        .replace(/- (.*?)(\n|$)/g, '<li>$1</li>'); // Lists
    
    // Wrap lists
    formatted = formatted.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');
    
    return formatted;
}

// ==================== ANALYTICS & TRACKING ====================

function updateUserPerformance(isCorrect) {
    const courseId = currentCourseForTest?.id;
    if (!courseId) return;
    
    // Load existing performance
    const userPerformance = JSON.parse(localStorage.getItem('nursequestions_userPerformance') || '{}');
    
    if (!userPerformance[courseId]) {
        userPerformance[courseId] = {
            attempted: 0,
            correct: 0,
            totalTime: 0,
            weakAreas: {}
        };
    }
    
    // Update stats
    userPerformance[courseId].attempted++;
    if (isCorrect) userPerformance[courseId].correct++;
    
    // Update weak areas
    const question = currentCourseQuestions[currentQuestionIndex];
    const category = question.category || question.difficulty || 'general';
    if (!userPerformance[courseId].weakAreas[category]) {
        userPerformance[courseId].weakAreas[category] = { attempted: 0, correct: 0 };
    }
    userPerformance[courseId].weakAreas[category].attempted++;
    if (isCorrect) userPerformance[courseId].weakAreas[category].correct++;
    
    // Calculate average time
    const timeSpent = userTestAnswers[currentQuestionIndex]?.timeSpent || 0;
    userPerformance[courseId].totalTime += timeSpent;
    
    // Save back to localStorage
    localStorage.setItem('nursequestions_userPerformance', JSON.stringify(userPerformance));
    
    // Update global statistics
    updateTestStatistics(isCorrect, timeSpent);
}

function updateTestStatistics(isCorrect, timeSpent) {
    testStatistics.totalAttempted++;
    if (isCorrect) testStatistics.totalCorrect++;
    else testStatistics.totalIncorrect++;
    
    // Update average time
    testStatistics.averageTime = 
        ((testStatistics.averageTime * (testStatistics.totalAttempted - 1)) + timeSpent) / 
        testStatistics.totalAttempted;
    
    // Save statistics
    localStorage.setItem('nursequestions_statistics', JSON.stringify(testStatistics));
    
    // Update UI
    updateAnalyticsUI();
}

// ==================== HELPER FUNCTIONS ====================

function getQuestionOptions(question) {
    const options = [];
    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
    
    // Try different field patterns
    for (let i = 0; i < 6; i++) {
        const field = `option_${String.fromCharCode(97 + i)}`; // option_a, option_b, etc.
        if (question[field] && question[field].trim()) {
            options.push({
                letter: optionLetters[i],
                text: question[field].trim()
            });
        }
    }
    
    // If no standard options, try JSON or comma-separated
    if (options.length === 0 && question.options) {
        try {
            const parsedOptions = JSON.parse(question.options);
            if (Array.isArray(parsedOptions)) {
                parsedOptions.forEach((opt, idx) => {
                    if (opt && opt.trim()) {
                        options.push({
                            letter: optionLetters[idx],
                            text: opt.trim()
                        });
                    }
                });
            }
        } catch (e) {
            // Treat as comma-separated
            const splitOptions = question.options.split(',');
            splitOptions.forEach((opt, idx) => {
                if (opt && opt.trim()) {
                    options.push({
                        letter: optionLetters[idx],
                        text: opt.trim()
                    });
                }
            });
        }
    }
    
    return options;
}

function isAnswerCorrect(question, userAnswer) {
    if (!question.correct_answer || !userAnswer) return false;
    
    // Case-insensitive comparison with trimming
    return question.correct_answer.trim().toLowerCase() === userAnswer.trim().toLowerCase();
}

function getUserAnswerStatus(questionIndex) {
    const answer = userTestAnswers[questionIndex];
    if (!answer) return '';
    
    if (answer.answered) {
        return answer.correct ? 'correct' : 'incorrect';
    } else if (answer.marked) {
        return 'marked';
    } else if (answer.selected) {
        return 'selected';
    }
    
    return '';
}

function calculateTotalTime(questions) {
    return questions.reduce((total, q) => total + (q.metadata?.readingTime || 1), 0);
}

// ==================== UTILITY FUNCTIONS ====================

function showLoading(message = 'Loading...') {
    const loadingEl = document.createElement('div');
    loadingEl.className = 'enhanced-loading';
    loadingEl.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p>${message}</p>
            <div class="loading-progress">
                <div class="progress-bar"></div>
            </div>
        </div>
    `;
    
    document.body.appendChild(loadingEl);
}

function hideLoading() {
    const loadingEl = document.querySelector('.enhanced-loading');
    if (loadingEl) loadingEl.remove();
}

function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `enhanced-toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        </div>
        <div class="toast-content">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function trackEvent(eventName, data = {}) {
    // Implementation for analytics tracking
    console.log(`üìä Event: ${eventName}`, data);
    
    // Could integrate with Google Analytics, Mixpanel, etc.
    if (typeof gtag !== 'undefined') {
        gtag('event', eventName, data);
    }
}

// ==================== GLOBAL EXPORTS ====================

// Make all functions available globally
window.loadQuestionBankCards = loadQuestionBankCards;
window.startEnhancedCourseTest = startEnhancedCourseTest;
window.selectOption = selectOption;
window.checkAnswer = checkAnswer;
window.showAnswer = showAnswer;
window.resetQuestion = resetQuestion;
window.skipQuestion = function() {
    if (currentQuestionIndex < currentCourseQuestions.length - 1) {
        nextQuestion();
    }
};
window.markForReview = markForReview;
window.goToQuestion = goToQuestion;
window.prevQuestion = prevQuestion;
window.nextQuestion = nextQuestion;
window.toggleStudyMode = function() {
    // Cycle through study modes
    const modes = Object.keys(STUDY_MODES);
    const currentIndex = modes.findIndex(m => STUDY_MODES[m].id === currentStudyMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    currentStudyMode = STUDY_MODES[modes[nextIndex]].id;
    
    showNotification(`Switched to ${STUDY_MODES[modes[nextIndex]].name}`, 'info');
    // Reload current question with new mode
    loadEnhancedQuestion();
};
       // *************************************************************************
            // *** ATTENDANCE SYSTEM ***
            // *************************************************************************
            
            // Load clinical targets
            async function loadClinicalTargets() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department) || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId);
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const intakeYear = currentUserProfile?.intake_year;
                const blockTerm = currentUserProfile?.block || null;
            
                if (!program || !intakeYear) {
                    cachedClinicalAreas = [];
                    return;
                }
            
                try {
                    // Geo-based clinical areas
                    const { data: areaData, error: areaError } = await sb
                        .from('clinical_areas')
                        .select('id, name, latitude, longitude, block, program, intake_year')
                        .ilike('program', program)
                        .ilike('intake_year', intakeYear)
                        .or(blockTerm ? `block.ilike.${blockTerm},block.is.null` : 'block.is.null');
                    if (areaError) throw areaError;
            
                    // Textual clinical names including UUID + coordinates
                    const { data: nameData, error: nameError } = await sb
                        .from('clinical_names')
                        .select('id, uuid, clinical_area_name, latitude, longitude, program, intake_year, block_term')
                        .ilike('program', program)
                        .ilike('intake_year', intakeYear)
                        .or(blockTerm ? `block_term.ilike.${blockTerm},block_term.is.null` : 'block_term.is.null');
                    if (nameError) throw nameError;
            
                    // Map textual names to use actual UUIDs + keep coordinates
                    const mappedNames = (nameData || []).map(n => ({
                        id: n.uuid,
                        original_id: n.id,
                        name: n.clinical_area_name,
                        latitude: n.latitude,
                        longitude: n.longitude,
                        block: n.block_term || null
                    }));
            
                    // Merge + deduplicate
                    cachedClinicalAreas = [...(areaData || []), ...mappedNames]
                        .filter((v, i, a) => a.findIndex(t => t.name === v.name) === i)
                        .sort((a, b) => a.name.localeCompare(b.name));
            
                } catch (error) {
                    console.error("Error loading clinical areas:", error);
                    cachedClinicalAreas = [];
                }
            }
            
            // Load class targets
            async function loadClassTargets() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department) || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId); 
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const intakeYear = currentUserProfile?.intake_year;
                const block = currentUserProfile?.block || null;
            
                if (!program || !intakeYear) {
                    cachedCourses = [];
                    return;
                }
            
                try {
                    let query = sb.from('courses_sections')
                        .select('id, name, code, latitude, longitude')
                        .eq('program', program)
                        .eq('intake_year', intakeYear);
            
                    if (block) query = query.or(`block.eq.${block},block.is.null`);
                    else query = query.is('block', null);
            
                    const { data, error } = await query.order('name');
                    if (error) throw error;
            
                    cachedCourses = (data || []).map(c => ({
                        id: c.id,
                        name: c.name,
                        code: c.code,
                        latitude: c.latitude,
                        longitude: c.longitude
                    }));
                } catch (error) {
                    console.error("Error loading class targets:", error);
                    cachedCourses = [];
                }
            }
            
            // Load attendance history
            async function loadGeoAttendanceHistory(userId) {
                const tableBody = document.getElementById('geo-attendance-history');
                if (!tableBody) return;
                
                tableBody.innerHTML = '<tr><td colspan="4">Loading geo check-in history...</td></tr>';
            
                try {
                    const { data: logs, error } = await sb
                        .from('geo_attendance_logs')
                        .select('check_in_time, session_type, target_name, is_verified')
                        .eq('student_id', userId)
                        .order('check_in_time', { ascending: false })
                        .limit(100);
            
                    if (error) throw error;
            
                    tableBody.innerHTML = '';
                    if (!logs || logs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4">No check-in logs found.</td></tr>';
                        return;
                    }
            
                    logs.forEach(log => {
                        const timeStr = new Date(log.check_in_time).toLocaleString();
                        const verifiedText = log.is_verified ? '‚úÖ Verified' : '‚è≥ Pending verification';
            
                        const row = `
                            <tr>
                                <td>${timeStr}</td>
                                <td>${log.session_type}</td>
                                <td>${log.target_name}</td>
                                <td>${verifiedText}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Failed to load attendance history:", error);
                    tableBody.innerHTML = `<tr><td colspan="4" style="color:#EF4444;">Error loading attendance logs: ${error.message}</td></tr>`;
                }
            }
            
            // Update target dropdown
            function updateTargetSelect() {
                const sessionTypeSelect = document.getElementById('session-type');
                const attendanceTargetSelect = document.getElementById('attendance-target');
                const geoMessage = document.getElementById('geo-message');
                
                if (!sessionTypeSelect || !attendanceTargetSelect || !geoMessage) return;
            
                const sessionType = sessionTypeSelect.value;
                attendanceTargetSelect.innerHTML = '';
            
                let targetList = [];
                let label = 'Department/Course:';
            
                if (sessionType === 'Clinical') {
                    targetList = cachedClinicalAreas.map(d => ({
                        id: d.id,
                        name: d.name,
                        text: `${d.name} (Clinical)`
                    }));
                    label = 'Department/Area:';
                } else if (sessionType === 'Class') {
                    targetList = cachedCourses.map(c => ({
                        id: c.id,
                        name: c.name,
                        code: c.code,
                        text: `${c.code ? c.code + ' - ' : ''}${c.name} (Class)`
                    }));
                    label = 'Course/Subject:';
                }
            
                const targetLabel = document.getElementById('target-label');
                if (targetLabel) targetLabel.textContent = label;
            
                if (targetList.length === 0) {
                    const message = sessionType === 'Class'
                        ? 'No active courses found for your block.'
                        : 'No clinical areas assigned to your block.';
                    attendanceTargetSelect.innerHTML = `<option value="">${message}</option>`;
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `-- Select a ${label.replace(':', '')} --`;
                    attendanceTargetSelect.appendChild(defaultOption);
            
                    targetList.forEach(target => {
                        const option = document.createElement('option');
                        option.value = `${target.id}|${target.name}`;
                        option.textContent = target.text;
                        attendanceTargetSelect.appendChild(option);
                    });
            
                    attendanceTargetSelect.selectedIndex = 0;
                }
            
                geoMessage.innerHTML = `Please select a specific <strong>${label.replace(':', '')}</strong> to check in.`;
            }
            
            // Get device ID
            function getDeviceId() {
                let deviceId = localStorage.getItem('device_id');
                if (!deviceId) {
                    deviceId = crypto.randomUUID();
                    localStorage.setItem('device_id', deviceId);
                }
                return deviceId;
            }
            
            // Geo check-in function - UPDATED WITH OFFLINE SUPPORT
            async function geoCheckIn() {
                const button = document.getElementById('check-in-button');
                const geoMessage = document.getElementById('geo-message');
                const sessionTypeSelect = document.getElementById('session-type');
                const attendanceTargetSelect = document.getElementById('attendance-target');
            
                if (button) button.disabled = true;
                if (geoMessage) geoMessage.textContent = '‚è±Ô∏è Initializing check-in...';
            
                try {
                    if (!currentUserProfile) await loadProfile(currentUserId);
                    const studentProfile = currentUserProfile;
                    if (!studentProfile) {
                        if (geoMessage) geoMessage.textContent = 'Error: Student profile not loaded.';
                        return;
                    }
            
                    const studentProgram = studentProfile?.program || studentProfile?.department || null;
                    const deviceId = getDeviceId();
                    const sessionType = sessionTypeSelect?.value;
                    const targetSelect = attendanceTargetSelect?.value;
                    const checkInTime = new Date().toISOString();
            
                    if (!sessionType || !targetSelect || targetSelect === '') {
                        if (geoMessage) geoMessage.textContent = 'Error: Select session type and target.';
                        return;
                    }
            
                    // TargetSelect format is ID|NAME
                    const [targetId, targetNameFromDropdown] = targetSelect.split('|');
            
                    if (!targetId || !targetNameFromDropdown) {
                        if (geoMessage) geoMessage.textContent = 'Error: Invalid target selected.';
                        return;
                    }
            
                    // Check if offline
                    if (!navigator.onLine) {
                        OfflineManager.addToQueue('checkIn', {
                            sessionType,
                            targetId,
                            targetNameFromDropdown,
                            studentProgram,
                            checkInTime,
                            deviceId
                        });
                        if (geoMessage) geoMessage.innerHTML = `‚úÖ Check-in saved offline. Will sync when back online.`;
                        if (button) button.disabled = false;
                        return;
                    }
            
                    if (geoMessage) geoMessage.textContent = '‚è±Ô∏è Requesting device location... (Allow up to 15 seconds for GPS lock)';
            
                    // Get geolocation
                    const location = await new Promise(resolve => {
                        if (!navigator.geolocation) return resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'GPS unavailable' });
                        navigator.geolocation.getCurrentPosition(
                            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy, friendly: null }),
                            () => resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'GPS denied/timeout' }),
                            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                        );
                    });
            
                    // Reverse-geocode for friendly name
                    if (!location.friendly) {
                        try {
                            const res = await fetch(`${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${location.lat}&lon=${location.lon}&format=json`);
                            if (res.ok) {
                                const geoData = await res.json();
                                location.friendly = geoData?.display_name || `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)}`;
                            } else {
                                location.friendly = `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)} (Geo-API failed)`;
                            }
                        } catch (err) {
                            location.friendly = `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)} (Geo-API error)`;
                            console.warn('Reverse geocoding error:', err);
                        }
                    }
            
                    // Find the target entry to get coordinates and the CORRECT name
                    let targetEntry = sessionType === 'Clinical'
                        ? cachedClinicalAreas.find(c => c.id === targetId)
                        : cachedCourses.find(c => c.id === targetId);
                        
                    if (!targetEntry || (targetEntry.latitude === null || targetEntry.longitude === null)) {
                        if (geoMessage) geoMessage.textContent = 'Error: Target location coordinates not found.';
                        return;
                    }
            
                    let dbTargetId = targetEntry.id;
                    let targetNameToLog = targetNameFromDropdown;
                    let selectedCourseId = null;
            
                    // Set name and ID for logging based on type
                    if (sessionType === 'Class') {
                        targetNameToLog = targetEntry.name; 
                        selectedCourseId = targetEntry.id;
                    } else if (sessionType === 'Clinical') {
                        targetNameToLog = targetEntry.name;
                        dbTargetId = targetEntry.id;
                    }
            
                    // Haversine distance calculation
                    const R = 6371000; // Earth radius in meters
                    const toRad = x => x * Math.PI / 180;
                    const dLat = toRad(location.lat - targetEntry.latitude);
                    const dLon = toRad(location.lon - targetEntry.longitude);
                    const lat1 = toRad(location.lat);
                    const lat2 = toRad(targetEntry.latitude);
                    const a = Math.sin(dLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    const distanceMeters = R * c;
                    const isVerified = distanceMeters <= MAX_DISTANCE_RADIUS;
            
                    // RPC call to insert check-in
                    const { error } = await sb.rpc('check_in_and_defer_fk', {
                        p_student_id: currentUserId,
                        p_check_in_time: checkInTime,
                        p_session_type: sessionType === 'Clinical' ? 'Clinical' : 'Class',
                        p_target_id: dbTargetId,
                        p_target_name: targetNameToLog,
                        p_latitude: location.lat,
                        p_longitude: location.lon,
                        p_accuracy_m: location.acc,
                        p_location_friendly_name: location.friendly,
                        p_program: studentProgram,
                        p_block: studentProfile.block,
                        p_intake_year: studentProfile.intake_year,
                        p_device_id: deviceId,
                        p_is_verified: isVerified,
                        p_course_id: selectedCourseId,
                        p_student_name: studentProfile.full_name || studentProfile.name || 'Unknown Student'
                    });
            
                    if (error) {
                        console.error('Check-in failed:', error);
                        if (geoMessage) geoMessage.textContent = `Check-in failed: ${error.message}`;
                    } else {
                        if (geoMessage) geoMessage.innerHTML = `‚úÖ Check-in complete! ${isVerified ? 'Verified successfully' : 'Pending verification'}`;
                        loadGeoAttendanceHistory(currentUserId);
                    }
            
                } catch (e) {
                    console.error('GeoCheckIn error:', e);
                    if (geoMessage) geoMessage.textContent = `üö´ Critical error: ${e.message}`;
                } finally {
                    if (button) button.disabled = false;
                }
            }
            
            // *************************************************************************
            // *** COURSES, EXAMS, AND RESOURCES ***
            // *************************************************************************
            
            // Load courses
            async function loadCourses() {
                const tableBody = document.getElementById('courses-table');
                if (!tableBody) return;
                AppUtils.showLoading(tableBody, 'Loading courses...');

                if (!currentUserProfile) await loadProfile(currentUserId); 
                
                const program = currentUserProfile?.program;
                const department = currentUserProfile?.department;
                const block = currentUserProfile?.block;
                const intakeYear = currentUserProfile?.intake_year;

                if ((!program && !department) || !intakeYear) {
                    tableBody.innerHTML = `<tr><td colspan="4">
                        Missing program/department or intake year info. 
                        Program: ${program || 'undefined'}, 
                        Department: ${department || 'undefined'},
                        Intake Year: ${intakeYear || 'undefined'}
                        Cannot load courses.
                    </td></tr>`;
                    cachedCourses = [];
                    return;
                }

                try {
                    const blockFilter = `block.eq.${block},block.is.null,block.eq.General`;

                    let programFilter;
                    
                    if (program === 'TVET' || department === 'TVET') {
                        programFilter = `target_program.eq.TVET`;
                    } else if (program === 'KRCHN') {
                        programFilter = `target_program.eq.KRCHN`;
                    } else if (department === 'Nursing') {
                        programFilter = `target_program.eq.Nursing`;
                    } else if (department === 'Clinical Medicine') {
                        programFilter = `target_program.eq.Clinical Medicine`;
                    } else if (department === 'Management') {
                        programFilter = `target_program.eq.Management`;
                    } else {
                        programFilter = `target_program.eq.${program}`;
                    }

                    const { data: courses, error } = await sb
                        .from('courses')
                        .select('*')
                        .or(programFilter)
                        .eq('intake_year', intakeYear)
                        .or(blockFilter)
                        .order('course_name', { ascending: true });

                    if (error) throw error;

                    cachedCourses = courses || [];
                    
                    tableBody.innerHTML = '';
                    if (cachedCourses.length > 0) {
                        cachedCourses.forEach(c => {
                            tableBody.innerHTML += `
                                <tr>
                                    <td>${escapeHtml(c.course_name) || 'N/A'}</td>
                                    <td>${escapeHtml(c.unit_code) || 'N/A'}</td>
                                    <td>${escapeHtml(c.description) || 'N/A'}</td>
                                    <td>${escapeHtml(c.status) || 'N/A'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="4">
                            No courses found for: ${program || department} 
                            (Program: ${program || 'undefined'}, Department: ${department || 'undefined'})
                            <br>Intake Year: ${intakeYear}, Block: ${block}
                        </td></tr>`;
                    }

                } catch (error) {
                    console.error("‚ùå Failed to load courses:", error);
                    AppUtils.showError(tableBody, `Error loading courses: ${error.message}`);
                    cachedCourses = [];
                }

                if (typeof loadDashboardMetrics === "function") {
                    loadDashboardMetrics(currentUserId);
                }
            }

            // Utility to safely escape HTML
            function escapeHtml(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
                        
// Load exams - FIXED: Pass mark is ALWAYS 60% with consistent PASS/FAIL
async function loadExams() {
    const tableBody = document.getElementById('exams-table');
    if (!tableBody) return;

    AppUtils.showLoading(tableBody, 'Loading your exams and grades...');

    if (!currentUserProfile) await loadProfile(currentUserId);
    const program = currentUserProfile?.program || currentUserProfile?.department;
    const block = currentUserProfile?.block;
    const intakeYear = currentUserProfile?.intake_year;
    const studentId = currentUserId;

    if (!program || !intakeYear) {
        tableBody.innerHTML = `<tr><td colspan="9">Missing program or intake year info. Cannot load exams.</td></tr>`;
        cachedExams = [];
        return;
    }

    try {
        // Fetch exams for this student's program
        const { data: exams, error: examsError } = await sb
            .from('exams_with_courses')
            .select(`
                id,
                exam_name,
                exam_type,  
                exam_date,
                status,
                block_term,
                program_type,
                exam_link,
                course_name
            `)
            .or(`program_type.eq.${program},program_type.eq.General`)
            .or(`block_term.eq.${block},block_term.is.null,block_term.eq.General`)
            .eq('intake_year', intakeYear)
            .order('exam_date', { ascending: true });

        if (examsError) throw examsError;

        // Fetch overall grades
        const { data: grades, error: gradesError } = await sb
            .from('exam_grades')
            .select(`
                exam_id,
                student_id,
                cat_1_score,
                cat_2_score,
                exam_score,
                total_score,
                result_status,
                marks,
                graded_by,
                graded_at
            `)
            .eq('student_id', studentId)
            .eq('question_id', '00000000-0000-0000-0000-000000000000')
            .order('graded_at', { ascending: false });

        if (gradesError) throw gradesError;

        // Combine exams with their grades - FIXED: Consistent PASS/FAIL logic
        cachedExams = exams.map(exam => {
            const grade = grades?.find(g => String(g.exam_id) === String(exam.id));
            const examType = exam.exam_type || '';
            
            // ‚úÖ FIXED: Consistent PASS/FAIL calculation for both table and transcript
            let resultStatus = 'Scheduled';
            let displayStatus = 'Scheduled';
            let calculatedPercentage = null;
            
            if (grade) {
                // Calculate percentage consistently
                if (grade.total_score !== null && grade.total_score !== undefined) {
                    // Use total_score from database (already a percentage)
                    calculatedPercentage = Number(grade.total_score);
                } else {
                    // Calculate from CAT scores if total_score not available
                    if (examType.includes('CAT_1') || examType === 'CAT' || examType === 'CAT_1') {
                        if (grade.cat_1_score !== null) {
                            calculatedPercentage = (grade.cat_1_score / 30) * 100;
                        }
                    } else if (examType.includes('CAT_2') || examType === 'CAT_2') {
                        if (grade.cat_2_score !== null) {
                            calculatedPercentage = (grade.cat_2_score / 30) * 100;
                        }
                    } else if (examType === 'EXAM' || examType.includes('EXAM') || examType.includes('Final')) {
                        // For final exams, calculate from all scores if available
                        if (grade.cat_1_score !== null && grade.cat_2_score !== null && grade.exam_score !== null) {
                            const totalMarks = grade.cat_1_score + grade.cat_2_score + grade.exam_score;
                            calculatedPercentage = (totalMarks / 100) * 100;
                        } else if (grade.marks) {
                            // Try to get percentage from marks JSON
                            try {
                                const marksData = typeof grade.marks === 'string' ? JSON.parse(grade.marks) : grade.marks;
                                if (marksData.percentage !== undefined) {
                                    calculatedPercentage = marksData.percentage;
                                }
                            } catch (e) {
                                // Ignore parsing errors
                            }
                        }
                    }
                }
                
                // Determine PASS/FAIL based on 60% threshold
                if (calculatedPercentage !== null) {
                    displayStatus = calculatedPercentage >= 60 ? 'PASS' : 'FAIL';
                    resultStatus = 'Final';
                } else {
                    // If we can't calculate percentage, use result_status from database
                    if (grade.result_status === 'Final') {
                        displayStatus = 'Graded'; // Default to Graded if Final but no percentage
                        resultStatus = 'Final';
                    } else {
                        displayStatus = grade.result_status || 'Graded';
                        resultStatus = grade.result_status || 'Graded';
                    }
                }
            }
            
            return { 
                ...exam, 
                grade: grade || null,
                display_status: displayStatus,
                result_status: resultStatus,
                calculated_percentage: calculatedPercentage
            };
        });

        // Make exams data globally accessible
        window.cachedExams = cachedExams;

        // Filter by dropdown
        const filter = document.getElementById('exam-type-filter')?.value || 'all';
        let filteredExams = cachedExams;
        
        if (filter === 'CAT') {
            filteredExams = cachedExams.filter(e => {
                const examType = e.exam_type || '';
                const examName = e.exam_name || '';
                return examType.includes('CAT') || 
                       examName.toLowerCase().includes('cat') ||
                       examType === 'CAT_1' || 
                       examType === 'CAT_2';
            });
        } else if (filter === 'Final') {
            filteredExams = cachedExams.filter(e => {
                const examType = e.exam_type || '';
                const examName = e.exam_name || '';
                return examType === 'EXAM' || 
                       examName.toLowerCase().includes('final') ||
                       examName.toLowerCase().includes('exam');
            });
        }

        // Display exams table
        displayExamsTable(filteredExams);

    } catch (error) {
        console.error('‚ùå Failed to load exams:', error);
        AppUtils.showError(tableBody, `Error loading exams: ${error.message}`);
        cachedExams = [];
        
        // Show error in table
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="color: #DC2626; padding: 20px; text-align: center;">
                    Error loading exams: ${error.message}
                </td>
            </tr>
        `;
    }

    if (typeof loadDashboardMetrics === 'function') {
        loadDashboardMetrics(currentUserId);
    }
}

// Display exams in table - FIXED: 60% pass mark
function displayExamsTable(exams) {
    const tableBody = document.getElementById('exams-table');
    if (!tableBody) return;

    tableBody.innerHTML = '';
    
    if (!exams || exams.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="padding: 40px; text-align: center; color: #6B7280;">
                    <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    <h3>No Exams Found</h3>
                    <p>No exams match your current filter.</p>
                    <button onclick="resetExamFilter()" class="profile-button" style="margin-top: 10px;">
                        <i class="fas fa-redo"></i> Reset Filter
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    exams.forEach(exam => {
        const dateStr = exam.exam_date
            ? new Date(exam.exam_date).toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            })
            : 'N/A';

        const gradeEntry = exam.grade;
        const examType = exam.exam_type || 'EXAM';
        
        // Determine what scores to show
        let cat1Score = '-';
        let cat2Score = '-';
        let finalExamScore = '-';
        let totalScore = '-';
        let hasResults = false;
        
        if (gradeEntry) {
            hasResults = true;
            
            if (examType.includes('CAT_1') || examType === 'CAT' || examType === 'CAT_1') {
                // CAT 1 only
                cat1Score = gradeEntry.cat_1_score !== null ? gradeEntry.cat_1_score : '-';
                cat2Score = '<span style="color:#9CA3AF; font-style:italic;">N/A</span>';
                finalExamScore = '<span style="color:#9CA3AF; font-style:italic;">N/A</span>';
                
                // ‚úÖ Use calculated_percentage (consistent with transcript)
                if (exam.calculated_percentage !== null) {
                    totalScore = `${exam.calculated_percentage.toFixed(1)}%`;
                } else if (gradeEntry.total_score !== null) {
                    totalScore = `${gradeEntry.total_score.toFixed(1)}%`;
                } else if (gradeEntry.cat_1_score !== null) {
                    totalScore = `${((gradeEntry.cat_1_score / 30) * 100).toFixed(1)}%`;
                } else {
                    totalScore = '-';
                }
                    
            } else if (examType.includes('CAT_2') || examType === 'CAT_2') {
                // CAT 2 only
                cat1Score = '<span style="color:#9CA3AF; font-style:italic;">N/A</span>';
                cat2Score = gradeEntry.cat_2_score !== null ? gradeEntry.cat_2_score : '-';
                finalExamScore = '<span style="color:#9CA3AF; font-style:italic;">N/A</span>';
                
                // ‚úÖ Use calculated_percentage (consistent with transcript)
                if (exam.calculated_percentage !== null) {
                    totalScore = `${exam.calculated_percentage.toFixed(1)}%`;
                } else if (gradeEntry.total_score !== null) {
                    totalScore = `${gradeEntry.total_score.toFixed(1)}%`;
                } else if (gradeEntry.cat_2_score !== null) {
                    totalScore = `${((gradeEntry.cat_2_score / 30) * 100).toFixed(1)}%`;
                } else {
                    totalScore = '-';
                }
                    
            } else if (examType === 'EXAM' || examType.includes('EXAM') || examType.includes('Final')) {
                // Final Exam - show all scores
                cat1Score = gradeEntry.cat_1_score !== null ? gradeEntry.cat_1_score : '-';
                cat2Score = gradeEntry.cat_2_score !== null ? gradeEntry.cat_2_score : '-';
                finalExamScore = gradeEntry.exam_score !== null ? gradeEntry.exam_score : '-';
                
                // ‚úÖ Use calculated_percentage (consistent with transcript)
                if (exam.calculated_percentage !== null) {
                    totalScore = `${exam.calculated_percentage.toFixed(1)}%`;
                } else if (gradeEntry.total_score !== null) {
                    totalScore = `${gradeEntry.total_score.toFixed(1)}%`;
                } else if (gradeEntry.cat_1_score !== null && gradeEntry.cat_2_score !== null && gradeEntry.exam_score !== null) {
                    const totalMarks = gradeEntry.cat_1_score + gradeEntry.cat_2_score + gradeEntry.exam_score;
                    totalScore = `${totalMarks.toFixed(1)}%`;
                } else {
                    totalScore = '-';
                }
            }
        } else {
            // No grade yet
            cat1Score = '-';
            cat2Score = '-';
            finalExamScore = '-';
            totalScore = '-';
        }

        // Use display_status which is now consistently calculated
        const resultStatus = exam.display_status || 'Scheduled';
        
        // Determine status color and text
        let statusDisplay = '';
        let statusColor = '';
        
        if (resultStatus === 'PASS') {
            statusColor = '#10B981'; // Green
            statusDisplay = `<span style="color:${statusColor}; font-weight:700;">
                <i class="fas fa-check-circle"></i> PASS
            </span>`;
        } else if (resultStatus === 'FAIL') {
            statusColor = '#EF4444'; // Red
            statusDisplay = `<span style="color:${statusColor}; font-weight:700;">
                <i class="fas fa-times-circle"></i> FAIL
            </span>`;
        } else if (resultStatus === 'Graded') {
            statusColor = '#3B82F6'; // Blue
            statusDisplay = `<span style="color:${statusColor}; font-weight:700;">
                <i class="fas fa-clipboard-check"></i> Graded
            </span>`;
        } else {
            statusColor = '#F59E0B'; // Orange
            statusDisplay = `<span style="color:${statusColor}; font-weight:700;">
                <i class="fas fa-calendar"></i> ${resultStatus}
            </span>`;
        }

        // Add exam type badge
        const typeBadge = examType.includes('CAT_1') ? 
            '<span style="background:#3B82F6; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px;">CAT 1</span>' :
            examType.includes('CAT_2') ?
            '<span style="background:#8B5CF6; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px;">CAT 2</span>' :
            examType.includes('EXAM') || examType.includes('Final') ?
            '<span style="background:#EF4444; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px;">Final</span>' :
            '<span style="background:#6B7280; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px;">Exam</span>';

        // Action buttons
        let actionBtn = '';
        if (exam.exam_link && !hasResults) {
            actionBtn += `<a href="${exam.exam_link}" target="_blank" class="profile-button" style="background-color: var(--color-success); padding:6px 10px; font-size:0.85em; margin-right:5px;">
                <i class="fas fa-play-circle"></i> Start Exam
            </a>`;
        }
        
        if (hasResults) {
            actionBtn += `<button onclick="viewProvisionalTranscript('${exam.id}')" class="profile-button" style="background-color: var(--color-primary); padding:6px 10px; font-size:0.85em;">
                <i class="fas fa-eye"></i> View Transcript
            </button>`;
        } else if (!exam.exam_link) {
            actionBtn += `<button disabled class="profile-button" style="background-color: var(--color-secondary); padding:6px 10px; font-size:0.85em; opacity:0.6; cursor: not-allowed;">
                <i class="fas fa-clock"></i> Not Available
            </button>`;
        }

        tableBody.innerHTML += `
            <tr>
                <td>${escapeHtml(exam.exam_name || 'N/A')} ${typeBadge}</td>
                <td>${escapeHtml(exam.block_term || 'N/A')}</td>
                <td>${dateStr}</td>
                <td>${statusDisplay}</td>
                <td style="text-align:center; ${cat1Score !== '-' ? 'font-weight:600;' : ''}">${cat1Score}</td>
                <td style="text-align:center; ${cat2Score !== '-' && !cat2Score.includes('N/A') ? 'font-weight:600;' : ''}">${cat2Score}</td>
                <td style="text-align:center; ${finalExamScore !== '-' ? 'font-weight:600;' : ''}">${finalExamScore}</td>
                <td style="text-align:center; ${totalScore !== '-' && totalScore !== '-%' ? 'font-weight:700;' : ''}">
                    ${totalScore}
                </td>
                <td>${actionBtn}</td>
            </tr>`;
    });
}

// View provisional transcript - ENHANCED with better formatting
async function viewProvisionalTranscript(examId) {
    try {
        const exam = window.cachedExams?.find(e => String(e.id) === String(examId));
        if (!exam) {
            alert("Exam not found.");
            return;
        }

        const grade = exam.grade || {};
        const examType = exam.exam_type || '';
        
        // Get scores with better formatting
        let cat1Score = grade.cat_1_score !== null ? grade.cat_1_score : 'N/A';
        let cat2Score = grade.cat_2_score !== null ? grade.cat_2_score : 'N/A';
        let finalScore = grade.exam_score !== null ? grade.exam_score : 'N/A';
        let totalScore = '-';
        
        // Use calculated_percentage from exam object (same as table)
        if (exam.calculated_percentage !== null) {
            totalScore = `${exam.calculated_percentage.toFixed(1)}%`;
        } else if (grade.total_score !== null) {
            totalScore = `${grade.total_score.toFixed(1)}%`;
        } else {
            // Calculate from available scores (fallback)
            if (examType.includes('CAT_1') || examType === 'CAT' || examType === 'CAT_1') {
                if (grade.cat_1_score !== null) {
                    totalScore = `${((grade.cat_1_score / 30) * 100).toFixed(1)}%`;
                }
                cat2Score = 'N/A';
                finalScore = 'N/A';
            } else if (examType.includes('CAT_2') || examType === 'CAT_2') {
                if (grade.cat_2_score !== null) {
                    totalScore = `${((grade.cat_2_score / 30) * 100).toFixed(1)}%`;
                }
                cat1Score = 'N/A';
                finalScore = 'N/A';
            } else if (examType === 'EXAM' || examType.includes('EXAM') || examType.includes('Final')) {
                if (grade.cat_1_score !== null && grade.cat_2_score !== null && grade.exam_score !== null) {
                    const totalMarks = grade.cat_1_score + grade.cat_2_score + grade.exam_score;
                    totalScore = `${totalMarks.toFixed(1)}%`;
                }
            }
        }

        // Use the SAME display_status as the table (already calculated)
        const resultStatus = exam.display_status || 'Provisional';
        
        // Format graded date
        let gradedDateStr = 'N/A';
        let gradedByStr = 'System';
        
        if (grade.graded_at) {
            gradedDateStr = new Date(grade.graded_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Try to get lecturer name from cache or fetch it
        if (grade.graded_by) {
            // First check if we already fetched this lecturer name
            if (window.lecturerCache && window.lecturerCache[grade.graded_by]) {
                gradedByStr = window.lecturerCache[grade.graded_by];
            } else {
                // Try to get lecturer name from database
                try {
                    const { data: lecturer, error } = await sb
                        .from('users')
                        .select('full_name, email, username')
                        .eq('id', grade.graded_by)
                        .single();
                    
                    if (!error && lecturer) {
                        // Use full_name, email, or username
                        gradedByStr = lecturer.full_name || lecturer.email || lecturer.username || 'Lecturer';
                        
                        // Cache it for future use
                        if (!window.lecturerCache) window.lecturerCache = {};
                        window.lecturerCache[grade.graded_by] = gradedByStr;
                    } else {
                        // Check if it's already a name (not a UUID)
                        if (!grade.graded_by.includes('-') || grade.graded_by.length !== 36) {
                            gradedByStr = grade.graded_by;
                        } else {
                            gradedByStr = 'Auto-graded';
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch lecturer name:', e);
                    gradedByStr = 'Auto-graded';
                }
            }
        }

        // Update only elements that exist in your HTML
        const examNameElement = document.getElementById('transcript-exam-name');
        if (examNameElement) {
            examNameElement.textContent = exam.exam_name || 'N/A';
        }
        
        // Update scores - with enhanced formatting
        const cat1Element = document.getElementById('transcript-cat1');
        if (cat1Element) {
            if (grade.cat_1_score !== null && (examType.includes('CAT_1') || examType === 'CAT' || examType === 'CAT_1')) {
                const percentage = ((grade.cat_1_score / 30) * 100).toFixed(1);
                cat1Element.textContent = `${grade.cat_1_score} (${percentage}%)`;
            } else {
                cat1Element.textContent = cat1Score;
            }
        }
        
        const cat2Element = document.getElementById('transcript-cat2');
        if (cat2Element) {
            if (grade.cat_2_score !== null && examType.includes('CAT_2')) {
                const percentage = ((grade.cat_2_score / 30) * 100).toFixed(1);
                cat2Element.textContent = `${grade.cat_2_score} (${percentage}%)`;
            } else {
                cat2Element.textContent = cat2Score;
            }
        }
        
        const finalElement = document.getElementById('transcript-final');
        if (finalElement) {
            finalElement.textContent = finalScore;
        }
        
        const totalElement = document.getElementById('transcript-total');
        if (totalElement) {
            totalElement.textContent = totalScore;
            
            // Color code total score
            if (totalScore !== '-' && totalScore !== '-%' && totalScore !== 'N/A') {
                const numericScore = parseFloat(totalScore);
                if (!isNaN(numericScore)) {
                    totalElement.style.color = numericScore >= 60 ? '#10B981' : '#EF4444';
                    totalElement.style.fontWeight = 'bold';
                }
            }
        }
        
        const statusElement = document.getElementById('transcript-status');
        if (statusElement) {
            statusElement.textContent = resultStatus;
            statusElement.style.color = resultStatus === 'PASS' ? '#10B981' : 
                                     resultStatus === 'FAIL' ? '#EF4444' : '#6B7280';
            statusElement.style.fontWeight = 'bold';
        }
        
        // Add or update extra info rows
        const table = document.querySelector('#transcript-modal table');
        if (table) {
            // Remove any existing dynamic rows
            const existingRows = table.querySelectorAll('.dynamic-row');
            existingRows.forEach(row => row.remove());
            
            // Add Graded By, Date, and Pass Mark
            const rowsToAdd = [
                { label: 'Graded By:', value: gradedByStr },
                { label: 'Graded On:', value: gradedDateStr },
                { label: 'Pass Mark:', value: '60%' }
            ];
            
            rowsToAdd.forEach(rowData => {
                const row = table.insertRow();
                row.className = 'dynamic-row';
                row.innerHTML = `
                    <td style="font-weight:600; padding:4px 0; color:#4B5563; font-size:0.9em;">${rowData.label}</td>
                    <td style="padding:4px 0; font-size:0.9em; text-align:right;">${rowData.value}</td>
                `;
            });
        }

        // Show the modal
        const modal = document.getElementById('transcript-modal');
        if (modal) {
            modal.style.display = 'flex';
        }

    } catch (error) {
        console.error('Error viewing transcript:', error);
        AppUtils.showToast('Failed to load transcript details', 'error');
    }
}

// Close transcript modal with cleanup
function closeTranscriptModal() {
    const modal = document.getElementById('transcript-modal');
    if (modal) {
        modal.style.display = 'none';
        
        // Clean up dynamic rows
        const table = modal.querySelector('table');
        if (table) {
            const dynamicRows = table.querySelectorAll('.dynamic-row');
            dynamicRows.forEach(row => row.remove());
        }
    }
}

// Make sure functions are globally accessible
window.viewProvisionalTranscript = viewProvisionalTranscript;
window.closeTranscriptModal = closeTranscriptModal;
            // *************************************************************************
            // *** ENHANCED RESOURCES SYSTEM - VIEW ONLY ***
            // *************************************************************************

            let currentResources = [];
            let filteredResources = [];
            let currentReaderResource = null;

            // Enhanced loadResources function
            async function loadResources() {
                if (!currentUserProfile) await loadProfile(currentUserId);
                
                const resourcesGrid = document.getElementById('resources-grid');
                if (!resourcesGrid) return;
                
                AppUtils.showLoading(resourcesGrid, 'Loading resources...');
                currentResources = [];

                try {
                    const program = currentUserProfile?.program;
                    const block = currentUserProfile?.block;
                    const intakeYear = currentUserProfile?.intake_year;

                    if (!program || !intakeYear || !block) {
                        resourcesGrid.innerHTML = '<div class="error-state">Missing enrollment details</div>';
                        return;
                    }

                    const { data: resources, error } = await sb
                        .from('resources')
                        .select('id, title, file_path, file_url, program_type, block, intake, uploaded_by_name, created_at, description, file_type')
                        .eq('program_type', program)
                        .eq('block', block)
                        .eq('intake', intakeYear)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    currentResources = resources || [];
                    filteredResources = [...currentResources];
                    
                    renderResourcesGrid();
                    populateCourseFilter();

                } catch (err) {
                    console.error("Error loading resources:", err);
                    AppUtils.showError(resourcesGrid, `Error loading resources: ${err.message}`);
                }

                if (typeof loadDashboardMetrics === 'function') {
                    loadDashboardMetrics(currentUserId);
                }
            }

            // Render mobile-optimized resources grid - VIEW ONLY
            function renderResourcesGrid() {
                const resourcesGrid = document.getElementById('resources-grid');
                if (!resourcesGrid) return;

                if (filteredResources.length === 0) {
                    resourcesGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No Resources Found</h3>
                            <p>No resources match your current filters</p>
                        </div>
                    `;
                    return;
                }

                resourcesGrid.innerHTML = filteredResources.map(resource => `
                    <div class="resource-card" data-type="${getFileType(resource.file_path)}" data-course="${resource.program_type}">
                        <div class="card-header">
                            <div class="file-icon ${getFileType(resource.file_path)}">
                                <i class="${getFileIcon(resource.file_path)}"></i>
                            </div>
                            <div class="card-title">
                                <h3>${escapeHtml(resource.title)}</h3>
                                <span class="file-type">${getFileType(resource.file_path).toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <p class="card-description">${escapeHtml(resource.description || 'No description available')}</p>
                            
                            <div class="card-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${new Date(resource.created_at).toLocaleDateString()}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>${escapeHtml(resource.uploaded_by_name || 'Admin')}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-book"></i>
                                    <span>${escapeHtml(resource.program_type)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <button class="card-btn primary" onclick="openResource(${resource.id})">
                                <i class="fas fa-eye"></i> View Resource
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Open resource in mobile-optimized reader - VIEW ONLY
            async function openResource(resourceId) {
                const resource = currentResources.find(r => r.id == resourceId);
                if (!resource) return;

                currentReaderResource = resource;

                const reader = document.getElementById('mobile-reader');
                const readerTitle = document.getElementById('reader-title');
                const readerContent = document.getElementById('reader-content');

                if (!reader || !readerTitle || !readerContent) return;

                // Show reader
                reader.style.display = 'block';
                readerTitle.textContent = resource.title;

                // Load content based on file type
                const fileType = getFileType(resource.file_path);
                
                if (fileType === 'pdf') {
                    await loadPDFInReader(resource, readerContent);
                } else if (['doc', 'docx', 'ppt', 'pptx'].includes(fileType)) {
                    loadOfficeInReader(resource, readerContent);
                } else if (fileType === 'video') {
                    loadVideoInReader(resource, readerContent);
                } else {
                    loadFallbackView(resource, readerContent);
                }
            }
window.openResource = openResource; // ADD THIS LINE
            // Close mobile reader
            function closeReader() {
                const reader = document.getElementById('mobile-reader');
                if (reader) {
                    reader.style.display = 'none';
                    currentReaderResource = null;
                }
            }

            // Filter resources
            function filterResources() {
                const searchTerm = document.getElementById('resource-search').value.toLowerCase();
                const typeFilter = document.getElementById('resource-filter').value;
                const courseFilter = document.getElementById('course-filter').value;

                filteredResources = currentResources.filter(resource => {
                    const matchesSearch = resource.title.toLowerCase().includes(searchTerm) || 
                                        (resource.description && resource.description.toLowerCase().includes(searchTerm));
                    const matchesType = typeFilter === 'all' || getFileType(resource.file_path) === typeFilter;
                    const matchesCourse = courseFilter === 'all' || resource.program_type === courseFilter;

                    return matchesSearch && matchesType && matchesCourse;
                });

                renderResourcesGrid();
            }

            // Populate course filter
            function populateCourseFilter() {
                const courseFilter = document.getElementById('course-filter');
                if (!courseFilter) return;

                const courses = [...new Set(currentResources.map(r => r.program_type))];
                
                courseFilter.innerHTML = '<option value="all">All Courses</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseFilter.appendChild(option);
                });
            }

            // Utility functions for resources
            function getFileType(filePath) {
                if (!filePath) return 'unknown';
                const ext = filePath.split('.').pop().toLowerCase();
                
                if (ext === 'pdf') return 'pdf';
                if (['doc', 'docx'].includes(ext)) return 'doc';
                if (['ppt', 'pptx'].includes(ext)) return 'slides';
                if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) return 'video';
                if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'image';
                
                return 'file';
            }

            function getFileIcon(filePath) {
                const type = getFileType(filePath);
                
                switch(type) {
                    case 'pdf': return 'fas fa-file-pdf';
                    case 'doc': return 'fas fa-file-word';
                    case 'slides': return 'fas fa-file-powerpoint';
                    case 'video': return 'fas fa-file-video';
                    case 'image': return 'fas fa-file-image';
                    default: return 'fas fa-file';
                }
            }

            // PDF loading for mobile - VIEW ONLY - HIGH QUALITY + FIXED NAVIGATION
            async function loadPDFInReader(resource, container) {
                container.innerHTML = `
                    <div class="pdf-mobile-viewer">
                        <div class="view-only-notice">
                            <i class="fas fa-eye"></i>
                            <span>View Only - Content cannot be downloaded</span>
                        </div>
                        <!-- PDF CONTENT FIRST -->
                        <div class="pdf-container-mobile">
                            <canvas id="pdf-canvas-mobile"></canvas>
                        </div>
                        <!-- NAVIGATION CONTROLS AT THE BOTTOM -->
                        <div class="pdf-controls-mobile">
                            <button onclick="changePDFPage(-1)" class="pdf-nav-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="pdf-page-info">Page: <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                            <button onclick="changePDFPage(1)" class="pdf-nav-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;

                try {
                    const pdfDoc = await pdfjsLib.getDocument(resource.file_url).promise;
                    let currentPage = 1;
                    let pdfScale = 1.8;
                    
                    document.getElementById('total-pages').textContent = pdfDoc.numPages;
                    
                    function renderPage(pageNum) {
                        pdfDoc.getPage(pageNum).then(page => {
                            const canvas = document.getElementById('pdf-canvas-mobile');
                            const ctx = canvas.getContext('2d');
                            const container = document.querySelector('.pdf-container-mobile');
                            
                            const containerWidth = container.clientWidth - 40;
                            const maxContainerHeight = window.innerHeight * 0.7;
                            
                            const viewport = page.getViewport({ scale: 1 });
                            
                            const scaleX = containerWidth / viewport.width;
                            const scaleY = maxContainerHeight / viewport.height;
                            const optimalScale = Math.min(scaleX, scaleY, pdfScale) * (window.devicePixelRatio || 1);
                            
                            const scaledViewport = page.getViewport({ scale: optimalScale });
                            
                            canvas.width = scaledViewport.width;
                            canvas.height = scaledViewport.height;
                            
                            canvas.style.width = (scaledViewport.width / (window.devicePixelRatio || 1)) + 'px';
                            canvas.style.height = (scaledViewport.height / (window.devicePixelRatio || 1)) + 'px';
                            
                            const renderContext = {
                                canvasContext: ctx,
                                viewport: scaledViewport,
                                enableWebGL: true,
                                intent: 'display',
                                renderInteractiveForms: false,
                                imageLayer: false
                            };
                            
                            page.render(renderContext).promise.then(() => {
                                document.getElementById('current-page').textContent = pageNum;
                            });
                        }).catch(error => {
                            console.error('Error rendering page:', error);
                            container.innerHTML = `
                                <div class="error-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Failed to render PDF page</h3>
                                    <p>${error.message}</p>
                                </div>
                            `;
                        });
                    }
                    
                    window.changePDFPage = function(delta) {
                        const newPage = currentPage + delta;
                        if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                            currentPage = newPage;
                            renderPage(currentPage);
                        }
                    };
                    
                    window.zoomPDF = function(zoomIn) {
                        if (zoomIn) {
                            pdfScale = Math.min(pdfScale + 0.25, 3.0);
                        } else {
                            pdfScale = Math.max(pdfScale - 0.25, 0.5);
                        }
                        renderPage(currentPage);
                    };
                    
                    renderPage(currentPage);
                    
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'ArrowLeft') {
                            changePDFPage(-1);
                        } else if (e.key === 'ArrowRight') {
                            changePDFPage(1);
                        } else if (e.key === '+' || e.key === '=') {
                            zoomPDF(true);
                        } else if (e.key === '-' || e.key === '_') {
                            zoomPDF(false);
                        }
                    });
                    
                } catch (error) {
                    console.error('PDF loading error:', error);
                    container.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Failed to load PDF</h3>
                            <p>${error.message}</p>
                            <p class="view-only-message">This resource is view-only and cannot be downloaded.</p>
                            <button onclick="window.open('${resource.file_url}', '_blank')" class="profile-button" style="margin-top: 15px;">
                                <i class="fas fa-external-link-alt"></i> Open in New Tab
                            </button>
                        </div>
                    `;
                }
            }

            // Office files viewer - VIEW ONLY
            function loadOfficeInReader(resource, container) {
                container.innerHTML = `
                    <div class="office-viewer">
                        <div class="view-only-notice">
                            <i class="fas fa-eye"></i>
                            <span>View Only - Content cannot be downloaded</span>
                        </div>
                        <div class="viewer-message">
                            <i class="fas fa-file-word" style="font-size: 3rem; color: #1D4ED8; margin-bottom: 15px;"></i>
                            <h3>Office Document</h3>
                            <p>This document can be viewed using the online Office viewer.</p>
                            <div class="viewer-actions">
                                <button onclick="window.open('https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(resource.file_url)}', '_blank')" class="profile-button primary">
                                    <i class="fas fa-external-link-alt"></i> Open Online Viewer
                                </button>
                            </div>
                            <p class="view-only-message">This resource is view-only and cannot be downloaded.</p>
                        </div>
                    </div>
                `;
            }

            // Video viewer - VIEW ONLY
            function loadVideoInReader(resource, container) {
                container.innerHTML = `
                    <div class="video-viewer">
                        <div class="view-only-notice">
                            <i class="fas fa-eye"></i>
                            <span>View Only - Content cannot be downloaded</span>
                        </div>
                        <video controls style="width: 100%; max-height: 70vh; border-radius: 8px;">
                            <source src="${resource.file_url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <p class="view-only-message" style="text-align: center; margin-top: 15px; color: #6B7280;">
                            <i class="fas fa-info-circle"></i> This video is view-only and cannot be downloaded.
                        </p>
                    </div>
                `;
            }

            // Fallback viewer for unsupported files - VIEW ONLY
            function loadFallbackView(resource, container) {
                container.innerHTML = `
                    <div class="fallback-viewer">
                        <div class="view-only-notice">
                            <i class="fas fa-eye"></i>
                            <span>View Only - Content cannot be downloaded</span>
                        </div>
                        <div class="viewer-message">
                            <i class="fas fa-file" style="font-size: 3rem; color: #6B7280; margin-bottom: 15px;"></i>
                            <h3>File Preview Not Available</h3>
                            <p>This file type cannot be previewed in the browser.</p>
                            <p class="view-only-message">This resource is view-only and cannot be downloaded.</p>
                        </div>
                    </div>
                `;
            }

            // Set up event listeners for resources
            document.getElementById('resource-search').addEventListener('input', filterResources);
            document.getElementById('resource-filter').addEventListener('change', filterResources);
            document.getElementById('course-filter').addEventListener('change', filterResources);

            // *************************************************************************
            // *** ACADEMIC CALENDAR ***
            // *************************************************************************
            
            async function fetchAllScheduleData() {
                if (!currentUserProfile || !currentUserProfile.program && !currentUserProfile.department || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId); 
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const block = currentUserProfile?.block;
                const intakeYear = currentUserProfile?.intake_year;
            
                if (!program || !block || !intakeYear) return [];
            
                const sessionsPromise = Promise.resolve([]); 
                const examsPromise = Promise.resolve(cachedExams.map(e => ({
                    date: e.exam_date,
                    title: e.exam_name,
                    type: 'Exam',
                    details: `${e.status || 'Scheduled'} - Block ${e.block_term}`
                })));
            
                const eventsPromise = sb
                    .from('calendar_events')
                    .select('event_name, event_date, type, description, target_program, target_block, target_intake_year')
                    .or(`target_program.eq.${program},target_program.eq.General`)
                    .or(`target_block.eq.${block},target_block.is.null`)
                    .eq('target_intake_year', intakeYear)
                    .then(({ data, error }) => {
                        if (error) { console.error("Events error:", error); return []; }
                        return (data || []).map(e => ({
                            date: e.event_date,
                            title: e.event_name,
                            type: e.type,
                            details: e.description
                        }));
                    });
            
                const results = await Promise.all([sessionsPromise, examsPromise, eventsPromise]);
                return results.flat();
            }
            
            async function loadAcademicCalendar() {
                const tableBody = document.getElementById('calendar-table');
                if (!tableBody) return;
                AppUtils.showLoading(tableBody, 'Loading academic schedule...');
            
                try {
                    const allEvents = await fetchAllScheduleData();
                    const filterType = document.getElementById('calendar-filter').value;
            
                    const filteredEvents = allEvents
                        .filter(e => filterType === 'all' || e.type === filterType)
                        .sort((a, b) => new Date(a.date) - new Date(b.date)); 
            
                    tableBody.innerHTML = '';
            
                    if (filteredEvents.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="3">No scheduled events found for the selected filter (${filterType}).</td></tr>`;
                        return;
                    }
            
                    filteredEvents.forEach(event => {
                        const dateStr = new Date(event.date).toLocaleString();
                        const row = `
                            <tr>
                                <td class="date-col">${dateStr}</td>
                                <td>${escapeHtml(event.title)} (${escapeHtml(event.details)})</td>
                                <td class="session-type-col ${event.type}">${event.type}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
            
                } catch (error) {
                    console.error("Failed to load academic calendar:", error);
                    AppUtils.showError(tableBody, 'Error loading calendar data.');
                }
            }
            
            // *************************************************************************
            // *** MESSAGES SYSTEM ***
            // *************************************************************************
            
            async function loadStudentMessagesAndAnnouncements() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department)) {
                    await loadProfile(currentUserId);
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const messageContainer = document.getElementById('messages-list');
                if (!messageContainer) return;
            
                AppUtils.showLoading(messageContainer, 'Loading messages...');
            
                try {
                    // Load personal messages
                    const { data: personalMessages, error: personalError } = await sb
                        .from('student_messages')
                        .select('*')
                        .or(`recipient_id.eq.${currentUserId},recipient_program.eq.${program}`)
                        .order('created_at', { ascending: false });
            
                    if (personalError) throw personalError;
            
                    // Load official announcements
                    const { data: notifications, error: notifError } = await sb
                        .from('notifications')
                        .select('*')
                        .or(`target_program.eq.${program},target_program.is.null`)
                        .order('created_at', { ascending: false });
            
                    if (notifError) throw notifError;
            
                    // Combine messages, with personal messages first
                    const allMessages = [
                        ...(personalMessages || []).map(m => ({ ...m, type: 'Personal' })),
                        ...(notifications || []).map(n => ({ ...n, type: 'Announcement' }))
                    ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
                    messageContainer.innerHTML = '';
                    if (allMessages.length === 0) {
                        messageContainer.innerHTML = '<p>No messages or announcements at this time.</p>';
                        return;
                    }
            
                    // Render each message/announcement
                    allMessages.forEach(msg => {
                        const title = msg.subject || msg.title || 'Message';
                        const body = msg.body || msg.message || msg.message_content || '';
                        const isRead = msg.is_read ? 'read' : 'unread';
                        const createdAt = msg.created_at ? new Date(msg.created_at).toLocaleDateString() : '';
                        const borderColor = msg.type === 'Personal' ? '#4C1D95' : '#F97316';
                        const statusColor = msg.is_read ? '#10B981' : '#F59E0B';
            
                        messageContainer.innerHTML += `
                            <div class="message-item ${isRead}" style="border-left: 4px solid ${borderColor}; padding: 15px; margin-bottom: 10px; background-color: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div class="message-header" style="display: flex; justify-content: space-between; font-weight: bold; color: #4C1D95;">
                                    <span class="message-title">${escapeHtml(title)}</span>
                                    <span class="message-date" style="font-weight: normal; color: #6B7280;">${createdAt}</span>
                                </div>
                                <div class="message-body" style="margin-top: 5px; color: #374151;">${escapeHtml(body.substring(0, 300))}${body.length > 300 ? '...' : ''}</div>
                                <span class="message-status" style="font-size: 0.8em; color: ${statusColor}; margin-top: 5px; display: inline-block;">Type: ${msg.type} | Status: ${isRead.toUpperCase()}</span>
                            </div>
                        `;
                    });
            
                } catch (error) {
                    console.error("Failed to load student messages and announcements:", error);
                    AppUtils.showError(messageContainer, 'Error loading messages and announcements.');
                }
            }
            
            // *************************************************************************
            // *** GLOBAL EVENT LISTENERS ***
            // *************************************************************************
            
            document.addEventListener('DOMContentLoaded', async () => {
                // Setup global error handlers
                window.addEventListener('error', (event) => {
                    console.error('Global error:', event.error);
                    AppUtils.showToast('An unexpected error occurred', 'error');
                });
            
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled promise rejection:', event.reason);
                    AppUtils.showToast('An operation failed', 'error');
                });
            
                // Setup event listeners for filters
                const examFilter = document.getElementById('exam-type-filter');
                if (examFilter) {
                    examFilter.addEventListener('change', loadExams);
                }
                
                const sessionType = document.getElementById('session-type');
                if (sessionType) {
                    sessionType.addEventListener('change', updateTargetSelect);
                }
                
                const calendarFilter = document.getElementById('calendar-filter');
                if (calendarFilter) {
                    calendarFilter.addEventListener('change', loadAcademicCalendar);
                }
            });
            
            // Make functions globally available
            window.toggleMenu = toggleMenu;
            window.closeMenu = closeMenu;
            window.showTab = showTab;
            window.logout = logout;
            window.geoCheckIn = geoCheckIn;
            window.updateTargetSelect = updateTargetSelect;
            window.viewProvisionalTranscript = viewProvisionalTranscript;
            window.closeTranscriptModal = closeTranscriptModal;
            window.openResource = openResource;
            window.closeReader = closeReader;
            window.filterResources = filterResources;
            window.changePDFPage = function() {}; // Placeholder
            window.zoomPDF = function() {}; // Placeholder
            window.installPWA = installPWA;
            window.closeInstallPrompt = closeInstallPrompt;
            window.showSystemInfo = showSystemInfo;
            window.closeModal = closeModal;
        }

        // Start application when config is ready
        if (window.APP_CONFIG) {
            initializeApplication();
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                // Give config.js a moment to load
                setTimeout(() => {
                    if (window.APP_CONFIG) {
                        initializeApplication();
                    } else {
                        showConfigurationError();
                    }
                }, 1000);
            });
        }
    </script>

    <!-- Config file generated by GitHub Actions with secrets -->
    <script src="./config.js"></script>
</body>
</html>
