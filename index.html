<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"></noscript>
    
    <style>
        /* Global Reset and Ultra Modern Typography */
        :root {
            --color-dark: #1F2937; /* Deep Charcoal */
            --color-sidebar: #111827; /* Near-black for deep contrast */
            --color-primary: #3B82F6; /* Modern Sky Blue */
            --color-secondary: #059669; /* Success Green */
            --color-background: #F9FAFB; /* Off-white for content */
            --color-card-bg: #FFFFFF;
            --color-text-light: #D1D5DB; /* Light gray for sidebar text */
            --color-text-dark: #374151; /* Dark gray for body text */
            --border-radius: 12px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --color-info: #FBBF24; /* Amber for info/warning */
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            -webkit-font-smoothing: antialiased;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 1. Sidebar (Sleek, Dark, High Contrast) */
        .sidebar {
            width: 250px;
            background-color: var(--color-sidebar);
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #374151;
        }
        .sidebar-header img {
            width: 70px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.1));
        }
        .sidebar-header h2 {
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            letter-spacing: 0.5px;
        }
        .nav { 
            list-style: none; padding: 0; flex-grow: 1; 
        }
        .nav a { 
            color: var(--color-text-light); 
            text-decoration: none; 
            padding: 12px 15px; 
            border-radius: var(--border-radius); 
            display: block; 
            transition: all 0.2s ease-in-out; 
            font-weight: 500;
            margin-bottom: 8px;
        }
        .nav a:hover { 
            background-color: #1F2937;
            color: white;
        }
        .nav a.active { 
            background-color: var(--color-primary); 
            color: white; 
            box-shadow: var(--shadow-md);
            font-weight: 600;
        }
        .logout { 
            margin-top: auto; 
            text-align: center; 
            padding-top: 20px;
        }
        .logout a { 
            display: block;
            width: 100%;
            padding: 12px 20px; 
            background-color: #EF4444;
            color: #fff; 
            text-decoration: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .logout a:hover { 
            background-color: #DC2626; 
        }

        /* 2. Main Content Area */
        .main { 
            flex: 1; 
            padding: 40px; 
            overflow-y: auto; 
        }
        header h1 { 
            margin: 0; 
            font-size: 2.5rem; 
            font-weight: 700;
            color: var(--color-dark);
        }
        .subtitle { 
            color: #6B7280; 
            margin-top: 5px;
            margin-bottom: 30px; 
            font-weight: 400;
        }
        
        /* Welcome Message Banner */
        #welcome-banner {
            background-color: #FEF3C7; 
            color: #92400E; 
            border: 1px solid #FCD34D; 
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcome-banner strong {
            font-weight: 700;
            color: #D97706; 
        }
        .info-icon {
            font-size: 1.5rem;
            color: var(--color-info);
        }

        /* 3. Cards (For Dashboard and other areas) */
        .cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .card { 
            background-color: var(--color-card-bg); 
            padding: 25px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            box-shadow: var(--shadow-md); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-left: 5px solid var(--color-primary);
        }
        .card:hover { 
            transform: translateY(-8px); 
            box-shadow: var(--shadow-lg); 
            border-left-color: var(--color-secondary);
        }
        .card h3 { 
            margin-top: 0; 
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-dark);
        }
        .tab-content h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 10px;
        }

        /* 4. Tables */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: var(--color-card-bg); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--shadow-md);
        }
        th, td { 
            padding: 15px 20px; 
            text-align: left; 
            font-size: 0.9rem;
        }
        th { 
            background-color: #F3F4F6;
            color: var(--color-dark);
            font-weight: 600;
            border-bottom: 2px solid #E5E7EB;
        }
        tbody tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        tbody tr:hover { 
            background-color: #E5E7EB;
        }
        td {
            border-bottom: 1px solid #F3F4F6;
        }

        /* 5. Tab Content Management */
        .tab-content { 
            display: none; 
            padding-top: 10px;
        }
        .tab-content.active { 
            display: block; 
        }
        
        /* 6. Check-in Controls */
        .check-in-controls {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-wrap: wrap;
            border-top: 5px solid var(--color-primary);
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .check-in-controls label {
            font-weight: 600;
            color: var(--color-dark);
        }
        .check-in-controls select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #D1D5DB;
            background-color: #fff;
            cursor: pointer;
            font-size: 1rem;
            flex-grow: 1;
            min-width: 200px;
        }
        .check-in-controls button {
            padding: 12px 25px;
            background-color: var(--color-secondary); 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .check-in-controls button:hover:not(:disabled) {
            background-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }
        .check-in-controls button:disabled {
            background-color: #A7F3D0;
            cursor: not-allowed;
            color: #065F46;
        }
        #geo-message {
            margin-top: 5px;
            font-style: italic;
            color: var(--color-text-dark);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            background-color: #F0F4F8;
            font-size: 0.95rem;
        }
        
        /* 7. Enhanced Profile Styling */
        #profile-form {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border-top: 5px solid var(--color-primary);
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        
        .profile-details {
            flex-grow: 1;
        }
        
        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-dark);
        }
        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-field input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .profile-media {
            width: 180px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #passport-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%; 
            object-fit: cover;
            border: 4px solid var(--color-primary);
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .profile-button {
            padding: 12px 25px;
            background-color: var(--color-primary); 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }
        .profile-button:hover {
            background-color: #2563EB;
            transform: translateY(-2px);
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #F3F4F6;
            color: var(--color-dark);
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: #E5E7EB;
        }
        #passport-file-input {
            display: none;
        }
        #profile-status {
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }
        /* End Enhanced Profile Styling */
        
        /* 8. Form Styling (Messages Tab) */
        #message-form {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        #message-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
        }
        #message-form button {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #message-form button:hover {
            background-color: #2563EB;
        }
        #message-status {
            margin-top: 10px;
            font-weight: 500;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 20px 0;
                height: auto;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                margin-top: 10px;
            }
            .nav li {
                width: 30%;
                margin: 5px 0;
            }
            .nav a {
                text-align: center;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .main {
                padding: 20px;
            }
            .cards {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .control-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .check-in-controls select {
                width: 100%;
                min-width: unset;
            }
            /* Profile adjustments for mobile */
            #profile-form {
                flex-direction: column;
                padding: 20px;
            }
            .profile-media {
                width: 100%;
                order: -1; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">Dashboard</a></li>
                <li><a href="#" data-tab="profile">Profile</a></li>
                <li><a href="#" data-tab="courses">My Courses</a></li>
                <li><a href="#" data-tab="attendance">Attendance</a></li>
                <li><a href="#" data-tab="cats">CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">Resources</a></li>
                <li><a href="#" data-tab="messages">Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Student!</h1>
                <p class="subtitle">Access your learning tools and updates</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-banner">
                    <span class="info-icon">&#x2139;</span>
                    <strong>ADMIN MESSAGE:</strong> 
                    <span id="admin-welcome-message">Loading message...</span>
                </div>
                
                <h2 style="margin-top: 30px;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-primary);" id="dashboard-attendance-rate">--%</p>
                        <small>Last 30 days</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-secondary);" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-info);" id="dashboard-new-resources">0</p>
                        <small>Last updated week</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #FBBF24; cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for Anatomy 101.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #FBBF24;">View Resources</button>
                    </div>
                </div>
            </section>
            <section id="profile" class="tab-content">
                <h2>My Profile & Account</h2>
                <form id="profile-form">
                    
                    <div class="profile-media">
                        <img id="passport-preview" src="images/placeholder_passport.jpg" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png">
                        <label for="passport-file-input" class="file-upload-label">Upload New Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" required>
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" disabled>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone">
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" disabled>
                        </div>
                        <button type="submit" class="profile-button">Update Profile Details</button>
                        <p id="profile-status"></p>
                    </div>
                </form>
            </section>

            <section id="courses" class="tab-content">
                <h2>My Courses (Real-Time)</h2>
                <table>
                    <thead><tr><th>Course Name</th><th>Status</th></tr></thead>
                    <tbody id="courses-table">
                        <tr><td colspan="2">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2>Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Rotation</option>
                            <option value="Class">Class Session</option>
                            <option value="Call">On Call</option>
                            <option value="Virtual">Virtual Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Rotation/Course:</label>
                        <select id="attendance-target">
                            <option>Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Select a Session Type and then a specific Rotation or Course to check in at your current GPS location and time.</p>
                </div>

                <h2>Past Attendance Records (Old Table)</h2>
                <table>
                    <thead><tr><th>Course/Rotation</th><th>Type</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="attendance-table">
                        <tr><td colspan="4">Loading attendance records...</td></tr>
                    </tbody>
                </table>

                <h3>Geo Attendance History (Check-in Logs)</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Location (Lat, Long)</th><th>Accuracy (m)</th><th>Verified by Admin</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="5">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="cats" class="tab-content">
                <h2>CATS / Exams Schedule</h2>
                <table>
                    <thead><tr><th>Exam Name</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="exams-table">
                        <tr><td colspan="3">Loading exam schedule...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="resources" class="tab-content">
                <h2>Learning Resources (Filtered by Program)</h2>
                <div id="resources-list">Loading resources...</div>
            </section>

            <section id="messages" class="tab-content">
                <h2>Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
                
                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>

    <script>
    // *************************************************************************
    // *** 1. CONFIGURATION: UPDATE THESE VALUES ***
    // *************************************************************************
    
    // ** SUPABASE CONFIGURATION **
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ** LOCATIONIQ CONFIGURATION (Geocoding API) - REPLACE KEY WITH YOUR OWN! **
    // Get a free key from locationiq.com
    const LOCATIONIQ_API_KEY = 'YOUR_LOCATIONIQ_API_KEY_HERE'; // <--- MUST BE REPLACED
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';

    // ** STATIC MOCK DATA (REPLACE WITH REAL SUPABASE TABLES) **
    const MOCK_HOSPITAL_DEPARTMENTS = [
        { id: 1, name: 'Accident & Emergency' },
        { id: 2, name: 'Inpatient Medicine' },
        { id: 3, name: 'Operating Theatres' },
        { id: 4, name: 'Obstetrics and Gynaecology' },
        { id: 5, name: 'Outpatient Clinic' },
    ];

    // ** FALLBACK LOCATION (Used if user denies GPS permission) **
    const FALLBACK_LAT = -1.286389; // Nairobi, Kenya
    const FALLBACK_LON = 36.817223;
    const FALLBACK_ACCURACY = 500; 

    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = []; 

    // DOM Elements
    const geoMessage = document.getElementById('geo-message');
    const checkInButton = document.getElementById('check-in-button');
    const messageForm = document.getElementById('message-form');
    const sessionTypeSelect = document.getElementById('session-type');
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const adminWelcomeMessage = document.getElementById('admin-welcome-message'); 
    const profileForm = document.getElementById('profile-form');
    const passportFileInput = document.getElementById('passport-file-input');
    const passportPreview = document.getElementById('passport-preview');
    const uploadButton = document.getElementById('upload-button');
    const profileStatus = document.getElementById('profile-status');


    // *************************************************************************
    // *** 2. UI AND NAVIGATION LOGIC (Tab Hiding/Showing) ***
    // *************************************************************************
    const navLinks = document.querySelectorAll('.nav a');
    const tabs = document.querySelectorAll('.tab-content');

    function showTab(tabId) {
        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
        if(activeLink) activeLink.classList.add('active');

        tabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if(activeTab) activeTab.classList.add('active');
        
        // Load data specific to the tab being activated
        if (tabId === 'profile' && currentUserId) loadProfile(currentUserId);
        if (tabId === 'attendance' && currentUserId) {
            loadAttendance(currentUserId);
            loadGeoAttendanceHistory(currentUserId);
            updateTargetSelect();
        }
        if (tabId === 'cats' && currentUserId) loadExams();
        if (tabId === 'resources' && currentUserId) loadResources();     
        if (tabId === 'messages' && currentUserId) loadStudentMessages(); 
        if (tabId === 'courses' && currentUserId) loadCourses(); 
        if (tabId === 'dashboard' && currentUserId) {
            loadWelcomeMessage();
            loadDashboardMetrics(currentUserId); 
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            showTab(link.dataset.tab);
        });
    });

    async function logout() {
        sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
        await sb.auth.signOut();
        window.location.href = "login.html"; 
    }

    // *************************************************************************
    // *** 3. CORE DATA FUNCTIONS ***
    // *************************************************************************
    
    async function loadWelcomeMessage() {
        adminWelcomeMessage.textContent = 'Loading message...';
        const { data, error } = await sb
            .from('system_settings')
            .select('setting_value')
            .eq('setting_key', 'welcome_message')
            .single();

        if (error || !data) {
            console.warn("Could not load welcome message:", error);
            adminWelcomeMessage.textContent = 'The system message is currently unavailable. Please check back later.';
            return;
        }

        adminWelcomeMessage.textContent = data.setting_value || 'Welcome to the NCHSM Student Dashboard!';
    }
    
    async function loadDashboardMetrics(userId) {
        // --- 1. Load Active Courses Count ---
        document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;

        // --- 2. Load Attendance Rate (MOCK) ---
        // REPLACE with logic: calculate (Days Present / Total Days) * 100 for last 30 days
        const attendanceRate = '94'; 
        document.getElementById('dashboard-attendance-rate').textContent = `${attendanceRate}%`;

        // --- 3. Load Upcoming Exam (MOCK) ---
        // REPLACE with real query to 'exams' table for nearest date
        const mockExamDate = new Date();
        mockExamDate.setDate(mockExamDate.getDate() + 5); 
        document.getElementById('dashboard-upcoming-exam').textContent = `${mockExamDate.toLocaleDateString()} (Anatomy)`;

        // --- 4. Load New Resources (MOCK) ---
        // REPLACE with real query to 'resources' table
        document.getElementById('dashboard-new-resources').textContent = '3'; 

        // --- 5. Conditional Action Required Section ---
        const actionRequiredEl = document.getElementById('dashboard-actions');
        const actionsTitleEl = document.getElementById('actions-title');
        const passportCard = document.getElementById('action-passport');

        // Check if passport is missing (uses currentUserProfile loaded by loadProfile)
        let profileIncomplete = !currentUserProfile?.passport_url; 
        
        if (profileIncomplete) {
            // Ensure the passport action card is shown if the profile is incomplete
            if (passportCard) passportCard.style.display = 'block'; 
        } else {
            // Hide the passport action card if the profile is complete
            if (passportCard) passportCard.style.display = 'none';
        }

        // Check if any action cards are visible (MOCK: just check the list child count)
        const visibleActions = Array.from(actionRequiredEl.children).filter(el => el.style.display !== 'none');

        if (visibleActions.length > 0) {
             actionsTitleEl.style.display = 'block';
             actionRequiredEl.style.display = 'flex';
        } else {
             actionsTitleEl.style.display = 'none';
             actionRequiredEl.style.display = 'none';
        }
    }


    async function loadProfile(userId) {
        profileStatus.textContent = 'Loading profile data...';
        
        const { data: profile, error: profileError } = await sb
            .from('profiles')
            .select('full_name, email, phone, program_type, passport_url') 
            .eq('id', userId)
            .single();

        if (profileError) {
            console.error("Profile Fetch Error:", profileError);
            profileStatus.textContent = `Error loading profile: ${profileError.message}. Check RLS policy on 'profiles' table.`;
            profileStatus.style.color = 'red';
            return;
        }

        currentUserProfile = profile; 

        const firstName = profile.full_name ? profile.full_name.split(' ')[0] : 'Student';
        document.querySelector('header h1').textContent = `Welcome, ${firstName}!`;
        
        // Populate the form fields
        document.getElementById('profile-name').value = profile.full_name || '';
        document.getElementById('profile-email').value = profile.email || '';
        document.getElementById('profile-phone').value = profile.phone || '';
        document.getElementById('profile-program').value = profile.program_type || '';

        // Load passport image
        const passportUrl = profile.passport_url;
        if (passportUrl) {
            passportPreview.src = passportUrl;
        } else {
            passportPreview.src = 'images/placeholder_passport.jpg';
        }
        
        profileStatus.textContent = 'Profile loaded. Edit details and click "Update Profile Details".';
        profileStatus.style.color = 'var(--color-text-dark)';

        loadAttendance(currentUserId);
        loadGeoAttendanceHistory(currentUserId);
        loadCourses(true); 
    }
    
    // Handle profile detail updates
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        profileStatus.textContent = 'Updating profile...';
        profileStatus.style.color = 'var(--color-primary)';
        
        const newName = document.getElementById('profile-name').value.trim();
        const newPhone = document.getElementById('profile-phone').value.trim();
        
        try {
            const { error } = await sb
                .from('profiles')
                .update({ full_name: newName, phone: newPhone })
                .eq('id', currentUserId);
                
            if (error) throw error;
            
            await loadProfile(currentUserId); 
            profileStatus.textContent = 'Profile details updated successfully!';
            profileStatus.style.color = 'var(--color-secondary)';
            
        } catch (error) {
            console.error('Profile update failed:', error);
            profileStatus.textContent = `Update failed: ${error.message}. Check RLS policy on 'profiles'.`;
            profileStatus.style.color = 'red';
        }
    });
    
    // Handle passport photo preview
    passportFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                passportPreview.src = e.target.result; 
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Handle passport photo upload
    uploadButton.addEventListener('click', async () => {
        const file = passportFileInput.files[0];
        if (!file) {
            profileStatus.textContent = 'Please select a file to upload first.';
            profileStatus.style.color = 'red';
            return;
        }
        
        profileStatus.textContent = 'Uploading photo...';
        profileStatus.style.color = 'var(--color-primary)';
        uploadButton.disabled = true;

        const fileExt = file.name.split('.').pop();
        const filePath = `${currentUserId}/passport_photo.${fileExt}`; 

        try {
            // 1. Upload to Supabase Storage Bucket ('avatars')
            // NOTE: Ensure the 'avatars' bucket exists in Supabase Storage and RLS is set up.
            const { error: uploadError } = await sb.storage
                .from('avatars') 
                .upload(filePath, file, { 
                    cacheControl: '3600', 
                    upsert: true 
                });

            if (uploadError) throw uploadError;
            
            // 2. Get the public URL
            const { data: { publicUrl }, error: urlError } = sb.storage
                .from('avatars')
                .getPublicUrl(filePath);
            
            if (urlError) throw urlError;
            
            // 3. Update the user's profile record with the URL
            const { error: profileUpdateError } = await sb
                .from('profiles')
                .update({ passport_url: publicUrl })
                .eq('id', currentUserId);
            
            if (profileUpdateError) throw profileUpdateError;

            profileStatus.textContent = 'Passport photo uploaded and saved successfully!';
            profileStatus.style.color = 'var(--color-secondary)';
            
        } catch (error) {
            console.error('Photo upload failed:', error);
            profileStatus.textContent = `Photo upload failed: ${error.message}. Check Supabase Storage/RLS settings.`;
            profileStatus.style.color = 'red';
        } finally {
            uploadButton.disabled = false;
        }
    });

    async function loadCourses(cacheOnly = false) {
        const { data, error } = await sb.from('courses').select('course_name, status').limit(10);
        
        if (error) {
            console.error("Courses Fetch Error:", error);
            if (!cacheOnly) {
                document.getElementById('courses-table').innerHTML = `<tr><td colspan="2" style="color: red;">Error loading courses: ${error.message}</td></tr>`;
            }
            return;
        }
        
        cachedCourses = data || [];
        
        if (!cacheOnly) {
            const table = document.getElementById('courses-table');
            table.innerHTML = cachedCourses.map(c => `<tr><td>${c.course_name}</td><td>Active</td></tr>`).join('');
        }
    }

    async function loadAttendance(userId) {
        const { data, error } = await sb
            .from('attendance')
            .select('course_or_rotation, session_type, date, status')
            .eq('student_id', userId) 
            .order('date', { ascending: false }); 

        const table = document.getElementById('attendance-table');
        if (error) {
            console.error("Attendance Fetch Error:", error);
            table.innerHTML = `<tr><td colspan="4" style="color: red;">Error loading attendance history: ${error.message}</td></tr>`;
            return;
        }
        
        table.innerHTML = (data || []).map(a => `
            <tr>
                <td>${a.course_or_rotation || 'N/A'}</td>
                <td>${a.session_type || 'N/A'}</td>
                <td>${a.date ? new Date(a.date).toLocaleDateString() : 'N/A'}</td>
                <td>${a.status || 'Present'}</td>
            </tr>`).join('');
    }
    
    async function loadGeoAttendanceHistory(userId) {
        const { data, error } = await sb
            .from('geo_attendance_logs')
            .select('check_in_time, session_type, latitude, longitude, accuracy_meters, address_snapshot, is_verified')
            .eq('student_id', userId)
            .order('check_in_time', { ascending: false });

        const table = document.getElementById('geo-attendance-history');
        
        if (error) {
            table.innerHTML = `<tr><td colspan="5" style="color: red;">Error loading Geo History: ${error.message}</td></tr>`;
            return;
        }

        table.innerHTML = (data || []).map(a => `
            <tr>
                <td>${new Date(a.check_in_time).toLocaleString()}</td>
                <td>${a.session_type}</td>
                <td><span title="${a.address_snapshot || 'Address N/A'}">${a.latitude.toFixed(6)}, ${a.longitude.toFixed(6)}</span></td>
                <td>${a.accuracy_meters.toFixed(2)}</td>
                <td>${a.is_verified ? 'Yes' : 'No (Pending)'}</td>
            </tr>`).join('');
    }

    // *** PLACEHOLDER FUNCTIONS ***
    async function loadExams() {
        const table = document.getElementById('exams-table');
        table.innerHTML = `<tr><td colspan="3">CATS/Exams data loading...</td></tr>`;
    }

    async function loadResources() {
        const list = document.getElementById('resources-list');
        list.innerHTML = `<p>Loading learning resources...</p>`;
    }

    async function loadStudentMessages() {
        const list = document.getElementById('messages-list');
        list.innerHTML = `<p>Loading your messages...</p>`;
    }


    // *************************************************************************
    // *** 4. GEOLOCATION AND REVERSE GEOCODING LOGIC ***
    // *************************************************************************

    function updateTargetSelect() {
        const sessionType = sessionTypeSelect.value;
        let options = '';
        
        document.getElementById('target-control-group').style.display = (sessionType === 'Call' || sessionType === 'Virtual') ? 'none' : 'flex';
        
        if (sessionType === 'Clinical') {
            document.getElementById('target-label').textContent = 'Clinical Rotation:';
            options = MOCK_HOSPITAL_DEPARTMENTS.map(dept => 
                `<option value="${dept.name}">${dept.name}</option>`
            ).join('');
            
        } else if (sessionType === 'Class') {
            document.getElementById('target-label').textContent = 'Course Session:';
            
            options = cachedCourses.map(course => 
                `<option value="${course.course_name}">${course.course_name}</option>`
            ).join('');
            
        } else {
            attendanceTargetSelect.innerHTML = `<option value="${sessionType}">- N/A -</option>`;
            return;
        }

        attendanceTargetSelect.innerHTML = options || '<option value="">No options available</option>';
    }

    /**
     * Attempts to get high-accuracy GPS location. Falls back to a default location on failure.
     */
    async function getLocationAndAddress() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                geoMessage.textContent = 'Geolocation not supported. Using fallback coordinates.';
                return resolve({ 
                    latitude: FALLBACK_LAT, 
                    longitude: FALLBACK_LON, 
                    accuracy_meters: FALLBACK_ACCURACY 
                });
            }
            
            geoMessage.textContent = 'Requesting high-accuracy location... Please grant permission.';

            // Real Geolocation API call with options for high accuracy
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    geoMessage.textContent = `Location acquired. Accuracy: ${position.coords.accuracy.toFixed(2)} meters.`;
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy_meters: position.coords.accuracy
                    });
                },
                (error) => {
                    console.warn(`Geolocation failed (${error.code}:${error.message}). Using fallback coordinates.`);
                    geoMessage.textContent = `Location denied or failed. Using fallback location (Accuracy: ${FALLBACK_ACCURACY}m).`;
                    
                    // Fallback on permission denial or timeout
                    resolve({ 
                        latitude: FALLBACK_LAT, 
                        longitude: FALLBACK_LON, 
                        accuracy_meters: FALLBACK_ACCURACY 
                    });
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        });
    }

    /**
     * Calls the LocationIQ API to get a human-readable address.
     */
    async function reverseGeocode(lat, lon) {
        if (LOCATIONIQ_API_KEY === 'YOUR_LOCATIONIQ_API_KEY_HERE') {
             console.warn("LocationIQ API key is not set. Using mock address.");
             return `[MOCK ADDRESS]: Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        }
        
        const url = `${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${lat}&lon=${lon}&format=json`;
        
        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                console.error(`Geocoding API error: ${response.statusText}. Check API key or daily limits.`);
                return `Geocoding failed (Status: ${response.status}).`;
            }
            
            const data = await response.json();
            
            // LocationIQ returns 'display_name'
            return data.display_name || `Location N/A (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;
            
        } catch (e) {
            console.error('Reverse geocoding fetch error:', e);
            return `Geocoding failed due to network error.`;
        }
    }

    async function geoCheckIn() {
        if (!currentUserId) {
            geoMessage.textContent = 'Error: Please log in again.';
            geoMessage.style.color = '#EF4444';
            return;
        }

        const selectedSessionType = sessionTypeSelect.value;
        let selectedTarget = attendanceTargetSelect.value;
        
        if (selectedSessionType === 'Call' || selectedSessionType === 'Virtual') {
            selectedTarget = selectedSessionType;
        }
        
        if (!selectedTarget || selectedTarget === 'No options available' || selectedTarget === 'Select Session Type first...') {
            geoMessage.textContent = 'Please select a specific Rotation/Course before checking in.';
            geoMessage.style.color = '#EF4444';
            return;
        }

        const submissionTime = new Date().toISOString(); 
        geoMessage.textContent = `Acquiring GPS location for ${selectedTarget} at current time...`;

        geoMessage.style.color = 'var(--color-primary)';
        checkInButton.disabled = true;

        try {
            const { latitude, longitude, accuracy_meters } = await getLocationAndAddress(); 
            
            geoMessage.textContent = `Location acquired. Looking up address...`;

            const address = await reverseGeocode(latitude, longitude); 
            
            geoMessage.textContent = `Submitting record for ${selectedTarget} at ${address}...`;

            // 1. Insert into the geo_attendance_logs table
            const { error: geoError } = await sb
                .from('geo_attendance_logs')
                .insert({
                    student_id: currentUserId,
                    session_type: selectedSessionType,
                    check_in_time: submissionTime, 
                    latitude: latitude,
                    longitude: longitude,
                    accuracy_meters: accuracy_meters,
                    address_snapshot: address,
                    is_verified: false
                });

            // 2. Insert/Update the main attendance table
            const { error: attendanceError } = await sb
                .from('attendance')
                .insert({
                    student_id: currentUserId,
                    course_or_rotation: selectedTarget,
                    session_type: selectedSessionType,
                    status: 'Present' 
                });


            if (geoError || attendanceError) throw new Error(geoError?.message || attendanceError?.message);

            geoMessage.textContent = 'Check-in successful! Record submitted for administration review.';
            geoMessage.style.color = 'var(--color-secondary)';
            loadGeoAttendanceHistory(currentUserId);
            loadAttendance(currentUserId);

        } catch (error) {
            console.error('Check-in failed:', error);
            geoMessage.textContent = `Check-in failed: ${error.message}. Please check console for RLS/Schema errors.`;
            geoMessage.style.color = '#EF4444';
        } finally {
            checkInButton.disabled = false;
        }
    }
    
    // *************************************************************************
    // *** 5. INITIALIZATION ***
    // *************************************************************************

    async function initialize() {
        const { data: { user }, error } = await sb.auth.getUser();

        if (error || !user) {
            window.location.href = "login.html";
            return;
        }

        currentUserId = user.id;
        
        // Load initial data and cache courses first
        await loadCourses(true);
        // Load profile next, which populates user details and then calls: loadAttendance/loadGeoAttendanceHistory
        await loadProfile(currentUserId); 
        
        // Final dashboard content based on loaded profile/courses
        updateTargetSelect();
        loadWelcomeMessage(); 
        loadDashboardMetrics(currentUserId); 
    }
    
    // Set up message form submit listener 
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageBody = document.getElementById('student-message-body').value;
        const statusEl = document.getElementById('message-status');

        if (!messageBody) {
            statusEl.textContent = 'Message cannot be empty.';
            statusEl.style.color = '#EF4444';
            return;
        }

        try {
            const { error } = await sb.from('student_messages').insert([
                { 
                    sender_id: currentUserId, 
                    body: messageBody,
                }
            ]);

            if (error) throw error;

            statusEl.textContent = 'Message sent successfully! The admin will review it shortly.';
            statusEl.style.color = 'var(--color-secondary)';
            messageForm.reset();
            loadStudentMessages(); 
        } catch (error) {
            console.error('Message submission failed:', error);
            statusEl.textContent = `Failed to send message: ${error.message}`;
            statusEl.style.color = '#EF4444';
        }
    });

    initialize();
    </script>
</body>
</html>
