<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"></noscript>
    
    <style>
        /* Global Reset and Ultra Modern Typography */
        :root {
            --color-dark: #1F2937; /* Deep Charcoal */
            --color-sidebar: #111827; /* Near-black for deep contrast */
            --color-primary: #3B82F6; /* Modern Sky Blue */
            --color-secondary: #059669; /* Success Green */
            --color-background: #F9FAFB; /* Off-white for content */
            --color-card-bg: #FFFFFF;
            --color-text-light: #D1D5DB; /* Light gray for sidebar text */
            --color-text-dark: #374151; /* Dark gray for body text */
            --border-radius: 12px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --color-info: #FBBF24; /* Amber for info/warning */
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            -webkit-font-smoothing: antialiased;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 1. Sidebar (Sleek, Dark, High Contrast) */
        .sidebar {
            width: 250px;
            background-color: var(--color-sidebar);
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #374151;
        }
        .sidebar-header img {
            width: 70px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.1));
        }
        .sidebar-header h2 {
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            letter-spacing: 0.5px;
        }
        .nav { 
            list-style: none; padding: 0; flex-grow: 1; 
        }
        .nav a { 
            color: var(--color-text-light); 
            text-decoration: none; 
            padding: 12px 15px; 
            border-radius: var(--border-radius); 
            display: block; 
            transition: all 0.2s ease-in-out; 
            font-weight: 500;
            margin-bottom: 8px;
        }
        .nav a:hover { 
            background-color: #1F2937;
            color: white;
        }
        .nav a.active { 
            background-color: var(--color-primary); 
            color: white; 
            box-shadow: var(--shadow-md);
            font-weight: 600;
        }
        .logout { 
            margin-top: auto; 
            text-align: center; 
            padding-top: 20px;
        }
        .logout a { 
            display: block;
            width: 100%;
            padding: 12px 20px; 
            background-color: #EF4444;
            color: #fff; 
            text-decoration: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .logout a:hover { 
            background-color: #DC2626; 
        }

        /* 2. Main Content Area */
        .main { 
            flex: 1; 
            padding: 40px; 
            overflow-y: auto; 
        }
        header h1 { 
            margin: 0; 
            font-size: 2.5rem; 
            font-weight: 700;
            color: var(--color-dark);
        }
        .subtitle { 
            color: #6B7280; 
            margin-top: 5px;
            margin-bottom: 30px; 
            font-weight: 400;
        }
        
        /* Welcome Message Banner */
        #welcome-banner {
            background-color: #FEF3C7; 
            color: #92400E; 
            border: 1px solid #FCD34D; 
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcome-banner strong {
            font-weight: 700;
            color: #D97706; 
        }
        .info-icon {
            font-size: 1.5rem;
            color: var(--color-info);
        }

        /* 3. Cards (For Dashboard and other areas) */
        .cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .card { 
            background-color: var(--color-card-bg); 
            padding: 25px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            box-shadow: var(--shadow-md); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-left: 5px solid var(--color-primary);
        }
        .card:hover { 
            transform: translateY(-8px); 
            box-shadow: var(--shadow-lg); 
            border-left-color: var(--color-secondary);
        }
        .card h3 { 
            margin-top: 0; 
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-dark);
        }
        .tab-content h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 10px;
        }

        /* 4. Tables */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: var(--color-card-bg); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--shadow-md);
        }
        th, td { 
            padding: 15px 20px; 
            text-align: left; 
            font-size: 0.9rem;
        }
        th { 
            background-color: #F3F4F6;
            color: var(--color-dark);
            font-weight: 600;
            border-bottom: 2px solid #E5E7EB;
        }
        tbody tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        tbody tr:hover { 
            background-color: #E5E7EB;
        }
        td {
            border-bottom: 1px solid #F3F4F6;
        }

        /* 5. Tab Content Management */
        .tab-content { 
            display: none; 
            padding-top: 10px;
        }
        .tab-content.active { 
            display: block; 
        }
        
        /* 6. Check-in Controls */
        .check-in-controls {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border-top: 5px solid var(--color-primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .check-in-controls label {
            font-weight: 600;
            color: var(--color-dark);
        }
        .check-in-controls select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #D1D5DB;
            background-color: #fff;
            cursor: pointer;
            font-size: 1rem;
            flex-grow: 1;
            min-width: 200px;
        }
        .check-in-controls button {
            padding: 12px 25px;
            background-color: var(--color-secondary); 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .check-in-controls button:hover:not(:disabled) {
            background-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }
        .check-in-controls button:disabled {
            background-color: #A7F3D0;
            cursor: not-allowed;
            color: #065F46;
        }
        #geo-message {
            margin-top: 5px;
            font-style: italic;
            color: var(--color-text-dark);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            background-color: #F0F4F8;
            font-size: 0.95rem;
        }
        
        /* 7. Enhanced Profile Styling */
        #profile-form {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border-top: 5px solid var(--color-primary);
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        
        .profile-details {
            flex-grow: 1;
        }
        
        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-dark);
        }
        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }
        /* Style for read-only fields */
        .form-field input[readonly] {
            background-color: var(--color-background); /* Lighter background for non-editable state */
            border-color: #E5E7EB;
            cursor: default;
        }
        .form-field input:not([readonly]):focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .profile-media {
            width: 180px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #passport-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%; 
            object-fit: cover;
            border: 4px solid var(--color-primary);
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .profile-button {
            padding: 12px 25px;
            background-color: var(--color-primary); 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }
        .profile-button:hover {
            background-color: #2563EB;
            transform: translateY(-2px);
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #F3F4F6;
            color: var(--color-dark);
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: #E5E7EB;
        }
        #passport-file-input {
            display: none;
        }
        #profile-status {
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }
        /* End Enhanced Profile Styling */
        
        /* 8. Form Styling (Messages Tab) */
        #message-form {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        #message-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
        }
        #message-form button {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #message-form button:hover {
            background-color: #2563EB;
        }
        #message-status {
            margin-top: 10px;
            font-weight: 500;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 20px 0;
                height: auto;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                margin-top: 10px;
            }
            .nav li {
                width: 30%;
                margin: 5px 0;
            }
            .nav a {
                text-align: center;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .main {
                padding: 20px;
            }
            .cards {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .control-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .check-in-controls select {
                width: 100%;
                min-width: unset;
            }
            /* Profile adjustments for mobile */
            #profile-form {
                flex-direction: column;
                padding: 20px;
            }
            .profile-media {
                width: 100%;
                order: -1; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">Dashboard</a></li>
                <li><a href="#" data-tab="profile">Profile</a></li>
                <li><a href="#" data-tab="courses">My Courses</a></li>
                <li><a href="#" data-tab="attendance">Attendance</a></li>
                <li><a href="#" data-tab="cats">CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">Resources</a></li>
                <li><a href="#" data-tab="messages">Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Student!</h1>
                <p class="subtitle">Access your learning tools and updates</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-banner">
                    <span class="info-icon">&#x2139;</span>
                    <strong>ADMIN MESSAGE:</strong> 
                    <span id="admin-welcome-message">Loading message...</span>
                </div>
                
                <h2 style="margin-top: 30px;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-primary);" id="dashboard-attendance-rate">--%</p>
                        <small>Last 30 days</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-secondary);" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-info);" id="dashboard-new-resources">0</p>
                        <small>Last updated week</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #FBBF24; cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for Anatomy 101.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #FBBF24;">View Resources</button>
                    </div>
                </div>
            </section>
            
            <section id="profile" class="tab-content">
                <h2>My Profile & Account</h2>
                <form id="profile-form">
                    
                    <div class="profile-media">
                        <img id="passport-preview" src="https://via.placeholder.com/150x150?text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        
                        <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                        
                        <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>

                        <p id="profile-status"></p>
                    </div>
                </form>
            </section>
            <section id="courses" class="tab-content">
                <h2>My Courses (Real-Time)</h2>
                <table>
                    <thead><tr><th>Course Name</th><th>Status</th></tr></thead>
                    <tbody id="courses-table">
                        <tr><td colspan="2">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2>Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Rotation</option>
                            <option value="Class">Class Session</option>
                            <option value="Call">On Call</option>
                            <option value="Virtual">Virtual Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Rotation/Course:</label>
                        <select id="attendance-target">
                            <option>Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Select a Session Type and then a specific Rotation or Course to check in at your current GPS location and time.</p>
                </div>

                <h2>Past Attendance Records (Old Table)</h2>
                <table>
                    <thead><tr><th>Course/Rotation</th><th>Type</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="attendance-table">
                        <tr><td colspan="4">Loading attendance records...</td></tr>
                    </tbody>
                </table>

                <h3>Geo Attendance History (Check-in Logs)</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Location (Friendly Name)</th><th>Accuracy (m)</th><th>Verified by Admin</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="5">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="cats" class="tab-content">
                <h2>CATS / Exams Schedule</h2>
                <table>
                    <thead><tr><th>Exam Name</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="exams-table">
                        <tr><td colspan="3">Loading exam schedule...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="resources" class="tab-content">
                <h2>Learning Resources (Filtered by Program)</h2>
                <div id="resources-list">Loading resources...</div>
            </section>

            <section id="messages" class="tab-content">
                <h2>Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
                
                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>

    <script>
    // *************************************************************************
    // *** 1. CONFIGURATION: UPDATE THESE VALUES ***
    // *************************************************************************
    
    // ** SUPABASE CONFIGURATION **
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ** LOCATIONIQ CONFIGURATION (Geocoding API) **
    const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c'; // <--- API KEY INJECTED
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';

    // ** STATIC MOCK DATA (REPLACE WITH REAL SUPABASE TABLES) **
    const MOCK_HOSPITAL_DEPARTMENTS = [
        { id: '1', name: 'Accident & Emergency' },
        { id: '2', name: 'Inpatient Medicine' },
        { id: '3', name: 'Operating Theatres' },
        { id: '4', name: 'Obstetrics and Gynaecology' },
        { id: '5', name: 'Outpatient Clinic' },
    ];
    // Mock courses, using UUIDs for safety
    const MOCK_COURSES = [
        { id: '1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d', name: 'Anatomy 101' },
        { id: '2b3c4d5e-6f7a-8b9c-0d1e-2f3a4b5c6d7e', name: 'Physiology 101' },
        { id: '3c4d5e6f-7a8b-9c0d-1e2f-3a4b5c6d7e8f', name: 'Clinical Skills' },
    ];

    // ** FALLBACK LOCATION (Used if user denies GPS permission) **
    const FALLBACK_LAT = -1.286389; // Nairobi, Kenya
    const FALLBACK_LON = 36.817223;
    const FALLBACK_ACCURACY = 500; 

    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = MOCK_COURSES; // Using mock courses for target selection

    // DOM Elements
    const geoMessage = document.getElementById('geo-message');
    const checkInButton = document.getElementById('check-in-button');
    const messageForm = document.getElementById('message-form');
    const sessionTypeSelect = document.getElementById('session-type');
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const adminWelcomeMessage = document.getElementById('admin-welcome-message'); 
    const profileForm = document.getElementById('profile-form');
    const passportFileInput = document.getElementById('passport-file-input');
    const passportPreview = document.getElementById('passport-preview');
    const uploadButton = document.getElementById('upload-button');
    const profileStatus = document.getElementById('profile-status');

    // NEW DOM Elements for Profile Logic
    const editProfileButton = document.getElementById('edit-profile-button');
    const saveProfileButton = document.getElementById('save-profile-button');
    const uploadLabel = document.getElementById('upload-label');
    

    // *************************************************************************
    // *** 2. UI AND NAVIGATION LOGIC (Tab Hiding/Showing) ***
    // *************************************************************************
    const navLinks = document.querySelectorAll('.nav a');
    const tabs = document.querySelectorAll('.tab-content');

    function showTab(tabId) {
        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
        if(activeLink) activeLink.classList.add('active');

        tabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if(activeTab) activeTab.classList.add('active');
        
        // Load data specific to the tab being activated
        if (tabId === 'profile' && currentUserId) loadProfile(currentUserId);
        if (tabId === 'attendance' && currentUserId) {
            loadAttendance(currentUserId);
            loadGeoAttendanceHistory(currentUserId); // FIX: Ensure this is called
            updateTargetSelect();
        }
        if (tabId === 'cats' && currentUserId) loadExams();
        if (tabId === 'resources' && currentUserId) loadResources();     
        if (tabId === 'messages' && currentUserId) loadStudentMessages(); 
        if (tabId === 'courses' && currentUserId) loadCourses(); 
        if (tabId === 'dashboard' && currentUserId) {
            loadWelcomeMessage();
            loadDashboardMetrics(currentUserId); 
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            showTab(link.dataset.tab);
        });
    });

    async function logout() {
        sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
        await sb.auth.signOut();
        window.location.href = "login.html"; 
    }

    // *************************************************************************
    // *** 3. CORE DATA AND DASHBOARD FUNCTIONS ***
    // *************************************************************************
    
    async function loadWelcomeMessage() {
        adminWelcomeMessage.textContent = 'Loading message...';
        // This is the key: it pulls the message updated by the Superadmin
        const { data, error } = await sb
            .from('system_settings')
            .select('setting_value')
            .eq('setting_key', 'welcome_message')
            .single();

        if (error || !data) {
            console.warn("Could not load welcome message:", error);
            adminWelcomeMessage.textContent = 'The system message is currently unavailable. Please check back later.';
            return;
        }

        adminWelcomeMessage.textContent = data.setting_value || 'Welcome to the NCHSM Student Dashboard!';
    }
    
    async function loadDashboardMetrics(userId) {
        // --- 1. Load Active Courses Count ---
        document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;

        // --- 2. Load Attendance Rate (MOCK) ---
        // TODO: Replace with real calculation using a PostgreSQL function
        const attendanceRate = '94'; 
        document.getElementById('dashboard-attendance-rate').textContent = `${attendanceRate}%`;

        // --- 3. Load Upcoming Exam (MOCK) ---
        // TODO: Replace with real query to 'exams' table for nearest date
        const mockExamDate = new Date();
        mockExamDate.setDate(mockExamDate.getDate() + 5); 
        document.getElementById('dashboard-upcoming-exam').textContent = `${mockExamDate.toLocaleDateString()} (Anatomy)`;

        // --- 4. Load New Resources (MOCK) ---
        // TODO: Replace with real query to 'resources' table
        document.getElementById('dashboard-new-resources').textContent = '3'; 

        // --- 5. Conditional Action Required Section ---
        const actionRequiredEl = document.getElementById('dashboard-actions');
        const actionsTitleEl = document.getElementById('actions-title');
        const passportCard = document.getElementById('action-passport');

        // Check if passport is missing
        let profileIncomplete = !currentUserProfile?.passport_url; 
        
        // Hide/Show Passport Action Card
        passportCard.style.display = profileIncomplete ? 'block' : 'none';
        
        // Hide/Show 'Action Required' title if no actions
        if (!profileIncomplete) {
             actionsTitleEl.style.display = 'none';
             actionRequiredEl.style.display = 'none';
        } else {
             actionsTitleEl.style.display = 'block';
             actionRequiredEl.style.display = 'flex';
        }
    }
    
    // --- REMAINDER OF JAVASCRIPT CODE ---

    // *************************************************************************
    // *** 4. AUTHENTICATION AND PROFILE MANAGEMENT ***
    // *************************************************************************

    async function checkAuthAndLoad() {
        const { data: { user } } = await sb.auth.getUser();

        if (user) {
            currentUserId = user.id;
            // Load user profile and initial dashboard data
            await loadProfile(currentUserId); 
            showTab('dashboard');
        } else {
            // No user, redirect to login page
            window.location.href = 'login.html'; 
        }
    }

    async function loadProfile(userId) {
        profileStatus.textContent = 'Loading profile...';
        
        const { data: profile, error } = await sb
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();

        if (error) {
            console.error('Error loading profile:', error);
            profileStatus.textContent = 'Error loading profile details.';
            return;
        }

        currentUserProfile = profile;
        document.getElementById('profile-name').value = profile.full_name || 'N/A';
        document.getElementById('profile-email').value = profile.email || 'N/A';
        document.getElementById('profile-phone').value = profile.phone || 'N/A';
        document.getElementById('profile-program').value = profile.program_name || 'N/A';
        
        document.getElementById('passport-preview').src = profile.passport_url 
            ? sb.storage.from('passports').getPublicUrl(profile.passport_url).data.publicUrl
            : 'https://via.placeholder.com/150x150?text=NO+PHOTO';
        
        document.getElementById('passport-preview').alt = profile.full_name || 'Passport Photo';

        // Update welcome message on the header
        document.querySelector('header h1').textContent = `Welcome, ${profile.first_name || 'Student'}!`;

        profileStatus.textContent = '';
        toggleProfileEdit(false); // Reset to read-only state
        // Show upload elements if not complete
        if (!profile.passport_url) {
            uploadLabel.style.display = 'inline-block';
            passportFileInput.style.display = 'none'; // Still hidden, triggered by label
        }
    }
    
    function toggleProfileEdit(enable) {
        const fields = ['profile-name', 'profile-phone'];
        fields.forEach(id => {
            const input = document.getElementById(id);
            if (input) input.readOnly = !enable;
        });

        editProfileButton.style.display = enable ? 'none' : 'block';
        saveProfileButton.style.display = enable ? 'block' : 'none';
        uploadLabel.style.display = enable ? 'inline-block' : 'none'; 
        
        // Show file input only when editing if a file is already selected, otherwise the label handles it
        if (enable && !passportFileInput.files[0]) {
             document.getElementById('upload-button').style.display = 'none';
        }
    }
    
    // Event Listeners for Profile Actions
    editProfileButton.addEventListener('click', () => toggleProfileEdit(true));
    
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        profileStatus.textContent = 'Saving changes...';
        
        const updates = {
            id: currentUserId,
            full_name: document.getElementById('profile-name').value,
            phone: document.getElementById('profile-phone').value,
            updated_at: new Date().toISOString()
        };

        const { error } = await sb
            .from('profiles')
            .update(updates)
            .eq('id', currentUserId);

        if (error) {
            profileStatus.textContent = `Error saving profile: ${error.message}`;
        } else {
            profileStatus.textContent = 'Profile updated successfully!';
            // Reload profile data and switch back to read-only
            loadProfile(currentUserId); 
        }
    });

    passportFileInput.addEventListener('change', () => {
        const file = passportFileInput.files[0];
        if (file) {
            passportPreview.src = URL.createObjectURL(file);
            uploadButton.style.display = 'block'; // Show save button when a file is selected
            uploadLabel.style.display = 'none'; // Hide change label
        }
    });

    uploadButton.addEventListener('click', async () => {
        const file = passportFileInput.files[0];
        if (!file) {
            profileStatus.textContent = 'Please select a file first.';
            return;
        }

        profileStatus.textContent = 'Uploading photo...';
        uploadButton.disabled = true;

        const fileExt = file.name.split('.').pop();
        const filePath = `${currentUserId}.${fileExt}`;

        // 1. Upload to Storage
        const { error: uploadError } = await sb.storage
            .from('passports')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: true
            });

        if (uploadError) {
            profileStatus.textContent = `Upload failed: ${uploadError.message}`;
            uploadButton.disabled = false;
            return;
        }
        
        // 2. Update profile table with the new URL path
        const { error: updateError } = await sb
            .from('profiles')
            .update({ passport_url: filePath, updated_at: new Date().toISOString() })
            .eq('id', currentUserId);

        if (updateError) {
            profileStatus.textContent = `Database update failed: ${updateError.message}`;
        } else {
            profileStatus.textContent = 'Photo uploaded and saved successfully!';
            passportFileInput.value = ''; // Clear file input
            uploadButton.style.display = 'none';
            uploadLabel.style.display = 'inline-block';
            loadProfile(currentUserId); // Reload profile to update UI
        }
        uploadButton.disabled = false;
    });

    // *************************************************************************
    // *** 5. ATTENDANCE LOGIC ***
    // *************************************************************************

    function updateTargetSelect() {
        const sessionType = sessionTypeSelect.value;
        attendanceTargetSelect.innerHTML = '';
        
        let targetList = [];
        let label = 'Rotation/Course:';

        if (sessionType === 'Clinical' || sessionType === 'Call') {
            targetList = MOCK_HOSPITAL_DEPARTMENTS.map(d => ({ 
                id: d.id, 
                name: d.name, 
                text: `${d.name} (${sessionType})` 
            }));
            label = 'Department/Area:';
        } else if (sessionType === 'Class' || sessionType === 'Virtual') {
            targetList = cachedCourses.map(c => ({ 
                id: c.id, 
                name: c.name, 
                text: `${c.name} (${sessionType})` 
            }));
            label = 'Course/Subject:';
        }

        document.getElementById('target-label').textContent = label;

        if (targetList.length === 0) {
            attendanceTargetSelect.innerHTML = '<option>No targets available.</option>';
        } else {
            targetList.forEach(target => {
                const option = document.createElement('option');
                // Use a pipe '|' to safely combine ID and Name for retrieval in geoCheckIn
                option.value = `${target.id}|${target.name}`; 
                option.textContent = target.text;
                attendanceTargetSelect.appendChild(option);
            });
        }
        geoMessage.textContent = 'Select a Session Type and then a specific Rotation or Course to check in at your current GPS location and time.';
    }

    // *** FIX: Corrected and fleshed-out geoCheckIn function ***
    async function geoCheckIn() {
        // This function requires the RLS INSERT policy to be set on the 'geo_attendance_logs' table.

        const sessionType = sessionTypeSelect.value;
        const targetSelect = attendanceTargetSelect.value;
        const checkInTime = new Date().toISOString();
        const button = document.getElementById('check-in-button');
        
        if (!sessionType || !targetSelect || targetSelect === 'Select Session Type first...' || targetSelect === 'No targets available.') {
            geoMessage.textContent = 'Error: Please select both a Session Type and a valid Rotation/Course.';
            return;
        }

        button.disabled = true;
        geoMessage.textContent = 'Attempting to get location and check in...';

        // 1. Get Location
        const getLocation = () => new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                return resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'Fallback Location (Geolocation Disabled)' });
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve({ 
                    lat: pos.coords.latitude, 
                    lon: pos.coords.longitude, 
                    acc: pos.coords.accuracy, 
                    friendly: null 
                }),
                (err) => {
                    console.warn(`Geolocation error (${err.code}): ${err.message}. Using fallback.`);
                    resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'Fallback Location (GPS Error)' });
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        try {
            let location = await getLocation();

            // 2. Reverse Geocode (if necessary)
            if (location.friendly === null) {
                const geocodeUrl = `${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${location.lat}&lon=${location.lon}&format=json`;
                const response = await fetch(geocodeUrl);
                if (response.ok) {
                    const geoData = await response.json();
                    location.friendly = geoData.display_name || `Lat: ${location.lat.toFixed(4)}, Lon: ${location.lon.toFixed(4)}`;
                } else {
                    location.friendly = `Geocoding Failed. Lat: ${location.lat.toFixed(4)}, Lon: ${location.lon.toFixed(4)}`;
                }
            }
            
            // Split target string to get ID and Name
            const [targetId, targetName] = targetSelect.split('|');

            // 3. Insert Attendance Log into 'geo_attendance_logs'
            const { error } = await sb
                .from('geo_attendance_logs')
                .insert({
                    student_id: currentUserId,
                    check_in_time: checkInTime,
                    session_type: sessionType,
                    target_id: targetId,
                    target_name: targetName,
                    latitude: location.lat,
                    longitude: location.lon,
                    accuracy_m: location.acc,
                    location_friendly_name: location.friendly,
                    is_verified: false,
                    notes: `Checked in via dashboard for ${sessionType}`
                });

            if (error) {
                console.error("Check-in failed:", error);
                geoMessage.textContent = `Check-in failed: Error: ${error.message}`;
            } else {
                geoMessage.textContent = `Check-in successful! Logged at ${new Date(checkInTime).toLocaleTimeString()} near ${location.friendly}.`;
                // Refresh history table
                loadGeoAttendanceHistory(currentUserId);
            }

        } catch (e) {
            console.error("GeoCheckIn major failure:", e);
            geoMessage.textContent = `A critical error occurred during check-in: ${e.message}`;
        } finally {
            button.disabled = false;
        }
    }

    // *** FIX: Corrected loadGeoAttendanceHistory function ***
    async function loadGeoAttendanceHistory(userId) {
        const tableBody = document.getElementById('geo-attendance-history');
        tableBody.innerHTML = '<tr><td colspan="5">Loading geo check-in history...</td></tr>';

        try {
            // FIX for 400 Bad Request: Use a clean, comma-separated select list.
            const { data: logs, error } = await sb
                .from('geo_attendance_logs')
                .select('check_in_time, session_type, location_friendly_name, accuracy_m, is_verified')
                .eq('student_id', userId)
                .order('check_in_time', { ascending: false })
                .limit(15); 

            if (error) throw error;

            tableBody.innerHTML = '';

            if (!logs || logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No geo check-in history found.</td></tr>';
                return;
            }

            logs.forEach(log => {
                // FIX for TypeError: Cannot read properties of undefined (reading 'toFixed')
                const accuracyText = (log.accuracy_m || 0).toFixed(2) + 'm'; // Safe null check
                
                const verificationStatus = log.is_verified 
                    ? '<span style="color: var(--color-secondary); font-weight: 600;">Verified</span>' 
                    : '<span style="color: var(--color-info); font-weight: 600;">Pending</span>';

                const row = `
                    <tr>
                        <td>${new Date(log.check_in_time).toLocaleString()}</td>
                        <td>${log.session_type}</td>
                        <td>${log.location_friendly_name || 'N/A'}</td>
                        <td>${accuracyText}</td>
                        <td>${verificationStatus}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            console.error("Failed to load geo attendance history:", error);
            tableBody.innerHTML = `<tr><td colspan="5" style="color: #EF4444;">Error loading history: ${error.message}</td></tr>`;
        }
    }


    // MOCK FUNCTIONS (You will need to implement these with real data later)
    async function loadAttendance() {
        document.getElementById('attendance-table').innerHTML = '<tr><td colspan="4">No historical attendance records found. (MOCK)</td></tr>';
    }
    async function loadCourses() {
         document.getElementById('courses-table').innerHTML = cachedCourses.map(c => `<tr><td>${c.name}</td><td>Active</td></tr>`).join('');
    }
    async function loadExams() {
         document.getElementById('exams-table').innerHTML = '<tr><td colspan="3">No upcoming exams scheduled. (MOCK)</td></tr>';
    }
    async function loadResources() {
         document.getElementById('resources-list').innerHTML = '<p>No resources available for your program at this time. (MOCK)</p>';
    }
    async function loadStudentMessages() {
         document.getElementById('messages-list').innerHTML = '<h2>Recent Admin Messages</h2><p>No new messages. (MOCK)</p>';
    }

    // *************************************************************************
    // *** 6. INITIALIZATION ***
    // *************************************************************************

    document.addEventListener('DOMContentLoaded', checkAuthAndLoad);

    </script>
</body>
</html>
