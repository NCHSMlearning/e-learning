<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard - Deep Purple Theme</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* -------------------------------------- */
        /* SUPABASE STUDENT PORTAL STYLE (Deep Purple Theme) */
        /* -------------------------------------- */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F1F5F9; }
        .container { display: flex; min-height: 100vh; }

        /* Sidebar - Deep Purple Theme */
        .sidebar { 
            width: 250px;
            background-color: #4C1D95;
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
        }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header img { width: 60px; margin-bottom: 10px; filter: invert(1); }
        .nav { list-style: none; padding: 0; flex-grow: 1; }
        .nav li { margin: 10px 0; }
        .nav a { color: #E5E7EB; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.2s; }
        .nav a:hover { background-color: #5B21B6; }
        .nav a.active { 
            background-color: #FCD34D;
            color: #1F2937;
            font-weight: bold;
        }
        .logout { margin-top: auto; text-align: center; }
        .logout a { 
            display: inline-block; 
            margin-top: 20px; 
            padding: 10px 20px; 
            background-color: #EF4444; 
            color: #fff; 
            text-decoration: none; 
            border-radius: 6px; 
        }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        header h1 { margin: 0; font-size: 2.2rem; color: #4C1D95; }
        .subtitle { color: #6B7280; margin-bottom: 25px; }

        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .card { 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            transition: transform 0.2s, box-shadow 0.2s; 
            border: 1px solid #E2E8F0;
            text-align: center;
            border-left: 5px solid #4C1D95; 
        }
        .card:hover { transform: translateY(-7px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .card h3 { margin-top: 0; font-size: 1.1em; color: #4C1D95;}
        .card p.data { font-size: 2em; font-weight: 800; margin: 5px 0 0; color: #F59E0B; } 
        
        /* Dashboard Welcome Banner (Admin Message) */
        #welcome-banner {
            background-color: #FEE7D1; 
            color: #9A3412; 
            border: 1px solid #FDBA74; 
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.0rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcome-banner strong {
            font-weight: bold;
            color: #F59E0B; 
        }
        .info-icon {
            font-size: 1.5rem;
            color: #F59E0B;
        }

        /* Tabs, Tables, Forms */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; background-color: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid #E2E8F0; text-align: left; }
        th { background-color: #E5E7EB; color: #1F2937; }
        tr:hover { background-color: #F8FAFC; }

        /* Forms */
        form input, form select, form button, form textarea {
            padding: 10px 12px; margin: 5px 5px 10px 0; border-radius: 6px; border: 1px solid #CBD5E1;
            box-sizing: border-box; 
            min-width: 150px;
        }
        form button { background-color: #4C1D95; color: #fff; cursor: pointer; }
        form button:hover { background-color: #5B21B6; }
        
        /* Profile Specific Styles */
        #profile-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95; 
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        .profile-details {
            /* Use grid for better layout of details */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .profile-media {
            grid-column: 1 / 3; /* Span across both columns on smaller screens/layouts */
        }
        .form-field {
            min-width: 100%;
        }
        .form-field.full-width {
            grid-column: 1 / 3;
        }

        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            margin-top: 15px; 
            color: #4C1D95;
        }
        .form-field input[readonly] {
            background-color: #E5E7EB;
            color: #4B5563;
        }
        .profile-button {
            background-color: #4C1D95; 
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            margin-top: 15px;
            border: none;
            cursor: pointer;
        }
        
        /* Check-in Controls */
        .check-in-controls {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .check-in-controls button {
            background-color: #10B981; 
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }
        
        .resource-item {
            background-color: #fff;
            border: 1px solid #E2E8F0;
            border-left: 4px solid #F59E0B;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .resource-item a {
            color: #4C1D95;
            font-weight: 600;
            text-decoration: none;
        }
        .resource-item a:hover {
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; padding: 20px 0; height: auto; }
            .nav { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 10px; }
            .nav li { width: 30%; margin: 5px 0; }
            .nav a { text-align: center; padding: 8px 10px; font-size: 0.8rem; }
            .main { padding: 20px; }
            .cards { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .check-in-controls select { width: 100%; min-width: unset; }
            #profile-form { flex-direction: column; padding: 20px; }
            .profile-details { grid-template-columns: 1fr; }
            .form-field.full-width { grid-column: 1 / 2; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo"> 
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Student!</h1>
                <p class="subtitle">Access your learning tools and updates</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-banner">
                    <span class="info-icon">&#x2139;</span>
                    <strong>ADMIN MESSAGE:</strong> 
                    <span id="admin-welcome-message">Loading message...</span>
                </div>
                
                <h2 style="margin-top: 30px; color: #4C1D95;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Last 30 days</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600; color: #4C1D95;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last updated week</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: #4C1D95;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #F59E0B; cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #F59E0B;">View Resources</button>
                    </div>
                </div>
            </section>
            
            <section id="profile" class="tab-content">
                <h2 style="color: #4C1D95;">My Profile & Account</h2>
                <form id="profile-form">
                    
                    <div class="profile-media">
                        <img id="passport-preview" src="https://via.placeholder.com/150x150?text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                             <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                        
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>

                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>
            
            <section id="courses" class="tab-content">
                <h2 style="color: #4C1D95;">My Courses (Real-Time Enrollment)</h2>
                <p>Courses shown here are filtered by your **Program**, **Block**, and **Intake Year** for relevance.</p>
                <table>
                    <thead><tr><th>Course Name</th><th>Status</th></tr></thead>
                    <tbody id="courses-table">
                        <tr><td colspan="2">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2 style="color: #4C1D95;">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option>Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Select a **Session Type** and then a specific **Department or Course** to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: #4C1D95;">Geo Attendance History (Check-in Logs)</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Target</th><th>Accuracy (m)</th><th>Verified by Admin</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="5">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="cats" class="tab-content">
                <h2 style="color: #4C1D95;">CATS / Exams Schedule</h2>
                <table>
                    <thead><tr><th>Exam Name</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="exams-table">
                        <tr><td colspan="3">Loading exam schedule...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="resources" class="tab-content">
                <h2 style="color: #4C1D95;">Learning Resources</h2>
                <div id="resources-list">Loading resources...</div>
            </section>

            <section id="messages" class="tab-content">
                <h2 style="color: #4C1D95;">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
                
                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>
<script>
    // *************************************************************************
    // *** 1. CONFIGURATION ***
    // *************************************************************************
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c';
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';

    const MOCK_HOSPITAL_DEPARTMENTS = [
        { id: '1', name: 'Maternity Department' },
        { id: '2', name: 'Male Surgical' },
        { id: '3', name: 'Female Surgical' },
        { id: '4', name: 'Male Medical' },
        { id: '5', name: 'Female Medical' },
        { id: '6', name: 'Peaditrics' },
        { id: '7', name: 'Psychiatry' },
        { id: '8', name: 'ICU' },
        { id: '9', name: 'Outpatient' },
        { id: '10', name: 'Oncology' },
        { id: '11', name: 'NBU' }, 
        { id: '12', name: 'Gynecology' },
        { id: '13', name: 'Community Health' },
    ];

    const FALLBACK_LAT = -1.286389; 
    const FALLBACK_LON = 36.817223;
    const FALLBACK_ACCURACY = 500; 

    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = [];
    let cachedExams = [];

    // DOM Elements
    const geoMessage = document.getElementById('geo-message');
    const sessionTypeSelect = document.getElementById('session-type');
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const adminWelcomeMessage = document.getElementById('admin-welcome-message'); 

    // *************************************************************************
    // *** 2. UI AND NAVIGATION LOGIC ***
    // *************************************************************************
    const navLinks = document.querySelectorAll('.nav a');
    const tabs = document.querySelectorAll('.tab-content');

    function showTab(tabId) {
        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
        if(activeLink) activeLink.classList.add('active');

        tabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if(activeTab) activeTab.classList.add('active');
        
        if (tabId === 'profile' && currentUserId) loadProfile(currentUserId); 
        if (tabId === 'attendance' && currentUserId) {
            loadGeoAttendanceHistory(currentUserId); 
            updateTargetSelect();
        }
        if (tabId === 'dashboard' && currentUserId) {
            loadWelcomeMessage();
            loadCourses();
            loadExams();
            loadResources();
            setTimeout(() => loadDashboardMetrics(currentUserId), 500); 
        }
        if (tabId === 'courses' && currentUserId) loadCourses(); 
        if (tabId === 'resources' && currentUserId) loadResources(); 
        if (tabId === 'cats' && currentUserId) loadExams();
        if (tabId === 'messages' && currentUserId) loadStudentMessages(); 
    }

    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            showTab(link.dataset.tab);
        });
    });

    async function logout() {
        sb.realtime.channels.forEach(channel => sb.removeChannel(channel)); 
        await sb.auth.signOut();
        window.location.href = "login.html";
    }

    // *************************************************************************
    // *** 3. CORE DASHBOARD FUNCTIONS ***
    // *************************************************************************

    async function loadWelcomeMessage() {
        adminWelcomeMessage.textContent = 'Loading message...';
        const { data, error } = await sb
            .from('system_settings')
            .select('setting_value')
            .eq('setting_key', 'welcome_message')
            .single();

        adminWelcomeMessage.textContent = (!error && data?.setting_value) 
            ? data.setting_value 
            : 'Welcome to the NCHSM Student Dashboard! Stay updated with your studies.';
    }

    async function loadDashboardMetrics(userId) {
        document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;
        document.getElementById('dashboard-attendance-rate').textContent = '94%';

        let nextExamText = 'None Scheduled';
        if (cachedExams?.length > 0) {
            const now = new Date();
            const upcomingExam = cachedExams.find(e => new Date(e.exam_date) >= now);
            if (upcomingExam) nextExamText = `${new Date(upcomingExam.exam_date).toLocaleDateString()} (${upcomingExam.exam_name})`;
            else nextExamText = 'Semester Complete';
        }
        document.getElementById('dashboard-upcoming-exam').textContent = nextExamText;

        const passportCard = document.getElementById('action-passport');
        let profileIncomplete = !currentUserProfile?.passport_url; 
        passportCard.style.display = profileIncomplete ? 'block' : 'none';
    }

    // *************************************************************************
    // *** 4. AUTHENTICATION & PROFILE MANAGEMENT ***
    // *************************************************************************

    async function checkAuthAndLoad() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            console.warn("No active user session. Redirecting.");
            window.location.href = "login.html"; 
            return;
        }

        currentUserId = user.id;
        await loadProfile(currentUserId);
        await loadCourses();
        await loadExams();
        await loadResources(); 
        showTab('dashboard');
        setTimeout(() => loadDashboardMetrics(currentUserId), 500);
    }

    async function loadProfile(userId) {
        const profileStatus = document.getElementById('profile-status');
        profileStatus.textContent = 'Loading profile...';
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', userId).single();

        if (error) {
            console.error('Error loading profile:', error);
            currentUserProfile = { full_name: 'Student', program: 'N/A', block: 'N/A', intake_year: 'N/A' };
            profileStatus.textContent = 'Error loading profile.';
            return;
        }

        currentUserProfile = profile;
        profileStatus.textContent = '';

        document.getElementById('profile-student-id').value = currentUserProfile.student_id_no || 'N/A';
        document.getElementById('profile-name').value = currentUserProfile.full_name || 'N/A';
        document.getElementById('profile-email').value = currentUserProfile.email || 'N/A';
        document.getElementById('profile-phone').value = currentUserProfile.phone || 'N/A';
        document.getElementById('profile-program').value = currentUserProfile.program || 'N/A';
        document.getElementById('profile-block').value = currentUserProfile.block || 'N/A';
        document.getElementById('profile-intake-year').value = currentUserProfile.intake_year || 'N/A';
        
        document.getElementById('passport-preview').src = currentUserProfile.passport_url 
            ? sb.storage.from('passports').getPublicUrl(currentUserProfile.passport_url).data.publicUrl
            : 'https://via.placeholder.com/150x150?text=NO+PHOTO'; 

        document.querySelector('header h1').textContent = `Welcome, ${currentUserProfile.first_name || 'Student'}!`;
    }

    // *************************************************************************
    // *** 5. ATTENDANCE LOGIC ***
    // *************************************************************************

    function updateTargetSelect() {
        const sessionType = sessionTypeSelect.value;
        attendanceTargetSelect.innerHTML = '';
        let targetList = [];
        let label = 'Department/Course:';

        if (sessionType === 'Clinical') {
            targetList = MOCK_HOSPITAL_DEPARTMENTS.map(d => ({ id: d.id, name: d.name, text: `${d.name} (Clinical)` }));
            label = 'Department/Area:';
        } else if (sessionType === 'Class') {
            targetList = cachedCourses.map(c => ({ id: c.id, name: c.course_name, text: `${c.code ? c.code + ' - ' : ''}${c.course_name} (Class)` }));
            label = 'Course/Subject:';
        }

        document.getElementById('target-label').textContent = label;

        if (!targetList.length) {
            const message = sessionType === 'Class' ? 'No active courses found. Please check My Courses.' : 'No clinical targets available.';
            attendanceTargetSelect.innerHTML = `<option>${message}</option>`;
        } else {
            targetList.forEach(target => {
                const option = document.createElement('option');
                option.value = `${target.id}|${target.name}`;
                option.textContent = target.text;
                attendanceTargetSelect.appendChild(option);
            });
        }

        geoMessage.innerHTML = `Please select a specific **${label.replace(':','')}** to check in.`;
    }

    // *************************************************************************
    // *** 6. SUPABASE DATA LOADING ***
    // *************************************************************************

    async function loadCourses() {
        const tableBody = document.getElementById('courses-table');
        tableBody.innerHTML = '<tr><td colspan="2">Loading courses...</td></tr>';

        try {
            const program = currentUserProfile?.program;
            const block = currentUserProfile?.block;
            const intakeYear = currentUserProfile?.intake_year;

            if (!program || !block || !intakeYear) {
                tableBody.innerHTML = '<tr><td colspan="2">Missing enrollment details.</td></tr>';
                cachedCourses = [];
                return;
            }

            const { data: courses, error } = await sb
                .from('courses')
                .select('*')
                .eq('target_program', program)
                .eq('block', block)
                .eq('intake_year', intakeYear)
                .eq('status', 'Active')
                .order('course_name', { ascending: true });

            if (error) throw error;

            cachedCourses = courses || [];
            tableBody.innerHTML = '';

            if (!cachedCourses.length) {
                tableBody.innerHTML = '<tr><td colspan="2">No courses found for your cohort.</td></tr>';
            } else {
                cachedCourses.forEach(c => {
                    tableBody.innerHTML += `<tr><td>${c.code ? c.code + ' - ' : ''}${c.course_name}</td><td>${c.status}</td></tr>`;
                });
            }

        } catch (error) {
            console.error("Failed to load courses:", error);
            tableBody.innerHTML = `<tr><td colspan="2" style="color:#EF4444;">Error loading courses: ${error.message}</td></tr>`;
            cachedCourses = [];
        }

        if (document.getElementById('attendance').classList.contains('active')) updateTargetSelect();
        document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;
    }

    async function loadExams() {
        const tableBody = document.getElementById('exams-table').querySelector('tbody');
        tableBody.innerHTML = '<tr><td colspan="3">Loading exams...</td></tr>';

        try {
            const program = currentUserProfile?.program;
            const block = currentUserProfile?.block;
            const intakeYear = currentUserProfile?.intake_year;

            if (!program || !block || !intakeYear) {
                tableBody.innerHTML = '<tr><td colspan="3">Missing enrollment details.</td></tr>';
                cachedExams = [];
                return;
            }

            const { data: exams, error } = await sb
                .from('exams_schedule')
                .select('exam_name, exam_date, status')
                .eq('program', program)
                .eq('block', block)
                .eq('intake_year', intakeYear)
                .order('exam_date', { ascending: true });

            if (error) throw error;

            cachedExams = exams || [];
            tableBody.innerHTML = '';

            if (!cachedExams.length) {
                tableBody.innerHTML = '<tr><td colspan="3">No exams or CATs scheduled for your cohort yet.</td></tr>';
            } else {
                cachedExams.forEach(exam => {
                    tableBody.innerHTML += `<tr><td>${exam.exam_name}</td><td>${new Date(exam.exam_date).toLocaleDateString()}</td><td>${exam.status}</td></tr>`;
                });
            }

        } catch (error) {
            console.error("Failed to load exams:", error);
            tableBody.innerHTML = `<tr><td colspan="3" style="color:#EF4444;">Error loading exams: ${error.message}</td></tr>`;
            cachedExams = [];
        }

        loadDashboardMetrics(currentUserId);
    }

    async function loadResources() {
        const resourceList = document.getElementById('resources-list');
        resourceList.innerHTML = 'Loading resources...';

        try {
            const program = currentUserProfile?.program;
            const block = currentUserProfile?.block;

            if (!program || !block) {
                resourceList.innerHTML = '<p>Missing enrollment details.</p>';
                return;
            }

            const { data: resources, error } = await sb
                .from('resources')
                .select('id, title, file_path, program, block, upload_date')
                .or(`program.eq.${program},program.eq.all`) 
                .eq('block', block)
                .order('upload_date', { ascending: false });

            if (error) throw error;

            resourceList.innerHTML = '';
            if (!resources.length) resourceList.innerHTML = '<p>No resources found.</p>';
            else {
                resources.forEach(r => {
                    const link = sb.storage.from('resources').getPublicUrl(r.file_path).data.publicUrl;
                    resourceList.innerHTML += `<li><a href="${link}" target="_blank">${r.title}</a> (${new Date(r.upload_date).toLocaleDateString()})</li>`;
                });
            }

        } catch (error) {
            console.error("Failed to load resources:", error);
            resourceList.innerHTML = `<p style="color:#EF4444;">Error loading resources: ${error.message}</p>`;
        }
    }

    // *************************************************************************
    // *** 7. INITIALIZATION ***
    // *************************************************************************
    document.addEventListener('DOMContentLoaded', checkAuthAndLoad);
</script>
</body>
</html>
