<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"></noscript>
    
    <style>
        /* Global Styles & Variables */
        :root {
            --color-primary: #3B82F6; /* Blue for action/emphasis */
            --color-secondary: #10B981; /* Green for success */
            --color-dark: #1F2937; /* Deep text color */
            --color-text-light: #6B7280;
            --color-background: #F9FAFB;
            --color-card-bg: #FFFFFF;
            --color-sidebar: #0F172A; /* Dark blue sidebar */
            --border-radius: 10px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-dark);
            -webkit-font-smoothing: antialiased;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 1. Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--color-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            box-shadow: var(--shadow-md);
            z-index: 10;
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #374151;
        }
        .sidebar-header img {
            width: 60px;
            margin-bottom: 15px;
        }
        .sidebar-header h2 {
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            letter-spacing: 0.5px;
        }
        .nav { 
            list-style: none; padding: 0; flex-grow: 1; 
        }
        .nav a { 
            color: #D1D5DB; 
            text-decoration: none; 
            padding: 12px 15px; 
            border-radius: var(--border-radius); 
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease-in-out; 
            font-weight: 500;
            margin-bottom: 8px;
        }
        .nav a:hover { 
            background-color: #1F2937;
            color: white;
        }
        .nav a.active { 
            background-color: var(--color-primary); 
            color: white; 
            font-weight: 600;
        }
        .logout { 
            margin-top: auto; 
            padding-top: 20px;
            text-align: center;
        }
        .logout a { 
            display: block;
            width: 100%;
            padding: 12px 20px; 
            background-color: #EF4444; /* Red for Logout */
            color: #fff; 
            text-decoration: none; 
            border-radius: var(--border-radius); 
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .logout a:hover { 
            background-color: #DC2626; 
        }

        /* 2. Main Content Area */
        .main { 
            flex: 1; 
            padding: 40px; 
            overflow-y: auto; 
        }
        header h1 { 
            margin: 0; 
            font-size: 2.2rem; 
            font-weight: 700;
            color: var(--color-dark);
        }
        .subtitle { 
            color: var(--color-text-light); 
            margin-top: 5px;
            margin-bottom: 30px; 
            font-weight: 400;
        }

        /* 3. Cards (Attendance/Stats) */
        .cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .card { 
            background-color: var(--color-card-bg); 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-md); 
            border-left: 5px solid var(--color-primary);
        }
        .card h3 { 
            margin-top: 0; 
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-light);
            text-transform: uppercase;
        }
        .card-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--color-dark);
            margin-top: 10px;
        }

        /* 4. Attendance Action Area */
        #attendance-check {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 40px;
            border-top: 4px solid var(--color-secondary);
        }
        .action-button {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 15px;
        }
        #check-in-btn {
            background-color: var(--color-primary);
        }
        #check-in-btn:hover {
            background-color: #2563EB;
        }
        #check-out-btn {
            background-color: #FBBF24; /* Amber/Yellow for Check-out */
            margin-top: 10px;
        }
        #check-out-btn:hover {
            background-color: #F59E0B;
        }
        #status-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        /* 5. Tables */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: var(--color-card-bg); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--shadow-md);
        }
        th, td { 
            padding: 15px 20px; 
            text-align: left; 
            font-size: 0.9rem;
        }
        th { 
            background-color: #F3F4F6;
            color: var(--color-dark);
            font-weight: 600;
            border-bottom: 2px solid #E5E7EB;
        }
        tbody tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        tbody tr:hover { 
            background-color: #E5E7EB;
        }
        
        /* 6. Other Tabs */
        .tab-content { 
            display: none; 
            padding-top: 10px;
        }
        .tab-content.active { 
            display: block; 
        }

        #announcements-list, #messages-form {
            background-color: var(--color-card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 20px;
        }
        .announcement-item {
            border-bottom: 1px dashed #E5E7EB;
            padding: 15px 0;
        }
        .announcement-item:last-child {
            border-bottom: none;
        }
        .announcement-item p {
            margin: 5px 0;
            font-size: 1rem;
        }
        .announcement-item .meta {
            font-size: 0.8rem;
            color: var(--color-text-light);
            font-weight: 500;
        }
        
        /* Messages Form */
        #messages-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }
        #messages-form button {
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #messages-form button:hover {
            background-color: #059669;
        }
        #message-status {
            margin-top: 10px;
            font-weight: 500;
        }
        
        /* Profile Tab */
        #profile-details p {
            font-size: 1.1rem;
            padding: 8px 0;
            border-bottom: 1px dotted #E5E7EB;
        }
        #profile-details strong {
            display: inline-block;
            width: 150px;
            font-weight: 600;
            color: var(--color-primary);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 20px 0;
                height: auto;
            }
            .nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                margin-top: 10px;
            }
            .nav li {
                width: 45%;
                margin: 5px 0;
            }
            .nav a {
                text-align: center;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .main {
                padding: 20px;
            }
            .cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo" style="filter: invert(1);">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">&#x1F3E0; Dashboard</a></li>
                <li><a href="#" data-tab="attendance">&#x23F0; Attendance Logs</a></li>
                <li><a href="#" data-tab="announcements">&#x1F4E3; Announcements</a></li>
                <li><a href="#" data-tab="messages">&#x1F4E8; Message Admin</a></li>
                <li><a href="#" data-tab="profile">&#x1F464; My Profile</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, <span id="student-name">Student</span>!</h1>
                <p class="subtitle">Your personalized activity dashboard and tools.</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <h2>Daily Geo-Attendance Check</h2>
                <div id="attendance-check">
                    <p style="font-weight: 600; margin-bottom: 15px; text-align: center;">Your current status: <span id="current-attendance-status" style="color: var(--color-primary);">Loading...</span></p>

                    <button id="check-in-btn" class="action-button">Check-In Now</button>
                    <button id="check-out-btn" class="action-button" disabled>Check-Out Now</button>
                    
                    <p id="status-message"></p>
                    <p style="font-size: 0.9rem; color: #9CA3AF; margin-top: 15px; text-align: center;">*Location services must be enabled and accurate for attendance verification.</p>
                </div>

                <h2>Your Statistics</h2>
                <div class="cards">
                    <div class="card">
                        <h3>Program Type</h3>
                        <p class="card-value" id="program-type">...</p>
                    </div>
                    <div class="card">
                        <h3>Total Check-ins (Month)</h3>
                        <p class="card-value" id="monthly-checkins">...</p>
                    </div>
                    <div class="card">
                        <h3>Unread Announcements</h3>
                        <p class="card-value" id="unread-announcements">...</p>
                    </div>
                </div>
            </section>

            <section id="attendance" class="tab-content">
                <h2>Your Attendance History</h2>
                <p class="subtitle">Review your past geo-location check-in and check-out logs.</p>
                <table>
                    <thead><tr><th>Date</th><th>Check-In Time</th><th>Check-Out Time</th><th>Status</th><th>Location Verified</th></tr></thead>
                    <tbody id="attendance-table">
                        <tr><td colspan="5">Loading your attendance logs...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="announcements" class="tab-content">
                <h2>Program Announcements</h2>
                <div id="announcements-list">
                    <p>Loading announcements...</p>
                </div>
            </section>

            <section id="messages" class="tab-content">
                <h2>Send Message to Administration</h2>
                <form id="messages-form">
                    <p style="font-size: 0.9rem; color: var(--color-text-light);">Use this form to send a private inquiry or report an issue directly to the admin team.</p>
                    <textarea id="message-body" placeholder="Write your message here..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
            </section>

            <section id="profile" class="tab-content">
                <h2>My Personal Details</h2>
                <div id="profile-details">
                    <p><strong>Full Name:</strong> <span id="p-full-name">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="p-email">Loading...</span></p>
                    <p><strong>Student ID:</strong> <span id="p-student-id">Loading...</span></p>
                    <p><strong>Program:</strong> <span id="p-program">Loading...</span></p>
                    <p><strong>Phone:</strong> <span id="p-phone">Loading...</span></p>
                    <p><strong>Account Status:</strong> <span id="p-status">Loading...</span></p>
                </div>
            </section>
        </main>
    </div>

    <script>
    // *************************************************************************
    // *** 1. CONFIGURATION: UPDATE THESE VALUES ***
    // *************************************************************************
    
    // ** SUPABASE CONFIGURATION **
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUserId = null; 
    let studentProfile = {}; // Store the user's profile data
    let currentCheckInLog = null; // Store the current day's active check-in record

    // *************************************************************************
    // *** 2. UI AND NAVIGATION LOGIC ***
    // *************************************************************************
    const navLinks = document.querySelectorAll('.nav a');
    const tabs = document.querySelectorAll('.tab-content');

    function showTab(tabId) {
        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
        if(activeLink) activeLink.classList.add('active');

        tabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if(activeTab) activeTab.classList.add('active');
        
        // Load data specific to the tab being activated
        if (!currentUserId) return; // Wait for user data
        if (tabId === 'dashboard') loadDashboardData();
        if (tabId === 'attendance') loadAttendanceLogs();
        if (tabId === 'announcements') loadAnnouncements();
        if (tabId === 'profile') displayProfile();
    }

    // Add listeners to enable switching tabs
    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            showTab(link.dataset.tab);
        });
    });

    async function logout() {
        await sb.auth.signOut();
        window.location.href = "login.html"; // Redirect to your login page
    }

    // *************************************************************************
    // *** 3. CORE ATTENDANCE AND GEOLOCATION LOGIC ***
    // *************************************************************************

    /**
     * Attempts to get the user's current geolocation.
     * @returns {Promise<Object>} Object with latitude, longitude, and accuracy.
     */
    function getGeoLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error("Geolocation is not supported by this browser."));
            } else {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy_meters: position.coords.accuracy
                        });
                    },
                    (error) => {
                        reject(new Error(`Geolocation error: ${error.message}`));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        });
    }

    /**
     * Updates the UI status message.
     */
    function setStatus(message, isSuccess = false) {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        statusEl.style.backgroundColor = isSuccess ? '#D1FAE5' : '#FEE2E2';
        statusEl.style.color = isSuccess ? '#065F46' : '#991B1B';
        if (isSuccess) setTimeout(() => statusEl.style.display = 'none', 5000);
    }
    
    /**
     * Checks if a user has an active check-in record for today.
     */
    async function checkCurrentAttendanceStatus() {
        const today = new Date().toISOString().split('T')[0];
        const statusEl = document.getElementById('current-attendance-status');

        const { data, error } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .eq('student_id', currentUserId)
            .gte('check_in_time', today)
            .is('check_out_time', null) // Look for open sessions
            .limit(1)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 is "No rows found"
            statusEl.textContent = 'Error checking status.';
            statusEl.style.color = '#EF4444';
            console.error('Attendance status error:', error);
            return;
        }

        if (data) {
            // Active session found
            currentCheckInLog = data;
            statusEl.textContent = `CHECKED IN at ${new Date(data.check_in_time).toLocaleTimeString()}`;
            statusEl.style.color = var('--color-secondary');
            document.getElementById('check-in-btn').disabled = true;
            document.getElementById('check-out-btn').disabled = false;
        } else {
            // No active session found
            currentCheckInLog = null;
            statusEl.textContent = 'CHECKED OUT or No Check-in Today';
            statusEl.style.color = var('--color-primary');
            document.getElementById('check-in-btn').disabled = false;
            document.getElementById('check-out-btn').disabled = true;
        }
    }

    /**
     * Handles the Check-In process.
     */
    async function handleCheckIn() {
        if (!currentUserId) return setStatus("Error: User not identified.", false);
        document.getElementById('check-in-btn').disabled = true;
        setStatus("Attempting Geo Check-In...");

        try {
            const geo = await getGeoLocation();
            
            // NOTE: In a real system, you'd check if geo.latitude/longitude is within an approved fence (geofence table).
            // For this demo, we just log the location.

            const { data, error } = await sb
                .from('geo_attendance_logs')
                .insert({
                    student_id: currentUserId,
                    session_type: 'Clinical', // Simplified, could be a dropdown choice
                    latitude: geo.latitude,
                    longitude: geo.longitude,
                    accuracy_meters: geo.accuracy_meters,
                    // is_verified is false by default in the DB until Admin reviews or Geofence confirms
                })
                .select()
                .single();

            if (error) throw new Error(error.message);

            setStatus(`Check-In successful at ${new Date().toLocaleTimeString()}! Location logged (Accuracy: ${geo.accuracy_meters.toFixed(2)}m).`, true);
            checkCurrentAttendanceStatus(); // Re-check and update UI

        } catch (e) {
            setStatus(`Check-In Failed: ${e.message}`, false);
            document.getElementById('check-in-btn').disabled = false;
        }
    }

    /**
     * Handles the Check-Out process.
     */
    async function handleCheckOut() {
        if (!currentCheckInLog) return setStatus("Error: No active Check-In found to close.", false);
        document.getElementById('check-out-btn').disabled = true;
        setStatus("Attempting Geo Check-Out...");
        
        try {
            // Optionally, log geo-location for check-out as well, but we'll simplify and only update the time.
            const { error } = await sb
                .from('geo_attendance_logs')
                .update({ check_out_time: new Date().toISOString() })
                .eq('id', currentCheckInLog.id);

            if (error) throw new Error(error.message);

            setStatus(`Check-Out successful at ${new Date().toLocaleTimeString()}!`, true);
            checkCurrentAttendanceStatus(); // Re-check and update UI

        } catch (e) {
            setStatus(`Check-Out Failed: ${e.message}`, false);
            document.getElementById('check-out-btn').disabled = false;
        }
    }

    // Attach listeners to buttons
    document.getElementById('check-in-btn').addEventListener('click', handleCheckIn);
    document.getElementById('check-out-btn').addEventListener('click', handleCheckOut);

    // *************************************************************************
    // *** 4. DATA LOADING FUNCTIONS ***
    // *************************************************************************

    async function loadDashboardData() {
        document.getElementById('student-name').textContent = studentProfile.full_name || 'Student';
        document.getElementById('program-type').textContent = studentProfile.program_type || 'N/A';

        // 1. Monthly Check-ins
        const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
        const { count: monthlyCount, error: countError } = await sb
            .from('geo_attendance_logs')
            .select('*', { count: 'exact', head: true })
            .eq('student_id', currentUserId)
            .gte('check_in_time', startOfMonth);

        document.getElementById('monthly-checkins').textContent = countError ? 'Error' : monthlyCount || 0;
        
        // 2. Unread Announcements (Assuming no read-status tracking for demo, just show total recent)
        const twoWeeksAgo = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString();
        const { count: announcementCount, error: announceError } = await sb
            .from('messages')
            .select('*', { count: 'exact', head: true })
            .or(`program_type.eq.ALL,program_type.eq.${studentProfile.program_type}`)
            .gte('created_at', twoWeeksAgo);

        document.getElementById('unread-announcements').textContent = announceError ? 'Error' : announcementCount || 0;

        // 3. Check and display today's status
        checkCurrentAttendanceStatus();
    }

    async function loadAttendanceLogs() {
        const { data: logs, error } = await sb
            .from('geo_attendance_logs')
            .select('*')
            .eq('student_id', currentUserId)
            .order('check_in_time', { ascending: false })
            .limit(20);

        const table = document.getElementById('attendance-table');
        if (error) {
            table.innerHTML = `<tr><td colspan="5" style="color: red;">Error loading logs: ${error.message}</td></tr>`;
            return;
        }

        table.innerHTML = (logs || []).map(log => {
            const date = new Date(log.check_in_time).toLocaleDateString();
            const checkIn = new Date(log.check_in_time).toLocaleTimeString();
            const checkOut = log.check_out_time ? new Date(log.check_out_time).toLocaleTimeString() : 'N/A (Open)';
            const status = log.check_out_time ? 'Completed' : 'Active';
            const verified = log.is_verified ? 'Yes &#x2705;' : 'Pending/No &#x274C;';
            return `
                <tr>
                    <td>${date}</td>
                    <td>${checkIn}</td>
                    <td>${checkOut}</td>
                    <td>${status}</td>
                    <td>${verified}</td>
                </tr>
            `;
        }).join('');
    }

    async function loadAnnouncements() {
        const container = document.getElementById('announcements-list');
        container.innerHTML = '<p>Fetching latest announcements...</p>';

        const { data: announcements, error } = await sb
            .from('messages')
            .select('body, created_at, program_type')
            // Get messages targeted to ALL or the student's specific program
            .or(`program_type.eq.ALL,program_type.eq.${studentProfile.program_type}`) 
            .order('created_at', { ascending: false })
            .limit(10);

        if (error) {
            container.innerHTML = `<p style="color:red;">Error loading announcements: ${error.message}</p>`;
            return;
        }

        if (announcements.length === 0) {
            container.innerHTML = '<p>No announcements currently available for your program.</p>';
            return;
        }

        container.innerHTML = (announcements || []).map(a => `
            <div class="announcement-item">
                <p><strong>${a.program_type === 'ALL' ? 'GLOBAL NOTICE' : 'Program Update'}:</strong> ${a.body}</p>
                <p class="meta">Posted: ${new Date(a.created_at).toLocaleString()}</p>
            </div>
        `).join('');
    }

    function displayProfile() {
        document.getElementById('p-full-name').textContent = studentProfile.full_name || 'N/A';
        document.getElementById('p-email').textContent = studentProfile.email || 'N/A';
        document.getElementById('p-student-id').textContent = studentProfile.student_id || 'N/A';
        document.getElementById('p-program').textContent = studentProfile.program_type || 'N/A';
        document.getElementById('p-phone').textContent = studentProfile.phone || 'N/A';
        document.getElementById('p-status').textContent = studentProfile.status || 'Active';
    }

    // *************************************************************************
    // *** 5. MESSAGE TO ADMIN LOGIC ***
    // *************************************************************************
    document.getElementById('messages-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = document.getElementById('message-body').value.trim();
        const statusElement = document.getElementById('message-status');

        if (!body) return;

        statusElement.textContent = 'Sending message...';
        statusElement.style.color = var('--color-primary');
        
        // program_type: 'TO_ADMIN' signifies this is an inquiry *to* the admin
        const { error } = await sb
            .from('messages')
            .insert({
                sender_id: currentUserId,
                body: body,
                program_type: 'TO_ADMIN' 
            });

        if (error) {
            console.error('Error sending message:', error);
            statusElement.textContent = `Error sending message: ${error.message}`;
            statusElement.style.color = '#EF4444';
        } else {
            statusElement.textContent = 'Message successfully sent to the administration!';
            statusElement.style.color = var('--color-secondary');
            document.getElementById('message-body').value = ''; 
            setTimeout(() => { statusElement.textContent = ''; }, 5000);
        }
    });


    // *************************************************************************
    // *** 6. INITIALIZATION LOGIC ***
    // *************************************************************************
    
    async function initializeApp() {
        const { data: { user } } = await sb.auth.getUser();

        if (user) {
            currentUserId = user.id;
            
            // Fetch the user's profile and store it globally
            const { data: profile, error } = await sb
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if (error || profile.role !== 'student') {
                alert('Access Denied: Your account role is not set as a Student or profile data is missing.');
                await logout();
                return;
            }
            
            studentProfile = profile;
            
            // Start loading data for the default tab
            loadDashboardData();
            showTab('dashboard'); 

        } else {
            // No user is signed in, redirect to login
            window.location.href = "login.html";
        }
    }

    // Initial call to start the app
    initializeApp();
    </script>
</body>
</html>
