<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"></noscript>
    
    <style>
        /*
         * (The original CSS styles you provided are excellent and complete.
         * For brevity in this response, I'll assume the CSS block is here
         * and proceed directly to the JavaScript.)
         */
        
        /* Global Reset and Ultra Modern Typography */
        :root {
            --color-dark: #1F2937;
            --color-sidebar: #111827;
            --color-primary: #3B82F6;
            --color-secondary: #059669;
            --color-background: #F9FAFB;
            --color-card-bg: #FFFFFF;
            --color-text-light: #D1D5DB;
            --color-text-dark: #374151;
            --border-radius: 12px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --color-info: #FBBF24;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            -webkit-font-smoothing: antialiased;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 1. Sidebar (Sleek, Dark, High Contrast) */
        .sidebar {
            width: 250px;
            background-color: var(--color-sidebar);
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #374151;
        }
        .sidebar-header img {
            width: 70px;
            margin-bottom: 15px;
            /* Placeholder path - adjust if necessary */
            /* src="images/Logo_NCHSM.png" */
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.1));
        }
        .sidebar-header h2 {
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            letter-spacing: 0.5px;
        }
        .nav {
            list-style: none; padding: 0; flex-grow: 1;
        }
        .nav a {
            color: var(--color-text-light);
            text-decoration: none;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            display: block;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .nav a:hover {
            background-color: #1F2937;
            color: white;
        }
        .nav a.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-md);
            font-weight: 600;
        }
        .logout {
            margin-top: auto;
            text-align: center;
            padding-top: 20px;
        }
        .logout a {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: #EF4444;
            color: #fff;
            text-decoration: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .logout a:hover {
            background-color: #DC2626;
        }

        /* 2. Main Content Area */
        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-dark);
        }
        .subtitle {
            color: #6B7280;
            margin-top: 5px;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        /* Welcome Message Banner */
        #welcome-banner {
            background-color: #FEF3C7;
            color: #92400E;
            border: 1px solid #FCD34D;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            font-weight: 500;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcome-banner strong {
            font-weight: 700;
            color: #D97706;
        }
        .info-icon {
            font-size: 1.5rem;
            color: var(--color-info);
        }

        /* 3. Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .card {
            background-color: var(--color-card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--color-primary);
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-left-color: var(--color-secondary);
        }
        .card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-dark);
        }
        .tab-content h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 10px;
        }

        /* 4. Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        th, td {
            padding: 15px 20px;
            text-align: left;
            font-size: 0.9rem;
        }
        th {
            background-color: #F3F4F6;
            color: var(--color-dark);
            font-weight: 600;
            border-bottom: 2px solid #E5E7EB;
        }
        tbody tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        tbody tr:hover {
            background-color: #E5E7EB;
        }
        td {
            border-bottom: 1px solid #F3F4F6;
        }

        /* 5. Tab Content Management */
        .tab-content {
            display: none;
            padding-top: 10px;
        }
        .tab-content.active {
            display: block;
        }

        /* 6. Check-in Controls */
        .check-in-controls {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border-top: 5px solid var(--color-primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .check-in-controls label {
            font-weight: 600;
            color: var(--color-dark);
        }
        .check-in-controls select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #D1D5DB;
            background-color: #fff;
            cursor: pointer;
            font-size: 1rem;
            flex-grow: 1;
            min-width: 200px;
        }
        .check-in-controls button {
            padding: 12px 25px;
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .check-in-controls button:hover:not(:disabled) {
            background-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3);
        }
        .check-in-controls button:disabled {
            background-color: #A7F3D0;
            cursor: not-allowed;
            color: #065F46;
        }
        #geo-message {
            margin-top: 5px;
            font-style: italic;
            color: var(--color-text-dark);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            background-color: #F0F4F8;
            font-size: 0.95rem;
        }

        /* 7. Enhanced Profile Styling */
        #profile-form {
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border-top: 5px solid var(--color-primary);
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }

        .profile-details {
            flex-grow: 1;
        }

        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-dark);
        }
        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }
        /* Style for read-only fields */
        .form-field input[readonly] {
            background-color: var(--color-background);
            border-color: #E5E7EB;
            cursor: default;
        }
        .form-field input:not([readonly]):focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .profile-media {
            width: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #passport-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--color-primary);
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }

        .profile-button {
            padding: 12px 25px;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }
        .profile-button:hover {
            background-color: #2563EB;
            transform: translateY(-2px);
        }

        .file-upload-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #F3F4F6;
            color: var(--color-dark);
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: #E5E7EB;
        }
        #passport-file-input {
            display: none;
        }
        #profile-status {
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }
        /* End Enhanced Profile Styling */

        /* 8. Form Styling (Messages Tab) */
        #message-form {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }
        #message-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
        }
        #message-form button {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #message-form button:hover {
            background-color: #2563EB;
        }
        #message-status {
            margin-top: 10px;
            font-weight: 500;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 20px 0;
                height: auto;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                margin-top: 10px;
            }
            .nav li {
                width: 30%;
                margin: 5px 0;
            }
            .nav a {
                text-align: center;
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .main {
                padding: 20px;
            }
            .cards {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .control-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .check-in-controls select {
                width: 100%;
                min-width: unset;
            }
            /* Profile adjustments for mobile */
            #profile-form {
                flex-direction: column;
                padding: 20px;
            }
            .profile-media {
                width: 100%;
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">Dashboard</a></li>
                <li><a href="#" data-tab="profile">Profile</a></li>
                <li><a href="#" data-tab="courses">My Courses</a></li>
                <li><a href="#" data-tab="attendance">Attendance</a></li>
                <li><a href="#" data-tab="cats">CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">Resources</a></li>
                <li><a href="#" data-tab="messages">Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Student!</h1>
                <p class="subtitle">Access your learning tools and updates</p>
            </header>

            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-banner">
                    <span class="info-icon">&#x2139;</span>
                    <strong>ADMIN MESSAGE:</strong>
                    <span id="admin-welcome-message">Loading message...</span>
                </div>
                
                <h2 style="margin-top: 30px;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-primary);" id="dashboard-attendance-rate">--%</p>
                        <small>Last 30 days</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-secondary);" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--color-info);" id="dashboard-new-resources">0</p>
                        <small>Last updated week</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #FBBF24; cursor: default; display: none;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for Anatomy 101.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #FBBF24;">View Resources</button>
                    </div>
                </div>
            </section>
            
            <section id="profile" class="tab-content">
                <h2>My Profile & Account</h2>
                <form id="profile-form">
                    
                    <div class="profile-media">
                        <img id="passport-preview" src="https://via.placeholder.com/150x150?text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        
                        <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                        
                        <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>

                        <p id="profile-status"></p>
                    </div>
                </form>
            </section>
            
            <section id="courses" class="tab-content">
                <h2>My Courses (Real-Time)</h2>
                <table>
                    <thead><tr><th>Course Name</th><th>Status</th></tr></thead>
                    <tbody id="courses-table">
                        <tr><td colspan="2">Loading courses...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="attendance" class="tab-content">
                <h2>Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Rotation</option>
                            <option value="Class">Class Session</option>
                            <option value="Call">On Call</option>
                            <option value="Virtual">Virtual Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Rotation/Course:</label>
                        <select id="attendance-target">
                            <option>Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Select a Session Type and then a specific Rotation or Course to check in at your current GPS location and time.</p>
                </div>

                <h2>Past Attendance Records (Old Table)</h2>
                <table>
                    <thead><tr><th>Course/Rotation</th><th>Type</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="attendance-table">
                        <tr><td colspan="4">Loading attendance records...</td></tr>
                    </tbody>
                </table>

                <h3>Geo Attendance History (Check-in Logs)</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Location (Friendly Name)</th><th>Accuracy (m)</th><th>Verified by Admin</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="5">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="cats" class="tab-content">
                <h2>CATS / Exams Schedule</h2>
                <table>
                    <thead><tr><th>Exam Name</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="exams-table">
                        <tr><td colspan="3">Loading exam schedule...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="resources" class="tab-content">
                <h2>Learning Resources (Filtered by Program)</h2>
                <div id="resources-list">Loading resources...</div>
            </section>

            <section id="messages" class="tab-content">
                <h2>Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>
                
                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>

   <script>
    // *************************************************************************
    // *** 1. CONFIGURATION & INITIALIZATION ***
    // *************************************************************************

    // !! WARNING: Replace these with your actual Supabase keys and URL !!
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Ppk';

    // Initialize Supabase client with full auth persistence
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storage: window.localStorage
        }
    });

    const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c';
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';

    // Mock/Fallback location for testing if Geo-API fails (e.g., NCHSM main campus)
    const FALLBACK_LAT = -1.286389; 
    const FALLBACK_LON = 36.817223;
    const FALLBACK_ACCURACY = 500;

    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = [];
    let cachedDepartments = [];
    let cachedRotations = [];

    // *************************************************************************
    // *** 2. DOM ELEMENTS & EVENT HANDLERS ***
    // *************************************************************************

    const geoMessage = document.getElementById('geo-message');
    const checkInButton = document.getElementById('check-in-button');
    const sessionTypeSelect = document.getElementById('session-type');
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const adminWelcomeMessage = document.getElementById('admin-welcome-message');
    const profileForm = document.getElementById('profile-form');
    const passportFileInput = document.getElementById('passport-file-input');
    const passportPreview = document.getElementById('passport-preview');
    const uploadButton = document.getElementById('upload-button');
    const profileStatus = document.getElementById('profile-status');
    const editProfileButton = document.getElementById('edit-profile-button');
    const saveProfileButton = document.getElementById('save-profile-button');
    const uploadLabel = document.getElementById('upload-label');
    const messageForm = document.getElementById('message-form');

    const navLinks = document.querySelectorAll('.nav a');
    const tabs = document.querySelectorAll('.tab-content');

    function showTab(tabId) {
        navLinks.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
        if(activeLink) activeLink.classList.add('active');

        tabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if(activeTab) activeTab.classList.add('active');
            
        // Trigger data loading only when a tab is shown
        if (tabId === 'profile' && currentUserId) loadProfile(currentUserId);
        if (tabId === 'attendance' && currentUserId) {
            updateTargetSelect();
            loadGeoAttendanceHistory(currentUserId);
            loadOldAttendanceRecords(currentUserId);
        }
        if (tabId === 'cats' && currentUserId) loadExams();
        if (tabId === 'resources' && currentUserId) loadResources();
        if (tabId === 'messages' && currentUserId) loadStudentMessages();
        if (tabId === 'courses' && currentUserId) loadCourses();
        if (tabId === 'dashboard' && currentUserId) {
            loadWelcomeMessage();
            loadDashboardMetrics(currentUserId);
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            showTab(link.dataset.tab);
        });
    });

    // Profile Edit Mode Toggle
    editProfileButton.addEventListener('click', () => {
        const fields = document.querySelectorAll('#profile-form input:not([type="file"]):not([readonly])');
        fields.forEach(field => field.readOnly = false);
        editProfileButton.style.display = 'none';
        saveProfileButton.style.display = 'block';
        uploadLabel.style.display = 'block';
    });

    // Handle profile form submission
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateProfile();
        
        // After save, return to read-only mode
        document.querySelectorAll('#profile-form input').forEach(field => {
             // Only make editable fields readonly again
            if (field.id !== 'profile-email' && field.id !== 'profile-program') {
                field.readOnly = true;
            }
        });
        editProfileButton.style.display = 'block';
        saveProfileButton.style.display = 'none';
        uploadLabel.style.display = 'none';
    });
    
    // Handle Passport file selection
    passportFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                passportPreview.src = e.target.result;
                uploadButton.style.display = 'block'; // Show save button when a new file is selected
            };
            reader.readAsDataURL(file);
        }
    });

    // Handle Photo upload
    uploadButton.addEventListener('click', uploadPassportPhoto);
    messageForm.addEventListener('submit', submitMessage);

    async function logout() {
        // Remove all active real-time subscriptions
        sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
        await sb.auth.signOut();
        window.location.href = "login.html";
    }

    // *************************************************************************
    // *** 3. CORE DATA AND DASHBOARD FUNCTIONS ***
    // *************************************************************************

    async function loadWelcomeMessage() {
        adminWelcomeMessage.textContent = 'Loading message...';
        try {
            const { data, error } = await sb
                .from('system_settings')
                .select('setting_value')
                .eq('setting_key', 'student_welcome')
                .single();

            if (error || !data) {
                console.warn("Could not load welcome message:", error?.message || 'No data');
                adminWelcomeMessage.textContent = 'The system message is currently unavailable. Please check back later.';
                return;
            }
            
            adminWelcomeMessage.innerHTML = data.setting_value || 'Welcome to the NCHSM Student Dashboard!';
        } catch (e) {
             adminWelcomeMessage.textContent = 'Error loading system message.';
             console.error('Welcome message fetch error:', e);
        }
    }
    
    async function loadDashboardMetrics(userId) {
        // Mock Data Loading (Replace with real Supabase calls if tables exist)
        document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;
        
        // This is a placeholder value. A real implementation needs a function 
        // that aggregates attendance logs.
        const attendanceRate = '94';
        document.getElementById('dashboard-attendance-rate').textContent = `${attendanceRate}%`;

        // Mock Upcoming Exam
        const mockExamDate = new Date();
        mockExamDate.setDate(mockExamDate.getDate() + 5);
        document.getElementById('dashboard-upcoming-exam').textContent = `${mockExamDate.toLocaleDateString('en-US')} (Anatomy)`;

        document.getElementById('dashboard-new-resources').textContent = '3';

        // Action Required Logic (Based on Profile completion)
        const actionRequiredEl = document.getElementById('dashboard-actions');
        const actionsTitleEl = document.getElementById('actions-title');
        const passportCard = document.getElementById('action-passport');

        // Check if the passport URL field is empty
        let profileIncomplete = !currentUserProfile?.passport_url;
        
        passportCard.style.display = profileIncomplete ? 'block' : 'none';
        
        // Hide the action section if no actions are required
        if (!profileIncomplete) {
             actionsTitleEl.style.display = 'none';
             actionRequiredEl.style.display = 'none';
        } else {
             actionsTitleEl.style.display = 'block';
             actionRequiredEl.style.display = 'flex';
        }
    }

    // Load list of all courses and clinical rotations for the attendance dropdowns
    async function loadAllAttendanceTargets() {
        // NOTE: This assumes you have 'courses' and 'clinical_rotations' tables
        try {
            const { data: coursesData, error: coursesError } = await sb
                .from('courses')
                .select('id, name')
                .order('name');
                
            const { data: rotationsData, error: rotationsError } = await sb
                .from('clinical_rotations')
                .select('id, name')
                .order('name');
            
            if (coursesError) console.error("Error loading courses:", coursesError);
            if (rotationsError) console.error("Error loading rotations:", rotationsError);

            cachedCourses = coursesData || [];
            cachedRotations = rotationsData || [];
            
        } catch (e) {
            console.error("Failed to load attendance targets:", e);
        }
    }
    
    // Updates the second dropdown based on the first (Session Type)
    function updateTargetSelect() {
        const type = sessionTypeSelect.value;
        attendanceTargetSelect.innerHTML = ''; // Clear previous options
        let targets = [];
        let labelText = 'Rotation/Course:';

        if (type === 'Clinical' || type === 'Call') {
            targets = cachedRotations;
            labelText = 'Clinical Rotation:';
        } else if (type === 'Class' || type === 'Virtual') {
            targets = cachedCourses;
            labelText = 'Course/Subject:';
        } else {
             attendanceTargetSelect.innerHTML = '<option>Select Session Type first...</option>';
             return;
        }

        document.getElementById('target-label').textContent = labelText;

        if (targets.length === 0) {
            attendanceTargetSelect.innerHTML = '<option>No targets found...</option>';
            checkInButton.disabled = true;
            return;
        }

        targets.forEach(target => {
            const option = document.createElement('option');
            option.value = target.id; // Assuming ID is the value
            option.textContent = target.name;
            attendanceTargetSelect.appendChild(option);
        });
        checkInButton.disabled = false;
    }


    // *************************************************************************
    // *** 4. AUTHENTICATION AND PROFILE MANAGEMENT (CRITICAL SECTION) ***
    // *************************************************************************

    async function loadInitialDataAndCheckAuth() {
        // 1. Load targets for the attendance tab first
        await loadAllAttendanceTargets();
        
        // 2. Check for an active user session
        const { data: { user }, error } = await sb.auth.getUser();

        if (error) {
            console.error("Error fetching user session:", error);
            window.location.href = 'login.html';
            return;
        }

        // 3. Handle Authentication Result
        if (user) {
            currentUserId = user.id;
            
            // This is the core data load and authorization gate
            const authCheckPassed = await loadProfile(currentUserId);
            
            if (authCheckPassed) {
                 // If authenticated AND approved, show dashboard
                showTab('dashboard');
            }
             // NOTE: If authCheckPassed is false, loadProfile handled the redirect/sign out.
             
        } else {
            // If no user session is found, redirect to login
            window.location.href = 'login.html';
        }
    }

    // ** MODIFIED loadProfile function with the 'approved' check **
    async function loadProfile(userId) {
        profileStatus.textContent = 'Loading profile details...';
        
        try {
            // Fetch profile data AND join the auth.users table to get the 'approved' flag
            const { data, error } = await sb
                .from('profiles')
                .select(`
                    id, 
                    full_name, 
                    phone, 
                    program, 
                    semester, 
                    passport_url, 
                    auth_user:auth.users!inner(email, approved)
                `)
                .eq('id', userId)
                .single();

            if (error || !data) {
                console.error("Error loading profile:", error?.message || 'No profile data found');
                profileStatus.textContent = 'Failed to load profile. Please contact IT.';
                await sb.auth.signOut();
                window.location.href = 'login.html';
                return false;
            }
            
            // *** CRITICAL AUTHORIZATION CHECK ***
            const isApproved = data.auth_user?.approved;
            
            if (isApproved !== true) {
                console.warn("User is authenticated but NOT approved. Redirecting.");
                profileStatus.textContent = 'Your account is pending administrator approval.';
                
                // Alert and redirect
                alert("Your account is pending administrator approval. You will be logged out now.");
                await sb.auth.signOut(); 
                window.location.href = 'login.html';
                return false; // Authorization failed
            }
            // **********************************

            // If approved, proceed to load data
            currentUserProfile = {
                ...data,
                email: data.auth_user.email,
                approved: isApproved
            };
            
            profileStatus.textContent = 'Profile loaded successfully.';

            // Populate form fields
            document.getElementById('profile-name').value = data.full_name || '';
            document.getElementById('profile-email').value = data.auth_user.email || '';
            document.getElementById('profile-phone').value = data.phone || '';
            document.getElementById('profile-program').value = data.program || '';

            // Update dashboard header
            document.querySelector('header h1').textContent = `Welcome, ${data.full_name?.split(' ')[0] || 'Student'}!`;

            // Load passport photo
            if (data.passport_url) {
                const { data: fileData } = sb.storage.from('passport_photos').getPublicUrl(data.passport_url);
                passportPreview.src = fileData.publicUrl;
                document.getElementById('action-passport').style.display = 'none'; // Hide passport action
            } else {
                 passportPreview.src = "https://via.placeholder.com/150x150?text=NO+PHOTO";
                 document.getElementById('action-passport').style.display = 'block'; // Show passport action
            }
            
            // Set fields to read-only initially
            document.querySelectorAll('#profile-form input').forEach(field => {
                // Keep email and program readonly always
                if (field.id === 'profile-email' || field.id === 'profile-program') {
                    field.readOnly = true;
                } else {
                     field.readOnly = true;
                }
            });

            return true; // Authorization succeeded

        } catch (e) {
            console.error("An unexpected error occurred in loadProfile:", e);
            profileStatus.textContent = 'A critical error occurred. Logging out.';
            await sb.auth.signOut();
            window.location.href = 'login.html';
            return false;
        }
    }

    async function updateProfile() {
        const fullName = document.getElementById('profile-name').value.trim();
        const phone = document.getElementById('profile-phone').value.trim();
        
        profileStatus.textContent = 'Saving changes...';

        try {
            const { error } = await sb
                .from('profiles')
                .update({ full_name: fullName, phone: phone })
                .eq('id', currentUserId);

            if (error) throw error;

            profileStatus.textContent = 'Profile updated successfully!';
            // Reload profile data to update currentUserProfile global variable
            await loadProfile(currentUserId); 

        } catch (error) {
            profileStatus.textContent = `Update failed: ${error.message}`;
            console.error('Update Profile Error:', error);
        }
    }
    
    async function uploadPassportPhoto() {
        const file = passportFileInput.files[0];
        if (!file) return;

        profileStatus.textContent = 'Uploading photo...';
        uploadButton.disabled = true;

        const fileExt = file.name.split('.').pop();
        const filePath = `${currentUserId}.${fileExt}`;

        try {
            // 1. Upload file to Supabase Storage
            const { error: uploadError } = await sb.storage
                .from('passport_photos')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true // Overwrite existing file
                });

            if (uploadError) throw uploadError;

            // 2. Update the 'profiles' table with the new file path
            const { error: updateError } = await sb
                .from('profiles')
                .update({ passport_url: filePath })
                .eq('id', currentUserId);

            if (updateError) throw updateError;

            profileStatus.textContent = 'Photo uploaded and profile updated successfully!';
            
            // Reload profile to update UI
            await loadProfile(currentUserId);
            uploadButton.style.display = 'none';

        } catch (error) {
            profileStatus.textContent = `Photo upload failed: ${error.message}`;
            console.error('Photo Upload Error:', error);
        } finally {
            uploadButton.disabled = false;
        }
    }


    // *************************************************************************
    // *** 5. ATTENDANCE FUNCTIONS ***
    // *************************************************************************
    
    // Reverse Geocoding API call
    async function getFriendlyLocation(lat, lon) {
        const url = `${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${lat}&lon=${lon}&format=json`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            // Use address components to create a friendly name
            const display_name = data.address.road || data.address.neighbourhood || data.address.county || data.display_name;
            return display_name;
        } catch (e) {
            console.error('Reverse geocoding failed:', e);
            return 'Unknown Location';
        }
    }

    // Main Check-in function
    function geoCheckIn() {
        geoMessage.textContent = 'Attempting to get your precise location...';
        checkInButton.disabled = true;
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    handleGeolocationSuccess(position);
                },
                error => {
                    handleGeolocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            geoMessage.textContent = 'Geolocation is not supported by your browser.';
            checkInButton.disabled = false;
        }
    }

    async function handleGeolocationSuccess(position) {
        const { latitude, longitude, accuracy } = position.coords;
        const targetId = attendanceTargetSelect.value;
        const sessionType = sessionTypeSelect.value;
        const targetName = attendanceTargetSelect.options[attendanceTargetSelect.selectedIndex].textContent;

        if (!targetId) {
            geoMessage.textContent = 'Please select a valid Session Type and Target.';
            checkInButton.disabled = false;
            return;
        }

        geoMessage.textContent = `Location found (Accuracy: ${accuracy.toFixed(1)}m). Checking in...`;

        const friendlyLocation = await getFriendlyLocation(latitude, longitude);

        try {
            // Insert the attendance log into a 'geo_check_ins' table
            const { error } = await sb
                .from('geo_check_ins')
                .insert([
                    {
                        user_id: currentUserId,
                        session_type: sessionType,
                        target_id: targetId,
                        target_name: targetName,
                        latitude: latitude,
                        longitude: longitude,
                        accuracy: accuracy,
                        location_name: friendlyLocation
                    }
                ]);

            if (error) throw error;

            geoMessage.textContent = `Check-in successful for ${targetName} at ${friendlyLocation}!`;
            loadGeoAttendanceHistory(currentUserId); // Refresh the history table

        } catch (e) {
            geoMessage.textContent = `Check-in failed: ${e.message}`;
            console.error('Check-in error:', e);
        } finally {
            checkInButton.disabled = false;
        }
    }

    function handleGeolocationError(error) {
        let message = 'Geolocation failed. ';
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message += "You must allow location access to check in.";
                break;
            case error.POSITION_UNAVAILABLE:
                message += "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                message += "The request to get user location timed out.";
                break;
            default:
                message += `An unknown error occurred (Code: ${error.code}).`;
                break;
        }
        
        // Provide a fallback option for IT if needed (for remote/virtual check-ins)
        message += " If you are having issues, please contact IT.";
        geoMessage.textContent = message;
        checkInButton.disabled = false;
    }
    
    // Load recent geo check-in history
    async function loadGeoAttendanceHistory(userId) {
        const historyTableBody = document.getElementById('geo-attendance-history');
        historyTableBody.innerHTML = '<tr><td colspan="5">Loading geo check-in history...</td></tr>';
        
        try {
            const { data, error } = await sb
                .from('geo_check_ins')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(10); // Show last 10 records

            if (error) throw error;

            historyTableBody.innerHTML = '';
            if (data.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="5">No recent check-in records found.</td></tr>';
                return;
            }

            data.forEach(record => {
                const row = historyTableBody.insertRow();
                row.insertCell().textContent = new Date(record.created_at).toLocaleString();
                row.insertCell().textContent = record.session_type;
                row.insertCell().textContent = record.location_name;
                row.insertCell().textContent = record.accuracy.toFixed(1);
                row.insertCell().textContent = record.is_verified ? 'Yes' : 'Pending';
            });
        } catch (e) {
            historyTableBody.innerHTML = `<tr><td colspan="5">Error loading history: ${e.message}</td></tr>`;
            console.error('Load Geo History Error:', e);
        }
    }
    
    // Placeholder function for old/legacy attendance records (if applicable)
    async function loadOldAttendanceRecords(userId) {
         // This function is for demonstration and assumes another table ('attendance_legacy')
         const tableBody = document.getElementById('attendance-table');
         tableBody.innerHTML = '<tr><td colspan="4">No legacy attendance records available.</td></tr>';
    }


    // *************************************************************************
    // *** 6. OTHER TAB FUNCTIONS (MOCK DATA) ***
    // *************************************************************************

    async function loadCourses() {
        const coursesTableBody = document.getElementById('courses-table');
        coursesTableBody.innerHTML = '<tr><td colspan="2">Loading courses...</td></tr>';
        
        // Mock data for demonstration
        const mockCourses = [
            { name: "Anatomy & Physiology 101", status: "Active" },
            { name: "Clinical Skills Lab 202", status: "Active" },
            { name: "Medical Ethics 301", status: "status: "Completed" }
        ];

        coursesTableBody.innerHTML = '';
        mockCourses.forEach(course => {
            const row = coursesTableBody.insertRow();
            row.insertCell().textContent = course.name;
            row.insertCell().textContent = course.status;
        });
        
        // Update the cached list of courses
        cachedCourses = mockCourses;
    }

    async function loadExams() {
        const examsTableBody = document.getElementById('exams-table');
        examsTableBody.innerHTML = '<tr><td colspan="3">Loading exam schedule...</td></tr>';
        
        // Mock data
        const mockExams = [
            { name: "Mid-Term (A&P 101)", date: "2025-10-15", status: "Upcoming" },
            { name: "Final CAT (Ethics)", date: "2025-11-01", status: "Scheduled" },
            { name: "OSCE Skills Test", date: "2025-09-20", status: "Completed" }
        ];

        examsTableBody.innerHTML = '';
        mockExams.forEach(exam => {
            const row = examsTableBody.insertRow();
            row.insertCell().textContent = exam.name;
            row.insertCell().textContent = new Date(exam.date).toLocaleDateString('en-US');
            row.insertCell().textContent = exam.status;
        });
    }

    async function loadResources() {
         const resourcesList = document.getElementById('resources-list');
         resourcesList.innerHTML = 'Loading resources...';

         // Filter by the student's program for a personalized list
         const studentProgram = currentUserProfile?.program || 'General';
         
         // Mock resource data
         const mockResources = [
             { name: "A&P Unit 3 Handout", link: "#", program: "General", date: "2025-10-01" },
             { name: "Clinical Skills Video Library", link: "#", program: "Clinical", date: "2025-09-25" },
             { name: "Program Orientation Guide", link: "#", program: "General", date: "2025-09-01" }
         ];

         const filteredResources = mockResources.filter(r => r.program === 'General' || r.program === studentProgram);

         resourcesList.innerHTML = filteredResources.map(r => `
             <div class="card" style="margin-bottom: 15px; cursor: pointer; border-left-color: #3B82F6;" onclick="window.open('${r.link}', '_blank')">
                 <h3>${r.name}</h3>
                 <small>Posted: ${new Date(r.date).toLocaleDateString()} | Program: ${r.program}</small>
             </div>
         `).join('');
    }

    async function submitMessage(e) {
        e.preventDefault();
        const messageBody = document.getElementById('student-message-body');
        const messageStatus = document.getElementById('message-status');

        if (!messageBody.value.trim()) return;

        messageStatus.textContent = 'Sending message...';
        messageForm.querySelector('button').disabled = true;

        try {
            const { error } = await sb
                .from('student_messages')
                .insert([
                    {
                        sender_id: currentUserId,
                        sender_name: currentUserProfile.full_name,
                        message_body: messageBody.value.trim()
                    }
                ]);

            if (error) throw error;

            messageStatus.textContent = 'Message sent successfully! You will receive a response soon.';
            messageBody.value = ''; // Clear the textarea
            loadStudentMessages(); // Refresh message list

        } catch (error) {
            messageStatus.textContent = `Error sending message: ${error.message}`;
            console.error('Message Send Error:', error);
        } finally {
            messageForm.querySelector('button').disabled = false;
        }
    }

    async function loadStudentMessages() {
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = 'Loading messages...';
        
        try {
            const { data, error } = await sb
                .from('student_messages')
                .select('message_body, created_at, response_body')
                .eq('sender_id', currentUserId)
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            messagesList.innerHTML = '';
            if (data.length === 0) {
                 messagesList.innerHTML = '<p style="font-style: italic; margin-top: 20px;">No message history found.</p>';
                 return;
            }

            data.forEach(msg => {
                const messageCard = document.createElement('div');
                messageCard.className = 'card';
                messageCard.style.cursor = 'default';
                messageCard.style.marginBottom = '20px';
                
                const responseHtml = msg.response_body 
                    ? `<p style="color: var(--color-secondary); border-left: 2px solid var(--color-secondary); padding-left: 10px; margin-top: 10px;">
                       <strong>Admin Response:</strong> ${msg.response_body}
                       </p>`
                    : '<p style="color: var(--color-info); font-style: italic; margin-top: 10px;">Awaiting response...</p>';

                messageCard.innerHTML = `
                    <h3>Your Message (${new Date(msg.created_at).toLocaleDateString()})</h3>
                    <p>${msg.message_body}</p>
                    ${responseHtml}
                `;
                messagesList.appendChild(messageCard);
            });

        } catch (error) {
             messagesList.innerHTML = `<p style="color: red;">Failed to load messages: ${error.message}</p>`;
             console.error('Load Messages Error:', error);
        }
    }


    // *************************************************************************
    // *** 7. INITIALIZATION ***
    // *************************************************************************
    
    // Start the application lifecycle when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', loadInitialDataAndCheckAuth);
    
    </script>
</body>
</html>
