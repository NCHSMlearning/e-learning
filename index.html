<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NCHSM Student Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"></noscript>
<style>
body, html{margin:0;padding:0;font-family:'Inter',sans-serif;background:#f5f5f5;color:#333}
.container{display:flex;min-height:100vh}
.sidebar{width:220px;background:#1b1b2f;color:#fff;display:flex;flex-direction:column;justify-content:space-between}
.sidebar-header{text-align:center;padding:20px}
.sidebar-header img{width:80px;margin-bottom:10px}
.nav{list-style:none;padding:0;margin:0}
.nav li{margin:0}
.nav a{display:block;padding:12px 20px;color:#fff;text-decoration:none;transition:0.2s}
.nav a.active, .nav a:hover{background:#272747}
.logout{text-align:center;padding:20px}
.logout a{color:#fff;cursor:pointer;text-decoration:none}
.main{flex:1;padding:20px;overflow:auto}
.tab-content{display:none}
.tab-content.active{display:block}
h1,h2{margin:10px 0}
.cards{display:flex;gap:15px;flex-wrap:wrap;margin:20px 0}
.card{background:#fff;padding:20px;border-radius:8px;flex:1;min-width:120px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
th{background:#f0f0f0}
.form-field{margin-bottom:15px}
.form-field label{display:block;margin-bottom:5px;font-weight:500}
.form-field input, .form-field select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
.profile-button{padding:10px 20px;background:#1b1b2f;color:#fff;border:none;border-radius:4px;cursor:pointer}
.profile-button:hover{background:#272747}
.profile-details{max-width:400px}
.profile-media img{width:150px;height:150px;border-radius:50%;object-fit:cover;margin-top:20px}
.check-in-controls{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);margin-bottom:15px}
.control-group{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.control-group label{margin:0}
#geo-message{margin-top:10px;color:green}
</style>
</head>
<body>
<div class="container">
<aside class="sidebar">
    <div>
        <div class="sidebar-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Nakuru_County_Logo.png" alt="NCHSM Logo">
            <h2>NCHSM Dashboard</h2>
        </div>
        <ul class="nav">
            <li><a href="#" class="active" data-tab="dashboard-tab">Dashboard</a></li>
            <li><a href="#" data-tab="courses-tab">Courses</a></li>
            <li><a href="#" data-tab="attendance-tab">Attendance</a></li>
            <li><a href="#" data-tab="geo-attendance-tab">Geo Attendance</a></li>
            <li><a href="#" data-tab="exams-tab">Exams</a></li>
            <li><a href="#" data-tab="resources-tab">Resources</a></li>
            <li><a href="#" data-tab="messages-tab">Messages</a></li>
            <li><a href="#" data-tab="profile-tab">Profile</a></li>
        </ul>
    </div>
    <div class="logout">
        <a id="logout">Logout</a>
    </div>
</aside>
<main class="main">
<header>
    <h1>Welcome, <span id="student-name">Student</span></h1>
    <p class="subtitle">Manage your learning and track progress.</p>
</header>

<div id="dashboard-tab" class="tab-content active">
    <div class="cards">
        <div class="card" id="total-courses"><h3>Courses</h3><p id="total-courses-count">0</p></div>
        <div class="card" id="total-attendance"><h3>Attendance Logs</h3><p id="total-attendance-count">0</p></div>
        <div class="card" id="total-exams"><h3>Exams</h3><p id="total-exams-count">0</p></div>
        <div class="card" id="total-resources"><h3>Resources</h3><p id="total-resources-count">0</p></div>
        <div class="card" id="total-messages"><h3>Messages</h3><p id="total-messages-count">0</p></div>
    </div>
</div>

<div id="courses-tab" class="tab-content">
<h2>Your Courses</h2>
<table><thead><tr><th>Course Name</th><th>Instructor</th><th>Status</th></tr></thead><tbody id="courses-tbody"></tbody></table>
</div>

<div id="attendance-tab" class="tab-content">
<h2>Attendance Logs</h2>
<table><thead><tr><th>Date</th><th>Course</th><th>Status</th></tr></thead><tbody id="attendance-tbody"></tbody></table>
</div>

<div id="geo-attendance-tab" class="tab-content">
<h2>Geo Attendance Check-In</h2>
<div class="check-in-controls">
    <div class="control-group">
        <label for="geo-session-type">Session Type:</label>
        <select id="geo-session-type"><option value="lecture">Lecture</option><option value="practical">Practical</option></select>
        <label for="geo-target">Target:</label>
        <select id="geo-target"></select>
        <button id="geo-check-in">Check In</button>
    </div>
    <div id="geo-message"></div>
</div>
<h2>Check-In History</h2>
<table><thead><tr><th>Date & Time</th><th>Session</th><th>Location</th><th>Accuracy</th><th>Verified</th></tr></thead>
<tbody id="geo-attendance-history"></tbody></table>
</div>

<div id="exams-tab" class="tab-content">
<h2>Your Exams</h2>
<table><thead><tr><th>Exam Name</th><th>Course</th><th>Date</th><th>Status</th></tr></thead>
<tbody id="exams-tbody"></tbody></table>
</div>

<div id="resources-tab" class="tab-content">
<h2>Your Resources</h2>
<table><thead><tr><th>Title</th><th>Type</th><th>Uploaded On</th><th>Action</th></tr></thead>
<tbody id="resources-tbody"></tbody></table>
</div>

<div id="messages-tab" class="tab-content">
<h2>Messages</h2>
<table><thead><tr><th>From</th><th>Subject</th><th>Date</th><th>Status</th></tr></thead>
<tbody id="messages-tbody"></tbody></table>
</div>

<div id="profile-tab" class="tab-content">
<h2>Profile</h2>
<form id="profile-form">
    <div class="profile-details">
        <div class="form-field"><label>Full Name</label><input type="text" id="profile-fullname"></div>
        <div class="form-field"><label>Email</label><input type="email" id="profile-email"></div>
        <div class="form-field"><label>Phone</label><input type="tel" id="profile-phone"></div>
        <div class="form-field"><label>Program / Course of Study</label><input type="text" id="profile-program" readonly></div>
        <button type="button" class="profile-button" id="save-profile">Save Profile</button>
    </div>
    <div class="profile-media">
        <img src="" id="passport-preview" alt="Profile Picture">
    </div>
</form>
</div>
</main>
</div>

<script>
const SUPABASE_URL = 'https://lwhtjozfsmbyihenfwnw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c';
const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';

document.querySelectorAll('.nav a').forEach(tabLink=>{
    tabLink.addEventListener('click',e=>{
        e.preventDefault();
        document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
        tabLink.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
        document.getElementById(tabLink.dataset.tab).classList.add('active');
        if(tabLink.dataset.tab==='geo-attendance-tab') loadGeoTargets();
    });
});

document.getElementById('logout').addEventListener('click',async()=>{
    await sb.auth.signOut();
    location.reload();
});

async function loadProfile(){
    const user = sb.auth.user();
    if(!user) return;
    const { data: profile } = await sb.from('profiles').select('*').eq('id',user.id).single();
    if(profile){
        document.getElementById('student-name').textContent = profile.full_name;
        document.getElementById('profile-fullname').value = profile.full_name;
        document.getElementById('profile-email').value = profile.email;
        document.getElementById('profile-phone').value = profile.phone;
        document.getElementById('passport-preview').src = profile.passport_url||'https://via.placeholder.com/150';
        document.getElementById('profile-program').value = profile.program||'N/A';
    }
}

document.getElementById('save-profile').addEventListener('click',async()=>{
    const user = sb.auth.user();
    if(!user) return alert('No user logged in.');
    const { error } = await sb.from('profiles').update({
        full_name: document.getElementById('profile-fullname').value,
        email: document.getElementById('profile-email').value,
        phone: document.getElementById('profile-phone').value
    }).eq('id',user.id);
    if(error) alert('Profile update failed: '+error.message);
    else alert('Profile updated successfully');
});

async function loadDashboardCounts(){
    const user = sb.auth.user();
    if(!user) return;
    const studentId = user.id;
    const [{ data: courses },{ data: attendance },{ data: exams },{ data: resources },{ data: messages }] = await Promise.all([
        sb.from('courses').select('*').eq('student_id', studentId),
        sb.from('attendance_logs').select('*').eq('student_id', studentId),
        sb.from('exams').select('*').eq('student_id', studentId),
        sb.from('resources').select('*').eq('student_id', studentId),
        sb.from('messages').select('*').eq('recipient_id', studentId)
    ]);
    document.getElementById('total-courses-count').textContent = courses?.length||0;
    document.getElementById('total-attendance-count').textContent = attendance?.length||0;
    document.getElementById('total-exams-count').textContent = exams?.length||0;
    document.getElementById('total-resources-count').textContent = resources?.length||0;
    document.getElementById('total-messages-count').textContent = messages?.length||0;

    const coursesTbody=document.getElementById('courses-tbody'); coursesTbody.innerHTML='';
    courses?.forEach(c=>{coursesTbody.innerHTML+=`<tr><td>${c.name}</td><td>${c.instructor}</td><td>${c.status}</td></tr>`});

    const attendanceTbody=document.getElementById('attendance-tbody'); attendanceTbody.innerHTML='';
    attendance?.forEach(a=>{attendanceTbody.innerHTML+=`<tr><td>${new Date(a.date).toLocaleDateString()}</td><td>${a.course_name}</td><td>${a.status}</td></tr>`});

    const examsTbody=document.getElementById('exams-tbody'); examsTbody.innerHTML='';
    exams?.forEach(ex=>{examsTbody.innerHTML+=`<tr><td>${ex.name}</td><td>${ex.course_name}</td><td>${new Date(ex.date).toLocaleDateString()}</td><td>${ex.status}</td></tr>`});

    const resourcesTbody=document.getElementById('resources-tbody'); resourcesTbody.innerHTML='';
    resources?.forEach(r=>{resourcesTbody.innerHTML+=`<tr><td>${r.title}</td><td>${r.type}</td><td>${new Date(r.uploaded_on).toLocaleDateString()}</td><td><a href="${r.file_url}" target="_blank">View</a></td></tr>`});

    const messagesTbody=document.getElementById('messages-tbody'); messagesTbody.innerHTML='';
    messages?.forEach(m=>{messagesTbody.innerHTML+=`<tr><td>${m.sender_name}</td><td>${m.subject}</td><td>${new Date(m.date_sent).toLocaleString()}</td><td>${m.read?'Read':'Unread'}</td></tr>`});
}

async function loadGeoTargets(){
    const targetsSelect=document.getElementById('geo-target'); targetsSelect.innerHTML='';
    const { data: targets } = await sb.from('courses').select('id,name').eq('student_id', sb.auth.user().id);
    targets?.forEach(t=>{targetsSelect.innerHTML+=`<option value="${t.id}|${t.name}">${t.name}</option>`});
}

document.getElementById('geo-check-in').addEventListener('click', async ()=>{
    const button=document.getElementById('geo-check-in'); const geoMessage=document.getElementById('geo-message');
    button.disabled=true; geoMessage.textContent='Getting location...';
    const sessionType=document.getElementById('geo-session-type').value;
    const targetSelect=document.getElementById('geo-target').value;
    const checkInTime=new Date().toISOString();
    try{
        const pos=await new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true,timeout:10000}));
        const [targetId,targetName]=targetSelect.split('|');
        const locResponse=await fetch(`${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
        const locData=await locResponse.json();
        const address=locData.display_name||`${pos.coords.latitude},${pos.coords.longitude}`;
        const { error }=await sb.from('geo_attendance_logs').insert([{
            student_id: sb.auth.user().id,
            session_type: sessionType,
            target_id: targetId,
            target_name: targetName,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            location_name: address,
            check_in_time: checkInTime,
            verified: false
        }]);
        if(error) geoMessage.textContent='Check-in failed: '+error.message;
        else { geoMessage.textContent='Checked in successfully.'; loadGeoAttendanceHistory(); }
    }catch(err){ geoMessage.textContent='Location error: '+err.message; }
    finally{ button.disabled=false; }
});

async function loadGeoAttendanceHistory(){
    const tbody=document.getElementById('geo-attendance-history'); tbody.innerHTML='';
    const { data, error } = await sb.from('geo_attendance_logs').select('*').eq('student_id', sb.auth.user().id).order('check_in_time',{ascending:false});
    if(error || !data || data.length===0){tbody.innerHTML='<tr><td colspan="5">No check-ins recorded.</td></tr>'; return;}
    data.forEach(log=>{
        tbody.innerHTML+=`<tr>
            <td>${new Date(log.check_in_time).toLocaleString()}</td>
            <td>${log.session_type}</td>
            <td>${log.location_name || log.target_name}</td>
            <td>${log.accuracy || '-'}</td>
            <td>${log.verified? 'Yes':'No'}</td>
        </tr>`;
    });
}

sb.auth.onAuthStateChange((_event, session)=>{
    if(!session){ alert('Please login to access dashboard'); return; }
    loadProfile();
    loadDashboardCounts();
    loadGeoAttendanceHistory();
});
</script>
</body>
</html>
