<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Digital Student Dashboard</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="indexstyle.css">
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <div class="header-title-container">
            <span>NCHSM Digital Student Portal</span>
            <img 
                id="header-passport-preview" 
                src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" 
                alt="Profile Photo" 
                class="header-profile-photo"
            />
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="overlay" onclick="closeMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <div id="welcome-section" class="welcome-card">
                    <h2 id="welcome-header">Welcome back, Student!</h2>
                    <p id="student-welcome-message">Access your courses, schedule, and check your attendance status.</p>
                </div>

                <div id="announcement-banner">
                    <span class="info-icon">üì£</span>
                    <div>
                        <strong>Official Announcement:</strong>
                        <p id="student-announcement">Loading latest announcement...</p>
                    </div>
                </div>

                <h2 style="margin-top: 20px; color: var(--color-primary); font-weight: 700;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card alert-card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Verified Check-ins: <strong id="dashboard-verified-count">0</strong> / <strong id="dashboard-total-count">0</strong></small>
                        <small style="display:block; margin-top: 5px; color:var(--color-alert);">Pending Review: <strong id="dashboard-pending-count">0</strong></small>
                    </div>

                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 700; color: #F97316;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>

                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>

                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last 7 days</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: var(--color-primary); font-weight: 700;">Action Required</h2>
                <div id="dashboard-actions">
                    <div id="action-passport" class="card" style="border-left-color: var(--color-alert); cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    
                    <div class="card" style="border-left-color: var(--color-warning); cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: var(--color-warning);">View Resources</button>
                    </div>
                    
                    <div id="latest-announcement-card" class="card" style="border-left-color: var(--color-success); display: none; cursor: pointer;">
                        <h4><span id="announcement-title" style="color: var(--color-primary);">Loading...</span></h4>
                        <p id="announcement-body" style="margin-bottom: 10px;">Loading message body...</p>
                        <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                            <span id="announcement-date"></span> | 
                            <span id="announcement-status" style="font-weight: bold;"></span>
                        </div>
                        <button onclick="showTab('messages')" class="profile-button" style="background-color: var(--color-primary); margin-top: 15px;">Go to Messages Tab</button>
                    </div>
                </div>
            </section>

            <!-- Profile Tab -->
            <section id="profile" class="tab-content">
                <h2 style="color: var(--color-primary);">My Profile & Account</h2>
                <form id="profile-form">
                    <div class="profile-media">
                        <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>
                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>

            <!-- Calendar Tab -->
            <section id="calendar" class="tab-content">
                <h2 style="color: var(--color-primary);">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter" onchange="loadAcademicCalendar()">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <div style="overflow-x: auto;"> 
                    <table>
                        <thead>
                            <tr>
                                <th class="date-col">Date & Time</th>
                                <th>Event / Details</th>
                                <th class="session-type-col">Type</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-table">
                            <tr><td colspan="3">Loading academic schedule...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses Tab -->
            <section id="courses" class="tab-content">
                <h2 style="color: var(--color-primary);">My Courses</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Unit Code</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table">
                            <tr><td colspan="4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Attendance Tab -->
            <section id="attendance" class="tab-content">
                <h2 style="color: var(--color-primary);">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>

                    <p id="geo-message">Select a <strong>Session Type</strong> and then a specific <strong>Department or Course</strong> to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: var(--color-primary);">Past Attendance History (Check-in Logs)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Session Type</th>
                                <th>Target</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="geo-attendance-history">
                            <tr><td colspan="4">Loading geo check-in history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Exams Tab -->
            <section id="cats" class="tab-content">
                <h2 style="color: var(--color-primary); font-size: 1.6rem; margin-bottom: 5px;">CATS / Exams & Grades</h2>
                <p style="color: #6B7280; margin-bottom: 20px;">Provisional results</p>

                <div class="exam-controls" style="margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
                    <label for="exam-type-filter" style="font-weight:600; color:#374151;">Filter by Type:</label>
                    <select id="exam-type-filter" onchange="loadExams()" 
                            style="padding:6px 10px; border:1px solid #D1D5DB; border-radius:6px; background:white; color:#111827;">
                        <option value="all">Show All (CATS & Exams)</option>
                        <option value="CAT">Show Only CATS</option>
                        <option value="Final">Show Only Final Exams</option>
                    </select>
                </div>

                <div style="overflow-x: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius:8px;">
                    <table id="exams-grades-table" style="width:100%; border-collapse:collapse; min-width:700px;">
                        <thead style="background-color:#F3F4F6; color:#111827; font-weight:600;">
                            <tr>
                                <th style="padding:10px 12px;">Exam Name</th>
                                <th style="padding:10px 12px;">Block</th>
                                <th style="padding:10px 12px;">Date</th>
                                <th style="padding:10px 12px;">Status</th>
                                <th style="padding:10px 12px;">CAT 1</th>
                                <th style="padding:10px 12px;">CAT 2</th>
                                <th style="padding:10px 12px;">Final Exam</th>
                                <th style="padding:10px 12px;">Total (%)</th>
                                <th style="padding:10px 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table" style="background:white;">
                            <tr>
                                <td colspan="9" style="padding:12px; text-align:center; color:#6B7280;">Loading your exams and grades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Resources Tab - ENHANCED FOR MOBILE -->
            <section id="resources" class="tab-content">
                <div class="resources-header">
                    <h2 style="color: var(--color-primary); margin-bottom: 8px;">Learning Resources</h2>
                    <p class="subtitle" style="margin-bottom: 20px;">Access your course materials and study resources</p>
                    
                    <!-- Mobile Filter Controls -->
                    <div class="mobile-resource-controls">
                        <div class="filter-group">
                            <label for="resource-type-filter">Filter by Type:</label>
                            <select id="resource-type-filter" class="resource-filter">
                                <option value="all">All Types</option>
                                <option value="pdf">PDF Documents</option>
                                <option value="video">Videos</option>
                                <option value="image">Images</option>
                                <option value="document">Documents</option>
                                <option value="presentation">Presentations</option>
                            </select>
                        </div>
                        
                        <div class="sort-group">
                            <label for="resource-sort">Sort by:</label>
                            <select id="resource-sort" class="resource-filter">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name">Name A-Z</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="resources-container">
                    <!-- Resources List - Mobile Optimized -->
                    <div id="resources-list" class="resources-sidebar">
                        <div class="resources-count">
                            <i class="fas fa-file-alt"></i>
                            <span><strong id="resources-count">0</strong> resources available</span>
                            <div class="mobile-view-toggle">
                                <button class="view-btn active" data-view="list">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="view-btn" data-view="grid">
                                    <i class="fas fa-th"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="resources-search">
                            <input type="text" id="resource-search" placeholder="Search resources..." class="search-input">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        
                        <div class="resources-list" id="resources-list-container">
                            <!-- Resources will be loaded here dynamically -->
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading resources...
                            </div>
                        </div>
                    </div>

                    <!-- Resource Preview - Enhanced for Mobile -->
                    <div id="resource-viewer" class="resource-preview">
                        <div class="preview-placeholder">
                            <div class="placeholder-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <h3>Select a Resource</h3>
                            <p>Choose a resource from the list to view its content</p>
                        </div>
                        
                        <!-- Active Resource Viewer -->
                        <div class="active-resource" style="display: none;">
                            <div class="resource-header">
                                <div class="resource-meta">
                                    <h3 id="resource-title">Resource Title</h3>
                                    <div class="resource-info">
                                        <span class="resource-type" id="resource-type">PDF</span>
                                        <span class="resource-size" id="resource-size">2.4 MB</span>
                                        <span class="resource-date" id="resource-date">Jan 15, 2024</span>
                                    </div>
                                </div>
                                <div class="resource-actions">
                                    <button class="action-btn fullscreen-btn" id="fullscreen-resource">
                                        <i class="fas fa-expand"></i>
                                        Full Screen
                                    </button>
                                    <button class="action-btn bookmark-btn" id="bookmark-resource">
                                        <i class="fas fa-bookmark"></i>
                                        Bookmark
                                    </button>
                                </div>
                            </div>
                            
                            <div class="preview-container">
                                <!-- PDF Preview -->
                                <div id="pdf-preview" class="preview-content" style="display: none;">
                                    <div class="pdf-controls">
                                        <button id="prev-page" class="page-btn">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="page-info">
                                            Page <span id="page-num">1</span> of <span id="page-count">1</span>
                                        </span>
                                        <button id="next-page" class="page-btn">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="page-btn zoom-out" id="zoom-out">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button class="page-btn zoom-in" id="zoom-in">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                    </div>
                                    <div class="pdf-viewer">
                                        <canvas id="pdf-canvas"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Image Preview -->
                                <div id="image-preview" class="preview-content" style="display: none;">
                                    <div class="image-controls">
                                        <button class="action-btn zoom-btn" id="image-zoom">
                                            <i class="fas fa-search-plus"></i>
                                            Zoom
                                        </button>
                                    </div>
                                    <div class="image-viewer">
                                        <img id="preview-image" src="" alt="Resource Image">
                                    </div>
                                </div>
                                
                                <!-- Video Preview -->
                                <div id="video-preview" class="preview-content" style="display: none;">
                                    <div class="video-controls">
                                        <button class="action-btn fullscreen-btn" id="video-fullscreen">
                                            <i class="fas fa-expand"></i>
                                            Full Screen
                                        </button>
                                    </div>
                                    <div class="video-viewer">
                                        <video id="preview-video" controls>
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>
                                </div>
                                
                                <!-- Document Preview (Office files) -->
                                <div id="office-preview" class="preview-content" style="display: none;">
                                    <div class="office-controls">
                                        <button class="action-btn fullscreen-btn" id="office-fullscreen">
                                            <i class="fas fa-expand"></i>
                                            Full Screen
                                        </button>
                                    </div>
                                    <div class="office-viewer">
                                        <iframe id="office-frame" width="100%" height="600px" frameborder="0"></iframe>
                                    </div>
                                </div>
                                
                                <!-- Unsupported File Type -->
                                <div id="unsupported-preview" class="preview-content" style="display: none;">
                                    <div class="unsupported-message">
                                        <i class="fas fa-file-exclamation"></i>
                                        <h4>Preview Not Available</h4>
                                        <p>This file type cannot be previewed in the browser.</p>
                                        <p class="note">Please contact your instructor for alternative access.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resource Details -->
                            <div class="resource-details">
                                <h4>Details</h4>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Uploaded by:</span>
                                        <span class="detail-value" id="detail-uploader">Admin</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Course:</span>
                                        <span class="detail-value" id="detail-course">General</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Block:</span>
                                        <span class="detail-value" id="detail-block">Block 1</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Description:</span>
                                        <span class="detail-value" id="detail-description">No description available</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Full Screen Overlay -->
                <div id="fullscreen-overlay" class="fullscreen-overlay">
                    <div class="fullscreen-header">
                        <button class="close-fullscreen" id="close-fullscreen">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <h3 id="fullscreen-title">Resource Title</h3>
                    </div>
                    <div class="fullscreen-content" id="fullscreen-content">
                        <!-- Content will be moved here when fullscreen is activated -->
                    </div>
                </div>
                
                <!-- Mobile Bottom Navigation -->
                <div class="mobile-resource-nav">
                    <button class="nav-btn active" data-action="list">
                        <i class="fas fa-list"></i>
                        <span>Resources</span>
                    </button>
                    <button class="nav-btn" data-action="preview">
                        <i class="fas fa-eye"></i>
                        <span>Preview</span>
                    </button>
                    <button class="nav-btn" data-action="fullscreen">
                        <i class="fas fa-expand"></i>
                        <span>Full Screen</span>
                    </button>
                </div>
            </section>

            <!-- Messages Tab -->
            <section id="messages" class="tab-content">
                <h2 style="color: var(--color-primary);">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>

                <div id="messages-list"></div>
            </section>
        </main>
    </div>

    <!-- Provisional Transcript Modal -->
    <div id="transcript-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
            <button onclick="closeTranscriptModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.2em; cursor:pointer;">‚úñ</button>
            <h3 id="transcript-exam-name" style="margin-bottom:15px; color: var(--color-primary);"></h3>
            <table style="width:100%; border-collapse:collapse; font-size:0.95em;">
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 1:</td>
                    <td id="transcript-cat1"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 2:</td>
                    <td id="transcript-cat2"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Final Exam:</td>
                    <td id="transcript-final"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Total Score:</td>
                    <td id="transcript-total"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Status:</td>
                    <td id="transcript-status"></td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        // *************************************************************************
        // *** SECURE CONFIGURATION - Loads from GitHub Secrets via config.js ***
        // *************************************************************************

        // Hides the .html extension in the URL
        if (window.location.pathname.endsWith('.html')) {
            const cleanPath = window.location.pathname.replace(/\.html$/, '');
            window.history.replaceState({}, '', cleanPath);
        }

        // Configuration validation
        function validateConfig() {
            if (!window.APP_CONFIG) {
                console.error('‚ùå APP_CONFIG not loaded - check config.js');
                return false;
            }

            const required = ['SUPABASE_URL', 'SUPABASE_ANON_KEY', 'LOCATIONIQ_API_KEY'];
            const missing = required.filter(key => !window.APP_CONFIG[key]);
            
            if (missing.length > 0) {
                console.error('‚ùå Missing configuration:', missing);
                return false;
            }
            
            console.log('‚úÖ Configuration loaded successfully from GitHub Secrets');
            console.log('Build:', window.APP_CONFIG.BUILD_TIME, 'Commit:', window.APP_CONFIG.COMMIT_SHA);
            return true;
        }

        // Show configuration error
        function showConfigurationError() {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: 'Inter', sans-serif; background: #f8f8f8; height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div style="max-width: 500px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h2 style="color: #EF4444; margin-bottom: 20px;">üö´ Configuration Error</h2>
                        <p style="color: #6B7280; margin-bottom: 20px;">The application failed to load configuration.</p>
                        <div style="background: #FEF2F2; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                            <strong>Possible issues:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>GitHub Secrets not configured</li>
                                <li>Deployment in progress</li>
                                <li>Configuration file missing</li>
                            </ul>
                        </div>
                        <button onclick="window.location.reload()" style="background: #4C1D95; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                            Retry
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize application with secure configuration
        function initializeApplication() {
            if (!validateConfig()) {
                showConfigurationError();
                return;
            }

            // Extract configuration from GitHub Secrets
            const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
            const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
            const LOCATIONIQ_API_KEY = window.APP_CONFIG.LOCATIONIQ_API_KEY;
            
            console.log('üîß Initializing Supabase with secure configuration...');
            
            // Initialize Supabase client
            const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';
            
            // Set PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Start the main application
            startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL);
        }

        // YOUR EXISTING APPLICATION CODE - MODIFIED FOR SECURITY
        async function startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL) {
            // *************************************************************************
            // *** CONFIGURATION AND INITIALIZATION ***
            // *************************************************************************
            
            // Global State
            let currentUserId = null;
            let currentUserProfile = null;
            let cachedCourses = []; 
            let cachedExams = [];
            let cachedClinicalAreas = [];
            let cachedResources = [];
            
            // Constants
            const MAX_ALLOWED_ACCURACY = 30;
            const MAX_DISTANCE_RADIUS = 200;
            const FALLBACK_LAT = 0.00;
            const FALLBACK_LON = 0.00;
            const FALLBACK_ACCURACY = 9999;
            const RESOURCES_BUCKET = 'resources';
            
            // *************************************************************************
            // *** UTILITY FUNCTIONS ***
            // *************************************************************************
            
            const AppUtils = {
                // Show loading state
                showLoading(element, message = 'Loading...') {
                    if (element) {
                        element.innerHTML = `<div class="loading-state">${message}</div>`;
                    }
                },
            
                // Show error state
                showError(element, message) {
                    if (element) {
                        element.innerHTML = `<div class="error-state">${message}</div>`;
                    }
                },
            
                // Safe API call wrapper
                async safeApiCall(apiCall, errorMessage = 'Operation failed') {
                    try {
                        return await apiCall();
                    } catch (error) {
                        console.error(errorMessage, error);
                        this.showToast(errorMessage, 'error');
                        return null;
                    }
                },
            
                // Toast notification
                showToast(message, type = 'info') {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
            
                    setTimeout(() => {
                        toast.remove();
                    }, 4000);
                }
            };
            
            // Simple cache implementation
            const cache = {
                data: new Map(),
                set(key, value, ttl = 5 * 60 * 1000) {
                    this.data.set(key, {
                        value,
                        expiry: Date.now() + ttl,
                        timestamp: new Date().toISOString()
                    });
                },
                get(key) {
                    const item = this.data.get(key);
                    if (!item) return null;
                    if (Date.now() > item.expiry) {
                        this.data.delete(key);
                        return null;
                    }
                    return item.value;
                },
                clear() {
                    this.data.clear();
                }
            };
            
            // *************************************************************************
            // *** AUTHENTICATION ***
            // *************************************************************************
            
            // Enforce authentication
            (async function enforceAuth() {
                try {
                    console.log("üîê Checking authentication...");
                    const { data: { session }, error } = await sb.auth.getSession();
                    
                    if (error) {
                        console.error("Session error:", error);
                        AppUtils.showToast('Authentication error - redirecting to login', 'error');
                        setTimeout(() => window.location.href = "login.html", 2000);
                        return;
                    }
                    
                    if (!session || !session.user) {
                        console.warn("No active session found");
                        AppUtils.showToast('Please log in to continue', 'warning');
                        window.location.href = "login.html";
                        return;
                    }
                    
                    currentUserId = session.user.id;
                    console.log("‚úÖ User authenticated:", currentUserId);
                    await checkAuthAndLoad();
                    
                } catch (err) {
                    console.error("Auth enforcement failed:", err);
                    AppUtils.showToast('Login check failed - redirecting', 'error');
                    window.location.href = "login.html";
                }
            })();
            
            // Initialize dashboard after auth
            async function checkAuthAndLoad() {
                try {
                    if (!currentUserId) {
                        window.location.href = "login.html"; 
                        return;
                    }
            
                    console.log("üîÑ Loading dashboard data...");
                    
                    // Load data with proper error handling
                    await Promise.allSettled([
                        loadProfile(currentUserId).catch(err => {
                            console.error("Profile load failed:", err);
                            AppUtils.showToast('Failed to load profile', 'error');
                        }),
                        loadClinicalTargets().catch(err => {
                            console.error("Clinical targets failed:", err);
                            AppUtils.showToast('Clinical data incomplete', 'warning');
                        }),
                        loadClassTargets().catch(err => {
                            console.error("Class targets failed:", err);
                        }),
                        loadCourses().catch(err => {
                            console.error("Courses failed:", err);
                            AppUtils.showToast('Course data unavailable', 'warning');
                        }),
                        loadExams().catch(err => {
                            console.error("Exams failed:", err);
                        }),
                        loadResources().catch(err => {
                            console.error("Resources failed:", err);
                        })
                    ]);
            
                    // Load UI components
                    await loadWelcomeDetails();
                    showTab('dashboard');
                    loadDashboardMetrics(currentUserId);
                    
                    console.log("‚úÖ Dashboard initialization complete");
                    
                } catch (error) {
                    console.error("üö® Initialization failed:", error);
                    AppUtils.showToast('Failed to load dashboard - some features may be unavailable', 'error');
                }
            }
            
            // Logout function
            async function logout() {
                try {
                    sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
                    await sb.auth.signOut();
                    window.location.href = "login.html";
                } catch (error) {
                    console.error("Logout error:", error);
                    window.location.href = "login.html";
                }
            }
            
            // *************************************************************************
            // *** UI AND NAVIGATION ***
            // *************************************************************************
            
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            const navLinks = document.querySelectorAll('.nav a');
            const tabs = document.querySelectorAll('.tab-content');
            
            // Mobile menu functions
            function toggleMenu() {
                if (sidebar.classList.contains('open')) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }
            
            function openMenu() {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeMenu() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Tab navigation
            function showTab(tabId) {
                // Highlight active link
                navLinks.forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
                if (activeLink) activeLink.classList.add('active');
            
                // Show active tab content
                tabs.forEach(tab => tab.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                if (activeTab) activeTab.classList.add('active');
            
                // Close mobile menu if open
                if (sidebar.classList.contains('open')) {
                    closeMenu();
                }
            
                // Load tab-specific data
                switch(tabId) {
                    case 'profile':
                        if (currentUserId) loadProfile(currentUserId);
                        break;
                    case 'attendance':
                        if (currentUserId) {
                            loadGeoAttendanceHistory(currentUserId);
                            updateTargetSelect();
                        }
                        break;
                    case 'dashboard':
                        if (currentUserId) {
                            loadWelcomeDetails();
                            loadDashboardMetrics(currentUserId);
                        }
                        break;
                    case 'courses':
                        if (currentUserId) loadCourses();
                        break;
                    case 'resources':
                        if (currentUserId) loadResources();
                        break;
                    case 'cats':
                        if (currentUserId) loadExams();
                        break;
                    case 'messages':
                        if (currentUserId) loadStudentMessagesAndAnnouncements();
                        break;
                    case 'calendar':
                        if (currentUserId) loadAcademicCalendar();
                        break;
                }
            
                // Always refresh latest announcement
                if (currentUserId) loadLatestOfficialAnnouncement();
            }
            
            // Attach event listeners to nav links
            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    if (tabId) showTab(tabId);
                });
            });
            
            // *************************************************************************
            // *** DASHBOARD FUNCTIONS ***
            // *************************************************************************
            
            // Load welcome details with live clock
            async function loadWelcomeDetails() {
                const studentName = currentUserProfile?.full_name || 'Student';
                const welcomeHeader = document.getElementById('welcome-header');
            
                function getGreeting(hour) {
                    if (hour >= 5 && hour < 12) return "Good Morning";
                    if (hour >= 12 && hour < 17) return "Good Afternoon";
                    if (hour >= 17 && hour < 21) return "Good Evening";
                    return "Good Night";
                }
            
                function updateHeader() {
                    const now = new Date();
                    const hour = now.getHours();
                    const minute = now.getMinutes().toString().padStart(2, '0');
                    const second = now.getSeconds().toString().padStart(2, '0');
                    
                    if (welcomeHeader) {
                        welcomeHeader.textContent = `${getGreeting(hour)}, ${studentName} ‚Äî ${hour.toString().padStart(2,'0')}:${minute}:${second}`;
                    }
                }
            
                // Initialize and start the live clock
                updateHeader();
                setInterval(updateHeader, 1000);
            
                // Load other messages
                await loadStudentMessage('student_welcome', 'student-welcome-message');
                await loadLatestOfficialAnnouncement();
            }
            
            // Load student message from app_settings
            async function loadStudentMessage(key, elementId) {
                const element = document.getElementById(elementId);
                if (!element) return;
            
                AppUtils.showLoading(element, 'Loading...');
            
                try {
                    const { data, error } = await sb
                        .from('app_settings')
                        .select('value')
                        .eq('key', key)
                        .maybeSingle();
            
                    if (error) throw error;
            
                    if (data && data.value) {
                        element.innerHTML = data.value;
                    } else {
                        element.textContent = 'No message available.';
                    }
                } catch (err) {
                    console.error(`‚ùå Failed to load ${key}:`, err);
                    AppUtils.showError(element, 'Failed to load message. Please refresh.');
                }
            }
            
            // Load latest official announcement
            async function loadLatestOfficialAnnouncement() {
                const element = document.getElementById('student-announcement');
                if (!element) return;
            
                AppUtils.showLoading(element, 'Loading latest announcement...');
            
                try {
                    const { data, error } = await sb
                        .from('notifications')
                        .select('*')
                        .eq('subject', 'Official Announcement')
                        .order('created_at', { ascending: false })
                        .limit(1);
            
                    if (error) throw error;
            
                    if (data && data.length > 0) {
                        element.textContent = data[0].message;
                    } else {
                        element.textContent = 'No official announcements at this time.';
                    }
                } catch (err) {
                    console.error('Failed to load official announcement:', err);
                    AppUtils.showError(element, 'Failed to load announcement. Please refresh.');
                }
            }
            
            // Load system messages for dashboard
            async function loadSystemMessages(studentProgram) {
                const card = document.getElementById('latest-announcement-card');
                const titleElement = document.getElementById('announcement-title');
                const bodyElement = document.getElementById('announcement-body');
                const dateElement = document.getElementById('announcement-date');
                const statusElement = document.getElementById('announcement-status');
            
                if (!card || !studentProgram) return;
            
                card.style.display = 'none';
            
                try {
                    // Fetch the single latest notification for the student's program
                    const { data: messages, error } = await sb
                        .from('notifications')
                        .select('created_at, subject, message, is_read, target_program')
                        .or(`target_program.eq.${studentProgram},target_program.is.null`)
                        .order('created_at', { ascending: false })
                        .limit(1);
            
                    if (error) throw error;
            
                    if (messages && messages.length > 0) {
                        const latestMsg = messages[0];
                        const date = new Date(latestMsg.created_at).toLocaleDateString('en-GB');
                        const statusColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-success)';
                        const statusText = !latestMsg.is_read ? 'New' : 'Seen';
                        const cardBorderColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-primary)';
            
                        titleElement.textContent = (latestMsg.subject || 'New Announcement').toUpperCase();
                        bodyElement.textContent = latestMsg.message;
                        dateElement.textContent = date;
                        statusElement.textContent = `Status: ${statusText}`;
                        statusElement.style.color = statusColor;
            
                        card.style.display = 'block';
                        card.style.borderLeftColor = cardBorderColor;
            
                    } else {
                        card.style.display = 'none';
                    }
            
                } catch (error) {
                    console.error('Error loading notifications for dashboard:', error.message);
                    card.style.display = 'none';
                }
            }
            
            // Load dashboard metrics
            async function loadDashboardMetrics(userId) {
                try {
                    // Show loading states
                    AppUtils.showLoading(document.getElementById('dashboard-attendance-rate'), '--%');
                    AppUtils.showLoading(document.getElementById('dashboard-active-courses'), '0');
                    AppUtils.showLoading(document.getElementById('dashboard-upcoming-exam'), 'Loading...');
            
                    // Load data in parallel for better performance
                    const [attendanceData, coursesData, examsData, resourcesData] = await Promise.all([
                        AppUtils.safeApiCall(() => loadAttendanceMetrics(userId)),
                        AppUtils.safeApiCall(() => loadCoursesMetrics()),
                        AppUtils.safeApiCall(() => loadExamsMetrics()),
                        AppUtils.safeApiCall(() => loadResourcesMetrics())
                    ]);
            
                    // Update UI with actual data
                    updateDashboardUI(attendanceData, coursesData, examsData, resourcesData);
                    
                    // Load profile photo
                    loadProfilePhoto();
                    
                    // Load system messages
                    if (currentUserProfile?.program) {
                        loadSystemMessages(currentUserProfile.program);
                    }
            
                } catch (error) {
                    console.error('Dashboard metrics loading failed:', error);
                    AppUtils.showToast('Failed to load dashboard data', 'error');
                }
            }
            
            // Helper functions for metrics
            async function loadAttendanceMetrics(userId) {
                const { data: logs, error } = await sb
                    .from('geo_attendance_logs')
                    .select('is_verified')
                    .eq('student_id', userId)
                    .order('check_in_time', { ascending: false });
            
                if (error) throw error;
            
                const totalLogs = logs.length;
                const verifiedCount = logs.filter(l => l.is_verified === true).length;
                const pendingCount = logs.filter(l => !l.is_verified).length;
                const attendanceRate = totalLogs > 0 ? Math.round((verifiedCount / totalLogs) * 100) : 0;
            
                return { attendanceRate, verifiedCount, totalLogs, pendingCount };
            }
            
            async function loadCoursesMetrics() {
                return { count: cachedCourses.length };
            }
            
            async function loadExamsMetrics() {
                const upcomingExams = cachedExams
                    .filter(exam => new Date(exam.exam_date) > new Date())
                    .sort((a, b) => new Date(a.exam_date) - new Date(b.exam_date));
            
                return { upcomingExam: upcomingExams[0] };
            }
            
            async function loadResourcesMetrics() {
                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const newResourcesCount = cachedResources.filter(r => r.created_at >= oneWeekAgo).length;
                return { newResourcesCount };
            }
            
            function updateDashboardUI(attendance, courses, exams, resources) {
                // Update attendance
                if (attendance) {
                    document.getElementById('dashboard-attendance-rate').textContent = attendance.attendanceRate + '%';
                    document.getElementById('dashboard-verified-count').textContent = attendance.verifiedCount;
                    document.getElementById('dashboard-total-count').textContent = attendance.totalLogs;
                    document.getElementById('dashboard-pending-count').textContent = attendance.pendingCount;
                }
            
                // Update courses
                if (courses) {
                    document.getElementById('dashboard-active-courses').textContent = courses.count;
                }
            
                // Update exams
                if (exams?.upcomingExam) {
                    const examDate = new Date(exams.upcomingExam.exam_date).toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric' 
                    });
                    document.getElementById('dashboard-upcoming-exam').textContent = 
                        `${exams.upcomingExam.exam_name || 'Exam'} on ${examDate}`;
                } else {
                    document.getElementById('dashboard-upcoming-exam').textContent = 'No Exams Scheduled';
                }
            
                // Update resources
                if (resources) {
                    document.getElementById('dashboard-new-resources').textContent = resources.newResourcesCount;
                }
            }
            
            // Load profile photo
            function loadProfilePhoto() {
                const passportImg = document.getElementById('passport-preview');
                const headerPassportImg = document.getElementById('header-passport-preview');
                const passportCard = document.getElementById('action-passport');
            
                const photoUrl = currentUserProfile?.passport_url;
            
                if (passportCard) {
                    passportCard.style.display = photoUrl ? 'none' : 'block';
                }
            
                // Determine the photo source (URL or fallback)
                let finalPhotoSrc = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                
                if (photoUrl) {
                    // Construct proper Supabase URL
                    finalPhotoSrc = `${window.APP_CONFIG.SUPABASE_URL}/storage/v1/object/public/passports/${photoUrl}?t=${new Date().getTime()}`;
                }
            
                // Update both profile and header images
                if (passportImg) {
                    passportImg.src = finalPhotoSrc;
                    passportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }
            
                if (headerPassportImg) {
                    headerPassportImg.src = finalPhotoSrc;
                    headerPassportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }
            }
            
            // *************************************************************************
            // *** PROFILE MANAGEMENT ***
            // *************************************************************************
            
            const profileForm = document.getElementById('profile-form');
            const passportFileInput = document.getElementById('passport-file-input');
            const passportPreview = document.getElementById('passport-preview');
            const uploadButton = document.getElementById('upload-button');
            const profileStatus = document.getElementById('profile-status');
            const editProfileButton = document.getElementById('edit-profile-button');
            const saveProfileButton = document.getElementById('save-profile-button');
            const uploadLabel = document.getElementById('upload-label');
            
            // Load profile from consolidated_user_profiles_table
            async function loadProfile(userId) {
                if (profileStatus) profileStatus.textContent = 'Loading profile...';
            
                const { data: profile, error } = await sb
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
            
                if (error || !profile) {
                    console.error('Error loading consolidated profile:', error);
                    if (profileStatus) profileStatus.textContent = 'Profile data missing or restricted. Contact Admin.';
                    currentUserProfile = {};
                } else {
                    currentUserProfile = profile;
                    if (profileStatus) profileStatus.textContent = '';
                }
            
                // Populate form fields
                if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').value = currentUserProfile.student_id || 'N/A';
                if (document.getElementById('profile-name')) document.getElementById('profile-name').value = currentUserProfile.full_name || 'N/A';
                if (document.getElementById('profile-email')) document.getElementById('profile-email').value = currentUserProfile.email || 'N/A';
                if (document.getElementById('profile-phone')) document.getElementById('profile-phone').value = currentUserProfile.phone || 'N/A';
                if (document.getElementById('profile-program')) document.getElementById('profile-program').value = currentUserProfile.program || currentUserProfile.department || 'N/A'; 
                if (document.getElementById('profile-block')) document.getElementById('profile-block').value = currentUserProfile.block || 'N/A';
                if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').value = currentUserProfile.intake_year || 'N/A';
            
                // Load profile photo
                loadProfilePhoto();
            
                toggleProfileEdit(false);
                if (uploadLabel && !currentUserProfile.passport_url) {
                    uploadLabel.style.display = 'block';
                }
            }
            
            // Toggle profile edit mode
            function toggleProfileEdit(enable) {
                const editableFields = ['profile-name', 'profile-phone'];
            
                editableFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.readOnly = !enable;
                });
            
                // Non-editable fields
                if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').readOnly = true;
                if (document.getElementById('profile-email')) document.getElementById('profile-email').readOnly = true;
                if (document.getElementById('profile-program')) document.getElementById('profile-program').readOnly = true;
                if (document.getElementById('profile-block')) document.getElementById('profile-block').readOnly = true;
                if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').readOnly = true;
            
                // Toggle buttons
                if (editProfileButton) editProfileButton.style.display = enable ? 'none' : 'block';
                if (saveProfileButton) saveProfileButton.style.display = enable ? 'block' : 'none';
            
                // Upload label visibility
                if (uploadLabel) {
                    if (enable || !(currentUserProfile && currentUserProfile.passport_url)) {
                        uploadLabel.style.display = 'block';
                    } else {
                        uploadLabel.style.display = 'none';
                    }
                }
            
                if (document.getElementById('upload-button')) document.getElementById('upload-button').style.display = 'none';
            }
            
            // Edit profile button event
            if (editProfileButton) {
                editProfileButton.addEventListener('click', () => toggleProfileEdit(true));
            }
            
            // Save profile
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (profileStatus) profileStatus.textContent = 'Saving changes...';
            
                    const updates = {
                        full_name: document.getElementById('profile-name').value,
                        phone: document.getElementById('profile-phone').value,
                        updated_at: new Date().toISOString()
                    };
            
                    const { error } = await sb
                        .from('consolidated_user_profiles_table')
                        .update(updates)
                        .eq('user_id', currentUserId);
            
                    if (error) {
                        if (profileStatus) profileStatus.textContent = `Error saving profile: ${error.message}`;
                    } else {
                        if (profileStatus) profileStatus.textContent = 'Profile updated successfully!';
                        loadProfile(currentUserId);
                    }
                });
            }
            
            // Passport photo upload
            if (passportFileInput) {
                passportFileInput.addEventListener('change', () => {
                    const file = passportFileInput.files[0];
                    if (file) {
                        // Display temporary object URL for preview
                        if (passportPreview) passportPreview.src = URL.createObjectURL(file);
                        if (uploadButton) uploadButton.style.display = 'block';
                        if (uploadLabel) uploadLabel.style.display = 'none';
                    }
                });
            }
            
            // Upload photo button
            if (uploadButton) {
                uploadButton.addEventListener('click', async () => {
                    const file = passportFileInput.files[0];
                    if (!file) {
                        if (profileStatus) profileStatus.textContent = 'Please select a file first.';
                        return;
                    }
            
                    if (profileStatus) profileStatus.textContent = 'Uploading photo... (This may take a few seconds)';
                    if (uploadButton) uploadButton.disabled = true;
            
                    const fileExt = file.name.split('.').pop();
                    const filePath = `${currentUserId}.${fileExt}`;
            
                    const { error: uploadError } = await sb.storage
                        .from('passports')
                        .upload(filePath, file, { cacheControl: '3600', upsert: true });
            
                    if (uploadError) {
                        if (profileStatus) profileStatus.textContent = `Upload failed: ${uploadError.message}`;
                        if (uploadButton) uploadButton.disabled = false;
                        return;
                    }
            
                    const { error: updateError } = await sb
                        .from('consolidated_user_profiles_table')
                        .update({ passport_url: filePath, updated_at: new Date().toISOString() })
                        .eq('user_id', currentUserId);
            
                    if (updateError) {
                        if (profileStatus) profileStatus.textContent = `Database update failed: ${updateError.message}`;
                    } else {
                        if (profileStatus) profileStatus.textContent = 'Photo uploaded and saved successfully! Refreshing profile...';
                        
                        // Clear file input and hide buttons after successful upload
                        if (passportFileInput) passportFileInput.value = ''; 
                        if (uploadButton) uploadButton.style.display = 'none';
                        if (uploadLabel) uploadLabel.style.display = 'none';
                        
                        // Reload profile and dashboard to reflect change
                        await loadProfile(currentUserId);
                        loadDashboardMetrics(currentUserId);
                        
                        // Set final status message
                        if (profileStatus) profileStatus.textContent = 'Photo updated successfully!';
                    }
            
                    if (uploadButton) uploadButton.disabled = false;
                });
            }
            
            // *************************************************************************
            // *** ATTENDANCE SYSTEM ***
            // *************************************************************************
            
            // Load clinical targets
            async function loadClinicalTargets() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department) || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId);
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const intakeYear = currentUserProfile?.intake_year;
                const blockTerm = currentUserProfile?.block || null;
            
                if (!program || !intakeYear) {
                    cachedClinicalAreas = [];
                    return;
                }
            
                try {
                    // Geo-based clinical areas
                    const { data: areaData, error: areaError } = await sb
                        .from('clinical_areas')
                        .select('id, name, latitude, longitude, block, program, intake_year')
                        .ilike('program', program)
                        .ilike('intake_year', intakeYear)
                        .or(blockTerm ? `block.ilike.${blockTerm},block.is.null` : 'block.is.null');
                    if (areaError) throw areaError;
            
                    // Textual clinical names including UUID + coordinates
                    const { data: nameData, error: nameError } = await sb
                        .from('clinical_names')
                        .select('id, uuid, clinical_area_name, latitude, longitude, program, intake_year, block_term')
                        .ilike('program', program)
                        .ilike('intake_year', intakeYear)
                        .or(blockTerm ? `block_term.ilike.${blockTerm},block_term.is.null` : 'block_term.is.null');
                    if (nameError) throw nameError;
            
                    // Map textual names to use actual UUIDs + keep coordinates
                    const mappedNames = (nameData || []).map(n => ({
                        id: n.uuid,
                        original_id: n.id,
                        name: n.clinical_area_name,
                        latitude: n.latitude,
                        longitude: n.longitude,
                        block: n.block_term || null
                    }));
            
                    // Merge + deduplicate
                    cachedClinicalAreas = [...(areaData || []), ...mappedNames]
                        .filter((v, i, a) => a.findIndex(t => t.name === v.name) === i)
                        .sort((a, b) => a.name.localeCompare(b.name));
            
                } catch (error) {
                    console.error("Error loading clinical areas:", error);
                    cachedClinicalAreas = [];
                }
            }
            
            // Load class targets
            async function loadClassTargets() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department) || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId); 
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const intakeYear = currentUserProfile?.intake_year;
                const block = currentUserProfile?.block || null;
            
                if (!program || !intakeYear) {
                    cachedCourses = [];
                    return;
                }
            
                try {
                    let query = sb.from('courses_sections')
                        .select('id, name, code, latitude, longitude')
                        .eq('program', program)
                        .eq('intake_year', intakeYear);
            
                    if (block) query = query.or(`block.eq.${block},block.is.null,block.eq.General`);
                    else query = query.is('block', null);
            
                    const { data, error } = await query.order('name');
                    if (error) throw error;
            
                    cachedCourses = (data || []).map(c => ({
                        id: c.id,
                        name: c.name,
                        code: c.code,
                        latitude: c.latitude,
                        longitude: c.longitude
                    }));
                } catch (error) {
                    console.error("Error loading class targets:", error);
                    cachedCourses = [];
                }
            }
            
            // Load attendance history
            async function loadGeoAttendanceHistory(userId) {
                const tableBody = document.getElementById('geo-attendance-history');
                if (!tableBody) return;
                
                tableBody.innerHTML = '<tr><td colspan="4">Loading geo check-in history...</td></tr>';
            
                try {
                    const { data: logs, error } = await sb
                        .from('geo_attendance_logs')
                        .select('check_in_time, session_type, target_name, is_verified')
                        .eq('student_id', userId)
                        .order('check_in_time', { ascending: false })
                        .limit(100);
            
                    if (error) throw error;
            
                    tableBody.innerHTML = '';
                    if (!logs || logs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4">No check-in logs found.</td></tr>';
                        return;
                    }
            
                    logs.forEach(log => {
                        const timeStr = new Date(log.check_in_time).toLocaleString();
                        const verifiedText = log.is_verified ? '‚úÖ Verified' : '‚è≥ Pending verification';
            
                        const row = `
                            <tr>
                                <td>${timeStr}</td>
                                <td>${log.session_type}</td>
                                <td>${log.target_name}</td>
                                <td>${verifiedText}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Failed to load attendance history:", error);
                    tableBody.innerHTML = `<tr><td colspan="4" style="color:#EF4444;">Error loading attendance logs: ${error.message}</td></tr>`;
                }
            }
            
            // Update target dropdown
            function updateTargetSelect() {
                const sessionTypeSelect = document.getElementById('session-type');
                const attendanceTargetSelect = document.getElementById('attendance-target');
                const geoMessage = document.getElementById('geo-message');
                
                if (!sessionTypeSelect || !attendanceTargetSelect || !geoMessage) return;
            
                const sessionType = sessionTypeSelect.value;
                attendanceTargetSelect.innerHTML = '';
            
                let targetList = [];
                let label = 'Department/Course:';
            
                if (sessionType === 'Clinical') {
                    targetList = cachedClinicalAreas.map(d => ({
                        id: d.id,
                        name: d.name,
                        text: `${d.name} (Clinical)`
                    }));
                    label = 'Department/Area:';
                } else if (sessionType === 'Class') {
                    targetList = cachedCourses.map(c => ({
                        id: c.id,
                        name: c.name,
                        code: c.code,
                        text: `${c.code ? c.code + ' - ' : ''}${c.name} (Class)`
                    }));
                    label = 'Course/Subject:';
                }
            
                const targetLabel = document.getElementById('target-label');
                if (targetLabel) targetLabel.textContent = label;
            
                if (targetList.length === 0) {
                    const message = sessionType === 'Class'
                        ? 'No active courses found for your block.'
                        : 'No clinical areas assigned to your block.';
                    attendanceTargetSelect.innerHTML = `<option value="">${message}</option>`;
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `-- Select a ${label.replace(':', '')} --`;
                    attendanceTargetSelect.appendChild(defaultOption);
            
                    targetList.forEach(target => {
                        const option = document.createElement('option');
                        option.value = `${target.id}|${target.name}`;
                        option.textContent = target.text;
                        attendanceTargetSelect.appendChild(option);
                    });
            
                    attendanceTargetSelect.selectedIndex = 0;
                }
            
                geoMessage.innerHTML = `Please select a specific <strong>${label.replace(':', '')}</strong> to check in.`;
            }
            
            // Get device ID
            function getDeviceId() {
                let deviceId = localStorage.getItem('device_id');
                if (!deviceId) {
                    deviceId = crypto.randomUUID();
                    localStorage.setItem('device_id', deviceId);
                }
                return deviceId;
            }
            
            // Geo check-in function - UPDATED WITH SIMPLIFIED MESSAGE
            async function geoCheckIn() {
                const button = document.getElementById('check-in-button');
                const geoMessage = document.getElementById('geo-message');
                const sessionTypeSelect = document.getElementById('session-type');
                const attendanceTargetSelect = document.getElementById('attendance-target');
            
                if (button) button.disabled = true;
                if (geoMessage) geoMessage.textContent = '‚è±Ô∏è Initializing check-in...';
            
                try {
                    if (!currentUserProfile) await loadProfile(currentUserId);
                    const studentProfile = currentUserProfile;
                    if (!studentProfile) {
                        if (geoMessage) geoMessage.textContent = 'Error: Student profile not loaded.';
                        return;
                    }
            
                    const studentProgram = studentProfile?.program || studentProfile?.department || null;
                    const deviceId = getDeviceId();
                    const sessionType = sessionTypeSelect?.value;
                    const targetSelect = attendanceTargetSelect?.value;
                    const checkInTime = new Date().toISOString();
            
                    if (!sessionType || !targetSelect || targetSelect === '') {
                        if (geoMessage) geoMessage.textContent = 'Error: Select session type and target.';
                        return;
                    }
            
                    // TargetSelect format is ID|NAME
                    const [targetId, targetNameFromDropdown] = targetSelect.split('|');
            
                    if (!targetId || !targetNameFromDropdown) {
                        if (geoMessage) geoMessage.textContent = 'Error: Invalid target selected.';
                        return;
                    }
            
                    if (geoMessage) geoMessage.textContent = '‚è±Ô∏è Requesting device location... (Allow up to 15 seconds for GPS lock)';
            
                    // Get geolocation
                    const location = await new Promise(resolve => {
                        if (!navigator.geolocation) return resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'GPS unavailable' });
                        navigator.geolocation.getCurrentPosition(
                            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy, friendly: null }),
                            () => resolve({ lat: FALLBACK_LAT, lon: FALLBACK_LON, acc: FALLBACK_ACCURACY, friendly: 'GPS denied/timeout' }),
                            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                        );
                    });
            
                    // Reverse-geocode for friendly name
                    if (!location.friendly) {
                        try {
                            const res = await fetch(`${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${location.lat}&lon=${location.lon}&format=json`);
                            if (res.ok) {
                                const geoData = await res.json();
                                location.friendly = geoData?.display_name || `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)}`;
                            } else {
                                location.friendly = `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)} (Geo-API failed)`;
                            }
                        } catch (err) {
                            location.friendly = `Lat:${location.lat.toFixed(4)}, Lon:${location.lon.toFixed(4)} (Geo-API error)`;
                            console.warn('Reverse geocoding error:', err);
                        }
                    }
            
                    // Find the target entry to get coordinates and the CORRECT name
                    let targetEntry = sessionType === 'Clinical'
                        ? cachedClinicalAreas.find(c => c.id === targetId)
                        : cachedCourses.find(c => c.id === targetId);
                        
                    if (!targetEntry || (targetEntry.latitude === null || targetEntry.longitude === null)) {
                        if (geoMessage) geoMessage.textContent = 'Error: Target location coordinates not found.';
                        return;
                    }
            
                    let dbTargetId = targetEntry.id;
                    let targetNameToLog = targetNameFromDropdown;
                    let selectedCourseId = null;
            
                    // Set name and ID for logging based on type
                    if (sessionType === 'Class') {
                        targetNameToLog = targetEntry.name; 
                        selectedCourseId = targetEntry.id;
                    } else if (sessionType === 'Clinical') {
                        targetNameToLog = targetEntry.name;
                        dbTargetId = targetEntry.id;
                    }
            
                    // Haversine distance calculation
                    const R = 6371000; // Earth radius in meters
                    const toRad = x => x * Math.PI / 180;
                    const dLat = toRad(location.lat - targetEntry.latitude);
                    const dLon = toRad(location.lon - targetEntry.longitude);
                    const lat1 = toRad(location.lat);
                    const lat2 = toRad(targetEntry.latitude);
                    const a = Math.sin(dLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    const distanceMeters = R * c;
                    const isVerified = distanceMeters <= MAX_DISTANCE_RADIUS;
            
                    // RPC call to insert check-in
                    const { error } = await sb.rpc('check_in_and_defer_fk', {
                        p_student_id: currentUserId,
                        p_check_in_time: checkInTime,
                        p_session_type: sessionType === 'Clinical' ? 'Clinical' : 'Class',
                        p_target_id: dbTargetId,
                        p_target_name: targetNameToLog,
                        p_latitude: location.lat,
                        p_longitude: location.lon,
                        p_accuracy_m: location.acc,
                        p_location_friendly_name: location.friendly,
                        p_program: studentProgram,
                        p_block: studentProfile.block,
                        p_intake_year: studentProfile.intake_year,
                        p_device_id: deviceId,
                        p_is_verified: isVerified,
                        p_course_id: selectedCourseId,
                        p_student_name: studentProfile.full_name || studentProfile.name || 'Unknown Student'
                    });
            
                    if (error) {
                        console.error('Check-in failed:', error);
                        if (geoMessage) geoMessage.textContent = `Check-in failed: ${error.message}`;
                    } else {
                        // ‚úÖ UPDATED: Simplified success message
                        if (geoMessage) geoMessage.innerHTML = `‚úÖ Check-in complete! ${isVerified ? 'Verified successfully' : 'Pending verification'}`;
                        loadGeoAttendanceHistory(currentUserId);
                    }
            
                } catch (e) {
                    console.error('GeoCheckIn error:', e);
                    if (geoMessage) geoMessage.textContent = `üö´ Critical error: ${e.message}`;
                } finally {
                    if (button) button.disabled = false;
                }
            }
            
            // *************************************************************************
            // *** COURSES, EXAMS, AND RESOURCES ***
            // *************************************************************************
            
            // Load courses - FIXED VERSION
            async function loadCourses() {
                const tableBody = document.getElementById('courses-table');
                if (!tableBody) return;
                AppUtils.showLoading(tableBody, 'Loading courses...');

                if (!currentUserProfile) await loadProfile(currentUserId); 
                
                const program = currentUserProfile?.program;
                const department = currentUserProfile?.department;
                const block = currentUserProfile?.block;
                const intakeYear = currentUserProfile?.intake_year;

                // Debug info
                console.log('User Profile:', {
                    program: program,
                    department: department,
                    block: block,
                    intakeYear: intakeYear
                });

                if ((!program && !department) || !intakeYear) {
                    tableBody.innerHTML = `<tr><td colspan="4">
                        Missing program/department or intake year info. 
                        Program: ${program || 'undefined'}, 
                        Department: ${department || 'undefined'},
                        Intake Year: ${intakeYear || 'undefined'}
                        Cannot load courses.
                    </td></tr>`;
                    cachedCourses = [];
                    return;
                }

                try {
                    const blockFilter = `block.eq.${block},block.is.null,block.eq.General`;

                    // Determine the correct target_program filter
                    let programFilter;
                    
                    // TVET students - check all possible combinations
                    if (program === 'TVET' || department === 'TVET') {
                        programFilter = `target_program.eq.TVET`;
                        console.log('Filtering for TVET courses only');
                    } 
                    // KRCHN students have program = 'KRCHN'
                    else if (program === 'KRCHN') {
                        programFilter = `target_program.eq.KRCHN`;
                        console.log('Filtering for KRCHN courses only');
                    }
                    // Nursing department students
                    else if (department === 'Nursing') {
                        programFilter = `target_program.eq.Nursing`;
                        console.log('Filtering for Nursing courses only');
                    }
                    // Clinical Medicine department
                    else if (department === 'Clinical Medicine') {
                        programFilter = `target_program.eq.Clinical Medicine`;
                        console.log('Filtering for Clinical Medicine courses only');
                    }
                    // Management department
                    else if (department === 'Management') {
                        programFilter = `target_program.eq.Management`;
                        console.log('Filtering for Management courses only');
                    }
                    else {
                        // Fallback: use program field if available
                        programFilter = `target_program.eq.${program}`;
                        console.log('Filtering for program:', program);
                    }

                    console.log('Final program filter:', programFilter);

                    const { data: courses, error } = await sb
                        .from('courses')
                        .select('*')
                        .or(programFilter)
                        .eq('intake_year', intakeYear)
                        .or(blockFilter)
                        .order('course_name', { ascending: true });

                    if (error) throw error;

                    cachedCourses = courses || [];
                    
                    console.log('Found courses:', cachedCourses.length);
                    console.log('Courses for', program || department, ':', cachedCourses);
                    
                    tableBody.innerHTML = '';
                    if (cachedCourses.length > 0) {
                        cachedCourses.forEach(c => {
                            tableBody.innerHTML += `
                                <tr>
                                    <td>${escapeHtml(c.course_name) || 'N/A'}</td>
                                    <td>${escapeHtml(c.unit_code) || 'N/A'}</td>
                                    <td>${escapeHtml(c.description) || 'N/A'}</td>
                                    <td>${escapeHtml(c.status) || 'N/A'}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="4">
                            No courses found for: ${program || department} 
                            (Program: ${program || 'undefined'}, Department: ${department || 'undefined'})
                            <br>Intake Year: ${intakeYear}, Block: ${block}
                            <br>Filter used: ${programFilter}
                            <br><small>Check if courses exist with target_program = '${program || department}' and intake_year = '${intakeYear}'</small>
                        </td></tr>`;
                    }

                } catch (error) {
                    console.error("‚ùå Failed to load courses:", error);
                    AppUtils.showError(tableBody, `Error loading courses: ${error.message}`);
                    cachedCourses = [];
                }

                if (typeof loadDashboardMetrics === "function") {
                    loadDashboardMetrics(currentUserId);
                }
            }

            // Utility to safely escape HTML
            function escapeHtml(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            // Load exams
            async function loadExams() {
                const tableBody = document.getElementById('exams-table');
                if (!tableBody) return;
            
                AppUtils.showLoading(tableBody, 'Loading your exams and grades...');
            
                if (!currentUserProfile) await loadProfile(currentUserId);
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const block = currentUserProfile?.block;
                const intakeYear = currentUserProfile?.intake_year;
                const studentId = currentUserId;
            
                if (!program || !intakeYear) {
                    tableBody.innerHTML = `<tr><td colspan="9">Missing program or intake year info. Cannot load exams.</td></tr>`;
                    cachedExams = [];
                    return;
                }
            
                try {
                    const { data: exams, error: examsError } = await sb
                        .from('exams_with_courses')
                        .select(`
                            id,
                            exam_name,
                            exam_date,
                            status,
                            block_term,
                            program_type,
                            exam_link,
                            course_name
                        `)
                        .or(`program_type.eq.${program},program_type.eq.General`)
                        .or(`block_term.eq.${block},block_term.is.null,block_term.eq.General`)
                        .eq('intake_year', intakeYear)
                        .order('exam_date', { ascending: true });
            
                    if (examsError) throw examsError;
            
                    const { data: grades, error: gradesError } = await sb
                        .from('exam_grades')
                        .select(`
                            exam_id,
                            student_id,
                            cat_1_score,
                            cat_2_score,
                            exam_score,
                            total_score,
                            result_status
                        `)
                        .eq('student_id', studentId);
            
                    if (gradesError) throw gradesError;
            
                    cachedExams = exams.map(exam => {
                        const grade = grades.find(g => g.exam_id === exam.id);
                        return { ...exam, grade };
                    });
            
                    // Filter by dropdown
                    const filter = document.getElementById('exam-type-filter')?.value || 'all';
                    let filteredExams = cachedExams;
                    if (filter === 'CAT') filteredExams = cachedExams.filter(e => e.exam_name.toLowerCase().includes('cat'));
                    if (filter === 'Final') filteredExams = cachedExams.filter(e => e.exam_name.toLowerCase().includes('final'));
            
                    tableBody.innerHTML = '';
                    if (!filteredExams.length) {
                        tableBody.innerHTML = `<tr><td colspan="9">No exams found.</td></tr>`;
                        return;
                    }
            
                    filteredExams.forEach(exam => {
                        const dateStr = exam.exam_date
                            ? new Date(exam.exam_date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })
                            : 'N/A';
            
                        const gradeEntry = exam.grade;
                        const cat1Score = gradeEntry?.cat_1_score ?? '-';
                        const cat2Score = gradeEntry?.cat_2_score ?? '-';
                        const finalExamScore = gradeEntry?.exam_score ?? '-';
                        const totalScore = gradeEntry?.total_score ?? '-';
                        const resultStatus = gradeEntry?.result_status ?? 'Scheduled';
            
                        const statusDisplay = resultStatus === 'Final'
                            ? `<span style="color:var(--color-success); font-weight:700;">Final</span>`
                            : `<span style="color:var(--color-warning); font-weight:700;">${resultStatus}</span>`;
            
                        // Dual Action buttons
                        let actionBtn = '';
                        if (exam.exam_link) {
                            actionBtn += `<a href="${exam.exam_link}" target="_blank" class="profile-button" style="background-color: var(--color-success); padding:6px 10px; font-size:0.85em; margin-right:5px;">Start Exam</a>`;
                        }
                        actionBtn += `<button onclick="viewProvisionalTranscript('${exam.id}')" class="profile-button" style="background-color: var(--color-primary); padding:6px 10px; font-size:0.85em;">View Transcript</button>`;
            
                        tableBody.innerHTML += `
                            <tr>
                                <td>${escapeHtml(exam.exam_name || 'N/A')}</td>
                                <td>${escapeHtml(exam.block_term || 'N/A')}</td>
                                <td>${dateStr}</td>
                                <td>${statusDisplay}</td>
                                <td>${cat1Score}</td>
                                <td>${cat2Score}</td>
                                <td>${finalExamScore}</td>
                                <td>${totalScore !== '-' ? `${totalScore}%` : '-'}</td>
                                <td>${actionBtn}</td>
                            </tr>`;
                    });
            
                } catch (error) {
                    console.error('‚ùå Failed to load exams:', error);
                    AppUtils.showError(tableBody, `Error loading exams: ${error.message}`);
                    cachedExams = [];
                }
            
                if (typeof loadDashboardMetrics === 'function') loadDashboardMetrics(currentUserId);
            }
            
            // View provisional transcript
            function viewProvisionalTranscript(examId) {
                const exam = cachedExams.find(e => String(e.id) === String(examId));
                if (!exam) return alert("Exam not found.");
            
                const grade = exam.grade || {};
                const totalScore = grade.total_score;
            
                // Colors: red if <50%, green if final, gray if provisional
                const cat1Color = grade.cat_1_score < 50 ? 'red' : 'black';
                const cat2Color = grade.cat_2_score < 50 ? 'red' : 'black';
                const finalColor = grade.exam_score < 50 ? 'red' : 'black';
                const totalColor = totalScore !== undefined
                    ? (grade.result_status === 'Final' ? 'green' : (totalScore < 50 ? 'red' : 'black'))
                    : 'black';
                const statusColor = grade.result_status === 'Final' ? 'green' : 'gray';
            
                document.getElementById('transcript-exam-name').textContent = exam.exam_name || 'N/A';
                document.getElementById('transcript-cat1').textContent = grade.cat_1_score ?? '-';
                document.getElementById('transcript-cat1').style.color = cat1Color;
                document.getElementById('transcript-cat2').textContent = grade.cat_2_score ?? '-';
                document.getElementById('transcript-cat2').style.color = cat2Color;
                document.getElementById('transcript-final').textContent = grade.exam_score ?? '-';
                document.getElementById('transcript-final').style.color = finalColor;
                document.getElementById('transcript-total').textContent = totalScore !== undefined ? `${totalScore}%` : '-';
                document.getElementById('transcript-total').style.color = totalColor;
                document.getElementById('transcript-status').textContent = grade.result_status || 'Provisional';
                document.getElementById('transcript-status').style.color = statusColor;
            
                document.getElementById('transcript-modal').style.display = 'flex';
            }
            
            // Close transcript modal
            function closeTranscriptModal() {
                document.getElementById('transcript-modal').style.display = 'none';
            }
            
            // *************************************************************************
            // *** ENHANCED RESOURCES SYSTEM ***
            // *************************************************************************
            
            // Load resources with enhanced mobile features
            async function loadResources() {
                if (!currentUserProfile) await loadProfile(currentUserId);
            
                const resourceListContainer = document.getElementById('resources-list-container');
                if (!resourceListContainer) return;
                AppUtils.showLoading(resourceListContainer, 'Loading resources...');
                cachedResources = [];
            
                try {
                    const program = currentUserProfile?.program;
                    const block = currentUserProfile?.block;
                    const intakeYear = currentUserProfile?.intake_year;
            
                    if (!program || !intakeYear || !block) {
                        resourceListContainer.innerHTML = '<p>Missing enrollment details (program, block, or intake year).</p>';
                        return;
                    }
            
                    const { data: resources, error } = await sb
                        .from('resources')
                        .select('id, title, file_path, file_url, program_type, block, intake, uploaded_by_name, created_at, file_size, file_type')
                        .eq('program_type', program)
                        .eq('block', block)
                        .eq('intake', intakeYear)
                        .order('created_at', { ascending: false });
            
                    if (error) throw error;
            
                    cachedResources = resources || [];
                    renderResourcesList(cachedResources);
            
                    // Update resources count
                    document.getElementById('resources-count').textContent = cachedResources.length;
            
                    // Load first resource if available
                    if (cachedResources.length > 0) {
                        viewResource(cachedResources[0].id);
                    } else {
                        document.getElementById('resource-viewer').innerHTML = 'Select a resource to view.';
                    }
            
                } catch (err) {
                    console.error("Error loading resources:", err);
                    AppUtils.showError(resourceListContainer, `Error loading resources: ${err.message}`);
                }
            
                if (typeof loadDashboardMetrics === 'function') {
                    loadDashboardMetrics(currentUserId);
                }
            }
            
            // Render resources list with enhanced UI
            function renderResourcesList(resources) {
                const resourceListContainer = document.getElementById('resources-list-container');
                if (!resourceListContainer) return;
            
                resourceListContainer.innerHTML = '';
            
                if (!resources.length) {
                    resourceListContainer.innerHTML = '<div class="no-resources">No resources found for your program and block.</div>';
                    return;
                }
            
                resources.forEach(resource => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'resource-item';
                    itemDiv.setAttribute('data-resource-id', resource.id);
                    
                    const fileExt = (resource.file_path || '').split('.').pop().toLowerCase();
                    const fileType = getFileType(fileExt);
                    const fileIcon = getFileIcon(fileExt);
                    const fileSize = formatFileSize(resource.file_size);
                    const uploadDate = new Date(resource.created_at).toLocaleDateString();
                    
                    itemDiv.innerHTML = `
                        <div class="resource-icon ${fileType}">
                            <i class="${fileIcon}"></i>
                        </div>
                        <div class="resource-content">
                            <div class="resource-name">${escapeHtml(resource.title)}</div>
                            <div class="resource-meta">
                                <span class="resource-type-badge">${fileExt.toUpperCase()}</span>
                                <span>${fileSize}</span>
                                <span>${uploadDate}</span>
                            </div>
                        </div>
                    `;
                    
                    itemDiv.addEventListener('click', () => viewResource(resource.id));
                    resourceListContainer.appendChild(itemDiv);
                });
            }
            
            // Get file type for styling
            function getFileType(extension) {
                const pdfTypes = ['pdf'];
                const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'];
                const videoTypes = ['mp4', 'avi', 'mov', 'wmv', 'flv'];
                const documentTypes = ['doc', 'docx', 'txt', 'rtf'];
                const presentationTypes = ['ppt', 'pptx'];
                const spreadsheetTypes = ['xls', 'xlsx', 'csv'];
                
                if (pdfTypes.includes(extension)) return 'pdf';
                if (imageTypes.includes(extension)) return 'image';
                if (videoTypes.includes(extension)) return 'video';
                if (documentTypes.includes(extension)) return 'document';
                if (presentationTypes.includes(extension)) return 'presentation';
                if (spreadsheetTypes.includes(extension)) return 'spreadsheet';
                return 'other';
            }
            
            // Get appropriate icon for file type
            function getFileIcon(extension) {
                const fileType = getFileType(extension);
                
                switch(fileType) {
                    case 'pdf': return 'fas fa-file-pdf';
                    case 'image': return 'fas fa-file-image';
                    case 'video': return 'fas fa-file-video';
                    case 'document': return 'fas fa-file-word';
                    case 'presentation': return 'fas fa-file-powerpoint';
                    case 'spreadsheet': return 'fas fa-file-excel';
                    default: return 'fas fa-file';
                }
            }
            
            // Format file size for display
            function formatFileSize(bytes) {
                if (!bytes) return 'Unknown size';
                
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                if (bytes === 0) return '0 Bytes';
                const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
            }
            
            // Enhanced view resource function with full-screen support
            async function viewResource(resourceId) {
                const resourceViewer = document.getElementById('resource-viewer');
                const resource = cachedResources.find(r => r.id == resourceId);
            
                if (!resource || !resourceViewer) {
                    if (resourceViewer) resourceViewer.innerHTML = 'Resource not found.';
                    return;
                }
            
                // Update active state in list
                document.querySelectorAll('.resource-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.resource-item[data-resource-id="${resourceId}"]`).classList.add('active');
            
                const fileUrl = resource.file_url;
                const filePath = resource.file_path;
                const ext = (filePath || '').split('.').pop().toLowerCase();
                const fileType = getFileType(ext);
            
                // Show active resource viewer
                document.querySelector('.preview-placeholder').style.display = 'none';
                document.querySelector('.active-resource').style.display = 'flex';
            
                // Update resource header
                document.getElementById('resource-title').textContent = resource.title;
                document.getElementById('resource-type').textContent = ext.toUpperCase();
                document.getElementById('resource-size').textContent = formatFileSize(resource.file_size);
                document.getElementById('resource-date').textContent = new Date(resource.created_at).toLocaleDateString();
                
                // Update resource details
                document.getElementById('detail-uploader').textContent = resource.uploaded_by_name || 'Admin';
                document.getElementById('detail-course').textContent = resource.program_type || 'General';
                document.getElementById('detail-block').textContent = resource.block || 'N/A';
                document.getElementById('detail-description').textContent = resource.description || 'No description available';
            
                // Hide all preview types first
                document.querySelectorAll('.preview-content').forEach(preview => {
                    preview.style.display = 'none';
                });
            
                // Setup fullscreen button
                document.getElementById('fullscreen-resource').onclick = () => openFullscreen(resourceId);
                document.getElementById('bookmark-resource').onclick = () => toggleBookmark(resourceId);
            
                // Handle different file types
                switch(fileType) {
                    case 'pdf':
                        await loadPdfPreview(fileUrl);
                        break;
                    case 'image':
                        await loadImagePreview(fileUrl);
                        break;
                    case 'video':
                        await loadVideoPreview(fileUrl);
                        break;
                    case 'document':
                    case 'presentation':
                    case 'spreadsheet':
                        await loadOfficePreview(fileUrl, filePath);
                        break;
                    default:
                        showUnsupportedPreview(fileUrl);
                        break;
                }
            }
            
            // Load PDF preview with enhanced controls
            async function loadPdfPreview(fileUrl) {
                const pdfPreview = document.getElementById('pdf-preview');
                pdfPreview.style.display = 'flex';
            
                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');
                let pdfDoc = null;
                let pageNum = 1;
                let scale = 1.5;
            
                try {
                    pdfjsLib.getDocument(fileUrl).promise
                        .then(pdf => {
                            pdfDoc = pdf;
                            document.getElementById('page-count').textContent = pdf.numPages;
                            renderPage(pageNum, scale);
                        })
                        .catch(err => {
                            pdfPreview.innerHTML = `<p style="color:#EF4444;">Failed to load PDF: ${err.message}</p>`;
                        });
            
                    function renderPage(num, zoomLevel = scale) {
                        pdfDoc.getPage(num).then(page => {
                            const viewport = page.getViewport({ scale: zoomLevel });
            
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
            
                            const renderContext = {
                                canvasContext: ctx,
                                viewport: viewport
                            };
            
                            page.render(renderContext).promise.then(() => {
                                document.getElementById('page-num').textContent = num;
                            });
                        });
                    }
            
                    // Navigation controls
                    document.getElementById('prev-page').onclick = () => {
                        if (pageNum > 1) {
                            pageNum--;
                            renderPage(pageNum, scale);
                        }
                    };
            
                    document.getElementById('next-page').onclick = () => {
                        if (pageNum < pdfDoc.numPages) {
                            pageNum++;
                            renderPage(pageNum, scale);
                        }
                    };
            
                    // Zoom controls
                    document.getElementById('zoom-in').onclick = () => {
                        scale += 0.25;
                        renderPage(pageNum, scale);
                    };
            
                    document.getElementById('zoom-out').onclick = () => {
                        if (scale > 0.5) {
                            scale -= 0.25;
                            renderPage(pageNum, scale);
                        }
                    };
            
                } catch (err) {
                    pdfPreview.innerHTML = `<p style="color:#EF4444;">Error loading PDF: ${err.message}</p>`;
                }
            }
            
            // Load image preview
            async function loadImagePreview(fileUrl) {
                const imagePreview = document.getElementById('image-preview');
                imagePreview.style.display = 'flex';
            
                const img = document.getElementById('preview-image');
                img.src = fileUrl;
                
                // Zoom functionality
                let isZoomed = false;
                document.getElementById('image-zoom').onclick = () => {
                    isZoomed = !isZoomed;
                    img.style.transform = isZoomed ? 'scale(1.5)' : 'scale(1)';
                    img.style.transition = 'transform 0.3s ease';
                    document.getElementById('image-zoom').innerHTML = isZoomed ? 
                        '<i class="fas fa-search-minus"></i> Zoom Out' : 
                        '<i class="fas fa-search-plus"></i> Zoom';
                };
            }
            
            // Load video preview
            async function loadVideoPreview(fileUrl) {
                const videoPreview = document.getElementById('video-preview');
                videoPreview.style.display = 'flex';
            
                const video = document.getElementById('preview-video');
                video.src = fileUrl;
                
                // Fullscreen for video
                document.getElementById('video-fullscreen').onclick = () => {
                    if (video.requestFullscreen) {
                        video.requestFullscreen();
                    } else if (video.webkitRequestFullscreen) {
                        video.webkitRequestFullscreen();
                    } else if (video.msRequestFullscreen) {
                        video.msRequestFullscreen();
                    }
                };
            }
            
            // Load office document preview
            async function loadOfficePreview(fileUrl, filePath) {
                const officePreview = document.getElementById('office-preview');
                officePreview.style.display = 'flex';
            
                try {
                    // Generate a signed URL (1 hour)
                    const { data: signed } = await sb.storage
                        .from(RESOURCES_BUCKET)
                        .createSignedUrl(filePath, 3600);
            
                    if (!signed?.signedUrl) {
                        officePreview.innerHTML = `<p style="color:#EF4444;">Unable to load file.</p>`;
                        return;
                    }
            
                    const encoded = encodeURIComponent(signed.signedUrl);
                    const iframe = document.getElementById('office-frame');
                    iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encoded}`;
                    
                    // Fullscreen for office docs
                    document.getElementById('office-fullscreen').onclick = () => {
                        openFullscreenOffice(encoded);
                    };
            
                } catch (err) {
                    officePreview.innerHTML = `<p style="color:#EF4444;">Failed to load file: ${err.message}</p>`;
                }
            }
            
            // Show unsupported file type
            function showUnsupportedPreview(fileUrl) {
                const unsupportedPreview = document.getElementById('unsupported-preview');
                unsupportedPreview.style.display = 'flex';
            }
            
            // Fullscreen functionality
            function openFullscreen(resourceId) {
                const resource = cachedResources.find(r => r.id == resourceId);
                if (!resource) return;
            
                const overlay = document.getElementById('fullscreen-overlay');
                const content = document.getElementById('fullscreen-content');
                const title = document.getElementById('fullscreen-title');
                
                title.textContent = resource.title;
                
                // Clone the current preview content
                const currentPreview = document.querySelector('.preview-content[style*="display: flex"]');
                if (currentPreview) {
                    const clone = currentPreview.cloneNode(true);
                    content.innerHTML = '';
                    content.appendChild(clone);
                    
                    // Adjust for fullscreen
                    const canvas = clone.querySelector('#pdf-canvas');
                    if (canvas) {
                        // Re-render PDF at larger scale for fullscreen
                        setTimeout(() => {
                            const pdfPreview = clone.querySelector('#pdf-preview');
                            if (pdfPreview) {
                                pdfPreview.style.height = '100%';
                                pdfPreview.style.flexDirection = 'column';
                            }
                        }, 100);
                    }
                }
                
                overlay.classList.add('active');
                
                // Close fullscreen
                document.getElementById('close-fullscreen').onclick = closeFullscreen;
                
                // ESC key to close
                document.addEventListener('keydown', function escHandler(e) {
                    if (e.key === 'Escape') {
                        closeFullscreen();
                        document.removeEventListener('keydown', escHandler);
                    }
                });
            }
            
            function closeFullscreen() {
                const overlay = document.getElementById('fullscreen-overlay');
                overlay.classList.remove('active');
            }
            
            function openFullscreenOffice(encodedUrl) {
                const overlay = document.getElementById('fullscreen-overlay');
                const content = document.getElementById('fullscreen-content');
                const title = document.getElementById('fullscreen-title');
                
                title.textContent = 'Document Preview';
                content.innerHTML = `
                    <iframe 
                        src="https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}"
                        width="100%"
                        height="100%"
                        style="border:none;"
                        frameborder="0">
                    </iframe>
                `;
                
                overlay.classList.add('active');
                document.getElementById('close-fullscreen').onclick = closeFullscreen;
            }
            
            // Bookmark functionality
            function toggleBookmark(resourceId) {
                let bookmarks = JSON.parse(localStorage.getItem('resourceBookmarks') || '[]');
                const index = bookmarks.indexOf(resourceId);
                
                if (index > -1) {
                    bookmarks.splice(index, 1);
                    AppUtils.showToast('Resource removed from bookmarks', 'info');
                } else {
                    bookmarks.push(resourceId);
                    AppUtils.showToast('Resource bookmarked', 'success');
                }
                
                localStorage.setItem('resourceBookmarks', JSON.stringify(bookmarks));
                updateBookmarkButton(resourceId);
            }
            
            function updateBookmarkButton(resourceId) {
                const bookmarks = JSON.parse(localStorage.getItem('resourceBookmarks') || '[]');
                const isBookmarked = bookmarks.includes(resourceId);
                const button = document.getElementById('bookmark-resource');
                
                if (button) {
                    button.innerHTML = isBookmarked ? 
                        '<i class="fas fa-bookmark"></i> Bookmarked' : 
                        '<i class="fas fa-bookmark"></i> Bookmark';
                    button.style.background = isBookmarked ? 'var(--color-warning)' : 'var(--color-primary)';
                }
            }
            
            // Mobile navigation
            function setupMobileNavigation() {
                const navButtons = document.querySelectorAll('.mobile-resource-nav .nav-btn');
                const resourcesSidebar = document.querySelector('.resources-sidebar');
                const resourcePreview = document.querySelector('.resource-preview');
                
                navButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        
                        // Update active state
                        navButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Handle actions
                        switch(action) {
                            case 'list':
                                resourcesSidebar.style.display = 'flex';
                                resourcePreview.style.display = 'none';
                                break;
                            case 'preview':
                                resourcesSidebar.style.display = 'none';
                                resourcePreview.style.display = 'flex';
                                break;
                            case 'fullscreen':
                                const activeResource = document.querySelector('.resource-item.active');
                                if (activeResource) {
                                    const resourceId = activeResource.getAttribute('data-resource-id');
                                    openFullscreen(resourceId);
                                }
                                break;
                        }
                    });
                });
            }
            
            // Initialize mobile navigation when resources tab is shown
            const originalShowTab = window.showTab;
            window.showTab = function(tabId) {
                originalShowTab(tabId);
                if (tabId === 'resources') {
                    setTimeout(setupMobileNavigation, 100);
                }
            };
            
            // *************************************************************************
            // *** ACADEMIC CALENDAR ***
            // *************************************************************************
            
            async function fetchAllScheduleData() {
                if (!currentUserProfile || !currentUserProfile.program && !currentUserProfile.department || !currentUserProfile.intake_year) {
                    await loadProfile(currentUserId); 
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const block = currentUserProfile?.block;
                const intakeYear = currentUserProfile?.intake_year;
            
                if (!program || !block || !intakeYear) return [];
            
                const sessionsPromise = Promise.resolve([]); 
                const examsPromise = Promise.resolve(cachedExams.map(e => ({
                    date: e.exam_date,
                    title: e.exam_name,
                    type: 'Exam',
                    details: `${e.status || 'Scheduled'} - Block ${e.block_term}`
                })));
            
                // Holidays/Academic Events
                const eventsPromise = sb
                    .from('calendar_events')
                    .select('event_name, event_date, type, description, target_program, target_block, target_intake_year')
                    .or(`target_program.eq.${program},target_program.eq.General`)
                    .or(`target_block.eq.${block},target_block.is.null`)
                    .eq('target_intake_year', intakeYear)
                    .then(({ data, error }) => {
                        if (error) { console.error("Events error:", error); return []; }
                        return (data || []).map(e => ({
                            date: e.event_date,
                            title: e.event_name,
                            type: e.type,
                            details: e.description
                        }));
                    });
            
                const results = await Promise.all([sessionsPromise, examsPromise, eventsPromise]);
                return results.flat();
            }
            
            async function loadAcademicCalendar() {
                const tableBody = document.getElementById('calendar-table');
                if (!tableBody) return;
                AppUtils.showLoading(tableBody, 'Loading academic schedule...');
            
                try {
                    const allEvents = await fetchAllScheduleData();
                    const filterType = document.getElementById('calendar-filter').value;
            
                    const filteredEvents = allEvents
                        .filter(e => filterType === 'all' || e.type === filterType)
                        .sort((a, b) => new Date(a.date) - new Date(b.date)); 
            
                    tableBody.innerHTML = '';
            
                    if (filteredEvents.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="3">No scheduled events found for the selected filter (${filterType}).</td></tr>`;
                        return;
                    }
            
                    filteredEvents.forEach(event => {
                        const dateStr = new Date(event.date).toLocaleString();
                        const row = `
                            <tr>
                                <td class="date-col">${dateStr}</td>
                                <td>${escapeHtml(event.title)} (${escapeHtml(event.details)})</td>
                                <td class="session-type-col ${event.type}">${event.type}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
            
                } catch (error) {
                    console.error("Failed to load academic calendar:", error);
                    AppUtils.showError(tableBody, 'Error loading calendar data.');
                }
            }
            
            // *************************************************************************
            // *** MESSAGES SYSTEM ***
            // *************************************************************************
            
            async function loadStudentMessagesAndAnnouncements() {
                if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department)) {
                    await loadProfile(currentUserId);
                }
            
                const program = currentUserProfile?.program || currentUserProfile?.department;
                const messageContainer = document.getElementById('messages-list');
                if (!messageContainer) return;
            
                AppUtils.showLoading(messageContainer, 'Loading messages...');
            
                try {
                    // Load personal messages
                    const { data: personalMessages, error: personalError } = await sb
                        .from('student_messages')
                        .select('*')
                        .or(`recipient_id.eq.${currentUserId},recipient_program.eq.${program}`)
                        .order('created_at', { ascending: false });
            
                    if (personalError) throw personalError;
            
                    // Load official announcements
                    const { data: notifications, error: notifError } = await sb
                        .from('notifications')
                        .select('*')
                        .or(`target_program.eq.${program},target_program.is.null`)
                        .order('created_at', { ascending: false });
            
                    if (notifError) throw notifError;
            
                    // Combine messages, with personal messages first
                    const allMessages = [
                        ...(personalMessages || []).map(m => ({ ...m, type: 'Personal' })),
                        ...(notifications || []).map(n => ({ ...n, type: 'Announcement' }))
                    ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
                    messageContainer.innerHTML = '';
                    if (allMessages.length === 0) {
                        messageContainer.innerHTML = '<p>No messages or announcements at this time.</p>';
                        return;
                    }
            
                    // Render each message/announcement
                    allMessages.forEach(msg => {
                        const title = msg.subject || msg.title || 'Message';
                        const body = msg.body || msg.message || msg.message_content || '';
                        const isRead = msg.is_read ? 'read' : 'unread';
                        const createdAt = msg.created_at ? new Date(msg.created_at).toLocaleDateString() : '';
                        const borderColor = msg.type === 'Personal' ? '#4C1D95' : '#F97316';
                        const statusColor = msg.is_read ? '#10B981' : '#F59E0B';
            
                        messageContainer.innerHTML += `
                            <div class="message-item ${isRead}" style="border-left: 4px solid ${borderColor}; padding: 15px; margin-bottom: 10px; background-color: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div class="message-header" style="display: flex; justify-content: space-between; font-weight: bold; color: #4C1D95;">
                                    <span class="message-title">${escapeHtml(title)}</span>
                                    <span class="message-date" style="font-weight: normal; color: #6B7280;">${createdAt}</span>
                                </div>
                                <div class="message-body" style="margin-top: 5px; color: #374151;">${escapeHtml(body.substring(0, 300))}${body.length > 300 ? '...' : ''}</div>
                                <span class="message-status" style="font-size: 0.8em; color: ${statusColor}; margin-top: 5px; display: inline-block;">Type: ${msg.type} | Status: ${isRead.toUpperCase()}</span>
                            </div>
                        `;
                    });
            
                } catch (error) {
                    console.error("Failed to load student messages and announcements:", error);
                    AppUtils.showError(messageContainer, 'Error loading messages and announcements.');
                }
            }
            
            // *************************************************************************
            // *** GLOBAL EVENT LISTENERS ***
            // *************************************************************************
            
            document.addEventListener('DOMContentLoaded', async () => {
                // Setup global error handlers
                window.addEventListener('error', (event) => {
                    console.error('Global error:', event.error);
                    AppUtils.showToast('An unexpected error occurred', 'error');
                });
            
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled promise rejection:', event.reason);
                    AppUtils.showToast('An operation failed', 'error');
                });
            
                // Setup event listeners for filters
                const examFilter = document.getElementById('exam-type-filter');
                if (examFilter) {
                    examFilter.addEventListener('change', loadExams);
                }
                
                const sessionType = document.getElementById('session-type');
                if (sessionType) {
                    sessionType.addEventListener('change', updateTargetSelect);
                }
                
                const calendarFilter = document.getElementById('calendar-filter');
                if (calendarFilter) {
                    calendarFilter.addEventListener('change', loadAcademicCalendar);
                }
                
                // Resource filters
                const resourceTypeFilter = document.getElementById('resource-type-filter');
                const resourceSort = document.getElementById('resource-sort');
                const resourceSearch = document.getElementById('resource-search');
                
                if (resourceTypeFilter) {
                    resourceTypeFilter.addEventListener('change', filterResources);
                }
                
                if (resourceSort) {
                    resourceSort.addEventListener('change', sortResources);
                }
                
                if (resourceSearch) {
                    resourceSearch.addEventListener('input', searchResources);
                }
                
                // View toggle
                const viewButtons = document.querySelectorAll('.view-btn');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        viewButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        toggleView(this.getAttribute('data-view'));
                    });
                });
            });
            
            // Resource filtering
            function filterResources() {
                const filterValue = document.getElementById('resource-type-filter').value;
                let filtered = cachedResources;
                
                if (filterValue !== 'all') {
                    filtered = cachedResources.filter(resource => {
                        const ext = (resource.file_path || '').split('.').pop().toLowerCase();
                        const fileType = getFileType(ext);
                        return fileType === filterValue;
                    });
                }
                
                renderResourcesList(filtered);
            }
            
            // Resource sorting
            function sortResources() {
                const sortValue = document.getElementById('resource-sort').value;
                let sorted = [...cachedResources];
                
                switch(sortValue) {
                    case 'newest':
                        sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        break;
                    case 'oldest':
                        sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                        break;
                    case 'name':
                        sorted.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                }
                
                renderResourcesList(sorted);
            }
            
            // Resource search
            function searchResources() {
                const searchValue = document.getElementById('resource-search').value.toLowerCase();
                const filtered = cachedResources.filter(resource => 
                    resource.title.toLowerCase().includes(searchValue)
                );
                
                renderResourcesList(filtered);
            }
            
            // Toggle between list and grid view
            function toggleView(viewType) {
                const container = document.getElementById('resources-list-container');
                if (viewType === 'grid') {
                    container.classList.add('grid-view');
                } else {
                    container.classList.remove('grid-view');
                }
            }
            
            // Make functions globally available
            window.toggleMenu = toggleMenu;
            window.closeMenu = closeMenu;
            window.showTab = showTab;
            window.logout = logout;
            window.geoCheckIn = geoCheckIn;
            window.updateTargetSelect = updateTargetSelect;
            window.viewProvisionalTranscript = viewProvisionalTranscript;
            window.closeTranscriptModal = closeTranscriptModal;
            window.viewResource = viewResource;
            window.openFullscreen = openFullscreen;
            window.closeFullscreen = closeFullscreen;
        }

        // Start application when config is ready
        if (window.APP_CONFIG) {
            initializeApplication();
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                // Give config.js a moment to load
                setTimeout(() => {
                    if (window.APP_CONFIG) {
                        initializeApplication();
                    } else {
                        showConfigurationError();
                    }
                }, 1000);
            });
        }
    </script>

    <!-- Config file generated by GitHub Actions with secrets -->
    <script src="./config.js"></script>
</body>
</html>
