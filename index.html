<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard - Deep Purple Theme</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* -------------------------------------- */
        /* SUPABASE STUDENT PORTAL STYLE (Deep Purple Theme) */
        /* -------------------------------------- */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F1F5F9; }
        .container { display: flex; min-height: 100vh; }


        /* Sidebar - Deep Purple Theme (Vertical for Desktop) */
        .sidebar { 
            width: 250px;
            background-color: #4C1D95;
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            transition: transform 0.3s, width 0.3s;
            position: sticky; /* Keep it visible on desktop scroll */
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header img { width: 60px; margin-bottom: 10px; filter: invert(1); }
        
        /* Nav Container */
        .nav { list-style: none; padding: 0; flex-grow: 1; }
        .nav li { margin: 10px 0; }
        .nav a { color: #E5E7EB; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.2s; }
        .nav a:hover { background-color: #5B21B6; }
        .nav a.active { 
            background-color: #FCD34D;
            color: #1F2937;
            font-weight: bold;
        }
        .logout { margin-top: auto; text-align: center; }
        .logout a { 
            display: inline-block; 
            margin-top: 20px; 
            padding: 10px 20px; 
            background-color: #EF4444; 
            color: #fff; 
            text-decoration: none; 
            border-radius: 6px; 
        }


        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        header h1 { margin: 0; font-size: 2.2rem; color: #4C1D95; }
        .subtitle { color: #6B7280; margin-bottom: 25px; }


        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .card { 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            transition: transform 0.2s, box-shadow 0.2s; 
            border: 1px solid #E2E8F0;
            text-align: center;
            border-left: 5px solid #4C1D95; 
        }
        .card:hover { transform: translateY(-7px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .card h3 { margin-top: 0; font-size: 1.1em; color: #4C1D95;}
        .card p.data { font-size: 2em; font-weight: 800; margin: 5px 0 0; color: #F59E0B; } 


      /* Dashboard Welcome Banner (Compact Admin Message) */
#welcome-banner {
  background-color: #FFF7ED;
  color: #92400E;
  border: 1px solid #FED7AA;
  padding: 10px 15px;
  border-radius: 6px;
  margin-bottom: 20px;
  font-weight: 500;
  font-size: 0.95rem; /* smaller text */
  display: flex;
  align-items: center;
  gap: 10px;
}

#welcome-banner strong {
  font-weight: 600;
  color: #EA580C; /* darker orange */
  font-size: 0.95rem;
}

.info-icon {
  font-size: 1.3rem;
  color: #EA580C;
}

        /* Tabs, Tables, Forms */
        .tab-content { display: none; }
        .tab-content.active { display: block; }


        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; background-color: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid #E2E8F0; text-align: left; }
        th { background-color: #E5E7EB; color: #1F2937; }
        tr:hover { background-color: #F8FAFC; }


        /* Calendar Specific Styles */
        #calendar-table th.session-type-col { width: 15%; }
        #calendar-table th.date-col { width: 15%; }
        #calendar-table td.Clinical { background-color: #fce7f3; } /* Light Pink */
        #calendar-table td.Class { background-color: #e0f2f1; } /* Light Teal */
        #calendar-table td.Exam { background-color: #fef3c7; } /* Light Yellow */



        /* Forms */
        form input, form select, form button, form textarea {
            padding: 10px 12px; margin: 5px 5px 10px 0; border-radius: 6px; border: 1px solid #CBD5E1;
            box-sizing: border-box; 
            min-width: 150px;
        }
        form button { background-color: #4C1D95; color: #fff; cursor: pointer; }
        form button:hover { background-color: #5B21B6; }


        /* Profile Specific Styles */
        #profile-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95; 
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 30px;
        }
        .profile-details {
            /* Use grid for better layout of details */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .profile-media {
            /* Adjusted for better mobile flow */
        }
        .form-field {
            min-width: 100%;
        }
        .form-field.full-width {
            grid-column: 1 / 3;
        }


        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            margin-top: 15px; 
            color: #4C1D95;
        }
        .form-field input[readonly] {
            background-color: #E5E7EB;
            color: #4B5563;
        }
        .profile-button {
            background-color: #4C1D95; 
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            margin-top: 15px;
            border: none;
            cursor: pointer;
        }


        /* Check-in Controls */
        .check-in-controls {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 5px solid #4C1D95;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .check-in-controls button {
            background-color: #10B981; 
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }


        .resource-item {
            background-color: #fff;
            border: 1px solid #E2E8F0;
            border-left: 4px solid #F59E0B;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .resource-item a {
            color: #4C1D95;
            font-weight: 600;
            text-decoration: none;
        }
        .resource-item a:hover {
            text-decoration: underline;
        }
        
        /* -------------------------------------- */
        /* MOBILE NAV HEADER & TOGGLE */
        /* -------------------------------------- */
        .mobile-header {
            display: none; /* Hidden by default */
            background-color: #4C1D95;
            color: white;
            padding: 10px 15px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1010;
        }
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* -------------------------------------- */
        /* RESPONSIVE ADJUSTMENTS (Mobile First) */
        /* -------------------------------------- */
        @media (max-width: 768px) {
            .container { 
                flex-direction: column; 
            }

            /* Show Mobile Header */
            .mobile-header {
                display: flex;
            }
            
            /* Hide the main sidebar off-screen initially */
            .sidebar { 
                position: fixed;
                top: 0;
                left: 0;
                width: 70%; /* Takes up 70% of the screen */
                height: 100%;
                transform: translateX(-100%); /* CRITICAL: Hides the sidebar */
                transition: transform 0.3s ease-in-out;
                box-shadow: 4px 0 10px rgba(0,0,0,0.3);
            }
            
            /* Class added by JS to show the menu */
            .sidebar.open {
                transform: translateX(0);
            }

            /* Full screen overlay to dim the content */
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            .overlay.active {
                display: block;
            }

            .sidebar-header { 
                /* Compact header in the menu */
                display: flex; 
                justify-content: flex-start; 
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                padding: 10px 0;
                border-bottom: 1px solid #5B21B6;
            }
            .sidebar-header img { 
                width: 40px; 
                margin-bottom: 0; 
            }
            .sidebar-header h2 {
                 font-size: 1.2rem;
            }

            /* Enforce vertical tabs within the mobile sidebar */
            .nav { 
                display: flex; 
                flex-direction: column; 
                padding: 0; 
                margin: 0;
            }
            .nav a { 
                padding: 12px 15px; 
                border-radius: 0;
            }

            /* Move logout back to the sidebar on mobile, but at the bottom */
            .logout { display: block; margin-top: auto; }
            .main { padding: 15px; } /* Reduce main padding */

            .cards { 
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
                gap: 15px; 
                margin-bottom: 20px; 
            }
            .card p.data { font-size: 1.8em; }


            /* Profile/Form refinement */
            #profile-form { 
                flex-direction: column; 
                padding: 15px; 
                gap: 15px;
            }
            .profile-details { 
                grid-template-columns: 1fr; /* Force single column on mobile */
                gap: 10px; 
            }
            .form-field.full-width { 
                grid-column: 1 / 2; 
            }
            
            /* Check-in controls refinement */
            .check-in-controls { 
                padding: 15px; 
                gap: 10px;
            }
            .check-in-controls select, .check-in-controls button {
                min-width: unset;
                width: 100%; /* Ensure selects and buttons take full width */
            }

            /* Resource viewer fixes */
            .tab-content#resources > div {
                flex-direction: column;
            }
            #resources-list {
                width: 100% !important; /* Forces resource list to take full width */
                max-height: 300px !important; /* Keeps the list from being too long */
                border-right: none !important;
                border-bottom: 1px solid #ddd;
                padding-right: 0 !important;
                padding-bottom: 10px;
            }
            #resource-viewer {
                width: 100% !important; /* Forces viewer to take full width */
                min-height: 400px !important;
            }
            .resource-item iframe {
                height: 300px !important; /* Reduce iframe height for mobile */
            }
        }

        /* Desktop-only styles (Re-enables vertical nav and full sidebar) */
        @media (min-width: 769px) {
            .sidebar { 
                width: 250px; 
                flex-direction: column; 
                padding: 20px; 
                position: sticky; /* Sticky on desktop */
                transform: translateX(0); /* Ensure it's visible */
            }
            .sidebar-header { display: block; text-align: center; } /* Restore full header */
            .sidebar-header h2 { font-size: 1.5rem; }
            .nav { display: block; overflow-x: visible; }
            .nav li { margin: 10px 0; }
            .nav a { white-space: normal; text-align: left; padding: 10px; font-size: 1rem; border-radius: 6px; }
            .logout { display: block; }
            .container { flex-direction: row; }
        }
    </style>
</head>
<body>
    
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <span>NCHSM Student Portal</span>
    </div>
    
    <div class="overlay" onclick="toggleMenu()"></div>


    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo" style="width: 100px; margin-bottom: 10px; filter: none;"> 
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active" onclick="closeMenu()">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile" onclick="closeMenu()">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar" onclick="closeMenu()">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses" onclick="closeMenu()">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance" onclick="closeMenu()">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats" onclick="closeMenu()">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources" onclick="closeMenu()">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages" onclick="closeMenu()">üí¨ Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>


        <main class="main">
            <header>
                <h1 id="welcome-header">Hello, Student!</h1>
                <p class="subtitle">Your academic resources and tools.</p>
            </header>


            <section id="dashboard" class="tab-content active">
                
                <div id="welcome-section" class="welcome-card">
  <h2 id="welcome-header">Hello, Student!</h2>
  <p id="student-welcome-message">Loading your welcome message...</p>
</div>

<div id="announcement-banner" class="announcement-card">
  <span class="info-icon">üì£</span>
  <div>
    <strong>Official Announcement:</strong>
    <p id="student-announcement">Loading latest announcement...</p>
  </div>
</div>


                <h2 style="margin-top: 30px; color: #4C1D95;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Overall Verified</small>
                    </div>
                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 600; color: #4C1D95;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>
                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>
                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last 7 days</small>
                    </div>
                </div>


                <h2 id="actions-title" style="margin-top: 30px; color: #4C1D95;">Action Required</h2>
                <div id="dashboard-actions" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div id="action-passport" class="card" style="flex-basis: 300px; border-left-color: #EF4444; cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    <div class="card" style="flex-basis: 300px; border-left-color: #F59E0B; cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: #F59E0B;">View Resources</button>
                    </div>
                </div>
            </section>


            <section id="profile" class="tab-content">
                <h2 style="color: #4C1D95;">My Profile & Account</h2>
                <form id="profile-form">


                    <div class="profile-media">
                      <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                      <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>


                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                             <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>


                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>


                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>


                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>


            <section id="calendar" class="tab-content">
                <h2 style="color: #4C1D95;">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>


                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter" onchange="loadAcademicCalendar()">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <div style="overflow-x: auto;"> 
                    <table>
                        <thead>
                            <tr>
                                <th class="date-col">Date & Time</th>
                                <th>Event / Details</th>
                                <th class="session-type-col">Type</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-table">
                            <tr><td colspan="3">Loading academic schedule...</td></tr>
                        </tbody>
                    </table>
                </div>
                </section>


         <section id="courses" class="tab-content">
            <h2 style="color: #4C1D95;">My Courses</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Course Name</th>
                            <th>Unit Code</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="courses-table">
                        <tr><td colspan="4">Loading courses...</td></tr>
                    </tbody>
                </table>
            </div>
            </section>



         <section id="attendance" class="tab-content">
                <h2 style="color: #4C1D95;">Daily Attendance Check-in</h2>


                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>


                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>


                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>


                    <p id="geo-message">Select a **Session Type** and then a specific **Department or Course** to check in at your current GPS location and time.</p>
                </div>


                <h3 style="color: #4C1D95;">Past Attendance History (Check-in Logs)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>Time</th><th>Session Type</th><th>Target</th><th>Location</th><th>Accuracy (m)</th><th>Verified</th></tr></thead>
                        <tbody id="geo-attendance-history">
                            <tr><td colspan="6">Loading geo check-in history...</td></tr>
                        </tbody>
                    </table>
                </div>
                </section>

<section id="cats" class="tab-content">
  <h2 style="color: #4C1D95;">CATS / Exams & Grades</h2>

  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>Exam Name</th>
          <th>Block</th>
          <th>Date</th>
          <th>Status</th>
          <th>CAT (30%)</th>
          <th>Exam (70%)</th>
          <th>Total (100%)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="exams-table">
        <tr>
          <td colspan="8">Loading your exams and grades...</td>
        </tr>
      </tbody>
    </table>
  </div>
  </section>


            <section id="resources" class="tab-content">
                <h2 style="color: #4C1D95;">Learning Resources</h2>
                <div style="display:flex; gap:20px;">
                    <div id="resources-list" style="width:30%; max-height:600px; overflow-y:auto; border-right:1px solid #ddd; padding-right:10px;">
                        Loading resources...
                    </div>

                    <div id="resource-viewer" style="width:70%; min-height:600px; border:1px solid #ddd; padding:10px;">
                        Select a resource to view.
                    </div>
                </div>
            </section>


            <section id="messages" class="tab-content">
                <h2 style="color: #4C1D95;">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>


                <div id="messages-list">
                    </div>
            </section>
        </main>
    </div>


<script>
    // *************************************************************************
    // *** NEW MOBILE MENU LOGIC ***
    // *************************************************************************
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.overlay');

    function toggleMenu() {
        if (sidebar.classList.contains('open')) {
            closeMenu();
        } else {
            openMenu();
        }
    }
    
    function openMenu() {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling the background content
    }

    function closeMenu() {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto'; // Restore scrolling
    }


    // Hides the .html extension in the URL
    if (window.location.pathname.endsWith('.html')) {
        const cleanPath = window.location.pathname.replace(/\.html$/, '');
        window.history.replaceState({}, '', cleanPath);
    }


    // *************************************************************************
    // *** 1. CONFIGURATION AND GLOBAL DECLARATIONS ***
    // *************************************************************************


    // ** SUPABASE CONFIGURATION **
    const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co'; // <--- Update with your actual Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk'; // <--- Update with your actual Anon Key
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
    // üîí Redirect to login if not authenticated
  (async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      window.location.href = '/login';
    } else {
      currentUserId = session.user.id;
    }
  })();

    // ** LOCATIONIQ CONFIGURATION (Geocoding API) **
    const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c'; 
    const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';


    // ** GLOBAL STATE VARIABLES **
    let currentUserId = null;
    let currentUserProfile = null;
    let cachedCourses = []; 
    let cachedExams = [];
    let cachedClinicalAreas = [];
    let cachedResources = []; // Added for new resource logic


    // ** UI ELEMENT REFERENCES **
    const welcomeHeader = document.getElementById('welcome-header'); // Must exist in your HTML
    const sessionTypeSelect = document.getElementById('session-type'); 
    const attendanceTargetSelect = document.getElementById('attendance-target');
    const geoMessage = document.getElementById('geo-message');


    // ** GLOBAL CONSTANTS **
    const SETTINGS_TABLE = 'app_settings'; 
    const MESSAGE_KEY = 'welcome_message';
    const FALLBACK_LAT = 0.00; // Define safe fallback coordinates
    const FALLBACK_LON = 0.00;
    const FALLBACK_ACCURACY = 9999;



// *************************************************************************
// *** 2. UI AND NAVIGATION LOGIC ***
// *************************************************************************
const navLinks = document.querySelectorAll('.nav a');
const tabs = document.querySelectorAll('.tab-content');


function showTab(tabId) {
    navLinks.forEach(l => l.classList.remove('active'));
    const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
    if (activeLink) activeLink.classList.add('active');


    tabs.forEach(tab => tab.classList.remove('active'));
    const activeTab = document.getElementById(tabId);
    if (activeTab) activeTab.classList.add('active');


    // Load data specific to the tab being activated
    if (tabId === 'profile' && currentUserId) loadProfile(currentUserId);
    if (tabId === 'attendance' && currentUserId) {
        loadGeoAttendanceHistory(currentUserId);
        updateTargetSelect(); // CRITICAL: Runs on tab switch to populate the target dropdown
    }
    if (tabId === 'dashboard' && currentUserId) {
        // Core loaders run in checkAuth, just refresh metrics
        loadWelcomeDetails();
        loadDashboardMetrics(currentUserId);
    }
    if (tabId === 'courses' && currentUserId) loadCourses(); 
    if (tabId === 'resources' && currentUserId) loadResources();
    if (tabId === 'cats' && currentUserId) loadExams();
   if (tabId === 'messages' && currentUserId) loadStudentMessagesAndAnnouncements();
    if (tabId === 'calendar' && currentUserId) loadAcademicCalendar();
}


navLinks.forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        showTab(link.dataset.tab);
    });
});


async function logout() {
    sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
    await sb.auth.signOut();
    window.location.href = "login.html";
}


// *************************************************************************
// *** 3. CORE DATA AND DASHBOARD FUNCTIONS ***
// *************************************************************************


/**
 * Load the student header, welcome message, and announcement.
 */
async function loadWelcomeDetails() {
  const studentName = currentUserProfile?.full_name || 'Student';
  const welcomeHeader = document.getElementById('welcome-header');

  if (welcomeHeader) {
    welcomeHeader.textContent = `Hello, ${studentName}!`;
  }

  // Load both welcome and announcement messages
  await loadStudentMessage('student_welcome', 'student-welcome-message');  // short personal welcome
  await loadStudentMessage('welcome_message', 'student-announcement');     // admin announcement
}

/**
 * Load a message from app_settings safely.
 */
async function loadStudentMessage(key, elementId) {
  const element = document.getElementById(elementId);
  if (!element) return;

  element.textContent = 'Loading...';

  try {
    const { data, error } = await sb
      .from('app_settings')
      .select('value')
      .eq('key', key)
      .maybeSingle();

    if (error) throw error;

    if (data && data.value) {
      element.innerHTML = data.value;
    } else {
      element.textContent = 'No message available.';
    }
  } catch (err) {
    console.error(`‚ùå Failed to load ${key}:`, err);
    element.textContent = 'Failed to load message. Please refresh.';
  }
}


/**
 * Calculates and updates all dashboard metrics.
 */
async function loadDashboardMetrics(userId) {
    // --- ACTIVE COURSES ---
    document.getElementById('dashboard-active-courses').textContent = cachedCourses.length;


    // --- OVERALL ATTENDANCE RATE (FIXED LOGIC) ---
    let attendanceRate = 0;
    try {
        const { data: logs, error: attendanceError } = await sb
            .from('geo_attendance_logs')
            .select('is_verified')
            .eq('student_id', userId)
            // Filter logs to last 365 days for "Overall" metric, or remove filter for true "Overall"
            // For now, let's keep it as true overall attendance
            // .gte('check_in_time', new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString()); 


        if (attendanceError) throw attendanceError;


        const totalSessions = logs.length;
        // Count verified logs, treating null/undefined as unverified for safety
        const attended = logs.filter(l => l.is_verified === true).length; 


        attendanceRate = totalSessions > 0 ? Math.round((attended / totalSessions) * 100) : 0;


       document.getElementById('dashboard-attendance-rate').textContent = attendanceRate + '%';
    } catch (err) {
        console.error("Failed to load overall attendance metrics:", err);
        document.getElementById('dashboard-attendance-rate').textContent = 'N/A';
    }


    // --- UPCOMING EXAM ---
    let nextExamText = 'No Exams Scheduled'; 

    if (cachedExams.length > 0) {
        // Filter cached exams to only include future dates and sort them
        const now = new Date(); 
        const upcomingExams = cachedExams
            .filter(exam => new Date(exam.exam_date) > now)
            .sort((a, b) => new Date(a.exam_date) - new Date(b.exam_date));


        if (upcomingExams.length > 0) {
            const upcomingExam = upcomingExams[0];
            const examDate = new Date(upcomingExam.exam_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            nextExamText = `${upcomingExam.exam_name || 'Exam'} on ${examDate}`;
        } else {
            nextExamText = 'Semester Completed'; 
        }
    } 

    document.getElementById('dashboard-upcoming-exam').textContent = nextExamText;


    // --- NEW RESOURCES (FIXED LOGIC) ---
    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
    const newResourcesCount = cachedResources.filter(r => r.created_at >= oneWeekAgo).length;
    document.getElementById('dashboard-new-resources').textContent = newResourcesCount;


    // --- PROFILE COMPLETION CHECK ---
    const passportCard = document.getElementById('action-passport');
    let profileIncomplete = !(currentUserProfile && currentUserProfile.passport_url);
    if (passportCard) passportCard.style.display = profileIncomplete ? 'block' : 'none';


    const actionsContainer = document.getElementById('dashboard-actions');
    const actionTitle = document.getElementById('actions-title');


    if (actionTitle && actionsContainer) {
        const visibleActions = Array.from(actionsContainer.children).filter(child => child.style.display !== 'none').length;
        actionTitle.style.display = visibleActions === 0 ? 'none' : 'block';
    }
}



// *************************************************************************
// *** 4. AUTHENTICATION AND PROFILE MANAGEMENT ***
// *************************************************************************


async function checkAuthAndLoad() {
    const { data: { user } } = await sb.auth.getUser();


    if (user) {
        currentUserId = user.id;
        
        // ** CRITICAL: Load all necessary data FIRST **
        await loadProfile(currentUserId);
        await loadClinicalTargets(); 
        await loadClassTargets(); 
        await loadCourses(); 
        await loadExams(); 
        await loadResources(); // Load resources for the dashboard metric

        // ** THEN, load UI elements and metrics **
        await loadWelcomeDetails();
        showTab('dashboard');
        loadDashboardMetrics(currentUserId);


    } else {
        console.warn("No active user session found. Redirecting to login. (MOCKING DATA LOAD)");
        // window.location.href = "login.html"; // Uncomment for real app


        // --- MOCK DATA LOAD FOR DEVELOPMENT ---
        currentUserId = 'mock_student_uuid'; 
        await loadProfile(currentUserId); // Mocks loading a profile
        await loadClinicalTargets(); 
        await loadClassTargets(); 
        await loadCourses(); 
        await loadExams(); 
        await loadResources();

        await loadWelcomeDetails();
        showTab('dashboard');
        loadDashboardMetrics(currentUserId);
        // --- END MOCK ---
    }
}


const profileForm = document.getElementById('profile-form');
const passportFileInput = document.getElementById('passport-file-input');
const passportPreview = document.getElementById('passport-preview');
const uploadButton = document.getElementById('upload-button');
const profileStatus = document.getElementById('profile-status');
const editProfileButton = document.getElementById('edit-profile-button');
const saveProfileButton = document.getElementById('save-profile-button');
const uploadLabel = document.getElementById('upload-label');


// Loads profile from consolidated_user_profiles_table
async function loadProfile(userId) {
    if (profileStatus) profileStatus.textContent = 'Loading profile...';


    const { data: profile, error } = await sb
        .from('consolidated_user_profiles_table')
        .select('*')
        .eq('user_id', userId)
        .single();


    if (error || !profile) {
        console.error('Error loading consolidated profile:', error);
        if (profileStatus) profileStatus.textContent = 'Profile data missing or restricted. Contact Admin.';
        // Mock/Fallback profile data
        currentUserProfile = {
            full_name: 'Mock Student (ID: ' + userId + ')',
            program: 'ClinicalMedicine',
            block: 'Block_B',
            intake_year: '2024',
            email: 'mock.student@nchsm.edu',
            phone: '+254711000111',
            student_id: 'REG/NCHS/001/2024',
            department: 'ClinicalMedicine'
        };
    } else {
        currentUserProfile = profile;
        if (profileStatus) profileStatus.textContent = '';
    }


    if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').value = currentUserProfile.student_id || 'N/A';
    if (document.getElementById('profile-name')) document.getElementById('profile-name').value = currentUserProfile.full_name || 'N/A';
    if (document.getElementById('profile-email')) document.getElementById('profile-email').value = currentUserProfile.email || 'N/A';
    if (document.getElementById('profile-phone')) document.getElementById('profile-phone').value = currentUserProfile.phone || 'N/A';
    if (document.getElementById('profile-program')) document.getElementById('profile-program').value = currentUserProfile.program || currentUserProfile.department || 'N/A'; 
    if (document.getElementById('profile-block')) document.getElementById('profile-block').value = currentUserProfile.block || 'N/A';
    if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').value = currentUserProfile.intake_year || 'N/A';


    let photoUrl = 'https://via.placeholder.com/150x150?text=NO+PHOTO';
    if (currentUserProfile.passport_url) {
        const publicUrlResponse = sb.storage.from('passports').getPublicUrl(currentUserProfile.passport_url);
        if (publicUrlResponse.data) {
            photoUrl = publicUrlResponse.data.publicUrl;
        }
    }
    if (document.getElementById('passport-preview')) document.getElementById('passport-preview').src = photoUrl;


    toggleProfileEdit(false);
    if (uploadLabel && !currentUserProfile.passport_url) {
        uploadLabel.style.display = 'block';
    }
}


function toggleProfileEdit(enable) {
    const editableFields = ['profile-name', 'profile-phone'];


    editableFields.forEach(id => {
        const input = document.getElementById(id);
        if (input) input.readOnly = !enable;
    });


    if (document.getElementById('profile-student-id')) document.getElementById('profile-student-id').readOnly = true;
    if (document.getElementById('profile-email')) document.getElementById('profile-email').readOnly = true;
    if (document.getElementById('profile-program')) document.getElementById('profile-program').readOnly = true;
    if (document.getElementById('profile-block')) document.getElementById('profile-block').readOnly = true;
    if (document.getElementById('profile-intake-year')) document.getElementById('profile-intake-year').readOnly = true;


    if (editProfileButton) editProfileButton.style.display = enable ? 'none' : 'block';
    if (saveProfileButton) saveProfileButton.style.display = enable ? 'block' : 'none';


    if (uploadLabel) {
        if (enable || !(currentUserProfile && currentUserProfile.passport_url)) {
            uploadLabel.style.display = 'block';
        } else {
            uploadLabel.style.display = 'none';
        }
    }


    if (document.getElementById('upload-button')) document.getElementById('upload-button').style.display = 'none';
}


if (editProfileButton) editProfileButton.addEventListener('click', () => toggleProfileEdit(true));


// Save profile back to consolidated_user_profiles_table
if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (profileStatus) profileStatus.textContent = 'Saving changes...';


        const updates = {
            full_name: document.getElementById('profile-name').value,
            phone: document.getElementById('profile-phone').value,
            updated_at: new Date().toISOString()
        };


        const { error } = await sb
            .from('consolidated_user_profiles_table')
            .update(updates)
            .eq('user_id', currentUserId);


        if (error) {
            if (profileStatus) profileStatus.textContent = `Error saving profile: ${error.message}`;
        } else {
            if (profileStatus) profileStatus.textContent = 'Profile updated successfully!';
            loadProfile(currentUserId);
        }
    });
}


if (passportFileInput) {
    passportFileInput.addEventListener('change', () => {
        const file = passportFileInput.files[0];
        if (file) {
            if (passportPreview) passportPreview.src = URL.createObjectURL(file);
            if (uploadButton) uploadButton.style.display = 'block';
            if (uploadLabel) uploadLabel.style.display = 'none';
        }
    });
}


if (uploadButton) {
    uploadButton.addEventListener('click', async () => {
        const file = passportFileInput.files[0];
        if (!file) {
            if (profileStatus) profileStatus.textContent = 'Please select a file first.';
            return;
        }


        if (profileStatus) profileStatus.textContent = 'Uploading photo...';
        if (uploadButton) uploadButton.disabled = true;


        const fileExt = file.name.split('.').pop();
        const filePath = `${currentUserId}.${fileExt}`;


        const { error: uploadError } = await sb.storage
            .from('passports')
            .upload(filePath, file, { cacheControl: '3600', upsert: true });


        if (uploadError) {
            if (profileStatus) profileStatus.textContent = `Upload failed: ${uploadError.message}`;
            if (uploadButton) uploadButton.disabled = false;
            return;
        }


        const { error: updateError } = await sb
            .from('consolidated_user_profiles_table')
            .update({ passport_url: filePath, updated_at: new Date().toISOString() })
            .eq('user_id', currentUserId);


        if (updateError) {
            if (profileStatus) profileStatus.textContent = `Database update failed: ${updateError.message}`;
        } else {
            if (profileStatus) profileStatus.textContent = 'Photo uploaded and saved successfully!';
            if (passportFileInput) passportFileInput.value = '';
            if (uploadButton) uploadButton.style.display = 'none';
            loadProfile(currentUserId);
        }


        if (uploadButton) uploadButton.disabled = false;
    });
}


// *************************************************************************
// *** 5. ATTENDANCE LOGIC (GeoCheckIn - final) ***
// *************************************************************************

// ====== FIXED COORDINATES FOR AUTO-VERIFY ======
// Class -> Nakuru College of Health Sciences
const COLLEGE_COORDS = {
  name: "Nakuru College of Health Sciences",
  lat: -0.26052375396447247,
  lon: 36.0112920812486
};

// Clinical sites (auto-verify points)
const CLINICAL_SITES = [
  { name: "Nakuru County Teaching and Referral Hospital", lat: -0.27325867625933564, lon: 36.06910844071205 },
  { name: "Eldama Ravine Sub County Hospital", lat: 0.04648281893529269, lon: 35.724600465904835 },
  { name: "Njoro Sub County Hospital", lat: -0.33022116954046055, lon: 35.9433350238334 },
  { name: "Bahati Sub County Hospital", lat: -0.17024189527085296, lon: 36.12342488124838 }
];

// Adjust verification radius here (meters) ‚Äî set to 50 by default
const VERIFICATION_RADIUS_METERS = 50;

// ====== GEO UTILITIES ======
function toRad(x) { return (x * Math.PI) / 180; }

function getDistanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// Wait for best GPS reading (watchPosition) up to timeoutMs, stop if desiredAcc reached
function getAccuratePosition(timeoutMs = 15000, desiredAcc = 20) {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));

    let best = null;
    let settled = false;
    const watchId = navigator.geolocation.watchPosition(
      pos => {
        // keep the best (smallest accuracy)
        if (!best || pos.coords.accuracy < best.coords.accuracy) best = pos;

        // if good enough, stop early
        if (pos.coords.accuracy <= desiredAcc && !settled) {
          settled = true;
          navigator.geolocation.clearWatch(watchId);
          resolve(best);
        }
      },
      err => {
        navigator.geolocation.clearWatch(watchId);
        // Resolve with best if any; otherwise reject with error
        if (best) resolve(best);
        else reject(err);
      },
      { enableHighAccuracy: true, maximumAge: 0 }
    );

    // safety timeout
    setTimeout(() => {
      navigator.geolocation.clearWatch(watchId);
      if (best) resolve(best);
      else reject(new Error("Timeout getting accurate position"));
    }, timeoutMs);
  });
}

/**
 * üí° FIX: Removed the unreliable findClinicalSiteByName helper function
 * and moved the robust matching logic directly into geoCheckIn().
 */

// ---------------------------
// Improved geoCheckIn()
// ---------------------------
async function geoCheckIn() {
  if (!currentUserProfile) await loadProfile(currentUserId);
  const studentProfile = currentUserProfile;
  const deviceId = getDeviceId();
  const sessionType = sessionTypeSelect?.value;
  const targetSelect = attendanceTargetSelect?.value; // format: id|name
  const checkInTime = new Date().toISOString();
  const button = document.getElementById('check-in-button');

  if (!studentProfile || !sessionType || !targetSelect || targetSelect === '') {
    geoMessage.textContent = 'Error: Select session type and target, and ensure profile is loaded.';
    return;
  }

  const [targetId, targetNameRaw] = targetSelect.split('|');
  const targetName = (targetNameRaw || '').trim();

  if (!targetId || !targetName) {
    geoMessage.textContent = 'Error: Invalid target selected.';
    return;
  }

  if (button) button.disabled = true;
  geoMessage.textContent = 'Acquiring accurate GPS ‚Äî please wait (up to 15s)...';

  try {
    // 1) Get accurate position (best effort)
    let pos;
    try {
      pos = await getAccuratePosition(15000, 20); // 15s timeout, 20m desired accuracy
    } catch (err) {
      // If we timed out or error, try single-shot as fallback
      try {
        pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            p => resolve(p),
            e => reject(e),
            { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
          );
        });
      } catch (e2) {
        // fallback to error
        throw new Error('Unable to get location. Ensure location is enabled and try again.');
      }
    }

    const location = {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      acc: pos.coords.accuracy
    };

    // Validate coords
    if (typeof location.lat !== 'number' || typeof location.lon !== 'number' || Number.isNaN(location.lat) || Number.isNaN(location.lon)) {
      geoMessage.textContent = 'Invalid GPS reading ‚Äî try again outdoors.';
      if (button) button.disabled = false;
      return;
    }

    if (Math.abs(location.lat) < 0.00001 && Math.abs(location.lon) < 0.00001) {
      geoMessage.textContent = 'Invalid GPS reading (0,0). Please retry outdoors.';
      if (button) button.disabled = false;
      return;
    }

  // Resolve friendly address (best-effort)
let friendly = `Lat:${location.lat.toFixed(5)}, Lon:${location.lon.toFixed(5)}`;
try {
  const res = await fetch(
    `${LOCATIONIQ_API_URL}?key=${LOCATIONIQ_API_KEY}&lat=${location.lat}&lon=${location.lon}&format=json`
  );
  if (res.ok) {
    const geoData = await res.json();
    friendly = geoData.display_name || friendly;
  }
} catch (e) {
  console.warn("Reverse geocoding failed, using coordinates instead.");
}


    // 2) Determine official target coordinates
    let targetCoords = null;
    let targetTypeName = null;

    if (sessionType === 'Class') {
      // For class sessions, use the college coords (one campus)
      targetCoords = { lat: COLLEGE_COORDS.lat, lon: COLLEGE_COORDS.lon, name: COLLEGE_COORDS.name };
      targetTypeName = COLLEGE_COORDS.name;
    } else if (sessionType === 'Clinical') {
      
      // üí° FIX: Robustly match selected target name/ID to known coordinates.
      
      // 1. Try to match the selected targetName to a clinical site from our hardcoded list
      const matchedSite = CLINICAL_SITES.find(site => 
        targetName.toLowerCase().includes(site.name.toLowerCase()) || 
        site.name.toLowerCase().includes(targetName.toLowerCase())
      );

      if (matchedSite) {
        targetCoords = { lat: matchedSite.lat, lon: matchedSite.lon, name: matchedSite.name };
        targetTypeName = matchedSite.name;
      } else {
        // 2. Fallback: Check cached Clinical Areas (data loaded from Supabase)
        if (Array.isArray(cachedClinicalAreas) && cachedClinicalAreas.length) {
          const matched = cachedClinicalAreas.find(c => 
            (String(c.id) === String(targetId) || (c.name && targetName.toLowerCase().includes(c.name.toLowerCase()))) &&
            typeof c.latitude === 'number' && 
            typeof c.longitude === 'number'
          );
          if (matched) {
            targetCoords = { lat: matched.latitude, lon: matched.longitude, name: matched.name };
            targetTypeName = matched.name;
          }
        }
      }
    }

    // If we still don't have target coords, warn but still log unverified
    if (!targetCoords) {
      geoMessage.textContent = 'Warning: No official coordinates found for this target. Check-in will be recorded as unverified.';
    }

    // 3) Compute distance to target (if available)
    let distanceToTarget = null;
    if (targetCoords) {
      distanceToTarget = getDistanceMeters(location.lat, location.lon, targetCoords.lat, targetCoords.lon);
    }

    // 4) Decide verification
    let isVerified = false;
    if (distanceToTarget !== null) {
      // dynamic allowance: allow buffer by device accuracy if you want
      const allowed = VERIFICATION_RADIUS_METERS + Math.min(location.acc || 0, 150); // small buffer using accuracy, cap 150m
      if (distanceToTarget <= allowed) isVerified = true;
    } else {
      // no target coords -> cannot verify
      isVerified = false;
    }

    // Build payload fields to pass to RPC/insert
    const payload = {
      p_student_id: currentUserId,
      p_check_in_time: checkInTime,
      p_session_type: sessionType,
      p_target_id: targetId || null,
      p_target_name: targetName || (targetTypeName || null),
      p_latitude: location.lat,
      p_longitude: location.lon,
      p_accuracy_m: location.acc,
      p_location_friendly_name: friendly,
      p_program: studentProfile.program || studentProfile.department || null,
      p_block: studentProfile.block || null,
      p_intake_year: studentProfile.intake_year || null,
      p_device_id: deviceId,
      p_is_verified: isVerified
    };

    // Try RPC first (keeps your existing business logic)
    let rpcError = null;
    try {
      const { error } = await sb.rpc('check_in_and_defer_fk', payload);
      if (error) rpcError = error;
    } catch (rpcEx) {
      rpcError = rpcEx;
    }

    // If RPC failed, fallback to direct insert into geo_attendance_logs
    if (rpcError) {
      console.warn('RPC failed, falling back to direct insert:', rpcError);
      try {
        // Map fields to geo_attendance_logs column names
        const insertObj = {
          student_id: currentUserId,
          check_in_time: checkInTime,
          latitude: location.lat,
          longitude: location.lon,
          accuracy_meters: location.acc,
          accuracy_m: location.acc,
          is_verified: isVerified,
          // Use null for target_id, relying on target_name for human readability unless you know the FK relationship
          target_id: null, 
          course_id: (sessionType === 'Class' ? targetId : null),
          session_type: sessionType,
          target_name: targetName || targetTypeName,
          device_id: deviceId,
          target_latitude: targetCoords ? targetCoords.lat : null,
          target_longitude: targetCoords ? targetCoords.lon : null,
          location_friendly_name: friendly,
          program: studentProfile.program || studentProfile.department || null,
          block: studentProfile.block || null,
          intake_year: studentProfile.intake_year || null,
          student_email: studentProfile.email || null,
          student_name: studentProfile.full_name || studentProfile.name || null,
          is_manual_entry: false,
          notes: null
        };

        const { error: insertErr } = await sb.from('geo_attendance_logs').insert(insertObj);
        if (insertErr) {
          throw insertErr;
        }
      } catch (insertEx) {
        console.error('Direct insert failed:', insertEx);
        throw insertEx;
      }
    }

   // 5) Final UI messages + history refresh
if (isVerified) {
  const distText = distanceToTarget !== null ? `${distanceToTarget.toFixed(1)} m` : 'N/A';
  geoMessage.innerHTML = `‚úÖ Auto-verified${targetTypeName ? ' at ' + targetTypeName : ''} ‚Äî distance ${distText} (accuracy ¬±${location.acc.toFixed(1)} m).`;
} else {
  const distText = distanceToTarget !== null ? `${distanceToTarget.toFixed(1)} m` : 'unknown';
  geoMessage.innerHTML = `‚è≥ Check-in recorded (unverified). Distance: ${distText} (accuracy ¬±${location.acc.toFixed(1)} m). Admin verification required.`;
}

// Save some debugging info to console
console.log('GeoCheckIn result', {
  targetCoords,
  location,
  distanceToTarget,
  isVerified,
  payload,
  rpcError
});

// Refresh UI
loadGeoAttendanceHistory(currentUserId);
loadDashboardMetrics(currentUserId);

} catch (e) {
  console.error('GeoCheckIn error:', e);
  geoMessage.textContent = `Error during check-in: ${e.message || e}`;
} finally {
  if (button) button.disabled = false;
}




// *************************************************************************
// *** 6. SUPABASE DATA LOADING FUNCTIONS (Courses, Exams, Resources) ***
// *************************************************************************


/**
 * loadCourses() fetches student-specific courses.
 */
async function loadCourses() {
    const tableBody = document.getElementById('courses-table');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4">Loading courses...</td></tr>';

    if (!currentUserProfile) await loadProfile(currentUserId); 
    const program = currentUserProfile?.program || currentUserProfile?.department; 
    const block = currentUserProfile?.block;
    const intakeYear = currentUserProfile?.intake_year;

    if (!program || !intakeYear) {
        tableBody.innerHTML = `<tr><td colspan="4">Missing program or intake year info. Cannot load courses.</td></tr>`;
        cachedCourses = [];
        return;
    }

    try {
        // Flexible filter for the block field
        const blockFilter = `block.eq.${block},block.is.null,block.eq.General`;

        const { data: courses, error } = await sb
            .from('courses')
            .select('*')
            .or(`target_program.eq.${program},target_program.eq.General`)
            .eq('intake_year', intakeYear)
            .or(blockFilter)
            .order('course_name', { ascending: true });

        if (error) throw error;

        cachedCourses = courses || [];
        
        tableBody.innerHTML = '';
        if (cachedCourses.length > 0) {
            cachedCourses.forEach(c => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${c.course_name || 'N/A'}</td>
                        <td>${c.unit_code || 'N/A'}</td>
                        <td>${c.description || 'N/A'}</td>
                        <td>${c.status || 'N/A'}</td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = `<tr><td colspan="4">No courses found.</td></tr>`;
        }

    } catch (error) {
        console.error("‚ùå Failed to load courses:", error);
        tableBody.innerHTML = `<tr><td colspan="4" style="color:#EF4444;">Error loading courses: ${error.message}</td></tr>`;
        cachedCourses = [];
    }

    if (typeof loadDashboardMetrics === "function") {
        loadDashboardMetrics(currentUserId);
    }
}


// Utility to safely escape HTML
function escapeHtml(str) {
    if (!str) return '';
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}


/**
 * Student Dashboard: loadExams()
 * Displays student's exams with scores and exam link (if available)
 */
async function loadExams() {
  const tableBody = document.getElementById('exams-table');
  if (!tableBody) return;

  tableBody.innerHTML = '<tr><td colspan="8">Loading your exams and grades...</td></tr>';

  if (!currentUserProfile) await loadProfile(currentUserId);
  const program = currentUserProfile?.program || currentUserProfile?.department;
  const block = currentUserProfile?.block;
  const intakeYear = currentUserProfile?.intake_year;

  if (!program || !intakeYear) {
    tableBody.innerHTML = `<tr><td colspan="8">Missing program or intake year info. Cannot load exams.</td></tr>`;
    cachedExams = [];
    return;
  }

  try {
    const { data: exams, error } = await sb
      .from('exams_with_courses')
      .select(`
        id,
        exam_name,
        exam_date,
        status,
        block_term,
        program_type,
        exam_link,
        exam_grades!left(student_id, cat_score, exam_score, total_score)
      `)
      .or(`program_type.eq.${program},program_type.eq.General`)
      .or(`block_term.eq.${block},block_term.is.null,block_term.eq.General`)
      .eq('intake_year', intakeYear)
      .order('exam_date', { ascending: true });

    if (error) throw error;

    cachedExams = exams || [];
    tableBody.innerHTML = '';

    if (cachedExams.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="8">
            No exams or CATs scheduled.
          </td>
        </tr>`;
      return;
    }

    cachedExams.forEach(exam => {
      const dateStr = exam.exam_date
        ? new Date(exam.exam_date).toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          })
        : 'N/A';

      const catScore = exam.exam_grades?.[0]?.cat_score ?? '-';
      const examScore = exam.exam_grades?.[0]?.exam_score ?? '-';
      const totalScore = exam.exam_grades?.[0]?.total_score ?? '-';

      const actionBtn = exam.exam_link
        ? `<a href="${exam.exam_link}" target="_blank" class="btn btn-sm btn-primary">Start Exam</a>`
        : `<span style="color:gray;">No Link</span>`;

      tableBody.innerHTML += `
        <tr>
          <td>${escapeHtml(exam.exam_name || 'N/A')}</td>
          <td>${escapeHtml(exam.block_term || 'N/A')}</td>
          <td>${dateStr}</td>
          <td>${escapeHtml(exam.status || 'Scheduled')}</td>
          <td>${catScore}</td>
          <td>${examScore}</td>
          <td>${totalScore}</td>
          <td>${actionBtn}</td>
        </tr>
      `;
    });

  } catch (error) {
    console.error('‚ùå Failed to load exams:', error);
    tableBody.innerHTML = `<tr><td colspan="8" style="color:#EF4444;">Error loading exams: ${error.message}</td></tr>`;
    cachedExams = [];
  }

  if (typeof loadDashboardMetrics === 'function') {
    loadDashboardMetrics(currentUserId);
  }
}


/**
 * loadResources() fetches student-specific learning materials and caches them.
 * FIXED: Ensures the resource list is generated on load.
 */
async function loadResources() {
    // Ensure profile data is loaded
    if (!currentUserProfile) await loadProfile(currentUserId); 

    const resourceListContainer = document.getElementById('resources-list');
    if (!resourceListContainer) return;
    resourceListContainer.innerHTML = 'Loading resources...';
    cachedResources = []; // Clear old cache

    try {
        const program = currentUserProfile?.program || currentUserProfile?.department;
        const block = currentUserProfile?.block;
        const intakeYear = currentUserProfile?.intake_year;

        if (!program || !intakeYear) {
            resourceListContainer.innerHTML = '<p>Missing enrollment details (program or intake year).</p>';
            return;
        }

        // --- Supabase Query ---
        const { data: resources, error } = await sb
            .from('resources')
            .select('id, title, file_path, file_url, program_type, block_term, block, intake_year, intake, uploaded_by_name, created_at, allow_download')
            .or(`program_type.eq.${program},program_type.eq.General`)
            // Match against both block_term (for resources) and block (from profile)
            .or(`block_term.eq.${block},block_term.is.null,block_term.eq.General`)
            // Match against both intake_year (for resources) and intake (from profile)
            .or(`intake_year.eq.${intakeYear},intake_year.is.null`)
            .order('created_at', { ascending: false });

        if (error) throw error;

        cachedResources = resources || [];
        
        // --- Render List ---
        resourceListContainer.innerHTML = '';
        if (cachedResources.length === 0) {
            resourceListContainer.innerHTML = `<p>No learning resources found.</p>`;
            return;
        }

        cachedResources.forEach(res => {
             const displayDate = new Date(res.created_at).toLocaleDateString('en-US');
             resourceListContainer.innerHTML += `
                <div class="resource-item" onclick="viewResource('${res.id}')" style="cursor:pointer; flex-direction: column; align-items: flex-start;">
                    <strong style="color: #4C1D95;">${escapeHtml(res.title)}</strong>
                    <p style="margin:5px 0 0;font-size:0.8em;color:#6B7280;">
                        Uploaded: ${displayDate} 
                        (${res.program_type === 'General' ? 'General' : res.program_type})
                    </p>
                </div>
            `;
        });
        
        // Load the first resource automatically
        if(cachedResources.length > 0) {
            viewResource(cachedResources[0].id);
        }
        
    } catch (error) {
        console.error("‚ùå Failed to load resources:", error);
        resourceListContainer.innerHTML = `<p style="color:#EF4444;">Error loading resources: ${error.message}</p>`;
    }

    if (typeof loadDashboardMetrics === "function") {
        loadDashboardMetrics(currentUserId); // Update the dashboard metric
    }
}


/**
 * Generates and displays the iframe for the selected resource.
 */
function viewResource(resourceId) {
    const resourceViewer = document.getElementById('resource-viewer');
    const resource = cachedResources.find(r => r.id == resourceId);

    if (!resource || !resourceViewer) {
        resourceViewer.innerHTML = 'Resource not found.';
        return;
    }

    let previewHtml = '';
    const fileUrl = resource.file_url;
    const ext = (resource.file_path || '').split('.').pop().toLowerCase();
    
    // Default to PDF view
    if (ext === 'pdf') {
        previewHtml = `<iframe src="${fileUrl}" width="100%" height="580px" style="border:none;"></iframe>`;
    } 
    // Office file preview via Microsoft Viewer
    else if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(ext)) {
        const encoded = encodeURIComponent(fileUrl);
        previewHtml = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encoded}" width="100%" height="580px" style="border:none;"></iframe>`;
    } 
    // Simple link for other types
    else {
        previewHtml = `<p>This file type (<strong>.${ext}</strong>) cannot be previewed directly.</p>`;
    }

    const downloadBtn = resource.allow_download 
        ? `<a href="${fileUrl}" download class="profile-button" style="display:block; text-align:center; margin-top:10px; background-color: #10B981;">Download File</a>` 
        : `<p style="color:#EF4444; margin-top:10px;">Download not permitted for this resource.</p>`;

    resourceViewer.innerHTML = `
        <h3 style="color: #4C1D95; margin-bottom: 5px;">${escapeHtml(resource.title)}</h3>
        <p style="font-size: 0.9em; color: #6B7280;">Uploaded by: ${escapeHtml(resource.uploaded_by_name || 'Admin')} on ${new Date(resource.created_at).toLocaleDateString()}</p>
        ${previewHtml}
        ${downloadBtn}
    `;
}


// *************************************************************************
// *** 7. ACADEMIC CALENDAR LOGIC ***
// *************************************************************************
async function fetchAllScheduleData() {
    // Ensure profile data is loaded before reading it
    if (!currentUserProfile || !currentUserProfile.program && !currentUserProfile.department || !currentUserProfile.intake_year) {
        await loadProfile(currentUserId); 
    }


    // FIX: Use the combined program/department value
    const program = currentUserProfile?.program || currentUserProfile?.department;
    const block = currentUserProfile?.block;
    const intakeYear = currentUserProfile?.intake_year;


    if (!program || !block || !intakeYear) return [];


    // Note: sessionPromise and examsPromise are currently empty/placeholder in the HTML's logic.
    const sessionsPromise = Promise.resolve([]); 
    const examsPromise = Promise.resolve(cachedExams.map(e => ({ // Use cached exams for calendar
        date: e.exam_date,
        title: e.exam_name,
        type: 'Exam',
        details: `${e.status || 'Scheduled'} - Block ${e.block_term}`
    })));


    // Holidays/Academic Events
    const eventsPromise = sb
        .from('calendar_events')
        .select('event_name, event_date, type, description, target_program, target_block, target_intake_year')
        .or(`target_program.eq.${program},target_program.eq.General`)
        .or(`target_block.eq.${block},target_block.is.null`)
        .eq('target_intake_year', intakeYear)
        .then(({ data, error }) => {
            if (error) { console.error("Events error:", error); return []; }
            return (data || []).map(e => ({
                date: e.event_date,
                title: e.event_name,
                type: e.type,
                details: e.description
            }));
        });


    const results = await Promise.all([sessionsPromise, examsPromise, eventsPromise]);
    return results.flat();
}


async function loadAcademicCalendar() {
    const tableBody = document.getElementById('calendar-table');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="3">Loading academic schedule...</td></tr>';


    try {
        const allEvents = await fetchAllScheduleData();
        const filterType = document.getElementById('calendar-filter').value;


        // Filtering logic
        const filteredEvents = allEvents
            .filter(e => filterType === 'all' || e.type === filterType)
            .sort((a, b) => new Date(a.date) - new Date(b.date)); 


        tableBody.innerHTML = '';


        if (filteredEvents.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3">No scheduled events found for the selected filter (${filterType}).</td></tr>`;
            return;
        }


        filteredEvents.forEach(event => {
            const dateStr = new Date(event.date).toLocaleString();
            const row = `
                <tr>
                    <td class="date-col">${dateStr}</td>
                    <td>${event.title} (${event.details})</td>
                    <td class="session-type-col ${event.type}">${event.type}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });


    } catch (error) {
        console.error("Failed to load academic calendar:", error);
        tableBody.innerHTML = '<tr><td colspan="3" style="color:#EF4444;">Error loading calendar data.</td></tr>';
    }
}


// *************************************************************************
// *** 8. MESSAGES LOGIC (Combined Personal + Official Announcements) ***
// *************************************************************************

/**
 * Load all messages and announcements for the student.
 */
async function loadStudentMessagesAndAnnouncements() {
    // Ensure profile data is loaded before reading it
    if (!currentUserProfile || (!currentUserProfile.program && !currentUserProfile.department)) {
        await loadProfile(currentUserId);
    }

    const program = currentUserProfile?.program || currentUserProfile?.department;
    const messageContainer = document.getElementById('messages-list');
    if (!messageContainer) return;

    messageContainer.innerHTML = 'Loading messages...';

    try {
        // 1Ô∏è‚É£ Load personal messages
        const { data: personalMessages, error: personalError } = await sb
            .from('student_messages')
            .select('*')
            .or(`recipient_id.eq.${currentUserId},recipient_program.eq.${program}`)
            .order('created_at', { ascending: false });

        if (personalError) throw personalError;

        // 2Ô∏è‚É£ Load official announcements
        const { data: notifications, error: notifError } = await sb
            .from('notifications')
            .select('*')
            .or(`target_program.eq.${program},target_program.is.null`)
            .order('created_at', { ascending: false });

        if (notifError) throw notifError;

        // Combine messages, with personal messages first
        const allMessages = [
            ...(personalMessages || []),
            ...(notifications || [])
        ];

        messageContainer.innerHTML = '';
        if (allMessages.length === 0) {
            messageContainer.innerHTML = '<p>No messages or announcements at this time.</p>';
            return;
        }

        // Render each message/announcement
        allMessages.forEach(msg => {
            const title = msg.subject || msg.title || 'Message';
            const body = msg.body || msg.message || msg.message_content || '';
            const isRead = msg.is_read ? 'read' : 'unread';
            const createdAt = msg.created_at ? new Date(msg.created_at).toLocaleDateString() : '';

            messageContainer.innerHTML += `
                <div class="message-item ${isRead}" style="border-left: 4px solid ${msg.is_read ? '#10B981' : '#F59E0B'}; padding: 15px; margin-bottom: 10px; background-color: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div class="message-header" style="display: flex; justify-content: space-between; font-weight: bold; color: #4C1D95;">
                        <span class="message-title">${title}</span>
                        <span class="message-date" style="font-weight: normal; color: #6B7280;">${createdAt}</span>
                    </div>
                    <div class="message-body" style="margin-top: 5px; color: #374151;">${body.substring(0, 300)}</div>
                    <span class="message-status" style="font-size: 0.8em; color: ${msg.is_read ? '#10B981' : '#F59E0B'}; margin-top: 5px; display: inline-block;">Status: ${isRead.toUpperCase()}</span>
                </div>
            `;
        });

    } catch (error) {
        console.error("Failed to load student messages and announcements:", error);
        messageContainer.innerHTML = '<p style="color:#EF4444;">Error loading messages and announcements.</p>';
    }
}


// *************************************************************************
// *** 9. INITIALIZATION ***
// *************************************************************************


// Start the authentication check once the script is loaded
checkAuthAndLoad();


</script>
</body>
</html>
