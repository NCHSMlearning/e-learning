<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /*
        * CRITICAL FIX: Only show the active tab content
        */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Set Inter font and warmer background */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f8f9fa; /* Light background */
        }

        /* Sidebar link styling */
        .nav-link {
            transition: all 0.2s ease-in-out;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            border-radius: 0.75rem; /* Smoother corners */
        }
        .nav-link:hover {
            background-color: #1e293b; /* Slate 800 on hover */
        }
        .nav-link.active {
            background-color: #10b981; /* Emerald 500 for active link */
            color: #ffffff;
            font-weight: 600;
        }
        
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #e2e8f0; /* Light grey */
            border-top: 4px solid #10b981; /* Emerald */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        /* Small Loader for async content */
        .loader-small {
            border: 3px solid #f3f3f3; /* Light grey */
            border-top: 3px solid #10b981; /* Emerald */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Styling */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;} 
            to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Main Content Wrapper -->
    <div id="app-container" class="flex flex-col lg:flex-row min-h-screen">

        <!-- Sidebar (Hidden on mobile by default) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:relative lg:flex lg:flex-col w-64 bg-slate-900 text-white p-4 space-y-4 transition-transform duration-300 z-50 shadow-2xl">
            <div class="text-2xl font-bold text-emerald-400 mb-6">
                NCHSM Portal
            </div>
            
            <nav class="flex-grow space-y-2">
                <!-- 1. Dashboard -->
                <a href="#" data-tab="dashboard" class="nav-link active" id="dashboard-link">
                    <!-- Icon: Home -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Dashboard
                </a>
                
                <!-- 2. Profile -->
                <a href="#" data-tab="profile" class="nav-link" id="profile-link">
                    <!-- Icon: User -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Profile
                </a>

                <!-- 3. My Courses -->
                <a href="#" data-tab="courses" class="nav-link" id="courses-link">
                    <!-- Icon: Book Open -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    My Courses
                </a>

                <!-- 4. Attendance (Check-in) -->
                <a href="#" data-tab="attendance" class="nav-link" id="attendance-link">
                    <!-- Icon: Users/Attendance -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 10V6"/><path d="M18 10V6"/><path d="M20 18v-8"/></svg>
                    Attendance
                </a>

                <!-- 5. CATS/Exams -->
                <a href="#" data-tab="cats" class="nav-link" id="cats-link">
                    <!-- Icon: Graduation Cap -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21.42 10.922a1 1 0 0 0-.019-1.843L15 6 9 3 2.5 6.5l6 3.5 3.5-2z"/><path d="M11 11v11a1 1 0 0 1-2 0V11"/><path d="M22 10v11a1 1 0 0 1-2 0V10"/><line x1="12" x2="12" y1="14" y2="22"/></svg>
                    CATS/Exams
                </a>

                <!-- 6. Resources (formerly Documents) -->
                <a href="#" data-tab="resources" class="nav-link" id="resources-link">
                    <!-- Icon: Folders -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M4 20h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-7.93a1 1 0 0 0-.68.28L8 8H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2z"/></svg>
                    Resources
                </a>

                <!-- 7. Messages -->
                <a href="#" data-tab="messages" class="nav-link" id="messages-link">
                    <!-- Icon: Message Square -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    Messages
                </a>
            </nav>

            <a href="#" class="nav-link bg-red-700 hover:bg-red-800" id="logout-link">
                <!-- Icon for Logout -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                Logout (Guest ID)
            </a>
            
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 transition-all duration-300 overflow-y-auto">
            <!-- Header for Mobile -->
            <header class="flex justify-between items-center lg:hidden mb-4">
                <div class="text-xl font-bold text-slate-800">NCHSM Portal</div>
                <button id="menu-toggle" class="p-2 rounded-md text-slate-800 hover:bg-gray-200 focus:outline-none">
                    <!-- Menu Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="18" y2="18"/></svg>
                </button>
            </header>

            <!-- Loading Screen / Authentication required -->
            <div id="loading-screen" class="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center z-40 transition-opacity duration-500">
                <div class="loader mb-4"></div>
                <p class="text-lg font-medium text-slate-600" id="loading-message">Initializing...</p>
            </div>

            <!-- Content Tabs -->
            <div id="content-area" class="hidden">
                <h1 class="text-3xl font-extrabold text-slate-800 mb-6" id="current-tab-title">Student Dashboard</h1>
                
                <!-- 1. Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active bg-white p-6 md:rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-2 text-emerald-600">Welcome!</h2>
                    <div id="welcome-message" class="bg-gray-50 p-4 rounded-xl shadow-inner text-gray-700 italic border-l-4 border-emerald-500 min-h-[5rem] flex items-center justify-center">
                        <span class="loader-small"></span> Loading welcome message...
                    </div>
                    <p class="mt-4 text-gray-600">This is your main student portal, powered by Supabase. Use the navigation on the left to access all portal features.</p>
                </div>

                <!-- 2. Profile Tab (NEW) -->
                <div id="tab-profile" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">My Profile</h2>
                    <p class="text-gray-600">This section will show personal information, contact details, and student ID.</p>
                    <div class="mt-4 p-4 border rounded-lg bg-yellow-50 text-yellow-800">
                        <p><strong>Placeholder:</strong> User information and editing functionality will be built here.</p>
                    </div>
                </div>

                <!-- 3. My Courses Tab (NEW) -->
                <div id="tab-courses" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">My Courses</h2>
                    <p class="text-gray-600">View your enrolled courses, schedules, and overall progress.</p>
                    <div class="mt-4 p-4 border rounded-lg bg-yellow-50 text-yellow-800">
                        <p><strong>Placeholder:</strong> Course listings, grades, and resources will be displayed here.</p>
                    </div>
                </div>

                <!-- 4. Attendance Check-in Tab -->
                <div id="tab-attendance" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-6 border-b pb-2">Daily Attendance Check-in</h2>
                    
                    <div class="mb-6 bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                        <p class="text-sm font-semibold text-emerald-700">Guest User ID:</p>
                        <p id="current-user-id" class="break-all font-mono text-xs text-emerald-600 mt-1"></p>
                    </div>

                    <form id="attendance-form" class="space-y-4 max-w-lg">
                        <div>
                            <label for="session-type-select" class="block text-sm font-medium text-gray-700 mb-1">Session Type:</label>
                            <select id="session-type-select" name="session-type" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm bg-white">
                                <option value="" disabled selected>Select Session Type</option>
                                <option value="class">On Class</option>
                                <option value="clinicals">On Clinicals</option>
                            </select>
                        </div>

                        <div>
                            <label id="session-detail-label" for="session-detail-select" class="block text-sm font-medium text-gray-700 mb-1">Detail (Course/Department):</label>
                            <select id="session-detail-select" name="session-detail" required
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md shadow-sm bg-white" disabled>
                                <option value="" disabled selected>Select a Detail</option>
                            </select>
                        </div>
                        
                        <button id="check-in-button" type="submit" disabled
                            class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-xl text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            Check In
                        </button>
                         <p id="geoloc-status" class="text-sm text-gray-500 mt-2">Status: Awaiting Check-in...</p>
                    </form>

                    <h3 class="text-xl font-bold text-slate-700 mt-8 mb-4 border-b pb-2">Recent Attendance</h3>
                    <div id="recent-attendance-list" class="space-y-3">
                        <div class="text-gray-500">Loading attendance history...</div>
                    </div>
                </div>

                <!-- 5. CATS/Exams Tab (NEW) -->
                <div id="tab-cats" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">CATS/Exams</h2>
                    <p class="text-gray-600">Track your Continuous Assessment Tests (CATS) and final exam scores.</p>
                    <div class="mt-4 p-4 border rounded-lg bg-yellow-50 text-yellow-800">
                        <p><strong>Placeholder:</strong> Scores, upcoming exam schedules, and results publication will go here.</p>
                    </div>
                </div>

                <!-- 6. Resources Tab (RENAMED) -->
                <div id="tab-resources" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">Academic Resources</h2>
                    <p class="text-gray-600">Access vital academic resources, handbooks, and clinical protocols.</p>
                    <ul class="mt-4 space-y-2 text-emerald-600">
                        <li><a href="#" class="hover:underline">Student Handbook 2024 (PDF)</a></li>
                        <li><a href="#" class="hover:underline">Clinical Rotation Schedule (XLSX)</a></li>
                        <li><a href="#" class="hover:underline">Emergency Protocol Checklist</a></li>
                    </ul>
                </div>

                <!-- 7. Messages Tab (NEW) -->
                <div id="tab-messages" class="tab-content hidden p-6 bg-white md:rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">Messages</h2>
                    <p class="text-gray-600">Your communication hub for important alerts and messages from faculty.</p>
                    <div class="mt-4 p-4 border rounded-lg bg-yellow-50 text-yellow-800">
                        <p><strong>Placeholder:</strong> An inbox system for communication will be implemented here.</p>
                    </div>
                </div>

            </div>
        </main>

        <!-- Toast Notification -->
        <div id="toast" class="toast-hidden"></div>
    </div>

    <script type="module">
        // ** SUPABASE CONFIGURATION **
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ** LOCATIONIQ CONFIGURATION (Geocoding API) **
        const LOCATIONIQ_API_KEY = 'pk.cbe61eae35ecbe1d1d682c347d81381c';
        const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';
        
        // Global App variables
        let currentUserId = null;
        const GUEST_ID_KEY = 'nchsm_guest_id';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Supabase Table Names
        const ATTENDANCE_TABLE = 'attendance';
        const SETTINGS_TABLE = 'settings';
        const WELCOME_KEY = 'welcome_message';

        // Mock Data for dynamic dropdowns
        const COURSES = [
            { id: 'anatomy', name: 'Anatomy 101' },
            { id: 'physiology', name: 'Physiology 202' },
            { id: 'pharm', name: 'Pharmacology 303' },
            { id: 'pathology', name: 'Pathology 404' },
        ];

        const DEPARTMENTS = [
            { id: 'pediatrics', name: 'Pediatrics' },
            { id: 'surgery', name: 'General Surgery' },
            { id: 'er', name: 'Emergency Room' },
            { id: 'icu', name: 'Intensive Care Unit (ICU)' },
            { id: 'obgyn', name: 'Obstetrics/Gynecology (OB-GYN)' },
        ];

        // UI Elements
        const loadingScreen = document.getElementById('loading-screen');
        const contentArea = document.getElementById('content-area');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const logoutLink = document.getElementById('logout-link');
        const checkInButton = document.getElementById('check-in-button');
        const sessionTypeSelect = document.getElementById('session-type-select');
        const sessionDetailSelect = document.getElementById('session-detail-select');
        const attendanceForm = document.getElementById('attendance-form');
        const attendanceList = document.getElementById('recent-attendance-list');
        const userIdDisplay = document.getElementById('current-user-id');
        const welcomeMessageElement = document.getElementById('welcome-message');
        const geolocStatus = document.getElementById('geoloc-status');
        const tabTitle = document.getElementById('current-tab-title');

        // --- Utility Functions ---

        /**
         * Shows a transient toast notification.
         */
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'show';
            toast.style.backgroundColor = isError ? '#ef4444' : '#10b981';
            setTimeout(function(){ toast.className = toast.className.replace('show', ''); }, 3000);
        }

        /**
         * Toggles the mobile sidebar visibility.
         */
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }

        /**
         * Switches the active content tab.
         */
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-tab') === tabId) {
                    link.classList.add('active');
                    // Update main title
                    tabTitle.textContent = link.textContent.trim(); 
                }
            });
        }

        /**
         * Generates or retrieves a persistent Guest User ID.
         */
        function getOrCreateGuestId() {
            let id = localStorage.getItem(GUEST_ID_KEY);
            if (!id) {
                // Generate a simple UUID if not found
                id = crypto.randomUUID();
                localStorage.setItem(GUEST_ID_KEY, id);
            }
            return id;
        }

        // --- Attendance UI/Helper Functions ---

        /**
         * Validates the form state and enables/disables the check-in button.
         */
        function validateAttendanceForm() {
            const typeSelected = sessionTypeSelect.value !== '';
            const detailSelected = sessionDetailSelect.value !== '';
            
            if (typeSelected && detailSelected) {
                checkInButton.disabled = false;
            } else {
                checkInButton.disabled = true;
            }
            // Ensure the detail select is enabled if a type is chosen
            sessionDetailSelect.disabled = !typeSelected;
        }

        /**
         * Updates the detail dropdown based on session type (Class/Clinicals).
         */
        function updateAttendanceDetail(sessionType) {
            const sessionDetailSelect = document.getElementById('session-detail-select');
            sessionDetailSelect.innerHTML = '<option value="" disabled selected>Select a Detail</option>';
            let details = [];
            let labelText = 'Detail (Course/Department):'; 

            if (sessionType === 'class') {
                details = COURSES;
                labelText = 'Course:';
            } else if (sessionType === 'clinicals') {
                details = DEPARTMENTS;
                labelText = 'Hospital Department:';
            }

            // Update the label dynamically
            document.getElementById('session-detail-label').textContent = labelText;
            
            // Populate options
            details.forEach(detail => {
                const option = document.createElement('option');
                option.value = detail.id;
                option.textContent = detail.name;
                sessionDetailSelect.appendChild(option);
            });

            // Re-validate the form after updating details
            validateAttendanceForm();
        }

        // --- Supabase and LocationIQ Functions ---

        /**
         * Ensures a default welcome message exists in the settings table.
         */
        async function ensureDefaultWelcomeMessage() {
            try {
                const { data: existing, error: selectError } = await sb
                    .from(SETTINGS_TABLE)
                    .select('*')
                    .eq('key', WELCOME_KEY);

                if (selectError) throw selectError;

                if (!existing || existing.length === 0) {
                    console.log("Setting default welcome message...");
                    const { error: insertError } = await sb
                        .from(SETTINGS_TABLE)
                        .insert({
                            key: WELCOME_KEY,
                            value: "A warm welcome to the NCHSM Student Portal! This message is editable by an administrator.",
                            app_id: APP_ID
                        });
                    if (insertError) throw insertError;
                }
            } catch (e) {
                console.error("Error ensuring default welcome message:", e);
            }
        }

        /**
         * Loads the welcome message in real-time using Supabase Realtime.
         */
        function loadWelcomeMessage() {
            // Initial fetch
            sb.from(SETTINGS_TABLE)
                .select('value')
                .eq('key', WELCOME_KEY)
                .then(({ data, error }) => {
                    if (error) throw error;
                    if (data && data.length > 0) {
                        welcomeMessageElement.classList.remove('justify-center');
                        welcomeMessageElement.innerHTML = data[0].value;
                    } else {
                        welcomeMessageElement.classList.add('justify-center');
                        welcomeMessageElement.innerHTML = "No welcome message configured by the admin yet.";
                    }
                })
                .catch(e => {
                    console.error("Error initial loading welcome message:", e);
                    welcomeMessageElement.classList.add('justify-center');
                    welcomeMessageElement.innerHTML = "Error loading message. Please try refreshing.";
                });

            // Set up Realtime listener for changes
            sb.channel('public:settings')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: SETTINGS_TABLE, filter: `key=eq.${WELCOME_KEY}` }, (payload) => {
                    if (payload.new.value) {
                        welcomeMessageElement.classList.remove('justify-center');
                        welcomeMessageElement.innerHTML = payload.new.value;
                        showToast("Welcome message updated by admin!");
                    }
                })
                .subscribe();
        }

        /**
         * Loads recent attendance records in real-time using Supabase Realtime.
         */
        function loadRecentAttendance(userId) {
            
            attendanceList.innerHTML = '<div class="flex items-center text-gray-500"><span class="loader-small"></span> Loading history...</div>';

            const renderList = (records) => {
                if (records.length === 0) {
                    attendanceList.innerHTML = '<p class="text-gray-500 italic">No attendance records found yet. Check in to start!</p>';
                    return;
                }

                // Sort the records client-side by created_at (latest first)
                records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                attendanceList.innerHTML = ''; // Clear loading message

                records.slice(0, 10).forEach(record => {
                    const dateStr = new Date(record.created_at).toLocaleString();
                    const typeDisplay = record.type === 'class' ? 'Class' : 'Clinical';
                    
                    let detailName = 'N/A';
                    if (record.type === 'class') {
                        const course = COURSES.find(c => c.id === record.detail);
                        detailName = course ? course.name : record.detail;
                    } else if (record.type === 'clinicals') {
                        const department = DEPARTMENTS.find(d => d.id === record.detail);
                        detailName = department ? department.name : record.detail;
                    }

                    const locationDisplay = record.location_data || 'Location Unknown';

                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200';
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-slate-700">${typeDisplay} Check-in: <span class="text-emerald-600">${detailName}</span></p>
                            </div>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 truncate">@ ${locationDisplay}</p>
                    `;
                    attendanceList.appendChild(item);
                });
            };

            // Initial data fetch
            sb.from(ATTENDANCE_TABLE)
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(10)
                .then(({ data, error }) => {
                    if (error) throw error;
                    renderList(data);
                })
                .catch(e => {
                    console.error("Error initial loading attendance:", e);
                    attendanceList.innerHTML = '<p class="text-red-500">Error loading attendance history. Check console for details.</p>';
                });

            // Set up Realtime listener for new inserts
            sb.channel('public:attendance')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: ATTENDANCE_TABLE, filter: `user_id=eq.${userId}` }, (payload) => {
                    // Refetch all and re-render to ensure sorting and limits are respected
                    sb.from(ATTENDANCE_TABLE)
                        .select('*')
                        .eq('user_id', userId)
                        .then(({ data, error }) => {
                            if (error) throw error;
                            renderList(data);
                        })
                        .catch(e => console.error("Error updating list via Realtime:", e));
                })
                .subscribe();
        }

        /**
         * Gets the user's current position and converts it to a readable address using LocationIQ.
         * @returns {Promise<string>} The formatted address string.
         */
        async function getGeolocationAndReverseGeocode() {
            return new Promise((resolve, reject) => {
                geolocStatus.textContent = 'Status: Fetching geolocation...';
                
                // 1. Get Geolocation
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation is not supported by this browser."));
                    return;
                }

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    geolocStatus.textContent = `Status: Location found (${lat.toFixed(4)}, ${lon.toFixed(4)}). Reverse geocoding...`;

                    // 2. Reverse Geocode via LocationIQ
                    const url = new URL(LOCATIONIQ_API_URL);
                    url.searchParams.append('key', LOCATIONIQ_API_KEY);
                    url.searchParams.append('lat', lat);
                    url.searchParams.append('lon', lon);
                    url.searchParams.append('format', 'json');

                    try {
                        const response = await fetch(url.toString());
                        const data = await response.json();

                        if (data.error) {
                            console.warn("LocationIQ Error:", data.error);
                            resolve(`Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)} (Geocode failed)`);
                            return;
                        }

                        // Format the address for display
                        const address = data.display_name || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                        geolocStatus.textContent = `Status: Location resolved.`;
                        resolve(address);

                    } catch (error) {
                        console.error("LocationIQ Fetch Error:", error);
                        resolve(`Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)} (API error)`);
                    }
                }, (error) => {
                    let errorMessage = 'Geolocation failed.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Location required: Please allow location access to check-in.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Location request timed out.";
                            break;
                        default:
                            errorMessage = "An unknown error occurred while getting location.";
                            break;
                    }
                    geolocStatus.textContent = `Status: ${errorMessage}`;
                    reject(new Error(errorMessage));
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }


        /**
         * Handles the final check-in process, including geolocation and Supabase insertion.
         */
        async function handleCheckIn(e) {
            e.preventDefault();
            checkInButton.disabled = true;
            checkInButton.innerHTML = '<span class="loader-small mr-2"></span> Submitting...';
            
            const sessionType = sessionTypeSelect.value;
            const sessionDetail = sessionDetailSelect.value;

            if (!sessionType || !sessionDetail) {
                showToast("Please select both Session Type and Detail.", true);
                checkInButton.disabled = false;
                checkInButton.textContent = 'Check In';
                return;
            }

            let locationData = 'Location Not Recorded';

            try {
                // 1. Get location data
                locationData = await getGeolocationAndReverseGeocode();
                
                // 2. Insert into Supabase
                const { error } = await sb
                    .from(ATTENDANCE_TABLE)
                    .insert({
                        user_id: currentUserId,
                        app_id: APP_ID, // Include app_id for separation
                        type: sessionType,
                        detail: sessionDetail,
                        location_data: locationData,
                    });

                if (error) throw error;
                
                showToast("Attendance successfully recorded!", false);
                
                // 3. Reset form state
                sessionTypeSelect.value = '';
                sessionDetailSelect.innerHTML = '<option value="" disabled selected>Select a Detail</option>';
                document.getElementById('session-detail-label').textContent = 'Detail (Course/Department):';
                geolocStatus.textContent = 'Status: Check-in complete.';
                validateAttendanceForm();

            } catch (error) {
                console.error("Error during check-in or geolocation:", error);
                showToast(`Check-in failed: ${error.message || 'Check console for details.'}`, true);
            } finally {
                checkInButton.textContent = 'Check In';
                validateAttendanceForm();
            }
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Set up Guest User ID (to replace Firebase anonymous user logic)
            currentUserId = getOrCreateGuestId();
            userIdDisplay.textContent = currentUserId;

            // 2. Load Content
            loadingScreen.classList.add('hidden');
            contentArea.classList.remove('hidden');

            // 3. Setup Supabase Listeners
            ensureDefaultWelcomeMessage();
            loadWelcomeMessage();
            loadRecentAttendance(currentUserId);
            
            showToast(`Welcome! You are operating as Guest ID: ${currentUserId.substring(0, 8)}...`);

            // --- Event Listeners ---
            
            // Attendance check-in event
            attendanceForm.addEventListener('submit', handleCheckIn);

            menuToggle.addEventListener('click', toggleSidebar);

            // Navigation handler
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        showTab(tabId);
                    }
                    // Close sidebar on small screens after clicking a link
                    if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            });

            // The Logout button for Guest Mode simply clears the local ID and refreshes
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                showToast("Resetting local Guest ID.", false);
                localStorage.removeItem(GUEST_ID_KEY);
                // Simple redirect to reload the application with a new UUID
                setTimeout(() => window.location.reload(), 1000); 
            });

            // Handle session type change to update details
            sessionTypeSelect.addEventListener('change', (e) => {
                updateAttendanceDetail(e.target.value);
            });

            // Detail change triggers validation (user must select an item)
            sessionDetailSelect.addEventListener('change', validateAttendanceForm);

            // Initial form validation on load
            validateAttendanceForm();
        });
    </script>
</body>
</html>
