<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Digital Student Dashboard</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="indexstyle.css">
    <link rel="stylesheet" href="status-footer.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4C1D95">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Windows PWA Support -->
    <meta name="msapplication-TileColor" content="#4C1D95">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Mobile PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i> You are offline. Some features may be unavailable.
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <div class="header-title-container">
            <span>NCHSM Digital Student Portal</span>
            <img 
                id="header-passport-preview" 
                src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" 
                alt="Profile Photo" 
                class="header-profile-photo"
            />
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="overlay" onclick="closeMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <div id="welcome-section" class="welcome-card">
                    <h2 id="welcome-header">Welcome back, Student!</h2>
                    <p id="student-welcome-message">Access your courses, schedule, and check your attendance status.</p>
                </div>

                <div id="announcement-banner">
                    <span class="info-icon">üì£</span>
                    <div>
                        <strong>Official Announcement:</strong>
                        <p id="student-announcement">Loading latest announcement...</p>
                    </div>
                </div>

                <h2 style="margin-top: 20px; color: var(--color-primary); font-weight: 700;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card alert-card" onclick="showTab('attendance')">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Verified Check-ins: <strong id="dashboard-verified-count">0</strong> / <strong id="dashboard-total-count">0</strong></small>
                        <small style="display:block; margin-top: 5px; color:var(--color-alert);">Pending Review: <strong id="dashboard-pending-count">0</strong></small>
                    </div>

                    <div class="card" onclick="showTab('cats')">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 700; color: #F97316;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>

                    <div class="card" onclick="showTab('courses')">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>

                    <div class="card" onclick="showTab('resources')">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last 7 days</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: var(--color-primary); font-weight: 700;">Action Required</h2>
                <div id="dashboard-actions">
                    <div id="action-passport" class="card" style="border-left-color: var(--color-alert); cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" onclick="showTab('profile')">Go to Profile</button>
                    </div>
                    
                    <div class="card" style="border-left-color: var(--color-warning); cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" onclick="showTab('resources')" style="background-color: var(--color-warning);">View Resources</button>
                    </div>
                    
                    <div id="latest-announcement-card" class="card" style="border-left-color: var(--color-success); display: none; cursor: pointer;">
                        <h4><span id="announcement-title" style="color: var(--color-primary);">Loading...</span></h4>
                        <p id="announcement-body" style="margin-bottom: 10px;">Loading message body...</p>
                        <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                            <span id="announcement-date"></span> | 
                            <span id="announcement-status" style="font-weight: bold;"></span>
                        </div>
                        <button onclick="showTab('messages')" class="profile-button" style="background-color: var(--color-primary); margin-top: 15px;">Go to Messages Tab</button>
                    </div>
                </div>
            </section>

            <!-- Profile Tab -->
            <section id="profile" class="tab-content">
                <h2 style="color: var(--color-primary);">My Profile & Account</h2>
                <form id="profile-form">
                    <div class="profile-media">
                        <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>
                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>

            <!-- Calendar Tab -->
            <section id="calendar" class="tab-content">
                <h2 style="color: var(--color-primary);">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter" onchange="loadAcademicCalendar()">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <div style="overflow-x: auto;"> 
                    <table>
                        <thead>
                            <tr>
                                <th class="date-col">Date & Time</th>
                                <th>Event / Details</th>
                                <th class="session-type-col">Type</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-table">
                            <tr><td colspan="3">Loading academic schedule...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses Tab -->
            <section id="courses" class="tab-content">
                <h2 style="color: var(--color-primary);">My Courses</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Unit Code</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table">
                            <tr><td colspan="4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Attendance Tab -->
            <section id="attendance" class="tab-content">
                <h2 style="color: var(--color-primary);">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type" onchange="updateTargetSelect()">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>

                    <p id="geo-message">Select a <strong>Session Type</strong> and then a specific <strong>Department or Course</strong> to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: var(--color-primary);">Past Attendance History (Check-in Logs)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Session Type</th>
                                <th>Target</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="geo-attendance-history">
                            <tr><td colspan="4">Loading geo check-in history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Exams Tab -->
            <section id="cats" class="tab-content">
                <h2 style="color: var(--color-primary); font-size: 1.6rem; margin-bottom: 5px;">CATS / Exams & Grades</h2>
                <p style="color: #6B7280; margin-bottom: 20px;">Provisional results</p>

                <div class="exam-controls" style="margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
                    <label for="exam-type-filter" style="font-weight:600; color:#374151;">Filter by Type:</label>
                    <select id="exam-type-filter" onchange="loadExams()" 
                            style="padding:6px 10px; border:1px solid #D1D5DB; border-radius:6px; background:white; color:#111827;">
                        <option value="all">Show All (CATS & Exams)</option>
                        <option value="CAT">Show Only CATS</option>
                        <option value="Final">Show Only Final Exams</option>
                    </select>
                </div>

                <div style="overflow-x: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius:8px;">
                    <table id="exams-grades-table" style="width:100%; border-collapse:collapse; min-width:700px;">
                        <thead style="background-color:#F3F4F6; color:#111827; font-weight:600;">
                            <tr>
                                <th style="padding:10px 12px;">Exam Name</th>
                                <th style="padding:10px 12px;">Block</th>
                                <th style="padding:10px 12px;">Date</th>
                                <th style="padding:10px 12px;">Status</th>
                                <th style="padding:10px 12px;">CAT 1</th>
                                <th style="padding:10px 12px;">CAT 2</th>
                                <th style="padding:10px 12px;">Final Exam</th>
                                <th style="padding:10px 12px;">Total (%)</th>
                                <th style="padding:10px 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table" style="background:white;">
                            <tr>
                                <td colspan="9" style="padding:12px; text-align:center; color:#6B7280;">Loading your exams and grades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Resources Tab -->
            <section id="resources" class="tab-content">
                <div class="resources-header">
                    <h2 style="color: var(--color-primary); margin-bottom: 8px;">Learning Resources</h2>
                    <p class="subtitle" style="margin-bottom: 20px;">View your course materials and study resources</p>
                    
                    <div class="resources-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="resource-search" placeholder="Search resources...">
                        </div>
                        
                        <div class="filter-group">
                            <select id="resource-filter">
                                <option value="all">All Resources</option>
                                <option value="pdf">PDF Notes</option>
                                <option value="video">Video Lectures</option>
                                <option value="slides">Presentation Slides</option>
                            </select>
                            
                            <select id="course-filter">
                                <option value="all">All Courses</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="resources-grid" id="resources-grid">
                    <div class="loading-state">Loading resources...</div>
                </div>

                <div id="mobile-reader" class="mobile-reader" style="display: none;">
                    <div class="reader-header">
                        <button class="reader-back" onclick="closeReader()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 id="reader-title">Resource Title</h3>
                        <div class="view-only-badge">
                            <i class="fas fa-eye"></i> View Only
                        </div>
                    </div>
                    <div class="reader-content" id="reader-content">
                        <!-- Resource content will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Messages Tab -->
            <section id="messages" class="tab-content">
                <h2 style="color: var(--color-primary);">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>

                <div id="messages-list"></div>
            </section>
        </main>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <button class="install-close" onclick="closeInstallPrompt()">√ó</button>
        <div class="install-content">
            <div class="install-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="install-text">
                <h4>Install NCHSM Portal</h4>
                <p>Install on your device for offline access and faster loading</p>
            </div>
        </div>
        <div class="install-actions">
            <button class="install-btn secondary" onclick="closeInstallPrompt()">Not Now</button>
            <button class="install-btn primary" onclick="installPWA()">Install</button>
        </div>
    </div>

    <!-- Offline Queue Notification -->
    <div class="offline-queue" id="offlineQueue">
        <i class="fas fa-sync sync-animation"></i>
        <span id="queueCount">0</span> pending actions
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Nakuru College of Health Sciences and Management (NCHSM)</h3>
                <p>Providing quality health sciences and management education with practical skills and digital innovation.</p>
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Kiamunyi Off Nakuru - Kabarak Rd, Along Canon Ndungu Street, Nakuru</span>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Contact Information</h3>
                <div class="footer-contact">
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>portal.nchsm@gmail.com</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>0790969743</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-map-pin"></i>
                        <span>P. O. Box 12906 - 20100, Nakuru</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-clock"></i>
                        <span>Mon - Fri: 8:00 AM - 5:00 PM</span>
                    </div>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="#" onclick="showTab('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#" onclick="showTab('courses')"><i class="fas fa-book"></i> My Courses</a></li>
                    <li><a href="#" onclick="showTab('calendar')"><i class="fas fa-calendar"></i> Academic Calendar</a></li>
                    <li><a href="#" onclick="showTab('resources')"><i class="fas fa-file-pdf"></i> Resources</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Support</h3>
                <ul class="footer-links">
                    <li><a href="#" onclick="showTab('messages')"><i class="fas fa-question-circle"></i> Contact Admin</a></li>
                    <li><a href="#" id="clearCacheBtn"><i class="fas fa-broom"></i> Clear Cache</a></li>
                    <li><a href="#" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</a></li>
                    <li><a href="#" onclick="showSystemInfo()"><i class="fas fa-info-circle"></i> System Info</a></li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="copyright">
                ¬© 2025 Nakuru College of Health Sciences and Management. All rights reserved.
                <span id="appVersion" style="margin-left: 10px; opacity: 0.7;">v2.1</span>
            </div>
            <div class="footer-social">
                <a href="https://facebook.com" class="social-icon" target="_blank" aria-label="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://twitter.com" class="social-icon" target="_blank" aria-label="Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://instagram.com" class="social-icon" target="_blank" aria-label="Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="mailto:portal.nchsm@gmail.com" class="social-icon" aria-label="Email">
                    <i class="fas fa-envelope"></i>
                </a>
            </div>
        </div>
    </footer>

    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
        <div class="status-left">
            <div class="status-item">
                <i class="fas fa-wifi status-icon" id="connectionIcon"></i>
                <span id="connectionStatus">Online</span>
            </div>
            <div class="status-item">
                <i class="fas fa-database status-icon"></i>
                <span id="cacheStatus">Cache: 0MB</span>
            </div>
            <div class="status-item">
                <i class="fas fa-user status-icon"></i>
                <span id="userStatus">Student</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-badge" id="syncStatus">
                <i class="fas fa-sync"></i>
                <span>Synced</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock status-icon"></i>
                <span id="currentTime">00:00:00</span>
            </div>
        </div>
    </div>

    <!-- Provisional Transcript Modal -->
    <div id="transcript-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
            <button onclick="closeTranscriptModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.2em; cursor:pointer;">‚úñ</button>
            <h3 id="transcript-exam-name" style="margin-bottom:15px; color: var(--color-primary);"></h3>
            <table style="width:100%; border-collapse:collapse; font-size:0.95em;">
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 1:</td>
                    <td id="transcript-cat1"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 2:</td>
                    <td id="transcript-cat2"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Final Exam:</td>
                    <td id="transcript-final"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Total Score:</td>
                    <td id="transcript-total"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Status:</td>
                    <td id="transcript-status"></td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        // *************************************************************************
        // *** SECURE CONFIGURATION - Loads from GitHub Secrets via config.js ***
        // *************************************************************************

        // Hides the .html extension in the URL
        if (window.location.pathname.endsWith('.html')) {
            const cleanPath = window.location.pathname.replace(/\.html$/, '');
            window.history.replaceState({}, '', cleanPath);
        }

        // Configuration validation
        function validateConfig() {
            if (!window.APP_CONFIG) {
                console.error('‚ùå APP_CONFIG not loaded - check config.js');
                return false;
            }

            const required = ['SUPABASE_URL', 'SUPABASE_ANON_KEY', 'LOCATIONIQ_API_KEY'];
            const missing = required.filter(key => !window.APP_CONFIG[key]);
            
            if (missing.length > 0) {
                console.error('‚ùå Missing configuration:', missing);
                return false;
            }
            
            console.log('‚úÖ Configuration loaded successfully from GitHub Secrets');
            console.log('Build:', window.APP_CONFIG.BUILD_TIME, 'Commit:', window.APP_CONFIG.COMMIT_SHA);
            return true;
        }

        // Show configuration error
        function showConfigurationError() {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: 'Inter', sans-serif; background: #f8f8f8; height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div style="max-width: 500px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h2 style="color: #EF4444; margin-bottom: 20px;">üö´ Configuration Error</h2>
                        <p style="color: #6B7280; margin-bottom: 20px;">The application failed to load configuration.</p>
                        <div style="background: #FEF2F2; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                            <strong>Possible issues:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>GitHub Secrets not configured</li>
                                <li>Deployment in progress</li>
                                <li>Configuration file missing</li>
                            </ul>
                        </div>
                        <button onclick="window.location.reload()" style="background: #4C1D95; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                            Retry
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize application with secure configuration
        function initializeApplication() {
            if (!validateConfig()) {
                showConfigurationError();
                return;
            }

            // Extract configuration from GitHub Secrets
            const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
            const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
            const LOCATIONIQ_API_KEY = window.APP_CONFIG.LOCATIONIQ_API_KEY;
            
            console.log('üîß Initializing Supabase with secure configuration...');
            
            // Initialize Supabase client
            const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const LOCATIONIQ_API_URL = 'https://us1.locationiq.com/v1/reverse.php';
            
            // Set PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Start the main application
            startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL);
        }

        // *************************************************************************
        // *** OFFLINE SUPPORT & SERVICE WORKER ***
        // *************************************************************************
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swUrl = '/sw.js';
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ New Service Worker found:', newWorker.state);
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('New version available! Refresh to update.', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // Offline Support System
        const OfflineManager = {
            queue: [],
            isOnline: navigator.onLine,
            isSyncing: false,

            init() {
                this.loadQueue();
                this.setupEventListeners();
                this.startSyncInterval();
                this.updateConnectionStatus();
            },

            loadQueue() {
                const saved = localStorage.getItem('offlineQueue');
                this.queue = saved ? JSON.parse(saved) : [];
                this.updateQueueDisplay();
            },

            saveQueue() {
                localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
                this.updateQueueDisplay();
            },

            addToQueue(action, data) {
                const queueItem = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    action,
                    data,
                    timestamp: new Date().toISOString(),
                    attempts: 0,
                    maxAttempts: 3
                };

                this.queue.push(queueItem);
                this.saveQueue();
                
                if (this.isOnline) {
                    this.processQueue();
                } else {
                    showToast('Action saved offline. Will sync when online.', 'warning');
                }
            },

            async processQueue() {
                if (this.isSyncing || this.queue.length === 0 || !this.isOnline) return;

                this.isSyncing = true;
                this.updateSyncStatus('syncing');

                try {
                    while (this.queue.length > 0) {
                        const item = this.queue[0];
                        const success = await this.executeAction(item);

                        if (success) {
                            this.queue.shift(); // Remove successful item
                        } else {
                            item.attempts++;
                            if (item.attempts >= item.maxAttempts) {
                                console.warn(`Failed after ${item.maxAttempts} attempts:`, item);
                                this.queue.shift(); // Remove failed item
                                showToast('Failed to sync action after multiple attempts', 'error');
                            }
                            break; // Stop processing on first failure
                        }
                        
                        this.saveQueue();
                    }
                    
                    if (this.queue.length === 0) {
                        showToast('All offline actions synced', 'success');
                    }
                } catch (error) {
                    console.error('Queue processing error:', error);
                } finally {
                    this.isSyncing = false;
                    this.updateSyncStatus(this.queue.length > 0 ? 'offline' : 'idle');
                }
            },

            async executeAction(item) {
                try {
                    // Simulate API call - replace with actual Supabase calls
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return true;
                } catch (error) {
                    console.error('Action execution failed:', error);
                    return false;
                }
            },

            updateQueueDisplay() {
                const queueElement = document.getElementById('offlineQueue');
                const countElement = document.getElementById('queueCount');
                
                if (this.queue.length > 0) {
                    if (queueElement) queueElement.classList.add('show');
                    if (countElement) countElement.textContent = this.queue.length;
                } else {
                    if (queueElement) queueElement.classList.remove('show');
                }
            },

            updateSyncStatus(status) {
                const syncElement = document.getElementById('syncStatus');
                if (!syncElement) return;

                syncElement.className = 'status-badge';
                
                switch(status) {
                    case 'syncing':
                        syncElement.classList.add('syncing');
                        syncElement.innerHTML = '<i class="fas fa-sync sync-animation"></i><span>Syncing...</span>';
                        break;
                    case 'idle':
                        syncElement.classList.add('online');
                        syncElement.innerHTML = '<i class="fas fa-check"></i><span>Synced</span>';
                        break;
                    case 'offline':
                        syncElement.classList.add('offline');
                        syncElement.innerHTML = '<i class="fas fa-cloud"></i><span>Offline</span>';
                        break;
                }
            },

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    this.processQueue();
                    showToast('You are back online', 'success');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus();
                    this.updateSyncStatus('offline');
                    showToast('You are offline. Changes will sync when back online.', 'warning');
                });
            },

            startSyncInterval() {
                // Try to sync every 30 seconds when online
                setInterval(() => {
                    if (this.isOnline && this.queue.length > 0) {
                        this.processQueue();
                    }
                }, 30000);
            },

            updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const iconElement = document.getElementById('connectionIcon');
                const offlineIndicator = document.getElementById('offlineIndicator');
                
                if (this.isOnline) {
                    if (statusElement) statusElement.textContent = 'Online';
                    if (iconElement) {
                        iconElement.className = 'fas fa-wifi status-icon status-online';
                    }
                    if (offlineIndicator) offlineIndicator.style.display = 'none';
                } else {
                    if (statusElement) statusElement.textContent = 'Offline';
                    if (iconElement) {
                        iconElement.className = 'fas fa-wifi-slash status-icon status-offline';
                    }
                    if (offlineIndicator) offlineIndicator.style.display = 'block';
                }
            }
        };

        // Cache Manager
        const CacheManager = {
            async estimateCache() {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    try {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                        const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
                        
                        const cacheElement = document.getElementById('cacheStatus');
                        if (cacheElement) {
                            cacheElement.textContent = `Cache: ${usedMB}MB / ${quotaMB}MB`;
                        }
                    } catch (error) {
                        console.error('Cache estimation failed:', error);
                    }
                }
            },

            async clearCache() {
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        
                        // Clear localStorage except essential data
                        const essentialKeys = ['offlineQueue', 'userPreferences'];
                        Object.keys(localStorage).forEach(key => {
                            if (!essentialKeys.includes(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        showToast('Cache cleared successfully', 'success');
                        this.estimateCache();
                    } catch (error) {
                        console.error('Cache clearing failed:', error);
                        showToast('Failed to clear cache', 'error');
                    }
                }
            },

            async exportData() {
                try {
                    const data = {
                        profile: currentUserProfile || {},
                        courses: cachedCourses || [],
                        exams: cachedExams || [],
                        resources: cachedResources || [],
                        exportDate: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nchsm-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('Data exported successfully', 'success');
                } catch (error) {
                    console.error('Data export failed:', error);
                    showToast('Failed to export data', 'error');
                }
            }
        };

        // PWA Installation
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 5 seconds
            setTimeout(() => {
                if (deferredPrompt && !isAppInstalled()) {
                    installPrompt.classList.add('show');
                }
            }, 5000);
        });

        function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted install');
                    showToast('App installation started', 'success');
                }
                deferredPrompt = null;
                closeInstallPrompt();
            });
        }

        function closeInstallPrompt() {
            installPrompt.classList.remove('show');
        }

        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // System Info Modal
        function showSystemInfo() {
            const info = `
                <div style="padding: 20px;">
                    <h3 style="color: #4C1D95; margin-bottom: 15px;">System Information</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>App Version:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">v2.1</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Browser:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${navigator.userAgent.split(' ')[0]}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Online:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${navigator.onLine ? 'Yes' : 'No'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Service Worker:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;">${'serviceWorker' in navigator ? 'Active' : 'Not Supported'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;"><strong>Cache Size:</strong></td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #E5E7EB;" id="cacheSizeInfo">Calculating...</td>
                        </tr>
                    </table>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="closeModal()" class="profile-button">Close</button>
                    </div>
                </div>
            `;
            
            showModal('System Information', info);
        }

        function showModal(title, content) {
            // Create modal dynamically
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #4C1D95;">${title}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div>${content}</div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Status bar clock function
        function updateStatusBarClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) timeElement.textContent = timeString;
        }

        // Initialize all systems
        function initializeSystems() {
            console.log("üîÑ Initializing systems...");
            
            // 1. Start status bar clock
            updateStatusBarClock();
            setInterval(updateStatusBarClock, 1000);
            
            // 2. Initialize offline manager
            OfflineManager.init();
            
            // 3. Update cache size periodically
            CacheManager.estimateCache();
            setInterval(() => CacheManager.estimateCache(), 60000);
            
            // 4. Setup footer button listeners
            document.getElementById('clearCacheBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Clear all cached data? This will not delete your submissions.')) {
                    CacheManager.clearCache();
                }
            });
            
            document.getElementById('exportDataBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                CacheManager.exportData();
            });
            
            // 5. Setup service worker update check
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.addEventListener('statechange', () => {
                    if (navigator.serviceWorker.controller.state === 'installed') {
                        showToast('New update available! Refresh to update.', 'info');
                    }
                });
            }
            
            console.log("‚úÖ Systems initialized successfully");
        }

        // YOUR EXISTING APPLICATION CODE - MODIFIED FOR SECURITY
        async function startMainApplication(sb, LOCATIONIQ_API_KEY, LOCATIONIQ_API_URL) {
            // *************************************************************************
            // *** CONFIGURATION AND INITIALIZATION ***
            // *************************************************************************
            
            // Global State
            let currentUserId = null;
            let currentUserProfile = null;
            let cachedCourses = []; 
            let cachedExams = [];
            let cachedClinicalAreas = [];
            let cachedResources = [];
            
            // Initialize offline systems
            initializeSystems();
            
            // Constants
            const MAX_ALLOWED_ACCURACY = 30;
            const MAX_DISTANCE_RADIUS = 200;
            const FALLBACK_LAT = 0.00;
            const FALLBACK_LON = 0.00;
            const FALLBACK_ACCURACY = 9999;
            const RESOURCES_BUCKET = 'resources';
            
            // *************************************************************************
            // *** UTILITY FUNCTIONS ***
            // *************************************************************************
            
            const AppUtils = {
                // Show loading state
                showLoading(element, message = 'Loading...') {
                    if (element) {
                        element.innerHTML = `<div class="loading-state">${message}</div>`;
                    }
                },
            
                // Show error state
                showError(element, message) {
                    if (element) {
                        element.innerHTML = `<div class="error-state">${message}</div>`;
                    }
                },
            
                // Safe API call wrapper
                async safeApiCall(apiCall, errorMessage = 'Operation failed') {
                    try {
                        return await apiCall();
                    } catch (error) {
                        console.error(errorMessage, error);
                        this.showToast(errorMessage, 'error');
                        return null;
                    }
                },
            
                // Toast notification
                showToast(message, type = 'info') {
                    showToast(message, type);
                }
            };
            
            // Simple cache implementation
            const cache = {
                data: new Map(),
                set(key, value, ttl = 5 * 60 * 1000) {
                    this.data.set(key, {
                        value,
                        expiry: Date.now() + ttl,
                        timestamp: new Date().toISOString()
                    });
                },
                get(key) {
                    const item = this.data.get(key);
                    if (!item) return null;
                    if (Date.now() > item.expiry) {
                        this.data.delete(key);
                        return null;
                    }
                    return item.value;
                },
                clear() {
                    this.data.clear();
                }
            };
            
            // *************************************************************************
            // *** AUTHENTICATION ***
            // *************************************************************************
            
            // Enforce authentication
            (async function enforceAuth() {
                try {
                    console.log("üîê Checking authentication...");
                    const { data: { session }, error } = await sb.auth.getSession();
                    
                    if (error) {
                        console.error("Session error:", error);
                        AppUtils.showToast('Authentication error - redirecting to login', 'error');
                        setTimeout(() => window.location.href = "login.html", 2000);
                        return;
                    }
                    
                    if (!session || !session.user) {
                        console.warn("No active session found");
                        AppUtils.showToast('Please log in to continue', 'warning');
                        window.location.href = "login.html";
                        return;
                    }
                    
                    currentUserId = session.user.id;
                    console.log("‚úÖ User authenticated:", currentUserId);
                    
                    // Update user status in status bar
                    const userStatusElement = document.getElementById('userStatus');
                    if (userStatusElement) {
                        userStatusElement.textContent = 'Loading...';
                    }
                    
                    await checkAuthAndLoad();
                    
                } catch (err) {
                    console.error("Auth enforcement failed:", err);
                    AppUtils.showToast('Login check failed - redirecting', 'error');
                    window.location.href = "login.html";
                }
            })();
            
            // Initialize dashboard after auth
            async function checkAuthAndLoad() {
                try {
                    if (!currentUserId) {
                        window.location.href = "login.html"; 
                        return;
                    }
            
                    console.log("üîÑ Loading dashboard data...");
                    
                    // Load data with proper error handling
                    await Promise.allSettled([
                        loadProfile(currentUserId).catch(err => {
                            console.error("Profile load failed:", err);
                            AppUtils.showToast('Failed to load profile', 'error');
                        }),
                        loadClinicalTargets().catch(err => {
                            console.error("Clinical targets failed:", err);
                            AppUtils.showToast('Clinical data incomplete', 'warning');
                        }),
                        loadClassTargets().catch(err => {
                            console.error("Class targets failed:", err);
                        }),
                        loadCourses().catch(err => {
                            console.error("Courses failed:", err);
                            AppUtils.showToast('Course data unavailable', 'warning');
                        }),
                        loadExams().catch(err => {
                            console.error("Exams failed:", err);
                        }),
                        loadResources().catch(err => {
                            console.error("Resources failed:", err);
                        })
                    ]);
            
                    // Load UI components
                    await loadWelcomeDetails();
                    showTab('dashboard');
                    loadDashboardMetrics(currentUserId);
                    
                    console.log("‚úÖ Dashboard initialization complete");
                    
                } catch (error) {
                    console.error("üö® Initialization failed:", error);
                    AppUtils.showToast('Failed to load dashboard - some features may be unavailable', 'error');
                }
            }
            
            // Logout function
            async function logout() {
                try {
                    sb.realtime.channels.forEach(channel => sb.removeChannel(channel));
                    await sb.auth.signOut();
                    window.location.href = "login.html";
                } catch (error) {
                    console.error("Logout error:", error);
                    window.location.href = "login.html";
                }
            }
            
            // *************************************************************************
            // *** UI AND NAVIGATION ***
            // *************************************************************************
            
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            const navLinks = document.querySelectorAll('.nav a');
            const tabs = document.querySelectorAll('.tab-content');
            
            // Mobile menu functions
            function toggleMenu() {
                if (sidebar.classList.contains('open')) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }
            
            function openMenu() {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeMenu() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Tab navigation
            function showTab(tabId) {
                // Highlight active link
                navLinks.forEach(l => l.classList.remove('active'));
                const activeLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
                if (activeLink) activeLink.classList.add('active');
            
                // Show active tab content
                tabs.forEach(tab => tab.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                if (activeTab) activeTab.classList.add('active');
            
                // Close mobile menu if open
                if (sidebar.classList.contains('open')) {
                    closeMenu();
                }
            
                // Load tab-specific data
                switch(tabId) {
                    case 'profile':
                        if (currentUserId) loadProfile(currentUserId);
                        break;
                    case 'attendance':
                        if (currentUserId) {
                            loadGeoAttendanceHistory(currentUserId);
                            updateTargetSelect();
                        }
                        break;
                    case 'dashboard':
                        if (currentUserId) {
                            loadWelcomeDetails();
                            loadDashboardMetrics(currentUserId);
                        }
                        break;
                    case 'courses':
                        if (currentUserId) loadCourses();
                        break;
                    case 'resources':
                        if (currentUserId) loadResources();
                        break;
                    case 'cats':
                        if (currentUserId) loadExams();
                        break;
                    case 'messages':
                        if (currentUserId) loadStudentMessagesAndAnnouncements();
                        break;
                    case 'calendar':
                        if (currentUserId) loadAcademicCalendar();
                        break;
                }
            
                // Always refresh latest announcement
                if (currentUserId) loadLatestOfficialAnnouncement();
            }
            
            // Attach event listeners to nav links
            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    if (tabId) showTab(tabId);
                });
            });
            
            // *************************************************************************
            // *** DASHBOARD FUNCTIONS ***
            // *************************************************************************
            
            // Load welcome details WITHOUT live clock
            async function loadWelcomeDetails() {
                const studentName = currentUserProfile?.full_name || 'Student';
                const welcomeHeader = document.getElementById('welcome-header');

                function getGreeting(hour) {
                    if (hour >= 5 && hour < 12) return "Good Morning";
                    if (hour >= 12 && hour < 17) return "Good Afternoon";
                    if (hour >= 17 && hour < 21) return "Good Evening";
                    return "Good Night";
                }

                function updateHeader() {
                    const now = new Date();
                    const hour = now.getHours();
                    
                    if (welcomeHeader) {
                        // NO CLOCK in welcome header - just greeting and name
                        welcomeHeader.textContent = `${getGreeting(hour)}, ${studentName}`;
                    }
                }

                // Initialize welcome message (NO CLOCK)
                updateHeader();
                setInterval(updateHeader, 60000); // Update greeting every minute

                // Load other messages
                await loadStudentMessage('student_welcome', 'student-welcome-message');
                await loadLatestOfficialAnnouncement();
            }

            // Load student message from app_settings
            async function loadStudentMessage(key, elementId) {
                const element = document.getElementById(elementId);
                if (!element) return;

                AppUtils.showLoading(element, 'Loading...');

                try {
                    const { data, error } = await sb
                        .from('app_settings')
                        .select('value')
                        .eq('key', key)
                        .maybeSingle();

                    if (error) throw error;

                    if (data && data.value) {
                        element.innerHTML = data.value;
                    } else {
                        element.textContent = 'No message available.';
                    }
                } catch (err) {
                    console.error(`‚ùå Failed to load ${key}:`, err);
                    AppUtils.showError(element, 'Failed to load message. Please refresh.');
                }
            }

            // Load latest official announcement
            async function loadLatestOfficialAnnouncement() {
                const element = document.getElementById('student-announcement');
                if (!element) return;

                AppUtils.showLoading(element, 'Loading latest announcement...');

                try {
                    const { data, error } = await sb
                        .from('notifications')
                        .select('*')
                        .eq('subject', 'Official Announcement')
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        element.textContent = data[0].message;
                    } else {
                        element.textContent = 'No official announcements at this time.';
                    }
                } catch (err) {
                    console.error('Failed to load official announcement:', err);
                    AppUtils.showError(element, 'Failed to load announcement. Please refresh.');
                }
            }

            // Load system messages for dashboard
            async function loadSystemMessages(studentProgram) {
                const card = document.getElementById('latest-announcement-card');
                const titleElement = document.getElementById('announcement-title');
                const bodyElement = document.getElementById('announcement-body');
                const dateElement = document.getElementById('announcement-date');
                const statusElement = document.getElementById('announcement-status');

                if (!card || !studentProgram) return;

                card.style.display = 'none';

                try {
                    // Fetch the single latest notification for the student's program
                    const { data: messages, error } = await sb
                        .from('notifications')
                        .select('created_at, subject, message, is_read, target_program')
                        .or(`target_program.eq.${studentProgram},target_program.is.null`)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (error) throw error;

                    if (messages && messages.length > 0) {
                        const latestMsg = messages[0];
                        const date = new Date(latestMsg.created_at).toLocaleDateString('en-GB');
                        const statusColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-success)';
                        const statusText = !latestMsg.is_read ? 'New' : 'Seen';
                        const cardBorderColor = !latestMsg.is_read ? 'var(--color-alert)' : 'var(--color-primary)';

                        titleElement.textContent = (latestMsg.subject || 'New Announcement').toUpperCase();
                        bodyElement.textContent = latestMsg.message;
                        dateElement.textContent = date;
                        statusElement.textContent = `Status: ${statusText}`;
                        statusElement.style.color = statusColor;

                        card.style.display = 'block';
                        card.style.borderLeftColor = cardBorderColor;

                    } else {
                        card.style.display = 'none';
                    }

                } catch (error) {
                    console.error('Error loading notifications for dashboard:', error.message);
                    card.style.display = 'none';
                }
            }

            // Load dashboard metrics
            async function loadDashboardMetrics(userId) {
                try {
                    // Show loading states
                    AppUtils.showLoading(document.getElementById('dashboard-attendance-rate'), '--%');
                    AppUtils.showLoading(document.getElementById('dashboard-active-courses'), '0');
                    AppUtils.showLoading(document.getElementById('dashboard-upcoming-exam'), 'Loading...');

                    // Load data in parallel for better performance
                    const [attendanceData, coursesData, examsData, resourcesData] = await Promise.all([
                        AppUtils.safeApiCall(() => loadAttendanceMetrics(userId)),
                        AppUtils.safeApiCall(() => loadCoursesMetrics()),
                        AppUtils.safeApiCall(() => loadExamsMetrics()),
                        AppUtils.safeApiCall(() => loadResourcesMetrics())
                    ]);

                    // Update UI with actual data
                    updateDashboardUI(attendanceData, coursesData, examsData, resourcesData);
                    
                    // Load profile photo
                    loadProfilePhoto();
                    
                    // Load system messages
                    if (currentUserProfile?.program) {
                        loadSystemMessages(currentUserProfile.program);
                    }

                } catch (error) {
                    console.error('Dashboard metrics loading failed:', error);
                    AppUtils.showToast('Failed to load dashboard data', 'error');
                }
            }

            // Helper functions for metrics
            async function loadAttendanceMetrics(userId) {
                const { data: logs, error } = await sb
                    .from('geo_attendance_logs')
                    .select('is_verified')
                    .eq('student_id', userId);

                if (error) throw error;

                const totalLogs = logs.length;
                const verifiedCount = logs.filter(l => l.is_verified === true).length;
                const pendingCount = logs.filter(l => !l.is_verified).length;
                const attendanceRate = totalLogs > 0 ? Math.round((verifiedCount / totalLogs) * 100) : 0;

                return { attendanceRate, verifiedCount, totalLogs, pendingCount };
            }

            async function loadCoursesMetrics() {
                return { count: cachedCourses.length };
            }

            async function loadExamsMetrics() {
                const upcomingExams = cachedExams
                    .filter(exam => new Date(exam.exam_date) > new Date())
                    .sort((a, b) => new Date(a.exam_date) - new Date(b.exam_date));

                return { upcomingExam: upcomingExams[0] };
            }

            async function loadResourcesMetrics() {
                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const newResourcesCount = cachedResources.filter(r => r.created_at >= oneWeekAgo).length;
                return { newResourcesCount };
            }

            function updateDashboardUI(attendance, courses, exams, resources) {
                // Update attendance
                if (attendance) {
                    document.getElementById('dashboard-attendance-rate').textContent = attendance.attendanceRate + '%';
                    document.getElementById('dashboard-verified-count').textContent = attendance.verifiedCount;
                    document.getElementById('dashboard-total-count').textContent = attendance.totalLogs;
                    document.getElementById('dashboard-pending-count').textContent = attendance.pendingCount;
                }

                // Update courses
                if (courses) {
                    document.getElementById('dashboard-active-courses').textContent = courses.count;
                }

                // Update exams
                if (exams?.upcomingExam) {
                    const examDate = new Date(exams.upcomingExam.exam_date).toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric' 
                    });
                    document.getElementById('dashboard-upcoming-exam').textContent = 
                        `${exams.upcomingExam.exam_name || 'Exam'} on ${examDate}`;
                } else {
                    document.getElementById('dashboard-upcoming-exam').textContent = 'No Exams Scheduled';
                }

                // Update resources
                if (resources) {
                    document.getElementById('dashboard-new-resources').textContent = resources.newResourcesCount;
                }
            }

            // Load profile photo
            function loadProfilePhoto() {
                const passportImg = document.getElementById('passport-preview');
                const headerPassportImg = document.getElementById('header-passport-preview');
                const passportCard = document.getElementById('action-passport');

                const photoUrl = currentUserProfile?.passport_url;

                if (passportCard) {
                    passportCard.style.display = photoUrl ? 'none' : 'block';
                }

                // Determine the photo source (URL or fallback)
                let finalPhotoSrc = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                
                if (photoUrl) {
                    // Construct proper Supabase URL
                    finalPhotoSrc = `${window.APP_CONFIG.SUPABASE_URL}/storage/v1/object/public/passports/${photoUrl}?t=${new Date().getTime()}`;
                }

                // Update both profile and header images
                if (passportImg) {
                    passportImg.src = finalPhotoSrc;
                    passportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }

                if (headerPassportImg) {
                    headerPassportImg.src = finalPhotoSrc;
                    headerPassportImg.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO';
                    };
                }
            }
            
            // [Rest of your functions remain the same...]
            // PROFILE MANAGEMENT, ATTENDANCE, COURSES, EXAMS, RESOURCES, etc.
            // These functions should be copied from your existing code
            
            // Make functions globally available
            window.toggleMenu = toggleMenu;
            window.closeMenu = closeMenu;
            window.showTab = showTab;
            window.logout = logout;
            window.geoCheckIn = geoCheckIn;
            window.updateTargetSelect = updateTargetSelect;
            window.viewProvisionalTranscript = viewProvisionalTranscript;
            window.closeTranscriptModal = closeTranscriptModal;
            window.openResource = openResource;
            window.closeReader = closeReader;
            window.filterResources = filterResources;
            window.changePDFPage = function() {};
            window.zoomPDF = function() {};
            window.installPWA = installPWA;
            window.closeInstallPrompt = closeInstallPrompt;
            window.showSystemInfo = showSystemInfo;
            window.closeModal = closeModal;
        }

        // Start application when config is ready
        if (window.APP_CONFIG) {
            initializeApplication();
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                // Give config.js a moment to load
                setTimeout(() => {
                    if (window.APP_CONFIG) {
                        initializeApplication();
                    } else {
                        showConfigurationError();
                    }
                }, 1000);
            });
        }
    </script>

    <!-- Config file generated by GitHub Actions with secrets -->
    <script src="./config.js"></script>
</body>
</html>
