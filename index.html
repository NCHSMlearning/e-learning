<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
        * CRITICAL FIX: Only show the active tab content
        */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Set Inter font and warmer background */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Sidebar link styling */
        .nav-link {
            transition: all 0.2s ease-in-out;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            border-radius: 0.75rem; /* Smoother corners */
        }
        .nav-link:hover {
            background-color: #1e293b; /* Slate 800 on hover */
        }
        .nav-link.active {
            background-color: #10b981; /* Emerald 500 for active link */
            color: #ffffff;
            font-weight: 600;
        }
        
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #e2e8f0; /* Slate 200 */
            border-top: 4px solid #10b981; /* Emerald 500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="flex">

        <!-- Sidebar Navigation - Darker Slate Background -->
        <aside id="sidebar" class="w-64 bg-slate-900 text-gray-200 space-y-6 py-7 px-4 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition duration-200 ease-in-out z-50">

            <!-- Sidebar Header -->
            <div class="sidebar-header flex items-center mb-10">
                <div class="text-4xl font-extrabold text-emerald-400">
                    &#x1F393;
                </div>
                <h2 class="text-2xl font-bold ml-2 text-white">NCHSM <span id="portal-title" class="text-xl font-medium block leading-none">Student</span></h2>
            </div>

            <!-- Navigation Links -->
            <nav class="flex flex-col space-y-2">
                <a href="#" data-tab="welcome" class="nav-link active">
                    <span class="mr-3 text-xl">&#x1F3E0;</span>
                    Welcome/Started
                </a>
                <a href="#" data-tab="dashboard" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F4C8;</span>
                    Dashboard
                </a>
                
                <!-- Super Admin Link -->
                <div id="admin-link-container" class="hidden">
                    <hr class="my-3 border-slate-700">
                    <a href="#" data-tab="admin-tools" class="nav-link text-white bg-indigo-800 hover:bg-indigo-700 font-bold">
                        <span class="mr-3 text-xl">&#x2699;</span>
                        Admin Tools
                    </a>
                    <hr class="my-3 border-slate-700">
                </div>
                <!-- End Super Admin Link -->

                <a href="#" data-tab="profile" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F464;</span>
                    My Profile
                </a>
                <a href="#" data-tab="grades" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F4DD;</span>
                    Grades & Reports
                </a>
                <a href="#" data-tab="attendance" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x23F0;</span>
                    Attendance Logs
                </a>
                <a href="#" data-tab="announcements" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F4E3;</span>
                    Announcements
                </a>
                <a href="#" data-tab="messages" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F4E8;</span>
                    Message Admin
                </a>
                 <!-- Placeholder Tabs -->
                <a href="#" data-tab="courses" class="nav-link text-slate-300 hover:text-white mt-4">
                    <span class="mr-3 text-xl">&#x1F4D6;</span>
                    My Courses
                </a>
                <a href="#" data-tab="cats-exams" class="nav-link text-slate-300 hover:text-white">
                    <span class="mr-3 text-xl">&#x1F5D2;</span>
                    CATs/Exams
                </a>
                <!-- Logout/Spacer -->
                <a href="#" id="logout-link" class="nav-link bg-red-600 hover:bg-red-700 text-white mt-6 justify-center shadow-lg">
                    <span class="mr-2">&#x274C;</span>
                    Logout
                </a>
            </nav>

        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 lg:ml-64">
            
            <!-- Mobile Header/Toggle -->
            <header class="flex justify-between items-center bg-white shadow-md p-4 lg:hidden sticky top-0 z-40">
                <button id="menu-toggle" class="text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-emerald-500 rounded-lg p-2 transition duration-150 ease-in-out">
                    <!-- Hamburger Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl font-bold text-gray-800">Portal</h1>
                <div class="w-6 h-6"></div> <!-- Spacer -->
            </header>

            <main class="p-6 md:p-10">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Hello, <span id="user-display-name">Loading...</span>!</h1>
                <p class="text-lg text-slate-500 mb-8" id="user-subtitle">Your academic resources and tools.</p>

                <!-- 1. Welcome/Getting Started Tab (Active by default) -->
                <section id="welcome" class="tab-content active space-y-6">
                    <!-- Dynamic Welcome/Announcement Message (Styled with a vibrant gradient) -->
                    <div class="bg-gradient-to-r from-cyan-600 to-blue-700 text-white p-6 rounded-2xl shadow-xl flex items-center gap-4">
                         <span class="text-4xl">&#x1F4E3;</span>
                        <h2 class="text-2xl font-bold" id="welcome-subject">Loading Announcement...</h2>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-xl space-y-4 min-h-32 border-t-4 border-cyan-400" id="welcome-body-display">
                        <div class="flex justify-center items-center h-full">
                            <div class="loader"></div>
                            <p class="text-slate-500 ml-4">Loading welcome message content...</p>
                        </div>
                    </div>
                </section>

                <!-- 2. Dashboard Tab (Includes Geo-Attendance Check) -->
                <section id="dashboard" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard Overview & Daily Check-In</h2>

                    <!-- Attendance Check-In Widget -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-emerald-500 mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Daily Geo-Attendance Check</h3>
                        <div class="space-y-4">
                            <!-- Step 1: Session Type -->
                            <div>
                                <label for="session-type" class="block text-sm font-medium text-gray-700 mb-1">1. Select Session Type</label>
                                <select id="session-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 shadow-sm" required>
                                    <option value="">-- Choose Type --</option>
                                    <option value="on-class">On Class Session</option>
                                    <option value="clinicals">Clinicals Session</option>
                                </select>
                            </div>

                            <!-- Step 2: Session Detail (Conditionally Hidden/Shown by JS) -->
                            <div id="session-detail-container" class="hidden">
                                <label for="session-detail" class="block text-sm font-medium text-gray-700 mb-1">2. Select Lesson/Rotation</label>
                                <select id="session-detail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 shadow-sm" disabled required>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>

                            <button id="check-in-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                Check In Now
                            </button>
                            <p id="check-in-status" class="text-sm text-slate-600 mt-2 text-center">Please select the session type and detail to enable check-in.</p>
                        </div>
                    </div>

                    <!-- Other Dashboard Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-emerald-500">
                            <p class="text-sm font-medium text-slate-500">Current GPA</p>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1">3.85</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-slate-500">Attendance Rate</p>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1">94%</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-indigo-500">
                            <p class="text-sm font-medium text-slate-500">Unread Messages</p>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1">3</p>
                        </div>
                    </div>
                </section>

                <!-- 3. Super Admin Tools Tab - Distinct Styling -->
                <section id="admin-tools" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Welcome, <span id="admin-name-display">Super Admin Matoka</span>!</h2>
                    <p class="text-lg text-slate-500 mb-6">Full system oversight and user management.</p>

                    <!-- Edit Welcome Message Panel -->
                    <div class="bg-white p-6 rounded-2xl shadow-2xl space-y-4 border-t-8 border-indigo-600">
                        <h3 class="text-xl font-bold text-indigo-700">Edit Student Welcome Message</h3>
                        <p class="text-sm text-slate-500">Customize the content that appears on the student dashboard's main screen. **HTML formatting is supported**.</p>
                        
                        <form id="welcome-message-form">
                            <textarea id="welcome-message-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-y font-mono text-sm shadow-inner" rows="12" placeholder="Enter your custom welcome message HTML here..."></textarea>
                            <button type="submit" id="save-welcome-button" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 w-full md:w-auto shadow-md hover:shadow-lg">
                                Save Welcome Message
                            </button>
                            <p id="save-status" class="text-sm mt-2 text-slate-600"></p>
                        </form>
                    </div>
                    
                    <!-- Current Live Preview -->
                    <div class="mt-8 mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Current Live Preview</h3>
                        <div id="live-preview" class="bg-slate-50 p-6 rounded-xl border-2 border-dashed border-gray-300">
                            <p class="text-slate-500">Loading live preview...</p>
                        </div>
                    </div>

                    <!-- New Live Attendance Logs Section -->
                    <div class="mt-8 bg-white p-6 rounded-2xl shadow-2xl space-y-4 border-t-8 border-indigo-600">
                        <h3 class="text-xl font-bold text-indigo-700">Live Student Attendance Logs</h3>
                        <p class="text-sm text-slate-500 mb-4">All check-in records including the recorded geolocation data. (Sorted by most recent)</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (UTC)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location (Geocoded)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="admin-attendance-table-body">
                                    <tr><td colspan="4" class="px-4 py-4 text-center text-slate-500">Loading attendance data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                <!-- End Super Admin Tools Tab -->

                <!-- 4. Profile Tab -->
                <section id="profile" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Profile</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-xl space-y-4 border-l-4 border-gray-400">
                        <p><strong>User ID:</strong> <span id="user-id-display" class="text-gray-700 font-mono text-sm">Loading...</span></p>
                        <p><strong>Email:</strong> <span class="text-gray-700">Loading...</span></p>
                        <p><strong>Student ID:</strong> <span class="text-gray-700">Loading...</span></p>
                        <p><strong>Program:</strong> <span class="text-gray-700">Loading...</span></p>
                        <p><strong>Phone:</strong> <span class="text-gray-700">Loading...</span></p>
                        <p><strong>Account Status:</strong> <span class="text-emerald-600 font-bold">Loading...</span></p>
                    </div>
                </section>

                <!-- 5. Grades & Reports Tab -->
                <section id="grades" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Grades & Reports</h2>
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center text-slate-500 bg-slate-50">
                        <p class="text-lg">My Grades & Reports</p>
                        <p>This tab is where you would view detailed grades for all modules, and download official academic reports. (Under Construction)</p>
                    </div>
                </section>

                <!-- 6. Attendance Logs Tab -->
                <section id="attendance" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Attendance History</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check-In Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="attendance-table">
                                <tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">This tab is a placeholder for detailed student-specific attendance logs.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- 7. Announcements Tab -->
                <section id="announcements" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Program Announcements</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <p class="text-slate-500">Important notices sent by the administration regarding your program or the entire university.</p>
                        <p class="text-slate-500">Loading announcements...</p>
                    </div>
                </section>

                <!-- 8. Message Admin Tab -->
                <section id="messages" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Send Message to Administration</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <form id="messages-form" class="space-y-4">
                            <textarea id="message-body" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-y shadow-inner" rows="6" placeholder="Use this form to send a private inquiry or report an issue directly to the admin team." required></textarea>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                                Send Message
                            </button>
                            <p id="message-status" class="text-sm text-slate-500 mt-2"></p>
                        </form>
                    </div>
                </section>

                <!-- Other Placeholder Tabs -->
                <section id="courses" class="tab-content">
                     <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Enrollment & Courses</h2>
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center text-slate-500 bg-slate-50">
                        <p>This tab would show your full history of enrolled programs and the modules registered for the current term. (Under Construction)</p>
                    </div>
                </section>
                <section id="cats-exams" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">CATs/Exams</h2>
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center text-slate-500 bg-slate-50">
                        <p>Schedules and results for CATs and Exams. (Under Construction)</p>
                    </div>
                </section>
                <section id="academic-calendar" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Academic Calendar</h2>
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center text-slate-500 bg-slate-50">
                        <p>University academic calendar. (Under Construction)</p>
                    </div>
                </section>
                <section id="learning-resources" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Learning Resources</h2>
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center text-slate-500 bg-slate-50">
                        <p>Links to student resources. (Under Construction)</p>
                    </div>
                </section>
            </main>
        </div>

    </div>

    <!-- Toast Notification / Custom Alert Replacement for Logout -->
    <div id="toast-message" class="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50">
        Logging out... Goodbye!
    </div>
    <!-- /Toast Notification -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // LocationIQ Access Token (Publicly exposed by user request)
        const LOCATIONIQ_ACCESS_TOKEN = "pk.cbe61eae35ecbe1d1d682c347d81381c";

        // Global Firebase Variables (MUST be initialized)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore paths
        const WELCOME_MESSAGE_DOC_ID = "main_message";
        const ATTENDANCE_COLLECTION_PATH = `artifacts/${appId}/public/data/attendance/checkins`;

        let db, auth;
        let currentUserId = null;
        let isAuthReady = false;
        let isAdmin = false;

        // --- Firebase Initialization and Auth ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = currentUserId;
                    
                    // Super Admin Check (Simulated)
                    if (currentUserId === 'demo-admin-user-id' || currentUserId.length > 5 && currentUserId.startsWith('F-')) {
                        isAdmin = true;
                        document.getElementById('admin-link-container').classList.remove('hidden');
                        document.getElementById('user-display-name').textContent = 'Super Admin Matoka';
                        document.getElementById('user-subtitle').textContent = 'Full system oversight and user management.';
                        document.getElementById('portal-title').textContent = 'Super Admin';
                        loadAdminAttendance(); // Load logs for admin
                    } else {
                        isAdmin = false;
                        document.getElementById('user-display-name').textContent = 'Jane Doe'; 
                        document.getElementById('portal-title').textContent = 'Student';
                    }

                    loadWelcomeMessage();
                } else {
                    currentUserId = crypto.randomUUID(); 
                    isAuthReady = true;
                    loadWelcomeMessage();
                    document.getElementById('user-id-display').textContent = currentUserId;
                }
            });

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

        } catch (error) {
            console.error("Firebase initialization or authentication failed:", error);
            document.getElementById('welcome-body-display').innerHTML = '<p class="text-red-500">Error loading data. Check console for Firebase connection status.</p>';
        }

        // --- Geolocation Functions ---

        /**
         * Attempts to get the user's current latitude and longitude.
         * @returns {Promise<{lat: number, lon: number}|null>}
         */
        function getCurrentLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.error('Geolocation is not supported by this browser.');
                    resolve(null);
                    return;
                }

                // High accuracy for better check-in validation
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.error("Geolocation error:", error.message);
                        resolve(null);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        /**
         * Converts coordinates to a human-readable address using LocationIQ API.
         * @param {number} lat - Latitude
         * @param {number} lon - Longitude
         * @returns {Promise<string>} - The human-readable address or error string.
         */
        async function reverseGeocode(lat, lon) {
            const url = `https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_ACCESS_TOKEN}&lat=${lat}&lon=${lon}&format=json`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok && data.display_name) {
                    return data.display_name;
                } else {
                    console.error("LocationIQ API Error:", data.error || data);
                    return `Location found, but geocoding failed. Coords: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                }
            } catch (error) {
                console.error("Error fetching geocode data:", error);
                return `Geocoding failed. Check API key/Network. Coords: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            }
        }


        // --- Attendance Check-in Logic ---

        async function handleCheckIn(e) {
            e.preventDefault();
            const sessionType = sessionTypeSelect.value;
            const sessionDetail = sessionDetailSelect.value;

            if (!sessionType || !sessionDetail) {
                checkInStatus.textContent = "Please select both session type and detail.";
                return;
            }

            const originalButtonText = checkInButton.textContent;
            checkInButton.setAttribute('disabled', 'true');
            checkInButton.textContent = 'Checking location...';
            checkInStatus.classList.remove('text-red-600', 'text-green-600');
            checkInStatus.textContent = 'Requesting location access...';

            // 1. Get Location
            const location = await getCurrentLocation();

            if (!location) {
                checkInStatus.textContent = 'Error: Could not get your location. Please ensure location services are enabled and try again.';
                checkInStatus.classList.add('text-red-600');
                checkInButton.textContent = originalButtonText;
                checkInButton.removeAttribute('disabled');
                return;
            }

            checkInStatus.textContent = 'Location acquired. Reverse geocoding...';

            // 2. Reverse Geocode
            const address = await reverseGeocode(location.lat, location.lon);

            // 3. Construct Attendance Record
            const checkInRecord = {
                userId: currentUserId,
                sessionType: sessionType,
                sessionDetail: sessionDetail,
                timestamp: new Date().toISOString(),
                latitude: location.lat,
                longitude: location.lon,
                address: address, 
                timestamp_ms: Date.now() // For client-side sorting
            };

            // 4. Save to Firestore (Public Collection)
            checkInStatus.textContent = 'Saving record to database...';
            try {
                const checkinsColRef = collection(db, ATTENDANCE_COLLECTION_PATH);
                await addDoc(checkinsColRef, checkInRecord);
                
                // 5. Success feedback
                const checkInTime = new Date().toLocaleTimeString();
                checkInStatus.textContent = `Check-In successful! Logged for ${sessionDetail} at ${checkInTime}. Location: ${address}`;
                checkInStatus.classList.add('text-green-600');

            } catch (error) {
                console.error("Error saving check-in record:", error);
                checkInStatus.textContent = `Error saving check-in: ${error.message}`;
                checkInStatus.classList.add('text-red-600');
            } finally {
                checkInButton.textContent = originalButtonText;
                checkInButton.removeAttribute('disabled');
                validateAttendanceForm(); // Re-validate the form state
            }
        }

        // --- Data Loading Functions (Admin and Welcome) ---

        /**
         * Loads the public welcome message in real-time. (Called by all users)
         */
        function loadWelcomeMessage() {
            if (!isAuthReady) return;
            try {
                const welcomeDocRef = doc(db, `artifacts/${appId}/public/data/settings`, WELCOME_MESSAGE_DOC_ID);

                onSnapshot(welcomeDocRef, (docSnap) => {
                    const defaultMessage = `
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Welcome to the Student Portal here!</h3>
                        <p class="text-gray-700">Use the navigation bar on the left to access your profile, grades, attendance, and communication tools.</p>
                        <p class="text-gray-700">Customize this message here. <strong>HTML is supported!</strong></p>
                    `;
                    
                    let messageBody = defaultMessage;
                    let messageSubject = "THE OFFICIAL ANNOUNCMENT IS HERE";

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        messageBody = data.body || defaultMessage;
                        messageSubject = data.subject || "LATEST ANNOUNCEMENT";
                    }

                    // Display in Student Tab (using innerHTML for HTML support)
                    document.getElementById('welcome-body-display').innerHTML = messageBody;
                    document.getElementById('welcome-subject').textContent = messageSubject;

                    // Display in Admin Tab (for live preview and editing)
                    if (isAdmin) {
                        document.getElementById('live-preview').innerHTML = messageBody;
                        document.getElementById('welcome-message-input').value = messageBody;
                    }

                }, (error) => {
                    console.error("Error fetching welcome message:", error);
                });
            } catch (error) {
                console.error("Error setting up onSnapshot for welcome message:", error);
            }
        }

        /**
         * Loads all attendance records for the Admin view in real-time.
         */
        function loadAdminAttendance() {
            if (!isAdmin || !isAuthReady) return;
            
            const tableBody = document.getElementById('admin-attendance-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-indigo-500"><div class="loader mx-auto mb-2"></div> Loading live attendance feed...</td></tr>';

            try {
                const checkinsColRef = collection(db, ATTENDANCE_COLLECTION_PATH);
                const q = query(checkinsColRef);

                onSnapshot(q, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => {
                        records.push(doc.data());
                    });

                    // Client-side sort by timestamp_ms descending (most recent first)
                    records.sort((a, b) => (b.timestamp_ms || 0) - (a.timestamp_ms || 0));

                    if (records.length === 0) {
                         tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-slate-500">No attendance records found yet.</td></tr>';
                         return;
                    }

                    tableBody.innerHTML = records.map(record => {
                        const date = new Date(record.timestamp);
                        const timeString = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' });
                        const dateString = date.toLocaleDateString();
                        const displayUserId = record.userId.substring(0, 8) + '...'; // Truncate ID for table

                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono">${dateString} ${timeString}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" title="${record.userId}">${displayUserId}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${record.sessionDetail}</td>
                                <td class="px-4 py-3 text-sm text-gray-700 max-w-sm truncate" title="${record.address || 'N/A'}">
                                    ${record.address || `Coords: ${record.latitude}, ${record.longitude}`}
                                </td>
                            </tr>
                        `;
                    }).join('');

                }, (error) => {
                    console.error("Error fetching admin attendance:", error);
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-red-500">Error loading data. See console.</td></tr>';
                });
            } catch (error) {
                console.error("Error setting up onSnapshot for attendance:", error);
            }
        }


        /**
         * Saves the new welcome message to Firestore.
         */
        async function saveWelcomeMessage(event) {
            event.preventDefault();
            const saveButton = document.getElementById('save-welcome-button');
            const saveStatus = document.getElementById('save-status');
            const newBody = document.getElementById('welcome-message-input').value;
            const newSubject = document.getElementById('welcome-subject').textContent;

            saveButton.disabled = true;
            saveStatus.textContent = 'Saving...';
            saveStatus.classList.remove('text-green-600', 'text-red-600');

            try {
                const welcomeDocRef = doc(db, `artifacts/${appId}/public/data/settings`, WELCOME_MESSAGE_DOC_ID);
                await setDoc(welcomeDocRef, {
                    body: newBody,
                    subject: newSubject,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUserId
                }, { merge: true });
                
                saveStatus.textContent = 'Message saved successfully!';
                saveStatus.classList.add('text-green-600');
            } catch (error) {
                console.error("Error saving welcome message:", error);
                saveStatus.textContent = `Error saving message: ${error.message}`;
                saveStatus.classList.add('text-red-600');
            } finally {
                saveButton.disabled = false;
                setTimeout(() => saveStatus.textContent = '', 3000);
            }
        }


        // --- Other App Logic and Event Listeners ---

        const courses = ["Anatomy & Physiology I", "Medical Microbiology", "Clinical Pharmacology", "Nursing Ethics & Law"];
        const clinicals = ["Maternity Rotation", "Medical Ward", "Surgical Ward Male", "Surgical Ward Female"];

        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabs = document.querySelectorAll('.tab-content');
        const logoutLink = document.getElementById('logout-link');
        const toastMessage = document.getElementById('toast-message');

        const sessionTypeSelect = document.getElementById('session-type');
        const sessionDetailContainer = document.getElementById('session-detail-container');
        const sessionDetailSelect = document.getElementById('session-detail');
        const checkInButton = document.getElementById('check-in-button');
        const checkInStatus = document.getElementById('check-in-status');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            const existingOverlay = document.getElementById('sidebar-overlay');
            
            if (!sidebar.classList.contains('-translate-x-full')) {
                if (!existingOverlay) {
                    const overlay = document.createElement('div');
                    overlay.id = 'sidebar-overlay';
                    overlay.classList.add('fixed', 'inset-0', 'bg-gray-900', 'bg-opacity-50', 'z-40', 'lg:hidden');
                    overlay.addEventListener('click', toggleSidebar);
                    document.body.appendChild(overlay);
                }
            } else {
                if (existingOverlay) {
                    existingOverlay.remove();
                }
            }
        }

        function showTab(tabId) {
            tabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.getElementById(tabId);
            if(activeTab) activeTab.classList.add('active');

            navLinks.forEach(l => {
                l.classList.remove('active', 'text-white', 'font-semibold');
                if (l.id !== 'logout-link') {
                    l.classList.add('text-slate-300', 'hover:text-white');
                }
            });
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'text-white', 'font-semibold');
                activeLink.classList.remove('text-slate-300', 'hover:text-white');
            }
            
            // Special styling for admin link
            const adminLink = document.querySelector('.nav-link[data-tab="admin-tools"]');
             if (adminLink && tabId === 'admin-tools') {
                adminLink.classList.remove('text-slate-300', 'hover:text-white', 'bg-indigo-800');
                adminLink.classList.add('bg-indigo-700', 'active');
            } else if (adminLink) {
                adminLink.classList.remove('bg-indigo-700', 'active');
                adminLink.classList.add('bg-indigo-800');
            }
        }

        function showLogoutToast() {
            toastMessage.classList.remove('opacity-0');
            toastMessage.classList.add('opacity-100');
            setTimeout(() => {
                toastMessage.classList.remove('opacity-100');
                toastMessage.classList.add('opacity-0');
            }, 2000);
        }

        function updateAttendanceDetail(sessionType) {
            sessionDetailSelect.innerHTML = '<option value="">-- Choose Lesson/Rotation --</option>';
            if (!sessionType) {
                sessionDetailContainer.classList.add('hidden');
                sessionDetailSelect.setAttribute('disabled', 'true');
                return;
            }

            const optionsData = sessionType === 'on-class' ? courses : clinicals;
            optionsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                sessionDetailSelect.appendChild(option);
            });

            sessionDetailContainer.classList.remove('hidden');
            sessionDetailSelect.removeAttribute('disabled');
            validateAttendanceForm();
        }

        function validateAttendanceForm() {
            const typeSelected = sessionTypeSelect.value !== "";
            const detailSelected = sessionDetailSelect.value !== "";

            if (typeSelected && detailSelected) {
                checkInButton.removeAttribute('disabled');
                checkInButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                checkInStatus.textContent = `Ready to check in for ${sessionDetailSelect.value}.`;
            } else {
                checkInButton.setAttribute('disabled', 'true');
                checkInButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                checkInStatus.textContent = "Please select the session type and detail to enable check-in.";
            }
        }
        
        // --- Event Listeners ---
        
        // Initialize the app and attach listeners after DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            showTab('welcome');
            
            if (document.getElementById('welcome-message-form')) {
                document.getElementById('welcome-message-form').addEventListener('submit', saveWelcomeMessage);
            }
            
            checkInButton.addEventListener('click', handleCheckIn);

            menuToggle.addEventListener('click', toggleSidebar);

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (link.id === 'logout-link') return;
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        showTab(tabId);
                    }
                    if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            });

            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                showLogoutToast();
                if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            });

            sessionTypeSelect.addEventListener('change', (e) => {
                updateAttendanceDetail(e.target.value);
            });

            sessionDetailSelect.addEventListener('change', validateAttendanceForm);

        });
    </script>
</body>
</html>
