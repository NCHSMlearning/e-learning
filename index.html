<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Student Dashboard</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"></noscript>
    
    <style>
        /* CSS styles remain the same as provided, adding new elements */
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #F8FAFC; }
        .container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 220px; background-color: #1E293B; color: #fff; display: flex; flex-direction: column; padding: 20px; }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header img { width: 60px; margin-bottom: 10px; }
        .nav { list-style: none; padding: 0; flex-grow: 1; }
        .nav a { color: #fff; text-decoration: none; padding: 10px; border-radius: 6px; display: block; transition: 0.2s; }
        .nav a:hover, .nav a.active { background-color: #3B82F6; }
        .logout { margin-top: auto; text-align: center; }
        .logout a { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #EF4444; color: #fff; text-decoration: none; border-radius: 6px; cursor: pointer; }

        /* Main */
        .main { flex: 1; padding: 20px 30px; overflow-y: auto; }
        header h1 { margin: 0; font-size: 2rem; }
        .subtitle { color: #475569; margin-bottom: 20px; }

        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: #fff; padding: 20px; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; }

        /* Tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #E2E8F0; text-align: left; }
        th { background-color: #E2E8F0; }
        tr:hover { background-color: #F1F5F9; }

        /* New Attendance Section Styles */
        .check-in-controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .check-in-controls label {
            margin-right: 15px;
            font-weight: 600;
        }
        .check-in-controls select,
        .check-in-controls button {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .check-in-controls button {
            background-color: #059669; /* Green for check-in */
            color: white;
            border: none;
            font-weight: 600;
        }
        .check-in-controls button:hover {
            background-color: #047857;
        }
        #geo-message {
            margin-top: 15px;
            font-style: italic;
            color: #1E293B;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="images/Logo_NCHSM.png" alt="Logo">
                <h2>Student Panel</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">Dashboard</a></li>
                <li><a href="#" data-tab="profile">Profile</a></li>
                <li><a href="#" data-tab="courses">My Courses</a></li>
                <li><a href="#" data-tab="attendance">Attendance</a></li>
                <li><a href="#" data-tab="cats">CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">Resources</a></li>
                <li><a href="#" data-tab="messages">Messages</a></li>
            </ul>
            <div class="logout"><a href="#" onclick="logout()">Logout</a></div>
        </aside>

        <main class="main">
            <header>
                <h1>Welcome, Student!</h1>
                <p class="subtitle">Access your learning tools and updates</p>
            </header>

            <section id="dashboard" class="tab-content active">
                </section>

            <section id="profile" class="tab-content">
                </section>

            <section id="courses" class="tab-content">
                </section>

            <section id="attendance" class="tab-content">
                <h2>Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <label for="session-type">Session Type:</label>
                    <select id="session-type">
                        <option value="Clinical">Clinical Rotation</option>
                        <option value="Call">On Call</option>
                    </select>
                    
                    <button id="check-in-button" onclick="geoCheckIn()">Check In Now</button>
                    
                    <p id="geo-message">Click "Check In Now" to submit your attendance and location.</p>
                </div>

                <h2>Attendance Records (Real-Time)</h2>
                <table>
                    <thead><tr><th>Course/Rotation</th><th>Type</th><th>Date</th><th>Status</th></tr></thead>
                    <tbody id="attendance-table">
                        <tr><td colspan="4">Loading attendance records...</td></tr>
                    </tbody>
                </table>

                <h3>Geo Attendance History</h3>
                <table>
                    <thead><tr><th>Time</th><th>Session Type</th><th>Location (Lat, Long)</th><th>Accuracy (m)</th><th>Verified by Admin</th></tr></thead>
                    <tbody id="geo-attendance-history">
                        <tr><td colspan="5">Loading geo check-in history...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="cats" class="tab-content">
                </section>

            <section id="resources" class="tab-content">
                </section>

            <section id="messages" class="tab-content">
                </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // =========================================================================
        // 1. SUPABASE CONFIGURATION - IMPORTANT: Use your correct keys
        // =========================================================================
        const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY'; // **REPLACE with your actual Anon Key**
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUserId = null; 
        const geoMessage = document.getElementById('geo-message');
        const checkInButton = document.getElementById('check-in-button');

        // [ ... UI and Navigation Logic (showTab, logout) remains the same ... ]

        // =========================================================================
        // 2. GEOLOCATION AND CHECK-IN LOGIC (NEW)
        // =========================================================================

        // The main function to handle the geolocation check-in process
        function geoCheckIn() {
            if (!currentUserId) {
                geoMessage.textContent = "Error: User not logged in.";
                return;
            }

            if (!navigator.geolocation) {
                geoMessage.textContent = "Error: Geolocation is not supported by your browser.";
                return;
            }

            const sessionType = document.getElementById('session-type').value;
            checkInButton.disabled = true;
            geoMessage.textContent = `Requesting location for ${sessionType}... Please allow permission.`;

            // Request high accuracy location from the browser/device
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // SUCCESS CALLBACK: Location obtained
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    geoMessage.textContent = `Location acquired. Accuracy: ${accuracy.toFixed(2)} meters. Submitting...`;

                    // Send the data to Supabase
                    submitGeoAttendance(sessionType, latitude, longitude, accuracy);
                },
                (error) => {
                    // ERROR CALLBACK: Failed to get location
                    checkInButton.disabled = false;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            geoMessage.textContent = "Error: Location permission denied by the user. Cannot check in.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            geoMessage.textContent = "Error: Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            geoMessage.textContent = "Error: The request to get user location timed out.";
                            break;
                        default:
                            geoMessage.textContent = `Error getting location: ${error.message}`;
                            break;
                    }
                    console.error("Geolocation Error:", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds
                    maximumAge: 0 // Do not use cached position
                }
            );
        }

        // Supabase submission function
        async function submitGeoAttendance(sessionType, lat, long, accuracy) {
            const { error } = await sb
                .from('geo_attendance_logs')
                .insert({
                    student_id: currentUserId,
                    session_type: sessionType,
                    latitude: lat,
                    longitude: long,
                    accuracy_meters: accuracy,
                });
            
            checkInButton.disabled = false;

            if (error) {
                geoMessage.textContent = `Submission Error: ${error.message}`;
                console.error("Supabase Geo-Check-in Error:", error);
            } else {
                geoMessage.textContent = `Check-in successful! Session: ${sessionType} at ${new Date().toLocaleTimeString()}. Location sent to Admin.`;
                // Refresh the history table to show the new entry
                loadGeoAttendanceHistory(currentUserId);
            }
        }
        
        // =========================================================================
        // 3. NEW DATA FETCHING: GEO ATTENDANCE HISTORY
        // =========================================================================

        async function loadGeoAttendanceHistory(userId) {
            const { data, error } = await sb
                .from('geo_attendance_logs')
                .select('check_in_time, session_type, latitude, longitude, accuracy_meters, is_verified')
                .eq('student_id', userId)
                .order('check_in_time', { ascending: false });

            const table = document.getElementById('geo-attendance-history');
            
            if (error) {
                console.error("Geo History RLS Error:", error);
                table.innerHTML = `<tr><td colspan="5" style="color: red;">Error loading Geo History: Access Denied.</td></tr>`;
                return;
            }

            table.innerHTML = (data || []).map(a => `
                <tr>
                    <td>${new Date(a.check_in_time).toLocaleString()}</td>
                    <td>${a.session_type}</td>
                    <td>${a.latitude.toFixed(6)}, ${a.longitude.toFixed(6)}</td>
                    <td>${a.accuracy_meters.toFixed(2)}</td>
                    <td>${a.is_verified ? 'Yes (Verified)' : 'No (Pending)'}</td>
                </tr>`).join('');
        }
        
        // =========================================================================
        // 4. REALTIME HANDLERS AND INITIALIZATION (UPDATED)
        // =========================================================================

        // [ ... Existing handleCoursesUpdate, handleResourcesUpdate ... ]

        // New Handler for Geo History changes
        function handleGeoHistoryUpdate(payload) {
            console.log('Realtime Geo Attendance Update:', payload.eventType);
            if (currentUserId) {
                // If RLS is set correctly, this only refreshes the current user's history
                loadGeoAttendanceHistory(currentUserId);
            }
        }

        async function subscribeToRealtimeChannels(userId) {
            // [ ... Existing Subscriptions for Courses, Resources, Attendance (The old table) ... ]
            
            // New: Geo Attendance History Subscription
            sb.channel(`geo_attendance:user:${userId}`)
              .on('postgres_changes', 
                  { event: '*', schema: 'public', table: 'geo_attendance_logs', filter: `student_id=eq.${userId}` }, 
                  handleGeoHistoryUpdate
              )
              .subscribe();
        }

        async function initializeDashboard() {
            // 1. Check Session 
            const { data: { user }, error: userError } = await sb.auth.getUser();

            if (userError || !user) {
                console.warn("No active session found. Redirecting to login.");
                return window.location.href = "login.html";
            }
            
            currentUserId = user.id; 

            // 2. Load initial data
            loadProfile(currentUserId);
            loadCourses();
            loadAttendance(currentUserId); // Old attendance table
            loadGeoAttendanceHistory(currentUserId); // NEW Geo table history
            loadResources();
            
            // 3. Start Realtime subscriptions
            subscribeToRealtimeChannels(currentUserId);
        }

        // Init
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
